<p>本书讲了linux维护和管理过程中常用的命令。</p>

<p>分12个章节，分别将了目录切换、日期、SSH远程登录、常用linux命令、PS1-4操作提示符、解压缩、命令历史记录、系统管理、容器服务器Apache、脚本环境变量、性能监控等。</p>

<p>介绍的命令有：cd, dirs, pushd, popd, cdpath, <strong>alias</strong>, mkdir, eval, date, hwclock, ssh, grep, find, 输出重定向, join, tr, xargs, sort, uniq, cut, stat, diff, ac, ps1, ps2, ps3, ps4, PROMPT_COMMAND, zip, unzip, tar, gzip, bzip2, HISTTIMEFORMAT, HISTSIZE, HISTIGNORE, fdisk, mke2fsk, mount, tune2fs, useradd, adduser, passwd, groupadd, id, ssh-copy-id, ssh-agent, crontab, apachectl, httpd, <strong>.bash_rc</strong>, .bash_profile, 单引号, 双引号, free, top, ps, df, kill, du, lsof, sar, vmstat, netstat, sysctl, nice, renice等等。</p>

<p>下面结合工作中的一些实践，谈一谈</p>

<h2>技巧一：登录服务器</h2>

<p>不管是正式环境还是云端的测试环境，一般提供给我们访问的只有一个入口（也就是常说的跳板机），登录跳板机后然后才能连接其他服务器。常用的工具有【SecureCRT】和【Xshell】，它们的使用方式基本相同。</p>

<p>最佳实践：连接跳板机的同时，建立自己机器和内网机器之间的隧道，即可以方便浏览器的访问，同时也可以使用sftp直接传输文件到内网机器。</p>

<p><img src="/images/blogs/linux-101-hacks-review-securecrt-config.png" alt="" /></p>

<p><img src="/images/blogs/linux-101-hacks-review-securecrt-web.png" alt="" /></p>

<h2>技巧二：ssh-copy-id【hack 72】</h2>

<p>想不通，现在的教程都使用【复制-添加-修改权限】公钥的方式来进行无密钥登录配置。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@hadoop-master1 ~]$ scp .ssh/id_rsa.pub 172.17.0.3:~/master_id_rsa.pub
</span><span class='line'>hadoop@172.17.0.3's password: 
</span><span class='line'>id_rsa.pub                                                                                                                     100%  403     0.4KB/s   00:00    
</span><span class='line'>[hadoop@hadoop-master1 ~]$ ssh 172.17.0.3
</span><span class='line'>hadoop@172.17.0.3's password: 
</span><span class='line'>Last login: Sun Sep 13 11:41:17 2015 from 172.17.0.2
</span><span class='line'>[hadoop@hadoop-slaver1 ~]$ cat master_id_rsa.pub &gt;&gt; .ssh/authorized_keys 
</span><span class='line'>[hadoop@hadoop-slaver1 ~]$ ll -d .ssh
</span><span class='line'>drwx------. 2 hadoop hadoop 4096 Mar 10  2015 .ssh
</span><span class='line'>[hadoop@hadoop-slaver1 ~]$ ll .ssh/authorized_keys 
</span><span class='line'>-rw-------. 1 hadoop hadoop 403 Sep 13 11:58 .ssh/authorized_keys</span></code></pre></td></tr></table></div></figure>


<p>处理一个ssh无密钥登录搞N多的步骤，还不一定能成功！其实使用ssh-copy-id的命令就行了，不知道各类书籍上面都使用老旧的方法，都是抄来的吗？！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@hadoop-slaver1 ~]$ ssh-copy-id -i .ssh/id_rsa.pub 172.17.0.2
</span><span class='line'>The authenticity of host '172.17.0.2 (172.17.0.2)' can't be established.
</span><span class='line'>RSA key fingerprint is aa:41:79:6d:9d:c2:ec:f1:29:71:43:24:39:09:58:b6.
</span><span class='line'>Are you sure you want to continue connecting (yes/no)? yes
</span><span class='line'>Warning: Permanently added '172.17.0.2' (RSA) to the list of known hosts.
</span><span class='line'>hadoop@172.17.0.2's password: 
</span><span class='line'>Now try logging into the machine, with "ssh '172.17.0.2'", and check in:
</span><span class='line'>
</span><span class='line'>  .ssh/authorized_keys
</span><span class='line'>
</span><span class='line'>to make sure we haven't added extra keys that you weren't expecting.</span></code></pre></td></tr></table></div></figure>


<h2>技巧三：查看机器</h2>

<p>碰到不认识的人，我们都会上下打量。机器也一样，首先要了解机器，才能充分的发挥自己的性能。存储不够要么删点，要么加磁盘等等。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>uname -a
</span><span class='line'>cat /etc/redhat-release 
</span><span class='line'>ifconfig
</span><span class='line'>
</span><span class='line'>date
</span><span class='line'>
</span><span class='line'>df -h , df -Tha
</span><span class='line'>free -m 
</span><span class='line'>uptime
</span><span class='line'>top
</span><span class='line'>ps aux , ps auxf
</span><span class='line'>netstat -atp
</span><span class='line'>du -h --max-depth=1
</span><span class='line'>lsof -i:[PORT]
</span><span class='line'>
</span><span class='line'>cat /etc/hosts</span></code></pre></td></tr></table></div></figure>


<h2>技巧四：管道</h2>

<p>一个命令的结果直接输出给另一个命令。就像水从一个结头通过管子直接流向下一个结头一样。中间不需要落地，直接立即用于下一个命令，直到结果输出。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat /etc/hosts | grep 'hadoop' | awk '{print $2}' | while read h ; do echo $h ; done</span></code></pre></td></tr></table></div></figure>


<p>shell的命令那么多，简单功能的材料都准备好了，就像堆积木一样，叠加后总能实现你想得到的效果。</p>

<p>在进行一次性文件拷贝时，如果文件数量过多，可以先打包然后传到远程机器再解压：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tar zc nginx | ssh bigdata1 'tar zx'</span></code></pre></td></tr></table></div></figure>


<h2>技巧N：查看帮助</h2>

<p>写java的没看过开源项目不要说自己会java，写shell没用过man不要说自己会shell！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>man [CMD]
</span><span class='line'>info [CMD]
</span><span class='line'>[CMD] help
</span><span class='line'>[CMD] -h
</span><span class='line'>[CMD] -help</span></code></pre></td></tr></table></div></figure>


<p>总有一款适合你，带着实践和问题的目的去学/写，能更好的把握它。（shell的命令太多，不要寄希望于看一个宝典就能写好！实践出真知，真正用到的才是实用的）</p>

<h2>技巧N-1：调试Shell脚本</h2>

<p>Shell脚本/命令在执行前会对变量进行解析、处理。查看最终执行的命令，能让我们了解到脚本不正确的地方，然后及时进行更正。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set命令的参数说明
</span><span class='line'>-v      Print shell input lines as they are read.
</span><span class='line'>-x      After  expanding each simple command, for command, case command, select command, or arithmetic for command, 
</span><span class='line'>display the expanded value of PS4, followed by the command and its expanded arguments or associated word list.
</span><span class='line'>    
</span><span class='line'>[hadoop@hadoop-master2 ~]$ set -x
</span><span class='line'>[hadoop@hadoop-master2 1]$ cmd=*
</span><span class='line'>+ cmd='*'
</span><span class='line'>[hadoop@hadoop-master2 1]$ echo $cmd
</span><span class='line'>+ echo 2 file
</span><span class='line'>2 file
</span><span class='line'>[hadoop@hadoop-master2 1]$ echo "$cmd" # 双引号
</span><span class='line'>+ echo '*'
</span><span class='line'>*
</span><span class='line'>[hadoop@hadoop-master2 1]# echo '$cmd' # 单引号
</span><span class='line'>+ echo '$cmd'
</span><span class='line'>$cmd</span></code></pre></td></tr></table></div></figure>


<p>调试脚本</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master2 1]# vi run.sh
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>bin=$(dir=`dirname $0`; cd $dir ; pwd)
</span><span class='line'>
</span><span class='line'>cd $bin
</span><span class='line'>ls -l
</span><span class='line'>
</span><span class='line'>[root@hadoop-master2 1]# sh -x run.sh 
</span><span class='line'>+++ dirname run.sh
</span><span class='line'>++ dir=.
</span><span class='line'>++ cd .
</span><span class='line'>++ pwd
</span><span class='line'>+ bin=/tmp/1
</span><span class='line'>+ cd /tmp/1
</span><span class='line'>+ ls -l
</span><span class='line'>total 8
</span><span class='line'>drwxrwxr-x 2 hadoop hadoop 4096 Sep 13 20:33 2
</span><span class='line'>-rw-rw-r-- 1 hadoop hadoop    0 Sep 13 20:33 file
</span><span class='line'>-rw-r--r-- 1 root   root     66 Sep 13 21:12 run.sh</span></code></pre></td></tr></table></div></figure>


<h2>技巧N-2：历史history</h2>

<p>历史如足迹。如果你要学习前辈的经验，理着他的足迹，一步步的走！</p>

<p>很多书上说的，<code>CTRL+R, !!, !-1, CTRL+P, ![CMD], !!:$, !^, ![CMD]:2, ![CMD]:$</code>用于获取以后执行的命令或者参数，多半好看不实用。会写的也就前面1-2个命令重复用一下，上下方向键就可以了，不会写的用history查看全部慢慢学更实际点。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>历史记录执行时间
</span><span class='line'>export HISTTIMEFORMAT='%F %T '
</span><span class='line'>输出最近10条历史
</span><span class='line'>alias hist10='history 10'
</span><span class='line'>
</span><span class='line'>持久化保存的历史记录数
</span><span class='line'>vi ~/.bash_profile
</span><span class='line'>HISTSIZE=450
</span><span class='line'>HISTFILESIZE=450
</span><span class='line'># HISTFILE
</span><span class='line'>
</span><span class='line'>忽略连续重复的命令
</span><span class='line'>export HISTCONTROL=ignoredups
</span><span class='line'>
</span><span class='line'>忽略重复的命令
</span><span class='line'>export HISTCONTROL=erasedups
</span><span class='line'>
</span><span class='line'>忽略指定的命令
</span><span class='line'>export HISTIGNORE='pwd:ls'</span></code></pre></td></tr></table></div></figure>


<h2>技巧N-3：shell之grep awk sed vi</h2>

<p>这些就不是看看man就能上手的，细嚼慢咽找几本书翻翻！！</p>

<p>推荐两本书： [sed与awk(第二版)], [Shell脚本学习指南]</p>

<h2>技巧N-4：批量处理之神：expect/for/while</h2>

<p>传入用户（与ssh的用户一致）密码，进行SSH无密钥认证：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master2 1]# vi ssh-copy-id.expect
</span><span class='line'>#!/usr/bin/expect  
</span><span class='line'>
</span><span class='line'>## Usage $0 [user@]host password
</span><span class='line'>
</span><span class='line'>set host [lrange $argv 0 0];
</span><span class='line'>set password [lrange $argv 1 1] ;
</span><span class='line'>
</span><span class='line'>set timeout 30;
</span><span class='line'>
</span><span class='line'>spawn ssh-copy-id $host ;
</span><span class='line'>
</span><span class='line'>expect {
</span><span class='line'>  "(yes/no)?" { send yes\n; exp_continue; }
</span><span class='line'>  "password:" { send $password\n; exp_continue; }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>exec sleep 1;
</span><span class='line'>
</span><span class='line'>批量处理
</span><span class='line'>[root@hadoop-master2 1]# for h in `cat /etc/hosts | grep hadoop | awk '{print $2}' ` ; do ./ssh-copy-id.expect $h root-password ; done</span></code></pre></td></tr></table></div></figure>


<p>传入新用户名称和密码，新建用户：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master2 1]# vi passwd.expect
</span><span class='line'>#!/usr/bin/expect  
</span><span class='line'>
</span><span class='line'>## Usage $0 host username password
</span><span class='line'>
</span><span class='line'>set host [lrange $argv 0 0];
</span><span class='line'>set username [lrange $argv 1 1];
</span><span class='line'>set password [lrange $argv 2 2] ;
</span><span class='line'>
</span><span class='line'>set timeout 30;
</span><span class='line'>
</span><span class='line'>##
</span><span class='line'>
</span><span class='line'>spawn ssh $host useradd $username ;
</span><span class='line'>
</span><span class='line'>exec sleep 1;
</span><span class='line'>
</span><span class='line'>##
</span><span class='line'>
</span><span class='line'>spawn ssh $host passwd $username ;
</span><span class='line'>
</span><span class='line'>## password and repasswd all use this
</span><span class='line'>expect {
</span><span class='line'>  "password:" { send $password\n; exp_continue; }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>exec sleep 1;
</span><span class='line'>
</span><span class='line'>批量处理
</span><span class='line'>[root@hadoop-master2 1]# for h in `cat /etc/hosts | grep hadoop | awk '{print $2}' ` ; do ./passwd.expect $h hadoop hadoop-password ; done</span></code></pre></td></tr></table></div></figure>


<h2>最后</h2>

<p>当然还有很多命令，xargs, if等需要在实践中慢慢积累，shell博大精深继续码字！cdpath眼前一亮，alias还可以这么用！！</p>

<p>在linux把xml转成properties键值对形式的命令，觉得也挺有意思的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@hadoop-master2 ~]$ vi format.xslt
</span><span class='line'>&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
</span><span class='line'>&lt;xsl:output method="text" encoding="iso-8859-1"/&gt;
</span><span class='line'>
</span><span class='line'>&lt;xsl:strip-space elements="*" /&gt;
</span><span class='line'>
</span><span class='line'>&lt;xsl:template match="/*/child::*"&gt;
</span><span class='line'>&lt;xsl:for-each select="child::*"&gt;
</span><span class='line'>&lt;xsl:if test="position() != last()"&gt;&lt;xsl:value-of select="normalize-space(.)"/&gt;=&lt;/xsl:if&gt;
</span><span class='line'>&lt;xsl:if test="position() = last()"&gt;&lt;xsl:value-of select="normalize-space(.)"/&gt; &lt;xsl:text&gt;&#xa;&lt;/xsl:text&gt; &lt;/xsl:if&gt;
</span><span class='line'>&lt;/xsl:for-each&gt;
</span><span class='line'>&lt;/xsl:template&gt;
</span><span class='line'>
</span><span class='line'>&lt;/xsl:stylesheet&gt;
</span><span class='line'>
</span><span class='line'>[hadoop@hadoop-master2 ~]$ xsltproc format.xslt ~/hadoop-2.2.0/etc/hadoop/yarn-site.xml
</span><span class='line'>yarn.nodemanager.aux-services=mapreduce_shuffle
</span><span class='line'>yarn.nodemanager.aux-services.mapreduce.shuffle.class=org.apache.hadoop.mapred.ShuffleHandler
</span><span class='line'>yarn.resourcemanager.address=hadoop-master1:8032
</span><span class='line'>yarn.resourcemanager.scheduler.address=hadoop-master1:8030
</span><span class='line'>yarn.resourcemanager.resource-tracker.address=hadoop-master1:8031
</span><span class='line'>yarn.resourcemanager.admin.address=hadoop-master1:8033
</span><span class='line'>yarn.resourcemanager.webapp.address=hadoop-master1:8088
</span><span class='line'>yarn.nodemanager.resource.memory-mb=51200=yarn-default.xml
</span><span class='line'>yarn.scheduler.minimum-allocation-mb=1024=yarn-default.xml</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
