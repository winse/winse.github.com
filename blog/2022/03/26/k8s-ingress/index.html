
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>K8s Ingress - Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="Ingress是一个集中的集群应用网关，自动化的k8s反向代理组件（功能类比nginx）。 Ingress涉及到LoadBalancer，Ingress Controller, Ingress config等相关概念。controller从LoadBalancer/ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winse.github.io/blog/2022/03/26/k8s-ingress">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/libs/jquery.toc.min.js" type="text/javascript"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

<script src="/javascripts/generate-toc.js" type="text/javascript"></script>


  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D3G1YVNBK4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-D3G1YVNBK4');
</script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停都是风景, 熙熙攘攘都向最好, 忙忙碌碌都为明朝, 何畏之.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winse.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
  <li><a href="/tool/">Tools</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">K8s Ingress</h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-03-26T13:59:16+08:00" pubdate data-updated="true">Sat 2022-03-26 13:59</time>
		
        
		
      </p>
    
  </header>



<div class="toc-icon">
	<svg viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve" style="width: 20px;">
		<g>
			<path fill-rule="evenodd" clip-rule="evenodd" d="M2,15c-1.1,0-2,0.9-2,2c0,1.1,0.9,2,2,2s2-0.9,2-2C4,15.9,3.1,15,2,15z M2,8
				c-1.1,0-2,0.9-2,2c0,1.1,0.9,2,2,2s2-0.9,2-2C4,8.9,3.1,8,2,8z M7,4h12c0.55,0,1-0.45,1-1c0-0.55-0.45-1-1-1H7C6.45,2,6,2.45,6,3
				C6,3.55,6.45,4,7,4z M2,1C0.9,1,0,1.9,0,3c0,1.1,0.9,2,2,2s2-0.9,2-2C4,1.9,3.1,1,2,1z M19,9H7c-0.55,0-1,0.45-1,1
				c0,0.55,0.45,1,1,1h12c0.55,0,1-0.45,1-1C20,9.45,19.55,9,19,9z M19,16H7c-0.55,0-1,0.45-1,1c0,0.55,0.45,1,1,1h12
				c0.55,0,1-0.45,1-1C20,16.45,19.55,16,19,16z"></path>
		</g>
	</svg>
</div>
<div class="entry-content"><p>Ingress是一个集中的集群应用网关，自动化的k8s反向代理组件（功能类比nginx）。</p>

<p>Ingress涉及到LoadBalancer，Ingress Controller, Ingress config等相关概念。controller从LoadBalancer/NodePort把当前的服务发布出去，同时监听Ingress config实时的修改当前Ingress配置(实时更新nginx.conf配置文件，并重载)</p>

<p>这里仅从helloworld入门实践操作进行。</p>

<h2>入门指南</h2>

<h3>参考</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#quick-start">https://kubernetes.github.io/ingress-nginx/deploy/#quick-start</a></li>
<li><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh/docs/concepts/services-networking/ingress/</a></p></li>
<li><p><a href="https://docs.jdcloud.com/cn/jcs-for-kubernetes/deploy-k8s-ingress-nginx">https://docs.jdcloud.com/cn/jcs-for-kubernetes/deploy-k8s-ingress-nginx</a></p></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/concepts/ingress.html">https://jimmysong.io/kubernetes-handbook/concepts/ingress.html</a></li>
</ul>


<p>版本兼容性：
* <a href="https://github.com/kubernetes/ingress-nginx/#support-versions-table">https://github.com/kubernetes/ingress-nginx/#support-versions-table</a></p>

<h3>下载镜像</h3>

<p>镜像在gcr上面，先远程下载回来：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.2/deploy/static/provider/cloud/deploy.yaml 
</span><span class='line'>[ec2-user@k8s ~]$ vi ingress-nginx-controller-v1.1.2.yaml
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ grep image: ingress-nginx-controller-v1.1.2.yaml | sed 's/image: //' | sort -u | xargs echo 
</span><span class='line'>k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# docker pull k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c 
</span><span class='line'>k8s.gcr.io/ingress-nginx/controller@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c: Pulling from ingress-nginx/controller
</span><span class='line'>a0d0a0d46f8b: Pull complete 
</span><span class='line'>3aae86482564: Pull complete 
</span><span class='line'>c0d03781abb3: Pull complete 
</span><span class='line'>0297e2ef8f7f: Pull complete 
</span><span class='line'>866a68ce3c13: Pull complete 
</span><span class='line'>1c2a7ca65b54: Pull complete 
</span><span class='line'>41fd2de30e46: Pull complete 
</span><span class='line'>637f10464e4d: Pull complete 
</span><span class='line'>998064a16da4: Pull complete 
</span><span class='line'>e63d23220e8c: Pull complete 
</span><span class='line'>8128610547fb: Pull complete 
</span><span class='line'>ae07a1a7f038: Pull complete 
</span><span class='line'>ceb23c4cb607: Pull complete 
</span><span class='line'>Digest: sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
</span><span class='line'>Status: Downloaded newer image for k8s.gcr.io/ingress-nginx/controller@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
</span><span class='line'>k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# docker pull k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660 
</span><span class='line'>k8s.gcr.io/ingress-nginx/kube-webhook-certgen@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660: Pulling from ingress-nginx/kube-webhook-certgen
</span><span class='line'>ec52731e9273: Pull complete 
</span><span class='line'>b90aa28117d4: Pull complete 
</span><span class='line'>Digest: sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>Status: Downloaded newer image for k8s.gcr.io/ingress-nginx/kube-webhook-certgen@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# docker save k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660 -o ingress-nginx-v1.1.2.tar
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# gzip ingress-nginx-v1.1.2.tar 
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# ll -h ingress-nginx-v1.1.2.tar.gz 
</span><span class='line'>-rw------- 1 root root 116M Mar 24 23:49 ingress-nginx-v1.1.2.tar.gz
</span></code></pre></td></tr></table></div></figure>


<p>本地Linux服务器加载镜像</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ docker load -i k8s.gcr.io-ingress-nginx-v1.1.2.tar.gz 
</span><span class='line'>c0d270ab7e0d: Loading layer [==================================================&gt;]  3.697MB/3.697MB
</span><span class='line'>ce7a3c1169b6: Loading layer [==================================================&gt;]  45.38MB/45.38MB
</span><span class='line'>e2eb06d8af82: Loading layer [==================================================&gt;]  5.865MB/5.865MB
</span><span class='line'>ab1476f3fdd9: Loading layer [==================================================&gt;]  120.9MB/120.9MB
</span><span class='line'>ad20729656ef: Loading layer [==================================================&gt;]  4.096kB/4.096kB
</span><span class='line'>0d5022138006: Loading layer [==================================================&gt;]  38.09MB/38.09MB
</span><span class='line'>8f757e3fe5e4: Loading layer [==================================================&gt;]  21.42MB/21.42MB
</span><span class='line'>d2bc6b915bc9: Loading layer [==================================================&gt;]  4.019MB/4.019MB
</span><span class='line'>bbeb6784ed45: Loading layer [==================================================&gt;]  313.9kB/313.9kB
</span><span class='line'>0c411e83ee78: Loading layer [==================================================&gt;]  6.141MB/6.141MB
</span><span class='line'>9c2d86dc137f: Loading layer [==================================================&gt;]  38.45MB/38.45MB
</span><span class='line'>7797e5b3a760: Loading layer [==================================================&gt;]  2.754MB/2.754MB
</span><span class='line'>98ef19df5514: Loading layer [==================================================&gt;]  4.096kB/4.096kB
</span><span class='line'>4cde87c7ecaf: Loading layer [==================================================&gt;]  51.75MB/51.75MB
</span><span class='line'>11536690d74a: Loading layer [==================================================&gt;]  3.584kB/3.584kB
</span><span class='line'>Loaded image ID: sha256:c41e9fcadf5a291120de706b7dfa1af598b9f2ed5138b6dcb9f79a68aad0ef4c
</span><span class='line'>Loaded image ID: sha256:7e5c1cecb086f36c6ef4b319a60853020820997f3600c3687e8ba6139e83674d
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ cat k8s.gcr.io-ingress-nginx-v1.1.2.tar.gz | ssh worker1 docker load 
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>docker tag 7e5c1cecb086 k8s.gcr.io/ingress-nginx/controller:v1.1.2
</span><span class='line'>docker tag c41e9fcadf5a k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>注：由于配置中用了sha码，下载后tag不同，把image最后的 @sha256:xxx 删掉
</span><span class='line'>vi ingress-nginx-controller-v1.1.2.yaml
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h3>创建服务</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f ingress-nginx-controller-v1.1.2.yaml
</span><span class='line'>namespace/ingress-nginx created
</span><span class='line'>serviceaccount/ingress-nginx created
</span><span class='line'>serviceaccount/ingress-nginx-admission created
</span><span class='line'>role.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>role.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>clusterrole.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>rolebinding.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>configmap/ingress-nginx-controller created
</span><span class='line'>service/ingress-nginx-controller created
</span><span class='line'>service/ingress-nginx-controller-admission created
</span><span class='line'>deployment.apps/ingress-nginx-controller created
</span><span class='line'>job.batch/ingress-nginx-admission-create created
</span><span class='line'>job.batch/ingress-nginx-admission-patch created
</span><span class='line'>ingressclass.networking.k8s.io/nginx created
</span><span class='line'>validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl wait --namespace ingress-nginx \
</span><span class='line'>   --for=condition=ready pod \
</span><span class='line'>   --selector=app.kubernetes.io/component=controller \
</span><span class='line'>   --timeout=120s
</span><span class='line'>pod/ingress-nginx-controller-755447bb4d-rnxvl condition met
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 状态参考：
</span><span class='line'># https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --namespace=ingress-nginx
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get all -n ingress-nginx
</span><span class='line'>NAME                                            READY   STATUS      RESTARTS   AGE
</span><span class='line'>pod/ingress-nginx-admission-create-hbt9d        0/1     Completed   0          2m51s
</span><span class='line'>pod/ingress-nginx-admission-patch-j8qfh         0/1     Completed   1          2m51s
</span><span class='line'>pod/ingress-nginx-controller-755447bb4d-rnxvl   1/1     Running     0          2m51s
</span><span class='line'>
</span><span class='line'>NAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
</span><span class='line'>service/ingress-nginx-controller             LoadBalancer   10.104.8.155    &lt;pending&gt;     80:31031/TCP,443:31845/TCP   2m51s
</span><span class='line'>service/ingress-nginx-controller-admission   ClusterIP      10.108.67.255   &lt;none&gt;        443/TCP                      2m51s
</span><span class='line'>
</span><span class='line'>NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>deployment.apps/ingress-nginx-controller   1/1     1            1           2m51s
</span><span class='line'>
</span><span class='line'>NAME                                                  DESIRED   CURRENT   READY   AGE
</span><span class='line'>replicaset.apps/ingress-nginx-controller-755447bb4d   1         1         1       2m51s
</span><span class='line'>
</span><span class='line'>NAME                                       COMPLETIONS   DURATION   AGE
</span><span class='line'>job.batch/ingress-nginx-admission-create   1/1           3s         2m51s
</span><span class='line'>job.batch/ingress-nginx-admission-patch    1/1           3s         2m51s
</span></code></pre></td></tr></table></div></figure>


<p>看到 ingress-nginx-controller 服务的 <code>EXTERNAL-IP</code> 为 <code>&lt;pending&gt;</code> ，由于本地搭建并没有配备负载均衡器，所以没有手段，获取不到对外的IP。</p>

<h3>本地测试</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl create deployment demo --image=httpd --port=80
</span><span class='line'>deployment.apps/demo created
</span><span class='line'>[ec2-user@k8s ~]$ kubectl expose deployment demo
</span><span class='line'>service/demo exposed
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl create ingress demo-localhost --class=nginx \
</span><span class='line'>   --rule=demo.localdev.me/*=demo:80
</span><span class='line'>ingress.networking.k8s.io/demo-localhost created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl port-forward --namespace=ingress-nginx service/ingress-nginx-controller 8080:80
</span><span class='line'>Forwarding from 127.0.0.1:8080 -&gt; 80
</span><span class='line'>Forwarding from [::1]:8080 -&gt; 80
</span><span class='line'>Handling connection for 8080
</span><span class='line'>Handling connection for 8080
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ curl http://demo.localdev.me:8080/
</span><span class='line'>&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<p>clean</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl delete deployment demo 
</span><span class='line'>kubectl delete service demo 
</span><span class='line'>kubectl delete ingress demo</span></code></pre></td></tr></table></div></figure>


<h2>集成（发布）</h2>

<h3>cloud</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#aws">https://kubernetes.github.io/ingress-nginx/deploy/#aws</a></li>
</ul>


<p>配置云厂商的负载均衡器。</p>

<h3>baremetal: nodeport</h3>

<p>适用于部署在裸机服务器上的 Kubernetes 集群，以及使用通用 Linux 发行版手动安装 Kubernetes 的 [原始] 虚拟机</p>

<p>为了快速测试，您可以使用 NodePort。这应该适用于几乎每个集群，但它通常会使用 30000-32767 范围内的端口。</p>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters">https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.2/deploy/static/provider/baremetal/deploy.yaml
</span></code></pre></td></tr></table></div></figure>


<p>注：也可以通过修改配置使用80，443等端口，但不推荐。</p>

<h3>baremetal: hostNetwork</h3>

<p>ingress nginx controller的pod网络直接使用主机网络，这个比Service Nodeport稍微灵活一点，可以自己选择/管理端口。</p>

<h3>A pure software solution: MetalLB</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb</a></li>
<li><a href="https://metallb.universe.tf/concepts/">https://metallb.universe.tf/concepts/</a></li>
</ul>


<p>It has two features that work together to provide this service: address allocation, and external announcement.</p>

<p>After MetalLB has assigned an external IP address to a service, it needs to make the network beyond the cluster aware that the IP “lives” in the cluster. MetalLB uses standard routing protocols to achieve this: ARP, NDP, or BGP.</p>

<h4>安装</h4>

<ul>
<li><a href="https://metallb.universe.tf/installation/">https://metallb.universe.tf/installation/</a></li>
</ul>


<p>需要kube-proxy配置arp为true。得与局域网进行广播通信，所以需要开启arp功能（标准路由协议）。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl edit configmap -n kube-system kube-proxy
</span><span class='line'>
</span><span class='line'>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span><span class='line'>kind: KubeProxyConfiguration
</span><span class='line'>mode: "ipvs"
</span><span class='line'>ipvs:
</span><span class='line'>  strictARP: true</span></code></pre></td></tr></table></div></figure>


<p>或者批处理一步到位</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># see what changes would be made, returns nonzero returncode if different
</span><span class='line'>kubectl get configmap kube-proxy -n kube-system -o yaml | \
</span><span class='line'>sed -e "s/strictARP: false/strictARP: true/" | \
</span><span class='line'>kubectl diff -f - -n kube-system
</span><span class='line'>
</span><span class='line'># actually apply the changes, returns nonzero returncode on errors only
</span><span class='line'>kubectl get configmap kube-proxy -n kube-system -o yaml | \
</span><span class='line'>sed -e "s/strictARP: false/strictARP: true/" | \
</span><span class='line'>kubectl apply -f - -n kube-system
</span></code></pre></td></tr></table></div></figure>


<p>安装</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml
</span><span class='line'>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml
</span></code></pre></td></tr></table></div></figure>


<p>下载镜像慢一点，需要稍微多等等。再查看状态：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get all -n metallb-system
</span><span class='line'>NAME                             READY   STATUS    RESTARTS   AGE
</span><span class='line'>pod/controller-57fd9c5bb-kc5zt   1/1     Running   0          5m55s
</span><span class='line'>pod/speaker-8pg4v                1/1     Running   0          5m55s
</span><span class='line'>pod/speaker-95bs8                1/1     Running   0          5m55s
</span><span class='line'>
</span><span class='line'>NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
</span><span class='line'>daemonset.apps/speaker   2         2         2       2            2           kubernetes.io/os=linux   5m55s
</span><span class='line'>
</span><span class='line'>NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>deployment.apps/controller   1/1     1            1           5m55s
</span><span class='line'>
</span><span class='line'>NAME                                   DESIRED   CURRENT   READY   AGE
</span><span class='line'>replicaset.apps/controller-57fd9c5bb   1         1         1       5m55s
</span></code></pre></td></tr></table></div></figure>


<h4>配置地址</h4>

<ul>
<li><p><a href="https://metallb.universe.tf/configuration/#layer-2-configuration">https://metallb.universe.tf/configuration/#layer-2-configuration</a></p></li>
<li><p><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb</a></p></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 查看主机ip，避开这些节点IP的区间
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get node -o wide
</span><span class='line'>NAME      STATUS   ROLES                  AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME
</span><span class='line'>k8s       Ready    control-plane,master   10d   v1.23.5   192.168.191.131   &lt;none&gt;        Amazon Linux 2   4.14.268-205.500.amzn2.x86_64   docker://20.10.7
</span><span class='line'>worker1   Ready    &lt;none&gt;                 10d   v1.23.5   192.168.191.132   &lt;none&gt;        Amazon Linux 2   4.14.268-205.500.amzn2.x86_64   docker://20.10.7
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ cat metallb-config.yml
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: ConfigMap
</span><span class='line'>metadata:
</span><span class='line'>  namespace: metallb-system
</span><span class='line'>  name: config
</span><span class='line'>data:
</span><span class='line'>  config: |
</span><span class='line'>    address-pools:
</span><span class='line'>    - name: default
</span><span class='line'>      protocol: layer2
</span><span class='line'>      addresses:
</span><span class='line'>      - 192.168.191.200-192.168.191.220
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f metallb-config.yml 
</span><span class='line'>configmap/config created
</span></code></pre></td></tr></table></div></figure>


<p>然后，再回过头重新安装一遍nginx-ingress：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --namespace=ingress-nginx
</span><span class='line'>NAME                                        READY   STATUS      RESTARTS   AGE
</span><span class='line'>ingress-nginx-admission-create-b9hkn        0/1     Completed   0          17s
</span><span class='line'>ingress-nginx-admission-patch-xmnbr         0/1     Completed   1          17s
</span><span class='line'>ingress-nginx-controller-755447bb4d-lfrwk   0/1     Running     0          17s
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --namespace=ingress-nginx
</span><span class='line'>NAME                                        READY   STATUS      RESTARTS   AGE
</span><span class='line'>ingress-nginx-admission-create-b9hkn        0/1     Completed   0          25s
</span><span class='line'>ingress-nginx-admission-patch-xmnbr         0/1     Completed   1          25s
</span><span class='line'>ingress-nginx-controller-755447bb4d-lfrwk   1/1     Running     0          25s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl -n ingress-nginx get svc
</span><span class='line'>NAME                                 TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
</span><span class='line'>ingress-nginx-controller             LoadBalancer   10.107.221.243   192.168.191.200   80:31443/TCP,443:30099/TCP   57s
</span><span class='line'>ingress-nginx-controller-admission   ClusterIP      10.105.12.185    &lt;none&gt;            443/TCP                      57s
</span></code></pre></td></tr></table></div></figure>


<p>这次 EXTERNAL-IP 的ip就有值了，上面配置的ip段里面一个ip。</p>

<h3>在线/集成测试</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#online-testing">https://kubernetes.github.io/ingress-nginx/deploy/#online-testing</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get service ingress-nginx-controller --namespace=ingress-nginx
</span><span class='line'>NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
</span><span class='line'>ingress-nginx-controller   LoadBalancer   10.107.221.243   192.168.191.200   80:31443/TCP,443:30099/TCP   4m
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl create deployment demo --image=httpd --port=80
</span><span class='line'>deployment.apps/demo created
</span><span class='line'>[ec2-user@k8s ~]$ kubectl expose deployment demo
</span><span class='line'>service/demo exposed
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl create ingress demo --class=nginx \
</span><span class='line'>   --rule="www.demo.io/*=demo:80"
</span><span class='line'>ingress.networking.k8s.io/demo created
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get ingress 
</span><span class='line'>NAME   CLASS   HOSTS         ADDRESS   PORTS   AGE
</span><span class='line'>demo   nginx   www.demo.io             80      42s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get ingress 
</span><span class='line'>NAME   CLASS   HOSTS         ADDRESS           PORTS   AGE
</span><span class='line'>demo   nginx   www.demo.io   192.168.191.200   80      27m
</span></code></pre></td></tr></table></div></figure>


<p>在本地windows机器的 <code>C:/Windows/System32/drivers/etc/hosts</code> 增加 <code>192.168.191.200 www.demo.io</code> ，然后浏览器访问 <code>http://www.demo.io/</code> ，顺利的话就能在浏览器看到：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>It works!</span></code></pre></td></tr></table></div></figure>


<h3>后记</h3>

<h4>理一下网络调用，其实就是nginx的方式：</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl logs --tail=2 pod/demo-764c97f6fd-q5xts
</span><span class='line'>10.244.2.79 - - [28/Mar/2022:09:52:36 +0000] "GET / HTTP/1.1" 200 45
</span><span class='line'>10.244.2.79 - - [28/Mar/2022:09:52:36 +0000] "GET /favicon.ico HTTP/1.1" 404 196
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -n ingress-nginx -o wide 
</span><span class='line'>NAME                                        READY   STATUS      RESTARTS   AGE    IP            NODE      NOMINATED NODE   READINESS GATES
</span><span class='line'>ingress-nginx-admission-create-b9hkn        0/1     Completed   0          157m   10.244.2.78   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>ingress-nginx-admission-patch-xmnbr         0/1     Completed   1          157m   10.244.2.77   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>ingress-nginx-controller-755447bb4d-lfrwk   1/1     Running     0          157m   10.244.2.79   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>
</span><span class='line'># 192.168.191.1是vmware虚拟网卡的地址
</span><span class='line'>[ec2-user@k8s ~]$ kubectl logs --tail=2 pod/ingress-nginx-controller-755447bb4d-lfrwk -n ingress-nginx 
</span><span class='line'>192.168.191.1 - - [28/Mar/2022:09:52:36 +0000] "GET / HTTP/1.1" 200 45 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.82 Safari/537.36" 566 0.000 [default-demo-80] [] 10.244.2.80:80 45 0.000 200 6d52ef8349eb3101c31c3cc6377b982b
</span><span class='line'>192.168.191.1 - - [28/Mar/2022:09:52:36 +0000] "GET /favicon.ico HTTP/1.1" 404 196 "http://www.demo.io/" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.82 Safari/537.36" 506 0.001 [default-demo-80] [] 10.244.2.80:80 196 0.000 404 fefe172a57273977cdcd1455bcf322ac
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>## web
</span><span class='line'>Request URL: http://www.demo.io/
</span><span class='line'>Request Method: GET
</span><span class='line'>Status Code: 200 OK
</span><span class='line'>Remote Address: 192.168.191.200:80
</span><span class='line'>Referrer Policy: strict-origin-when-cross-origin
</span></code></pre></td></tr></table></div></figure>


<h4>看看metallb的日志，ip是怎么分配的</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># https://metallb.universe.tf/concepts/layer2/
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -n metallb-system -o wide
</span><span class='line'>NAME                         READY   STATUS    RESTARTS   AGE     IP                NODE      NOMINATED NODE   READINESS GATES
</span><span class='line'>controller-57fd9c5bb-kc5zt   1/1     Running   0          3h34m   10.244.2.76       worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>speaker-8pg4v                1/1     Running   0          3h34m   192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>speaker-95bs8                1/1     Running   0          3h34m   192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl logs pod/controller-57fd9c5bb-kc5zt -n metallb-system
</span><span class='line'>{"caller":"level.go:63","event":"ipAllocated","ip":["192.168.191.200"],"level":"info","msg":"IP address assigned by controller","service":"ingress-nginx/ingress-nginx-controller","ts":"2022-03-28T07:16:22.675599527Z"}
</span><span class='line'>{"caller":"level.go:63","event":"serviceUpdated","level":"info","msg":"updated service object","service":"ingress-nginx/ingress-nginx-controller","ts":"2022-03-28T07:1
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl logs speaker-8pg4v -n metallb-system 
</span><span class='line'>{"caller":"level.go:63","event":"serviceAnnounced","ips":["192.168.191.200"],"level":"info","msg":"service has IP, announcing","pool":"default","protocol":"layer2","service":"ingress-nginx/ingress-nginx-controller","ts":"2022-03-28T07:16:42.775467559Z"}
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ ping 192.168.191.200
</span><span class='line'>PING 192.168.191.200 (192.168.191.200) 56(84) bytes of data.
</span><span class='line'>^C
</span><span class='line'>--- 192.168.191.200 ping statistics ---
</span><span class='line'>3 packets transmitted, 0 received, 100% packet loss, time 2055ms
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ arp 
</span><span class='line'>Address                  HWtype  HWaddress           Flags Mask            Iface
</span><span class='line'>192.168.191.200          ether   00:0c:29:d5:4f:0f   C                     eth0
</span><span class='line'>
</span><span class='line'># worker1节点的MAC
</span><span class='line'>[ec2-user@worker1 ~]$ ip a | grep -i -C 10 '00:0c:29:d5:4f:0f' 
</span><span class='line'>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
</span><span class='line'>    link/ether 00:0c:29:d5:4f:0f brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.191.132/24 brd 192.168.191.255 scope global dynamic eth0
</span><span class='line'>       valid_lft 1714sec preferred_lft 1714sec
</span><span class='line'>
</span><span class='line'># In layer 2 mode, all traffic for a service IP goes to one node. From there, kube-proxy spreads the traffic to all the service’s pods.
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -A -o wide | grep 192.168.191.132
</span><span class='line'>kube-system            kube-flannel-ds-q4qkt                        1/1     Running     8 (2d10h ago)   11d     192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            kube-proxy-pd77m                             1/1     Running     6 (3d2h ago)    11d     192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>metallb-system         speaker-8pg4v                                1/1     Running     0               5h31m   192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>例子：</h2>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#local-testing">https://kubernetes.github.io/ingress-nginx/deploy/#local-testing</a></li>
<li><a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/">https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/</a></li>
</ul>


<h2>验证</h2>

<ul>
<li><a href="https://www.qikqiak.com/post/visually-explained-k8s-service/">图解 Kubernetes Service</a></li>
<li><a href="https://www.qikqiak.com/post/visually-explained-k8s-ingress/">图解 Kubernetes Ingress</a></li>
</ul>


<p>文中说loadbalancer是通过了nodeport（会创建nodeport），还是有点诧异的。验证一番，果真如此！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get service ingress-nginx-controller --namespace=ingress-nginx
</span><span class='line'>NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
</span><span class='line'>ingress-nginx-controller   LoadBalancer   10.107.221.243   192.168.191.200   80:31443/TCP,443:30099/TCP   34m
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl describe service ingress-nginx-controller --namespace=ingress-nginx
</span><span class='line'>Name:                     ingress-nginx-controller
</span><span class='line'>Namespace:                ingress-nginx
</span><span class='line'>Labels:                   app.kubernetes.io/component=controller
</span><span class='line'>                          app.kubernetes.io/instance=ingress-nginx
</span><span class='line'>                          app.kubernetes.io/managed-by=Helm
</span><span class='line'>                          app.kubernetes.io/name=ingress-nginx
</span><span class='line'>                          app.kubernetes.io/part-of=ingress-nginx
</span><span class='line'>                          app.kubernetes.io/version=1.1.2
</span><span class='line'>                          helm.sh/chart=ingress-nginx-4.0.18
</span><span class='line'>Annotations:              &lt;none&gt;
</span><span class='line'>Selector:                 app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx
</span><span class='line'>Type:                     LoadBalancer
</span><span class='line'>IP Family Policy:         SingleStack
</span><span class='line'>IP Families:              IPv4
</span><span class='line'>IP:                       10.107.221.243
</span><span class='line'>IPs:                      10.107.221.243
</span><span class='line'>LoadBalancer Ingress:     192.168.191.200
</span><span class='line'>Port:                     http  80/TCP
</span><span class='line'>TargetPort:               http/TCP
</span><span class='line'>NodePort:                 http  31443/TCP
</span><span class='line'>Endpoints:                10.244.2.79:80
</span><span class='line'>Port:                     https  443/TCP
</span><span class='line'>TargetPort:               https/TCP
</span><span class='line'>NodePort:                 https  30099/TCP
</span><span class='line'>Endpoints:                10.244.2.79:443
</span><span class='line'>Session Affinity:         None
</span><span class='line'>External Traffic Policy:  Local
</span><span class='line'>HealthCheck NodePort:     31942
</span><span class='line'>Events:
</span><span class='line'>  Type    Reason        Age   From                Message
</span><span class='line'>  ----    ------        ----  ----                -------
</span><span class='line'>  Normal  IPAllocated   38m   metallb-controller  Assigned IP ["192.168.191.200"]
</span><span class='line'>  Normal  nodeAssigned  38m   metallb-speaker     announcing from node "worker1"
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ netstat -anp | grep 31443 
</span><span class='line'>(No info could be read for "-p": geteuid()=1002 but you should be root.)
</span><span class='line'>tcp        0      0 0.0.0.0:31443           0.0.0.0:*               LISTEN      -       
</span><span class='line'>
</span><span class='line'>[ec2-user@worker1 ~]$ netstat -anp | grep 31443
</span><span class='line'>(No info could be read for "-p": geteuid()=1002 but you should be root.)
</span><span class='line'>tcp        0      0 0.0.0.0:31443           0.0.0.0:*               LISTEN      -                   
</span></code></pre></td></tr></table></div></figure>


<h2>其他参考</h2>

<ul>
<li><a href="https://blog.51cto.com/tansong/4850092">多种方式访问AWS EKS的 Kubernetes Dashboard 下篇</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 创建证书
</span><span class='line'>openssl genrsa 2048 &gt; k8s-dashboard-private.key
</span><span class='line'>openssl req -new -x509 -nodes -sha1 -days 3650 -extensions v3_ca -key k8s-dashboard-private.key &gt; k8s-dashboard.crt
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://segmentfault.com/a/1190000019908991">k8s ingress原理及ingress-nginx部署测试</a></li>
</ul>


<p>&ndash;END</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Winse Liu</span></span>

      








  


<time datetime="2022-03-26T13:59:16+08:00" pubdate data-updated="true">Sat 2022-03-26 13:59</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/k8s/'>k8s</a>
  
</span>


	  <span style="padding: 0 1em;">
<a class="shellExecuteLink" href="npp-windows://e/_posts/2022-03-26-k8s-ingress.markdown" title="本地编辑"><i class="icon-edit"> </i>编辑</a>
</span>	
    </p>
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2022/03/18/k8s-guide-use-kubeadm/" title="Previous Post: k8s-v1.23.5安装指南 - 使用kubeadm">&laquo; k8s-v1.23.5安装指南 - 使用kubeadm</a>
      
      
        <a class="basic-alignment right" href="/blog/2022/04/06/minikube-guide/" title="Next Post: minikube guide">minikube guide &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
	
	
  
<!-- gitalk评论 start -->
    <div id="gitalk-container"></div> 
<!-- gitalk评论 end -->
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>



</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2023/11/18/reinstall-redmine-on-respberry2/">Reinstall Redmine on Raspberry2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/04/09/dingtalk-with-openai/">钉钉群机器人对接ChatGPT</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/26/clash-on-raspberry4/">树莓派4安装Clash</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/25/reinstall-raspberry2/">重新折腾raspberry2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/25/mirror-request/">请求复制/镜像</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/18/wechat-on-openai/">微信对接OpenAI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/02/01/git-reset-hard/">记git Reset --hard</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/02/01/register-openai/">注册OpenAI</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

<!-- key -->
	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (68) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/efficity/'>efficity</a> (23) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (16) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blog/'>blog</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/raspberry/'>raspberry</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (236)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<!--
  <h1>Softs, I'm using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
-->
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2024 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winse.github.io" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>







  <script type="text/javascript">
  jQuery(document).ready(function() {
    // Put a TOC right before the entry content.
    generateTOC('.entry-content', '目录');
	
	jQuery("#tocBlock").append(jQuery(".toc-icon"))
  });
  </script>



</body>
</html>
