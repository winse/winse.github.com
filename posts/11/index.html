
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="Redmine是类似JIRA的一个项目/BUG管理工具，使用ruby语言编写的。安装相对就麻烦一点，不熟嘛，一堆的东西要安装。有两种简单/傻瓜式的安装方式： bitnami-redmine，相当于一键安装；
docker + redmine，使用docker把所有的依赖都安装好， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winse.github.io/posts/11">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/libs/jquery.toc.min.js" type="text/javascript"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

<script src="/javascripts/generate-toc.js" type="text/javascript"></script>


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43198550-1', 'auto');
  ga('send', 'pageview');

</script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停, 熙熙攘攘, 忙忙碌碌, 不知何畏.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winse.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/18/redmine-deploy-and-install-plugins/">Redmine部署以及插件安装</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-09-18T23:46:24+08:00" pubdate data-updated="true">Mon 2017-09-18 23:46</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>Redmine是类似JIRA的一个项目/BUG管理工具，使用ruby语言编写的。安装相对就麻烦一点，不熟嘛，一堆的东西要安装。有两种简单/傻瓜式的安装方式：</p>

<ul>
<li>bitnami-redmine，相当于一键安装；</li>
<li>docker + redmine，使用docker把所有的依赖都安装好，只需要配置remine即可。</li>
</ul>


<p>这里选择使用docker-compose来安装： <a href="https://github.com/sameersbn/docker-redmine">sameersbn/redmine:3.4.2</a></p>

<h2>部署</h2>

<p>先跑起来，然后再根据需求修改配置。搞得不好的话，重新安装也超级简单，是吧！</p>

<ul>
<li><a href="https://github.com/sameersbn/docker-redmine#quick-start">https://github.com/sameersbn/docker-redmine#quick-start</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -p /srv/docker/redmine/{redmine,postgresql}
</span><span class='line'>
</span><span class='line'>wget https://raw.githubusercontent.com/sameersbn/docker-redmine/master/docker-compose.yml
</span><span class='line'>docker-compose up
</span></code></pre></td></tr></table></div></figure>


<p>启动后，浏览器访问 <a href="http://HOSTED_IP:10083">http://HOSTED_IP:10083</a> ，使用 admin/admin 登录。</p>

<ul>
<li>重新弄，初始化：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker-compose rm -f 或者 docker-compose down
</span><span class='line'>
</span><span class='line'>rm -rf /srv/docker/redmine/redmine/tmp/*
</span><span class='line'>rm -rf /srv/docker/redmine/postgresql/* 
</span><span class='line'>
</span><span class='line'>docker-compose up --build
</span><span class='line'>
</span><span class='line'>#docker-compose up -d
</span><span class='line'>#docker-compose start</span></code></pre></td></tr></table></div></figure>


<h2>Theme主题</h2>

<ul>
<li><a href="https://github.com/sameersbn/docker-redmine#themes">https://github.com/sameersbn/docker-redmine#themes</a></li>
<li><a href="http://www.redmine.org/projects/redmine/wiki/Themes">http://www.redmine.org/projects/redmine/wiki/Themes</a></li>
<li><a href="https://www.redmineup.com/pages/themes/a1">https://www.redmineup.com/pages/themes/a1</a></li>
</ul>


<p>改头换面，下载主题后放到 /srv/docker/redmine/redmine/themes/ 目录下。然后 <strong> 重启容器 </strong>，再重新登录，修改 <strong> 管理 - 配置 - 显示 - 主题 - A1 </strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s redmine]# ll /srv/docker/redmine/redmine/themes/
</span><span class='line'>total 0
</span><span class='line'>drwxr-xr-x. 6 es es 69 Sep 18 23:38 a1
</span></code></pre></td></tr></table></div></figure>


<h2>Plugins</h2>

<p>有些插件不兼容3.4，注意版本的选择！以下是在3.4下面安装使用的插件：</p>

<ul>
<li><a href="http://www.redmine.org/projects/redmine/wiki/Plugins">http://www.redmine.org/projects/redmine/wiki/Plugins</a></li>
<li><a href="http://www.redmine.org/plugins/clipboard_image_paste">http://www.redmine.org/plugins/clipboard_image_paste</a></li>
<li><a href="https://github.com/peclik/clipboard_image_paste">https://github.com/peclik/clipboard_image_paste</a></li>
<li><a href="http://www.redmine.org/plugins/redmine_checklists">http://www.redmine.org/plugins/redmine_checklists</a></li>
<li><a href="http://www.redmine.org/plugins/redmine_agile">http://www.redmine.org/plugins/redmine_agile</a></li>
<li><a href="https://github.com/paginagmbh/redmine_lightbox2.git">https://github.com/paginagmbh/redmine_lightbox2.git</a></li>
<li><a href="https://github.com/paginagmbh/redmine_lightbox2">https://github.com/paginagmbh/redmine_lightbox2</a></li>
<li><a href="http://www.redmine.org/plugins/mega_calendar">http://www.redmine.org/plugins/mega_calendar</a></li>
<li><a href="https://github.com/berti92/mega_calendar/wiki/Installation">https://github.com/berti92/mega_calendar/wiki/Installation</a></li>
<li><a href="http://www.redmine.org/plugins/redmine_work_time">http://www.redmine.org/plugins/redmine_work_time</a></li>
<li><a href="http://www.redmine.org/plugins/redmine_issue_templates">http://www.redmine.org/plugins/redmine_issue_templates</a></li>
<li>Kanban</li>
<li><a href="http://www.redmine.org/plugins/redhopper">http://www.redmine.org/plugins/redhopper</a></li>
<li><a href="http://www.redmine.org/plugins/redhopper">http://www.redmine.org/plugins/redhopper</a></li>
<li><a href="http://www.redmine.org/plugins/deployer">http://www.redmine.org/plugins/deployer</a></li>
<li><a href="https://github.com/zapic0/deployer">https://github.com/zapic0/deployer</a></li>
<li><a href="http://www.redmine.org/plugins/redmine-ckeditor">http://www.redmine.org/plugins/redmine-ckeditor</a></li>
<li><a href="https://github.com/a-ono/redmine_ckeditor">https://github.com/a-ono/redmine_ckeditor</a></li>
<li><a href="http://www.redmine.org/plugins/apijs">http://www.redmine.org/plugins/apijs</a> 有一些依赖要安装，没用到的可以不安装apijs这个插件。</li>
<li><a href="https://www.luigifab.info/redmine/en/apijs.php">https://www.luigifab.info/redmine/en/apijs.php</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s plugins]# sed -i '/haml/s/^/#/' redhopper/Gemfile           
</span><span class='line'>[root@k8s plugins]# mv apijs redmine_apijs
</span><span class='line'>
</span><span class='line'>[root@k8s redmine]# ll /srv/docker/redmine/redmine/plugins/
</span><span class='line'>total 0
</span><span class='line'>drwxr-xr-x.  8 es es 118 Sep 18 14:05 clipboard_image_paste
</span><span class='line'>drwxr-xr-x. 10 es es 212 Sep 18 19:18 deployer
</span><span class='line'>drwxr-xr-x.  7 es es 160 Sep 18 12:00 issuefy
</span><span class='line'>drwxr-xr-x.  4 es es  60 Sep 18 11:59 line_numbers
</span><span class='line'>drwxr-xr-x.  8 es es 182 Sep 17 18:05 mega_calendar
</span><span class='line'>drwxr-xr-x.  6 es es 158 Sep 18 12:00 open_flash_chart
</span><span class='line'>drwxrwxr-x.  8 es es 225 Sep 18 22:15 redhopper
</span><span class='line'>drwxr-xr-x.  9 es es 156 Sep  6 19:02 redmine_agile
</span><span class='line'>drwxr-xr-x.  7 es es 133 Sep 18 22:00 redmine_apijs
</span><span class='line'>drwxr-xr-x. 10 es es 119 Aug 30 21:46 redmine_checklists
</span><span class='line'>drwxr-xr-x.  9 es es 158 Sep 18 19:19 redmine_ckeditor
</span><span class='line'>drwxr-xr-x.  8 es es 221 Sep 18 12:01 redmine_code_review
</span><span class='line'>drwxr-xr-x.  8 es es 252 Sep 18 12:01 redmine_dashboard
</span><span class='line'>drwxr-xr-x.  3 es es  70 Sep 18 12:00 redmine_embedded_video
</span><span class='line'>drwxr-xr-x.  2 es es  78 Sep 18 12:00 redmine_gist
</span><span class='line'>drwxrwxr-x.  8 es es 129 Aug  5 10:52 redmine_issue_templates
</span><span class='line'>drwxr-xr-x.  8 es es 170 Sep 18 17:46 redmine_lightbox2
</span><span class='line'>drwxr-xr-x.  8 es es 160 Mar  5  2017 redmine_work_time</span></code></pre></td></tr></table></div></figure>


<p>不重启容器的话，可以登录到容器把 ~/data/plugins 拷贝到 ~/redmine/plugins 下面，然后执行下面的命令进行更新：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@f0481f5f8cda:/home/redmine/redmine# 
</span><span class='line'>bundle install --without development test
</span><span class='line'>bundle exec rake redmine:plugins:migrate RAILS_ENV=production
</span><span class='line'>
</span><span class='line'>supervisorctl restart unicorn
</span></code></pre></td></tr></table></div></figure>


<h2>其他的一些插件</h2>

<ul>
<li><a href="http://www.redmine.org/plugins/dmsf">http://www.redmine.org/plugins/dmsf</a></li>
<li><a href="https://github.com/danmunn/redmine_dmsf">https://github.com/danmunn/redmine_dmsf</a></li>
<li><a href="http://www.redmine.org/plugins/redmine_git_hosting">http://www.redmine.org/plugins/redmine_git_hosting</a> X</li>
<li><a href="http://www.redmine.org/plugins/redmine_upwork_plugin">http://www.redmine.org/plugins/redmine_upwork_plugin</a></li>
<li><a href="https://github.com/alexbevi/redmine_knowledgebase">https://github.com/alexbevi/redmine_knowledgebase</a></li>
<li><a href="https://github.com/danmunn/redmine_dmsf">https://github.com/danmunn/redmine_dmsf</a></li>
<li><a href="https://github.com/jbox-web/redmine_jenkins">https://github.com/jbox-web/redmine_jenkins</a></li>
<li><a href="https://github.com/masweetman/issue_charts">https://github.com/masweetman/issue_charts</a></li>
<li>3.3.x</li>
<li><a href="http://www.redmine.org/plugins/redmine_pivot_table">http://www.redmine.org/plugins/redmine_pivot_table</a></li>
<li><a href="https://www.redmine.org/plugins/advanced_roadmap_v2">https://www.redmine.org/plugins/advanced_roadmap_v2</a></li>
<li><a href="https://github.com/Coren/redmine_advanced_roadmap_v2">https://github.com/Coren/redmine_advanced_roadmap_v2</a></li>
<li><a href="https://github.com/Loriowar/redmine_issues_tree">https://github.com/Loriowar/redmine_issues_tree</a></li>
<li><a href="https://github.com/speedy32129/projects_show">https://github.com/speedy32129/projects_show</a></li>
</ul>


<h2>参考</h2>

<ul>
<li><a href="https://github.com/bitnami/bitnami-docker-redmine">https://github.com/bitnami/bitnami-docker-redmine</a></li>
<li><a href="http://11398377.blog.51cto.com/11388377/1875686">http://11398377.blog.51cto.com/11388377/1875686</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/17/docker-compose-hello/">Docker Compose入门</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-09-17T08:48:25+08:00" pubdate data-updated="true">Sun 2017-09-17 08:48</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>使用Docker也一段时间了，一开始直接使用命令行 docker run 来启动的，后面使用 k8s 来管理，对于多机环境来说还是挺方便的。但是如果仅仅是单机上面跑docker容器，安装一套 k8s 的话也挺尴尬的。</p>

<p>docker提供了compose编排的功能，通过配置文件的方式来启动、管理（多）容器的运行。有点启动脚本的意思，当然也包含一些管理的元素，对容器LifeCycle的管理。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s composetest]# docker version
</span><span class='line'>Client:
</span><span class='line'> Version:      1.12.6
</span><span class='line'> API version:  1.24
</span><span class='line'> Go version:   go1.6.4
</span><span class='line'> Git commit:   78d1802
</span><span class='line'> Built:        Tue Jan 10 20:20:01 2017
</span><span class='line'> OS/Arch:      linux/amd64
</span><span class='line'>
</span><span class='line'>Server:
</span><span class='line'> Version:      1.12.6
</span><span class='line'> API version:  1.24
</span><span class='line'> Go version:   go1.6.4
</span><span class='line'> Git commit:   78d1802
</span><span class='line'> Built:        Tue Jan 10 20:20:01 2017
</span><span class='line'> OS/Arch:      linux/amd64
</span><span class='line'> 
</span><span class='line'>[root@k8s composetest]# docker-compose version
</span><span class='line'>docker-compose version 1.16.1, build 6d1ac21
</span><span class='line'>docker-py version: 2.5.1
</span><span class='line'>CPython version: 2.7.13
</span><span class='line'>OpenSSL version: OpenSSL 1.0.1t  3 May 2016
</span></code></pre></td></tr></table></div></figure>


<p>docker的版本需要和compose配置的版本适配： <a href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a> ，docker-1.12的话，compose version不能高于 2.1。<a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#build">Compose file version 2</a> 。</p>

<p>先安装官网的helloworld来运行一个例子：</p>

<ul>
<li><a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></li>
<li><a href="https://docs.docker.com/compose/gettingstarted/#prerequisites">https://docs.docker.com/compose/gettingstarted/#prerequisites</a></li>
</ul>


<h2>安装：</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 浏览器下载docker-compose
</span><span class='line'>https://github.com/docker/compose/releases/download/1.16.1/docker-compose-Linux-x86_64
</span><span class='line'>
</span><span class='line'>[root@k8s opt]# cd /usr/local/bin/
</span><span class='line'>[root@k8s bin]# rz
</span><span class='line'>rz waiting to receive.
</span><span class='line'>Starting zmodem transfer.  Press Ctrl+C to cancel.
</span><span class='line'>Transferring docker-compose-Linux-x86_64 (1)...
</span><span class='line'>  100%    8648 KB    4324 KB/sec    00:00:02       0 Errors  
</span><span class='line'>
</span><span class='line'>[root@k8s bin]# mv docker-compose-Linux-x86_64 docker-compose
</span><span class='line'>[root@k8s bin]# chmod +x docker-compose 
</span></code></pre></td></tr></table></div></figure>


<h2>Hello World:</h2>

<p>官网是一个访问量统计的例子，通过python网站结合redis来实现。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s composetest]# ll
</span><span class='line'>total 16
</span><span class='line'>-rw-r--r--. 1 root root 303 Sep 17 08:09 app.py
</span><span class='line'>-rw-r--r--. 1 root root 112 Sep 17 08:39 docker-compose.yml
</span><span class='line'>-rw-r--r--. 1 root root 114 Sep 17 08:42 Dockerfile
</span><span class='line'>-rw-r--r--. 1 root root  13 Sep 17 08:09 requirements.txt
</span><span class='line'>
</span><span class='line'>[root@k8s composetest]# cat app.py 
</span><span class='line'>from flask import Flask
</span><span class='line'>from redis import Redis
</span><span class='line'>
</span><span class='line'>app = Flask(__name__)
</span><span class='line'>redis = Redis(host='redis', port=6379)
</span><span class='line'>
</span><span class='line'>@app.route('/')
</span><span class='line'>def hello():
</span><span class='line'>  count = redis.incr('hits')
</span><span class='line'>  return 'Hello World! I have been seen {} times.\n'.format(count)
</span><span class='line'>
</span><span class='line'>if __name__ == "__main__":
</span><span class='line'>  app.run(host="0.0.0.0", debug=True)
</span><span class='line'>
</span><span class='line'>[root@k8s composetest]# cat requirements.txt 
</span><span class='line'>flask
</span><span class='line'>redis
</span><span class='line'>
</span><span class='line'>[root@k8s composetest]# cat Dockerfile 
</span><span class='line'>FROM python:3.4-alpine
</span><span class='line'>
</span><span class='line'>ADD . /code
</span><span class='line'>WORKDIR /code
</span><span class='line'>
</span><span class='line'>RUN pip install -r requirements.txt
</span><span class='line'>
</span><span class='line'>CMD ["python", "app.py"]
</span><span class='line'>
</span><span class='line'>[root@k8s composetest]# cat docker-compose.yml 
</span><span class='line'>version: '2.1'
</span><span class='line'>services:
</span><span class='line'>  web:
</span><span class='line'>    build: .
</span><span class='line'>    ports:
</span><span class='line'>      - "5000:5000"
</span><span class='line'>  redis:
</span><span class='line'>    image: "redis:alpine"
</span></code></pre></td></tr></table></div></figure>


<p>依赖的镜像可以提前下载好，可以不修改docker配置的情况下来下载，参考<a href="https://raw.githubusercontent.com/winse/shell-not-just-on-work/master/docker-download-mirror.sh">docker-download-mirror.sh</a></p>

<p>写好配置后，运行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s composetest]# docker-compose up --build
</span><span class='line'>Building web
</span><span class='line'>Step 1 : FROM python:3.4-alpine
</span><span class='line'> ---&gt; 27a0e572c13a
</span><span class='line'>Step 2 : ADD . /code
</span><span class='line'> ---&gt; 84082044fb5e
</span><span class='line'>Removing intermediate container 7c4675b618da
</span><span class='line'>Step 3 : WORKDIR /code
</span><span class='line'> ---&gt; Running in a014af85b748
</span><span class='line'> ---&gt; 2ada42bd756c
</span><span class='line'>Removing intermediate container a014af85b748
</span><span class='line'>Step 4 : RUN pip install -r requirements.txt
</span><span class='line'> ---&gt; Running in 4be6f8f5c8b8
</span><span class='line'>Collecting flask (from -r requirements.txt (line 1))
</span><span class='line'>  Downloading Flask-0.12.2-py2.py3-none-any.whl (83kB)
</span><span class='line'>Collecting redis (from -r requirements.txt (line 2))
</span><span class='line'>  Downloading redis-2.10.6-py2.py3-none-any.whl (64kB)
</span><span class='line'>Collecting Jinja2&gt;=2.4 (from flask-&gt;-r requirements.txt (line 1))
</span><span class='line'>  Downloading Jinja2-2.9.6-py2.py3-none-any.whl (340kB)
</span><span class='line'>Collecting click&gt;=2.0 (from flask-&gt;-r requirements.txt (line 1))
</span><span class='line'>  Downloading click-6.7-py2.py3-none-any.whl (71kB)
</span><span class='line'>Collecting itsdangerous&gt;=0.21 (from flask-&gt;-r requirements.txt (line 1))
</span><span class='line'>  Downloading itsdangerous-0.24.tar.gz (46kB)
</span><span class='line'>Collecting Werkzeug&gt;=0.7 (from flask-&gt;-r requirements.txt (line 1))
</span><span class='line'>  Downloading Werkzeug-0.12.2-py2.py3-none-any.whl (312kB)
</span><span class='line'>Collecting MarkupSafe&gt;=0.23 (from Jinja2&gt;=2.4-&gt;flask-&gt;-r requirements.txt (line 1))
</span><span class='line'>  Downloading MarkupSafe-1.0.tar.gz
</span><span class='line'>Building wheels for collected packages: itsdangerous, MarkupSafe
</span><span class='line'>  Running setup.py bdist_wheel for itsdangerous: started
</span><span class='line'>  Running setup.py bdist_wheel for itsdangerous: finished with status 'done'
</span><span class='line'>  Stored in directory: /root/.cache/pip/wheels/fc/a8/66/24d655233c757e178d45dea2de22a04c6d92766abfb741129a
</span><span class='line'>  Running setup.py bdist_wheel for MarkupSafe: started
</span><span class='line'>  Running setup.py bdist_wheel for MarkupSafe: finished with status 'done'
</span><span class='line'>  Stored in directory: /root/.cache/pip/wheels/88/a7/30/e39a54a87bcbe25308fa3ca64e8ddc75d9b3e5afa21ee32d57
</span><span class='line'>Successfully built itsdangerous MarkupSafe
</span><span class='line'>Installing collected packages: MarkupSafe, Jinja2, click, itsdangerous, Werkzeug, flask, redis
</span><span class='line'>Successfully installed Jinja2-2.9.6 MarkupSafe-1.0 Werkzeug-0.12.2 click-6.7 flask-0.12.2 itsdangerous-0.24 redis-2.10.6
</span><span class='line'> ---&gt; ee3e476d4fad
</span><span class='line'>Removing intermediate container 4be6f8f5c8b8
</span><span class='line'>Step 5 : CMD python app.py
</span><span class='line'> ---&gt; Running in f2f9eefe782e
</span><span class='line'> ---&gt; 08e3065107b2
</span><span class='line'>Removing intermediate container f2f9eefe782e
</span><span class='line'>Successfully built 08e3065107b2
</span><span class='line'>Recreating composetest_web_1 ... 
</span><span class='line'>Recreating composetest_web_1
</span><span class='line'>Starting composetest_redis_1 ... 
</span><span class='line'>Recreating composetest_web_1 ... done
</span><span class='line'>Attaching to composetest_redis_1, composetest_web_1
</span><span class='line'>redis_1  | 1:C 17 Sep 00:43:45.012 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
</span><span class='line'>redis_1  | 1:C 17 Sep 00:43:45.013 # Redis version=4.0.1, bits=64, commit=00000000, modified=0, pid=1, just started
</span><span class='line'>redis_1  | 1:C 17 Sep 00:43:45.013 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 * Running mode=standalone, port=6379.
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 # Server initialized
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 * DB loaded from disk: 0.000 seconds
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 * Ready to accept connections
</span><span class='line'>web_1    |  * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)
</span><span class='line'>web_1    |  * Restarting with stat
</span><span class='line'>web_1    |  * Debugger is active!
</span><span class='line'>web_1    |  * Debugger PIN: 175-303-648</span></code></pre></td></tr></table></div></figure>


<p>查看容器状态：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s opt]# curl http://0.0.0.0:5000/
</span><span class='line'>Hello World! I have been seen 1 times.
</span><span class='line'>[root@k8s opt]# curl http://0.0.0.0:5000/
</span><span class='line'>Hello World! I have been seen 2 times.
</span><span class='line'>
</span><span class='line'>[root@k8s composetest]# docker-compose ps 
</span><span class='line'>       Name                      Command               State           Ports         
</span><span class='line'>-------------------------------------------------------------------------------------
</span><span class='line'>composetest_redis_1   docker-entrypoint.sh redis ...   Up      6379/tcp              
</span><span class='line'>composetest_web_1     python app.py                    Up      0.0.0.0:5000-&gt;5000/tcp
</span><span class='line'>
</span><span class='line'>##
</span><span class='line'>docker-compose rm -f # Remove stopped containers
</span><span class='line'>docker-compose down  # Stop and remove containers, networks, images, and volumes
</span></code></pre></td></tr></table></div></figure>


<h2>其他</h2>

<p>后台运行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose up -d
</span><span class='line'>$ docker-compose ps</span></code></pre></td></tr></table></div></figure>


<p>在指定容器内执行命令：有点类似 docker exec/kubectl exec</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose run web env</span></code></pre></td></tr></table></div></figure>


<p><a href="https://docs.docker.com/compose/production/#deploying-changes">单独编译运行</a> 仅更改过内容的容器：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose build web
</span><span class='line'>$ docker-compose up --no-deps -d web</span></code></pre></td></tr></table></div></figure>


<p>配置<a href="https://docs.docker.com/compose/extends/#extending-services">复用/覆写</a>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
</span><span class='line'>
</span><span class='line'># A
</span><span class='line'>webapp:
</span><span class='line'>  build: .
</span><span class='line'>  ports:
</span><span class='line'>    - "8000:8000"
</span><span class='line'>  volumes:
</span><span class='line'>    - "/data"
</span><span class='line'>   
</span><span class='line'># EA   
</span><span class='line'>web:
</span><span class='line'>  extends:
</span><span class='line'>    file: common-services.yml
</span><span class='line'>    service: webapp
</span><span class='line'>    </span></code></pre></td></tr></table></div></figure>


<h2>学习</h2>

<ul>
<li><a href="https://yeasy.gitbooks.io/docker_practice/content/compose/commands.html">Compose 命令</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/02/zookeeper-acl/">Zookeeper ACL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-09-02T23:14:55+08:00" pubdate data-updated="true">Sat 2017-09-02 23:14</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>集群又一次进行安检，SSH躲不过需要升级的，这次还加了hadoop security和zookeeper acl的bug。以前没太在意这些内容，既然安全检查出来了，还是需要处理的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ZooKeeper 未授权访问【原理扫描】
</span><span class='line'>详细描述  ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现，是Hadoop和Hbase的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。 
</span><span class='line'>ZooKeeper的目标就是封装好复杂易出错的关键服务，将简单易用的接口和性能高效、功能稳定的系统提供给用户。 
</span><span class='line'>在通常情况下，zookeeper允许未经授权的访问。
</span><span class='line'>解决办法  为ZooKeeper配置相应的访问权限。 
</span><span class='line'>
</span><span class='line'>方式一： 
</span><span class='line'>1）增加一个认证用户 
</span><span class='line'>addauth digest 用户名:密码明文 
</span><span class='line'>eg. addauth digest user1:password1 
</span><span class='line'>2）设置权限 
</span><span class='line'>setAcl /path auth:用户名:密码明文:权限 
</span><span class='line'>eg. setAcl /test auth:user1:password1:cdrwa 
</span><span class='line'>3）查看Acl设置 
</span><span class='line'>getAcl /path 
</span><span class='line'>
</span><span class='line'>方式二： 
</span><span class='line'>setAcl /path digest:用户名:密码密文:权限
</span><span class='line'>
</span><span class='line'>威胁分值  5.0
</span><span class='line'>危险插件  否
</span><span class='line'>发现日期  2015-02-10
</span></code></pre></td></tr></table></div></figure>


<h2>Zookeeper权限基本知识点、操作</h2>

<ul>
<li><a href="https://zookeeper.apache.org/doc/r3.3.3/zookeeperProgrammers.html#sc_ZooKeeperAccessControl">https://zookeeper.apache.org/doc/r3.3.3/zookeeperProgrammers.html#sc_ZooKeeperAccessControl</a></li>
<li><a href="https://my.oschina.net/guol/blog/1358538">https://my.oschina.net/guol/blog/1358538</a></li>
<li><a href="http://blog.csdn.net/xyang81/article/details/53147894">http://blog.csdn.net/xyang81/article/details/53147894</a></li>
<li><a href="https://ihong5.wordpress.com/2014/07/24/apache-zookeeper-setting-acl-in-zookeeper-client/">https://ihong5.wordpress.com/2014/07/24/apache-zookeeper-setting-acl-in-zookeeper-client/</a></li>
<li><a href="https://zookeeper.apache.org/doc/r3.3.3/zookeeperStarted.html">https://zookeeper.apache.org/doc/r3.3.3/zookeeperStarted.html</a></li>
</ul>


<p>Note also that an ACL pertains only to a specific znode. In particular it does not apply to children. ACL在znode上无继承性，也就是说子znode不会继承父znode的ACL权限.</p>

<ul>
<li>world has a single id, anyone, that represents anyone.</li>
<li>auth doesn&rsquo;t use any id, represents any authenticated user.</li>
<li>digest uses a username:password string to generate MD5 hash which is then used as an ACL ID identity. Authentication is done by sending the username:password in clear text. When used in the ACL the expression will be the username:base64 encoded SHA1 password digest.</li>
<li>ip uses the client host IP as an ACL ID identity. The ACL expression is of the form addr/bits(3.5+) where the most significant bits of addr are matched against the most significant bits of the client host IP.</li>
</ul>


<p>zookeeper的ACL格式为 schema:id:permissions 。模式就是上面列的几种，再加一个super。创建的节点默认权限为 world:anyone:rwadc 表示所有人都对这个节点有rwadc的权限。</p>

<ul>
<li>Create：允许对子节点Create 操作</li>
<li>Read：允许对本节点GetChildren 和GetData 操作</li>
<li>Write ：允许对本节点SetData 操作</li>
<li>Delete ：允许对子节点Delete 操作</li>
<li>Admin ：允许对本节点setAcl 操作</li>
</ul>


<h2>Auth授权</h2>

<p>不需要id，当前 &ldquo;登录&rdquo; 的所有users都有权限（sasl、kerberos这些授权方式不懂，囧)。虽然不需要id，但是格式还得按照 scheme:id:perm 的写法。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 15] setAcl /c auth:rwadc  
</span><span class='line'>auth:rwadc does not have the form scheme:id:perm
</span><span class='line'>Acl is not valid : /c
</span><span class='line'>
</span><span class='line'>[zk: k8s(CONNECTED) 13] addauth digest a:a
</span><span class='line'>[zk: k8s(CONNECTED) 14] addauth digest b:b
</span><span class='line'>[zk: k8s(CONNECTED) 15] addauth digest c:c
</span><span class='line'>[zk: k8s(CONNECTED) 16] create /e e
</span><span class='line'>Created /e
</span><span class='line'>[zk: k8s(CONNECTED) 17] setAcl /e auth::cdrwa
</span><span class='line'>...省略节点输出信息
</span><span class='line'>
</span><span class='line'>[zk: k8s(CONNECTED) 18] getAcl /e
</span><span class='line'>'digest,'a:mDmPUap4qvYwm+PZOtJ/scGyHLY=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'b:+F8zPn3x1CLx3qpYHEaRwIheWcc=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'c:K7CO7OxIfBOQxczG+7FI9BdZ6/s=
</span><span class='line'>: cdrwa</span></code></pre></td></tr></table></div></figure>


<p>id随便写也可以，zookeeper都不记录的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 9] addauth digest hdfs:hdfs    
</span><span class='line'>[zk: localhost:2181(CONNECTED) 10] setAcl /c auth:x:x:rwadc
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 11] getAcl /c               
</span><span class='line'>'digest,'user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'hdfs:0wpra2yK6RCUB9sbo0BkElpzcl8=
</span><span class='line'>: cdrwa</span></code></pre></td></tr></table></div></figure>


<p>也可以对根 / 授权，这样客户端就不能随便在根下面新建节点了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 9] addauth digest user:password    
</span><span class='line'>[zk: localhost:2181(CONNECTED) 21] setAcl / auth::rawdc
</span><span class='line'>
</span><span class='line'>重新登录
</span><span class='line'>[zk: localhost:2181(CONNECTED) 0] ls /
</span><span class='line'>Authentication is not valid : /
</span><span class='line'>[zk: localhost:2181(CONNECTED) 1] getAcl /
</span><span class='line'>'digest,'user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=
</span><span class='line'>: cdrwa
</span></code></pre></td></tr></table></div></figure>


<p>还原</p>

<p>使用有权限的用户/实例，如果都忘了那就只能放绝招：使用超级管理员登录，重新设置权限为world即可。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 26] setAcl / world:anyone:cdrwa</span></code></pre></td></tr></table></div></figure>


<h2>Digest</h2>

<p>直接用起来比 auth 简单，直接把密文交给zookeeper。首先得生成对应用户的密码。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s zookeeper-3.4.10]# java -cp zookeeper-3.4.10.jar:lib/* org.apache.zookeeper.server.auth.DigestAuthenticationProvider user:password
</span><span class='line'>user:password-&gt;user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=
</span><span class='line'>
</span><span class='line'>[root@k8s zookeeper-3.4.10]# java -cp zookeeper-3.4.10.jar:lib/* org.apache.zookeeper.server.auth.DigestAuthenticationProvider es:es
</span><span class='line'>es:es-&gt;es:KiHfMOSWCTgPKpz78IL/6qO8AEE=</span></code></pre></td></tr></table></div></figure>


<p>scheme是digest的时候，id需要密文。通过Zookeeper的客户端编码方式添加认证（登录），digest对应的auth数据是明文。</p>

<p>ACL授权一样使用 setAcl ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$$ A实例
</span><span class='line'>[zk: localhost:2181(CONNECTED) 17] setAcl /b digest:user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=:cdrwa
</span><span class='line'>和md5密码类似，数据库被盗了，如果是常用的密码会被猜出来
</span><span class='line'>[zk: localhost:2181(CONNECTED) 18] getAcl /b
</span><span class='line'>'digest,'user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=
</span><span class='line'>: cdrwa
</span><span class='line'>
</span><span class='line'>$$ B实例
</span><span class='line'>重新登录：
</span><span class='line'>[zk: k8s:2181(CONNECTED) 2] ls /b
</span><span class='line'>Authentication is not valid : /b
</span><span class='line'>
</span><span class='line'>$$ A实例
</span><span class='line'>[zk: localhost:2181(CONNECTED) 20] create /b/bb ''
</span><span class='line'>Authentication is not valid : /b/bb
</span><span class='line'>[zk: localhost:2181(CONNECTED) 21] addauth digest user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=
</span><span class='line'>[zk: localhost:2181(CONNECTED) 22] create /b/bb ''                                 
</span><span class='line'>Authentication is not valid : /b/bb
</span><span class='line'>
</span><span class='line'># 需要使用明文登录
</span><span class='line'>[zk: localhost:2181(CONNECTED) 23] addauth digest user:password
</span><span class='line'>[zk: localhost:2181(CONNECTED) 24] create /b/bb '' 
</span><span class='line'>Created /b/bb 
</span><span class='line'>
</span><span class='line'># 权限没有继承性
</span><span class='line'>[zk: localhost:2181(CONNECTED) 25] getAcl /b/bb
</span><span class='line'>'world,'anyone
</span><span class='line'>: cdrwa</span></code></pre></td></tr></table></div></figure>


<h1>IP</h1>

<p>ip的权限配置更简单些。逻辑就是匹配客户端的IP地址，在权限IP地址段范围内的才能访问。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$$ A实例
</span><span class='line'>[zk: localhost:2181(CONNECTED) 18] setAcl /i ip:127.0.0.1:cdrwa
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 19] getAcl /i
</span><span class='line'>'ip,'127.0.0.1
</span><span class='line'>: cdrwa
</span><span class='line'>[zk: localhost:2181(CONNECTED) 24] get /i
</span><span class='line'>Authentication is not valid : /i
</span><span class='line'>
</span><span class='line'>咋回事呢，就是本地还没权限？有时可localhost不一定对应127.0.0.1的。。。
</span><span class='line'>
</span><span class='line'>$$ B实例
</span><span class='line'>[root@k8s zookeeper-3.4.10]# bin/zkCli.sh -server 127.0.0.1
</span><span class='line'>[zk: 127.0.0.1(CONNECTED) 0] get /i
</span><span class='line'>i
</span><span class='line'>...
</span><span class='line'>改成另一个网卡的ip地址
</span><span class='line'>[zk: 127.0.0.1(CONNECTED) 1] setAcl /i ip:192.168.191.138:cdrwa
</span><span class='line'>...
</span><span class='line'>[zk: 127.0.0.1(CONNECTED) 2] getAcl /i
</span><span class='line'>'ip,'192.168.191.138
</span><span class='line'>: cdrwa
</span><span class='line'>[zk: 127.0.0.1(CONNECTED) 3] get /i
</span><span class='line'>Authentication is not valid : /i
</span><span class='line'>
</span><span class='line'>$$ C实例
</span><span class='line'>用主机名(191.138)登录的实例
</span><span class='line'>[zk: k8s(CONNECTED) 19] get /i
</span><span class='line'>i</span></code></pre></td></tr></table></div></figure>


<h2>超级管理员</h2>

<p>如果权限设置错了，咋办？</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: k8s(CONNECTED) 21] setAcl /i ip:192.168.191.0/24:cdrwa                   
</span><span class='line'>Acl is not valid : /i
</span><span class='line'>
</span><span class='line'>[zk: k8s(CONNECTED) 25] setAcl /i ip:192.168.191.0:cdrwa
</span><span class='line'>
</span><span class='line'>[zk: k8s(CONNECTED) 26] getAcl /i
</span><span class='line'>'ip,'192.168.191.0
</span><span class='line'>: cdrwa
</span><span class='line'>[zk: k8s(CONNECTED) 27] get /i
</span><span class='line'>Authentication is not valid : /i</span></code></pre></td></tr></table></div></figure>


<p>除非把客户端的ip地址换成 192.168.191.0 否则就访问不了了。</p>

<p>此时需要超级管理员才行，不然真没办法折腾了。（不知道为啥）是可以删掉（特指我当前的环境啊），但是这样数据就没有了啊！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 26] getAcl /i
</span><span class='line'>'ip,'192.168.191.0
</span><span class='line'>: cdrwa
</span><span class='line'>[zk: localhost:2181(CONNECTED) 27] delete /i
</span><span class='line'>[zk: localhost:2181(CONNECTED) 28] ls /
</span><span class='line'>[a, b, c, zookeeper, d, e]
</span><span class='line'>[zk: localhost:2181(CONNECTED) 29] ls /i
</span><span class='line'>Node does not exist: /i</span></code></pre></td></tr></table></div></figure>


<p>如果数据很重要，重启后用超级管理员的方式找回密码还是很划的来的。</p>

<ul>
<li><a href="https://community.hortonworks.com/articles/29900/zookeeper-using-superdigest-to-gain-full-access-to.html">https://community.hortonworks.com/articles/29900/zookeeper-using-superdigest-to-gain-full-access-to.html</a></li>
</ul>


<p>用 DigestAuthenticationProvider 加密就不操作了，直接用 es:es 对应的 es:es->es:KiHfMOSWCTgPKpz78IL/6qO8AEE= 作为管理员的账号密码。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export SERVER_JVMFLAGS=-Dzookeeper.DigestAuthenticationProvider.superDigest=es:KiHfMOSWCTgPKpz78IL/6qO8AEE=
</span><span class='line'>
</span><span class='line'>[root@k8s zookeeper-3.4.10]# bin/zkServer.sh stop
</span><span class='line'>[root@k8s zookeeper-3.4.10]# bin/zkServer.sh start
</span><span class='line'>ZooKeeper JMX enabled by default
</span><span class='line'>Using config: /opt/zookeeper-3.4.10/bin/../conf/zoo.cfg
</span><span class='line'>Starting zookeeper ... STARTED
</span><span class='line'>
</span><span class='line'>$$ A实例
</span><span class='line'>[root@k8s zookeeper-3.4.10]# bin/zkCli.sh 
</span><span class='line'>[zk: localhost:2181(CONNECTED) 0] get /i
</span><span class='line'>Authentication is not valid : /i
</span><span class='line'>[zk: localhost:2181(CONNECTED) 1] getAcl /i
</span><span class='line'>'ip,'192.168.191.0
</span><span class='line'>: cdrwa
</span><span class='line'>[zk: localhost:2181(CONNECTED) 2] addauth digest es:es
</span><span class='line'>[zk: localhost:2181(CONNECTED) 3] get /i
</span><span class='line'>i
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 4] setAcl /i world:anyone:cdrwa
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>$$ B实例
</span><span class='line'>[zk: localhost:2181(CONNECTED) 0] get /i
</span><span class='line'>i
</span><span class='line'>[zk: localhost:2181(CONNECTED) 1] getAcl /i
</span><span class='line'>'world,'anyone
</span><span class='line'>: cdrwa
</span></code></pre></td></tr></table></div></figure>


<h2>实践&mdash;好玩</h2>

<p>权限可以直接在创建的时刻指定：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>create /mynode content digest:user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=:cdrwa</span></code></pre></td></tr></table></div></figure>


<p>也可以一次性设置N个权限：</p>

<p>注：以下操作都是超级管理员登录的窗口，所以不存在权限的问题。想怎么改就怎么改</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setAcl /i ip:192.168.191.0:cdrwa,ip:127.0.0.1:cdrwa,ip:192.168.191.138:cdrwa
</span><span class='line'>
</span><span class='line'>getAcl /i
</span><span class='line'>'ip,'192.168.191.0
</span><span class='line'>: cdrwa
</span><span class='line'>'ip,'127.0.0.1
</span><span class='line'>: cdrwa
</span><span class='line'>'ip,'192.168.191.138
</span><span class='line'>: cdrwa
</span></code></pre></td></tr></table></div></figure>


<p>但是，使用ip、digest、word重设权限后，会覆盖旧的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 7] setAcl /i ip:0.0.0.0:cdrwa
</span><span class='line'>[zk: localhost:2181(CONNECTED) 8] getAcl /i
</span><span class='line'>'ip,'0.0.0.0
</span><span class='line'>: cdrwa
</span><span class='line'>
</span><span class='line'>[zk: localhost:2181(CONNECTED) 15] setAcl /i world:anyone:cdraw
</span><span class='line'>[zk: localhost:2181(CONNECTED) 16] getAcl /i
</span><span class='line'>'world,'anyone
</span><span class='line'>: cdrwa
</span></code></pre></td></tr></table></div></figure>


<p>3.4的版本不支持ip段（3.5应该是ok的）： <a href="https://github.com/apache/zookeeper/blob/release-3.4.10/src/java/main/org/apache/zookeeper/server/auth/IPAuthenticationProvider.java#L114">IPAuthenticationProvider</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public boolean isValid(String id) {
</span><span class='line'>    return addr2Bytes(id) != null;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>可以找对应版本的源码（远程）调试下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s zookeeper-3.4.10]# export SERVER_JVMFLAGS="-Dzookeeper.DigestAuthenticationProvider.superDigest=es:KiHfMOSWCTgPKpz78IL/6qO8AEE= -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005"
</span><span class='line'>[root@k8s zookeeper-3.4.10]# bin/zkServer.sh start
</span></code></pre></td></tr></table></div></figure>


<p>auth的权限比较有意思：自家兄弟添加、排除异己；permission按最新的算</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 21] setAcl /i auth::cdrwa,ip:0.0.0.0:cd
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 22] getAcl /i
</span><span class='line'>'ip,'0.0.0.0
</span><span class='line'>: cd
</span><span class='line'>'digest,'es:KiHfMOSWCTgPKpz78IL/6qO8AEE=
</span><span class='line'>: cdrwa
</span><span class='line'>
</span><span class='line'># auth add
</span><span class='line'>[zk: localhost:2181(CONNECTED) 27] addauth digest m:m
</span><span class='line'>[zk: localhost:2181(CONNECTED) 28] addauth digest n:n
</span><span class='line'>[zk: localhost:2181(CONNECTED) 29] setAcl /i auth::cdrwa
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 30] getAcl /i
</span><span class='line'>'digest,'es:KiHfMOSWCTgPKpz78IL/6qO8AEE=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'m:WZiIgWqJgd8EQVBh55Bslf/7JRc=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'n:TZ3f1UF7B75EF5g6qWR0VmEvb/s=
</span><span class='line'>: cdrwa
</span><span class='line'>
</span><span class='line'># perm
</span><span class='line'>[zk: localhost:2181(CONNECTED) 31] addauth digest z:z
</span><span class='line'>[zk: localhost:2181(CONNECTED) 32] addauth digest l:l
</span><span class='line'>[zk: localhost:2181(CONNECTED) 33] setAcl /i auth:z:z:cd
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 34] getAcl /i
</span><span class='line'>'digest,'es:KiHfMOSWCTgPKpz78IL/6qO8AEE=
</span><span class='line'>: cd
</span><span class='line'>'digest,'m:WZiIgWqJgd8EQVBh55Bslf/7JRc=
</span><span class='line'>: cd
</span><span class='line'>'digest,'n:TZ3f1UF7B75EF5g6qWR0VmEvb/s=
</span><span class='line'>: cd
</span><span class='line'>'digest,'z:cOgtYxFOAwKiTCMigcN2j2fFI3c=
</span><span class='line'>: cd
</span><span class='line'>'digest,'l:gdlgatwJdq7uG8kFfIjcIZj0tnQ=
</span><span class='line'>: cd
</span><span class='line'>
</span><span class='line'>可以看到全部变成cd了
</span><span class='line'>
</span><span class='line'>[zk: localhost:2181(CONNECTED) 35] setAcl /i auth:z:z:cdraw
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 36] getAcl /i               
</span><span class='line'>'digest,'es:KiHfMOSWCTgPKpz78IL/6qO8AEE=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'m:WZiIgWqJgd8EQVBh55Bslf/7JRc=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'n:TZ3f1UF7B75EF5g6qWR0VmEvb/s=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'z:cOgtYxFOAwKiTCMigcN2j2fFI3c=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'l:gdlgatwJdq7uG8kFfIjcIZj0tnQ=
</span><span class='line'>: cdrwa
</span><span class='line'>
</span><span class='line'>全部变成cdrwa
</span></code></pre></td></tr></table></div></figure>


<p>我觉得用 auth 设置权限是最保险的，不会搞错了出现自己都访问不了的情况。</p>

<h2>后记</h2>

<p>ok，到此基本的知识点算大概了解了。还有自定义实现授权的provider，这有点高级了有兴趣的自己去看官方文档了。</p>

<p>但是因为权限没有继承关系，像一些开源项目用到zookeeper的话，怎么进行加密呢？所有子目录都一个个的加？或者自定义根路径（chroot）让别人猜不到？</p>

<p>还有像zookeeper自己的目录 /zookeeper ，怎么进行权限管理呢？</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/31/jenkins-build-via-shell/">命令行调用Jenkins2.63打包</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-08-31T01:26:40+08:00" pubdate data-updated="true">Thu 2017-08-31 01:26</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>Jenkins给集成打包带来了很多的便捷，让不懂开发的同事也能轻松的打包。但是对于开发和运维来说，可能还需要在打包之外做一些事情，以及批量的处理N个打包。</p>

<p>对于研发来说，重复是最难忍受的。Jenkins可以直接通过api来调用查看和处理各种请求。</p>

<p>网络上资料其实挺多的。也有直接一个脚本直接搞定部署的。知其然知其所以然，还是需要自己下功夫理解人家的脚本这样才能更好的用（先不说自己写了）。主要的就是三个步骤：</p>

<ol>
<li>怎么登陆: <a href="https://wiki.jenkins.io/display/JENKINS/Jenkins+Script+Console#JenkinsScriptConsole-Remoteaccess">JenkinsScriptConsole-Remoteaccess</a> .|. <a href="https://wiki.jenkins.io/display/JENKINS/Remote+access+API#RemoteaccessAPI-CSRFProtection">RemoteaccessAPI-CSRFProtection</a></li>
<li>执行build：<a href="http://www.inanzzz.com/index.php/post/jnrg/running-jenkins-build-via-command-line">Running jenkins jobs via command line</a> .|. <a href="https://www.nczonline.net/blog/2015/10/triggering-jenkins-builds-by-url/">Triggering Jenkins builds by URL</a></li>
<li>检查结果：<a href="https://gist.githubusercontent.com/julianchurchill/8780920/raw/ae3ab0c120857b0fe69fe3718d720cb4ef94c4b8/checkJenkins.sh">checkJenkins.sh</a></li>
</ol>


<h2>crumb</h2>

<p>首先来看看crumb是啥</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@iZ9416vn227Z opt]# curl -X POST $JENKINS_PROJ_AUTH_URL/build
</span><span class='line'>&lt;html&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>&lt;meta http-equiv="Content-Type" content="text/html;charset=utf-8"/&gt;
</span><span class='line'>&lt;title&gt;Error 403 No valid crumb was included in the request&lt;/title&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>&lt;body&gt;&lt;h2&gt;HTTP ERROR 403&lt;/h2&gt;
</span><span class='line'>&lt;p&gt;Problem accessing /job/helloworld/build. Reason:
</span><span class='line'>&lt;pre&gt;    No valid crumb was included in the request&lt;/pre&gt;&lt;/p&gt;&lt;hr&gt;&lt;a href="http://eclipse.org/jetty"&gt;Powered by Jetty:// 9.4.z-SNAPSHOT&lt;/a&gt;&lt;hr/&gt;
</span><span class='line'>
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<p>这里<a href="https://wiki.jenkins.io/display/JENKINS/Jenkins+Script+Console#JenkinsScriptConsole-RemoteaccesswithCSRFprotectionenabled">CSRF</a> 相当于jenkins做的一个权限控制，有两种方式处理：</p>

<p>方法一：取消控制</p>

<ul>
<li><a href="http://www.zhyea.com/2016/10/14/resolve-no-valid-crumb-was-included-in-the-request-error.html">no valid crumb was included in the request解决</a></li>
<li><a href="https://github.com/ghale/gradle-jenkins-plugin/issues/78#issuecomment-215783175">No valid crumb was included in the request</a></li>
</ul>


<p>在菜单 系统管理 –> Configure Global Security 中调整设置: 取消 防止跨站点请求伪造(Prevent Cross Site Request Forgery exploits) 的勾选。 如果还坚持要启用“防止跨站点请求伪造”，就需要先动态获取crumb。</p>

<p>方法二：获取token</p>

<ul>
<li><a href="https://stackoverflow.com/questions/16738441/how-to-request-for-crumb-issuer-for-jenkins">How to request for Crumb issuer for jenkins</a></li>
<li><a href="http://russellsimpkins.blogspot.jp/2014/10/calling-jenkins-job-with-bash-script.html">Calling a jenkins job with a bash script</a></li>
<li><a href="https://support.cloudbees.com/hc/en-us/articles/218889337-How-to-build-a-job-using-the-REST-API-and-cURL-">https://support.cloudbees.com/hc/en-us/articles/218889337-How-to-build-a-job-using-the-REST-API-and-cURL-</a></li>
</ul>


<p>通过URL: crumbIssuer/api/json 获取token的键值，然后把它附加到build请求的HEADER。</p>

<h2>命令行通过URL请求jenkins进行编译</h2>

<ul>
<li><a href="http://blog.csdn.net/xian312854159/article/details/41118245">使用shell脚本curl调用jenkins进行构建并判断是否构建成功 </a></li>
<li><a href="https://wiki.jenkins.io/display/JENKINS/Remote+access+API">Remote access API</a></li>
<li><a href="https://wiki.jenkins.io/display/JENKINS/Authenticating+scripted+clients">https://wiki.jenkins.io/display/JENKINS/Authenticating+scripted+clients</a></li>
<li><a href="https://wiki.jenkins.io/display/JENKINS/Jenkins+Script+Console">https://wiki.jenkins.io/display/JENKINS/Jenkins+Script+Console</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>JENKINS_ID="admin:PASSWORD"
</span><span class='line'>JENKINS_PROJ_AUTH_URL=http://$JENKINS_ID@localhost:18080/job/helloworld
</span><span class='line'>JENKINS_PROJ_URL=http://localhost:18080/job/helloworld
</span><span class='line'>
</span><span class='line'>curl $JENKINS_PROJ_AUTH_URL/lastBuild/api/json
</span><span class='line'>
</span><span class='line'>#Get the current configuration and save it locally
</span><span class='line'>curl -X GET $JENKINS_PROJ_URL/config.xml
</span><span class='line'>
</span><span class='line'>curl 'http://'$JENKINS_ID'@localhost:18080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,":",//crumb)'
</span><span class='line'>Jenkins-Crumb:a4296173a91d900c11af07d932559fcd
</span><span class='line'>
</span><span class='line'>curl -X POST -H "Jenkins-Crumb:a4296173a91d900c11af07d932559fcd"  $JENKINS_PROJ_AUTH_URL/build
</span><span class='line'>
</span><span class='line'>curl -s $JENKINS_PROJ_AUTH_URL/lastBuild/api/json | jq .
</span><span class='line'>
</span><span class='line'># --- TODO ---
</span><span class='line'>
</span><span class='line'>progress（排队中）|pending（构建中），每三秒去重新获取结果进行判断  
</span><span class='line'>while grep -qE "In progress|pending" build.tmp2;  
</span><span class='line'>
</span><span class='line'>if grep -qE "Success" build.tmp2 ;then  
</span><span class='line'>elif grep -qE "Unstable" build.tmp2 ;then  
</span><span class='line'>elif grep -qE "Failed|Aborted" build.tmp2 ;then  
</span><span class='line'>echo "#Open Link: ${jobPage}${newbuild}/console see details"  
</span></code></pre></td></tr></table></div></figure>


<p>BuildName</p>

<ul>
<li><a href="https://wiki.jenkins.io/display/JENKINS/Build+Name+Setter+Plugin">https://wiki.jenkins.io/display/JENKINS/Build+Name+Setter+Plugin</a></li>
<li><a href="https://stackoverflow.com/questions/42172320/how-to-set-the-jenkins-build-name-based-on-some-conditions">https://stackoverflow.com/questions/42172320/how-to-set-the-jenkins-build-name-based-on-some-conditions</a></li>
<li><a href="https://stackoverflow.com/questions/30111298/how-to-use-build-name-setter-plugin">https://stackoverflow.com/questions/30111298/how-to-use-build-name-setter-plugin</a></li>
</ul>


<p>jenkins的使用案例</p>

<ul>
<li><a href="http://debugtalk.com/post/iOS-Android-Packing-with-Jenkins-details/">http://debugtalk.com/post/iOS-Android-Packing-with-Jenkins-details/</a></li>
</ul>


<h2>参考</h2>

<p>API使用</p>

<ul>
<li><a href="https://gist.githubusercontent.com/julianchurchill/8780920/raw/ae3ab0c120857b0fe69fe3718d720cb4ef94c4b8/checkJenkins.sh">https://gist.githubusercontent.com/julianchurchill/8780920/raw/ae3ab0c120857b0fe69fe3718d720cb4ef94c4b8/checkJenkins.sh</a></li>
<li><a href="https://www.nczonline.net/blog/2015/10/triggering-jenkins-builds-by-url/">Triggering Jenkins builds by URL</a></li>
</ul>


<p>登录/权限问题</p>

<ul>
<li><a href="https://stackoverflow.com/questions/10698419/how-can-a-jenkins-user-authentication-details-be-passed-to-a-script-which-uses">https://stackoverflow.com/questions/10698419/how-can-a-jenkins-user-authentication-details-be-passed-to-a-script-which-uses</a></li>
<li><a href="http://www.scmgalaxy.com/tutorials/ways-to-login-jenkins-using-command-line">http://www.scmgalaxy.com/tutorials/ways-to-login-jenkins-using-command-line</a></li>
<li><a href="https://wiki.jenkins.io/display/JENKINS/Jenkins+Script+Console#JenkinsScriptConsole-Remoteaccess">https://wiki.jenkins.io/display/JENKINS/Jenkins+Script+Console#JenkinsScriptConsole-Remoteaccess</a></li>
<li><a href="http://russellsimpkins.blogspot.jp/2014/10/calling-jenkins-job-with-bash-script.html">Calling a jenkins job with a bash script</a></li>
<li><a href="https://issues.jenkins-ci.org/browse/JENKINS-42200">No valid crumb was included in the request in kubernetes</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/23/vagrant-create-your-own-box/">Vagrant创建自定义的BOX</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-08-23T07:04:17+08:00" pubdate data-updated="true">Wed 2017-08-23 07:04</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>在《奔跑吧Ansible》中接触了Vagrant+VirtualBox，但是感觉一般般，也没觉得很特别的：就自己安装虚拟机差不多嘛。</p>

<p>后面在网上了解了一些关于这两工具，很多人用来搭建开发环境，脑子瞬间被击中了&mdash;还可以这么玩。这样系统重装的时刻就不用那么纠结和犹豫了，很多软件都安装在VirtualBox里面，重装后，直接启动虚拟机，就一切的开发环境的软件就都回来了。还有集群的搭建也挺方便的：由于Vagrant是命令行的方式结合配置来启动了，非常方便。</p>

<p>官方网站 <a href="http://www.vagrantbox.es/">Vagrantbox.es</a> <a href="https://app.vagrantup.com/boxes/search">Discover Vagrant Boxes</a> 有提供一些镜像，如Centos6:</p>

<ul>
<li><a href="https://app.vagrantup.com/centos/boxes/6">https://app.vagrantup.com/centos/boxes/6</a></li>
<li><a href="https://app.vagrantup.com/matchy/boxes/centos6-i386">https://app.vagrantup.com/matchy/boxes/centos6-i386</a> 。</li>
</ul>


<p>但是网络提供的不总能满足需要。所以有时还得亲自下手从零开始创建自己的Box。制作Vagrant的Box需要遵循一些要求/规范，官网有提供文档和说明：</p>

<ul>
<li><a href="https://www.vagrantup.com/docs/boxes/base.html">https://www.vagrantup.com/docs/boxes/base.html</a></li>
<li><a href="https://www.vagrantup.com/docs/virtualbox/boxes.html">https://www.vagrantup.com/docs/virtualbox/boxes.html</a></li>
<li><a href="https://unifreak.github.io/tutorial/Making-my-first-vagrant-box">制作自己第一个 vagrant box</a></li>
<li><a href="http://xuclv.blog.51cto.com/5503169/1239351">如何制作一个vagrant的base box</a></li>
</ul>


<p>为啥用vagrant：<a href="https://www.oschina.net/translate/get-vagrant-up-and-running-in-no-time">https://www.oschina.net/translate/get-vagrant-up-and-running-in-no-time</a></p>

<blockquote><p>在本地开发爽。用Vagrant快，简单，并可帮助你同时管理多个开发环境。</p>

<p>想象一下，你正在和据说15人的团队开发一个应用程序。这个程序真是狂棒！它使用Laravel的PHP框架，Redis和Memcached，ImageMagick和GD的PHP模块，curl，MySQL和PostgreSQL， 甚至MongoDB。 另外，Laravel明确依赖PHP版本5.3.7或更高版本，以及mcrypt的PHP扩展。</p>

<p>理想情况下，你会希望团队所有的15人在开发这个应用程序时，都是相同的开发环境。 但是不是所有的开发团队，都有系统管理的专家或者培养一个系统管理。获得相同设置的开发环境可能是一个非常艰巨的任务。 最重要的是，有些人使用的是Mac，而其他人则使用Linux或Windows。在它之前，开发人员会纠结在无尽的配置中，用电脑扔墙而筋疲力尽。</p></blockquote>

<p>其实，步骤不多也不是很复杂，但是总会遇到一些特定环境的问题。下来是我制作的过程（Vagrant1.9+VirutalBox5.1+Centos6.9_i686）。</p>

<p>还有其他的优点：</p>

<ul>
<li>还有配置化后，就可以可以进行版本管理。</li>
<li>分享。</li>
</ul>


<h2>下载安装系统</h2>

<ul>
<li>下载安装 VirtualBox ：<a href="https://www.virtualbox.org/">https://www.virtualbox.org/</a></li>
<li>下载安装 Vagrant ：<a href="http://www.vagrantup.com/">http://www.vagrantup.com/</a></li>
<li>操作系统 <a href="http://mirrors.zju.edu.cn/centos/6.9/isos/i386/">bin-DVD1.iso</a></li>
</ul>


<p>不要安装LiveDVD的版本会把桌面也安装了，系统大几个G，其实用不到图形界面。用DVD的安装没有mininal的系统。</p>

<h2>系统网络</h2>

<p>安装VirutalBox5.1完后，Windows宿主机多了一个 VirtualBox Host-Only Ethernet Adapter 本地网卡，可以先在VirtualBox菜单 [管理-全局设定-网络] 里删除Host-Only Network网卡。</p>

<p>在安装之前需要先了解VirtualBox的网卡的配置，它的选项/含义和VmWare不太一致，需要单独学习了解下：</p>

<ul>
<li>未指定： 相当于虚拟机没有插上网线的情况，此时与宿主机也连不通。</li>
<li>网络地址转换(NAT)：通过NAT转换仅通过HOST主机访问网络，但是访问不到虚拟机（单向的）。需要通过端口转发功能HOST主机才能连接到虚拟机。单机上网最简单的方式。</li>
<li>NAT网络</li>
<li>桥接网卡：虚拟机桥接到宿主机的一块网卡，直接与外部交换数据包，像是不经过宿主机一样。虚拟机能够设置一个独立的IP，所有网络功能完全和在网络中的真实机器一样(通过路由器来自动分配IP地址)。</li>
<li>内部网络：只虚拟机互通的网络。可以相互访问，前提是在设置网络时，两台虚拟机设置同一网络名称。</li>
<li>仅主机(Host-Only)网络：内部网络和桥接模式的混合，需要一个虚拟的网卡来配合。此时虚拟机可以和宿主机及宿主机所在的局域网通信，无法与外网通信。看F1帮助文档里面的，感觉和内部网络差不多，由于HOST主机 多了个网卡可以和HOST通信（通过Host Only网卡的IP），但虚拟机需要上网的话还需要再多配置一个桥接网络。</li>
<li>通用驱动</li>
</ul>


<p>网上的一些资料：</p>

<ul>
<li><a href="http://www.live-in.org/archives/789.html">http://www.live-in.org/archives/789.html</a></li>
<li><a href="https://liuliqiang.info/post/29/">https://liuliqiang.info/post/29/</a> 非常详细</li>
<li><a href="https://www.douban.com/group/topic/15558388/">https://www.douban.com/group/topic/15558388/</a> 和上一篇一样不知道谁抄谁，都看过就列在这里了</li>
<li><a href="https://serverfault.com/questions/225155/virtualbox-how-to-set-up-networking-so-both-host-and-guest-can-access-internet">VirtualBox: How to set up networking so both host and guest can access internet and talk to each other</a> NAT / host only;   use a Bridge Adapter 桥接</li>
<li><a href="https://superuser.com/questions/521072/cant-ping-guest-os-in-virtualbox-but-guests-can-ping-host">Can&rsquo;t ping guest OS in VirtualBox, but guests can ping host</a></li>
</ul>


<h2>配置</h2>

<p>安装系统后默认eth0的网卡是没有启用的。修改网络配置然后重启网络。</p>

<p>如果网卡启动失败，用 ifconfig -a 看看设备是不是eth0。</p>

<p>接下来就是连接系统，然后配置Vagrant了。</p>

<ul>
<li><a href="https://unifreak.github.io/tutorial/Making-my-first-vagrant-box">制作自己第一个 vagrant box</a></li>
<li><a href="http://xuclv.blog.51cto.com/5503169/1239351">如何制作一个vagrant的base box</a></li>
</ul>


<p>为了后面的配置更加顺利，需要先把网络调通。在虚拟机的黑窗口操作是非常不方便的，添加端口转发然后本地用Putty/git-ssh等工具登录系统操作 <a href="https://stackoverflow.com/questions/9885108/ssh-to-vagrant-box-in-windows">SSH to Vagrant box in Windows?</a> 。</p>

<p>接下来按照官网的说明进行配置：</p>

<ul>
<li><a href="https://www.vagrantup.com/docs/boxes/base.html#quot-vagrant-quot-user">https://www.vagrantup.com/docs/boxes/base.html#quot-vagrant-quot-user</a></li>
<li><a href="https://www.vagrantup.com/docs/virtualbox/boxes.html#to-install-via-the-command-line-">https://www.vagrantup.com/docs/virtualbox/boxes.html#to-install-via-the-command-line-</a></li>
<li><a href="https://www.vagrantup.com/docs/virtualbox/boxes.html#virtual-machine">https://www.vagrantup.com/docs/virtualbox/boxes.html#virtual-machine</a></li>
<li><a href="https://www.vagrantup.com/docs/boxes/base.html#testing-the-box">https://www.vagrantup.com/docs/boxes/base.html#testing-the-box</a></li>
</ul>


<p>步骤如下：</p>

<ol>
<li>增加帐号密码均为 vagrant ，root密码也是 vagrant</li>
<li>配置sudo</li>
<li>配置无密钥登录使用密钥进行登录，同时把insecure的 <a href="https://github.com/mitchellh/vagrant/tree/master/keys">vagrant的公钥</a> 写入authorized_key</li>
<li>安装tools</li>
<li>清理yum缓冲，tmp目录下的内容，以及其他的一些临时文件</li>
<li>删掉、禁用虚拟机多余的设备</li>
<li>第一个网卡设置为NAT（用于vagrant的端口转发，并且这网卡要boot启动啊！） <a href="https://www.vagrantup.com/docs/virtualbox/boxes.html#virtual-machine">boxes.html#virtual-machine</a></li>
<li>打包，进入到虚拟机存储的目录(可以通过【设置-高级】的备份位置确定），然后执行 <code>vagrant package --base centos6_i386</code></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# passwd
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# useradd vagrant
</span><span class='line'>[root@localhost ~]# passwd vagrant
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# echo 'vagrant ALL=(ALL) NOPASSWD: ALL' &gt;/etc/sudoers
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# su - vagrant
</span><span class='line'>[vagrant@localhost ~]$ mkdir .ssh && chmod 700 .ssh && cd .ssh
</span><span class='line'>[vagrant@localhost .ssh]$ curl https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant.pub -o authorized_keys 
</span><span class='line'>[vagrant@localhost .ssh]$ chmod 600 authorized_keys 
</span></code></pre></td></tr></table></div></figure>


<p>这里单独把安装tools执行的命令抽取出来：</p>

<ul>
<li><a href="https://superuser.com/questions/412527/modprobe-vboxguest-failed">https://superuser.com/questions/412527/modprobe-vboxguest-failed</a> 关键</li>
<li><a href="https://www.if-not-true-then-false.com/2010/install-virtualbox-guest-additions-on-fedora-centos-red-hat-rhel/comment-page-5/#comment-121648">https://www.if-not-true-then-false.com/2010/install-virtualbox-guest-additions-on-fedora-centos-red-hat-rhel/comment-page-5/#comment-121648</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wget http://download.virtualbox.org/virtualbox/5.1.26/VBoxGuestAdditions_5.1.26.iso
</span><span class='line'>curl -o VBoxGuestAdditions_5.1.26.iso http://download.virtualbox.org/virtualbox/5.1.26/VBoxGuestAdditions_5.1.26.iso
</span><span class='line'>mkdir /media/VBoxGuestAdditions
</span><span class='line'>mount -o loop,ro VBoxGuestAdditions_5.1.26.iso /media/VBoxGuestAdditions
</span></code></pre></td></tr></table></div></figure>


<p>事情总归不会一帆风顺的，依赖需要进行处理，如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# sh /media/VBoxGuestAdditions/VBoxLinuxAdditions.run 
</span><span class='line'>Verifying archive integrity... All good.
</span><span class='line'>Uncompressing VirtualBox 5.1.26 Guest Additions for Linux...........
</span><span class='line'>VirtualBox Guest Additions installer
</span><span class='line'>Copying additional installer modules ...
</span><span class='line'>Installing additional modules ...
</span><span class='line'>vboxadd.sh: Starting the VirtualBox Guest Additions.
</span><span class='line'>Failed to set up service vboxadd, please check the log file
</span><span class='line'>/var/log/VBoxGuestAdditions.log for details.
</span><span class='line'>[root@localhost ~]# cat /var/log/VBoxGuestAdditions.log
</span><span class='line'>
</span><span class='line'>vboxadd.sh: failed: Look at /var/log/vboxadd-install.log to find out what went wrong.
</span><span class='line'>vboxadd.sh: failed: Look at /var/log/vboxadd-install.log to find out what went wrong.
</span><span class='line'>vboxadd.sh: failed: modprobe vboxguest failed.
</span><span class='line'>[root@localhost ~]# cat /var/log/vboxadd-install.log
</span><span class='line'>/tmp/vbox.0/Makefile.include.header:112: *** Error: unable to find the sources of your current Linux kernel. Specify KERN_DIR=&lt;directory&gt; and run Make again.  Stop.
</span><span class='line'>Creating user for the Guest Additions.
</span><span class='line'>Creating udev rule for the Guest Additions kernel module.
</span><span class='line'>
</span><span class='line'># 处理
</span><span class='line'>[root@localhost ~]# yum install gcc make patch glibc-headers glibc-devel kernel-headers -y 
</span><span class='line'>[root@localhost ~]# yum install kernel-devel # / yum install kernel-devel-2.6.32-696.el6.i686  
</span><span class='line'>[root@localhost ~]# export KERN_DIR=/usr/src/kernels/2.6.32-696.6.3.el6.i686  &lt;- 根据情况改
</span><span class='line'>[root@localhost ~]# sh /media/VBoxGuestAdditions/VBoxLinuxAdditions.run 
</span><span class='line'>Verifying archive integrity... All good.
</span><span class='line'>Uncompressing VirtualBox 5.1.26 Guest Additions for Linux...........
</span><span class='line'>VirtualBox Guest Additions installer
</span><span class='line'>Removing installed version 5.1.26 of VirtualBox Guest Additions...
</span><span class='line'>vboxadd.sh: Stopping VirtualBox Additions.
</span><span class='line'>Copying additional installer modules ...
</span><span class='line'>Installing additional modules ...
</span><span class='line'>vboxadd.sh: Starting the VirtualBox Guest Additions.
</span><span class='line'>
</span><span class='line'>Could not find the X.Org or XFree86 Window System, skipping.
</span></code></pre></td></tr></table></div></figure>


<p>安装配置(jdk/tomcat/mysql/pgsql/redis/&hellip;)好后，打包前清理缓冲：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum clean all
</span><span class='line'>history -c
</span><span class='line'>rm -rf ~/.bash_history
</span><span class='line'>rm -rf /tmp/* /var/log/* /var/cache/*</span></code></pre></td></tr></table></div></figure>


<p>然后打开windows的命令行，进入到虚拟机磁盘文件目录打包：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>C:\Users\XXXX\VirtualBox VMs\centos6_i386&gt;vagrant package --base centos6_i386
</span><span class='line'>2017/08/24 07:18:04 launcher: detected 32bit Windows installation
</span><span class='line'>==&gt; centos6_i386: Clearing any previously set forwarded ports...
</span><span class='line'>==&gt; centos6_i386: Exporting VM...
</span><span class='line'>==&gt; centos6_i386: Compressing package to: C:/Users/XXXX/VirtualBox VMs/centos6_i386/package.box
</span></code></pre></td></tr></table></div></figure>


<h2>搭建开发环境</h2>

<ul>
<li><a href="https://blog.smdcn.net/article/1308.html">使用Vagrant在Windows下部署开发环境</a> 非常好的一篇文章</li>
<li><a href="https://blog.codecentric.de/en/2012/02/automated-virtual-test-environments-with-vagrant-and-puppet/">Automated virtual test-environments with Vagrant and Puppet</a></li>
<li><a href="https://favoorr.github.io/2017/01/06/import-vagrant-box-manually/">手工下载和导入 vagrant 镜像</a> 现在下载很快啊，尽管如此也是能学习一种新的备用方法。</li>
</ul>


<h2>实际操作命令</h2>

<h2>重装系统后再绑定</h2>

<p>重新安装后，vagrant和virtualbox在C盘用户目录的文件没有保存。再次启动发现vagrant是去重新启动一个新的虚拟机。</p>

<p>虚拟机嘛，总还是台机器，不会和对待docker那样操作。很多的文件、配置等等还是存储在虚拟机里面的。现在vagrant和virtualbox脱钩了。我们要做的就是把他们再绑定起来:</p>

<ul>
<li>首先启动直接双击box，启动虚拟机。会在用户目录.VirtualBox下面产生/修改VirtualBox.xml，打开文件找到当前虚拟机MachineEntry对应的uuid。</li>
<li>打开原vagrant的目录下 .vagrant\machines\default\virtualbox 的id文件。内容替换为virtualbox的最新的id。</li>
<li>上面的步骤已经把两者关联起来了，但是无密钥登录不行了。需要重新把github上的内容写入到虚拟机用户vagrant的authorzied_key里面。</li>
</ul>


<p>至此，就可以用 vagrant up 启动虚拟机了。还原绑定成功。</p>

<h2>其他</h2>

<ul>
<li><a href="https://github.com/guigarage/vagrant-binding">java invoke vagrant</a></li>
</ul>


<p>vagrant + virtualbox + nginx cache</p>

<ul>
<li><a href="https://stackoverflow.com/questions/9479117/vagrant-virtualbox-apache2-strange-cache-behaviour">https://stackoverflow.com/questions/9479117/vagrant-virtualbox-apache2-strange-cache-behaviour</a></li>
<li><a href="https://github.com/mitchellh/vagrant/issues/351#issuecomment-1339640">https://github.com/mitchellh/vagrant/issues/351#issuecomment-1339640</a></li>
</ul>


<p>vagrant + java deveploe env</p>

<ul>
<li><a href="https://github.com/rob-murray/vagrant-javadev-box/blob/master/Vagrantfile">https://github.com/rob-murray/vagrant-javadev-box/blob/master/Vagrantfile</a> 案例</li>
<li><a href="https://github.com/rob-murray/vagrant-javadev-box/blob/master/puppet/manifests/base.pp">https://github.com/rob-murray/vagrant-javadev-box/blob/master/puppet/manifests/base.pp</a></li>
<li><a href="https://github.com/spanneberg/vagrant-puppet-demo/blob/master/files/my.cnf">https://github.com/spanneberg/vagrant-puppet-demo/blob/master/files/my.cnf</a></li>
<li><a href="https://blog.codecentric.de/en/2012/02/automated-virtual-test-environments-with-vagrant-and-puppet/">https://blog.codecentric.de/en/2012/02/automated-virtual-test-environments-with-vagrant-and-puppet/</a></li>
</ul>


<p>git</p>

<ul>
<li><a href="https://stackoverflow.com/questions/34252265/how-to-start-mingw-console-gitbash-from-command-line-on-windows">https://stackoverflow.com/questions/34252265/how-to-start-mingw-console-gitbash-from-command-line-on-windows</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/12">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/10">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>
  <h1><a class='category' href='/blog/categories/recommend/'>Recommend</a></h1>
	<ul role="list">
		
			<li class="post">
				<a href="/blog/2023/11/18/reinstall-redmine-on-respberry2/">Reinstall Redmine on Respberry2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2023/03/25/reinstall-raspberry2/">重新折腾raspberry2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2023/03/25/mirror-request/">请求复制/镜像</a>
			</li>
		
			<li class="post">
				<a href="/blog/2022/07/24/xinchuang-install-postgres/">信创环境迁移浅析-以Postgres为例</a>
			</li>
		
			<li class="post">
				<a href="/blog/2021/12/08/recommand-blogs/">认真的博客</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/10/30/windows-run-ubuntu/">Windows Run Ubuntu</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/09/18/redmine-deploy-and-install-plugins/">Redmine部署以及插件安装</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/09/13/review-linux-101-hacks/">【linux 101 Hacks】读后感</a>
			</li>
		
			<li class="post">
				<a href="/blog/2013/09/19/let-shell-command-efficient/">让敲Shell命令高效起来</a>
			</li>
		
	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2023/11/18/reinstall-redmine-on-respberry2/">Reinstall Redmine on Respberry2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/04/09/dingtalk-with-openai/">钉钉群机器人对接ChatGPT</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/26/clash-on-raspberry4/">树莓派4安装Clash</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/25/reinstall-raspberry2/">重新折腾raspberry2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/25/mirror-request/">请求复制/镜像</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/18/wechat-on-openai/">微信对接OpenAI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/02/01/git-reset-hard/">记git Reset &#8211;hard</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/02/01/register-openai/">注册OpenAI</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/0/'>0</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/alluxio/'>alluxio</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/android/'>android</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/bigdata/'>bigdata</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blabla/'>blabla</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/clash/'>clash</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/debug/'>debug</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/deprecated/'>deprecated</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/devops/'>devops</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (16) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/es/'>es</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/flume/'>flume</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/git/'>git</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/good-series-1/'>good-series-1</a> (9) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (44) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hbase/'>hbase</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hole/'>hole</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jenkins/'>jenkins</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jeykll/'>jeykll</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k2/'>k2</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kafka/'>kafka</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kubeadm/'>kubeadm</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/logstash/'>logstash</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/map/'>map</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nfs/'>nfs</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/openai/'>openai</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/openeuler/'>openeuler</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/openvpn/'>openvpn</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/r4a/'>r4a</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/raspberry/'>raspberry</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/recommend/'>recommend</a> (18) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redmine/'>redmine</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/respberry2/'>respberry2</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/shell/'>shell</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/staf/'>staf</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tachyon/'>tachyon</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tez/'>tez</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tools/'>tools</a> (71) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/topics/'>topics</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/vagrant/'>vagrant</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/vnc/'>vnc</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/wsl/'>wsl</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/zookeeper/'>zookeeper</a> (1) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (236)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<!--
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
&#8211;>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2023 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1253103971'%3E%3C/span%3E%3Cscript src='https://s19.cnzz.com/z_stat.php%3Fid%3D1253103971%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winse.github.io" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>











</body>
</html>
