
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="折磨了一个多星期，最后还是调通了。折磨源于不自知，源于孤单，源于自负，后来通过扩展、查阅资料、请教同事顺利解决。简单部署可以查看README.md 。 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
yum install docker-engine-1. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winse.github.io/posts/11">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43198550-1', 'auto');
  ga('send', 'pageview');

</script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停, 熙熙攘攘, 忙忙碌碌, 不知何畏.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winse.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/04/14/k8s-hadoop-deploy/">K8s Hadoop Deploy</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-04-14T10:56:39+08:00" pubdate data-updated="true">Fri 2017-04-14 10:56</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>折磨了一个多星期，最后还是调通了。折磨源于不自知，源于孤单，源于自负，后来通过扩展、查阅资料、请教同事顺利解决。简单部署可以查看<a href="https://github.com/winse/docker-hadoop">README.md</a> 。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install docker-engine-1.12.6 docker-engine-selinux-1.12.6 -y
</span><span class='line'>
</span><span class='line'>cd kube-deploy
</span><span class='line'>vi hosts
</span><span class='line'>vi k8s.profile
</span><span class='line'># 把deploy同步到其他实体机，同时把k8s.profile映射到/etc/profile.d
</span><span class='line'>./rsync-deploy.sh
</span><span class='line'>
</span><span class='line'>cd docker-multinode/
</span><span class='line'>./master.sh or ./worker.sh
</span><span class='line'>
</span><span class='line'>docker save gcr.io/google_containers/etcd-amd64:3.0.4 | docker-bs load
</span><span class='line'>docker save quay.io/coreos/flannel:v0.6.1-amd64 | docker-bs load
</span><span class='line'>
</span><span class='line'>cd kube-deploy/hadoop/kubenetes/
</span><span class='line'>./prepare.sh
</span><span class='line'>kubectl create -f hadoop-master2.yaml
</span><span class='line'>kubectl create -f hadoop-slaver.yaml </span></code></pre></td></tr></table></div></figure>


<p>Tip：其实使用一套配置就可以启动多个集群，在 <code>kubectl create</code> 后面加上 <code>-n namespace</code> 即可。</p>

<p>比如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 kubenetes]# kubectl create namespace hd1
</span><span class='line'>[root@cu2 kubenetes]# kubectl create namespace hd2
</span><span class='line'>
</span><span class='line'>[root@cu2 kubenetes]# ./prepare.sh hd1
</span><span class='line'>[root@cu2 kubenetes]# kubectl create -f hadoop-master2.yaml -n hd1
</span><span class='line'>[root@cu2 kubenetes]# kubectl create -f hadoop-slaver.yaml -n hd1
</span><span class='line'>[root@cu2 kubenetes]# ./prepare.sh hd2
</span><span class='line'>[root@cu2 kubenetes]# kubectl create -f hadoop-master2.yaml -n hd2
</span><span class='line'>[root@cu2 kubenetes]# kubectl create -f hadoop-slaver.yaml -n hd2
</span><span class='line'>
</span><span class='line'>[root@cu2 kubenetes]# kubectl get pods --all-namespaces
</span><span class='line'>NAMESPACE     NAME                                    READY     STATUS    RESTARTS   AGE
</span><span class='line'>hd1           hadoop-master2                          1/1       Running   0          28s
</span><span class='line'>hd1           slaver-rc-fdcsw                         1/1       Running   0          18s
</span><span class='line'>hd1           slaver-rc-qv964                         1/1       Running   0          18s
</span><span class='line'>hd2           hadoop-master2                          1/1       Running   0          26s
</span><span class='line'>hd2           slaver-rc-0vdfk                         1/1       Running   0          17s
</span><span class='line'>hd2           slaver-rc-r7g84                         1/1       Running   0          17s
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>现在想来其实就是 <strong> dockerd &ndash;ip-masq=false </strong>的问题（所有涉及的dockerd都需要加）。 还有就是一台机器单机下的容器互相访问，源IP都错也是安装了openvpn所导致，对所有过eth0的都加了MASQUERADE。</p>

<p>根源就在于请求的源地址被替换，也就是iptables的转发进行了SNAT。关于iptables转发这篇文章讲的非常清晰；<a href="http://fancyxinyu.blog.163.com/blog/static/18232136620136185434661/">IPtables之四：NAT原理和配置  </a> 。</p>

<h2>所遇到的问题</h2>

<p>没加ip-masq之前，namenode收到datanode的请求后，源地址是flannel.0的ip: 10.1.98.0。</p>

<p>namenode对应的日志为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2017-04-09 07:22:06,920 INFO org.apache.hadoop.hdfs.StateChange: BLOCK* registerDatanode: from DatanodeRegistration(10.1.98.0, datanodeUuid=5086c549-f3bb-4ef6-8f56-05b1f7adb7d3, infoPort=50075, ipcPort=50020, storageInfo=lv=-56;cid=CID-522174fa-6e7b-4c3f-ae99-23c3018e35d7;nsid=1613705851;c=0) storage 5086c549-f3bb-4ef6-8f56-05b1f7adb7d3
</span><span class='line'>2017-04-09 07:22:06,920 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/10.1.98.0:50010
</span><span class='line'>2017-04-09 07:22:06,921 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/10.1.98.0:50010</span></code></pre></td></tr></table></div></figure>


<p>一开始以为是flannel的问题，换成yum安装，然后同时flannel把backend切换成vxlan后，还是一样的问题。</p>

<p>最后请教搞网络的同事，应该是请求的源地址被替换了，也就定位到iptables。然后通过查看文档，其实前面也有看到过对应的文章，但是看不明白不知道缘由。</p>

<ul>
<li><a href="https://groups.google.com/d/msg/kubernetes-users/P4uh7y383oo/bPzIRaxhs5gJ">Networking Problem in creating HDFS cluster. - Eugene Yakubovich </a></li>
<li><a href="https://groups.google.com/d/msg/kubernetes-users/P4uh7y383oo/a1GIV4hcAgAJ">Networking Problem in creating HDFS cluster. - Huihui He </a></li>
<li><a href="https://developer.ibm.com/recipes/tutorials/networking-your-docker-containers-using-docker0-bridge/">Networking your docker containers using docker0 bridge</a></li>
</ul>


<p>iptables的部分相关信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# iptables -S -t nat
</span><span class='line'>...
</span><span class='line'>-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
</span><span class='line'>-A PREROUTING -j PREROUTING_direct
</span><span class='line'>-A PREROUTING -j PREROUTING_ZONES_SOURCE
</span><span class='line'>-A PREROUTING -j PREROUTING_ZONES
</span><span class='line'>-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
</span><span class='line'>-A OUTPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
</span><span class='line'>-A OUTPUT -j OUTPUT_direct
</span><span class='line'>-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
</span><span class='line'>-A POSTROUTING -s 10.1.34.0/24 ! -o docker0 -j MASQUERADE
</span><span class='line'>-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING
</span><span class='line'>-A POSTROUTING -j POSTROUTING_direct
</span><span class='line'>-A POSTROUTING -j POSTROUTING_ZONES_SOURCE
</span><span class='line'>-A POSTROUTING -j POSTROUTING_ZONES
</span><span class='line'>-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000
</span><span class='line'>-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000
</span><span class='line'>-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -m mark --mark 0x4000/0x4000 -j MASQUERADE
</span><span class='line'>-A KUBE-SEP-75CPIAPDB4MAVFWI -s 10.1.40.3/32 -m comment --comment "kube-system/kube-dns:dns-tcp" -j KUBE-MARK-MASQ
</span><span class='line'>-A KUBE-SEP-75CPIAPDB4MAVFWI -p tcp -m comment --comment "kube-system/kube-dns:dns-tcp" -m tcp -j DNAT --to-destination 10.1.40.3:53
</span><span class='line'>-A KUBE-SEP-IWNPEB4T46P6VG5J -s 192.168.0.148/32 -m comment --comment "default/kubernetes:https" -j KUBE-MARK-MASQ
</span><span class='line'>-A KUBE-SEP-IWNPEB4T46P6VG5J -p tcp -m comment --comment "default/kubernetes:https" -m recent --set --name KUBE-SEP-IWNPEB4T46P6VG5J --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 192.168.0.148:6443
</span><span class='line'>-A KUBE-SEP-UYUINV25NDNSKNUW -s 10.1.40.3/32 -m comment --comment "kube-system/kube-dns:dns" -j KUBE-MARK-MASQ
</span><span class='line'>-A KUBE-SEP-UYUINV25NDNSKNUW -p udp -m comment --comment "kube-system/kube-dns:dns" -m udp -j DNAT --to-destination 10.1.40.3:53
</span><span class='line'>-A KUBE-SEP-XDHL2OHX2ICPQHKI -s 10.1.40.2/32 -m comment --comment "kube-system/kubernetes-dashboard:" -j KUBE-MARK-MASQ
</span><span class='line'>-A KUBE-SEP-XDHL2OHX2ICPQHKI -p tcp -m comment --comment "kube-system/kubernetes-dashboard:" -m tcp -j DNAT --to-destination 10.1.40.2:9090
</span><span class='line'>-A KUBE-SERVICES -d 10.0.0.1/32 -p tcp -m comment --comment "default/kubernetes:https cluster IP" -m tcp --dport 443 -j KUBE-SVC-NPX46M4PTMTKRN6Y
</span><span class='line'>-A KUBE-SERVICES -d 10.0.0.95/32 -p tcp -m comment --comment "kube-system/kubernetes-dashboard: cluster IP" -m tcp --dport 80 -j KUBE-SVC-XGLOHA7QRQ3V22RZ
</span><span class='line'>-A KUBE-SERVICES -d 10.0.0.10/32 -p udp -m comment --comment "kube-system/kube-dns:dns cluster IP" -m udp --dport 53 -j KUBE-SVC-TCOU7JCQXEZGVUNU
</span><span class='line'>-A KUBE-SERVICES -d 10.0.0.10/32 -p tcp -m comment --comment "kube-system/kube-dns:dns-tcp cluster IP" -m tcp --dport 53 -j KUBE-SVC-ERIFXISQEP7F7OF4
</span><span class='line'>-A KUBE-SERVICES -m comment --comment "kubernetes service nodeports; NOTE: this must be the last rule in this chain" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS
</span><span class='line'>-A KUBE-SVC-ERIFXISQEP7F7OF4 -m comment --comment "kube-system/kube-dns:dns-tcp" -j KUBE-SEP-75CPIAPDB4MAVFWI
</span><span class='line'>-A KUBE-SVC-NPX46M4PTMTKRN6Y -m comment --comment "default/kubernetes:https" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-IWNPEB4T46P6VG5J --mask 255.255.255.255 --rsource -j KUBE-SEP-IWNPEB4T46P6VG5J
</span><span class='line'>-A KUBE-SVC-NPX46M4PTMTKRN6Y -m comment --comment "default/kubernetes:https" -j KUBE-SEP-IWNPEB4T46P6VG5J
</span><span class='line'>-A KUBE-SVC-TCOU7JCQXEZGVUNU -m comment --comment "kube-system/kube-dns:dns" -j KUBE-SEP-UYUINV25NDNSKNUW
</span><span class='line'>-A KUBE-SVC-XGLOHA7QRQ3V22RZ -m comment --comment "kube-system/kubernetes-dashboard:" -j KUBE-SEP-XDHL2OHX2ICPQHKI</span></code></pre></td></tr></table></div></figure>


<p>在dockerd服务脚本加上 <code>--ip-masq=false</code> 后，<code>-A POSTROUTING -s 10.1.34.0/24 ! -o docker0 -j MASQUERADE</code> 这一句就没有了，也就是不会进行源地址重写了，这样请求发送到namenode后还是datanode容器的IP。问题解决，原因简单的让人欲哭无泪啊。</p>

<p>写yaml遇到的一些其他问题：</p>

<ul>
<li><a href="http://andykdocs.de/development/Docker/Fixing+the+Docker+TERM+variable+issue">Fixing the Docker TERM variable issue</a></li>
<li><a href="http://stackoverflow.com/questions/27195466/hdfs-datanode-denied-communication-with-namenode-because-hostname-cannot-be-reso">hdfs Datanode denied communication with namenode because hostname cannot be resolved</a></li>
</ul>


<p>当然还有很多其他的问题，这篇就写这么多，优化工作后面的弄好了再写。</p>

<h2>中间过程步骤记录</h2>

<p>主要就是记录心路历程，如果以后遇到同样的问题能让自己快速回想起来。如果仅仅为了部署，可以跳过该部分，直接后最后的常用命令。</p>

<p>记录下中间 <strong>通过yum安装etcd和flanneld</strong> 的过程。物理机安装flanneld会把配置docker环境变量（/run/flannel/subnet.env）加入启动脚本。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>安装docker-v1.12
</span><span class='line'>https://docs.docker.com/v1.12/
</span><span class='line'>https://docs.docker.com/v1.12/engine/installation/linux/centos/
</span><span class='line'>
</span><span class='line'># 删掉原来的
</span><span class='line'>yum-config-manager --disable docker-ce*
</span><span class='line'>yum remove -y docker-ce*
</span><span class='line'>
</span><span class='line'>sudo tee /etc/yum.repos.d/docker.repo &lt;&lt;-'EOF'
</span><span class='line'>[dockerrepo]
</span><span class='line'>name=Docker Repository
</span><span class='line'>baseurl=https://yum.dockerproject.org/repo/main/centos/7/
</span><span class='line'>enabled=1
</span><span class='line'>gpgcheck=1
</span><span class='line'>gpgkey=https://yum.dockerproject.org/gpg
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>https://yum.dockerproject.org/repo/main/centos/7/Packages/
</span><span class='line'>[root@cu3 ~]# yum --showduplicates list docker-engine | expand
</span><span class='line'>docker-engine.x86_64             1.12.6-1.el7.centos                  dockerrepo
</span><span class='line'>
</span><span class='line'>[root@cu3 yum.repos.d]# yum install docker-engine-1.12.6 docker-engine-selinux-1.12.6
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>https://kubernetes.io/docs/getting-started-guides/centos/centos_manual_config/
</span><span class='line'>
</span><span class='line'>cat &gt; /etc/yum.repos.d/virt7-docker-common-release.repo &lt;&lt;EOF
</span><span class='line'>[virt7-docker-common-release]
</span><span class='line'>name=virt7-docker-common-release
</span><span class='line'>baseurl=http://cbs.centos.org/repos/virt7-docker-common-release/x86_64/os/
</span><span class='line'>gpgcheck=0
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>yum -y install --enablerepo=virt7-docker-common-release etcd flannel
</span><span class='line'>yum -y install --enablerepo=virt7-docker-common-release flannel
</span><span class='line'>
</span><span class='line'>- ETCD配置
</span><span class='line'>[root@cu3 docker-multinode]# 
</span><span class='line'>etcdctl mkdir /kube-centos/network
</span><span class='line'>etcdctl set /kube-centos/network/config "{ \"Network\": \"10.1.0.0/16\", \"SubnetLen\": 24, \"Backend\": { \"Type\": \"vxlan\" } }"
</span><span class='line'>
</span><span class='line'>- FlANNEL
</span><span class='line'>[root@cu3 ~]# cat /etc/sysconfig/flanneld
</span><span class='line'># Flanneld configuration options  
</span><span class='line'>
</span><span class='line'># etcd url location.  Point this to the server where etcd runs
</span><span class='line'>FLANNEL_ETCD_ENDPOINTS="http://cu3:2379"
</span><span class='line'>
</span><span class='line'># etcd config key.  This is the configuration key that flannel queries
</span><span class='line'># For address range assignment
</span><span class='line'>FLANNEL_ETCD_PREFIX="/kube-centos/network"
</span><span class='line'>
</span><span class='line'># Any additional options that you want to pass
</span><span class='line'>#FLANNEL_OPTIONS=""
</span><span class='line'>
</span><span class='line'>[root@cu2 yum.repos.d]# systemctl daemon-reload
</span><span class='line'>
</span><span class='line'>[root@cu2 yum.repos.d]# cat /run/flannel/subnet.env
</span><span class='line'>
</span><span class='line'>[root@cu2 ~]# systemctl cat docker
</span><span class='line'>...
</span><span class='line'># /usr/lib/systemd/system/docker.service.d/flannel.conf
</span><span class='line'>[Service]
</span><span class='line'>EnvironmentFile=-/run/flannel/docker </span></code></pre></td></tr></table></div></figure>


<p>测试过程中有yaml配置中启动sshd，然后启动容器后，通过手动启动namenode、datanode的方式来测试：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd hadoop-2.6.5
</span><span class='line'>gosu hadoop mkdir /data/bigdata
</span><span class='line'>gosu hadoop sbin/hadoop-daemon.sh start datanode 
</span><span class='line'>
</span><span class='line'>cd hadoop-2.6.5/
</span><span class='line'>gosu hadoop  bin/hadoop namenode -format 
</span><span class='line'>gosu hadoop sbin/hadoop-daemon.sh start namenode</span></code></pre></td></tr></table></div></figure>


<p>后来发现问题出在iptables后，又回到原来的docker-bootstrap启动，需要删除flannel.1的网络：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum安装flanneld后停止 https://kubernetes.io/docs/getting-started-guides/scratch/
</span><span class='line'>ip link set flannel.1 down
</span><span class='line'>ip link delete flannel.1
</span><span class='line'>route -n
</span><span class='line'>
</span><span class='line'>rm /usr/lib/systemd/system/docker.service.d/flannel.conf </span></code></pre></td></tr></table></div></figure>


<p>开了防火墙的话，把容器的端加入到信任列表：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>systemctl enable firewalld && systemctl start firewalld
</span><span class='line'>
</span><span class='line'>firewall-cmd --zone=trusted --add-source=10.0.0.0/8 --permanent 
</span><span class='line'>firewall-cmd --zone=trusted --add-source=192.168.0.0/16 --permanent 
</span><span class='line'>firewall-cmd --reload</span></code></pre></td></tr></table></div></figure>


<h2>一些有趣的命令</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>查看用了哪些镜像
</span><span class='line'>
</span><span class='line'>[root@cu2 /]# kubectl get pods --all-namespaces -o jsonpath="{..image}" |\
</span><span class='line'> tr -s '[[:space:]]' '\n' |\
</span><span class='line'> sort |\
</span><span class='line'> uniq -c
</span><span class='line'>      2 gcr.io/google_containers/dnsmasq-metrics-amd64:1.0
</span><span class='line'>      2 gcr.io/google_containers/exechealthz-amd64:1.2
</span><span class='line'>     12 gcr.io/google_containers/hyperkube-amd64:v1.5.5
</span><span class='line'>      2 gcr.io/google_containers/kube-addon-manager-amd64:v6.1
</span><span class='line'>      2 gcr.io/google_containers/kubedns-amd64:1.9
</span><span class='line'>      2 gcr.io/google_containers/kube-dnsmasq-amd64:1.4
</span><span class='line'>      2 gcr.io/google_containers/kubernetes-dashboard-amd64:v1.5.0
</span><span class='line'>    
</span><span class='line'>      
</span><span class='line'>修改默认kubectl的配置
</span><span class='line'>
</span><span class='line'>[root@cu2 ~]# vi $KUBECONFIG 
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: Config
</span><span class='line'>preferences: {}
</span><span class='line'>current-context: default
</span><span class='line'>clusters:
</span><span class='line'>- cluster:
</span><span class='line'>    server: http://localhost:8080
</span><span class='line'>  name: default
</span><span class='line'>contexts:
</span><span class='line'>- context:
</span><span class='line'>    cluster: default
</span><span class='line'>    user: ""
</span><span class='line'>    namespace: kube-system
</span><span class='line'>  name: default
</span><span class='line'>users: {}
</span><span class='line'>
</span><span class='line'>如果kubectl没有下载，可以从镜像启动的容器里面获取
</span><span class='line'>
</span><span class='line'>[root@cu2 docker-multinode]# docker exec -ti 0c0360bcc2c3 bash
</span><span class='line'>root@cu2:/# cp kubectl /var/run/
</span><span class='line'>
</span><span class='line'>[root@cu2 run]# mv kubectl /data/kubernetes/kube-deploy/docker-multinode/
</span><span class='line'>
</span><span class='line'>获取容器IP
</span><span class='line'>
</span><span class='line'>https://kubernetes.io/docs/user-guide/jsonpath/
</span><span class='line'>[root@cu2 ~]# kubectl get pods -o wide -l run=redis -o jsonpath={..podIP}
</span><span class='line'>10.1.75.2 10.1.75.3 10.1.58.3 10.1.58.2 10.1.33.3
</span><span class='line'>
</span><span class='line'>网络共用: --net
</span><span class='line'>
</span><span class='line'>docker run -ti --entrypoint=sh --net=container:8e9f21956469f4ef7e5b9d91798788ab83f380795d2825cdacae0ed28f5ba03b gcr.io/google_containers/skydns-amd64:1.0
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>格式化输出
</span><span class='line'>
</span><span class='line'>kubectl get pods --all-namespaces -o jsonpath="{.items[*].spec.containers[*].image}"  
</span><span class='line'>
</span><span class='line'>[root@cu2 ~]# export POD_COL="custom-columns=NAME:.metadata.name,RESTARTS:.status.containerStatuses[*].restartCount,CONTAINERS:.spec.containers[*].name,IP:.status.podIP,HOST:.spec.nodeName"
</span><span class='line'>[root@cu2 ~]# kubectl get pods -o $POD_COL 
</span><span class='line'>
</span><span class='line'>kubectl get po -l k8s-app=kube-dns -o=custom-columns=NAME:.metadata.name,CONTAINERS:.spec.containers[*].name
</span><span class='line'>
</span><span class='line'>[root@cu2 kubernetes]# kubectl get po --all-namespaces -o=custom-columns=NAME:.metadata.name,CONTAINERS:.spec.containers[*].name
</span><span class='line'>
</span><span class='line'>kubectl get po --all-namespaces {range .items[*]}{.metadata.name}{“\t”}{end}
</span><span class='line'>
</span><span class='line'>备份
</span><span class='line'>
</span><span class='line'>echo "$(docker ps  | grep -v IMAGE | awk '{print $2}' )
</span><span class='line'>$(docker-bs ps | grep -v IMAGE | awk '{print $2}' )" | sort -u | while read image ; do docker save $image&gt;$(echo $image | tr '[/:]' _).tar ; done
</span><span class='line'>
</span><span class='line'>加Label
</span><span class='line'>
</span><span class='line'>cat /etc/hosts | grep -E "\scu[0-9]\s" | awk '{print "kubectl label nodes "$1" hostname="$2}' | while read line ; do sh -c "$line" ; done
</span><span class='line'>
</span><span class='line'>扩容
</span><span class='line'>
</span><span class='line'>[root@cu2 kubernetes]# kubectl run redis --image=redis:3.2.8 
</span><span class='line'>[root@cu2 kubernetes]# kubectl scale --replicas=9 deployment/redis
</span><span class='line'>
</span><span class='line'> echo " $( kubectl describe pods hadoop-master2 | grep -E "Node|Container ID" | awk -F/ '{print $NF}' | tr '\n' ' ' | awk '{print "ssh "$1" \rdocker exec -ti "$2" bash"}' ) "
</span><span class='line'> </span></code></pre></td></tr></table></div></figure>


<p>测试DNS是否成功：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 kube-deploy]# vi busybox.yaml
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: Pod
</span><span class='line'>metadata:
</span><span class='line'>  name: busybox
</span><span class='line'>  namespace: default
</span><span class='line'>spec:
</span><span class='line'>  containers:
</span><span class='line'>  - image: busybox
</span><span class='line'>    command:
</span><span class='line'>      - sleep
</span><span class='line'>      - "3600"
</span><span class='line'>    imagePullPolicy: IfNotPresent
</span><span class='line'>    name: busybox
</span><span class='line'>  restartPolicy: Always
</span><span class='line'>
</span><span class='line'>[root@cu3 kube-deploy]# kubectl create -f busybox.yaml 
</span><span class='line'>pod "busybox" created
</span><span class='line'>[root@cu3 kube-deploy]# kubectl get pods 
</span><span class='line'>NAME      READY     STATUS              RESTARTS   AGE
</span><span class='line'>busybox   0/1       ContainerCreating   0          11s
</span><span class='line'>[root@cu3 kube-deploy]# kubectl get pods 
</span><span class='line'>NAME      READY     STATUS    RESTARTS   AGE
</span><span class='line'>busybox   1/1       Running   0          1m
</span><span class='line'>[root@cu3 kube-deploy]# kubectl exec -ti busybox -- nslookup kubernetes.default
</span><span class='line'>Server:    10.0.0.10
</span><span class='line'>Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local
</span><span class='line'>
</span><span class='line'>Name:      kubernetes.default
</span><span class='line'>Address 1: 10.0.0.1 kubernetes.default.svc.cluster.local
</span><span class='line'>
</span><span class='line'>用容器的MYSQL的做客户端
</span><span class='line'>
</span><span class='line'>kubectl run -it --rm --image=mysql:5.6 mysql-client -- mysql -h mysql -ppassword
</span></code></pre></td></tr></table></div></figure>


<p>小结一点：日志的重要性！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 kubenetes]# docker ps -a | grep kubelet
</span><span class='line'>[root@cu2 kubenetes]# docker logs --tail=200 7432da457558
</span><span class='line'>
</span><span class='line'>E0417 11:39:40.194844   22528 configmap.go:174] Couldn't get configMap hadoop/dta-hadoop-config: configmaps "dta-hadoop-config" not found
</span><span class='line'>E0417 11:39:40.194910   22528 configmap.go:174] Couldn't get configMap hadoop/dta-bin-config: configmaps "dta-bin-config" not found
</span></code></pre></td></tr></table></div></figure>


<p>监控heapster的一些错误，还没调好</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# kubectl exec -ti heapster-564189836-shn2q -n kube-system -- sh
</span><span class='line'>/ # 
</span><span class='line'>/ # 
</span><span class='line'>没pod的数据
</span><span class='line'>/ # /heapster --source=https://kubernetes.default --sink=log --heapster-port=8083 -v 10
</span><span class='line'>
</span><span class='line'>E0329 10:11:53.823641       1 reflector.go:203] k8s.io/heapster/metrics/processors/node_autoscaling_enricher.go:100: Failed to list *api.Node: Get https://kubernetes.default/api/v1/nodes?resourceVersion=0: dial tcp 10.0.0.1:443: i/o timeout
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>$heapster/metrics
</span><span class='line'>$heapster/api/v1/model/debug/allkeys
</span></code></pre></td></tr></table></div></figure>


<p>其他一些配置</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>other_args=" --registry-mirror=https://docker.mirrors.ustc.edu.cn "
</span><span class='line'>
</span><span class='line'>--insecure-registry gcr.io 
</span><span class='line'>
</span><span class='line'>iptables -S -t nat
</span></code></pre></td></tr></table></div></figure>


<h2>其他一些资源</h2>

<ul>
<li><a href="https://kubernetes.io/docs/concepts/cluster-administration/resource-usage-monitoring/">https://kubernetes.io/docs/concepts/cluster-administration/resource-usage-monitoring/</a></li>
<li><p><a href="https://github.com/kubernetes/heapster/tree/v1.3.0/deploy/kube-config/influxdb">https://github.com/kubernetes/heapster/tree/v1.3.0/deploy/kube-config/influxdb</a></p></li>
<li><p><a href="https://github.com/kubernetes/heapster/blob/master/docs/debugging.md">https://github.com/kubernetes/heapster/blob/master/docs/debugging.md</a></p></li>
<li><p><a href="https://docs.docker.com/v1.12/engine/installation/linux/centos/">https://docs.docker.com/v1.12/engine/installation/linux/centos/</a></p></li>
<li><p><a href="https://github.com/CodisLabs/codis/blob/release3.2/Dockerfile">https://github.com/CodisLabs/codis/blob/release3.2/Dockerfile</a></p></li>
<li><a href="https://github.com/sporkmonger/redis-k8s/blob/master/redis.yaml">https://github.com/sporkmonger/redis-k8s/blob/master/redis.yaml</a></li>
<li><a href="https://github.com/sobotklp/kubernetes-redis-cluster/blob/master/redis-cluster.yml">https://github.com/sobotklp/kubernetes-redis-cluster/blob/master/redis-cluster.yml</a></li>
</ul>


<p>statefulset</p>

<ul>
<li><a href="https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/">https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/</a></li>
<li><a href="https://kubernetes.io/docs/tutorials/stateful-application/run-stateful-application/">https://kubernetes.io/docs/tutorials/stateful-application/run-stateful-application/</a></li>
<li><a href="https://kubernetes.io/docs/tutorials/stateful-application/run-replicated-stateful-application/">https://kubernetes.io/docs/tutorials/stateful-application/run-replicated-stateful-application/</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/03/30/k8s-harbor-config/">K8s Harbor Config</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-03-30T14:21:50+08:00" pubdate data-updated="true">Thu 2017-03-30 14:21</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>为了对比，还是想写写在centos7上面<a href="https://github.com/vmware/harbor/tree/master/make/kubernetes">安装Harbor</a>：太简单了，想想当初在6上面安装那酸爽($.$)。。。</p>

<h2>环境说明</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 kube-deploy]# yum install -y redhat-lsb
</span><span class='line'>[root@cu2 kube-deploy]# lsb_release -a
</span><span class='line'>LSB Version:    :core-4.1-amd64:core-4.1-noarch:cxx-4.1-amd64:cxx-4.1-noarch:desktop-4.1-amd64:desktop-4.1-noarch:languages-4.1-amd64:languages-4.1-noarch:printing-4.1-amd64:printing-4.1-noarch
</span><span class='line'>Distributor ID: CentOS
</span><span class='line'>Description:    CentOS Linux release 7.3.1611 (Core) 
</span><span class='line'>Release:        7.3.1611
</span><span class='line'>Codename:       Core
</span><span class='line'>
</span><span class='line'>[root@cu2 kube-deploy]# docker version
</span><span class='line'>Client:
</span><span class='line'> Version:      1.12.6
</span><span class='line'> API version:  1.24
</span><span class='line'> Go version:   go1.6.4
</span><span class='line'> Git commit:   78d1802
</span><span class='line'> Built:        Tue Jan 10 20:20:01 2017
</span><span class='line'> OS/Arch:      linux/amd64
</span><span class='line'>
</span><span class='line'>Server:
</span><span class='line'> Version:      1.12.6
</span><span class='line'> API version:  1.24
</span><span class='line'> Go version:   go1.6.4
</span><span class='line'> Git commit:   78d1802
</span><span class='line'> Built:        Tue Jan 10 20:20:01 2017
</span><span class='line'> OS/Arch:      linux/amd64
</span></code></pre></td></tr></table></div></figure>


<h2>使用docker-multinode搭建的环境</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 kube-deploy]# kubectl version
</span><span class='line'>Client Version: version.Info{Major:"1", Minor:"5", GitVersion:"v1.5.6", GitCommit:"114f8911f9597be669a747ab72787e0bd74c9359", GitTreeState:"clean", BuildDate:"2017-03-28T13:36:31Z", GoVersion:"go1.7.4", Compiler:"gc", Platform:"linux/amd64"}
</span><span class='line'>Server Version: version.Info{Major:"1", Minor:"5", GitVersion:"v1.5.6", GitCommit:"114f8911f9597be669a747ab72787e0bd74c9359", GitTreeState:"clean", BuildDate:"2017-03-28T13:36:31Z", GoVersion:"go1.7.4", Compiler:"gc", Platform:"linux/amd64"}</span></code></pre></td></tr></table></div></figure>


<h2>安装配置</h2>

<ul>
<li>证书准备</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# cd /data/kubernetes/
</span><span class='line'>[root@cu2 kubernetes]# cd kube-deploy/
</span><span class='line'>[root@cu2 kube-deploy]# cat easy-rsa.sh 
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'># cd /data/kubernetes
</span><span class='line'>cd ..
</span><span class='line'>
</span><span class='line'>git clone https://github.com/OpenVPN/easy-rsa.git
</span><span class='line'>cd easy-rsa/easyrsa3
</span><span class='line'>
</span><span class='line'>echo "# ======  CA  ======= #"
</span><span class='line'>./easyrsa init-pki
</span><span class='line'>./easyrsa build-ca #记住输入的密码，下面颁发证书还会用到
</span><span class='line'>
</span><span class='line'>echo "# ======  CERT  ======= #"
</span><span class='line'>./easyrsa gen-req cu nopass
</span><span class='line'>./easyrsa sign-req server cu #commonName填将要用到的域名咯</span></code></pre></td></tr></table></div></figure>


<ul>
<li>下载离线镜像</li>
</ul>


<p><a href="http://pan.baidu.com/s/1c1Rtnag">harbor-offline-installer-0.5.0.tgz</a>，加载harbor.0.5.0.tgz里面的镜像</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 harbor-make]# docker images 
</span><span class='line'>REPOSITORY                                            TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>vmware/harbor-jobservice                              0.5.0               1700fbe602a0        3 months ago        148.4 MB
</span><span class='line'>vmware/harbor-ui                                      0.5.0               6db5718f2012        3 months ago        209.6 MB
</span><span class='line'>vmware/harbor-db                                      0.5.0               c401344852c6        3 months ago        326.8 MB
</span><span class='line'>nginx                                                 1.11.5              cc16e49f1304        4 months ago        181.4 MB
</span><span class='line'>registry                                              2.5.0               44a8766d1758        8 months ago        33.28 MB
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>修改配置和yaml配置的镜像名称</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 harbor-make]# vi harbor.cfg
</span><span class='line'>
</span><span class='line'>hostname = cu.eshore.cn
</span><span class='line'>ui_url_protocol = https
</span><span class='line'>ssl_cert = /data/kubernetes/easy-rsa/easyrsa3/pki/issued/cu.crt
</span><span class='line'>ssl_cert_key = /data/kubernetes/easy-rsa/easyrsa3/pki/private/cu.key 
</span><span class='line'>
</span><span class='line'>[root@cu2 harbor-make]# find kubernetes/ -name "*.rc.yaml" 
</span><span class='line'>kubernetes/nginx/nginx.rc.yaml
</span><span class='line'>kubernetes/mysql/mysql.rc.yaml
</span><span class='line'>kubernetes/registry/registry.rc.yaml
</span><span class='line'>kubernetes/ui/ui.rc.yaml
</span><span class='line'>kubernetes/jobservice/jobservice.rc.yaml</span></code></pre></td></tr></table></div></figure>


<ul>
<li>启动</li>
</ul>


<p>k8s启动的配置用github上最新的，不要用release下面的！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 harbor-make]# cd kubernetes/
</span><span class='line'>[root@cu2 kubernetes]# python prepare 
</span><span class='line'>
</span><span class='line'>[root@cu2 kubernetes]# cat kube.sh 
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>OP=${1:-"apply"}
</span><span class='line'>
</span><span class='line'>kubectl $OP -f pv/
</span><span class='line'>
</span><span class='line'>kubectl $OP -f jobservice/jobservice.cm.yaml
</span><span class='line'>kubectl $OP -f mysql/mysql.cm.yaml
</span><span class='line'>kubectl $OP -f nginx/nginx.cm.yaml
</span><span class='line'>kubectl $OP -f registry/registry.cm.yaml
</span><span class='line'>kubectl $OP -f ui/ui.cm.yaml
</span><span class='line'>
</span><span class='line'>kubectl $OP -f jobservice/jobservice.svc.yaml
</span><span class='line'>kubectl $OP -f mysql/mysql.svc.yaml
</span><span class='line'>kubectl $OP -f nginx/nginx.svc.yaml
</span><span class='line'>kubectl $OP -f registry/registry.svc.yaml
</span><span class='line'>kubectl $OP -f ui/ui.svc.yaml
</span><span class='line'>
</span><span class='line'>kubectl $OP -f registry/registry.rc.yaml 
</span><span class='line'>kubectl $OP -f mysql/mysql.rc.yaml 
</span><span class='line'>kubectl $OP -f jobservice/jobservice.rc.yaml 
</span><span class='line'>kubectl $OP -f ui/ui.rc.yaml 
</span><span class='line'>kubectl $OP -f nginx/nginx.rc.yaml
</span></code></pre></td></tr></table></div></figure>


<p>客户端CA</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 kube-deploy]# cat rsync-deploy.sh 
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>SERVICES="$@"
</span><span class='line'>HOSTS=$(echo cu{1..5} )
</span><span class='line'>
</span><span class='line'>#########
</span><span class='line'># Harbor
</span><span class='line'>if echo "$SERVICES" | grep harbor &gt;/dev/null ; then 
</span><span class='line'>
</span><span class='line'>  sed -i '/cu.eshore.cn/d' /etc/hosts
</span><span class='line'>
</span><span class='line'>  cat &gt;&gt;/etc/hosts &lt;&lt;EOF
</span><span class='line'>$( kubectl get service nginx -n default -o jsonpath="{..clusterIP}" ) cu.eshore.cn
</span><span class='line'>EOF
</span><span class='line'>  echo "Updated Local Hosts"
</span><span class='line'>
</span><span class='line'>  for h in $HOSTS ; do
</span><span class='line'>    if [[ $h != "$(hostname)" ]] ; then
</span><span class='line'>      rsync -az /etc/hosts $h:/etc/
</span><span class='line'>    fi
</span><span class='line'>
</span><span class='line'>    ssh $h "mkdir -p /etc/docker/certs.d/cu.eshore.cn/"
</span><span class='line'>    rsync -az /data/kubernetes/easy-rsa/easyrsa3/pki/ca.crt $h:/etc/docker/certs.d/cu.eshore.cn/
</span><span class='line'>
</span><span class='line'>    ssh $h "docker login -u admin -p Harbor12345 cu.eshore.cn"
</span><span class='line'>  done
</span><span class='line'>  echo "Harbor Rsync Succeeded"
</span><span class='line'>
</span><span class='line'>fi 
</span></code></pre></td></tr></table></div></figure>


<p>搞定，上传下载一个镜像试试：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu1 dev]# docker build -t cu.eshore.cn/library/codis:3.2 codis/
</span><span class='line'>[root@cu1 dev]# docker push cu.eshore.cn/library/codis:3.2
</span><span class='line'>
</span><span class='line'>[root@cu2 ~]# docker pull cu.eshore.cn/library/codis:3.2
</span><span class='line'>3.2: Pulling from library/codis
</span><span class='line'>386a066cd84a: Already exists 
</span><span class='line'>a3ed95caeb02: Pull complete 
</span><span class='line'>b1d31257c103: Pull complete 
</span><span class='line'>0e627f083b66: Pull complete 
</span><span class='line'>83912002f3f9: Pull complete 
</span><span class='line'>fc5e0ef7d361: Pull complete 
</span><span class='line'>47fe51a74a06: Pull complete 
</span><span class='line'>08dacccac43c: Pull complete 
</span><span class='line'>ec5a5e8fd71b: Pull complete 
</span><span class='line'>83f9da97d228: Pull complete 
</span><span class='line'>d4735c06cafa: Pull complete 
</span><span class='line'>3a4dc262a84d: Pull complete 
</span><span class='line'>bcf78ab0a1a9: Pull complete 
</span><span class='line'>7ac5a6fd0bf8: Pull complete 
</span><span class='line'>Digest: sha256:1c9280840222d736b7419b7e896b6286709d08e53890ae9e3d18062d61a9ad58
</span><span class='line'>Status: Downloaded newer image for cu.eshore.cn/library/codis:3.2
</span><span class='line'>
</span><span class='line'>[root@cu3 ~]# docker pull cu.eshore.cn/library/codis:3.2
</span><span class='line'>...
</span><span class='line'>layers from manifest don't match image configuration 暂时不清楚啥问题，临时解决。。。囧
</span><span class='line'>[root@cu2 data]# docker save cu.eshore.cn/library/codis:3.2 | ssh cu3 docker load</span></code></pre></td></tr></table></div></figure>


<h2>小结</h2>

<p>高版本的docker和k8s对环境变量和config volumes都支持，配置相对就很简单。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/03/23/codis-usage2/">Codis使用进阶</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-03-23T17:48:55+08:00" pubdate data-updated="true">Thu 2017-03-23 17:48</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>去年年中的时刻有安装过codis。当时因为任务紧就使用jedis的ShardedJedisPool功能粗略的解决，由于是自己手动路由和管理，维护起来太难，特别是当初设置的实例数不够用时，相当麻烦。</p>

<p>年初项目各种测试，于是有些闲暇的时间，重新弄一弄redis cluster。算是搭建一个环境来测试：</p>

<p>版本：</p>

<ul>
<li>codis-3.2</li>
<li>centos6</li>
</ul>


<h2>测试环境编译安装</h2>

<p>现在的版本已经有了全部的依赖，直接编译即可。（centos6和官网提供的编译版本不兼容）</p>

<ul>
<li><a href="https://github.com/CodisLabs/codis/blob/release3.2/doc/tutorial_zh.md#0-%E4%B8%8B%E8%BD%BD%E4%B8%8E%E7%BC%96%E8%AF%91">官网文档</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tar zxvf go1.6.2.linux-amd64.tar.gz 
</span><span class='line'>
</span><span class='line'>/etc/profile
</span><span class='line'>export GOROOT=/opt/go
</span><span class='line'>export GOPATH=/opt/gopath
</span><span class='line'>export PATH=$GOPATH/bin:$GOROOT/bin:$PATH
</span><span class='line'>
</span><span class='line'>-
</span><span class='line'>
</span><span class='line'>[root@cu2 CodisLabs]# pwd
</span><span class='line'>/opt/go/src/github.com/CodisLabs
</span><span class='line'>
</span><span class='line'># @2017-06-05
</span><span class='line'># 如果下载的是tar.gz，直接在CodisLabs目录下解压，然后做个软链接
</span><span class='line'># cd $GOPATH ; mkdir -p src/github.com/CodisLabs/
</span><span class='line'># cd src/github.com/CodisLabs/; ln -s codis-3.2-rc2 codis
</span><span class='line'>[root@cu2 CodisLabs]# git clone --branch release3.2  https://github.com/CodisLabs/codis.git 
</span><span class='line'>
</span><span class='line'>[root@cu2 CodisLabs]# cd codis/
</span><span class='line'>
</span><span class='line'># 安装一些依赖
</span><span class='line'># # ./autogen.sh: line 5: autoconf: command not found
</span><span class='line'># yum install autoconf 
</span><span class='line'>[root@cu2 codis]# make 
</span><span class='line'>
</span><span class='line'>[root@cu2 codis]# ll bin/
</span><span class='line'>total 101292
</span><span class='line'>drwxr-xr-x 4 root root     4096 Mar 15 12:58 assets
</span><span class='line'>-rwxr-xr-x 1 root root 21036930 Mar 15 12:58 codis-admin
</span><span class='line'>-rwxr-xr-x 1 root root 22343059 Mar 15 12:58 codis-dashboard
</span><span class='line'>-rwxr-xr-x 1 root root 18378506 Mar 15 12:58 codis-fe
</span><span class='line'>-rwxr-xr-x 1 root root 22675153 Mar 15 12:58 codis-proxy
</span><span class='line'>-rwxr-xr-x 1 root root  7982967 Mar 15 12:58 codis-server
</span><span class='line'>-rwxr-xr-x 1 root root  5580431 Mar 15 12:58 redis-benchmark
</span><span class='line'>-rwxr-xr-x 1 root root  5712419 Mar 15 12:58 redis-cli
</span><span class='line'>-rw-r--r-- 1 root root      170 Mar 15 12:58 version
</span><span class='line'>[root@cu2 codis]# cat bin/version 
</span><span class='line'>version = 2017-03-15 00:40:41 +0800 @be9ee25c63a64396b5fb0076447be560497b909d @3.2-beta-10-gbe9ee25
</span><span class='line'>compile = 2017-03-15 12:58:23 +0800 by go version go1.6.2 linux/amd64
</span><span class='line'>
</span><span class='line'># 生成默认配置
</span><span class='line'>[root@cu2 codis]# bin/codis-dashboard --default-config | tee dashboard.toml
</span><span class='line'>[root@cu2 codis]# bin/codis-proxy --default-config | tee proxy.toml
</span></code></pre></td></tr></table></div></figure>


<h2>生产部署</h2>

<p>把测试环境的GOPATH和GOROOT全部拷贝到生产即可。这里上面已经生成了dashboard和proxy的配置了哦！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ud@cu-ud6 opt]$ ll
</span><span class='line'>drwxrwxr-x.  2 ud   ud   4096 3月  18 00:10 bin
</span><span class='line'>drwxr-xr-x. 11 ud   ud   4096 4月  20 2016 go
</span><span class='line'>drwxr-xr-x.  4 ud   ud   4096 3月  15 12:58 gopath
</span><span class='line'>drwxr-xr-x.  8 ud   ud   4096 3月  17 20:13 jdk1.8.0_92
</span><span class='line'>drwxr-xr-x. 10 ud   ud   4096 2月  20 2014 zookeeper-3.4.6
</span><span class='line'>
</span><span class='line'>[ud@cu-ud6 opt]$ ll bin
</span><span class='line'>总用量 24
</span><span class='line'>-rw-rw-r--. 1 ud ud 234 3月  17 20:36 codis.profile
</span><span class='line'>lrwxrwxrwx. 1 ud ud  54 3月  17 20:34 redis-cli -&gt; ../gopath/src/github.com/CodisLabs/codis/bin/redis-cli
</span><span class='line'>-rwxrwxr-x. 1 ud ud 487 3月  17 20:54 start-codis-dashboard.sh
</span><span class='line'>-rwxrwxr-x. 1 ud ud 310 3月  18 00:10 start-codis-proxy.sh
</span><span class='line'>-rwxrwxr-x. 1 ud ud 335 3月  17 21:17 start-redis.sh
</span><span class='line'>-rwxrwxr-x. 1 ud ud 323 3月  17 20:55 start-zoo.sh
</span><span class='line'>
</span><span class='line'>[ud@cu-ud6 opt]$ for f in $( find bin -type f ) ; do echo " =============== $f ================= "; cat "$f" ; done
</span><span class='line'> =============== bin/codis.profile ================= 
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>export GOROOT=/opt/go
</span><span class='line'>export GOPATH=/opt/gopath
</span><span class='line'>export CODIS_HOME=$GOPATH/src/github.com/CodisLabs/codis/
</span><span class='line'>export LOG_DIR=/var/log
</span><span class='line'>
</span><span class='line'>export JAVA_HOME=/opt/jdk1.8.0_92
</span><span class='line'>
</span><span class='line'>export PATH=$JAVA_HOME/bin:$GOPATH/bin:$GOROOT/bin:$PATH
</span><span class='line'>
</span><span class='line'> =============== bin/start-zoo.sh ================= 
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>CODIS_BIN="${BASH_SOURCE-$0}"
</span><span class='line'>CODIS_BIN="$(dirname "${CODIS_BIN}")"
</span><span class='line'>CODIS_BINDIR="$(cd "${CODIS_BIN}"; pwd)"
</span><span class='line'>
</span><span class='line'>source $CODIS_BINDIR/codis.profile
</span><span class='line'>
</span><span class='line'>export ZOO_LOG_DIR=$LOG_DIR
</span><span class='line'>
</span><span class='line'>cd /opt/zookeeper-3.4.6
</span><span class='line'>sed 's@dataDir=/tmp/zookeeper@dataDir=/data/zookeeper@' conf/zoo_sample.cfg &gt;conf/zoo.cfg
</span><span class='line'>
</span><span class='line'>bin/zkServer.sh start
</span><span class='line'>
</span><span class='line'> =============== bin/start-codis-dashboard.sh ================= 
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>CODIS_BIN="${BASH_SOURCE-$0}"
</span><span class='line'>CODIS_BIN="$(dirname "${CODIS_BIN}")"
</span><span class='line'>CODIS_BINDIR="$(cd "${CODIS_BIN}"; pwd)"
</span><span class='line'>
</span><span class='line'>source $CODIS_BINDIR/codis.profile
</span><span class='line'>
</span><span class='line'>cd $CODIS_HOME
</span><span class='line'>nohup bin/codis-dashboard \
</span><span class='line'>  --ncpu=4 \
</span><span class='line'>  --config=dashboard.toml \
</span><span class='line'>  --log=$LOG_DIR/codis_dashboard.log \
</span><span class='line'>  --log-level=INFO \
</span><span class='line'>  &gt;/dev/null 2&gt;&1 &
</span><span class='line'>
</span><span class='line'>nohup bin/codis-fe \
</span><span class='line'>  --ncpu=4 \
</span><span class='line'>  --zookeeper=127.0.0.1:2181 \
</span><span class='line'>  --listen=0.0.0.0:28080 \
</span><span class='line'>  --log=$LOG_DIR/codis_fe.log \
</span><span class='line'>  --log-level=INFO \
</span><span class='line'>  &gt;/dev/null 2&gt;&1 &
</span><span class='line'>
</span><span class='line'> =============== bin/start-codis-proxy.sh ================= 
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>CODIS_BIN="${BASH_SOURCE-$0}"
</span><span class='line'>CODIS_BIN="$(dirname "${CODIS_BIN}")"
</span><span class='line'>CODIS_BINDIR="$(cd "${CODIS_BIN}"; pwd)"
</span><span class='line'>
</span><span class='line'>source $CODIS_BINDIR/codis.profile
</span><span class='line'>
</span><span class='line'>cd $CODIS_HOME
</span><span class='line'>nohup bin/codis-proxy \
</span><span class='line'>  --ncpu=24 \
</span><span class='line'>  --config=proxy.toml \
</span><span class='line'>  --log=$LOG_DIR/codis_proxy.log \
</span><span class='line'>  --log-level=INFO \
</span><span class='line'>  &gt;/dev/null 2&gt;&1 &
</span><span class='line'>
</span><span class='line'> =============== bin/start-redis.sh ================= 
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>CODIS_BIN="${BASH_SOURCE-$0}"
</span><span class='line'>CODIS_BIN="$(dirname "${CODIS_BIN}")"
</span><span class='line'>CODIS_BINDIR="$(cd "${CODIS_BIN}"; pwd)"
</span><span class='line'>
</span><span class='line'>source $CODIS_BINDIR/codis.profile
</span><span class='line'>
</span><span class='line'>PORT=${1:-6379}
</span><span class='line'>
</span><span class='line'>cd $CODIS_HOME
</span><span class='line'>bin/codis-server --daemonize yes --port $PORT --pidfile /var/run/redis_$PORT.pid --logfile $LOG_DIR/redis_$PORT.log --save "" --bind $(hostname) 
</span></code></pre></td></tr></table></div></figure>


<p>环境：</p>

<ul>
<li>zookeeper: cu-ud6</li>
<li>dashboard: cu-ud6</li>
<li>fa: cu-ud6</li>
<li>proxy: cu-ud6/7/8</li>
<li>redis: cu-ud6/7/8:6378/6379</li>
<li>nginx代理: cu-ud9</li>
</ul>


<p>web界面添加步骤：</p>

<ul>
<li>界面上添加proxy : cu6/7/8:11080</li>
<li>再添加group，填数字: &frac12;/&frac34;/5/6</li>
<li>然后添加server : cu-ud6/7/8:6378/6379</li>
<li>最后分配slots</li>
</ul>


<p><img src="/images/blogs/codis.jpg" alt="" /></p>

<p>nginx1.11新版本已经支持tcp的代理，可以实现proxy的负载均衡：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 编译Nginx
</span><span class='line'>./configure --with-stream --with-http_ssl_module --with-pcre=src/pcre --with-zlib=src/zlib --prefix=/usr/local/nginx
</span><span class='line'>make && make install
</span><span class='line'>
</span><span class='line'>[ud@cu-ud9 nginx]$ cat conf/nginx.conf
</span><span class='line'>
</span><span class='line'>#user  nobody;
</span><span class='line'>worker_processes  1;
</span><span class='line'>
</span><span class='line'>#error_log  logs/error.log;
</span><span class='line'>error_log  /var/log/nginx_error.log  notice;
</span><span class='line'>#error_log  logs/error.log  info;
</span><span class='line'>
</span><span class='line'>#pid        logs/nginx.pid;
</span><span class='line'>
</span><span class='line'>events {
</span><span class='line'>    worker_connections  1024;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>stream {
</span><span class='line'>  upstream proxy {
</span><span class='line'>    hash   $remote_addr;
</span><span class='line'>    server cu-ud6:19000;
</span><span class='line'>    server cu-ud7:19000;
</span><span class='line'>    server cu-ud8:19000;
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  server {
</span><span class='line'>    listen cu-ud9:19000;
</span><span class='line'>    proxy_timeout 600s;
</span><span class='line'>    proxy_pass proxy;
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'># 测试获取数据
</span><span class='line'>[ud@cu-ud6 opt]$ bin/redis-cli -h cu-ud6 -p 6379 scan 0 # 样本Key
</span><span class='line'>[ud@cu-ud6 opt]$ bin/redis-cli -h cu-ud9 -p 19000
</span><span class='line'>&gt; get XXX
</span></code></pre></td></tr></table></div></figure>


<p>重置统计量：</p>

<ul>
<li><a href="https://github.com/CodisLabs/codis/issues/1049">https://github.com/CodisLabs/codis/issues/1049</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ud@cu-ud6 codis]$ bin/codis-admin --proxy=cu-ud6:11080 --reset-stats</span></code></pre></td></tr></table></div></figure>


<h2>问题</h2>

<p>pipeline量太大，修改proxy的 backend_max_pipeline/session_max_pipeline 。同时在客户端代码里面执行一定量的pipe后执行sync。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2017/03/18 00:01:23 session.go:79: [INFO] session [0xc839888d80] create: {"ops":0,"create":1489766483,"remote":"192.168.32.182:57029"}
</span><span class='line'>2017/03/18 00:01:24 session.go:86: [INFO] session [0xc834a06d80] closed: {"ops":39601,"create":1489766483,"lastop":1489766484,"remote":"192.168.32.182:57028"}, error: too many pipelined r
</span><span class='line'>equests</span></code></pre></td></tr></table></div></figure>


<p>sync还是会超时，修改nginx的proxy_timeout以及客户端初始化的timeout参数。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>new JedisPool(new GenericObjectPoolConfig(), "cu-ud9", 19000, 10 * 60 * 1000)</span></code></pre></td></tr></table></div></figure>


<p>W：感觉proxy还是会有停顿，sync后有时会出现几分钟时间没响应。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/03/12/k8s-harbor-config-on-centos6/">K8s Harbor Config on Centos6</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-03-12T23:21:30+08:00" pubdate data-updated="true">Sun 2017-03-12 23:21</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>前传</h2>

<p>前面有写在 centos6 安装k8s的文章，后来重启一台worker节点后该节点的网络就不通了 <strong> connect: Invalid argument </strong> 。更新到最新的0.7.0后worker节点重启网络都能正常连通。</p>

<ul>
<li><a href="https://github.com/coreos/flannel/issues/180">https://github.com/coreos/flannel/issues/180</a></li>
</ul>


<p>言归正传，来说说harbor的安装。想的是安装一个类似maven私服的功能（原来都是一台机一台机的save/load，麻烦）：</p>

<ul>
<li>本来安装registry就好了，每次都要加端口很烦有没有！！！</li>
<li>弄了个service整到80端口，还得加 <strong> &ndash;insecure-registry </strong> 参数。还行吧，但是没有图形界面</li>
<li>好了，看到有人用nexus3做docker私服。主要吧真没弄通，第二nexus3不会用！反正就是没搭成功了。</li>
<li>本来前面有看到过vmware harbor，但是官网说是要docker1.10+的，差点就打消念头了，但是nexus3实在是搞不懂，只能硬着头皮尝试下harbor。</li>
</ul>


<p>这hardor是一坑货啊，功能是狠牛逼但是文档版本都对不上的！！！</p>

<p>这里还是在 centos6 上面安装。并且老版本k8s-1.2各种配置不能用，一个个坑填的好苦！行，先爽一把，看看修改后的简单的安装操作流程：</p>

<h2>简单配置</h2>

<p>版本信息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# lsb_release -a
</span><span class='line'>LSB Version:    :base-4.0-amd64:base-4.0-noarch:core-4.0-amd64:core-4.0-noarch:graphics-4.0-amd64:graphics-4.0-noarch:printing-4.0-amd64:printing-4.0-noarch
</span><span class='line'>Distributor ID: CentOS
</span><span class='line'>Description:    CentOS release 6.8 (Final)
</span><span class='line'>Release:        6.8
</span><span class='line'>Codename:       Final
</span><span class='line'>[root@cu2 ~]# docker version
</span><span class='line'>Client version: 1.7.1
</span><span class='line'>Client API version: 1.19
</span><span class='line'>Go version (client): go1.4.2
</span><span class='line'>Git commit (client): 786b29d/1.7.1
</span><span class='line'>OS/Arch (client): linux/amd64
</span><span class='line'>Server version: 1.7.1
</span><span class='line'>Server API version: 1.19
</span><span class='line'>Go version (server): go1.4.2
</span><span class='line'>Git commit (server): 786b29d/1.7.1
</span><span class='line'>OS/Arch (server): linux/amd64</span></code></pre></td></tr></table></div></figure>


<ul>
<li>创建CA和证书</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 kubernetes]# git clone https://github.com/OpenVPN/easy-rsa.git
</span><span class='line'>
</span><span class='line'>[root@cu2 easyrsa3]# ./easyrsa init-pki
</span><span class='line'>[root@cu2 easyrsa3]# ./easyrsa build-ca #记住输入的密码，下面颁发证书还会用到
</span><span class='line'>
</span><span class='line'>[root@cu2 easyrsa3]# ./easyrsa gen-req cu nopass
</span><span class='line'>[root@cu2 easyrsa3]# ./easyrsa sign-req server cu #commonName填将要用到的域名咯
</span><span class='line'>
</span><span class='line'>生成的key和证书在pki/private和pki/issued下</span></code></pre></td></tr></table></div></figure>


<ul>
<li>下载配置</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/winse/docker-hadoop.git
</span><span class='line'>cd docker-hadoop/k8s-centos6/containers/harbor-make/</span></code></pre></td></tr></table></div></figure>


<ul>
<li>修改harbor.cfg配置</li>
</ul>


<p>把 <strong>域名</strong> 和 <strong>证书路径</strong> 修改成自己的。</p>

<ul>
<li>生成ConfigMaps配置</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>scl enable python27 bash
</span><span class='line'>python2.7 kubernetes/prepare </span></code></pre></td></tr></table></div></figure>


<ul>
<li>创建服务和容器</li>
</ul>


<p>这里需要先下载官网的离线包harbor-offline-installer-0.5.0.tgz，加载harbor.0.5.0.tgz里面的镜像</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 harbor]# docker images 
</span><span class='line'>REPOSITORY                                            TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
</span><span class='line'>gcr.io/google_containers/heapster-grafana-amd64       v4.0.2              74d2c72849cc        7 weeks ago         131.5 MB
</span><span class='line'>gcr.io/google_containers/heapster-influxdb-amd64      v1.1.1              55d63942e2eb        7 weeks ago         11.59 MB
</span><span class='line'>gcr.io/google_containers/heapster-amd64               v1.3.0-beta.1       026fb02eca65        7 weeks ago         101.3 MB
</span><span class='line'>quay.io/coreos/flannel                                v0.7.0-amd64        072e88d50780        8 weeks ago         73.75 MB
</span><span class='line'>gcr.io/google_containers/kubernetes-dashboard-amd64   v1.5.1              9af7d5c61ccf        8 weeks ago         103.6 MB
</span><span class='line'>vmware/harbor-log                                     0.5.0               5cccdd11efe0        3 months ago        190.5 MB
</span><span class='line'>vmware/harbor-jobservice                              0.5.0               573d0bbd91ee        3 months ago        169.4 MB
</span><span class='line'>vmware/harbor-ui                                      0.5.0               990d3476bf93        3 months ago        233 MB
</span><span class='line'>vmware/harbor-db                                      0.5.0               9a595c26d6bc        3 months ago        326.8 MB
</span><span class='line'>nginx                                                 1.11.5              98f8314de615        4 months ago        181.4 MB
</span><span class='line'>gcr.io/google_containers/hyperkube-amd64              v1.2.7              1dd7250ed1b3        4 months ago        231.4 MB
</span><span class='line'>quay.io/coreos/flannel                                v0.6.1-amd64        ef86f3a53de0        6 months ago        27.89 MB
</span><span class='line'>gcr.io/google_containers/etcd-amd64                   3.0.4               ef5e89d609f1        7 months ago        39.62 MB
</span><span class='line'>registry                                              2.5.0               8cc599785872        7 months ago        33.28 MB
</span><span class='line'>gcr.io/google_containers/kube2sky-amd64               1.15                f93305484d65        10 months ago       29.16 MB
</span><span class='line'>gcr.io/google_containers/etcd-amd64                   2.2.5               a6752fb962b5        11 months ago       30.45 MB
</span><span class='line'>gcr.io/google_containers/skydns-amd64                 1.0                 a925f95d080a        11 months ago       15.57 MB
</span><span class='line'>gcr.io/google_containers/exechealthz-amd64            1.0                 5b9ac190b20c        11 months ago       7.116 MB
</span><span class='line'>gcr.io/google_containers/pause                        2.0                 9981ca1bbdb5        17 months ago       350.2 kB
</span><span class='line'>
</span><span class='line'>---
</span><span class='line'>
</span><span class='line'>cd kubernetes/
</span><span class='line'>sh apply.sh</span></code></pre></td></tr></table></div></figure>


<ul>
<li>手动修复容器的配置文件</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sh config.sh</span></code></pre></td></tr></table></div></figure>


<p>CentOS6-K8S上面麻烦点，在CentOS7-K8S_V1.5+上面ConfigMap Volumn是可以用的，就不需要自己手动拷贝配置了。</p>

<ul>
<li>使用</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 easyrsa3]# kubectl get services 
</span><span class='line'>NAME         CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE
</span><span class='line'>jobservice   10.0.0.154   &lt;none&gt;        80/TCP              1d
</span><span class='line'>kubernetes   10.0.0.1     &lt;none&gt;        443/TCP             2d
</span><span class='line'>mysql        10.0.0.176   &lt;none&gt;        3306/TCP            1d
</span><span class='line'>nginx        10.0.0.78    &lt;none&gt;        80/TCP,443/TCP      1d
</span><span class='line'>registry     10.0.0.46    &lt;none&gt;        5000/TCP,5001/TCP   1d
</span><span class='line'>ui           10.0.0.11    &lt;none&gt;        80/TCP              1d
</span><span class='line'>
</span><span class='line'># 域名
</span><span class='line'>[root@cu3 ~]# vi /etc/hosts
</span><span class='line'>10.0.0.78 cu.eshore.cn
</span><span class='line'>
</span><span class='line'># 证书
</span><span class='line'>[root@cu3 ~]# mkdir -p /etc/docker/certs.d/cu.eshore.cn/
</span><span class='line'>
</span><span class='line'>[root@cu2 pki]# scp ca.crt cu3:/etc/docker/certs.d/cu.eshore.cn/
</span><span class='line'>
</span><span class='line'># 登录
</span><span class='line'>[root@cu3 certs.d]# docker login cu.eshore.cn
</span><span class='line'>Username: admin
</span><span class='line'>Password: Harbor12345
</span><span class='line'>Email: 1
</span><span class='line'>WARNING: login credentials saved in /root/.docker/config.json
</span><span class='line'>Login Succeeded
</span><span class='line'>
</span><span class='line'># https://cu.eshore.cn 通过WEB页面创建项目 google_containers
</span><span class='line'>
</span><span class='line'># PUSH
</span><span class='line'>[root@cu3 certs.d]# docker tag gcr.io/google_containers/pause:2.0 cu.eshore.cn/google_containers/pause:2.0
</span><span class='line'>
</span><span class='line'>[root@cu3 certs.d]# docker push cu.eshore.cn/google_containers/pause:2.0
</span><span class='line'>The push refers to a repository [cu.eshore.cn/google_containers/pause] (len: 1)
</span><span class='line'>9981ca1bbdb5: Image already exists 
</span><span class='line'>6995a49b90f2: Image successfully pushed 
</span><span class='line'>Digest: sha256:139471770ffc22a2f15ae2ad8e3a0b3b9cbd620ad32400c7e8024a3d09ebec7d
</span></code></pre></td></tr></table></div></figure>


<h1>&mdash;&mdash; 下面是记流水账内容 &mdash;&mdash;</h1>

<h2>简单搭建配置</h2>

<p>参考阅读</p>

<ul>
<li><a href="http://www.zoues.com/2017/02/19/vmware-harbor-%E5%9C%A8-kubernetes-%E4%B8%8A%E7%9A%84%E9%83%A8%E7%BD%B2%E3%80%90zoues-com%E3%80%91/">在 KUBERNETES 上的部署 VMWare Harbor</a></li>
<li><a href="https://github.com/vmware/harbor/blob/master/docs/kubernetes_deployment.md">主干文档 Integration with Kubernetes </a></li>
<li><a href="https://github.com/vmware/harbor/blob/master/docs/installation_guide.md">https://github.com/vmware/harbor/blob/master/docs/installation_guide.md</a></li>
<li><a href="https://github.com/vmware/harbor/tree/00259567a8b59758930950440a0ecfd6061db485/make/kubernetes">https://github.com/vmware/harbor/tree/00259567a8b59758930950440a0ecfd6061db485/make/kubernetes</a></li>
</ul>


<p>简略步骤：</p>

<ul>
<li>下载0.5.0的离线压缩包 harbor-offline-installer-0.5.0.tgz</li>
<li>把镜像加载到本地（解压offline后在目录下有tgz的镜像压缩包） <code>docker load -i harbor.0.5.0.tgz</code></li>
<li>下载github主干的源码 harbor-master.zip ，对是主干，不是release页面的源码！！！（香菇，release源码包里面的k8s配置文件尽然是不配套的，那打什么版本咯！！文档也不说明下。非常非常感谢 www.zoues.com 博主，这才是明灯啊）</li>
<li>安装python2.7（prepare脚本需要） <code>yum install centos-release-scl; yum install -y python27</code></li>
<li>解压进入到 harbor-master/make 目录</li>
<li>修改harbor.cfg文件配置。（这里我就改了域名而已，会有https的问题。先不管跑起来先，后面在讲https的处理）</li>
<li>执行prepare脚本，用于生成配置键值对cm文件（ConfigMaps）。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 make]# python kubernetes/prepare 
</span><span class='line'>Traceback (most recent call last):
</span><span class='line'>  File "kubernetes/prepare", line 145, in &lt;module&gt;
</span><span class='line'>    pkey = subprocess.check_output(['openssl','genrsa','4096'], stderr=devnull)
</span><span class='line'>AttributeError: 'module' object has no attribute 'check_output'
</span><span class='line'>
</span><span class='line'>&gt; Python should be version 2.7 or higher. Note that you may have to install Python on Linux distributions (Gentoo, Arch) that do not come with a Python interpreter installed by default
</span><span class='line'>
</span><span class='line'>https://github.com/h2oai/h2o-2/wiki/installing-python-2.7-on-centos-6.3.-follow-this-sequence-exactly-for-centos-machine-only
</span><span class='line'>https://gist.github.com/dalegaspi/dec44117fa5e7597a559  我按这个小写的安装的
</span><span class='line'>[root@cu2 make]# yum install centos-release-scl
</span><span class='line'>[root@cu2 make]# yum install -y python27
</span><span class='line'>
</span><span class='line'>[root@cu2 make]# scl enable python27 bash
</span><span class='line'>[root@cu2 make]# /opt/rh/python27/root/usr/bin/python -V
</span><span class='line'>Python 2.7.8
</span><span class='line'>
</span><span class='line'>[root@cu2 make]# less harbor.cfg 
</span><span class='line'>
</span><span class='line'>[root@cu2 make]# /opt/rh/python27/root/usr/bin/python kubernetes/prepare 
</span><span class='line'>Warning: Key(ldap_searchdn) is not existing. Use empty string as default
</span><span class='line'>Warning: Key(ldap_search_pwd) is not existing. Use empty string as default
</span><span class='line'>Warning: Key(ldap_filter) is not existing. Use empty string as default</span></code></pre></td></tr></table></div></figure>


<ul>
<li>然后就是愉快的执行apply就好：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl apply -f pv/
</span><span class='line'>
</span><span class='line'>kubectl apply -f jobservice/jobservice.cm.yaml
</span><span class='line'>kubectl apply -f mysql/mysql.cm.yaml
</span><span class='line'>kubectl apply -f nginx/nginx.cm.yaml
</span><span class='line'>kubectl apply -f registry/registry.cm.yaml
</span><span class='line'>kubectl apply -f ui/ui.cm.yaml
</span><span class='line'>
</span><span class='line'>kubectl apply -f jobservice/jobservice.svc.yaml
</span><span class='line'>kubectl apply -f mysql/mysql.svc.yaml
</span><span class='line'>kubectl apply -f nginx/nginx.svc.yaml
</span><span class='line'>kubectl apply -f registry/registry.svc.yaml
</span><span class='line'>kubectl apply -f ui/ui.svc.yaml
</span><span class='line'>
</span><span class='line'>kubectl apply -f registry/registry.rc.yaml
</span><span class='line'>kubectl apply -f mysql/mysql.rc.yaml
</span><span class='line'>kubectl apply -f jobservice/jobservice.rc.yaml
</span><span class='line'>kubectl apply -f ui/ui.rc.yaml
</span><span class='line'>kubectl apply -f nginx/nginx.rc.yaml
</span></code></pre></td></tr></table></div></figure>


<p>由于ConfigMaps方式不能正确的创建文件需要把配置文件拷贝到对应容器的config目录下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sh config.sh</span></code></pre></td></tr></table></div></figure>


<p>除了nginx报https的证书问题外，其他都正常跑起来了。把nginx.conf的https server部分先删掉，先查看效果。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 kubernetes]# kubectl get rc
</span><span class='line'>NAME            DESIRED   CURRENT   AGE
</span><span class='line'>jobservice-rc   1         1         4h
</span><span class='line'>mysql-rc        1         1         4h
</span><span class='line'>nginx-rc        1         1         4h
</span><span class='line'>registry-rc     1         1         4h
</span><span class='line'>ui-rc           1         1         4h
</span><span class='line'>[root@cu2 kubernetes]# kubectl get pods
</span><span class='line'>NAME                       READY     STATUS    RESTARTS   AGE
</span><span class='line'>jobservice-rc-3hhea        1/1       Running   0          4h
</span><span class='line'>k8s-master-192.168.0.214   4/4       Running   28         2d
</span><span class='line'>k8s-proxy-192.168.0.214    1/1       Running   4          2d
</span><span class='line'>mysql-rc-nyk6z             1/1       Running   0          4h
</span><span class='line'>nexus-3126345715-mfteg     1/1       Running   0          2d # 这个是maven私服
</span><span class='line'>nginx-rc-93cdr             1/1       Running   15         4h
</span><span class='line'>registry-rc-qbdfk          1/1       Running   12         4h
</span><span class='line'>ui-rc-7e76i                1/1       Running   10         4h
</span><span class='line'>
</span><span class='line'>[root@cu2 kubernetes]# kubectl get services nginx
</span><span class='line'>NAME      CLUSTER-IP   EXTERNAL-IP   PORT(S)          AGE
</span><span class='line'>nginx     10.0.0.78    &lt;none&gt;        80/TCP,443/TCP   1d
</span></code></pre></td></tr></table></div></figure>


<p>访问nginx：</p>

<p><img src="/images/blogs/k8s-harbor.jpg" alt="" /></p>

<p>安装完了后，使用harbor.cfg配置文件里面的admin和密码进行登录。然后看看官网的操作文档 <a href="https://github.com/vmware/harbor/blob/master/docs/user_guide.md">https://github.com/vmware/harbor/blob/master/docs/user_guide.md</a></p>

<p>现在PUSH要加 <code>--insecure-registry</code> 参数，还得重启docker太麻烦了。等下先弄https，搞好后添加证书直接push比较爽。</p>

<h2>修改配置过程中遇到的一些问题</h2>

<p>pvc在v1.2的时刻不支持selector。使用volumeName属性来代替。</p>

<ul>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/</a></li>
<li><a href="https://kubernetes.io/docs/user-guide/persistent-volumes/#persistentvolumeclaims">https://kubernetes.io/docs/user-guide/persistent-volumes/#persistentvolumeclaims</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.2.7/docs/user-guide/persistent-volumes/claims">https://github.com/kubernetes/kubernetes/tree/v1.2.7/docs/user-guide/persistent-volumes/claims</a></li>
<li><a href="https://kubernetes.io/docs/resources-reference/v1.5/#persistentvolumeclaim-v1">https://kubernetes.io/docs/resources-reference/v1.5/#persistentvolumeclaim-v1</a></li>
<li><a href="http://blog.fleeto.us/translation/persistent-volumes">http://blog.fleeto.us/translation/persistent-volumes</a></li>
</ul>


<p>巨坑，键名对不能用下划线、不能大写字母，到1.4才修复。</p>

<ul>
<li><a href="https://github.com/kubernetes/kubernetes/issues/23722">Allow underscore in configMapKeyRef key&rsquo;s</a></li>
</ul>


<p>configmap~volumn用于创建volumns好像有问题，没有创建对应文件。</p>

<ul>
<li><a href="https://kubernetes.io/docs/user-guide/configmap/">https://kubernetes.io/docs/user-guide/configmap/</a></li>
<li><a href="http://stackoverflow.com/questions/36187624/kubernetes-configmap-volume-doesnt-create-file-in-container">http://stackoverflow.com/questions/36187624/kubernetes-configmap-volume-doesnt-create-file-in-container</a></li>
</ul>


<p>在1.5.3上面是可以生成的。。。囧，相比puppet的文档，k8s的文档真的差了十万八千里啊！！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s kube-deploy]# kubectl logs nginx-rc-fr52v
</span><span class='line'>https.crt
</span><span class='line'>https.key
</span><span class='line'>nginx.conf</span></code></pre></td></tr></table></div></figure>


<p>后面看到nginx的v1.2用了secrets修改后也不行。</p>

<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/release-1.2/examples/https-nginx/nginx-app.yaml">https://github.com/kubernetes/kubernetes/blob/release-1.2/examples/https-nginx/nginx-app.yaml</a> 看到1.2使用secret volumes</li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/52f4d3806919e4ec16cb17336a1802461cf40a46/test/kubemark/resources/hollow-node_template.yaml">https://github.com/kubernetes/kubernetes/blob/52f4d3806919e4ec16cb17336a1802461cf40a46/test/kubemark/resources/hollow-node_template.yaml</a></li>
<li><a href="https://kubernetes.io/docs/user-guide/secrets/">https://kubernetes.io/docs/user-guide/secrets/</a></li>
<li><a href="https://kubernetes.io/docs/user-guide/configmap/">https://kubernetes.io/docs/user-guide/configmap/</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/downward-api-volume-expose-pod-information/">https://kubernetes.io/docs/tasks/configure-pod-container/downward-api-volume-expose-pod-information/</a></li>
</ul>


<p>其实就是docker版本老的不支持shared，其实在kubelet的容器里面是创建了对应的文件的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># docker logs
</span><span class='line'>I0316 08:22:19.729825   13206 volumes.go:279] Used volume plugin "kubernetes.io/configmap" to mount config
</span><span class='line'>I0316 08:22:19.729860   13206 configmap.go:118] Setting up volume config for pod cfe8b3f6-09fb-11e7-bdde-020047eb000e at /var/lib/kubelet/pods/cfe8b3f6-09fb-11e7-bdde-020047eb000e/volumes/kubernetes.io~configmap/config
</span><span class='line'>I0316 08:22:19.729915   13206 volumes.go:279] Used volume plugin "kubernetes.io/empty-dir" to mount wrapped_config
</span><span class='line'>...
</span><span class='line'>I0316 08:22:19.733309   13206 configmap.go:145] Received configMap default/harbor-ui-config containing (30) pieces of data, 3739 total bytes
</span><span class='line'>I0316 08:22:19.733470   13206 atomic_writer.go:316] /var/lib/kubelet/pods/cfe8b3f6-09fb-11e7-bdde-020047eb000e/volumes/kubernetes.io~configmap/config: current paths:   [app.conf private_key.pem]
</span><span class='line'>I0316 08:22:19.733493   13206 atomic_writer.go:328] /var/lib/kubelet/pods/cfe8b3f6-09fb-11e7-bdde-020047eb000e/volumes/kubernetes.io~configmap/config: new paths:       [app.conf private_key.pem]
</span><span class='line'>I0316 08:22:19.733502   13206 atomic_writer.go:331] /var/lib/kubelet/pods/cfe8b3f6-09fb-11e7-bdde-020047eb000e/volumes/kubernetes.io~configmap/config: paths to remove: map[]
</span><span class='line'>I0316 08:22:19.733552   13206 atomic_writer.go:136] pod default/ui-rc-psjzs volume config: no update required for target directory /var/lib/kubelet/pods/cfe8b3f6-09fb-11e7-bdde-020047eb000e/volumes/kubernetes.io~configmap/config
</span><span class='line'>
</span><span class='line'>[root@cu3 config]# docker exec -ti b34c51260dda bash
</span><span class='line'>root@cu3:/# ls -al /var/lib/kubelet/pods/cfe8b3f6-09fb-11e7-bdde-020047eb000e/volumes/kubernetes.io~configmap/config
</span><span class='line'>total 4
</span><span class='line'>drwxrwxrwt 3 root root  120 Mar 16 04:08 .
</span><span class='line'>drwxr-xr-x 3 root root 4096 Mar 16 04:08 ..
</span><span class='line'>drwxr-xr-x 2 root root   80 Mar 16 04:08 ..3983_16_03_04_08_50.565987072
</span><span class='line'>lrwxrwxrwx 1 root root   31 Mar 16 04:08 ..data -&gt; ..3983_16_03_04_08_50.565987072
</span><span class='line'>lrwxrwxrwx 1 root root   15 Mar 16 04:08 app.conf -&gt; ..data/app.conf
</span><span class='line'>lrwxrwxrwx 1 root root   22 Mar 16 04:08 private_key.pem -&gt; ..data/private_key.pem</span></code></pre></td></tr></table></div></figure>


<p>最后放弃了，直接用脚本来创建文件，然后把文件拷贝到对应的机器。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 kubernetes]# cd harbor-make/kubernetes/
</span><span class='line'>[root@cu2 kubernetes]# sh config.sh </span></code></pre></td></tr></table></div></figure>


<h2>HTTPS</h2>

<ul>
<li><a href="http://www.pangxie.space/docker/353">Docker部署认证私有仓库(registry2.x+nginx)-centos7</a></li>
<li><a href="https://github.com/vmware/harbor/blob/master/docs/configure_https.md">Configuring Harbor with HTTPS Access</a></li>
</ul>


<p>生成CA和证书</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 kubernetes]# git clone https://github.com/OpenVPN/easy-rsa.git
</span><span class='line'>
</span><span class='line'>https://github.com/OpenVPN/easy-rsa/blob/master/README.quickstart.md
</span><span class='line'>
</span><span class='line'>[root@cu2 easyrsa3]# ll
</span><span class='line'>total 56
</span><span class='line'>-rwxr-xr-x 1 root root 35253 Mar 13 01:04 easyrsa
</span><span class='line'>-rw-r--r-- 1 root root  4560 Mar 13 01:04 openssl-1.0.cnf
</span><span class='line'>-rw-r--r-- 1 root root  8126 Mar 13 01:04 vars.example
</span><span class='line'>drwxr-xr-x 2 root root  4096 Mar 13 01:04 x509-types
</span><span class='line'>[root@cu2 easyrsa3]# ./easyrsa init-pki
</span><span class='line'>
</span><span class='line'>init-pki complete; you may now create a CA or requests.
</span><span class='line'>Your newly created PKI dir is: /data/kubernetes/easy-rsa/easyrsa3/pki
</span><span class='line'>
</span><span class='line'>[root@cu2 easyrsa3]# ./easyrsa build-ca
</span><span class='line'>Generating a 2048 bit RSA private key
</span><span class='line'>.............................+++
</span><span class='line'>..............................................+++
</span><span class='line'>writing new private key to '/data/kubernetes/easy-rsa/easyrsa3/pki/private/ca.key.Nj5oHgfZC5'
</span><span class='line'>Enter PEM pass phrase: 123456
</span><span class='line'>Verifying - Enter PEM pass phrase: 123456
</span><span class='line'>-----
</span><span class='line'>You are about to be asked to enter information that will be incorporated
</span><span class='line'>into your certificate request.
</span><span class='line'>What you are about to enter is what is called a Distinguished Name or a DN.
</span><span class='line'>There are quite a few fields but you can leave some blank
</span><span class='line'>For some fields there will be a default value,
</span><span class='line'>If you enter '.', the field will be left blank.
</span><span class='line'>-----
</span><span class='line'>Common Name (eg: your user, host, or server name) [Easy-RSA CA]:eshore.cn
</span><span class='line'>
</span><span class='line'>CA creation complete and you may now import and sign cert requests.
</span><span class='line'>Your new CA certificate file for publishing is at:
</span><span class='line'>/data/kubernetes/easy-rsa/easyrsa3/pki/ca.crt
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[root@cu2 easyrsa3]# ./easyrsa gen-req cu nopass
</span><span class='line'>Generating a 2048 bit RSA private key
</span><span class='line'>..........+++
</span><span class='line'>.................................+++
</span><span class='line'>writing new private key to '/data/kubernetes/easy-rsa/easyrsa3/pki/private/cu.key.LQX3Dr2jG3'
</span><span class='line'>-----
</span><span class='line'>You are about to be asked to enter information that will be incorporated
</span><span class='line'>into your certificate request.
</span><span class='line'>What you are about to enter is what is called a Distinguished Name or a DN.
</span><span class='line'>There are quite a few fields but you can leave some blank
</span><span class='line'>For some fields there will be a default value,
</span><span class='line'>If you enter '.', the field will be left blank.
</span><span class='line'>-----
</span><span class='line'>Common Name (eg: your user, host, or server name) [cu]:cu.eshore.cn
</span><span class='line'>
</span><span class='line'>Keypair and certificate request completed. Your files are:
</span><span class='line'>req: /data/kubernetes/easy-rsa/easyrsa3/pki/reqs/cu.req
</span><span class='line'>key: /data/kubernetes/easy-rsa/easyrsa3/pki/private/cu.key
</span><span class='line'>
</span><span class='line'>[root@cu2 easyrsa3]# ./easyrsa sign-req server cu
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>You are about to sign the following certificate.
</span><span class='line'>Please check over the details shown below for accuracy. Note that this request
</span><span class='line'>has not been cryptographically verified. Please be sure it came from a trusted
</span><span class='line'>source or that you have verified the request checksum with the sender.
</span><span class='line'>
</span><span class='line'>Request subject, to be signed as a server certificate for 3650 days:
</span><span class='line'>
</span><span class='line'>subject=
</span><span class='line'>    commonName                = cu.eshore.cn
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Type the word 'yes' to continue, or any other input to abort.
</span><span class='line'>  Confirm request details: yes
</span><span class='line'>Using configuration from /data/kubernetes/easy-rsa/easyrsa3/openssl-1.0.cnf
</span><span class='line'>Enter pass phrase for /data/kubernetes/easy-rsa/easyrsa3/pki/private/ca.key:
</span><span class='line'>Check that the request matches the signature
</span><span class='line'>Signature ok
</span><span class='line'>The Subject's Distinguished Name is as follows
</span><span class='line'>commonName            :PRINTABLE:'cu.eshore.cn'
</span><span class='line'>Certificate is to be certified until Mar 10 23:36:42 2027 GMT (3650 days)
</span><span class='line'>
</span><span class='line'>Write out database with 1 new entries
</span><span class='line'>Data Base Updated
</span><span class='line'>
</span><span class='line'>Certificate created at: /data/kubernetes/easy-rsa/easyrsa3/pki/issued/cu.crt
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[root@cu2 easyrsa3]# 
</span><span class='line'>
</span><span class='line'>这里得用签发server端证书，如果是client使用时会报错： v2 ping attempt failed with error: Get https://cu.eshore.cn/v2/: x509: certificate specifies an incompatible key usage
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[root@cu2 easyrsa3]# tree .
</span><span class='line'>.
</span><span class='line'>├── easyrsa
</span><span class='line'>├── openssl-1.0.cnf
</span><span class='line'>├── pki
</span><span class='line'>│   ├── ca.crt
</span><span class='line'>│   ├── certs_by_serial
</span><span class='line'>│   │   └── 01.pem
</span><span class='line'>│   ├── index.txt
</span><span class='line'>│   ├── index.txt.attr
</span><span class='line'>│   ├── index.txt.old
</span><span class='line'>│   ├── issued
</span><span class='line'>│   │   └── cu.crt
</span><span class='line'>│   ├── private
</span><span class='line'>│   │   ├── ca.key
</span><span class='line'>│   │   └── cu.key
</span><span class='line'>│   ├── reqs
</span><span class='line'>│   │   └── cu.req
</span><span class='line'>│   ├── serial
</span><span class='line'>│   └── serial.old
</span><span class='line'>├── vars.example
</span><span class='line'>└── x509-types
</span><span class='line'>    ├── ca
</span><span class='line'>    ├── client
</span><span class='line'>    ├── COMMON
</span><span class='line'>    └── server
</span><span class='line'>
</span><span class='line'>6 directories, 18 files</span></code></pre></td></tr></table></div></figure>


<p>重新执行以下上面的步骤，配置关联比较多。https和http请求地址会有冲突。</p>

<p>重新配置后，把ca.cert拷贝到docker节点，然后登录、创建项目、提交项目即可。最开始有帖操作的代码，这里不重复了。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/03/05/k8s-docker-multinode-on-centos6/">k8s在Centos6部署实践</a></h1>
    
    
      <p class="meta">
        








  



  
<time datetime="2017-03-05T08:49:29+08:00" pubdate data-updated="true">Sun 2017-03-05 08:49</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>2017-3-17 08:33:56 折腾了大半个月，写点小结。在centos6 + docker-1.7 + k8s-1.2 是能用起来，安装了dashboard、nexus2、harbor，但是对于一些新的东西不能用，并且k8s官网文档不分版本并且没讲明白docker兼容的版本（至少官网文档），感觉在人家那就是行，到自己这里就不行，各种折腾后然后发现是版本问题。</p>

<p>docker和k8s在容器大热的当前，版本更新太快了，docker都到1.17了。综上，如果在centos6上面玩玩了解了k8s的概况还是好的，但是真的要用还是升级centos7吧。</p>

<p>configmap-volumes真是好东西，没办法docker-1.7不支持shared volume。</p>

<p>&ndash;</p>

<p>centos6系统比较&#8221;老&#8221;啊，既没有systemd，也没有docker-engine。网上各种资料要么是原始安装（非bootstrap docker），要么就是在centos7上装的。不太想在系统上做安装，这里按照kube-deploy的docker-multinode的脚本来进行修改然后安装，由于版本不兼容需要开推土机填各种坑：centos6上面的docker才1.7还不能用kubernetes-1.3，dashboard也需要自己安装。</p>

<p>环境描述：</p>

<ul>
<li>cu2: bootstrap(etcd, flannel), main(hyperkube, pause, kubernetes-dashboard)</li>
<li>cu4、cu5: bootstrap(flannel), main(hyperkube, pause)</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# docker -H unix:///var/run/docker-bootstrap.sock ps | grep -v IMAGE | awk '{print $2}' | sort -u
</span><span class='line'>gcr.io/google_containers/etcd-amd64:3.0.4
</span><span class='line'>quay.io/coreos/flannel:v0.6.1-amd64
</span><span class='line'>[root@cu4 ~]# docker -H unix:///var/run/docker-bootstrap.sock ps | grep -v IMAGE | awk '{print $2}' | sort -u
</span><span class='line'>quay.io/coreos/flannel:v0.6.1-amd64
</span><span class='line'>
</span><span class='line'>[root@cu2 kubernetes]# docker images
</span><span class='line'>REPOSITORY                                            TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
</span><span class='line'>bigdata                                               v1                  9e30d146824b        38 hours ago        457.2 MB
</span><span class='line'>gcr.io/google_containers/heapster-grafana-amd64       v4.0.2              74d2c72849cc        6 weeks ago         131.5 MB
</span><span class='line'>gcr.io/google_containers/heapster-influxdb-amd64      v1.1.1              55d63942e2eb        6 weeks ago         11.59 MB
</span><span class='line'>gcr.io/google_containers/heapster-amd64               v1.3.0-beta.1       026fb02eca65        6 weeks ago         101.3 MB
</span><span class='line'>gcr.io/google_containers/kubernetes-dashboard-amd64   v1.5.1              9af7d5c61ccf        7 weeks ago         103.6 MB
</span><span class='line'>gcr.io/google_containers/hyperkube-amd64              v1.2.7              1dd7250ed1b3        4 months ago        231.4 MB
</span><span class='line'>quay.io/coreos/flannel                                v0.6.1-amd64        ef86f3a53de0        6 months ago        27.89 MB
</span><span class='line'>gcr.io/google_containers/etcd-amd64                   3.0.4               ef5e89d609f1        6 months ago        39.62 MB
</span><span class='line'>gcr.io/google_containers/kube2sky-amd64               1.15                f93305484d65        10 months ago       29.16 MB
</span><span class='line'>gcr.io/google_containers/etcd-amd64                   2.2.5               a6752fb962b5        10 months ago       30.45 MB
</span><span class='line'>gcr.io/google_containers/skydns-amd64                 1.0                 a925f95d080a        11 months ago       15.57 MB
</span><span class='line'>gcr.io/google_containers/exechealthz-amd64            1.0                 5b9ac190b20c        11 months ago       7.116 MB
</span><span class='line'>gcr.io/google_containers/pause                        2.0                 9981ca1bbdb5        17 months ago       350.2 kB
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>etcd，flannel，和kubernetes-dashboard用的是docker-multinode时的版本。</li>
<li>kubelet是1.2的最新版v1.2.7。</li>
<li>pause:2.0是启动apiserver、controller容器时自动下载的版本。</li>
<li>新增DNS镜像（2017-3-6 02:07:14）</li>
<li>新增heapster镜像（2017-3-6 17:00:48）</li>
</ul>


<p>最好每台机器都load提前加载所有镜像。</p>

<h2>准备</h2>

<ul>
<li>安装docker，<a href="https://wiki.centos.org/zh/Cloud/Docker">Docker</a> <a href="/blog/2014/09/27/docker-start-guide-on-centos/">Docker入门</a></li>
<li>代理，<a href="/blog/2017/02/04/privoxy-http-proxy-for-shadowsocks/">Privoxy</a></li>
<li>镜像导入导出，<a href="/blog/2017/02/06/docker-http-proxy-and-save-reload/">Docker save/load</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export NO_PROXY="localhost,127.0.0.1,10.0.0.0/8"
</span><span class='line'>export https_proxy=http://localhost:8118/
</span><span class='line'>export http_proxy=http://localhost:8118/</span></code></pre></td></tr></table></div></figure>


<h2>先看操作和效果（看了菜单再看吃不吃）</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## 下载部署脚本 
</span><span class='line'># https://github.com/winse/docker-hadoop/tree/master/k8s-centos6/docker-multinode
</span><span class='line'>
</span><span class='line'>## 防火墙，关闭selinux
</span><span class='line'># 或者最后面增加 iptables -A INPUT -s 10.0.0.0/8 -j ACCEPT
</span><span class='line'>iptables -I INPUT 1 -s 10.0.0.0/8 -j ACCEPT
</span><span class='line'>
</span><span class='line'>## 先把镜像全部下载下来 git pull ...
</span><span class='line'>* 在master节点
</span><span class='line'>[root@cu2 ~]# docker images
</span><span class='line'>REPOSITORY                                            TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
</span><span class='line'>bigdata                                               v1                  9e30d146824b        2 days ago          457.2 MB
</span><span class='line'>redis                                                 3.2.8               c30a7507ec4d        6 days ago          182.9 MB
</span><span class='line'>gcr.io/google_containers/heapster-grafana-amd64       v4.0.2              74d2c72849cc        6 weeks ago         131.5 MB
</span><span class='line'>gcr.io/google_containers/heapster-influxdb-amd64      v1.1.1              55d63942e2eb        6 weeks ago         11.59 MB
</span><span class='line'>gcr.io/google_containers/heapster-amd64               v1.3.0-beta.1       026fb02eca65        6 weeks ago         101.3 MB
</span><span class='line'>gcr.io/google_containers/kubernetes-dashboard-amd64   v1.5.1              9af7d5c61ccf        7 weeks ago         103.6 MB
</span><span class='line'>gcr.io/google_containers/hyperkube-amd64              v1.2.7              1dd7250ed1b3        4 months ago        231.4 MB
</span><span class='line'>quay.io/coreos/flannel                                v0.6.1-amd64        ef86f3a53de0        6 months ago        27.89 MB
</span><span class='line'>gcr.io/google_containers/etcd-amd64                   3.0.4               ef5e89d609f1        6 months ago        39.62 MB
</span><span class='line'>gcr.io/google_containers/kube2sky-amd64               1.15                f93305484d65        10 months ago       29.16 MB
</span><span class='line'>gcr.io/google_containers/etcd-amd64                   2.2.5               a6752fb962b5        10 months ago       30.45 MB
</span><span class='line'>gcr.io/google_containers/skydns-amd64                 1.0                 a925f95d080a        11 months ago       15.57 MB
</span><span class='line'>gcr.io/google_containers/exechealthz-amd64            1.0                 5b9ac190b20c        11 months ago       7.116 MB
</span><span class='line'>gcr.io/google_containers/pause                        2.0                 9981ca1bbdb5        17 months ago       350.2 kB
</span><span class='line'>
</span><span class='line'>## 下载kubectl
</span><span class='line'>https://storage.googleapis.com/kubernetes-release/release/v1.2.7/bin/linux/amd64/kubectl 
</span><span class='line'># https://kubernetes.io/docs/user-guide/prereqs/
</span><span class='line'># https://kubernetes.io/docs/user-guide/kubectl/kubectl_version/
</span><span class='line'>
</span><span class='line'>## 环境变量
</span><span class='line'># https://kubernetes.io/docs/user-guide/kubeconfig-file/
</span><span class='line'>export KUBECONFIG=/var/lib/kubelet/kubeconfig/kubeconfig.yaml
</span><span class='line'>export PATH=...加kubectl所在文件夹
</span><span class='line'>
</span><span class='line'>## 启动MASTER
</span><span class='line'>./master.sh
</span><span class='line'>
</span><span class='line'>## 测试效果
</span><span class='line'>curl -fsSL http://localhost:2379/health
</span><span class='line'>curl -s http://localhost:8080/healthz
</span><span class='line'>curl -s http://localhost:8080/api
</span><span class='line'>kubectl get ns
</span><span class='line'>kubectl create namespace kube-system
</span><span class='line'>
</span><span class='line'>* 在worker节点
</span><span class='line'>[root@cu3 ~]# docker images
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>## 启动WORKER
</span><span class='line'>MASTER_IP=cu2 ./worker.sh
</span></code></pre></td></tr></table></div></figure>


<p>小状况：在第一次启动master脚本会有点问题：setup-files容器运行不正常：需要从googleapi下载easy-rsa.tar.gz，可以先手动下载到/root/kube目录，然后运行setup-files.sh脚本。如果不急的话等上一段时间多run几次后好像也能跑起来（囧）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# docker exec -ti kube_kubelet_624b2 bash
</span><span class='line'>root@cu2:/# /setup-files.sh IP:10.0.0.1,DNS:kubernetes,DNS:kubernetes.default,DNS:kubernetes.default.svc,DNS:kubernetes.default.svc.cluster.local
</span><span class='line'>
</span><span class='line'>然后再次提交dashboard：
</span><span class='line'>[root@cu2 docker-multinode-centos6]# ./dashboard.sh 
</span></code></pre></td></tr></table></div></figure>


<p>然后启动应用，测试多节点的情况下启动的容器网络能否互通：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## 运行查看容器
</span><span class='line'>[root@cu2 ~]# kubectl run redis --image=bigdata:v1 -r 5 --command -- /usr/sbin/sshd -D
</span><span class='line'>
</span><span class='line'>[root@cu2 ~]# kubectl get pods -o wide
</span><span class='line'>NAME                       READY     STATUS    RESTARTS   AGE       NODE
</span><span class='line'>k8s-master-192.168.0.214   4/4       Running   22         1h        192.168.0.214
</span><span class='line'>k8s-proxy-192.168.0.214    1/1       Running   0          1h        192.168.0.214
</span><span class='line'>redis-2212193268-1789v     1/1       Running   0          1h        192.168.0.174
</span><span class='line'>redis-2212193268-1j4ej     1/1       Running   0          1h        192.168.0.174
</span><span class='line'>redis-2212193268-8dbmq     1/1       Running   0          1h        192.168.0.30
</span><span class='line'>redis-2212193268-a447n     1/1       Running   0          1h        192.168.0.30
</span><span class='line'>redis-2212193268-tu5fl     1/1       Running   0          1h        192.168.0.214
</span><span class='line'>
</span><span class='line'>https://kubernetes.io/docs/user-guide/jsonpath/
</span><span class='line'>[root@cu2 ~]# kubectl get pods -o wide -l run=redis -o jsonpath={..podIP}
</span><span class='line'>10.1.75.2 10.1.75.3 10.1.58.3 10.1.58.2 10.1.33.3
</span><span class='line'>
</span><span class='line'>## 登录容器
</span><span class='line'># 用ssh登录
</span><span class='line'>[root@cu2 ~]# kubectl describe pods redis-2212193268-tu5fl | grep IP
</span><span class='line'>IP:             10.1.33.3
</span><span class='line'>[root@cu2 ~]# ssh 10.1.33.3
</span><span class='line'>The authenticity of host '10.1.33.3 (10.1.33.3)' can't be established.
</span><span class='line'>RSA key fingerprint is e5:58:ae:3b:54:c9:bb:0d:4c:9b:bc:fd:04:fe:be:cc.
</span><span class='line'>Are you sure you want to continue connecting (yes/no)? yes
</span><span class='line'>Warning: Permanently added '10.1.33.3' (RSA) to the list of known hosts.
</span><span class='line'>root@10.1.33.3's password: 
</span><span class='line'>Last login: Sat Mar  4 18:17:51 2017 from 10.1.61.1
</span><span class='line'>[root@redis-2212193268-tu5fl ~]# exit
</span><span class='line'>logout
</span><span class='line'>Connection to 10.1.33.3 closed.
</span><span class='line'>
</span><span class='line'># exec登录
</span><span class='line'>[root@cu2 ~]# kubectl exec -ti redis-2212193268-tu5fl bash
</span><span class='line'>[root@redis-2212193268-tu5fl /]# 
</span><span class='line'>
</span><span class='line'>## ping五台机器全部节点的机器都是互通的
</span><span class='line'>[root@redis-2212193268-tu5fl /]# ping 10.1.75.2
</span><span class='line'>PING 10.1.75.2 (10.1.75.2) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.1.75.2: icmp_seq=1 ttl=60 time=1.15 ms
</span><span class='line'>...
</span><span class='line'>[root@redis-2212193268-tu5fl /]# ping 10.1.75.3
</span><span class='line'>PING 10.1.75.3 (10.1.75.3) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.1.75.3: icmp_seq=1 ttl=60 time=1.23 ms
</span><span class='line'>...
</span><span class='line'>[root@redis-2212193268-tu5fl /]# ping 10.1.58.3
</span><span class='line'>PING 10.1.58.3 (10.1.58.3) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.1.58.3: icmp_seq=1 ttl=60 time=1.60 ms
</span><span class='line'>...
</span><span class='line'>[root@redis-2212193268-tu5fl /]# ping 10.1.58.2
</span><span class='line'>PING 10.1.58.2 (10.1.58.2) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.1.58.2: icmp_seq=1 ttl=60 time=1.39 ms
</span><span class='line'>...
</span><span class='line'>[root@redis-2212193268-tu5fl /]# ping 10.1.33.3         
</span><span class='line'>PING 10.1.33.3 (10.1.33.3) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.1.33.3: icmp_seq=1 ttl=64 time=0.036 ms
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>全部启动好后dashboard的效果图：</p>

<p><img src="/images/blogs/k8s-dashboard.jpg" alt="" /></p>

<h2>深入学习启动脚本</h2>

<p>官网这份<a href="https://kubernetes.io/docs/getting-started-guides/scratch/#starting-cluster-services">Creating a Custom Cluster from Scratch</a> 看的糊里糊涂，真不是给入门级的我来看的。需要有一定的实践经验才能看的懂。</p>

<p>另辟蹊径，根据 docker-multi 的启动脚本来拆分学习然后模拟动手实践。</p>

<p>在根据 <a href="https://kubernetes.io/docs/getting-started-guides/docker-multinode/">Portable Multi-Node Cluster</a> 文档学习操作的时刻不理解bootstrap docker以及main docker的含义。这次通过单独运行提取每个函数运行后才明白一点了，其实就相当于跑两个docker应用程序，互相不影响。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# ps aux|grep docker
</span><span class='line'>root      5310  0.0  0.2 645128 19180 pts/1    Sl   13:14   0:01 docker -d -H unix:///var/run/docker-bootstrap.sock -p /var/run/docker-bootstrap.pid --iptables=false --ip-masq=false --bridge=none --graph=/var/lib/docker-bootstrap --exec-root=/var/run/docker-bootstrap
</span><span class='line'>root      5782  1.1  0.5 2788284 43620 pts/1   Sl   13:14   0:23 /usr/bin/docker -d --mtu=1464 --bip=10.1.33.1/24
</span><span class='line'>root     10935  0.0  0.0 103316   896 pts/1    S+   13:47   0:00 grep docker
</span></code></pre></td></tr></table></div></figure>


<p>bootstrap docker启动后，容器etcd和flannel启动都很顺利。</p>

<p>以下的问题都是在自己虚拟机操作是遇到的，解决好后再部署到测试环境。</p>

<ul>
<li>问题1： 执行docker0网卡重置失败</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@bigdata1 data]# ip link set docker0 down
</span><span class='line'>[root@bigdata1 data]# ip link del docker0
</span><span class='line'>RTNETLINK answers: Operation not supported
</span><span class='line'>
</span><span class='line'>[root@bigdata1 data]# ip addr 
</span><span class='line'>
</span><span class='line'>删不掉，但是可以修改ip地址来实现相似的效果
</span><span class='line'>
</span><span class='line'>ifconfig docker0 ${FLANNEL_SUBNET}
</span><span class='line'>或者 
</span><span class='line'>[root@bigdata1 data]# ip link set dev docker0 mtu 1460
</span><span class='line'>[root@bigdata1 data]# ip addr del 172.17.42.1/16 dev docker0
</span><span class='line'>[root@bigdata1 data]# ip addr add ${FLANNEL_SUBNET} dev docker0
</span><span class='line'>[root@bigdata1 data]# ip link set dev docker0 up
</span><span class='line'>[root@bigdata1 data]# ifconfig # 查看重新分配的IP
</span><span class='line'>
</span><span class='line'>先添加参数在前端运行
</span><span class='line'>[root@bigdata1 data]# docker -d --mtu=1472 --bip=10.1.42.1/24
</span><span class='line'>
</span><span class='line'>启动
</span><span class='line'>[root@bigdata1 data]# sed -i 's/other_args=/other_args="--mtu=1472 --bip=10.1.42.1/24"/' /etc/sysconfig/docker
</span><span class='line'>[root@bigdata1 data]# service docker start
</span><span class='line'>Starting docker:                                           [确定]
</span><span class='line'>[root@bigdata1 data]# service docker status
</span><span class='line'>docker (pid  4542) 正在运行...</span></code></pre></td></tr></table></div></figure>


<ul>
<li>问题2：volumns mount不支持shared</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@bigdata1 data]# echo $KUBELET_MOUNTS
</span><span class='line'>-v /sys:/sys:rw -v /var/run:/var/run:rw -v /run:/run:rw -v /var/lib/docker:/var/lib/docker:rw -v /var/lib/kubelet:/var/lib/kubelet:shared -v /var/log/containers:/var/log/containers:rw
</span><span class='line'>
</span><span class='line'>[root@bigdata1 data]# mkdir -p /var/lib/kubelet
</span><span class='line'>[root@bigdata1 data]# mount --bind /var/lib/kubelet /var/lib/kubelet
</span><span class='line'>[root@bigdata1 data]# mount --make-shared /var/lib/kubelet
</span><span class='line'>
</span><span class='line'>[root@bigdata1 data]# docker run -d \
</span><span class='line'>&gt;     --net=host \
</span><span class='line'>&gt;     --pid=host \
</span><span class='line'>&gt;     --privileged \
</span><span class='line'>&gt;     --name kube_kubelet_$(kube::helpers::small_sha) \
</span><span class='line'>&gt;     ${KUBELET_MOUNTS} \
</span><span class='line'>&gt;     gcr.io/google_containers/hyperkube-${ARCH}:${K8S_VERSION} \
</span><span class='line'>&gt;     /hyperkube kubelet \
</span><span class='line'>&gt;       --allow-privileged \
</span><span class='line'>&gt;       --api-servers=http://localhost:8080 \
</span><span class='line'>&gt;       --config=/etc/kubernetes/manifests-multi \
</span><span class='line'>&gt;       --cluster-dns=10.0.0.10 \
</span><span class='line'>&gt;       --cluster-domain=cluster.local \
</span><span class='line'>&gt;       ${CNI_ARGS} \
</span><span class='line'>&gt;       ${CONTAINERIZED_FLAG} \
</span><span class='line'>&gt;       --hostname-override=${IP_ADDRESS} \
</span><span class='line'>&gt;       --v=2
</span><span class='line'>Error response from daemon: invalid mode for volumes-from: shared
</span><span class='line'>
</span><span class='line'># 改成z # -- 2017-3-16 19:15:57 不支持shared，后面会遇到volume的问题！
</span><span class='line'>    KUBELET_MOUNT="-v /var/lib/kubelet:/var/lib/kubelet:z"
</span><span class='line'>  
</span><span class='line'>[root@bigdata1 ~]# echo $KUBELET_MOUNTS
</span><span class='line'>-v /sys:/sys:rw -v /var/run:/var/run:rw -v /run:/run:rw -v /var/lib/docker:/var/lib/docker:rw -v /var/lib/kubelet:/var/lib/kubelet:z -v /var/log/containers:/var/log/containers:rw</span></code></pre></td></tr></table></div></figure>


<ul>
<li>问题3：cgroup问题</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Error: failed to run Kubelet: failed to get mounted cgroup subsystems: failed to find cgroup mounts
</span><span class='line'>failed to run Kubelet: failed to get mounted cgroup subsystems: failed to find cgroup mounts
</span><span class='line'>
</span><span class='line'>centos7 
</span><span class='line'>[root@k8s docker.service.d]# ll /sys/fs/cgroup/
</span><span class='line'>blkio/            cpuacct/          cpuset/           freezer/          memory/           net_cls,net_prio/ perf_event/       systemd/          
</span><span class='line'>cpu/              cpu,cpuacct/      devices/          hugetlb/          net_cls/          net_prio/         pids/             
</span><span class='line'>
</span><span class='line'>centos6
</span><span class='line'>http://wushank.blog.51cto.com/3489095/1203545
</span><span class='line'>[root@bigdata1 bin]# ls /cgroup/
</span><span class='line'>blkio  cpu  cpuacct  cpuset  devices  freezer  memory  net_cls
</span><span class='line'>
</span><span class='line'>把/cgroup加入到卷映射路径
</span><span class='line'>  KUBELET_MOUNTS="\
</span><span class='line'>    ${ROOTFS_MOUNT} \
</span><span class='line'>    -v /sys:/sys:rw \
</span><span class='line'>    -v /cgroup:/cgroup:rw \
</span><span class='line'>    -v /var/run:/var/run:rw \
</span><span class='line'>    -v /run:/run:rw \
</span><span class='line'>    -v /var/lib/docker:/var/lib/docker:rw \
</span><span class='line'>    ${KUBELET_MOUNT} \
</span><span class='line'>    -v /var/log/containers:/var/log/containers:rw"</span></code></pre></td></tr></table></div></figure>


<ul>
<li>问题4：再说版本，v1.3+的版本在centos6上运行kubelet报错：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@bigdata1 ~]# docker logs 7a2f7aec2239
</span><span class='line'>...
</span><span class='line'>E0228 10:56:05.408129    2516 kubelet.go:2049] Container runtime sanity check failed: container runtime version is older than 1.21</span></code></pre></td></tr></table></div></figure>


<p>1.3以上的版本都会报这个错。kubernetes用1.2.7的版本即可。</p>

<ul>
<li><p>问题5：dashboard/dns配置注意点</p></li>
<li><p>imagePullPolicy 就是个坑啊！改成IfNotPresent <a href="https://kubernetes.io/docs/user-guide/images/">https://kubernetes.io/docs/user-guide/images/</a></p></li>
<li>namespace 不能改，好像会写数据库然后指定的namespace就是kube-system</li>
<li>apiserver 由于没有addon-manager的支持，暂时使用http获取数据（DNS的问题确认了很久，kube2sky容器日志有报错，修改server地址为http方式才解决）</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 docker-multinode-centos6]# docker exec -ti 193863bc646b bash
</span><span class='line'>[root@redis-2212193268-0ovu7 /]# nslookup kubernetes.default
</span><span class='line'>Server:         10.0.0.10
</span><span class='line'>Address:        10.0.0.10#53
</span><span class='line'>
</span><span class='line'>Name:   kubernetes.default.svc.cluster.local
</span><span class='line'>Address: 10.0.0.1</span></code></pre></td></tr></table></div></figure>


<p>处理完以上问题，K8S集群就跑起来了，然后整合成开始用的脚本。当然后续还有很多工作，不仅仅是怎么用，还有一些其他辅助的软件需要配置和安装。</p>

<h2>监控</h2>

<ul>
<li><a href="https://kubernetes.io/docs/user-guide/monitoring/">Resource Usage Monitoring</a></li>
<li><a href="https://github.com/kubernetes/heapster/blob/master/docs/influxdb.md">Run Heapster in a Kubernetes cluster with an InfluxDB backend and a Grafana UI</a></li>
<li><a href="http://codingwater.org/2016/08/18/Kubernetes%E9%9B%86%E7%BE%A4%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7-Heapster/">Kubernetes集群性能监控&ndash;Heapster</a></li>
<li><a href="http://www.pangxie.space/docker/727">Kubernetes部署监控(Heapster+Influxdb+Grafana)-centos7</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>可以通过4194访问cAdvisor  &lt;http://www.dockone.io/article/page-46&gt;
</span><span class='line'>http://cu2:4194/containers/
</span><span class='line'>
</span><span class='line'>[root@cu2 influxdb]# kubectl create -f ./
</span><span class='line'>deployment "monitoring-grafana" created
</span><span class='line'>service "monitoring-grafana" created
</span><span class='line'>deployment "heapster" created
</span><span class='line'>service "heapster" created
</span><span class='line'>deployment "monitoring-influxdb" created
</span><span class='line'>service "monitoring-influxdb" created
</span><span class='line'>
</span><span class='line'>[root@cu2 influxdb]# kubectl get pods --namespace=kube-system -o wide
</span><span class='line'>NAME                                    READY     STATUS             RESTARTS   AGE       NODE
</span><span class='line'>heapster-2621086088-s77cl               0/1       CrashLoopBackOff   2          37s       192.168.0.148
</span><span class='line'>kube-dns-v8-00p5h                       4/4       Running            1          5h        192.168.0.174
</span><span class='line'>kubernetes-dashboard-2845140353-l7o8o   1/1       Running            0          5h        192.168.0.30
</span><span class='line'>monitoring-grafana-1501214244-kw3im     1/1       Running            0          37s       192.168.0.148
</span><span class='line'>monitoring-influxdb-3498630124-241tx    1/1       Running            0          37s       192.168.0.30
</span><span class='line'>
</span><span class='line'>第一次启动heapster失败，定位机器查看日志
</span><span class='line'>[root@cu3 ~]# docker logs aad68dd07ff8
</span><span class='line'>I0306 09:06:25.611251       1 heapster.go:71] /heapster --source=kubernetes:https://kubernetes.default --sink=influxdb:http://monitoring-influxdb:8086
</span><span class='line'>I0306 09:06:25.611523       1 heapster.go:72] Heapster version v1.3.0-beta.1
</span><span class='line'>F0306 09:06:25.611555       1 heapster.go:174] Failed to create source provide: open /var/run/secrets/kubernetes.io/serviceaccount/token: no such file or directory
</span><span class='line'>
</span><span class='line'>https://github.com/kubernetes/heapster/blob/master/docs/source-configuration.md 改成http
</span><span class='line'>
</span><span class='line'>重新加载
</span><span class='line'>[root@cu2 influxdb]# for file in * ; do sed -e "s|MASTER_IP|${IP_ADDRESS}|g" $file | kubectl apply -f - ; done
</span><span class='line'>deployment "monitoring-grafana" configured
</span><span class='line'>service "monitoring-grafana" configured
</span><span class='line'>deployment "heapster" configured
</span><span class='line'>service "heapster" configured
</span><span class='line'>deployment "monitoring-influxdb" configured
</span><span class='line'>service "monitoring-influxdb" configured
</span><span class='line'>
</span><span class='line'>[root@cu2 influxdb]# kubectl get service --namespace=kube-system -o wide
</span><span class='line'>NAME                   CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE       SELECTOR
</span><span class='line'>heapster               10.0.0.54    &lt;none&gt;        80/TCP          8m        k8s-app=heapster
</span><span class='line'>kube-dns               10.0.0.10    &lt;none&gt;        53/UDP,53/TCP   6h        k8s-app=kube-dns
</span><span class='line'>kubernetes-dashboard   10.0.0.181   nodes         80/TCP          6h        app=kubernetes-dashboard
</span><span class='line'>monitoring-grafana     10.0.0.220   &lt;none&gt;        80/TCP          8m        k8s-app=grafana
</span><span class='line'>monitoring-influxdb    10.0.0.223   &lt;none&gt;        8086/TCP        8m        k8s-app=influxdb
</span><span class='line'>
</span><span class='line'>浏览器访问grafana 登录：admin/admin
</span><span class='line'>http://10.0.0.220/
</span></code></pre></td></tr></table></div></figure>


<p>安装好监控后，dashboard也有图标了。</p>

<p><img src="/images/blogs/k8s-dashboard-pro.jpg" alt="" /></p>

<h4>某机器数据不显示问题定位</h4>

<p>原来是三台机器的，后面增加了148的机器进来。添加heapster监控后，就148机器图形显示不出来。并且dashboard的 148 Node 页面的 <strong> Conditions - Last heartbeat time </strong> 没显示内容。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# kubectl get services --all-namespaces
</span><span class='line'>NAMESPACE     NAME                   CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE
</span><span class='line'>default       kubernetes             10.0.0.1     &lt;none&gt;        443/TCP         1d
</span><span class='line'>kube-system   heapster               10.0.0.196   &lt;none&gt;        80/TCP          12m
</span><span class='line'>kube-system   kube-dns               10.0.0.10    &lt;none&gt;        53/UDP,53/TCP   21h
</span><span class='line'>kube-system   kubernetes-dashboard   10.0.0.181   nodes         80/TCP          21h
</span><span class='line'>kube-system   monitoring-grafana     10.0.0.215   &lt;none&gt;        80/TCP          12m
</span><span class='line'>kube-system   monitoring-influxdb    10.0.0.226   &lt;none&gt;        8086/TCP        12m
</span><span class='line'>
</span><span class='line'>查看接口
</span><span class='line'>https://github.com/kubernetes/heapster/blob/master/docs/debugging.md
</span><span class='line'>
</span><span class='line'>  http://10.0.0.196/metrics
</span><span class='line'>
</span><span class='line'>  这里没有148机器的key
</span><span class='line'>  http://10.0.0.196/api/v1/model/debug/allkeys
</span><span class='line'>
</span><span class='line'>  http://192.168.0.30:10255/stats/container/
</span><span class='line'>
</span><span class='line'>https://github.com/kubernetes/heapster/blob/master/docs/sink-configuration.md
</span><span class='line'>
</span><span class='line'>等到heapster机器运行命令，改下端口，日志输出详细点
</span><span class='line'>/ # /heapster --source=kubernetes:http://192.168.0.214:8080?inClusterConfig=false --sink=log --heapster-port=8083 -v 10
</span><span class='line'>
</span><span class='line'>  http://192.168.0.214:8080/api/v1/nodes
</span><span class='line'>  Node
</span><span class='line'>  Pod
</span><span class='line'>  Namespace
</span><span class='line'>  </span></code></pre></td></tr></table></div></figure>


<p>148机器的10255和4194端口都正常运行，heapster从148也获取到数据了。但是最后log输出的时刻没有148机器。系统时间？抱着尝试的心态改了一下，148的机器快了几分钟。</p>

<p>果不其然啊！！同步时间后监控图就显示出来了。</p>

<h2>后续学习操作</h2>

<ul>
<li>安全HTTPS <a href="https://kubernetes.io/docs/admin/authentication/#creating-certificates">https://kubernetes.io/docs/admin/authentication/#creating-certificates</a></li>
<li>register <a href="http://www.pangxie.space/docker/643">http://www.pangxie.space/docker/643</a> k8s版本旧的话很麻烦</li>
<li><a href="https://kubernetes.io/docs/tasks/">https://kubernetes.io/docs/tasks/</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/release-1.2/examples/redis/redis-controller.yaml">https://github.com/kubernetes/kubernetes/blob/release-1.2/examples/redis/redis-controller.yaml</a></li>
</ul>


<p>阿里云的镜像加速还是很赞的，由于我域名是在万网注册的本来就有账号，登录就能看到加速的地址，非常的方便。科技大学的加速镜像也很赞！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu1 ~]# cat /etc/sysconfig/docker
</span><span class='line'>...
</span><span class='line'>#other_args=" --registry-mirror=https://us69kjun.mirror.aliyuncs.com "
</span><span class='line'>other_args=" --registry-mirror=https://docker.mirrors.ustc.edu.cn "
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>有趣的命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://kubernetes.io/docs/user-guide/jsonpath/
</span><span class='line'>[root@cu2 ~]# kubectl get pods -o wide -l run=redis -o jsonpath={..podIP}
</span><span class='line'>10.1.75.2 10.1.75.3 10.1.58.3 10.1.58.2 10.1.33.3
</span><span class='line'>
</span><span class='line'>修改启动entry，以及网络共用
</span><span class='line'>docker run -ti --entrypoint=sh --net=container:8e9f21956469f4ef7e5b9d91798788ab83f380795d2825cdacae0ed28f5ba03b gcr.io/google_containers/skydns-amd64:1.0
</span><span class='line'>
</span><span class='line'>https://kubernetes.io/docs/tasks/kubectl/list-all-running-container-images/
</span><span class='line'>[root@cu2 ~]# kubectl get pods --all-namespaces -o jsonpath="{..image}" |\
</span><span class='line'>&gt; tr -s '[[:space:]]' '\n' |\
</span><span class='line'>&gt; sort |\
</span><span class='line'>&gt; uniq -c
</span><span class='line'>      2 gcr.io/google_containers/etcd-amd64:2.2.5
</span><span class='line'>      2 gcr.io/google_containers/exechealthz-amd64:1.0
</span><span class='line'>      2 gcr.io/google_containers/heapster-amd64:v1.3.0-beta.1
</span><span class='line'>      2 gcr.io/google_containers/heapster-grafana-amd64:v4.0.2
</span><span class='line'>      2 gcr.io/google_containers/heapster-influxdb-amd64:v1.1.1
</span><span class='line'>     10 gcr.io/google_containers/hyperkube-amd64:v1.2.7
</span><span class='line'>      2 gcr.io/google_containers/kube2sky-amd64:1.15
</span><span class='line'>      2 gcr.io/google_containers/kubernetes-dashboard-amd64:v1.5.1
</span><span class='line'>      2 gcr.io/google_containers/skydns-amd64:1.0
</span><span class='line'>      2 redis:3.2.8
</span><span class='line'>
</span><span class='line'>kubectl get pods --all-namespaces -o jsonpath="{.items[*].spec.containers[*].image}"
</span><span class='line'>
</span><span class='line'>[root@cu2 ~]# export POD_COL="custom-columns=NAME:.metadata.name,RESTARTS:.status.containerStatuses[*].restartCount,CONTAINERS:.spec.containers[*].name,IP:.status.podIP,HOST:.spec.nodeName"
</span><span class='line'>[root@cu2 ~]# kubectl get pods -o $POD_COL 
</span><span class='line'>
</span><span class='line'># 加label
</span><span class='line'>[root@cu2 ~]# cat /etc/hosts | grep -E "\scu[0-9]\s" | awk '{print "kubectl label nodes "$1" hostname="$2}' | while read line ; do sh -c "$line" ; done
</span><span class='line'>
</span><span class='line'>[root@cu2 kubernetes]# kubectl run redis --image=redis:3.2.8 
</span><span class='line'>[root@cu2 kubernetes]# kubectl scale --replicas=9 deployment/redis</span></code></pre></td></tr></table></div></figure>


<h2>其他参考</h2>

<p>纯手动安装，所有应用都作为服务启动
* <a href="http://chenguomin.blog.51cto.com/8794192/1828905">http://chenguomin.blog.51cto.com/8794192/1828905</a> 网络使用flannel、DNS的安装配置
* <a href="http://www.pangxie.space/docker/618">http://www.pangxie.space/docker/618</a>
* <a href="https://xuxinkun.github.io/2016/03/27/k8s-service/">https://xuxinkun.github.io/2016/03/27/k8s-service/</a> service是在防火墙做的跳转 => iptables -S -t nat</p>

<p>介绍
* <a href="http://www.infoq.com/cn/articles/kubernetes-and-cloud-native-applications-part01">http://www.infoq.com/cn/articles/kubernetes-and-cloud-native-applications-part01</a>
* <a href="http://www.codingwater.org/2016/08/25/Docker-Kubernetes-Intro/">http://www.codingwater.org/2016/08/25/Docker-Kubernetes-Intro/</a>
* <a href="https://github.com/kubernetes/kubernetes/tree/v1.0.1/cluster/addons/dns">https://github.com/kubernetes/kubernetes/tree/v1.0.1/cluster/addons/dns</a></p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/12">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/10">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>
  <h1><a class='category' href='/blog/categories/recommend/'>Recommend</a></h1>
	<ul role="list">
		
			<li class="post">
				<a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/08/25/video-auto-translate/">视频自动翻译</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/06/09/reasonable-way-to-access-the-internet/">科学上网（续）</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/01/20/gitalk-on-octopress/">Gitalk on Octopress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/11/16/sphinx-generate-docs/">使用Sphinx生成/管理文档</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/10/30/windows-run-ubuntu/">Windows Run Ubuntu</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/30/kubeadm-install-kubenetes-on-centos7/">Kubeadm部署kubernetes</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/08/casperjs-crawler/">爬虫之CasperJS</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/05/23/spark-on-hive-speculation-shit-bug/">Hive on Spark预测性执行BUG一枚</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/27/vnc-server-on-centos7/">在Centos7上安装VNC Server</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/25/develop-environment-prepare/">[整理] 环境准备工具集</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/19/nginx-https/">Nginx配置https</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/09/19/163-open-movies-download/">批量下载163-open的视频</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/23/hadoop-guide-catalog/">[整理] Hadoop入门</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/04/rpm-build-your-package/">RPM打包</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/03/28/hive-on-spark/">Hive on Spark</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/11/22/gfw-ladder/">搭梯笔记</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/08/24/manual-install-supervisor/">Supervisor安装配置</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/10/16/spark-build-and-configuration/">编译/搭建Spark环境</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/08/25/step-by-step-found-java-oom-error/">查找逐步定位Java程序OOM的异常实践</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/30/hadoop2-snappy-compress/">Hadoop2 Snappy Compress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/27/start-redis/">[读读书]Redis入门指南</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/04/21/hadoop2-windows-startguide/">Windows下部署/配置/调试hadoop2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/30/git-cheatsheet/">GIT操作记录手册</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/18/jekyll-edit-link-in-web-page/">Jekyll页面添加编辑按钮</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/02/23/quickly-open-program-in-windows/">[Windows运行]快速打开程序</a>
			</li>
		
			<li class="post">
				<a href="/blog/2013/09/19/let-shell-command-efficient/">让敲Shell命令高效起来</a>
			</li>
		
	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2021/12/08/recommand-blogs/">推崇的博客</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/09/15/k2-again/">斐讯K2刷机padavan</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/05/11/redmine-on-arm-pi/">在树莓派上部署redmine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/12/appium-android-auto-test/">appium-Android自动化测试</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/26/android-linux-via-termux/">Android Linux via Termux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/10/try-bk-dot-tencent-dot-com/">Try bk.tencent.com</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/20/jcef-build-on-win64/">编译JCEF - Win64</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/0/'>0</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/alluxio/'>alluxio</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/android/'>android</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/bigdata/'>bigdata</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blabla/'>blabla</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/debug/'>debug</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/deprecated/'>deprecated</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/devops/'>devops</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/es/'>es</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/flume/'>flume</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/git/'>git</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (44) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hbase/'>hbase</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hole/'>hole</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jenkins/'>jenkins</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k2/'>k2</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (9) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kafka/'>kafka</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kubeadm/'>kubeadm</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/logstash/'>logstash</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/map/'>map</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/recommend/'>recommend</a> (27) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/shell/'>shell</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/staf/'>staf</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tachyon/'>tachyon</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tez/'>tez</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tools/'>tools</a> (69) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/topics/'>topics</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/vagrant/'>vagrant</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/wsl/'>wsl</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/zookeeper/'>zookeeper</a> (1) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (218)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<!--
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
&#8211;>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1253103971'%3E%3C/span%3E%3Cscript src='https://s19.cnzz.com/z_stat.php%3Fid%3D1253103971%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winse.github.io" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>









</body>
</html>
