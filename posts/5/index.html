
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="新版本ES5和原来的有写不同，head等一些插件不能直接安装，需要单独起一个程序然后通过ajax的方式获取数据。 下载 elasticsearch-5.1.1 ，修改配置 network.host: cu-ud1 ，然后启动服务 bin/elasticsearch -d 。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winseliu.com/posts/5">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43198550-1', 'auto');
  ga('send', 'pageview');

</script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停, 熙熙攘攘, 忙忙碌碌, 不知何畏.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winseliu.com" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
  <li><a href="https://yunpan.cn/cuYhpFBPgQYgT" >Books[5aee]</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/14/elasticsearch5-head-plugin-config/">elasticsearch5安装Head插件</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-12-14T12:16:39+00:00" pubdate data-updated="true">Wed 2016-12-14 12:16</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>新版本ES5和原来的有写不同，head等一些插件不能直接安装，需要单独起一个程序然后通过ajax的方式获取数据。</p>

<p>下载 elasticsearch-5.1.1 ，修改配置 <strong> network.host: cu-ud1 </strong>，然后启动服务 bin/elasticsearch -d 。</p>

<p>Head插件安装相对比较麻烦。在windows一些插件安装不了，现在能上外网的Linux下载依赖，然后把全部的包复制到生产环境。最后配置并启动head服务。</p>

<ul>
<li><a href="https://github.com/mobz/elasticsearch-head#running-with-built-in-server">https://github.com/mobz/elasticsearch-head#running-with-built-in-server</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 elasticsearch-head]$ npm install
</span><span class='line'>
</span><span class='line'>[ud@cu-ud1 ~]$ xz -d node-v6.9.2-linux-x64.tar.xz 
</span><span class='line'>[ud@cu-ud1 ~]$ tar xvf node-v6.9.2-linux-x64.tar 
</span><span class='line'>[ud@cu-ud1 node-v6.9.2-linux-x64]$ vi ~/.bash_profile 
</span><span class='line'>...
</span><span class='line'>NODE_HOME=/home/ud/node-v6.9.2-linux-x64
</span><span class='line'>PATH=$NODE_HOME/bin:$PATH
</span><span class='line'>export PATH
</span><span class='line'>
</span><span class='line'>[ud@cu-ud1 ~]$ tar zxvf elasticsearch-head-standalone.tar.gz 
</span><span class='line'>
</span><span class='line'>[ud@cu-ud1 elasticsearch-5.1.1]$ vi config/elasticsearch.yml 
</span><span class='line'>...
</span><span class='line'>http.cors.enabled: true
</span><span class='line'>http.cors.allow-origin: "*"
</span><span class='line'>
</span><span class='line'>[ud@cu-ud1 elasticsearch-head]$ node_modules/grunt/bin/grunt server
</span></code></pre></td></tr></table></div></figure>


<p>然后浏览器访问9100端口即可。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/09/spark2-0-kafka0-10-1-partitions-work-incorrent/">Spark2-0 & Kafka0-10-1订阅多个单只读一个分区</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-12-09T04:02:38+00:00" pubdate data-updated="true">Fri 2016-12-09 04:02</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>同事在使用Spark-Kafka-Streaming的时刻遇到只能读取一个分区的情况，最后他找到问题所在。这里记录下，说白了就是Spark-2.0.0默认是用Kafka-0.10.0.1，自己换程序版本有风险！</p>

<h2>问题的关键点</h2>

<ul>
<li>Kafka-0.10.1.0</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org/apache/kafka/clients/consumer/KafkaConsumer.java
</span><span class='line'>    private void updateFetchPositions(Set&lt;TopicPartition&gt; partitions) {
</span><span class='line'>        // lookup any positions for partitions which are awaiting reset (which may be the
</span><span class='line'>        // case if the user called seekToBeginning or seekToEnd. We do this check first to
</span><span class='line'>        // avoid an unnecessary lookup of committed offsets (which typically occurs when
</span><span class='line'>        // the user is manually assigning partitions and managing their own offsets).
</span><span class='line'>        fetcher.resetOffsetsIfNeeded(partitions);
</span><span class='line'>
</span><span class='line'>        if (!subscriptions.hasAllFetchPositions()) {
</span><span class='line'>            // if we still don't have offsets for all partitions, then we should either seek
</span><span class='line'>            // to the last committed position or reset using the auto reset policy
</span><span class='line'>
</span><span class='line'>            // first refresh commits for all assigned partitions
</span><span class='line'>            coordinator.refreshCommittedOffsetsIfNeeded();
</span><span class='line'>
</span><span class='line'>            // then do any offset lookups in case some positions are not known
</span><span class='line'>            fetcher.updateFetchPositions(partitions);
</span><span class='line'>        }
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Kafka-0.10.0.1</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org.apache.kafka.clients.consumer.KafkaConsumer#updateFetchPositions
</span><span class='line'>    private void updateFetchPositions(Set&lt;TopicPartition&gt; partitions) {
</span><span class='line'>        // refresh commits for all assigned partitions
</span><span class='line'>        coordinator.refreshCommittedOffsetsIfNeeded();
</span><span class='line'>
</span><span class='line'>        // then do any offset lookups in case some positions are not known
</span><span class='line'>        fetcher.updateFetchPositions(partitions);
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<h2>问题描述以及说明</h2>

<p>当订阅同一个主题的多个分区时，每次SparkStreaming会获取每次处理的Offset。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org.apache.spark.streaming.kafka010.DirectKafkaInputDStream#latestOffsets
</span><span class='line'>  protected def latestOffsets(): Map[TopicPartition, Long] = {
</span><span class='line'>    val c = consumer
</span><span class='line'>    c.poll(0)
</span><span class='line'>    val parts = c.assignment().asScala
</span><span class='line'>
</span><span class='line'>    // make sure new partitions are reflected in currentOffsets
</span><span class='line'>    val newPartitions = parts.diff(currentOffsets.keySet)
</span><span class='line'>    // position for new partitions determined by auto.offset.reset if no commit
</span><span class='line'>    currentOffsets = currentOffsets ++ newPartitions.map(tp =&gt; tp -&gt; c.position(tp)).toMap
</span><span class='line'>    // don't want to consume messages, so pause
</span><span class='line'>    c.pause(newPartitions.asJava)
</span><span class='line'>    // find latest available offsets
</span><span class='line'>    c.seekToEnd(currentOffsets.keySet.asJava)
</span><span class='line'>    parts.map(tp =&gt; tp -&gt; c.position(tp)).toMap
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  override def compute(validTime: Time): Option[KafkaRDD[K, V]] = {
</span><span class='line'>    val untilOffsets = clamp(latestOffsets())
</span><span class='line'>    val offsetRanges = untilOffsets.map { case (tp, uo) =&gt;
</span><span class='line'>      val fo = currentOffsets(tp)
</span><span class='line'>      OffsetRange(tp.topic, tp.partition, fo, uo)
</span><span class='line'>    }
</span><span class='line'>    val rdd = new KafkaRDD[K, V](
</span><span class='line'>      context.sparkContext, executorKafkaParams, offsetRanges.toArray, getPreferredHosts, true)
</span><span class='line'>... </span></code></pre></td></tr></table></div></figure>


<p>如果使用kafka-0.10.1.0时，seekToEnd会重置当前客户端分区实例的position为null。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org.apache.kafka.clients.consumer.KafkaConsumer#seekToEnd
</span><span class='line'>    public void seekToEnd(Collection&lt;TopicPartition&gt; partitions) {
</span><span class='line'>        acquire();
</span><span class='line'>        try {
</span><span class='line'>            Collection&lt;TopicPartition&gt; parts = partitions.size() == 0 ? this.subscriptions.assignedPartitions() : partitions;
</span><span class='line'>            for (TopicPartition tp : parts) {
</span><span class='line'>                log.debug("Seeking to end of partition {}", tp);
</span><span class='line'>                subscriptions.needOffsetReset(tp, OffsetResetStrategy.LATEST);
</span><span class='line'>            }
</span><span class='line'>        } finally {
</span><span class='line'>            release();
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>org.apache.kafka.clients.consumer.internals.SubscriptionState#needOffsetReset(TopicPartition, OffsetResetStrategy)
</span><span class='line'>    public void needOffsetReset(TopicPartition partition, OffsetResetStrategy offsetResetStrategy) {
</span><span class='line'>        assignedState(partition).awaitReset(offsetResetStrategy);
</span><span class='line'>    } 
</span><span class='line'>org.apache.kafka.clients.consumer.internals.SubscriptionState.TopicPartitionState#awaitReset
</span><span class='line'>        private void awaitReset(OffsetResetStrategy strategy) {
</span><span class='line'>            this.resetStrategy = strategy;
</span><span class='line'>            this.position = null;
</span><span class='line'>        }</span></code></pre></td></tr></table></div></figure>


<p>此时再调用position一个个分区的获取最新位置信息。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org.apache.kafka.clients.consumer.KafkaConsumer#position
</span><span class='line'>    public long position(TopicPartition partition) {
</span><span class='line'>        acquire();
</span><span class='line'>        try {
</span><span class='line'>            if (!this.subscriptions.isAssigned(partition))
</span><span class='line'>                throw new IllegalArgumentException("You can only check the position for partitions assigned to this consumer.");
</span><span class='line'>            Long offset = this.subscriptions.position(partition);
</span><span class='line'>            if (offset == null) {
</span><span class='line'>                updateFetchPositions(Collections.singleton(partition));
</span><span class='line'>                offset = this.subscriptions.position(partition);
</span><span class='line'>            }
</span><span class='line'>            return offset;
</span><span class='line'>        } finally {
</span><span class='line'>            release();
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private void updateFetchPositions(Set&lt;TopicPartition&gt; partitions) {
</span><span class='line'>        // lookup any positions for partitions which are awaiting reset (which may be the
</span><span class='line'>        // case if the user called seekToBeginning or seekToEnd. We do this check first to
</span><span class='line'>        // avoid an unnecessary lookup of committed offsets (which typically occurs when
</span><span class='line'>        // the user is manually assigning partitions and managing their own offsets).
</span><span class='line'>        fetcher.resetOffsetsIfNeeded(partitions);
</span><span class='line'>
</span><span class='line'>        if (!subscriptions.hasAllFetchPositions()) {
</span><span class='line'>            // if we still don't have offsets for all partitions, then we should either seek
</span><span class='line'>            // to the last committed position or reset using the auto reset policy
</span><span class='line'>
</span><span class='line'>            // first refresh commits for all assigned partitions
</span><span class='line'>            coordinator.refreshCommittedOffsetsIfNeeded();
</span><span class='line'>
</span><span class='line'>            // then do any offset lookups in case some positions are not known
</span><span class='line'>            fetcher.updateFetchPositions(partitions);
</span><span class='line'>        }
</span><span class='line'>    } 
</span><span class='line'>
</span><span class='line'>org.apache.kafka.clients.consumer.internals.Fetcher#resetOffsetsIfNeeded
</span><span class='line'>    public void resetOffsetsIfNeeded(Set&lt;TopicPartition&gt; partitions) {
</span><span class='line'>        for (TopicPartition tp : partitions) {
</span><span class='line'>            // TODO: If there are several offsets to reset, we could submit offset requests in parallel
</span><span class='line'>            if (subscriptions.isAssigned(tp) && subscriptions.isOffsetResetNeeded(tp))
</span><span class='line'>                resetOffset(tp);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>org.apache.kafka.clients.consumer.internals.SubscriptionState.TopicPartitionState#seek
</span><span class='line'>        private void seek(long offset) {
</span><span class='line'>            this.position = offset;
</span><span class='line'>            this.resetStrategy = null;
</span><span class='line'>        } </span></code></pre></td></tr></table></div></figure>


<p>新版本KafkaConsumer先更新位置，最终调用seek设置position以及重置resetStrategy。</p>

<p>但是后面又额外多了一个判断！！检测所有的分区，只要有一个有问题就重新获取position，最对有问题啊！尽管后面又调用updateFetchPositions但是环境已经变了啊！！导致多个分区的情况下只能读取一个分区的数据。</p>

<p>问题找到了，直接客户端用旧的就行了。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/01/jasperreports-brief-summary/">Jasperreports使用小结</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-12-01T04:04:32+00:00" pubdate data-updated="true">Thu 2016-12-01 04:04</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近接了一个报表的任务，原来也有接触过，但是仅限于了解没有真正的动手画过。这里把从选型到最后成型一路下来遇到的问题整理下。</p>

<p>主要两个大问题：环境的搭建，以及子报表(嵌套报表)的配置。</p>

<h2>选择Jasperreports</h2>

<p>知道的有Birts、Pentaho、FineReport感觉其实都差不多，大家各自都取长补当更多。由于一穷二白的，没有弄过。网上找了和SpringMVC结合的都是Jasperreport的文章，就这么草率的定下来了。</p>

<p>基本的操作都类似，报表HelloWorld还是比较简单的。下载<a href="http://community.jaspersoft.com/project/jaspersoft-studio">jaspersoftstudio</a>最新版，然后了解各个区域的作用。</p>

<ul>
<li><a href="http://www.lai18.com/content/9047924.html">JasperReport入门</a></li>
<li><a href="http://blog.csdn.net/bryanliu1982/article/details/598176">JasperReport Tutorial（翻译）</a></li>
</ul>


<blockquote><p>一个完全的报表模板包括如下几个区域：title, pageHeader, columnHeader, groupHeader, detail, groupFooter, columnFoter, pageFooter, summary</p></blockquote>

<h2>整合SpringMVC</h2>

<p>原来做报表的同时都是直接连数据库的，过程中遇到各种问题。很多没法维护的事情发生：改个字段，数据库测试/生产链接等等。我这里直接选择通过JavaBean来传递数据。</p>

<ul>
<li>*<a href="http://blog.csdn.net/hwt_211/article/details/19904333">SpringMVC整合jasperreport做报表</a></li>
<li><a href="http://www.javacoder.cn/?p=188">Spring MVC中使用JasperReport</a></li>
<li><a href="http://zzc1684.iteye.com/blog/2189000">SpringMVC与iReport(JasperReports) 5.6整合开发实例</a></li>
</ul>


<p>贴代码之前先说PDF报表字体的问题，本来报表是加粗的，但是服务器生成浏览的时刻没有效果。发现还需要单独添加字体的包：<a href="http://stackoverflow.com/questions/25977427/bold-not-working-in-jaspersoft-studio-for-fonts-other-than-sans-serif">pdf - Bold not working in Jaspersoft Studio for fonts other than sans serif</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#maven
</span><span class='line'>&lt;properties&gt;
</span><span class='line'>      &lt;spring.version&gt;4.2.5.RELEASE&lt;/spring.version&gt;
</span><span class='line'>...
</span><span class='line'>      &lt;dependency&gt;
</span><span class='line'>          &lt;groupId&gt;net.sf.jasperreports&lt;/groupId&gt;
</span><span class='line'>          &lt;artifactId&gt;jasperreports&lt;/artifactId&gt;
</span><span class='line'>          &lt;version&gt;6.3.1&lt;/version&gt;
</span><span class='line'>      &lt;/dependency&gt;
</span><span class='line'>      &lt;dependency&gt;
</span><span class='line'>          &lt;groupId&gt;net.sf.jasperreports&lt;/groupId&gt;
</span><span class='line'>          &lt;artifactId&gt;jasperreports-fonts&lt;/artifactId&gt;
</span><span class='line'>          &lt;version&gt;6.0.0&lt;/version&gt;
</span><span class='line'>      &lt;/dependency&gt;
</span><span class='line'>      &lt;dependency&gt;
</span><span class='line'>          &lt;groupId&gt;com.itextpdf&lt;/groupId&gt;
</span><span class='line'>          &lt;artifactId&gt;itextpdf&lt;/artifactId&gt;
</span><span class='line'>          &lt;version&gt;5.5.10&lt;/version&gt;
</span><span class='line'>      &lt;/dependency&gt;
</span><span class='line'>      &lt;dependency&gt;
</span><span class='line'>          &lt;groupId&gt;com.itextpdf&lt;/groupId&gt;
</span><span class='line'>          &lt;artifactId&gt;itext-asian&lt;/artifactId&gt;
</span><span class='line'>          &lt;version&gt;5.2.0&lt;/version&gt;
</span><span class='line'>      &lt;/dependency&gt;
</span><span class='line'>      &lt;dependency&gt;
</span><span class='line'>          &lt;groupId&gt;org.codehaus.groovy&lt;/groupId&gt;
</span><span class='line'>          &lt;artifactId&gt;groovy-all&lt;/artifactId&gt;
</span><span class='line'>          &lt;version&gt;2.4.7&lt;/version&gt;
</span><span class='line'>      &lt;/dependency&gt;
</span><span class='line'>
</span><span class='line'># spring mvc xml
</span><span class='line'>  &lt;bean id="viewResolver" class="org.springframework.web.servlet.view.ResourceBundleViewResolver"&gt;
</span><span class='line'>      &lt;property name="order" value="0"&gt;&lt;/property&gt;
</span><span class='line'>      &lt;property name="basename" value="views"&gt;&lt;/property&gt;
</span><span class='line'>  &lt;/bean&gt;
</span><span class='line'>  &lt;bean class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;
</span><span class='line'>      &lt;property name="order" value="1"&gt;&lt;/property&gt;
</span><span class='line'>      &lt;property name="viewClass"&gt;
</span><span class='line'>          &lt;value&gt;org.springframework.web.servlet.view.JstlView&lt;/value&gt;
</span><span class='line'>      &lt;/property&gt;
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'># views.properties
</span><span class='line'>HELLO.(class)=org.springframework.web.servlet.view.jasperreports.JasperReportsPdfView 
</span><span class='line'>HELLO.url=/WEB-INF/report/helloworld.jasper
</span><span class='line'>HELLO.reportDataKey=datasource
</span><span class='line'>
</span><span class='line'># java Controller
</span><span class='line'>@Controller
</span><span class='line'>@RequestMapping("/report")
</span><span class='line'>public class HelloReportController {
</span><span class='line'>
</span><span class='line'>  @RequestMapping("/hello.pdf")
</span><span class='line'>  public ModelAndView printExpress() {
</span><span class='line'>      ModelAndView mv = new ModelAndView("HELLO");
</span><span class='line'>
</span><span class='line'>      // 如果直接传对象bean不行，需要使用list传值
</span><span class='line'>      List&lt;HelloWorldData&gt; list = new ArrayList&lt;&gt;();
</span><span class='line'>      list.add(new HelloWorldData("jarperreport", "Hi"));
</span><span class='line'>
</span><span class='line'>      mv.addObject("datasource", list);
</span><span class='line'>      return mv;
</span><span class='line'>  }
</span></code></pre></td></tr></table></div></figure>


<p>最后通过浏览器就能查看报表的PDF文件了。</p>

<p>前端所有的页面都是通过ajax来获取展示的，这里通过jquery-media.js来进行展示（生成内嵌的iframe），这也是上面的地址加上pdf后缀的原因。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># html
</span><span class='line'>&lt;div class="modal-body" style="max-height: 900px; padding: 10px;"&gt;
</span><span class='line'>  &lt;a class="media" href="${contextPath}${url}"&gt;&lt;/a&gt;
</span><span class='line'>&lt;/div&gt;
</span><span class='line'>
</span><span class='line'># jquery
</span><span class='line'>$('a.media', $modal).media({width:"100%", height:600});</span></code></pre></td></tr></table></div></figure>


<h2>子报表</h2>

<p>有一个结账的报表，既要展示汇总信息，还得把详情列表也输出出来。一开始的JavaBean：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class InvoiceData {
</span><span class='line'>  private String roomNo;
</span><span class='line'>  private List&lt;InvoiceDetailData&gt; details;
</span><span class='line'>  ...
</span><span class='line'>}
</span><span class='line'>public class InvoiceDetailData {
</span><span class='line'>  private String date;
</span><span class='line'>  private String amount;
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>但是简单报表是一维的，不能展示list里面的内容。网上一堆资料都是简单的案例，涉及多维度的就Table、Crosstable、Subreport这几个控件。Table的样式调起来麻烦，数据也不知道怎么搞。子报表至少看起来合乎逻辑，操作起来也简单。画好图标以及把对应的字段对应好后，子报表的Datasource直接填 <code>$F{details}</code> 。</p>

<p>修改views.properties，写好controller后，启动竟然报<strong>找不到details子报表</strong>路径。根据文章修改如下：</p>

<ul>
<li>*<a href="http://docs.spring.io/autorepo/docs/spring-framework/3.0.0.M3/reference/html/ch17s07.html">Working with Sub-Reports</a></li>
<li><a href="https://www.tutorialspoint.com/jasper_reports/jasper_create_subreports.htm">Create SubReports</a></li>
<li>*<a href="http://it.zhaozhao.info/archives/5581">在 Spring MVC 3.1.2.RELEASE 产出 JasperReports 4.7.1 子报表（Subreport）</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 主报表
</span><span class='line'># 类型必须加哦！
</span><span class='line'>  &lt;parameter name="DetailSubReport" class="net.sf.jasperreports.engine.JasperReport"/&gt;
</span><span class='line'>  ...
</span><span class='line'>  &lt;subreport&gt;
</span><span class='line'>      &lt;reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="520" height="167" uuid="8d69d85b-4fcf-482a-836c-c1698ce42dcd"/&gt;
</span><span class='line'>      &lt;dataSourceExpression&gt;&lt;![CDATA[$F{details}]]&gt;&lt;/dataSourceExpression&gt;
</span><span class='line'>      &lt;subreportExpression&gt;&lt;![CDATA[$P{DetailSubReport}]]&gt;&lt;/subreportExpression&gt;
</span><span class='line'>  &lt;/subreport&gt;
</span><span class='line'>  
</span><span class='line'># views.properties
</span><span class='line'>Invoice.(class)=org.springframework.web.servlet.view.jasperreports.JasperReportsPdfView 
</span><span class='line'>Invoice.url=/WEB-INF/report/invoice.jasper
</span><span class='line'>Invoice.reportDataKey=datasource
</span><span class='line'>Invoice.subReportUrls=DetailSubReport=/WEB-INF/report/InvoiceDetail.jasper</span></code></pre></td></tr></table></div></figure>


<p>罗马建成非一日之功，再次编译启动后，再次报错，这次的是<strong>类型错误</strong>。感觉正在慢慢向成功靠近。修改类型后最后启动展示搞定。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># javabean
</span><span class='line'>public class InvoiceData {
</span><span class='line'>  private JRDataSource details;
</span><span class='line'>  
</span><span class='line'>  public void setDetails(JRDataSource details) {
</span><span class='line'>      this.details = details;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  public void setDetails(List&lt;InvoiceDetailData&gt; details) {
</span><span class='line'>      this.details = new JRBeanCollectionDataSource(details);
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'># 主报表
</span><span class='line'>  &lt;field name="details" class="net.sf.jasperreports.engine.JRDataSource"&gt;
</span><span class='line'>      &lt;fieldDescription&gt;&lt;![CDATA[details]]&gt;&lt;/fieldDescription&gt;
</span><span class='line'>  &lt;/field&gt;</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/10/play2-development-environment-with-eclipse/">Play2开发环境搭建</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-11-10T03:56:07+00:00" pubdate data-updated="true">Thu 2016-11-10 03:56</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>用惯了MAVEN后，在用SBT真有种生不如死的感觉。Maven更沉稳成熟些，SBT感觉首先不熟（入门也没maven简单）并且随性。</p>

<p>好了抱怨了这么多。入题，主要碰到的就是两个问题：</p>

<ol>
<li>Play2的HelloWorld主要卡在网络（也就是sbt的配置）；</li>
<li>导入Eclipse。由于有Maven缺各种插件的体验，这里直接用官网的生成好.class/.project再导入已经存在的项目。</li>
</ol>


<p>接下来一步步的介绍环境的搭建。</p>

<h4>下载Play2和SBT</h4>

<p>下载官网的<a href="https://playframework.com/download">Offline Distribution</a> ,解压后把 <code>activator-dist-1.3.12/repository</code> 的所有文件拷贝到 <code>~/.ivy2/cache</code> 。反正都会下载到这个目录，拷贝更快。</p>

<p>下载<a href="http://www.scala-sbt.org/download.html">SBT</a> ,下载zip就好。</p>

<h4>配置</h4>

<ol>
<li>在 activator-dist-1.3.12 创建 conf/sbtconfig.txt 。同时在 sbt/conf/sbtconfig.txt 加上同样的语句：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-Dsbt.override.build.repos=true</span></code></pre></td></tr></table></div></figure>


<ol>
<li>添加获取jar的repo地址，新建 ~/.sbt/repositories 文件</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[repositories]
</span><span class='line'>  local
</span><span class='line'>  local-maven: file:///D:/maven/.m2/repository/
</span><span class='line'>  cu: http://cu1:8081/nexus/content/groups/public/
</span><span class='line'>  #oschina: http://maven.oschina.net/content/groups/public/
</span><span class='line'>  jcenter: https://jcenter.bintray.com/
</span><span class='line'>  typesafe-ivy-releases: https://repo.typesafe.com/typesafe/ivy-releases/, [organization]/[module]/[revision]/[type]s/[artifact](-[classifier]).[ext], bootOnly
</span><span class='line'>  maven-central
</span><span class='line'>  ivy-typesafe: http://dl.bintray.com/typesafe/ivy-releases, [organization]/[module]/(scala_[scalaVersion]/)(sbt_[sbtVersion]/)[revision]/[type]s/[artifact](-[classifier]).[ext]
</span><span class='line'>  ivy-sbt-plugin: http://dl.bintray.com/sbt/sbt-plugin-releases/, [organization]/[module]/(scala_[scalaVersion]/)(sbt_[sbtVersion]/)[revision]/[type]s/[artifact](-[classifier]).[ext]</span></code></pre></td></tr></table></div></figure>


<p>配置相关参考：</p>

<ul>
<li><a href="http://9leg.com/scala/2015/10/17/scala-play-setting.html">http://9leg.com/scala/2015/10/17/scala-play-setting.html</a></li>
<li><a href="https://afoo.me/posts/2014-11-05-how-make-sbt-jump-over-GFW.html">https://afoo.me/posts/2014-11-05-how-make-sbt-jump-over-GFW.html</a></li>
<li><a href="https://www.jfrog.com/confluence/display/RTF/SBT+Repositories">https://www.jfrog.com/confluence/display/RTF/SBT+Repositories</a> +</li>
<li><a href="http://www.scala-sbt.org/0.13/docs/zh-cn/Library-Dependencies.html">http://www.scala-sbt.org/0.13/docs/zh-cn/Library-Dependencies.html</a></li>
<li><a href="http://www.scala-sbt.org/0.13/docs/Proxy-Repositories.html">http://www.scala-sbt.org/0.13/docs/Proxy-Repositories.html</a></li>
</ul>


<h4>创建新项目</h4>

<ul>
<li><a href="https://playframework.com/documentation/2.5.x/Tutorials">https://playframework.com/documentation/2.5.x/Tutorials</a></li>
</ul>


<p>添加环境变量自己主动点，activator和sbt都加一下。然后运行 activator new 根据模板创建项目。也可以参考官网的直接写build.sbt。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>R:\&gt;activator new helloworld play-java
</span><span class='line'>ACTIVATOR_HOME=E:\local\usr\share\activator-dist-1.3.12
</span><span class='line'>
</span><span class='line'>Fetching the latest list of templates...
</span><span class='line'>
</span><span class='line'>OK, application "helloworld" is being created using the "play-java" template.
</span><span class='line'>
</span><span class='line'>To run "helloworld" from the command line, "cd helloworld" then:
</span><span class='line'>R:\\helloworld/activator run
</span><span class='line'>
</span><span class='line'>To run the test for "helloworld" from the command line, "cd helloworld" then:
</span><span class='line'>R:\\helloworld/activator test
</span><span class='line'>
</span><span class='line'>To run the Activator UI for "helloworld" from the command line, "cd helloworld" then:
</span><span class='line'>R:\\helloworld/activator ui</span></code></pre></td></tr></table></div></figure>


<p>创建好项目后，运行 activator run 看看效果：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>R:\helloworld&gt;activator run
</span><span class='line'>ACTIVATOR_HOME=E:\local\usr\share\activator-dist-1.3.12
</span><span class='line'>[info] Loading project definition from R:\helloworld\project
</span><span class='line'>[info] Updating {file:/R:/helloworld/project/}helloworld-build...
</span><span class='line'>[info] Resolving org.fusesource.jansi#jansi;1.4 ...
</span><span class='line'>[info] Done updating.
</span><span class='line'>[info] Set current project to helloworld (in build file:/R:/helloworld/)
</span><span class='line'>[info] Updating {file:/R:/helloworld/}root...
</span><span class='line'>[info] Resolving jline#jline;2.12.1 ...
</span><span class='line'>[info] Done updating.
</span><span class='line'>
</span><span class='line'>--- (Running the application, auto-reloading is enabled) ---
</span><span class='line'>
</span><span class='line'>[info] p.c.s.NettyServer - Listening for HTTP on /0:0:0:0:0:0:0:0:9000
</span><span class='line'>
</span><span class='line'>(Server started, use Ctrl+D to stop and go back to the console...)
</span></code></pre></td></tr></table></div></figure>


<p>打开浏览器访问 <a href="http://localhost:9000">http://localhost:9000</a> ,访问的时刻可能会实时的编译会等一段时间。</p>

<h4>导入eclipse</h4>

<p>前面已经把helloworld跑起来了，接下来是把功能导入eclipse。直接导入或者手动加classpath挺麻烦的，play的一些配置会最终会编译class的。</p>

<p>这里使用 sbteclipse 来生成 eclipse 项目需要的文件。</p>

<ul>
<li><a href="https://www.playframework.com/documentation/2.5.x/IDE">https://www.playframework.com/documentation/2.5.x/IDE</a></li>
<li><a href="https://github.com/typesafehub/sbteclipse">https://github.com/typesafehub/sbteclipse</a></li>
<li><a href="https://github.com/typesafehub/sbteclipse/wiki/Using-sbteclipse">https://github.com/typesafehub/sbteclipse/wiki/Using-sbteclipse</a></li>
</ul>


<p>需要配置二个文件，先添加插件、然后修改配置。</p>

<p>在 helloworld/project/plugins.sbt 最后添加 sbteclipse 插件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>addSbtPlugin("com.typesafe.sbteclipse" % "sbteclipse-plugin" % "5.0.1")</span></code></pre></td></tr></table></div></figure>


<p>在 helloworld/build.sbt 最后添加配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import com.typesafe.sbteclipse.plugin.EclipsePlugin.EclipseKeys
</span><span class='line'>// Compile the project before generating Eclipse files, so that generated .scala or .class files for views and routes are present
</span><span class='line'>EclipseKeys.preTasks := Seq(compile in Compile)
</span><span class='line'>EclipseKeys.projectFlavor := EclipseProjectFlavor.Java           // Java project. Don't expect Scala IDE
</span><span class='line'>EclipseKeys.createSrc := EclipseCreateSrc.Default + EclipseCreateSrc.ManagedClasses // Use .class files instead of generated .scala files for views and routes
</span><span class='line'>EclipseKeys.withSource := false
</span><span class='line'>EclipseKeys.withJavadoc := false</span></code></pre></td></tr></table></div></figure>


<p>然后用 sbt eclipse 生成IDE项目所需文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>R:\helloworld&gt;sbt
</span><span class='line'>Java HotSpot(TM) 64-Bit Server VM warning: ignoring option MaxPermSize=256m; support was removed in 8
</span><span class='line'>[info] Loading project definition from R:\helloworld\project
</span><span class='line'>[info] Updating {file:/R:/helloworld/project/}helloworld-build...
</span><span class='line'>[info] Resolving org.fusesource.jansi#jansi;1.4 ...
</span><span class='line'>[info] Done updating.
</span><span class='line'>[info] Set current project to helloworld (in build file:/R:/helloworld/)
</span><span class='line'>
</span><span class='line'>[helloworld] $ eclipse
</span><span class='line'>[info] About to create Eclipse project files for your project(s).
</span><span class='line'>[info] Updating {file:/R:/helloworld/}root...
</span><span class='line'>[info] Resolving jline#jline;2.12.1 ...
</span><span class='line'>[info] Done updating.
</span><span class='line'>[info] Compiling 6 Scala sources and 10 Java sources to R:\helloworld\target\scala-2.11\classes...
</span><span class='line'>[info] Successfully created Eclipse project files for project(s):
</span><span class='line'>[info] helloworld
</span><span class='line'>
</span><span class='line'>[helloworld] $ compile
</span><span class='line'>[success] Total time: 3 s, completed 2016-11-10 13:11:49
</span><span class='line'>
</span><span class='line'>[helloworld] $ eclipse
</span><span class='line'>[info] About to create Eclipse project files for your project(s).
</span><span class='line'>[info] Successfully created Eclipse project files for project(s):
</span><span class='line'>[info] helloworld
</span><span class='line'>[helloworld] $</span></code></pre></td></tr></table></div></figure>


<p>我这是专门重新弄的一个工程，依赖是原来已经下载好了的（下载需要等一段时间）。</p>

<p>然后导入已经存在的项目即可。看最终效果图：</p>

<p><img src="/images/blogs/play2-dev.jpg" alt="" /></p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/10/20/ssh-upgrade-on-centos6/">红帽6升级SSH</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-10-20T11:29:50+00:00" pubdate data-updated="true">Thu 2016-10-20 11:29</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>安全检查报告SSH版本太低存在漏洞需要进行升级，但是红帽没有现成的高版本打包好SSH的rpm。自己动手丰衣足食，没有网上一些朋友遇到那么多的问题，但是也是这纠结过程。</p>

<p>搞一台身边的机器测试安装，如果远程机器搞不好就连不上了！！先手动编译安装一遍，把编译需要的依赖都安装好，然后再rpmbuild就会比较顺利。</p>

<h2>运维同事编译安装的步骤</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>加载光盘的packages
</span><span class='line'># mount -o loop disk1.iso /mnt/disk
</span><span class='line'># vi /etc/yum.repo.d/local.repo
</span><span class='line'>
</span><span class='line'>[root@localhost SOURCES]# ll *.tar.gz
</span><span class='line'>-rw-r--r--. 1 root   root   1499808 3月  10 2016 openssh-7.2p2.tar.gz
</span><span class='line'>-rw-r--r--. 1 root   root   5489494 10月 20 16:41 openssl-1.0.2j.tar.gz
</span><span class='line'>-rw-r--r--. 1 root   root     29229 6月  26 2004 x11-ssh-askpass-1.2.4.1.tar.gz
</span><span class='line'>
</span><span class='line'>一、升级 Zlib
</span><span class='line'>1、下载最新版本 Zlib
</span><span class='line'># ./configure --prefix=/usr/local/zlib
</span><span class='line'>本次遇到GCC未安装
</span><span class='line'>yum -y install gcc
</span><span class='line'>./configure --prefix=/usr/local/zlib
</span><span class='line'># make
</span><span class='line'># make install
</span><span class='line'>这样，就把 zlib 编译安装在 /usr/local/zilib 中了。
</span><span class='line'>二、升级 OpenSSL
</span><span class='line'>1、下载最新版本 OpenSSL
</span><span class='line'>which openssl    查看到当前是在/usr/bin/openssl
</span><span class='line'># ./config --prefix=/usr --shared
</span><span class='line'>本次遇到系统时间不对的，修改好系统时间后config正常。
</span><span class='line'># make
</span><span class='line'># make test （这一步很重要哦！是进行 SSL 加密协议的完整测试，如果出现错误就要一定先找出哪里的原因，否则一味继续可能导致最终 SSH 不能使用，后果很严重哦！）
</span><span class='line'># make install
</span><span class='line'>三、升级 OpenSSH
</span><span class='line'>1、下载最新版本 OpenSSH
</span><span class='line'>#  ./configure --prefix=/usr --sysconfdir=/etc/ssh --with-pam --with-zlib=/usr/local/zlib --with-ssl-dir=/usr/bin/openssl --with-md5-passwords 
</span><span class='line'>（注意，如果 configure 时提示 PAM 有错误，那一般是因为系统中没有安装 pam-devel RPM 包，找到安装光盘，安装 pam-devel 就可以解决啦）如果是sshkeygen提示错误，需要make  clean再重新编译
</span><span class='line'>本次安装过程提示了pam问题,cd /opt/cdrom-mirror/Packages
</span><span class='line'>rpm -ivh pam-devel-1.1.1-10.el6_2.1.x86_64.rpm
</span><span class='line'>./configure --prefix=/usr --sysconfdir=/etc/ssh --with-pam --with-zlib=/usr/local/zlib --with-ssl-dir=/usr/bin/openssl --with-md5-passwords 
</span><span class='line'># make
</span><span class='line'># make install
</span><span class='line'>ssh -V 
</span></code></pre></td></tr></table></div></figure>


<h2>编译RPM包</h2>

<p>机器太多，不太可能一台台的编译安装。首先用rpmbuild打包，然后用createrepo制作本地私有仓库。主要是openssl打包比较纠结！OpenSSH完全依赖OpenSSL的，所以OpenSSL的版本一定要先编译安装好，然后再编译OpenSSH。相应的包下面都有对应的spec文件。</p>

<p>实际操作过程是先打包OpenSSH的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> cd
</span><span class='line'> mkdir rpmbuild
</span><span class='line'> cd rpmbuild/
</span><span class='line'> mkdir -pv {BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
</span><span class='line'>
</span><span class='line'> cd SOURCES/
</span><span class='line'> cd ../SPECS/
</span><span class='line'> cp ~/updatessh/openssh-7.2p2/contrib/redhat/openssh.spec ./
</span><span class='line'> cd ..
</span><span class='line'> cd SOURCES/
</span><span class='line'> vi /etc/resolv.conf
</span><span class='line'> wget http://pkgs.fedoraproject.org/repo/pkgs/openssh/x11-ssh-askpass-1.2.4.1.tar.gz/8f2e41f3f7eaa8543a2440454637f3c3/x11-ssh-askpass-1.2.4.1.tar.gz
</span><span class='line'> wget http://pkgs.fedoraproject.org/repo/pkgs/openssh/openssh-7.2p2.tar.gz/13009a9156510d8f27e752659075cced/openssh-7.2p2.tar.gz
</span><span class='line'> cd ..
</span><span class='line'> yum groupinstall "X Window System" "Desktop" "Desktop Platform" "General Purpose Desktop"
</span><span class='line'> yum -y install libX11-devel
</span><span class='line'> yum install imake
</span><span class='line'> yum provides \*/Intrinsic.h
</span><span class='line'> yum install libXt-devel
</span><span class='line'> yum search gtk
</span><span class='line'> yum install gtk2 gtk2-devel
</span><span class='line'> vi SPECS/openssh.spec
</span><span class='line'> rpmbuild -bb SPECS/openssh.spec</span></code></pre></td></tr></table></div></figure>


<p>然后坑就摆在那里了：重启sshd失败。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 在rpmbuild\RPMS\x86_64目录下面创建createrepo私有仓库
</span><span class='line'># /etc/yum.repo.d/local.repo增加节点
</span><span class='line'>
</span><span class='line'># yum install openssh 
</span><span class='line'>
</span><span class='line'># 重启
</span><span class='line'>[root@localhost ~]# service sshd restart
</span><span class='line'>然后启动了[失败]（具体错没记下来）</span></code></pre></td></tr></table></div></figure>


<p>感觉是OpenSSL的问题了。然后打包好OpenSSL后安装竟然报错：找不到libssl的动态链接库</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Error: Package: wget-1.12-1.4.el6.x86_64 (@anaconda-RedHatEnterpriseLinux-201206132210.x86_64/6.3)
</span><span class='line'>           Requires: libcrypto.so.10()(64bit)
</span><span class='line'>           Removing: openssl-1.0.0-20.el6_2.5.x86_64 (@cdrom)
</span><span class='line'>               libcrypto.so.10()(64bit)
</span><span class='line'>           Updated By: openssl-1.0.2j-1.x86_64 (upgrade)
</span><span class='line'>               Not found
</span><span class='line'>Error: Package: 1:wpa_supplicant-0.7.3-3.el6.x86_64 (@cdrom)
</span><span class='line'>           Requires: libssl.so.10()(64bit)
</span><span class='line'>           Removing: openssl-1.0.0-20.el6_2.5.x86_64 (@cdrom)
</span><span class='line'>               libssl.so.10()(64bit)
</span><span class='line'>           Updated By: openssl-1.0.2j-1.x86_64 (upgrade)
</span><span class='line'>               Not found</span></code></pre></td></tr></table></div></figure>


<p>官方的出的spec打包的rpm安装后竟然会少东西。百思不得其解，通过查看cdrom openssl-1.0.0-20.el6_2.5.x86_64.rpm与rpmbuild openssl-1.0.2j-1.x86_64.rpm的确还不同：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# rpm -qlp /opt/cdrom/Packages/openssl-1.0.0-20.el6_2.5.x86_64.rpm | grep libssl
</span><span class='line'>...
</span><span class='line'>/usr/lib64/libssl.so.1.0.0
</span><span class='line'>/usr/lib64/libssl.so.10
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# rpm -qlp /opt/cdrom/Packages/openssl-1.0.0-20.el6_2.5.x86_64.rpm | grep libssl
</span><span class='line'>...
</span><span class='line'>/usr/lib64/libssl.so.1.0.0</span></code></pre></td></tr></table></div></figure>


<p>在spec里面增加libssl.so.10软链接也没用。rpm并没有提供libssl.so.10的 <strong> provide </strong> 服务（可以通过<a href="http://stackoverflow.com/questions/25638461/how-can-i-make-rpm-tell-what-libraries-are-provided-inside-it">rpm -qip &ndash;provides RPM</a>查看）。</p>

<p>实在想不出办法了，只能先看下官网怎么打包的。最后通过查看 openssl-1.0.0-20.el6_2.5.src.rpm 的打包spec是进行定制了的，把原来编译生成的动态链接库so.$(SHLIB_MAJOR).$(SHLIB_MINOR)文件名改成so.$(SHLIB_SONAMEVER)。主要的两个patch为：</p>

<ul>
<li>openssl-1.0.0-beta3-soversion.patch</li>
<li>openssl-1.0.0-beta4-redhat.patch</li>
</ul>


<p>参考修改如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>修改Makefile
</span><span class='line'>diff -u openssl-1.0.2j/Makefile.org rpmbuild/SOURCES/openssl-1.0.2j/Makefile.org
</span><span class='line'>--- openssl-1.0.2j/Makefile.org 2016-09-26 17:49:07.000000000 +0800
</span><span class='line'>+++ rpmbuild/SOURCES/openssl-1.0.2j/Makefile.org        2016-10-20 15:28:32.000000000 +0800
</span><span class='line'>@@ -10,6 +10,7 @@
</span><span class='line'> SHLIB_MAJOR=
</span><span class='line'> SHLIB_MINOR=
</span><span class='line'> SHLIB_EXT=
</span><span class='line'>+SHLIB_SONAMEVER=10
</span><span class='line'> PLATFORM=dist
</span><span class='line'> OPTIONS=
</span><span class='line'> CONFIGURE_ARGS=
</span><span class='line'>@@ -342,10 +343,9 @@
</span><span class='line'> link-shared:
</span><span class='line'>        @ set -e; for i in $(SHLIBDIRS); do \
</span><span class='line'>                $(MAKE) -f $(HERE)/Makefile.shared -e $(BUILDENV) \
</span><span class='line'>-                       LIBNAME=$$i LIBVERSION=$(SHLIB_MAJOR).$(SHLIB_MINOR) \
</span><span class='line'>+                       LIBNAME=$$i LIBVERSION=$(SHLIB_SONAMEVER) \
</span><span class='line'>                        LIBCOMPATVERSIONS=";$(SHLIB_VERSION_HISTORY)" \
</span><span class='line'>                        symlink.$(SHLIB_TARGET); \
</span><span class='line'>-               libs="$$libs -l$$i"; \
</span><span class='line'>        done
</span><span class='line'> 
</span><span class='line'> build-shared: do_$(SHLIB_TARGET) link-shared
</span><span class='line'>@@ -356,7 +356,7 @@
</span><span class='line'>                        libs="$(LIBKRB5) $$libs"; \
</span><span class='line'>                fi; \
</span><span class='line'>                $(CLEARENV) && $(MAKE) -f Makefile.shared -e $(BUILDENV) \
</span><span class='line'>-                       LIBNAME=$$i LIBVERSION=$(SHLIB_MAJOR).$(SHLIB_MINOR) \
</span><span class='line'>+                       LIBNAME=$$i LIBVERSION=$(SHLIB_SONAMEVER) \
</span><span class='line'>                        LIBCOMPATVERSIONS=";$(SHLIB_VERSION_HISTORY)" \
</span><span class='line'>                        LIBDEPS="$$libs $(EX_LIBS)" \
</span><span class='line'>                        link_a.$(SHLIB_TARGET); \
</span><span class='line'>
</span><span class='line'>修改Configure1
</span><span class='line'>diff -u openssl-1.0.2j/Configure rpmbuild/SOURCES/openssl-1.0.2j/Configure
</span><span class='line'>--- openssl-1.0.2j/Configure    2016-09-26 17:49:07.000000000 +0800
</span><span class='line'>+++ rpmbuild/SOURCES/openssl-1.0.2j/Configure   2016-10-20 16:40:33.000000000 +0800
</span><span class='line'>@@ -1781,7 +1781,7 @@
</span><span class='line'>        elsif ($shared_extension ne "" && $shared_extension =~ /^\.s([ol])\.[^\.]*\.[^\.]*$/)
</span><span class='line'>                {
</span><span class='line'>                my $sotmp = $1;
</span><span class='line'>-               s/^SHARED_LIBS_LINK_EXTS=.*/SHARED_LIBS_LINK_EXTS=.s$sotmp.\$(SHLIB_MAJOR) .s$sotmp/;
</span><span class='line'>+               s/^SHARED_LIBS_LINK_EXTS=.*/SHARED_LIBS_LINK_EXTS=.s$sotmp.\$(SHLIB_SONAMEVER) .s$sotmp/;
</span><span class='line'>                }
</span><span class='line'>        elsif ($shared_extension ne "" && $shared_extension =~ /^\.[^\.]*\.[^\.]*\.dylib$/)
</span><span class='line'>                {
</span><span class='line'>
</span><span class='line'>修改Configure2
</span><span class='line'>rpmbuild/SOURCES/openssl-1.0.2j/Configure 文件中 so.\$(SHLIB_MAJOR).\$(SHLIB_MINOR) 替换成 so.\$(SHLIB_SONAMEVER)
</span><span class='line'>
</span><span class='line'>修改spec
</span><span class='line'>[root@localhost ~]# diff openssl-1.0.2j/openssl.spec rpmbuild/SPECS/openssl.spec
</span><span class='line'>110a111,121
</span><span class='line'>&gt; version=%{version}
</span><span class='line'>&gt; soversion=10
</span><span class='line'>&gt; rename so.${soversion} so.${version} $RPM_BUILD_ROOT%{_libdir}/*.so.${soversion}
</span><span class='line'>&gt; for lib in $RPM_BUILD_ROOT/usr/lib64/*.so.${version} ; do
</span><span class='line'>&gt;         chmod 755 ${lib}
</span><span class='line'>&gt;         ln -s -f `basename ${lib}` $RPM_BUILD_ROOT/usr/lib64/`basename ${lib} .${version}`
</span><span class='line'>&gt;         ln -s -f `basename ${lib}` $RPM_BUILD_ROOT/usr/lib64/`basename ${lib} .${version}`.${soversion}
</span><span class='line'>&gt; 
</span><span class='line'>&gt; done
</span><span class='line'>&gt; </span></code></pre></td></tr></table></div></figure>


<p>然后打包OpenSSL，用Yum更新OpenSSL；再打包OpenSSH，最后再用Yum安装OpenSSH。</p>

<h2>配置</h2>

<p>打包好完成后完成大半的任务了，但是重启过程出现了一些问题：</p>

<ol>
<li>error while loading shared libraries: libcrypto.so.10: cannot enable executable stack as shared object requires: Permission denied</li>
</ol>


<p>运行： <code>execstack -c libcrypto.so.10</code> 解决。 <a href="http://www.linuxquestions.org/questions/linux-kernel-70/longterm-and-grsec-on-slackware-13-0-a-903612/">http://www.linuxquestions.org/questions/linux-kernel-70/longterm-and-grsec-on-slackware-13-0-a-903612/</a></p>

<ol>
<li>重启后远程密码登录上不，但是机器重启是可以登录的，而且su通过密码也是可以切换的。</li>
</ol>


<p>由于su切换没问题，应该不是加解密的问题。最后经常是selinux的问题： <code>setenforce 0 ; vi /etc/selinux/config</code> 完成配置。</p>

<p>到此纠结的SSH升级告一段落。后面上百台机器通过puppet就可以搞定了。</p>

<p>最后分享一个牛逼到不能再牛逼升级配置的文章： <a href="http://www.tsingfun.com/html/2016/env_0330/1332.html">http://www.tsingfun.com/html/2016/env_0330/1332.html</a> 包括了升级过程中你遇到和没遇到的所有问题了。</p>

<h2>再记</h2>

<p>在测试机上面搞的都是默认的配置啊，安全级别本来就不高。但是到生产就不同了，本来加了防护的。需要特别注意！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#centos6.8
</span><span class='line'>#直接用openssl-1.0.1e-48.el6
</span><span class='line'>[root@localhost yum.repos.d]# mount -o loop CentOS-6.8-x86_64-bin-DVD1.iso /opt/cdrom
</span><span class='line'>[root@localhost yum.repos.d]# vi local.repo
</span><span class='line'>
</span><span class='line'>[root@localhost rpmbuild]#  yum groupinstall "X Window System" "Desktop" "Desktop Platform" "General Purpose Desktop"
</span><span class='line'>
</span><span class='line'>[root@localhost yum.repos.d]# yum install -y libX11-devel imake libXt-devel gtk2 gtk2-devel 
</span><span class='line'>
</span><span class='line'>[root@localhost rpmbuild]# yum install -y rpm-build
</span><span class='line'>[root@localhost rpmbuild]# yum install -y openssl-devel   krb5-devel pam-devel 
</span><span class='line'>
</span><span class='line'>[root@localhost rpmbuild]# yum install gcc
</span><span class='line'>
</span><span class='line'>[root@localhost rpmbuild]# rpmbuild -bb SPEC/openssh.spec
</span><span class='line'>
</span><span class='line'>自己做的repo：
</span><span class='line'>
</span><span class='line'>[root@hadoop-master1 ssh]# ll
</span><span class='line'>total 6192
</span><span class='line'>-rw-r--r-- 1 root root  439708 Oct 21 17:53 openssh-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root   41752 Oct 21 17:53 openssh-askpass-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root   22684 Oct 21 17:53 openssh-askpass-gnome-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root  581836 Oct 21 17:53 openssh-clients-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root   16948 Oct 21 17:53 openssh-debuginfo-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root  391544 Oct 21 17:53 openssh-server-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root 3226970 Oct 21 17:23 openssl-1.0.1e-48.el6.src.rpm
</span><span class='line'>-rw-r--r-- 1 root root 1595916 May 12 18:49 openssl-1.0.1e-48.el6.x86_64.rpm
</span><span class='line'>drwxr-xr-x 2 root root    4096 Oct 21 18:47 repodata
</span><span class='line'>
</span><span class='line'>注意点：
</span><span class='line'>
</span><span class='line'>1 selinux关掉
</span><span class='line'>
</span><span class='line'>2 开个telnet以防万一
</span><span class='line'>
</span><span class='line'>yum install telnet-server
</span><span class='line'>chkconfig telnet on
</span><span class='line'>service xinetd restart
</span><span class='line'>
</span><span class='line'>3 PAM
</span><span class='line'>vi /etc/ssh/sshd_config
</span><span class='line'>UsePAM no（反正要确认pam，或者看看/etc/pam.d/sshd是否满足要求）
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/6">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/4">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>
  <h1><a class='category' href='/blog/categories/recommend/'>Recommend</a></h1>
	<ul role="list">
		
			<li class="post">
				<a href="/blog/2016/04/23/hadoop-guide-catalog/">[整理] Hadoop入门</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/03/28/hive-on-spark/">Hive on Spark</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/01/23/install-and-config-ganglia-on-redhat-2/">安装配置Ganglia(2)</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/08/24/manual-install-supervisor/">Supervisor安装配置</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/10/16/spark-build-and-configuration/">编译/搭建Spark环境</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/08/25/step-by-step-found-java-oom-error/">查找逐步定位Java程序OOM的异常实践</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/29/hadoop2-snappy-compress/">Hadoop2 Snappy Compress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/26/start-redis/">[读读书]Redis入门指南</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/04/21/hadoop2-windows-startguide/">Windows下部署/配置/调试hadoop2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/30/git-cheatsheet/">GIT操作记录手册</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/17/jekyll-edit-link-in-web-page/">Jekyll页面添加编辑按钮</a>
			</li>
		
			<li class="post">
				<a href="/blog/2013/09/19/let-shell-command-efficient/">让敲Shell命令高效起来</a>
			</li>
		
	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/07/08/casperjs-crawler/">爬虫之CasperJS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/04/wechat-images-export/">导出微信照片</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/04/jenkins-start-guide/">Jenkins Start Guide</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/01/optimize-java-on-production-environment/">追生产的一次优化</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/23/spark-on-hive-speculation-shit-bug/">Hive on Spark预测性执行BUG一枚</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/05/puppet-automate-deploy-hosts/">Puppet批量自动化部署实战</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/14/k8s-hadoop-deploy/">K8s Hadoop Deploy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/30/k8s-harbor-config/">K8s Harbor Config</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/alluxio/'>alluxio</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/android/'>android</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/bigdata/'>bigdata</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blabla/'>blabla</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/debug/'>debug</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (10) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/flume/'>flume</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/git/'>git</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (43) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hbase/'>hbase</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hole/'>hole</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (9) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kafka/'>kafka</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/recommend/'>recommend</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/shell/'>shell</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tachyon/'>tachyon</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tez/'>tez</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tools/'>tools</a> (46) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/topics/'>topics</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/zookeeper/'>zookeeper</a> (1) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (174)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253461959'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1253461959%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  

<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"winseliu"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->










</body>
</html>
