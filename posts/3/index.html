
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="很久以前就在JD弄了一个K2，当时没有啥需求，所以也没有折腾 。最近尝试DDNS域名绑定到动态的IP，想在家有一个能提供SSH访问的机器。原来的树莓派被弄坏了，就想着折腾折腾刷刷K2，在上面安装一个SSH。 同时也把官网提供的系统净化净化。 原K2的详细信息 斐讯K2 1200M智能双频无线路由器 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winse.github.io/posts/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/libs/jquery.toc.min.js" type="text/javascript"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

<script src="/javascripts/generate-toc.js" type="text/javascript"></script>


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43198550-1', 'auto');
  ga('send', 'pageview');

</script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停, 熙熙攘攘, 忙忙碌碌, 不知何畏.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winse.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/20/k2-reburn/">斐讯K2刷机记录</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-06-20T23:08:28+08:00" pubdate data-updated="true">Wed 2018-06-20 23:08</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>很久以前就在JD弄了一个K2，当时没有啥需求，所以也没有折腾 。最近尝试DDNS域名绑定到动态的IP，想在家有一个能提供SSH访问的机器。原来的树莓派被弄坏了，就想着折腾折腾刷刷K2，在上面安装一个SSH。</p>

<p>同时也把官网提供的系统净化净化。</p>

<h2>原K2的详细信息</h2>

<p><a href="https://item.jd.com/2615810.html">斐讯K2 1200M智能双频无线路由器 WIFI穿墙 PSG1218</a></p>

<h2>了解刷机流程</h2>

<ul>
<li>官方版本可能存在的问题：</li>
</ul>


<p><a href="http://www.right.com.cn/forum/thread-208302-1-1.html">http://www.right.com.cn/forum/thread-208302-1-1.html</a></p>

<ul>
<li>刷机直接参考</li>
</ul>


<p><a href="http://www.right.com.cn/forum/thread-208753-1-1.html">【2017-12-01】斐讯K2 V22.5.9.163官方固件定制版,集成breed,支持官版直刷【V1.8】</a></p>

<h2>详细步骤</h2>

<ol>
<li><p>更新版本到 V22.5.9.163</p>

<p>查看官网提供的<a href="http://www.phicomm.com/cn/support.php/Soho/software_support/t/sm.html">软件</a>， 下载<a href="http://www.phicomm.com/cn/support.php/Soho/search_support/col/6/keys/k2.html">对应的版本</a></p>

<ul>
<li>K2_A2_V21.4.6.12.bin</li>
<li>K2_V22.5.9.163.bin</li>
</ul>
</li>
<li><p>刷净化版（带Bread）k2_163_v18_breed.rar</p>

<ul>
<li><p><a href="http://woo.iytc.net/?dir=uploads/K2">下载地址</a></p></li>
<li><p><a href="http://www.qqgzs.com/archives/k2-shuaji.html">breed刷入第三方固件</a></p>

<p> 进入Bread方法，这个了解下就行，这里不刷第三方的。</p>

<p> 拔除K2上Wan口的网线，路由器断电，持续按住路由器上的reset按钮，接通路由器电源，3秒后松开reset按钮。
 在浏览器地址栏输入 <a href="http://192.168.1.1">http://192.168.1.1</a> 访问Breed Web。</p></li>
</ul>
</li>
<li><p>启动telnet/手动安装SSH</p>

<ul>
<li><a href="http://iytc.net/wordpress/?p=1624">http://iytc.net/wordpress/?p=1624</a></li>
</ul>
</li>
</ol>


<p>3.1. 启动telnet</p>

<p>用 高级设置 - 系统设置 - WebShell 执行命令</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/www/cgi-bin# /usr/sbin/telnetd -l /bin/login.sh</span></code></pre></td></tr></table></div></figure>


<p>直接连，不用密码！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-ADH7K1Q:~$ telnet 192.168.2.1</span></code></pre></td></tr></table></div></figure>


<p>同时修改下密码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 更改root密码为 admin
</span><span class='line'>echo -e 'admin\nadmin' | passwd root</span></code></pre></td></tr></table></div></figure>


<p>3.2. 安装SSH</p>

<p>这个版本没有带opkg，需要首先把opkg安装好。</p>

<ul>
<li><a href="https://www.ywlib.com/archives/102.html">小米路由3安装opkg</a></li>
<li><a href="https://www.ywlib.com/archives/101.html">解压OpenWRT固件bin文档提取文件</a></li>
</ul>


<p>直接下载 <a href="http://www.ywlib.com/usr/uploads/2017/05/387250260.zip">opkg.zip</a> 然后本地起一个 httpserver 提供一个下载的服务。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-ADH7K1Q:/mnt/e/SOFTWARE/k2$ python -m SimpleHTTPServer
</span><span class='line'>Serving HTTP on 0.0.0.0 port 8000 ...</span></code></pre></td></tr></table></div></figure>


<p>在telnet窗口执行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@K2:/www/cgi-bin# cd /bin
</span><span class='line'>root@K2:/bin# wget http://192.168.2.160:8000/opkg
</span><span class='line'>--2018-06-20 22:50:18--  http://192.168.2.160:8000/opkg
</span><span class='line'>Connecting to 192.168.2.160:8000... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 130247 (127K) [application/octet-stream]
</span><span class='line'>Saving to: 'opkg'
</span><span class='line'>
</span><span class='line'>opkg                                  100%[=========================================================================&gt;] 127.19K   176KB/s   in 0.7s
</span><span class='line'>
</span><span class='line'>2018-06-20 22:50:18 (176 KB/s) - 'opkg' saved [130247/130247]
</span><span class='line'>
</span><span class='line'>root@K2:/bin# chmod +x opkg</span></code></pre></td></tr></table></div></figure>


<pre><code>注意：用完后就删掉吧 `rm -rf /bin/opkg` ，空间不够！！查看[安装了那些软件](https://unix.stackexchange.com/questions/157097/how-to-know-disk-space-occupied-by-packages-in-openwrt)

```
rm -rf /bin/opkg

root@K2:/overlay# du -sh */*/*
root@K2:/overlay# rm -rf usr/lib/opkg
```
</code></pre>

<p>然后安装ssh：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>opkg install http://downloads.openwrt.org/barrier_breaker/14.07/ramips/mt7620a/packages/base/dropbear_2014.63-2_ramips_24kec.ipk
</span><span class='line'># 开机自启
</span><span class='line'>/etc/init.d/dropbear enable
</span><span class='line'>
</span><span class='line'># https://openwrt.org/docs/guide-user/base-system/ssh_configuration
</span><span class='line'># https://wiki.openwrt.org/doc/uci/dropbear
</span><span class='line'>vi /etc/config/dropbear
</span><span class='line'>        option GatewayPorts '1'
</span><span class='line'>        
</span><span class='line'># 启动
</span><span class='line'>/etc/init.d/dropbear start
</span><span class='line'>
</span><span class='line'>uci show dropbear
</span><span class='line'>
</span><span class='line'># 如果需要放开防火墙
</span><span class='line'>iptables -I INPUT 1 -p tcp -m tcp --dport 22 -j ACCEPT
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>vi /etc/firewall.user
</span><span class='line'># 删除无用文件
</span><span class='line'>rm -rf /etc/dropbear/dropbear_dss_host_key</span></code></pre></td></tr></table></div></figure>


<p>注意：需要持久化的话，把这句开放22端口的指令写到 /etc/firewall.user 。</p>

<p>客户端登录：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-ADH7K1Q:~$ ssh root@192.168.2.1
</span><span class='line'>The authenticity of host '192.168.2.1 (192.168.2.1)' can't be established.
</span><span class='line'>RSA key fingerprint is SHA256:vuAY65qk3Us4MyjYT8KPT8lYsTSTqru6W4e7My6CRkk.
</span><span class='line'>Are you sure you want to continue connecting (yes/no)? yes
</span><span class='line'>Warning: Permanently added '192.168.2.1' (RSA) to the list of known hosts.
</span><span class='line'>root@192.168.2.1's password:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>BusyBox v1.22.1 (2017-02-15 13:52:46 CST) built-in shell (ash)
</span><span class='line'>Enter 'help' for a list of built-in commands.
</span><span class='line'>
</span><span class='line'>    ___  __ _______________  __  _____  ___  ________  ___
</span><span class='line'>   / _ \/ // /  _/ ___/ __ \/  |/  /  |/  / / __/ __ \/ _ \
</span><span class='line'>  / ___/ _  // // /__/ /_/ / /|_/ / /|_/ / _\ \/ /_/ / ___/
</span><span class='line'> /_/  /_//_/___/\___/\____/_/  /_/_/  /_/ /___/\____/_/
</span><span class='line'> ----------------------------------------------------------
</span><span class='line'> Barrier Breaker, unknown
</span><span class='line'> ----------------------------------------------------------
</span><span class='line'> PID=K2
</span><span class='line'> BUILD_TYPE=release
</span><span class='line'> BUILD_NUMBER=163
</span><span class='line'> BUILD_TIME=20170215-134532
</span><span class='line'> ----------------------------------------------------------
</span><span class='line'> MTK OpenWrt SDK V3.4
</span><span class='line'> revision : adab2180
</span><span class='line'> benchmark : APSoC SDK 5.0.1.0
</span><span class='line'> kernel : 144992
</span><span class='line'> ----------------------------------------------------------
</span><span class='line'>root@K2:~#</span></code></pre></td></tr></table></div></figure>


<p>不推荐用密码，最好使用公钥的方式来处理。<del>但公钥访问有点问题，.ssh的目录权限是个麻烦事</del> （其实文件的位置不对！！）。</p>

<p>参考： <a href="https://wiki.openwrt.org/doc/howto/dropbear.public-key.auth">Dropbear public-key authentication HowTo</a></p>

<blockquote><p>ssh <a href="&#109;&#x61;&#105;&#108;&#x74;&#x6f;&#x3a;&#114;&#x6f;&#111;&#116;&#64;&#49;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#49;&#x2e;&#49;">&#114;&#111;&#111;&#116;&#x40;&#x31;&#x39;&#50;&#x2e;&#49;&#x36;&#x38;&#x2e;&#49;&#46;&#x31;</a> &ldquo;tee -a /etc/dropbear/authorized_keys&rdquo; &lt; ~/.ssh/id_rsa.pub</p></blockquote>

<p>把 authorized_keys 文件移到 /etc/dropbear 下面就可以了！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@K2:~/.ssh# ls -la
</span><span class='line'>drwx------    2 root     root             0 Jun 21 10:35 .
</span><span class='line'>drwx------    1 root     root             0 Jun 21 08:57 ..
</span><span class='line'>-rw-------    1 root     root           397 Jun 21 10:35 authorized_keys
</span><span class='line'>root@K2:~/.ssh# mv authorized_keys /etc/dropbear/
</span></code></pre></td></tr></table></div></figure>


<h2>其他拓展</h2>

<h3>增加空间，挂载windows共享目录</h3>

<p><a href="https://blog.vircloud.net/linux/openwrt-psg1218.html">https://blog.vircloud.net/linux/openwrt-psg1218.html</a></p>

<p>K2 官方版式不带 USB，因此就限制了很多可玩的东西，但是我们可以通过 SMB 挂载的方式来增加存储空间，需要注意的是老毛子挂载 SMB 的方式与其他 OpenWRT 不同，使用 mount 命令是挂载不成功的，正确的方法是：</p>

<p>位置：高级设置 - 自定义设置 - 脚本 - 在路由器启动后执行
配置如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>### SMB资源挂载(局域网共享映射，无USB也能挂载储存空间)
</span><span class='line'>### 说明：共享路径填写时，【\】要写成【\\】。
</span><span class='line'>sleep 10
</span><span class='line'>modprobe des_generic
</span><span class='line'>modprobe cifs CIFSMaxBufSize=64512
</span><span class='line'>#mkdir -p /media/cifs
</span><span class='line'>#mount -t cifs \\\\{host}\\{share} /media/cifs -o username={user},password={pass}
</span><span class='line'>mount -t cifs \\\\192.168.31.100\\移动磁盘-C /mnt -o username=guest,password=guest
</span><span class='line'>
</span><span class='line'>sleep 10
</span><span class='line'>mdev -s
</span><span class='line'>sleep 5
</span><span class='line'>stop_ftpsamba
</span><span class='line'>sleep 2
</span><span class='line'>run_ftpsamba
</span><span class='line'>sleep 5
</span></code></pre></td></tr></table></div></figure>


<h3>Breed进入方式</h3>

<ol>
<li>将要刷的第三方固件准备好。</li>
<li>断电按着reset键不松手，然后通电5秒后再松开reset键。</li>
<li>打开浏览器输入<a href="http://192.168.1.1%E5%8D%B3%E5%8F%AFBreed">http://192.168.1.1%E5%8D%B3%E5%8F%AFBreed</a> Web恢复控制台（记得先在Breed Web恢复控制台中的固件备份里备份下EEPROM和编程器固件，以后可能用得着）。</li>
<li>恢复固件之前最好在Breed Web恢复控制台恢复一下出厂设置，固件类型：Config区（公版）</li>
</ol>


<p>参考：</p>

<ul>
<li><a href="https://github.com/moonjoin/k2-firmware">https://github.com/moonjoin/k2-firmware</a></li>
<li><a href="http://www.right.com.cn/forum/thread-161324-1-1.html">http://www.right.com.cn/forum/thread-161324-1-1.html</a></li>
<li><a href="https://www.c7cc.com/shuaji-chaiji/k1-k2-v21-4-6-10-telnet-ssh.html">https://www.c7cc.com/shuaji-chaiji/k1-k2-v21-4-6-10-telnet-ssh.html</a></li>
<li><a href="http://www.mm126.cc/319.html">http://www.mm126.cc/319.html</a></li>
<li><a href="http://www.qqgzs.com/archives/k2-22-6-503.html">http://www.qqgzs.com/archives/k2-22-6-503.html</a></li>
</ul>


<h2>其他参考</h2>

<ul>
<li><a href="https://www.jianshu.com/p/6be3639ff9e3">https://www.jianshu.com/p/6be3639ff9e3</a></li>
<li><a href="http://www.right.com.cn/forum/thread-184338-1-1.html">http://www.right.com.cn/forum/thread-184338-1-1.html</a></li>
<li><a href="http://www.cnblogs.com/lanye/p/6149242.html">http://www.cnblogs.com/lanye/p/6149242.html</a> 刷入 breed 和 ssh</li>
<li><a href="http://www.right.com.cn/forum/thread-189593-1-2.html">http://www.right.com.cn/forum/thread-189593-1-2.html</a> 安装SSH也是有多种方法</li>
<li><a href="https://www.cnblogs.com/xuliangxing/p/6486560.html">https://www.cnblogs.com/xuliangxing/p/6486560.html</a></li>
<li><a href="https://www.jianshu.com/p/275217976492">https://www.jianshu.com/p/275217976492</a> LEDE 是一个从 OpenWrt 中衍生出来的产品</li>
<li><a href="https://downloads.lede-project.org/releases/17.01.4/targets/ramips/mt7620/">https://downloads.lede-project.org/releases/17.01.4/targets/ramips/mt7620/</a></li>
<li><a href="https://bitbucket.org/stevengan/padavan/downloads/">https://bitbucket.org/stevengan/padavan/downloads/</a></li>
<li><a href="https://blog.aofall.com/archives/14.html">https://blog.aofall.com/archives/14.html</a></li>
<li><a href="http://www.hopol.cn/2017/05/853/">http://www.hopol.cn/2017/05/853/</a> 斐讯K2 163版配置文件加密破解过程。学学c++是怎么反编译的！！！！</li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/19/install-macosx-on-vmware/">使用VMWare安装Mac OS X</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-06-19T23:05:55+08:00" pubdate data-updated="true">Tue 2018-06-19 23:05</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>参考：</p>

<ul>
<li><a href="http://www.yhy0.com/ios_20160413_269.html">VMware Workstation 12 Pro如何安装Mac OS X 10.11.1</a></li>
<li><a href="https://blog.csdn.net/yongh701/article/details/70597982">【iOS】VMWare中MAC OS X的安装，VMWare tools的配置与iOS的Helloworld</a></li>
</ul>


<p>实际操作：</p>

<ul>
<li>安装 VMware-workstation-full-12.5.7-5813279 。</li>
<li>下载 unlocker208.zip 并使用管理员权限安装 win-install.cmd 。</li>
<li>添加虚拟机，选择 Apple Mac OS X(M) - OS X 10.9；然后修改vmx配置，在 <code>smc.present = "TRUE"</code> 后面添加 <code>smc.version = "0"</code></li>
<li>然后光盘选择 Mavericks_Install_13A603.cdr 安装系统。磁盘格式化：<code>实用工具 - 磁盘工具</code> 。</li>
<li>安装VMWare Tools。光盘选择 darwiniso.zip 压缩包里面的 darwin6.0.3.iso 。</li>
<li>配置共享文件夹。进入系统后，<code>Finder - 偏好设置 -  已连接的服务器</code> 。</li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/10/java-source-annotation-processor/">使用注解生成代码</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-06-10T12:51:39+08:00" pubdate data-updated="true">Sun 2018-06-10 12:51</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>Java里面随处可见annotation（注解），RetentionPolicy 指示了注解使用的情况：</p>

<ul>
<li>SOURCE，比如 @Override, @SuppressWarnings</li>
<li>RUNTIME，最熟悉的莫过于Spring Bean中使用的 @Controller, @Service 一般和反射同时使用。</li>
<li>CLASS</li>
</ul>


<p>而 CLASS 则是用于 compile 编译阶段的注解。一个注解的处理器，以Java代码（或编译过的字节码）作为输入，生成Java文件。这些生成的Java文件，会同其他普通的手动编写的Java源代码一样被javac编译。</p>

<p>可以自己实现一些类似groovy语法糖的功能（lombok框架修改bytecode为类生成新方法getter/setter、或者使用生成新的辅助类等）；减少机械的、冗余代码的管理，使得代码更简洁便于阅读。</p>

<h2>代码生成</h2>

<p>先来了解下整个过程，javac 从 ServiceLoader 获取一个 Processor 标注处理类，判断是否为符合条件的标注，再收集类的相关信息，然后使用 Filer 创建新的类。<a href="http://www.baeldung.com/java-annotation-processing-builder">Java Annotation Processing and Creating a Builder</a> ，<a href="https://liuzhengyang.github.io/2017/10/20/annotation-processing/">java annotation processor</a> 主要涉及到如下三部分：</p>

<ul>
<li>Annotation: @BuilderProperty</li>
<li>Processor: BuilderProcessor</li>
<li><p>Service:</p>

<p>通过google的auto-service来注册服务，最终会在 META-INF/services/ 生成名称为 javax.annotation.processing.Processor 的文件，内容为当前被标注的类名。</p></li>
</ul>


<p>项目的目录结构如下：</p>

<p><img src="/images/blogs/annotation-processor-projects.png" alt="" /></p>

<h3>具体实现：</h3>

<ul>
<li>BuilderProperty 注解</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.github.winse.annotation;
</span><span class='line'>
</span><span class='line'>import java.lang.annotation.ElementType;
</span><span class='line'>import java.lang.annotation.Retention;
</span><span class='line'>import java.lang.annotation.RetentionPolicy;
</span><span class='line'>import java.lang.annotation.Target;
</span><span class='line'>
</span><span class='line'>@Target(ElementType.METHOD)
</span><span class='line'>@Retention(RetentionPolicy.SOURCE)
</span><span class='line'>public @interface BuilderProperty {
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>BuilderProcessor</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.github.winse.processor;
</span><span class='line'>
</span><span class='line'>import com.github.winse.annotation.BuilderProperty;
</span><span class='line'>import com.google.auto.service.AutoService;
</span><span class='line'>
</span><span class='line'>import javax.annotation.processing.*;
</span><span class='line'>import javax.lang.model.SourceVersion;
</span><span class='line'>import javax.lang.model.element.Element;
</span><span class='line'>import javax.lang.model.element.TypeElement;
</span><span class='line'>import javax.lang.model.type.ExecutableType;
</span><span class='line'>import javax.tools.Diagnostic;
</span><span class='line'>import javax.tools.JavaFileObject;
</span><span class='line'>import java.io.IOException;
</span><span class='line'>import java.io.PrintWriter;
</span><span class='line'>import java.util.List;
</span><span class='line'>import java.util.Map;
</span><span class='line'>import java.util.Set;
</span><span class='line'>import java.util.stream.Collectors;
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'> * @see BuilderProperty
</span><span class='line'> */
</span><span class='line'>@SupportedAnnotationTypes("com.github.winse.annotation.BuilderProperty")
</span><span class='line'>@SupportedSourceVersion(SourceVersion.RELEASE_8)
</span><span class='line'>@AutoService(Processor.class)
</span><span class='line'>public class BuilderProcessor extends AbstractProcessor {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv) {
</span><span class='line'>        for (TypeElement annotation : annotations) {
</span><span class='line'>            Set&lt;? extends Element&gt; annotationElements = roundEnv.getElementsAnnotatedWith(annotation);
</span><span class='line'>
</span><span class='line'>            Map&lt;Boolean, List&lt;Element&gt;&gt; annotationMethods = annotationElements.stream()
</span><span class='line'>                    .collect(Collectors.partitioningBy(element -&gt; ((ExecutableType) element.asType()).getParameterTypes().size() == 1 && element.getSimpleName().toString().startsWith("set")));
</span><span class='line'>
</span><span class='line'>            List&lt;Element&gt; setters = annotationMethods.get(true);
</span><span class='line'>            List&lt;Element&gt; otherMethods = annotationMethods.get(false);
</span><span class='line'>
</span><span class='line'>            otherMethods.forEach(element -&gt; processingEnv.getMessager().printMessage(Diagnostic.Kind.ERROR, "@BuildProperty must be applied to a setXxx method with a single argument", element));
</span><span class='line'>
</span><span class='line'>            if (setters.isEmpty()) {
</span><span class='line'>                continue;
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            String className = ((TypeElement) setters.get(0).getEnclosingElement()).getQualifiedName().toString();
</span><span class='line'>
</span><span class='line'>            Map&lt;String, String&gt; setterMap = setters.stream().collect(Collectors.toMap(
</span><span class='line'>                    setter -&gt; setter.getSimpleName().toString(),
</span><span class='line'>                    setter -&gt; ((ExecutableType) setter.asType()).getParameterTypes().get(0).toString()
</span><span class='line'>            ));
</span><span class='line'>
</span><span class='line'>            try {
</span><span class='line'>                writeBuilderType(className, setterMap);
</span><span class='line'>            } catch (IOException e) {
</span><span class='line'>                processingEnv.getMessager().printMessage(Diagnostic.Kind.ERROR, e.getMessage());
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        return true;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private void writeBuilderType(String className, Map&lt;String, String&gt; setterMap) throws IOException {
</span><span class='line'>        String packageName = null;
</span><span class='line'>        int lastDot = className.lastIndexOf(".");
</span><span class='line'>        if (lastDot &gt; 0) {
</span><span class='line'>            packageName = className.substring(0, lastDot);
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        String simpleClassName = className.substring(lastDot + 1);
</span><span class='line'>        String builderClassName = className + "Builder";
</span><span class='line'>        String builderSimpleClassName = builderClassName.substring(lastDot + 1);
</span><span class='line'>
</span><span class='line'>        JavaFileObject builderFile = processingEnv.getFiler().createSourceFile(builderClassName);
</span><span class='line'>        try (PrintWriter out = new PrintWriter(builderFile.openWriter())) {
</span><span class='line'>            if (packageName != null) {
</span><span class='line'>                out.printf("package %s;\n", packageName);
</span><span class='line'>                out.println();
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            out.printf("public class %s {\n", builderSimpleClassName);
</span><span class='line'>            out.println();
</span><span class='line'>            out.printf("  private %s object = new %s();\n", simpleClassName, simpleClassName);
</span><span class='line'>            out.println();
</span><span class='line'>            out.printf("  public %s build() {\n", simpleClassName);
</span><span class='line'>            out.printf("    return object;\n");
</span><span class='line'>            out.printf("  }\n");
</span><span class='line'>            out.println();
</span><span class='line'>
</span><span class='line'>            setterMap.entrySet().forEach(setter -&gt; {
</span><span class='line'>                String methodName = setter.getKey();
</span><span class='line'>                String argumentType = setter.getValue();
</span><span class='line'>
</span><span class='line'>                out.printf("  public %s %s(%s value){\n", builderSimpleClassName, methodName, argumentType);
</span><span class='line'>                out.printf("    object.%s(value);\n", methodName);
</span><span class='line'>                out.printf("    return this;\n");
</span><span class='line'>                out.printf("  }\n");
</span><span class='line'>                out.println();
</span><span class='line'>            });
</span><span class='line'>
</span><span class='line'>            out.printf("}\n");
</span><span class='line'>
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>测试使用：</h3>

<ul>
<li>build.gradle</li>
</ul>


<p>我使用的是4.7的版本，4.7及以上版本可以直接使用 annotationProcessor 来添加标注处理器。（其他版本可以使用 apt 来处理）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>plugins {
</span><span class='line'>    id "net.ltgt.apt" version "0.10"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>sourceSets.main.java.srcDirs += ['build/generated/source/apt/main']
</span><span class='line'>
</span><span class='line'>dependencies {
</span><span class='line'>    compile rootProject
</span><span class='line'>    annotationProcessor project(':compiler')
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Person</li>
</ul>


<p>这是一个POJO类，BuilderProcessor处理器会根据BuilderProperty注解来生成PersonBuilder类。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.github.winse.example;
</span><span class='line'>
</span><span class='line'>import com.github.winse.annotation.BuilderProperty;
</span><span class='line'>
</span><span class='line'>public class Person {
</span><span class='line'>    private int age;
</span><span class='line'>    private String name;
</span><span class='line'>
</span><span class='line'>    @BuilderProperty
</span><span class='line'>    public void setAge(int age) {
</span><span class='line'>        this.age = age;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @BuilderProperty
</span><span class='line'>    public void setName(String name) {
</span><span class='line'>        this.name = name;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public int getAge() {
</span><span class='line'>        return age;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public String getName() {
</span><span class='line'>        return name;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>生成代码效果</h3>

<p>在 gradle 面板中选择子项目 <code>:example</code> ，然后选择 Tasks 下的 build 任务进行构建。构建完后在 <code>example/build/generated/source/apt</code> 目录下生成了对应的 Builder 代码。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.github.winse.example;
</span><span class='line'>
</span><span class='line'>public class PersonBuilder {
</span><span class='line'>
</span><span class='line'>  private Person object = new Person();
</span><span class='line'>
</span><span class='line'>  public Person build() {
</span><span class='line'>    return object;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  public PersonBuilder setName(java.lang.String value){
</span><span class='line'>    object.setName(value);
</span><span class='line'>    return this;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  public PersonBuilder setAge(int value){
</span><span class='line'>    object.setAge(value);
</span><span class='line'>    return this;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h2>注解处理器调试</h2>

<p>不会调试说明还没有真正的入门。并且没有调试的情况下，解决异常、错误也是一件异常痛苦的事情。注解处理器生成代码是在编译阶段来生成代码的，所以调试的选项配置添加到 javac 。而 gradle 提供了一种相对简单的方式来进行。</p>

<p>参考</p>

<ul>
<li><a href="https://stackoverflow.com/questions/8587096/how-do-you-debug-java-annotation-processors-using-intellij">how do you debug java annotation processors using intellij?
</a></li>
<li><a href="https://discuss.gradle.org/t/how-do-you-attach-a-debugger-to-gradle-so-that-i-can-debug-it-running-a-task/7526/5">How do you attach a debugger to gradle so that I can debug it running a task?</a></li>
</ul>


<p>具体步骤如下：</p>

<ol>
<li><p>在命令行运行构建</p>

<p>添加调试参数后，gradle 会 <strong>暂停等待远程调试</strong> ，相当于添加了 JVM 调试参数。<a href="https://docs.gradle.org/current/userguide/build_environment.html#sec:gradle_configuration_properties">Gradle properties</a></p>

<pre><code>hello-annotation-processor\example&gt;gradle clean build --no-daemon -Dorg.gradle.debug=true
或者
hello-annotation-processor&gt;gradle example:clean example:compileJava --no-daemon -Dorg.gradle.debug=true
</code></pre>

<p>注： &ndash;no-daemon 不加也是可以的，但是运行该次构建后不会停止。</p>

<p><img src="/images/blogs/annotation-processor-debug-s1.png" alt="" /></p></li>
<li><p>远程调试</p>

<p><img src="/images/blogs/annotation-processor-debug-s2.png" alt="" /></p></li>
</ol>


<h3>其他调试配置方式</h3>

<ul>
<li><p>通过环境变量</p>

<pre><code>example&gt;set GRADLE_OPTS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005

example&gt;gradle clean build
Listening for transport dt_socket at address: 5005
</code></pre></li>
<li><p>修改 ~/.gradle/gradle.properties</p>

<p>这种方式不推荐，因为它是全局的。</p>

<pre><code>org.gradle.daemon=false
org.gradle.debug=true
</code></pre>

<p>或者</p>

<pre><code>org.gradle.daemon=true
org.gradle.jvmargs=-XX:MaxPermSize=4g -XX:+HeapDumpOnOutOfMemoryError -Xmx4g -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5006

$ gradle --daemon
</code></pre>

<p>Then attach your debugger client to port 5006, set your breakpoint, then run your test.</p>

<p>注：该配置放到项目目录下没用。</p></li>
</ul>


<h2>其他</h2>

<ul>
<li>Gradle参数优化 <a href="https://stackoverflow.com/questions/16775197/building-and-running-app-via-gradle-and-android-studio-is-slower-than-via-eclips/19500539#19500539">Building and running app via Gradle and Android Studio is slower than via Eclipse</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/09/reasonable-way-to-access-the-internet/">科学上网（续）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-06-09T14:03:11+08:00" pubdate data-updated="true">Sat 2018-06-09 14:03</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>到新的环境就会遇到新的问题，需要不断的学习更新来适应新的环境。上网也是一样，工作地点和家里存在了一道鸿沟。过去断断续续的有一些解决的方式，但是总是有点间接。</p>

<ul>
<li><a href="http://www.winseliu.com/blog/2017/11/04/teamviewer-vpn-on-windows/">使用TeamviewerVPN访问公司内网</a></li>
<li><a href="http://www.winseliu.com/blog/2017/02/04/privoxy-http-proxy-for-shadowsocks/">使用Privoxy把shadowsocks转换为Http代理</a></li>
<li><a href="http://www.winseliu.com/blog/2016/03/11/install-and-config-openvpn/">安装配置OpenVPN</a></li>
<li><a href="http://www.winseliu.com/blog/2015/11/22/gfw-ladder/">搭梯笔记</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2011/12/ssh_port_forwarding.html">SSH原理与运用（二）：远程操作与端口转发</a></li>
<li><a href="http://www.winseliu.com/blog/2015/09/06/squid-http-proxy-server-install/">安装http代理服务器squid</a></li>
<li><a href="http://www.winseliu.com/blog/2017/10/30/windows-run-ubuntu/">Windows Run Ubuntu</a></li>
</ul>


<p>上周和同事讨论到在家访问公司服务器的方式时，可以通过花生壳的DDNS来实现域名动态绑定，相当于了把家里的宽带看做一个公网IP，花生壳实时的把域名解析更新为最新的IP。</p>

<p>其实有了公网IP绑定域名后，就可以在公司访问自己的域名（绑定到了家里的IP），公司连自己域名做一个 <em>反向代理</em> ，然后就可以在家直接访问公司的环境了。</p>

<p>但是查了下对于花生壳的口碑都不咋的，其实只要能自动的更新绑定域名和宽带的IP（电信宽带给的是动态IP，使用动态域名绑定），和花生壳的效果是一样。然后在 github 查到了 <code>aliyun-ddns</code> 可以同时定时检测来更新阿里云上的域名解析。</p>

<p>首先通过域名映射到家里电信宽带的公网IP，ddns用来适配电信IP的动态分配； <br/>
然后在家里局域网的一台机器开个SSH的服务；  <br/>
再在家里路由上做端口转发到ssh主机。这样就可以在公司通过 <code>ssh -p port my-domain</code> 连回家了。</p>

<h2>DDNS配置：映射域名到自己的公网IP</h2>

<p><a href="https://github.com/yyqian/aliyun-ddns">aliyun-ddns</a> 老版本有些复杂，我在此基础上一个<a href="https://github.com/winse/aliyun-ddns">本地命令行的版本</a> ，直接运行一个脚本就可以更新域名解析了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./client.sh myhome.winseliu.com</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/blogs/aliyun-dns.png" alt="" /></p>

<p>注：默认电信宽带给你分配的内网IP的，你可以打10000号要他们给你分配改成公网IP。</p>

<h2>本地环境配置</h2>

<ul>
<li>本地SSHD配置</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-ADH7K1Q:~$ sudo dpkg-reconfigure openssh-server
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ sudo service ssh start</span></code></pre></td></tr></table></div></figure>


<ul>
<li>无秘密登录配置</li>
</ul>


<p>为了安全，通过公网的SSH访问最好通过秘钥登录，把SSH密码登录的方式给关掉。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-ADH7K1Q:~/.ssh$ cat /business/server/id_rsa.pub &gt;&gt;authorized_keys</span></code></pre></td></tr></table></div></figure>


<ul>
<li>本机防火墙开放22端口</li>
</ul>


<p>参考 <a href="https://blog.csdn.net/zzq900503/article/details/11936379">开放windows服务器端口&mdash;&ndash;以打开端口8080为例</a></p>

<p><img src="/images/blogs/ddns-local-firewall.png" alt="" /></p>

<ul>
<li>路由器端口映射配置</li>
</ul>


<p><img src="/images/blogs/ddns-route-portforwarding.png" alt="" /></p>

<h2>穿透：配置反向代理</h2>

<p>在公司(机器)访问自己的域名，使用ssh的 <code>-R</code> 反向代理参数连接在家里电脑，在家里电脑新建一个5432的端口绑定(数据转发)到服务器的5432端口。这样当你在家电脑连本地的 <code>127.0.0.1:5432</code> 就相当于连接了服务器的 5432 端口。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/autossh -M 0 -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o StrictHostKeyChecking=no \
</span><span class='line'>-N -R 5432:localhost:5432 -i ~/.ssh/id_rsa autossh@myhome.winseliu.com </span></code></pre></td></tr></table></div></figure>


<p>当autossh连接太慢、并且SSH提示信息一直不出来，你完全有理由怀疑本地端口被占用了！！查看本地端口状态：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>C:\Users\winse&gt;netstat /?
</span><span class='line'>
</span><span class='line'>C:\Users\winse&gt;netstat -ano |findstr 5432</span></code></pre></td></tr></table></div></figure>


<p>如果端口被占用了，需要去任务管理器中关掉对应PID的程序。</p>

<h2>小结</h2>

<p>速度比 teamviewer vpn 的方式快狠多狠多！！这个10000号值得打，这个ddns值得一试。</p>

<h2>后记</h2>

<h3>说说 VS Code调试</h3>

<p>在写脚本bat/sh的过程中，需要用到nodejs的调试。</p>

<p>使用Windows Ubuntu中安装的Node：</p>

<ul>
<li><a href="https://blogs.msdn.microsoft.com/commandline/2017/10/27/running-node-js-on-wsl-from-visual-studio-code/">Running Node.js on WSL from Visual Studio Code</a></li>
<li><a href="https://stackoverflow.com/a/47495710/5697508">Using Visual Studio Code on Windows with Ubuntu-Bash and NodeJS</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"useWSL": true</span></code></pre></td></tr></table></div></figure>


<p><a href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging">https://code.visualstudio.com/docs/nodejs/nodejs-debugging</a></p>

<p>注意：这种外部启动的方式，会通过bash.sh运行node，所以就算停止调试后，Node进程还是一直存在的！！！需要通过任务管理器关闭。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/05/01/heatmap-base-on-baidu/">解读百度的Heatmap</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-05-01T12:26:43+08:00" pubdate data-updated="true">Tue 2018-05-01 12:26</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>前面通过Map的学习，了解到了瓦片的一些知识点。地图里面热图是一个比较典型的功能。通过对聚集数据不同颜色显示，直观形象的洞察数据的规律，比如说高危区等的热点分析，有点类似于arcgis的核密度。接下来结合百度里面的热图分析下它的实现。</p>

<ul>
<li><a href="http://lbsyun.baidu.com/jsdemo/demo/c1_15.htm">热力图功能示例</a></li>
<li><a href="http://desktop.arcgis.com/zh-cn/arcmap/10.3/tools/spatial-analyst-toolbox/differences-between-point-line-and-kernel-density.htm">点密度分析、线密度分析与核密度分析之间的区别</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var points =[
</span><span class='line'>{"lng":116.418261,"lat":39.921984,"count":50},
</span><span class='line'>...
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>//详细的参数,可以查看heatmap.js的文档 https://github.com/pa7/heatmap.js/blob/master/README.md
</span><span class='line'>heatmapOverlay = new BMapLib.HeatmapOverlay({"radius":20});
</span><span class='line'>map.addOverlay(heatmapOverlay);
</span><span class='line'>heatmapOverlay.setDataSet({data:points,max:100});</span></code></pre></td></tr></table></div></figure>


<h2>setDataSet</h2>

<p>把经纬度数据先转成界面的坐标(不在界面bounds内的点会被忽略掉)，然后调用setData</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HeatmapOverlay.prototype.setDataSet = function(data) {
</span><span class='line'>    this.data = data;
</span><span class='line'>    ...
</span><span class='line'>    var currentBounds = this._map.getBounds();
</span><span class='line'>    var mapdata = {
</span><span class='line'>        max: data.max,
</span><span class='line'>        data: []
</span><span class='line'>    };
</span><span class='line'>    var d = data.data,
</span><span class='line'>        dlen = d.length;
</span><span class='line'>        
</span><span class='line'>    while (dlen--) {
</span><span class='line'>        ...
</span><span class='line'>        if (!currentBounds.containsPoint(latlng)) {
</span><span class='line'>            continue;
</span><span class='line'>        }            
</span><span class='line'>        ...
</span><span class='line'>        mapdata.data.push({
</span><span class='line'>            x: point.x,
</span><span class='line'>            y: point.y,
</span><span class='line'>            count: d[dlen].count
</span><span class='line'>        });
</span><span class='line'>    }
</span><span class='line'>    this.heatmap.setData(mapdata);
</span><span class='line'>}
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h2>setData</h2>

<p>计算最大最小，合并（对同一坐标的对应的count值求和），其中 _organiseData 根据坐标构建一个稀疏矩阵，最后emit给renderall</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setData: function(data) {
</span><span class='line'>  var dataPoints = data.data;
</span><span class='line'>  var pointsLen = dataPoints.length;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  // reset data arrays
</span><span class='line'>  this._data = [];
</span><span class='line'>  this._radi = [];
</span><span class='line'>
</span><span class='line'>  for(var i = 0; i &lt; pointsLen; i++) {
</span><span class='line'>    this._organiseData(dataPoints[i], false);
</span><span class='line'>  }
</span><span class='line'>  this._max = data.max;
</span><span class='line'>  this._min = data.min || 0;
</span><span class='line'>  
</span><span class='line'>  this._onExtremaChange();
</span><span class='line'>  this._coordinator.emit('renderall', this._getInternalData());
</span><span class='line'>  return this;
</span><span class='line'>},
</span><span class='line'>
</span><span class='line'>_organiseData: function(dataPoint, forceRender) {
</span><span class='line'>    var x = dataPoint[this._xField];
</span><span class='line'>    var y = dataPoint[this._yField];
</span><span class='line'>    var radi = this._radi;
</span><span class='line'>    var store = this._data;
</span><span class='line'>    var max = this._max;
</span><span class='line'>    var min = this._min;
</span><span class='line'>    var value = dataPoint[this._valueField] || 1;
</span><span class='line'>    var radius = dataPoint.radius || this._cfgRadius || defaultRadius;
</span><span class='line'>    
</span><span class='line'>    ...
</span><span class='line'>    
</span><span class='line'>    if (!store[x][y]) {
</span><span class='line'>      store[x][y] = value;
</span><span class='line'>      radi[x][y] = radius;
</span><span class='line'>    } else {
</span><span class='line'>      store[x][y] += value;
</span><span class='line'>    }
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>_getInternalData: function() {
</span><span class='line'>  return { 
</span><span class='line'>    max: this._max,
</span><span class='line'>    min: this._min, 
</span><span class='line'>    data: this._data,
</span><span class='line'>    radi: this._radi 
</span><span class='line'>  };
</span><span class='line'>},</span></code></pre></td></tr></table></div></figure>


<h2>renderall 渲染</h2>

<p>这个是重点，下面一个步骤一个步骤的讲。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>renderAll: function(data) {
</span><span class='line'>  // reset render boundaries
</span><span class='line'>  this._clear();
</span><span class='line'>  this._drawAlpha(_prepareData(data));
</span><span class='line'>  this._colorize();
</span><span class='line'>},</span></code></pre></td></tr></table></div></figure>


<h3>_prepareData</h3>

<p>把上面合并数据创建的稀疏矩阵，再转回成对象 <code>{ x: ,y: ,value: , radius: }</code> ，然后交给 _drawAlpha 进行画图。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  var _prepareData = function(data) {
</span><span class='line'>    var renderData = [];
</span><span class='line'>    var min = data.min;
</span><span class='line'>    var max = data.max;
</span><span class='line'>    var radi = data.radi;
</span><span class='line'>    var data = data.data;
</span><span class='line'>    
</span><span class='line'>    var xValues = Object.keys(data);
</span><span class='line'>    var xValuesLen = xValues.length;
</span><span class='line'>
</span><span class='line'>    while(xValuesLen--) {
</span><span class='line'>      var xValue = xValues[xValuesLen];
</span><span class='line'>      var yValues = Object.keys(data[xValue]);
</span><span class='line'>      var yValuesLen = yValues.length;
</span><span class='line'>      while(yValuesLen--) {
</span><span class='line'>        var yValue = yValues[yValuesLen];
</span><span class='line'>        var value = data[xValue][yValue];
</span><span class='line'>        var radius = radi[xValue][yValue];
</span><span class='line'>        renderData.push({
</span><span class='line'>          x: xValue,
</span><span class='line'>          y: yValue,
</span><span class='line'>          value: value,
</span><span class='line'>          radius: radius
</span><span class='line'>        });
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return {
</span><span class='line'>      min: min,
</span><span class='line'>      max: max,
</span><span class='line'>      data: renderData
</span><span class='line'>    };
</span><span class='line'>  };</span></code></pre></td></tr></table></div></figure>


<h3>_drawAlpha</h3>

<p>然后根据处理整合后的数据画alpha的圆（由于透明度可以进行叠加处理，shadowCtx.globalAlpha = (value-min)/(max-min); ），同时统计会有数据的最大边界rect。</p>

<p>特定半径的密度衰减圆通过 _getPointTemplate  获得，每个数据以其x,y的坐标为圆心，根据count的百分比叠加模板密度圆的透明度进行绘制。由于透明度的叠加，起到 被影响的点 密度相加的效果。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_drawAlpha: function(data) {
</span><span class='line'>  var min = this._min = data.min;
</span><span class='line'>  var max = this._max = data.max;
</span><span class='line'>  var data = data.data || [];
</span><span class='line'>  var dataLen = data.length;
</span><span class='line'>  // on a point basis?
</span><span class='line'>  var blur = 1 - this._blur;
</span><span class='line'>
</span><span class='line'>  while(dataLen--) {
</span><span class='line'>
</span><span class='line'>    var point = data[dataLen];
</span><span class='line'>
</span><span class='line'>    var x = point.x;
</span><span class='line'>    var y = point.y;
</span><span class='line'>    var radius = point.radius;
</span><span class='line'>    // if value is bigger than max
</span><span class='line'>    // use max as value
</span><span class='line'>    var value = Math.min(point.value, max);
</span><span class='line'>    var rectX = x - radius;
</span><span class='line'>    var rectY = y - radius;
</span><span class='line'>    var shadowCtx = this.shadowCtx;
</span><span class='line'>
</span><span class='line'>    var tpl;
</span><span class='line'>    if (!this._templates[radius]) {
</span><span class='line'>      this._templates[radius] = tpl = _getPointTemplate(radius, blur);
</span><span class='line'>    } else {
</span><span class='line'>      tpl = this._templates[radius];
</span><span class='line'>    }
</span><span class='line'>    // value from minimum / value range
</span><span class='line'>    // =&gt; [0, 1]
</span><span class='line'>    shadowCtx.globalAlpha = (value-min)/(max-min);
</span><span class='line'>
</span><span class='line'>    shadowCtx.drawImage(tpl, rectX, rectY);
</span><span class='line'>
</span><span class='line'>    // update renderBoundaries
</span><span class='line'>    if (rectX &lt; this._renderBoundaries[0]) {
</span><span class='line'>        this._renderBoundaries[0] = rectX;
</span><span class='line'>      } 
</span><span class='line'>      if (rectY &lt; this._renderBoundaries[1]) {
</span><span class='line'>        this._renderBoundaries[1] = rectY;
</span><span class='line'>      }
</span><span class='line'>      if (rectX + 2*radius &gt; this._renderBoundaries[2]) {
</span><span class='line'>        this._renderBoundaries[2] = rectX + 2*radius;
</span><span class='line'>      }
</span><span class='line'>      if (rectY + 2*radius &gt; this._renderBoundaries[3]) {
</span><span class='line'>        this._renderBoundaries[3] = rectY + 2*radius;
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>  }
</span><span class='line'>},
</span></code></pre></td></tr></table></div></figure>


<h3>_colorize</h3>

<p>最后根据rect的边界范围，然后结合palette的颜色条进行染色（palette 是一个 256 * 4（rgba） 的数组）。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>_colorize: function() {
</span><span class='line'>  var x = this._renderBoundaries[0];
</span><span class='line'>  var y = this._renderBoundaries[1];
</span><span class='line'>  var width = this._renderBoundaries[2] - x;
</span><span class='line'>  var height = this._renderBoundaries[3] - y;
</span><span class='line'>  var maxWidth = this._width;
</span><span class='line'>  var maxHeight = this._height;
</span><span class='line'>  var opacity = this._opacity;
</span><span class='line'>  var maxOpacity = this._maxOpacity;
</span><span class='line'>  var minOpacity = this._minOpacity;
</span><span class='line'>  var useGradientOpacity = this._useGradientOpacity;
</span><span class='line'>
</span><span class='line'>  if (x &lt; 0) {
</span><span class='line'>    x = 0;
</span><span class='line'>  }
</span><span class='line'>  if (y &lt; 0) {
</span><span class='line'>    y = 0;
</span><span class='line'>  }
</span><span class='line'>  if (x + width &gt; maxWidth) {
</span><span class='line'>    width = maxWidth - x;
</span><span class='line'>  }
</span><span class='line'>  if (y + height &gt; maxHeight) {
</span><span class='line'>    height = maxHeight - y;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  var img = this.shadowCtx.getImageData(x, y, width, height);
</span><span class='line'>  var imgData = img.data;
</span><span class='line'>  var len = imgData.length;
</span><span class='line'>  var palette = this._palette;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  for (var i = 3; i &lt; len; i+= 4) {
</span><span class='line'>    var alpha = imgData[i];
</span><span class='line'>    var offset = alpha * 4;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    if (!offset) {
</span><span class='line'>      continue;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    var finalAlpha;
</span><span class='line'>    if (opacity &gt; 0) {
</span><span class='line'>      finalAlpha = opacity;
</span><span class='line'>    } else {
</span><span class='line'>      if (alpha &lt; maxOpacity) {
</span><span class='line'>        if (alpha &lt; minOpacity) {
</span><span class='line'>          finalAlpha = minOpacity;
</span><span class='line'>        } else {
</span><span class='line'>          finalAlpha = alpha;
</span><span class='line'>        }
</span><span class='line'>      } else {
</span><span class='line'>        finalAlpha = maxOpacity;
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    imgData[i-3] = palette[offset];
</span><span class='line'>    imgData[i-2] = palette[offset + 1];
</span><span class='line'>    imgData[i-1] = palette[offset + 2];
</span><span class='line'>    imgData[i] = useGradientOpacity ? palette[offset + 3] : finalAlpha;
</span><span class='line'>
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  img.data = imgData;
</span><span class='line'>  this.ctx.putImageData(img, x, y);
</span><span class='line'>
</span><span class='line'>  this._renderBoundaries = [1000, 1000, 0, 0];
</span><span class='line'>
</span><span class='line'>},</span></code></pre></td></tr></table></div></figure>


<p>最终绘制到canvas上，呈现热图效果。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>
  <h1><a class='category' href='/blog/categories/recommend/'>Recommend</a></h1>
	<ul role="list">
		
			<li class="post">
				<a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/08/25/video-auto-translate/">视频自动翻译</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/06/09/reasonable-way-to-access-the-internet/">科学上网（续）</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/01/20/gitalk-on-octopress/">Gitalk on Octopress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/11/16/sphinx-generate-docs/">使用Sphinx生成/管理文档</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/10/30/windows-run-ubuntu/">Windows Run Ubuntu</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/30/kubeadm-install-kubenetes-on-centos7/">Kubeadm部署kubernetes</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/08/casperjs-crawler/">爬虫之CasperJS</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/05/23/spark-on-hive-speculation-shit-bug/">Hive on Spark预测性执行BUG一枚</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/27/vnc-server-on-centos7/">在Centos7上安装VNC Server</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/25/develop-environment-prepare/">[整理] 环境准备工具集</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/19/nginx-https/">Nginx配置https</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/09/19/163-open-movies-download/">批量下载163-open的视频</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/23/hadoop-guide-catalog/">[整理] Hadoop入门</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/04/rpm-build-your-package/">RPM打包</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/03/28/hive-on-spark/">Hive on Spark</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/11/22/gfw-ladder/">搭梯笔记</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/08/24/manual-install-supervisor/">Supervisor安装配置</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/10/16/spark-build-and-configuration/">编译/搭建Spark环境</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/08/25/step-by-step-found-java-oom-error/">查找逐步定位Java程序OOM的异常实践</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/30/hadoop2-snappy-compress/">Hadoop2 Snappy Compress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/27/start-redis/">[读读书]Redis入门指南</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/04/21/hadoop2-windows-startguide/">Windows下部署/配置/调试hadoop2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/30/git-cheatsheet/">GIT操作记录手册</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/18/jekyll-edit-link-in-web-page/">Jekyll页面添加编辑按钮</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/02/23/quickly-open-program-in-windows/">[Windows运行]快速打开程序</a>
			</li>
		
			<li class="post">
				<a href="/blog/2013/09/19/let-shell-command-efficient/">让敲Shell命令高效起来</a>
			</li>
		
	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2021/12/08/octopress-generate-toc/">octopress生成TOC</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/12/08/recommand-blogs/">认真的博客</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/09/15/k2-again/">斐讯K2刷机padavan</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/05/11/redmine-on-arm-pi/">在树莓派上部署redmine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/12/appium-android-auto-test/">appium-Android自动化测试</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/26/android-linux-via-termux/">Android Linux via Termux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/10/try-bk-dot-tencent-dot-com/">Try bk.tencent.com</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/0/'>0</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/alluxio/'>alluxio</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/android/'>android</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/bigdata/'>bigdata</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blabla/'>blabla</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/debug/'>debug</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/deprecated/'>deprecated</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/devops/'>devops</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/es/'>es</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/flume/'>flume</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/git/'>git</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (44) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hbase/'>hbase</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hole/'>hole</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jenkins/'>jenkins</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jeykll/'>jeykll</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k2/'>k2</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (9) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kafka/'>kafka</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kubeadm/'>kubeadm</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/logstash/'>logstash</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/map/'>map</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/recommend/'>recommend</a> (27) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/shell/'>shell</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/staf/'>staf</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tachyon/'>tachyon</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tez/'>tez</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tools/'>tools</a> (69) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/topics/'>topics</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/vagrant/'>vagrant</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/wsl/'>wsl</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/zookeeper/'>zookeeper</a> (1) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (219)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<!--
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
&#8211;>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1253103971'%3E%3C/span%3E%3Cscript src='https://s19.cnzz.com/z_stat.php%3Fid%3D1253103971%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winse.github.io" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>











</body>
</html>
