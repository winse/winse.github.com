
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="Java里面随处可见annotation（注解），RetentionPolicy 指示了注解使用的情况： SOURCE，比如 @Override, @SuppressWarnings
RUNTIME，最熟悉的莫过于Spring Bean中使用的 @Controller, @Service &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winseliu.com/posts/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43198550-1', 'auto');
  ga('send', 'pageview');

</script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停, 熙熙攘攘, 忙忙碌碌, 不知何畏.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winseliu.com" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/10/java-source-annotation-processor/">使用注解生成代码</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-06-10T12:51:39+08:00" pubdate data-updated="true">Sun 2018-06-10 12:51</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Java里面随处可见annotation（注解），RetentionPolicy 指示了注解使用的情况：</p>

<ul>
<li>SOURCE，比如 @Override, @SuppressWarnings</li>
<li>RUNTIME，最熟悉的莫过于Spring Bean中使用的 @Controller, @Service 一般和反射同时使用。</li>
<li>CLASS</li>
</ul>


<p>而 CLASS 则是用于 compile 编译阶段的注解。一个注解的处理器，以Java代码（或编译过的字节码）作为输入，生成Java文件。这些生成的Java文件，会同其他普通的手动编写的Java源代码一样被javac编译。</p>

<p>可以自己实现一些类似groovy语法糖的功能（lombok框架修改bytecode为类生成新方法getter/setter、或者使用生成新的辅助类等）；减少机械的、冗余代码的管理，使得代码更简洁便于阅读。</p>

<h2>代码生成</h2>

<p>先来了解下整个过程，javac 从 ServiceLoader 获取一个 Processor 标注处理类，判断是否为符合条件的标注，再收集类的相关信息，然后使用 Filer 创建新的类。<a href="http://www.baeldung.com/java-annotation-processing-builder">Java Annotation Processing and Creating a Builder</a> ，<a href="https://liuzhengyang.github.io/2017/10/20/annotation-processing/">java annotation processor</a> 主要涉及到如下三部分：</p>

<ul>
<li>Annotation: @BuilderProperty</li>
<li>Processor: BuilderProcessor</li>
<li><p>Service:</p>

<p>通过google的auto-service来注册服务，最终会在 META-INF/services/ 生成名称为 javax.annotation.processing.Processor 的文件，内容为当前被标注的类名。</p></li>
</ul>


<p>项目的目录结构如下：</p>

<p><img src="/images/blogs/annotation-processor-projects.png" alt="" /></p>

<h3>具体实现：</h3>

<ul>
<li>BuilderProperty 注解</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.github.winse.annotation;
</span><span class='line'>
</span><span class='line'>import java.lang.annotation.ElementType;
</span><span class='line'>import java.lang.annotation.Retention;
</span><span class='line'>import java.lang.annotation.RetentionPolicy;
</span><span class='line'>import java.lang.annotation.Target;
</span><span class='line'>
</span><span class='line'>@Target(ElementType.METHOD)
</span><span class='line'>@Retention(RetentionPolicy.SOURCE)
</span><span class='line'>public @interface BuilderProperty {
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>BuilderProcessor</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.github.winse.processor;
</span><span class='line'>
</span><span class='line'>import com.github.winse.annotation.BuilderProperty;
</span><span class='line'>import com.google.auto.service.AutoService;
</span><span class='line'>
</span><span class='line'>import javax.annotation.processing.*;
</span><span class='line'>import javax.lang.model.SourceVersion;
</span><span class='line'>import javax.lang.model.element.Element;
</span><span class='line'>import javax.lang.model.element.TypeElement;
</span><span class='line'>import javax.lang.model.type.ExecutableType;
</span><span class='line'>import javax.tools.Diagnostic;
</span><span class='line'>import javax.tools.JavaFileObject;
</span><span class='line'>import java.io.IOException;
</span><span class='line'>import java.io.PrintWriter;
</span><span class='line'>import java.util.List;
</span><span class='line'>import java.util.Map;
</span><span class='line'>import java.util.Set;
</span><span class='line'>import java.util.stream.Collectors;
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'> * @see BuilderProperty
</span><span class='line'> */
</span><span class='line'>@SupportedAnnotationTypes("com.github.winse.annotation.BuilderProperty")
</span><span class='line'>@SupportedSourceVersion(SourceVersion.RELEASE_8)
</span><span class='line'>@AutoService(Processor.class)
</span><span class='line'>public class BuilderProcessor extends AbstractProcessor {
</span><span class='line'>
</span><span class='line'>    @Override
</span><span class='line'>    public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv) {
</span><span class='line'>        for (TypeElement annotation : annotations) {
</span><span class='line'>            Set&lt;? extends Element&gt; annotationElements = roundEnv.getElementsAnnotatedWith(annotation);
</span><span class='line'>
</span><span class='line'>            Map&lt;Boolean, List&lt;Element&gt;&gt; annotationMethods = annotationElements.stream()
</span><span class='line'>                    .collect(Collectors.partitioningBy(element -&gt; ((ExecutableType) element.asType()).getParameterTypes().size() == 1 && element.getSimpleName().toString().startsWith("set")));
</span><span class='line'>
</span><span class='line'>            List&lt;Element&gt; setters = annotationMethods.get(true);
</span><span class='line'>            List&lt;Element&gt; otherMethods = annotationMethods.get(false);
</span><span class='line'>
</span><span class='line'>            otherMethods.forEach(element -&gt; processingEnv.getMessager().printMessage(Diagnostic.Kind.ERROR, "@BuildProperty must be applied to a setXxx method with a single argument", element));
</span><span class='line'>
</span><span class='line'>            if (setters.isEmpty()) {
</span><span class='line'>                continue;
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            String className = ((TypeElement) setters.get(0).getEnclosingElement()).getQualifiedName().toString();
</span><span class='line'>
</span><span class='line'>            Map&lt;String, String&gt; setterMap = setters.stream().collect(Collectors.toMap(
</span><span class='line'>                    setter -&gt; setter.getSimpleName().toString(),
</span><span class='line'>                    setter -&gt; ((ExecutableType) setter.asType()).getParameterTypes().get(0).toString()
</span><span class='line'>            ));
</span><span class='line'>
</span><span class='line'>            try {
</span><span class='line'>                writeBuilderType(className, setterMap);
</span><span class='line'>            } catch (IOException e) {
</span><span class='line'>                processingEnv.getMessager().printMessage(Diagnostic.Kind.ERROR, e.getMessage());
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        return true;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private void writeBuilderType(String className, Map&lt;String, String&gt; setterMap) throws IOException {
</span><span class='line'>        String packageName = null;
</span><span class='line'>        int lastDot = className.lastIndexOf(".");
</span><span class='line'>        if (lastDot &gt; 0) {
</span><span class='line'>            packageName = className.substring(0, lastDot);
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        String simpleClassName = className.substring(lastDot + 1);
</span><span class='line'>        String builderClassName = className + "Builder";
</span><span class='line'>        String builderSimpleClassName = builderClassName.substring(lastDot + 1);
</span><span class='line'>
</span><span class='line'>        JavaFileObject builderFile = processingEnv.getFiler().createSourceFile(builderClassName);
</span><span class='line'>        try (PrintWriter out = new PrintWriter(builderFile.openWriter())) {
</span><span class='line'>            if (packageName != null) {
</span><span class='line'>                out.printf("package %s;\n", packageName);
</span><span class='line'>                out.println();
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            out.printf("public class %s {\n", builderSimpleClassName);
</span><span class='line'>            out.println();
</span><span class='line'>            out.printf("  private %s object = new %s();\n", simpleClassName, simpleClassName);
</span><span class='line'>            out.println();
</span><span class='line'>            out.printf("  public %s build() {\n", simpleClassName);
</span><span class='line'>            out.printf("    return object;\n");
</span><span class='line'>            out.printf("  }\n");
</span><span class='line'>            out.println();
</span><span class='line'>
</span><span class='line'>            setterMap.entrySet().forEach(setter -&gt; {
</span><span class='line'>                String methodName = setter.getKey();
</span><span class='line'>                String argumentType = setter.getValue();
</span><span class='line'>
</span><span class='line'>                out.printf("  public %s %s(%s value){\n", builderSimpleClassName, methodName, argumentType);
</span><span class='line'>                out.printf("    object.%s(value);\n", methodName);
</span><span class='line'>                out.printf("    return this;\n");
</span><span class='line'>                out.printf("  }\n");
</span><span class='line'>                out.println();
</span><span class='line'>            });
</span><span class='line'>
</span><span class='line'>            out.printf("}\n");
</span><span class='line'>
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>测试使用：</h3>

<ul>
<li>build.gradle</li>
</ul>


<p>我使用的是4.7的版本，4.7及以上版本可以直接使用 annotationProcessor 来添加标注处理器。（其他版本可以使用 apt 来处理）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>plugins {
</span><span class='line'>    id "net.ltgt.apt" version "0.10"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>sourceSets.main.java.srcDirs += ['build/generated/source/apt/main']
</span><span class='line'>
</span><span class='line'>dependencies {
</span><span class='line'>    compile rootProject
</span><span class='line'>    annotationProcessor project(':compiler')
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Person</li>
</ul>


<p>这是一个POJO类，BuilderProcessor处理器会根据BuilderProperty注解来生成PersonBuilder类。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.github.winse.example;
</span><span class='line'>
</span><span class='line'>import com.github.winse.annotation.BuilderProperty;
</span><span class='line'>
</span><span class='line'>public class Person {
</span><span class='line'>    private int age;
</span><span class='line'>    private String name;
</span><span class='line'>
</span><span class='line'>    @BuilderProperty
</span><span class='line'>    public void setAge(int age) {
</span><span class='line'>        this.age = age;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    @BuilderProperty
</span><span class='line'>    public void setName(String name) {
</span><span class='line'>        this.name = name;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public int getAge() {
</span><span class='line'>        return age;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public String getName() {
</span><span class='line'>        return name;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>生成代码效果</h3>

<p>在 gradle 面板中选择子项目 <code>:example</code> ，然后选择 Tasks 下的 build 任务进行构建。构建完后在 <code>example/build/generated/source/apt</code> 目录下生成了对应的 Builder 代码。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.github.winse.example;
</span><span class='line'>
</span><span class='line'>public class PersonBuilder {
</span><span class='line'>
</span><span class='line'>  private Person object = new Person();
</span><span class='line'>
</span><span class='line'>  public Person build() {
</span><span class='line'>    return object;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  public PersonBuilder setName(java.lang.String value){
</span><span class='line'>    object.setName(value);
</span><span class='line'>    return this;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  public PersonBuilder setAge(int value){
</span><span class='line'>    object.setAge(value);
</span><span class='line'>    return this;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h2>注解处理器调试</h2>

<p>不会调试说明还没有真正的入门。并且没有调试的情况下，解决异常、错误也是一件异常痛苦的事情。注解处理器生成代码是在编译阶段来生成代码的，所以调试的选项配置添加到 javac 。而 gradle 提供了一种相对简单的方式来进行。</p>

<p>参考</p>

<ul>
<li><a href="https://stackoverflow.com/questions/8587096/how-do-you-debug-java-annotation-processors-using-intellij">how do you debug java annotation processors using intellij?
</a></li>
<li><a href="https://discuss.gradle.org/t/how-do-you-attach-a-debugger-to-gradle-so-that-i-can-debug-it-running-a-task/7526/5">How do you attach a debugger to gradle so that I can debug it running a task?</a></li>
</ul>


<p>具体步骤如下：</p>

<ol>
<li><p>在命令行运行构建</p>

<p>添加调试参数后，gradle 会 <strong>暂停等待远程调试</strong> ，相当于添加了 JVM 调试参数。<a href="https://docs.gradle.org/current/userguide/build_environment.html#sec:gradle_configuration_properties">Gradle properties</a></p>

<pre><code>hello-annotation-processor\example&gt;gradle clean build --no-daemon -Dorg.gradle.debug=true
或者
hello-annotation-processor&gt;gradle example:clean example:compileJava --no-daemon -Dorg.gradle.debug=true
</code></pre>

<p>注： &ndash;no-daemon 不加也是可以的，但是运行该次构建后不会停止。</p>

<p><img src="/images/blogs/annotation-processor-debug-s1.png" alt="" /></p></li>
<li><p>远程调试</p>

<p><img src="/images/blogs/annotation-processor-debug-s2.png" alt="" /></p></li>
</ol>


<h3>其他调试配置方式</h3>

<ul>
<li><p>通过环境变量</p>

<pre><code>example&gt;set GRADLE_OPTS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005

example&gt;gradle clean build
Listening for transport dt_socket at address: 5005
</code></pre></li>
<li><p>修改 ~/.gradle/gradle.properties</p>

<p>这种方式不推荐，因为它是全局的。</p>

<pre><code>org.gradle.daemon=false
org.gradle.debug=true
</code></pre>

<p>或者</p>

<pre><code>org.gradle.daemon=true
org.gradle.jvmargs=-XX:MaxPermSize=4g -XX:+HeapDumpOnOutOfMemoryError -Xmx4g -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5006

$ gradle --daemon
</code></pre>

<p>Then attach your debugger client to port 5006, set your breakpoint, then run your test.</p>

<p>注：该配置放到项目目录下没用。</p></li>
</ul>


<h2>其他</h2>

<ul>
<li>Gradle参数优化 <a href="https://stackoverflow.com/questions/16775197/building-and-running-app-via-gradle-and-android-studio-is-slower-than-via-eclips/19500539#19500539">Building and running app via Gradle and Android Studio is slower than via Eclipse</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/09/reasonable-way-to-access-the-internet/">科学上网（续）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-06-09T14:03:11+08:00" pubdate data-updated="true">Sat 2018-06-09 14:03</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>到新的环境就会遇到新的问题，需要不断的学习更新来适应新的环境。上网也是一样，工作地点和家里存在了一道鸿沟。过去断断续续的有一些解决的方式，但是总是有点间接。</p>

<ul>
<li><a href="http://www.winseliu.com/blog/2017/11/04/teamviewer-vpn-on-windows/">使用TeamviewerVPN访问公司内网</a></li>
<li><a href="http://www.winseliu.com/blog/2017/02/04/privoxy-http-proxy-for-shadowsocks/">使用Privoxy把shadowsocks转换为Http代理</a></li>
<li><a href="http://www.winseliu.com/blog/2016/03/11/install-and-config-openvpn/">安装配置OpenVPN</a></li>
<li><a href="http://www.winseliu.com/blog/2015/11/22/gfw-ladder/">搭梯笔记</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2011/12/ssh_port_forwarding.html">SSH原理与运用（二）：远程操作与端口转发</a></li>
<li><a href="http://www.winseliu.com/blog/2015/09/06/squid-http-proxy-server-install/">安装http代理服务器squid</a></li>
<li><a href="http://www.winseliu.com/blog/2017/10/30/windows-run-ubuntu/">Windows Run Ubuntu</a></li>
</ul>


<p>上周和同事讨论到在家访问公司服务器的方式时，可以通过花生壳的DDNS来实现域名动态绑定，相当于了把家里的宽带看做一个公网IP，花生壳实时的把域名解析更新为最新的IP。</p>

<p>其实有了公网IP绑定域名后，就可以在公司访问自己的域名（绑定到了家里的IP），公司连自己域名做一个 <em>反向代理</em> ，然后就可以在家直接访问公司的环境了。</p>

<p>但是查了下对于花生壳的口碑都不咋的，其实只要能自动的更新绑定域名和宽带的IP（电信宽带给的是动态IP，使用动态域名绑定），和花生壳的效果是一样。然后在 github 查到了 <code>aliyun-ddns</code> 可以同时定时检测来更新阿里云上的域名解析。</p>

<p>首先通过域名映射到家里电信宽带的公网IP，ddns用来适配电信IP的动态分配； <br/>
然后在家里局域网的一台机器开个SSH的服务；  <br/>
再在家里路由上做端口转发到ssh主机。这样就可以在公司通过 <code>ssh -p port my-domain</code> 连回家了。</p>

<h2>DDNS配置：映射域名到自己的公网IP</h2>

<p><a href="https://github.com/yyqian/aliyun-ddns">aliyun-ddns</a> 老版本有些复杂，我在此基础上一个<a href="https://github.com/winse/aliyun-ddns">本地命令行的版本</a> ，直接运行一个脚本就可以更新域名解析了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./client.sh myhome.winseliu.com</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/blogs/aliyun-dns.png" alt="" /></p>

<p>注：默认电信宽带给你分配的内网IP的，你可以打10000号要他们给你分配改成公网IP。</p>

<h2>本地环境配置</h2>

<ul>
<li>本地SSHD配置</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-ADH7K1Q:~$ sudo dpkg-reconfigure openssh-server
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ sudo service ssh start</span></code></pre></td></tr></table></div></figure>


<ul>
<li>无秘密登录配置</li>
</ul>


<p>为了安全，通过公网的SSH访问最好通过秘钥登录，把SSH密码登录的方式给关掉。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-ADH7K1Q:~/.ssh$ cat /business/server/id_rsa.pub &gt;&gt;authorized_keys</span></code></pre></td></tr></table></div></figure>


<ul>
<li>本机防火墙开放22端口</li>
</ul>


<p>参考 <a href="https://blog.csdn.net/zzq900503/article/details/11936379">开放windows服务器端口&mdash;&ndash;以打开端口8080为例</a></p>

<p><img src="/images/blogs/ddns-local-firewall.png" alt="" /></p>

<ul>
<li>路由器端口映射配置</li>
</ul>


<p><img src="/images/blogs/ddns-route-portforwarding.png" alt="" /></p>

<h2>穿透：配置反向代理</h2>

<p>在公司(机器)访问自己的域名，使用ssh的 <code>-R</code> 反向代理参数连接在家里电脑，在家里电脑新建一个5432的端口绑定(数据转发)到服务器的5432端口。这样当你在家电脑连本地的 <code>127.0.0.1:5432</code> 就相当于连接了服务器的 5432 端口。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/autossh -M 0 -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o StrictHostKeyChecking=no \
</span><span class='line'>-N -R 5432:localhost:5432 -i ~/.ssh/id_rsa autossh@myhome.winseliu.com </span></code></pre></td></tr></table></div></figure>


<p>当autossh连接太慢、并且SSH提示信息一直不出来，你完全有理由怀疑本地端口被占用了！！查看本地端口状态：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>C:\Users\winse&gt;netstat /?
</span><span class='line'>
</span><span class='line'>C:\Users\winse&gt;netstat -ano |findstr 5432</span></code></pre></td></tr></table></div></figure>


<p>如果端口被占用了，需要去任务管理器中关掉对应PID的程序。</p>

<h2>小结</h2>

<p>速度比 teamviewer vpn 的方式快狠多狠多！！这个10000号值得打，这个ddns值得一试。</p>

<h2>后记</h2>

<h3>说说 VS Code调试</h3>

<p>在写脚本bat/sh的过程中，需要用到nodejs的调试。</p>

<p>使用Windows Ubuntu中安装的Node：</p>

<ul>
<li><a href="https://blogs.msdn.microsoft.com/commandline/2017/10/27/running-node-js-on-wsl-from-visual-studio-code/">Running Node.js on WSL from Visual Studio Code</a></li>
<li><a href="https://stackoverflow.com/a/47495710/5697508">Using Visual Studio Code on Windows with Ubuntu-Bash and NodeJS</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"useWSL": true</span></code></pre></td></tr></table></div></figure>


<p><a href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging">https://code.visualstudio.com/docs/nodejs/nodejs-debugging</a></p>

<p>注意：这种外部启动的方式，会通过bash.sh运行node，所以就算停止调试后，Node进程还是一直存在的！！！需要通过任务管理器关闭。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/05/01/heatmap-base-on-baidu/">解读百度的Heatmap</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-05-01T12:26:43+08:00" pubdate data-updated="true">Tue 2018-05-01 12:26</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前面通过Map的学习，了解到了瓦片的一些知识点。地图里面热图是一个比较典型的功能。通过对聚集数据不同颜色显示，直观形象的洞察数据的规律，比如说高危区等的热点分析，有点类似于arcgis的核密度。接下来结合百度里面的热图分析下它的实现。</p>

<ul>
<li><a href="http://lbsyun.baidu.com/jsdemo/demo/c1_15.htm">热力图功能示例</a></li>
<li><a href="http://desktop.arcgis.com/zh-cn/arcmap/10.3/tools/spatial-analyst-toolbox/differences-between-point-line-and-kernel-density.htm">点密度分析、线密度分析与核密度分析之间的区别</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var points =[
</span><span class='line'>{"lng":116.418261,"lat":39.921984,"count":50},
</span><span class='line'>...
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>//详细的参数,可以查看heatmap.js的文档 https://github.com/pa7/heatmap.js/blob/master/README.md
</span><span class='line'>heatmapOverlay = new BMapLib.HeatmapOverlay({"radius":20});
</span><span class='line'>map.addOverlay(heatmapOverlay);
</span><span class='line'>heatmapOverlay.setDataSet({data:points,max:100});</span></code></pre></td></tr></table></div></figure>


<h2>setDataSet</h2>

<p>把经纬度数据先转成界面的坐标(不在界面bounds内的点会被忽略掉)，然后调用setData</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HeatmapOverlay.prototype.setDataSet = function(data) {
</span><span class='line'>    this.data = data;
</span><span class='line'>    ...
</span><span class='line'>    var currentBounds = this._map.getBounds();
</span><span class='line'>    var mapdata = {
</span><span class='line'>        max: data.max,
</span><span class='line'>        data: []
</span><span class='line'>    };
</span><span class='line'>    var d = data.data,
</span><span class='line'>        dlen = d.length;
</span><span class='line'>        
</span><span class='line'>    while (dlen--) {
</span><span class='line'>        ...
</span><span class='line'>        if (!currentBounds.containsPoint(latlng)) {
</span><span class='line'>            continue;
</span><span class='line'>        }            
</span><span class='line'>        ...
</span><span class='line'>        mapdata.data.push({
</span><span class='line'>            x: point.x,
</span><span class='line'>            y: point.y,
</span><span class='line'>            count: d[dlen].count
</span><span class='line'>        });
</span><span class='line'>    }
</span><span class='line'>    this.heatmap.setData(mapdata);
</span><span class='line'>}
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h2>setData</h2>

<p>计算最大最小，合并（对同一坐标的对应的count值求和），其中 _organiseData 根据坐标构建一个稀疏矩阵，最后emit给renderall</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setData: function(data) {
</span><span class='line'>  var dataPoints = data.data;
</span><span class='line'>  var pointsLen = dataPoints.length;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  // reset data arrays
</span><span class='line'>  this._data = [];
</span><span class='line'>  this._radi = [];
</span><span class='line'>
</span><span class='line'>  for(var i = 0; i &lt; pointsLen; i++) {
</span><span class='line'>    this._organiseData(dataPoints[i], false);
</span><span class='line'>  }
</span><span class='line'>  this._max = data.max;
</span><span class='line'>  this._min = data.min || 0;
</span><span class='line'>  
</span><span class='line'>  this._onExtremaChange();
</span><span class='line'>  this._coordinator.emit('renderall', this._getInternalData());
</span><span class='line'>  return this;
</span><span class='line'>},
</span><span class='line'>
</span><span class='line'>_organiseData: function(dataPoint, forceRender) {
</span><span class='line'>    var x = dataPoint[this._xField];
</span><span class='line'>    var y = dataPoint[this._yField];
</span><span class='line'>    var radi = this._radi;
</span><span class='line'>    var store = this._data;
</span><span class='line'>    var max = this._max;
</span><span class='line'>    var min = this._min;
</span><span class='line'>    var value = dataPoint[this._valueField] || 1;
</span><span class='line'>    var radius = dataPoint.radius || this._cfgRadius || defaultRadius;
</span><span class='line'>    
</span><span class='line'>    ...
</span><span class='line'>    
</span><span class='line'>    if (!store[x][y]) {
</span><span class='line'>      store[x][y] = value;
</span><span class='line'>      radi[x][y] = radius;
</span><span class='line'>    } else {
</span><span class='line'>      store[x][y] += value;
</span><span class='line'>    }
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>_getInternalData: function() {
</span><span class='line'>  return { 
</span><span class='line'>    max: this._max,
</span><span class='line'>    min: this._min, 
</span><span class='line'>    data: this._data,
</span><span class='line'>    radi: this._radi 
</span><span class='line'>  };
</span><span class='line'>},</span></code></pre></td></tr></table></div></figure>


<h2>renderall 渲染</h2>

<p>这个是重点，下面一个步骤一个步骤的讲。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>renderAll: function(data) {
</span><span class='line'>  // reset render boundaries
</span><span class='line'>  this._clear();
</span><span class='line'>  this._drawAlpha(_prepareData(data));
</span><span class='line'>  this._colorize();
</span><span class='line'>},</span></code></pre></td></tr></table></div></figure>


<h3>_prepareData</h3>

<p>把上面合并数据创建的稀疏矩阵，再转回成对象 <code>{ x: ,y: ,value: , radius: }</code> ，然后交给 _drawAlpha 进行画图。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  var _prepareData = function(data) {
</span><span class='line'>    var renderData = [];
</span><span class='line'>    var min = data.min;
</span><span class='line'>    var max = data.max;
</span><span class='line'>    var radi = data.radi;
</span><span class='line'>    var data = data.data;
</span><span class='line'>    
</span><span class='line'>    var xValues = Object.keys(data);
</span><span class='line'>    var xValuesLen = xValues.length;
</span><span class='line'>
</span><span class='line'>    while(xValuesLen--) {
</span><span class='line'>      var xValue = xValues[xValuesLen];
</span><span class='line'>      var yValues = Object.keys(data[xValue]);
</span><span class='line'>      var yValuesLen = yValues.length;
</span><span class='line'>      while(yValuesLen--) {
</span><span class='line'>        var yValue = yValues[yValuesLen];
</span><span class='line'>        var value = data[xValue][yValue];
</span><span class='line'>        var radius = radi[xValue][yValue];
</span><span class='line'>        renderData.push({
</span><span class='line'>          x: xValue,
</span><span class='line'>          y: yValue,
</span><span class='line'>          value: value,
</span><span class='line'>          radius: radius
</span><span class='line'>        });
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return {
</span><span class='line'>      min: min,
</span><span class='line'>      max: max,
</span><span class='line'>      data: renderData
</span><span class='line'>    };
</span><span class='line'>  };</span></code></pre></td></tr></table></div></figure>


<h3>_drawAlpha</h3>

<p>然后根据处理整合后的数据画alpha的圆（由于透明度可以进行叠加处理，shadowCtx.globalAlpha = (value-min)/(max-min); ），同时统计会有数据的最大边界rect。</p>

<p>特定半径的密度衰减圆通过 _getPointTemplate  获得，每个数据以其x,y的坐标为圆心，根据count的百分比叠加模板密度圆的透明度进行绘制。由于透明度的叠加，起到 被影响的点 密度相加的效果。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_drawAlpha: function(data) {
</span><span class='line'>  var min = this._min = data.min;
</span><span class='line'>  var max = this._max = data.max;
</span><span class='line'>  var data = data.data || [];
</span><span class='line'>  var dataLen = data.length;
</span><span class='line'>  // on a point basis?
</span><span class='line'>  var blur = 1 - this._blur;
</span><span class='line'>
</span><span class='line'>  while(dataLen--) {
</span><span class='line'>
</span><span class='line'>    var point = data[dataLen];
</span><span class='line'>
</span><span class='line'>    var x = point.x;
</span><span class='line'>    var y = point.y;
</span><span class='line'>    var radius = point.radius;
</span><span class='line'>    // if value is bigger than max
</span><span class='line'>    // use max as value
</span><span class='line'>    var value = Math.min(point.value, max);
</span><span class='line'>    var rectX = x - radius;
</span><span class='line'>    var rectY = y - radius;
</span><span class='line'>    var shadowCtx = this.shadowCtx;
</span><span class='line'>
</span><span class='line'>    var tpl;
</span><span class='line'>    if (!this._templates[radius]) {
</span><span class='line'>      this._templates[radius] = tpl = _getPointTemplate(radius, blur);
</span><span class='line'>    } else {
</span><span class='line'>      tpl = this._templates[radius];
</span><span class='line'>    }
</span><span class='line'>    // value from minimum / value range
</span><span class='line'>    // =&gt; [0, 1]
</span><span class='line'>    shadowCtx.globalAlpha = (value-min)/(max-min);
</span><span class='line'>
</span><span class='line'>    shadowCtx.drawImage(tpl, rectX, rectY);
</span><span class='line'>
</span><span class='line'>    // update renderBoundaries
</span><span class='line'>    if (rectX &lt; this._renderBoundaries[0]) {
</span><span class='line'>        this._renderBoundaries[0] = rectX;
</span><span class='line'>      } 
</span><span class='line'>      if (rectY &lt; this._renderBoundaries[1]) {
</span><span class='line'>        this._renderBoundaries[1] = rectY;
</span><span class='line'>      }
</span><span class='line'>      if (rectX + 2*radius &gt; this._renderBoundaries[2]) {
</span><span class='line'>        this._renderBoundaries[2] = rectX + 2*radius;
</span><span class='line'>      }
</span><span class='line'>      if (rectY + 2*radius &gt; this._renderBoundaries[3]) {
</span><span class='line'>        this._renderBoundaries[3] = rectY + 2*radius;
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>  }
</span><span class='line'>},
</span></code></pre></td></tr></table></div></figure>


<h3>_colorize</h3>

<p>最后根据rect的边界范围，然后结合palette的颜色条进行染色（palette 是一个 256 * 4（rgba） 的数组）。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>_colorize: function() {
</span><span class='line'>  var x = this._renderBoundaries[0];
</span><span class='line'>  var y = this._renderBoundaries[1];
</span><span class='line'>  var width = this._renderBoundaries[2] - x;
</span><span class='line'>  var height = this._renderBoundaries[3] - y;
</span><span class='line'>  var maxWidth = this._width;
</span><span class='line'>  var maxHeight = this._height;
</span><span class='line'>  var opacity = this._opacity;
</span><span class='line'>  var maxOpacity = this._maxOpacity;
</span><span class='line'>  var minOpacity = this._minOpacity;
</span><span class='line'>  var useGradientOpacity = this._useGradientOpacity;
</span><span class='line'>
</span><span class='line'>  if (x &lt; 0) {
</span><span class='line'>    x = 0;
</span><span class='line'>  }
</span><span class='line'>  if (y &lt; 0) {
</span><span class='line'>    y = 0;
</span><span class='line'>  }
</span><span class='line'>  if (x + width &gt; maxWidth) {
</span><span class='line'>    width = maxWidth - x;
</span><span class='line'>  }
</span><span class='line'>  if (y + height &gt; maxHeight) {
</span><span class='line'>    height = maxHeight - y;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  var img = this.shadowCtx.getImageData(x, y, width, height);
</span><span class='line'>  var imgData = img.data;
</span><span class='line'>  var len = imgData.length;
</span><span class='line'>  var palette = this._palette;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  for (var i = 3; i &lt; len; i+= 4) {
</span><span class='line'>    var alpha = imgData[i];
</span><span class='line'>    var offset = alpha * 4;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    if (!offset) {
</span><span class='line'>      continue;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    var finalAlpha;
</span><span class='line'>    if (opacity &gt; 0) {
</span><span class='line'>      finalAlpha = opacity;
</span><span class='line'>    } else {
</span><span class='line'>      if (alpha &lt; maxOpacity) {
</span><span class='line'>        if (alpha &lt; minOpacity) {
</span><span class='line'>          finalAlpha = minOpacity;
</span><span class='line'>        } else {
</span><span class='line'>          finalAlpha = alpha;
</span><span class='line'>        }
</span><span class='line'>      } else {
</span><span class='line'>        finalAlpha = maxOpacity;
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    imgData[i-3] = palette[offset];
</span><span class='line'>    imgData[i-2] = palette[offset + 1];
</span><span class='line'>    imgData[i-1] = palette[offset + 2];
</span><span class='line'>    imgData[i] = useGradientOpacity ? palette[offset + 3] : finalAlpha;
</span><span class='line'>
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  img.data = imgData;
</span><span class='line'>  this.ctx.putImageData(img, x, y);
</span><span class='line'>
</span><span class='line'>  this._renderBoundaries = [1000, 1000, 0, 0];
</span><span class='line'>
</span><span class='line'>},</span></code></pre></td></tr></table></div></figure>


<p>最终绘制到canvas上，呈现热图效果。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/07/java-webstart-jnlp-with-jvmti/">WebStart的使用以及如何结合JVMTI</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-04-07T00:36:47+08:00" pubdate data-updated="true">Sat 2018-04-07 00:36</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>当新技术叠加老功能时总能把人折磨一番，新仇加旧恨，原本的老功能也不是熟到透，然后还得去结合新功能，真的简直要人命。</p>

<p>最近有上新功能，把Swing客户端的代码通过webstart的方式发布给客户用，这样用户只需要点击网页上的链接，就可以使用Swing客户端了。感觉体验上还是厉害不少的，只是感觉啊！现实往往更残酷，我们先避开不谈。</p>

<p>首先简单的介绍下webstart、jnlp的一些知识，然后讲讲怎么结合jvmti、以及过程中遇到问题时定位查找解决的一些小知识点。</p>

<h2>JNLP</h2>

<p>为了便于借鉴参考，我这里用的是 <code>jre1.8.0_162</code></p>

<ul>
<li>docs <a href="https://docs.oracle.com/javase/tutorial/deployment/webstart/developing.html">https://docs.oracle.com/javase/tutorial/deployment/webstart/developing.html</a></li>
<li>example <a href="https://docs.oracle.com/javase/tutorial/deployment/webstart/running.html">https://docs.oracle.com/javase/tutorial/deployment/webstart/running.html</a></li>
<li>syntax <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/javaws/developersguide/syntax.html">https://docs.oracle.com/javase/8/docs/technotes/guides/javaws/developersguide/syntax.html</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/opensource/os-ecl-rcpws/index.html">使用 WebStart 发布 RCP 应用程序</a></li>
<li><a href="http://javatechniques.com/blog/launching-java-webstart-from-the-command-line/">Launching Java WebStart from the Command Line</a></li>
</ul>


<p><strong> 签名： </strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>jarsigner.exe -keystore Keystore application.jar alias</span></code></pre></td></tr></table></div></figure>


<p><strong> 说说调试： </strong></p>

<ul>
<li>首先你得安装jre，不然Windows的控制面板没有Java这一项！</li>
<li>然后打开 <code>Java控制面板 - 高级 - 调试</code> 的选项。刚开始调试可以同时把 <code>Java控制台</code> 也显示出来</li>
<li>远程调试 选项在 <code>Java控制面板 - Java - Java运行时环境设置 - 运行时参数</code> 添加！</li>
</ul>


<p>参考</p>

<ul>
<li><a href="https://stackoverflow.com/questions/26668723/remote-debugging-java-web-start-under-jvm-1-8">Remote debugging java web start under JVM 1.8</a></li>
<li>Development Tips <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/plugin004.html">https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/plugin004.html</a></li>
<li>Configuration Problems <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/plugin001.html">https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/plugin001.html</a></li>
<li><a href="https://docs.oracle.com/javase/1.5.0/docs/guide/javaws/developersguide/troubleshooting.03.06.html">https://docs.oracle.com/javase/1.5.0/docs/guide/javaws/developersguide/troubleshooting.03.06.html</a></li>
<li><a href="https://stackoverflow.com/questions/686061/how-can-i-debug-applications-under-java-web-start-jnlp">How can I debug applications under Java Web Start (JNLP)?</a></li>
<li><a href="https://blackboard.secure.force.com/publickbarticleview?id=kA770000000CbHX">Java - Associating JNLP files on Windows without using the Control Panel</a></li>
</ul>


<p><strong> 缓冲： </strong></p>

<p>目录</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>C:\Users\winse\AppData\LocalLow\Sun\Java\Deployment</span></code></pre></td></tr></table></div></figure>


<p>调出 <em>Java高速缓冲查看器</em> 界面</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>javaws -viewer</span></code></pre></td></tr></table></div></figure>


<p><strong> 证书： </strong></p>

<p>证书是用jre对应目录下的： jre1.8.0_162\lib\security\cacerts</p>

<ul>
<li><a href="https://blogs.oracle.com/jtc/installing-trusted-certificates-into-a-java-keystore">Installing Trusted Certificates into a Java Keystore</a></li>
<li><a href="https://stackoverflow.com/questions/10077714/adding-certificate-to-keystore-using-java-code">Adding certificate to keystore using java code</a></li>
<li><a href="https://stackoverflow.com/questions/4325263/how-to-import-a-cer-certificate-into-a-java-keystore">How to import a .cer certificate into a java keystore?</a></li>
<li><a href="https://web.archive.org/web/20130319003303/http://dzone.com/snippets/ssl-download-certificate-chain">SSL : Download Certificate Chain From A Remote Host And Add The Certificates To A Local Keystore</a></li>
</ul>


<h2>结合JVMTI（仇恨点）</h2>

<p>既然都是agent，那么加载时机也同样有<strong>两种</strong>：启动时（Agent_OnLoad）和运行时Attach（Agent_OnAttach）。</p>

<ul>
<li><a href="http://www.fanyilun.me/2017/07/18/%E8%B0%88%E8%B0%88Java%20Intrumentation%E5%92%8C%E7%9B%B8%E5%85%B3%E5%BA%94%E7%94%A8/">谈谈Java Intrumentation和相关应用</a></li>
<li><a href="http://www.cnblogs.com/lancao008/archive/2012/03/29/2423469.html">基于jvmti方式加密java</a></li>
<li><a href="https://blog.csdn.net/ooppookid/article/details/51809545">Java千百问<em>08JDK详解（013）</em>JVMTI是什么</a></li>
<li><a href="http://www.cnblogs.com/princessd8251/articles/5177698.html">动态替换目标进程的Java类</a></li>
</ul>


<p><strong> 动态loadAgent </strong></p>

<ul>
<li><a href="https://liuzhengyang.github.io/2017/10/21/dynamic-attach-jvm/">dynamic-attach-jvm</a></li>
</ul>


<p><strong> 修改加载 动态链接库dll 的方式： </strong></p>

<p>默认是不能在程序里面动态修改加载库地址的 <a href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=4280189">JDK-4280189 : loadLibrary() fails to load a shared lib whose path is in java.library.path</a> 。</p>

<ol>
<li>修改环境变量PATH，-Djava.library.path</li>
<li>运行时动态修改java.library.path：usr_paths/sys_paths</li>
<li>把dll拷贝到环境变量PATH的一个路径下面</li>
</ol>


<p>参考</p>

<ul>
<li><a href="https://dzone.com/articles/jni-java-web-start-applet">JNI in Java Web Start / Applet environment</a></li>
<li><a href="https://www.chilkatsoft.com/java-loadlibrary-windows.asp">How to Load a Java Native/Dynamic Library (DLL)</a></li>
<li><a href="http://www.cnblogs.com/princessd8251/articles/5177698.html">动态替换目标进程的Java类</a></li>
</ul>


<p><strong> 解决 DLL依赖 问题的终极完美方法： </strong></p>

<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/7d83bc18.aspx">Search Path Used by Windows to Locate a DLL</a></li>
</ul>


<blockquote><ol>
<li>The directory where the executable module for the current process is located.</li>
<li>The current directory.</li>
<li>The Windows system directory. The GetSystemDirectory function retrieves the path of this directory.</li>
<li>The Windows directory. The GetWindowsDirectory function retrieves the path of this directory.</li>
<li>The directories listed in the PATH environment variable.</li>
</ol>
</blockquote>

<ul>
<li><a href="https://stackoverflow.com/questions/518228/is-it-possible-to-add-a-directory-to-dll-search-path-from-a-batch-file-or-cmd-sc">Is it possible to add a directory to DLL search path from a batch file or cmd script?</a></li>
<li><a href="https://rgrzywinski.wordpress.com/2006/03/27/cant-find-dependent-libraries/">Can’t find dependent libraries</a></li>
</ul>


<blockquote><p>You might need to use something such as Dependency Walker to trace the set of DLL dependencies.</p></blockquote>

<p>把所有的库全部按依赖顺序执行一遍 System.loadLibrary ！！</p>

<p><strong> com.sun.tools.attach.AttachNotSupportedException: no providers installed </strong></p>

<ul>
<li><a href="http://www.chenjianjx.com/myblog/entry/com-sun-tools-attach-attachnotsupportedexception">http://www.chenjianjx.com/myblog/entry/com-sun-tools-attach-attachnotsupportedexception</a></li>
</ul>


<blockquote><ol>
<li>你没有使用sun jdk</li>
<li>你使用了sun jdk，并且JAVA_HOME指向了这个jdk，但是你的path下的&#8221;java&#8221;命令不是这个jdk里面的java，而是操作系统给你默认安装的jre下的，如c:\Program Files\java..</li>
</ol>
</blockquote>

<h2>小结</h2>

<p>最傻瓜式的点击就能运行是最佳体验，我们暂时不能通过控制面板添加 <code>-agentlib:lib</code> 的方式来初始化JVMTI。最终通过以上添加tools.jar的VirtualMachine.loadAgentLibrary运行时attach方式来实现。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/01/30/map-started-guide/">Map入门指南</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-01-30T13:37:51+08:00" pubdate data-updated="true">Tue 2018-01-30 13:37</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近了解了一些Map地图相关的知识点，把学习的资料罗列一下：</p>

<h2>坐标体系</h2>

<ul>
<li><a href="http://lbsyun.baidu.com/index.php?title=coordinate">坐标系</a></li>
<li><a href="http://outdoor.farig.net/help/livemapset.php">http://outdoor.farig.net/help/livemapset.php</a></li>
</ul>


<p>说明：</p>

<ul>
<li>WGS84：为一种大地坐标系，也是目前广泛使用的GPS全球卫星定位系统使用的坐标系。标准的Web墨卡托投影坐标系。</li>
<li>GCJ02：又称火星坐标系，是由中国国家测绘局制定的地理坐标系统，是由WGS84加密后得到的坐标系。指中国国家测绘局制订的加偏Web墨卡托投影，正式名称为GCJ-02，国内可用的地图多数属于这种坐标系。</li>
<li>BD09：为百度坐标系，在GCJ02坐标系基础上再次加密。其中bd09ll表示百度经纬度坐标，bd09mc表示百度墨卡托米制坐标。</li>
</ul>


<h4>地图API</h4>

<p>百度</p>

<ul>
<li><a href="http://api.map.baidu.com/lbsapi/getpoint/index.html">拾取坐标系统</a></li>
<li><a href="http://developer.51cto.com/art/201110/298662.htm">百度地图API开发指南</a></li>
<li><a href="http://developer.baidu.com/map/jsdemo.htm#i8_1">浏览器定位</a></li>
<li><a href="http://lbsyun.baidu.com/cms/jsapi/reference/jsapi_reference.html#a6b0">API v2.0 TileLayer</a></li>
<li><a href="http://lbsyun.baidu.com/cms/jsapi/reference/jsapi_reference.html#a0b0">API v2.0 Map</a></li>
</ul>


<p>腾讯</p>

<ul>
<li><a href="http://lbs.qq.com/tool/getpoint/index.html">坐标拾取器</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/guide-start.html">http://lbs.qq.com/javascript_v2/guide-start.html</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/demo.html">http://lbs.qq.com/javascript_v2/demo.html</a></li>
<li><a href="http://lbs.qq.com/webservice_v1/guide-gcoder.html">API 逆地址解析(坐标位置描述)</a></li>
<li><a href="http://lbs.qq.com/static_v2/guide-getImage.html">http://lbs.qq.com/static_v2/guide-getImage.html</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-geocoding-reverse">地址反查（坐标查位置）：逆地址解析</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-event-latlng">鼠标移动显示地图坐标信息</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-event-center">拖动地图显示地图中心坐标信息</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-search-circlebounds">周边（圆形区域）检索</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/sample/sample-search-circlebounds.html">http://lbs.qq.com/javascript_v2/sample/sample-search-circlebounds.html</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/doc/maptype.html">http://lbs.qq.com/javascript_v2/doc/maptype.html</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/doc/projection.html">http://lbs.qq.com/javascript_v2/doc/projection.html</a></li>
</ul>


<p>高德</p>

<ul>
<li><a href="http://lbs.amap.com/console/show/picker">坐标获取</a></li>
<li><a href="http://lbs.amap.com/api">http://lbs.amap.com/api</a></li>
<li><a href="https://lbs.amap.com/api/javascript-api/example/geocoder/regeocoding?demo">逆向地理编码（坐标-地址）</a></li>
</ul>


<p>国内其他</p>

<ul>
<li><a href="http://lbs.tianditu.com/server/search.html">http://lbs.tianditu.com/server/search.html</a></li>
</ul>


<p>Google</p>

<ul>
<li><a href="https://www.google.com/maps">获取地理位置的经纬度</a>直接搜就行了</li>
<li><a href="https://support.google.com/maps/answer/18539?co=GENIE.Platform%3DDesktop&amp;hl=zh-Hans">https://support.google.com/maps/answer/18539?co=GENIE.Platform%3DDesktop&amp;hl=zh-Hans</a></li>
<li><a href="https://developers.google.cn/maps/documentation/geocoding/intro?hl=zh-cn#GeocodingResponses">地理编码转换</a></li>
</ul>


<p>NOTE: Google的在Java里面用需要指定证书和代理：</p>

<ul>
<li><a href="https://stackoverflow.com/questions/120797/how-do-i-set-the-proxy-to-be-used-by-the-jvm">https://stackoverflow.com/questions/120797/how-do-i-set-the-proxy-to-be-used-by-the-jvm</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html">https://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html</a></li>
</ul>


<p>网页访问一次，把geo的CA证书保存到本地，然后导入到本地的证书库，加入到应用得启动参数里面：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>keytool -import -rfc -v -alias geo_ca -keystore truststore -file geo.cer
</span><span class='line'>
</span><span class='line'>java -Djava.net.useSystemProxies=true -Djavax.net.ssl.trustStore=.\security\truststore </span></code></pre></td></tr></table></div></figure>


<h4>各坐标系间的转换</h4>

<p>Example:</p>

<ul>
<li><a href="http://developer.baidu.com/map/jsdemo.htm#a5_1">google坐标转成百度坐标</a></li>
<li><a href="http://developer.baidu.com/map/jsdemo.htm#a5_2">原始坐标转成百度坐标</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-convertor-library">转换百度坐标为腾讯坐标</a></li>
</ul>


<p>坐标转换代码：</p>

<ul>
<li><a href="https://github.com/wandergis/coordtransform">https://github.com/wandergis/coordtransform</a></li>
</ul>


<h4>比例尺</h4>

<p>百度</p>

<ul>
<li><a href="http://lbsyun.baidu.com/index.php?title=jspopular/guide/widget">http://lbsyun.baidu.com/index.php?title=jspopular/guide/widget</a></li>
<li><a href="http://developer.baidu.com/map/jsdemo.htm#f0_4">http://developer.baidu.com/map/jsdemo.htm#f0_4</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>map.addControl(new BMap.ScaleControl());
</span><span class='line'>map.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
</span><span class='line'>map.enableContinuousZoom();    //启用地图惯性拖拽，默认禁用</span></code></pre></td></tr></table></div></figure>


<p>左下角标注的尺寸包括一个数字加一条线段，就是地图上与<strong>那条线等长的距离</strong>的实际距离为数字表示的长度。假设长度为一厘米，那就是说那一厘米在地图上同等长度实际是20m的距离，比例为1:2000。</p>

<p>在百度地图API中，平面坐标是以最大级别18级为基准的。就是说在<strong>18级平面坐标的一个单位就代表了屏幕上的1个像素</strong> （详细的内容后面讲，可以参考<a href="https://my.oschina.net/bv10000/blog/644520">百度地图API详解之地图坐标系统</a>）。</p>

<p>Android里面计算百度比例尺的方式：取两个点获取它们的经纬度，然后算两个点之间的距离。</p>

<ul>
<li><a href="http://blog.csdn.net/mnorst/article/details/12975413">百度地图和谷歌地图的比例尺和分辨率</a></li>
<li><a href="http://blog.csdn.net/mad1989/article/details/9361983">百度、google、高德 地图比例尺功能实现</a></li>
</ul>


<p>NOTE: 百度地图SDK还提供了标注工具(PushpinTool)，测距工具(DistanceTool)。</p>

<p>Google</p>

<ul>
<li>通过手动算出各级的比例尺 <a href="http://www.360doc.com/content/15/0319/13/9009195_456410364.shtml">http://www.360doc.com/content/15/0319/13/9009195_456410364.shtml</a></li>
</ul>


<p>Bing</p>

<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/aa940990.aspx">https://msdn.microsoft.com/en-us/library/aa940990.aspx</a></li>
<li><a href="https://blogs.bing.com/maps/2006/02/25/map-control-zoom-levels-gt-resolution">https://blogs.bing.com/maps/2006/02/25/map-control-zoom-levels-gt-resolution</a></li>
</ul>


<h2>深入了解地图 - 瓦片</h2>

<ul>
<li><a href="https://my.oschina.net/bv10000/blog/644520">百度地图API详解之地图坐标系统</a> <a href="http://www.jiazhengblog.com/blog/2011/07/02/289/">##</a></li>
<li><a href="https://segmentfault.com/a/1190000011276788">瓦片地图原理</a></li>
<li><a href="https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames">Mercator projection</a></li>
<li><a href="http://cntchen.github.io/2016/05/09/%E5%9B%BD%E5%86%85%E4%B8%BB%E8%A6%81%E5%9C%B0%E5%9B%BE%E7%93%A6%E7%89%87%E5%9D%90%E6%A0%87%E7%B3%BB%E5%AE%9A%E4%B9%89%E5%8F%8A%E8%AE%A1%E7%AE%97%E5%8E%9F%E7%90%86/">国内主要地图瓦片坐标系定义及计算原理</a></li>
<li><a href="http://blog.csdn.net/evkj2013/article/details/12855889">OpenStreetMap/Google/百度/Bing瓦片地图服务(TMS) </a></li>
<li><a href="http://blog.csdn.net/mygisforum/article/details/7582449">Google 地图切片URL地址解析 </a></li>
<li><a href="http://blog.csdn.net/mygisforum/article/details/8162751">Tiles à la Google Maps: Coordinates, Tile Bounds and Projection</a></li>
<li><a href="http://blog.csdn.net/mygisforum/article/details/22997879">腾讯与百度地图瓦片规则分析</a></li>
<li><a href="http://cntchen.github.io/2016/05/09/%E7%99%BE%E5%BA%A6JavaScirpt%20%20API%E4%B8%AD%E7%BB%8F%E7%BA%AC%E5%BA%A6%E5%9D%90%E6%A0%87%E8%BD%AC%E7%93%A6%E7%89%87%E5%9D%90%E6%A0%87bug/">百度JavaScript API中经纬度坐标转瓦片坐标bug</a></li>
<li><a href="http://blog.csdn.net/fredricen/article/details/77189453">2017版高德地图瓦片分析</a></li>
</ul>


<p>各种tile的地址路径</p>

<ul>
<li><a href="https://github.com/CntChen/tile-lnglat-transform">https://github.com/CntChen/tile-lnglat-transform</a></li>
<li>各种tile的地址路径 <a href="https://github.com/brandonxiang/MapViewer/blob/master/app.js">https://github.com/brandonxiang/MapViewer/blob/master/app.js</a></li>
<li><a href="https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames#Java">https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames#Java</a></li>
</ul>


<p><a href="http://apis.map.qq.com/jsapi?qt=translate&amp;type=3&amp;points=113.338191,23.138992&amp;output=jsonp&amp;pf=jsapi&amp;ref=jsapi&amp;cb=qq.maps._svcb3.cbjcznrony1">腾讯&#8221;矢量&#8221;地图 - 通过JSON传数据画Canvas</a></p>

<h2>国内百度腾讯网页端的实现</h2>

<p>现在的地图基本都是使用瓦片技术，计算步骤如下:</p>

<ul>
<li>首先，根据投影（墨卡托投影）把 经纬度（度） 转成 平面坐标（m）；</li>
<li>然后，更具比例尺把 平面坐标 转成 像素坐标；</li>
<li>最后，根据坐标的平移把窗口内的瓦片从服务端下载并进行展示。</li>
</ul>


<p>通过JS代码了解地图的实现：</p>

<h4>百度</h4>

<p>打开一个百度的应用 <a href="http://api.map.baidu.com/lbsapi/getpoint/index.html">http://api.map.baidu.com/lbsapi/getpoint/index.html</a> 然后在调试窗口运行转换经纬度的代码，然后进到对应的代码，打断点，然后艰辛进行与混淆的代码死磕！</p>

<p><img src="/images/blogs/baidu-map-debug.png" alt="" /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var projection =new BMap.MercatorProjection();
</span><span class='line'>var point = projection.lngLatToPoint(new BMap.Point(113.338191,23.138992));
</span><span class='line'>point
</span><span class='line'>Q {x: 12616886.99, y: 2631894}
</span><span class='line'>
</span><span class='line'>var projection =new BMap.MercatorProjection();
</span><span class='line'>var point = projection.pointToLngLat(new BMap.Pixel(12616886.99,2631894));
</span><span class='line'>point
</span><span class='line'>H {lng: 113.338191, lat: 23.138992}
</span></code></pre></td></tr></table></div></figure>


<p>从代码上看还是不难的，但是里面有一堆魔法数字完全不懂。</p>

<p>如果仅仅获取瓦片 <a href="https://github.com/CntChen/tile-lnglat-transform/">https://github.com/CntChen/tile-lnglat-transform/</a> 推荐使用这个项目。</p>

<p>这里仅仅是经纬度转换为平面坐标(m)的过程。我们在源码中查找 getTilesUrl 在5901行打个断点，然后在回到网页，移动一下地图。接下来，就可以调试整个过程了。</p>

<p><img src="/images/blogs/baidu-map-getTilesUrl.png" alt="" /></p>

<p>注意标识的两处，是进行层级缩放、计算出瓦片编号的代码。</p>

<h4>腾讯</h4>

<p>看过了百度的，再看腾讯的。然鹅并没有觉得轻松啊，两种不同的坐标系，做法差别还是挺大的。不过从命名上看腾讯算学术派的了。</p>

<ul>
<li>Projection 对象规范 <a href="http://lbs.qq.com/javascript_v2/doc/projection.html">http://lbs.qq.com/javascript_v2/doc/projection.html</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/doc/maptype.html">http://lbs.qq.com/javascript_v2/doc/maptype.html</a></li>
</ul>


<p>打开 <a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-geocoding-reverse">http://lbs.qq.com/javascript_v2/case-run.html#sample-geocoding-reverse</a> ，在 map.qq.com/js/v2.js 的 apiLoad 处打断点进行到真正的map的js文件。</p>

<p><img src="/images/blogs/tencent-debug-apiLoad.png" alt="" /></p>

<p>然后查找 fromLatLngToPoint ，再在界面动一下，就可以调试整个过程：</p>

<p><img src="/images/blogs/tencent-debug-fromLatLngToPoint.png" alt="" /></p>

<ul>
<li>fromLatLngToPoint</li>
<li>fromPointToLatLng</li>
</ul>


<p>调式的时刻可以顺便看看整个调用链，会发现：</p>

<p><img src="/images/blogs/tencent-debug-fromDivPixelToLatLng.png" alt="" /></p>

<ul>
<li>fromDivPixelToLatLng</li>
<li>fromLatLngToDivPixel</li>
</ul>


<p>fromDivPixelToLatLng的条用链，以及数据的传递如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fromDivPixelToLatLng 
</span><span class='line'>=&gt;
</span><span class='line'>
</span><span class='line'>-&gt;Rh 转成相对位置转成绝对坐标后，传入到Mc
</span><span class='line'>[
</span><span class='line'>a
</span><span class='line'>P {x: 930, y: -471}
</span><span class='line'>c
</span><span class='line'>ia {width: 1725872.4160540444, height: 794188.9248479041}
</span><span class='line'>b
</span><span class='line'>true
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>-&gt;Mc(g, a, h, f)  &lt;-&gt;  Gf 缩放后，调用fromPointToLatLng
</span><span class='line'>[
</span><span class='line'>g
</span><span class='line'>Sh {a: P, b: 0.7111111111111111, c: 40.74366543152521, d: true}
</span><span class='line'>a
</span><span class='line'>P {x: 1726802, y: 793718}
</span><span class='line'>h
</span><span class='line'>13
</span><span class='line'>f
</span><span class='line'>true
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>-&gt;fromPointToLatLng(Ad, e)
</span><span class='line'>[
</span><span class='line'>Ad
</span><span class='line'>P {x: 210.791259765625, y: 96.889404296875}
</span><span class='line'>e
</span><span class='line'>true
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>-&gt; Return value : u
</span><span class='line'>    lat:40.02892889530204
</span><span class='line'>    lng:116.42520904541016
</span></code></pre></td></tr></table></div></figure>


<p>从 坐标计算 经纬度 反过来了：</p>

<p><img src="/images/blogs/tencent-debug-fromPointToLatLng.png" alt="" /></p>

<p>腾讯的计算过程直接把 <strong>转平面坐标和转像素坐标</strong> 两个过程合并了。<strong>通过 fromLatLngToPoint 得到就是一个 像素坐标 的值</strong>，然后通过缩放就可以得到<strong>当前层级级别</strong>的 <strong>像素坐标</strong> 。</p>

<p>查找瓦片地址的代码，直接在代码里面查找 <code>x=</code> 在37823处代码都打断点，刷新重新加载瓦片就会进到断点。</p>

<p>然后查看调用链，</p>

<p><img src="/images/blogs/tencent-debug-tile.png" alt="" /></p>

<p>详细跟踪的话，会发现，每次加载都会计算左上角和右下角两个点的像素坐标 （窗口的bounds）。计算要加载的瓦片时，直接用最大减最小除以256（每个瓦片的像素），就得到要加载瓦片的编号了。</p>

<p>用了几天比较肤浅的跟了下QQ地图的功能，如果没有混淆应该看起来会爽很多。。。没有很深层次的东西，仅仅是一个源码调试过程的记载，一些理论原理的知识请查完文章中的链接。</p>

<h2>其他</h2>

<ul>
<li><a href="http://www.gpsspg.com/bs/sql.htm">http://www.gpsspg.com/bs/sql.htm</a> 基站数据</li>
<li><a href="http://greatmaps.codeplex.com/">http://greatmaps.codeplex.com/</a></li>
<li><a href="https://my.oschina.net/zhajiang/blog/424157">Leaflet调用腾讯地图</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>
  <h1><a class='category' href='/blog/categories/recommend/'>Recommend</a></h1>
	<ul role="list">
		
			<li class="post">
				<a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/08/25/video-auto-translate/">视频自动翻译</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/06/09/reasonable-way-to-access-the-internet/">科学上网（续）</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/01/20/gitalk-on-octopress/">Gitalk on Octopress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/11/16/sphinx-generate-docs/">使用Sphinx生成/管理文档</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/10/30/windows-run-ubuntu/">Windows Run Ubuntu</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/30/kubeadm-install-kubenetes-on-centos7/">Kubeadm部署kubernetes</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/08/casperjs-crawler/">爬虫之CasperJS</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/05/23/spark-on-hive-speculation-shit-bug/">Hive on Spark预测性执行BUG一枚</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/27/vnc-server-on-centos7/">在Centos7上安装VNC Server</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/25/develop-environment-prepare/">[整理] 环境准备工具集</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/19/nginx-https/">Nginx配置https</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/09/19/163-open-movies-download/">批量下载163-open的视频</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/23/hadoop-guide-catalog/">[整理] Hadoop入门</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/04/rpm-build-your-package/">RPM打包</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/03/28/hive-on-spark/">Hive on Spark</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/11/22/gfw-ladder/">搭梯笔记</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/08/24/manual-install-supervisor/">Supervisor安装配置</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/10/16/spark-build-and-configuration/">编译/搭建Spark环境</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/08/25/step-by-step-found-java-oom-error/">查找逐步定位Java程序OOM的异常实践</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/30/hadoop2-snappy-compress/">Hadoop2 Snappy Compress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/27/start-redis/">[读读书]Redis入门指南</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/04/21/hadoop2-windows-startguide/">Windows下部署/配置/调试hadoop2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/30/git-cheatsheet/">GIT操作记录手册</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/18/jekyll-edit-link-in-web-page/">Jekyll页面添加编辑按钮</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/02/23/quickly-open-program-in-windows/">[Windows运行]快速打开程序</a>
			</li>
		
			<li class="post">
				<a href="/blog/2013/09/19/let-shell-command-efficient/">让敲Shell命令高效起来</a>
			</li>
		
	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2021/09/15/k2-again/">斐讯K2刷机padavan</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/05/11/redmine-on-arm-pi/">在树莓派上部署redmine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/12/appium-android-auto-test/">appium-Android自动化测试</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/26/android-linux-via-termux/">Android Linux via Termux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/10/try-bk-dot-tencent-dot-com/">Try bk.tencent.com</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/20/jcef-build-on-win64/">编译JCEF - Win64</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/08/25/video-auto-translate/">视频自动翻译</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/alluxio/'>alluxio</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/android/'>android</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/bigdata/'>bigdata</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blabla/'>blabla</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/debug/'>debug</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/deprecated/'>deprecated</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/devops/'>devops</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/es/'>es</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/flume/'>flume</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/git/'>git</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (44) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hbase/'>hbase</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hole/'>hole</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jenkins/'>jenkins</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k2/'>k2</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (9) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kafka/'>kafka</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kubeadm/'>kubeadm</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/logstash/'>logstash</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/map/'>map</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/recommend/'>recommend</a> (27) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/shell/'>shell</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/staf/'>staf</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tachyon/'>tachyon</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tez/'>tez</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tools/'>tools</a> (69) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/topics/'>topics</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/vagrant/'>vagrant</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/wsl/'>wsl</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/zookeeper/'>zookeeper</a> (1) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (217)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<!--
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
&#8211;>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253461959'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1253461959%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winseliu.com" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>









</body>
</html>
