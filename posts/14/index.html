
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="2017-3-17 08:33:56 折腾了大半个月，写点小结。在centos6 + docker-1.7 + k8s-1.2 是能用起来，安装了dashboard、nexus2、harbor，但是对于一些新的东西不能用，并且k8s官网文档不分版本并且没讲明白docker兼容的版本（至少官网文档 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winse.github.io/posts/14">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/libs/jquery.toc.min.js" type="text/javascript"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

<script src="/javascripts/generate-toc.js" type="text/javascript"></script>


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43198550-1', 'auto');
  ga('send', 'pageview');

</script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停, 熙熙攘攘, 忙忙碌碌, 不知何畏.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winse.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/03/05/k8s-docker-multinode-on-centos6/">k8s在Centos6部署实践</a></h1>
    
    
      <p class="meta">
        








  



  
<time datetime="2017-03-05T08:49:29+08:00" pubdate data-updated="true">Sun 2017-03-05 08:49</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>2017-3-17 08:33:56 折腾了大半个月，写点小结。在centos6 + docker-1.7 + k8s-1.2 是能用起来，安装了dashboard、nexus2、harbor，但是对于一些新的东西不能用，并且k8s官网文档不分版本并且没讲明白docker兼容的版本（至少官网文档），感觉在人家那就是行，到自己这里就不行，各种折腾后然后发现是版本问题。</p>

<p>docker和k8s在容器大热的当前，版本更新太快了，docker都到1.17了。综上，如果在centos6上面玩玩了解了k8s的概况还是好的，但是真的要用还是升级centos7吧。</p>

<p>configmap-volumes真是好东西，没办法docker-1.7不支持shared volume。</p>

<p>&ndash;</p>

<p>centos6系统比较&#8221;老&#8221;啊，既没有systemd，也没有docker-engine。网上各种资料要么是原始安装（非bootstrap docker），要么就是在centos7上装的。不太想在系统上做安装，这里按照kube-deploy的docker-multinode的脚本来进行修改然后安装，由于版本不兼容需要开推土机填各种坑：centos6上面的docker才1.7还不能用kubernetes-1.3，dashboard也需要自己安装。</p>

<p>环境描述：</p>

<ul>
<li>cu2: bootstrap(etcd, flannel), main(hyperkube, pause, kubernetes-dashboard)</li>
<li>cu4、cu5: bootstrap(flannel), main(hyperkube, pause)</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# docker -H unix:///var/run/docker-bootstrap.sock ps | grep -v IMAGE | awk '{print $2}' | sort -u
</span><span class='line'>gcr.io/google_containers/etcd-amd64:3.0.4
</span><span class='line'>quay.io/coreos/flannel:v0.6.1-amd64
</span><span class='line'>[root@cu4 ~]# docker -H unix:///var/run/docker-bootstrap.sock ps | grep -v IMAGE | awk '{print $2}' | sort -u
</span><span class='line'>quay.io/coreos/flannel:v0.6.1-amd64
</span><span class='line'>
</span><span class='line'>[root@cu2 kubernetes]# docker images
</span><span class='line'>REPOSITORY                                            TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
</span><span class='line'>bigdata                                               v1                  9e30d146824b        38 hours ago        457.2 MB
</span><span class='line'>gcr.io/google_containers/heapster-grafana-amd64       v4.0.2              74d2c72849cc        6 weeks ago         131.5 MB
</span><span class='line'>gcr.io/google_containers/heapster-influxdb-amd64      v1.1.1              55d63942e2eb        6 weeks ago         11.59 MB
</span><span class='line'>gcr.io/google_containers/heapster-amd64               v1.3.0-beta.1       026fb02eca65        6 weeks ago         101.3 MB
</span><span class='line'>gcr.io/google_containers/kubernetes-dashboard-amd64   v1.5.1              9af7d5c61ccf        7 weeks ago         103.6 MB
</span><span class='line'>gcr.io/google_containers/hyperkube-amd64              v1.2.7              1dd7250ed1b3        4 months ago        231.4 MB
</span><span class='line'>quay.io/coreos/flannel                                v0.6.1-amd64        ef86f3a53de0        6 months ago        27.89 MB
</span><span class='line'>gcr.io/google_containers/etcd-amd64                   3.0.4               ef5e89d609f1        6 months ago        39.62 MB
</span><span class='line'>gcr.io/google_containers/kube2sky-amd64               1.15                f93305484d65        10 months ago       29.16 MB
</span><span class='line'>gcr.io/google_containers/etcd-amd64                   2.2.5               a6752fb962b5        10 months ago       30.45 MB
</span><span class='line'>gcr.io/google_containers/skydns-amd64                 1.0                 a925f95d080a        11 months ago       15.57 MB
</span><span class='line'>gcr.io/google_containers/exechealthz-amd64            1.0                 5b9ac190b20c        11 months ago       7.116 MB
</span><span class='line'>gcr.io/google_containers/pause                        2.0                 9981ca1bbdb5        17 months ago       350.2 kB
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>etcd，flannel，和kubernetes-dashboard用的是docker-multinode时的版本。</li>
<li>kubelet是1.2的最新版v1.2.7。</li>
<li>pause:2.0是启动apiserver、controller容器时自动下载的版本。</li>
<li>新增DNS镜像（2017-3-6 02:07:14）</li>
<li>新增heapster镜像（2017-3-6 17:00:48）</li>
</ul>


<p>最好每台机器都load提前加载所有镜像。</p>

<h2>准备</h2>

<ul>
<li>安装docker，<a href="https://wiki.centos.org/zh/Cloud/Docker">Docker</a> <a href="/blog/2014/09/27/docker-start-guide-on-centos/">Docker入门</a></li>
<li>代理，<a href="/blog/2017/02/04/privoxy-http-proxy-for-shadowsocks/">Privoxy</a></li>
<li>镜像导入导出，<a href="/blog/2017/02/06/docker-http-proxy-and-save-reload/">Docker save/load</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export NO_PROXY="localhost,127.0.0.1,10.0.0.0/8"
</span><span class='line'>export https_proxy=http://localhost:8118/
</span><span class='line'>export http_proxy=http://localhost:8118/</span></code></pre></td></tr></table></div></figure>


<h2>先看操作和效果（看了菜单再看吃不吃）</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## 下载部署脚本 
</span><span class='line'># https://github.com/winse/docker-hadoop/tree/master/k8s-centos6/docker-multinode
</span><span class='line'>
</span><span class='line'>## 防火墙，关闭selinux
</span><span class='line'># 或者最后面增加 iptables -A INPUT -s 10.0.0.0/8 -j ACCEPT
</span><span class='line'>iptables -I INPUT 1 -s 10.0.0.0/8 -j ACCEPT
</span><span class='line'>
</span><span class='line'>## 先把镜像全部下载下来 git pull ...
</span><span class='line'>* 在master节点
</span><span class='line'>[root@cu2 ~]# docker images
</span><span class='line'>REPOSITORY                                            TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
</span><span class='line'>bigdata                                               v1                  9e30d146824b        2 days ago          457.2 MB
</span><span class='line'>redis                                                 3.2.8               c30a7507ec4d        6 days ago          182.9 MB
</span><span class='line'>gcr.io/google_containers/heapster-grafana-amd64       v4.0.2              74d2c72849cc        6 weeks ago         131.5 MB
</span><span class='line'>gcr.io/google_containers/heapster-influxdb-amd64      v1.1.1              55d63942e2eb        6 weeks ago         11.59 MB
</span><span class='line'>gcr.io/google_containers/heapster-amd64               v1.3.0-beta.1       026fb02eca65        6 weeks ago         101.3 MB
</span><span class='line'>gcr.io/google_containers/kubernetes-dashboard-amd64   v1.5.1              9af7d5c61ccf        7 weeks ago         103.6 MB
</span><span class='line'>gcr.io/google_containers/hyperkube-amd64              v1.2.7              1dd7250ed1b3        4 months ago        231.4 MB
</span><span class='line'>quay.io/coreos/flannel                                v0.6.1-amd64        ef86f3a53de0        6 months ago        27.89 MB
</span><span class='line'>gcr.io/google_containers/etcd-amd64                   3.0.4               ef5e89d609f1        6 months ago        39.62 MB
</span><span class='line'>gcr.io/google_containers/kube2sky-amd64               1.15                f93305484d65        10 months ago       29.16 MB
</span><span class='line'>gcr.io/google_containers/etcd-amd64                   2.2.5               a6752fb962b5        10 months ago       30.45 MB
</span><span class='line'>gcr.io/google_containers/skydns-amd64                 1.0                 a925f95d080a        11 months ago       15.57 MB
</span><span class='line'>gcr.io/google_containers/exechealthz-amd64            1.0                 5b9ac190b20c        11 months ago       7.116 MB
</span><span class='line'>gcr.io/google_containers/pause                        2.0                 9981ca1bbdb5        17 months ago       350.2 kB
</span><span class='line'>
</span><span class='line'>## 下载kubectl
</span><span class='line'>https://storage.googleapis.com/kubernetes-release/release/v1.2.7/bin/linux/amd64/kubectl 
</span><span class='line'># https://kubernetes.io/docs/user-guide/prereqs/
</span><span class='line'># https://kubernetes.io/docs/user-guide/kubectl/kubectl_version/
</span><span class='line'>
</span><span class='line'>## 环境变量
</span><span class='line'># https://kubernetes.io/docs/user-guide/kubeconfig-file/
</span><span class='line'>export KUBECONFIG=/var/lib/kubelet/kubeconfig/kubeconfig.yaml
</span><span class='line'>export PATH=...加kubectl所在文件夹
</span><span class='line'>
</span><span class='line'>## 启动MASTER
</span><span class='line'>./master.sh
</span><span class='line'>
</span><span class='line'>## 测试效果
</span><span class='line'>curl -fsSL http://localhost:2379/health
</span><span class='line'>curl -s http://localhost:8080/healthz
</span><span class='line'>curl -s http://localhost:8080/api
</span><span class='line'>kubectl get ns
</span><span class='line'>kubectl create namespace kube-system
</span><span class='line'>
</span><span class='line'>* 在worker节点
</span><span class='line'>[root@cu3 ~]# docker images
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>## 启动WORKER
</span><span class='line'>MASTER_IP=cu2 ./worker.sh
</span></code></pre></td></tr></table></div></figure>


<p>小状况：在第一次启动master脚本会有点问题：setup-files容器运行不正常：需要从googleapi下载easy-rsa.tar.gz，可以先手动下载到/root/kube目录，然后运行setup-files.sh脚本。如果不急的话等上一段时间多run几次后好像也能跑起来（囧）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# docker exec -ti kube_kubelet_624b2 bash
</span><span class='line'>root@cu2:/# /setup-files.sh IP:10.0.0.1,DNS:kubernetes,DNS:kubernetes.default,DNS:kubernetes.default.svc,DNS:kubernetes.default.svc.cluster.local
</span><span class='line'>
</span><span class='line'>然后再次提交dashboard：
</span><span class='line'>[root@cu2 docker-multinode-centos6]# ./dashboard.sh 
</span></code></pre></td></tr></table></div></figure>


<p>然后启动应用，测试多节点的情况下启动的容器网络能否互通：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## 运行查看容器
</span><span class='line'>[root@cu2 ~]# kubectl run redis --image=bigdata:v1 -r 5 --command -- /usr/sbin/sshd -D
</span><span class='line'>
</span><span class='line'>[root@cu2 ~]# kubectl get pods -o wide
</span><span class='line'>NAME                       READY     STATUS    RESTARTS   AGE       NODE
</span><span class='line'>k8s-master-192.168.0.214   4/4       Running   22         1h        192.168.0.214
</span><span class='line'>k8s-proxy-192.168.0.214    1/1       Running   0          1h        192.168.0.214
</span><span class='line'>redis-2212193268-1789v     1/1       Running   0          1h        192.168.0.174
</span><span class='line'>redis-2212193268-1j4ej     1/1       Running   0          1h        192.168.0.174
</span><span class='line'>redis-2212193268-8dbmq     1/1       Running   0          1h        192.168.0.30
</span><span class='line'>redis-2212193268-a447n     1/1       Running   0          1h        192.168.0.30
</span><span class='line'>redis-2212193268-tu5fl     1/1       Running   0          1h        192.168.0.214
</span><span class='line'>
</span><span class='line'>https://kubernetes.io/docs/user-guide/jsonpath/
</span><span class='line'>[root@cu2 ~]# kubectl get pods -o wide -l run=redis -o jsonpath={..podIP}
</span><span class='line'>10.1.75.2 10.1.75.3 10.1.58.3 10.1.58.2 10.1.33.3
</span><span class='line'>
</span><span class='line'>## 登录容器
</span><span class='line'># 用ssh登录
</span><span class='line'>[root@cu2 ~]# kubectl describe pods redis-2212193268-tu5fl | grep IP
</span><span class='line'>IP:             10.1.33.3
</span><span class='line'>[root@cu2 ~]# ssh 10.1.33.3
</span><span class='line'>The authenticity of host '10.1.33.3 (10.1.33.3)' can't be established.
</span><span class='line'>RSA key fingerprint is e5:58:ae:3b:54:c9:bb:0d:4c:9b:bc:fd:04:fe:be:cc.
</span><span class='line'>Are you sure you want to continue connecting (yes/no)? yes
</span><span class='line'>Warning: Permanently added '10.1.33.3' (RSA) to the list of known hosts.
</span><span class='line'>root@10.1.33.3's password: 
</span><span class='line'>Last login: Sat Mar  4 18:17:51 2017 from 10.1.61.1
</span><span class='line'>[root@redis-2212193268-tu5fl ~]# exit
</span><span class='line'>logout
</span><span class='line'>Connection to 10.1.33.3 closed.
</span><span class='line'>
</span><span class='line'># exec登录
</span><span class='line'>[root@cu2 ~]# kubectl exec -ti redis-2212193268-tu5fl bash
</span><span class='line'>[root@redis-2212193268-tu5fl /]# 
</span><span class='line'>
</span><span class='line'>## ping五台机器全部节点的机器都是互通的
</span><span class='line'>[root@redis-2212193268-tu5fl /]# ping 10.1.75.2
</span><span class='line'>PING 10.1.75.2 (10.1.75.2) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.1.75.2: icmp_seq=1 ttl=60 time=1.15 ms
</span><span class='line'>...
</span><span class='line'>[root@redis-2212193268-tu5fl /]# ping 10.1.75.3
</span><span class='line'>PING 10.1.75.3 (10.1.75.3) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.1.75.3: icmp_seq=1 ttl=60 time=1.23 ms
</span><span class='line'>...
</span><span class='line'>[root@redis-2212193268-tu5fl /]# ping 10.1.58.3
</span><span class='line'>PING 10.1.58.3 (10.1.58.3) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.1.58.3: icmp_seq=1 ttl=60 time=1.60 ms
</span><span class='line'>...
</span><span class='line'>[root@redis-2212193268-tu5fl /]# ping 10.1.58.2
</span><span class='line'>PING 10.1.58.2 (10.1.58.2) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.1.58.2: icmp_seq=1 ttl=60 time=1.39 ms
</span><span class='line'>...
</span><span class='line'>[root@redis-2212193268-tu5fl /]# ping 10.1.33.3         
</span><span class='line'>PING 10.1.33.3 (10.1.33.3) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.1.33.3: icmp_seq=1 ttl=64 time=0.036 ms
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>全部启动好后dashboard的效果图：</p>

<p><img src="/images/blogs/k8s-dashboard.jpg" alt="" /></p>

<h2>深入学习启动脚本</h2>

<p>官网这份<a href="https://kubernetes.io/docs/getting-started-guides/scratch/#starting-cluster-services">Creating a Custom Cluster from Scratch</a> 看的糊里糊涂，真不是给入门级的我来看的。需要有一定的实践经验才能看的懂。</p>

<p>另辟蹊径，根据 docker-multi 的启动脚本来拆分学习然后模拟动手实践。</p>

<p>在根据 <a href="https://kubernetes.io/docs/getting-started-guides/docker-multinode/">Portable Multi-Node Cluster</a> 文档学习操作的时刻不理解bootstrap docker以及main docker的含义。这次通过单独运行提取每个函数运行后才明白一点了，其实就相当于跑两个docker应用程序，互相不影响。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# ps aux|grep docker
</span><span class='line'>root      5310  0.0  0.2 645128 19180 pts/1    Sl   13:14   0:01 docker -d -H unix:///var/run/docker-bootstrap.sock -p /var/run/docker-bootstrap.pid --iptables=false --ip-masq=false --bridge=none --graph=/var/lib/docker-bootstrap --exec-root=/var/run/docker-bootstrap
</span><span class='line'>root      5782  1.1  0.5 2788284 43620 pts/1   Sl   13:14   0:23 /usr/bin/docker -d --mtu=1464 --bip=10.1.33.1/24
</span><span class='line'>root     10935  0.0  0.0 103316   896 pts/1    S+   13:47   0:00 grep docker
</span></code></pre></td></tr></table></div></figure>


<p>bootstrap docker启动后，容器etcd和flannel启动都很顺利。</p>

<p>以下的问题都是在自己虚拟机操作是遇到的，解决好后再部署到测试环境。</p>

<ul>
<li>问题1： 执行docker0网卡重置失败</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@bigdata1 data]# ip link set docker0 down
</span><span class='line'>[root@bigdata1 data]# ip link del docker0
</span><span class='line'>RTNETLINK answers: Operation not supported
</span><span class='line'>
</span><span class='line'>[root@bigdata1 data]# ip addr 
</span><span class='line'>
</span><span class='line'>删不掉，但是可以修改ip地址来实现相似的效果
</span><span class='line'>
</span><span class='line'>ifconfig docker0 ${FLANNEL_SUBNET}
</span><span class='line'>或者 
</span><span class='line'>[root@bigdata1 data]# ip link set dev docker0 mtu 1460
</span><span class='line'>[root@bigdata1 data]# ip addr del 172.17.42.1/16 dev docker0
</span><span class='line'>[root@bigdata1 data]# ip addr add ${FLANNEL_SUBNET} dev docker0
</span><span class='line'>[root@bigdata1 data]# ip link set dev docker0 up
</span><span class='line'>[root@bigdata1 data]# ifconfig # 查看重新分配的IP
</span><span class='line'>
</span><span class='line'>先添加参数在前端运行
</span><span class='line'>[root@bigdata1 data]# docker -d --mtu=1472 --bip=10.1.42.1/24
</span><span class='line'>
</span><span class='line'>启动
</span><span class='line'>[root@bigdata1 data]# sed -i 's/other_args=/other_args="--mtu=1472 --bip=10.1.42.1/24"/' /etc/sysconfig/docker
</span><span class='line'>[root@bigdata1 data]# service docker start
</span><span class='line'>Starting docker:                                           [确定]
</span><span class='line'>[root@bigdata1 data]# service docker status
</span><span class='line'>docker (pid  4542) 正在运行...</span></code></pre></td></tr></table></div></figure>


<ul>
<li>问题2：volumns mount不支持shared</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@bigdata1 data]# echo $KUBELET_MOUNTS
</span><span class='line'>-v /sys:/sys:rw -v /var/run:/var/run:rw -v /run:/run:rw -v /var/lib/docker:/var/lib/docker:rw -v /var/lib/kubelet:/var/lib/kubelet:shared -v /var/log/containers:/var/log/containers:rw
</span><span class='line'>
</span><span class='line'>[root@bigdata1 data]# mkdir -p /var/lib/kubelet
</span><span class='line'>[root@bigdata1 data]# mount --bind /var/lib/kubelet /var/lib/kubelet
</span><span class='line'>[root@bigdata1 data]# mount --make-shared /var/lib/kubelet
</span><span class='line'>
</span><span class='line'>[root@bigdata1 data]# docker run -d \
</span><span class='line'>&gt;     --net=host \
</span><span class='line'>&gt;     --pid=host \
</span><span class='line'>&gt;     --privileged \
</span><span class='line'>&gt;     --name kube_kubelet_$(kube::helpers::small_sha) \
</span><span class='line'>&gt;     ${KUBELET_MOUNTS} \
</span><span class='line'>&gt;     gcr.io/google_containers/hyperkube-${ARCH}:${K8S_VERSION} \
</span><span class='line'>&gt;     /hyperkube kubelet \
</span><span class='line'>&gt;       --allow-privileged \
</span><span class='line'>&gt;       --api-servers=http://localhost:8080 \
</span><span class='line'>&gt;       --config=/etc/kubernetes/manifests-multi \
</span><span class='line'>&gt;       --cluster-dns=10.0.0.10 \
</span><span class='line'>&gt;       --cluster-domain=cluster.local \
</span><span class='line'>&gt;       ${CNI_ARGS} \
</span><span class='line'>&gt;       ${CONTAINERIZED_FLAG} \
</span><span class='line'>&gt;       --hostname-override=${IP_ADDRESS} \
</span><span class='line'>&gt;       --v=2
</span><span class='line'>Error response from daemon: invalid mode for volumes-from: shared
</span><span class='line'>
</span><span class='line'># 改成z # -- 2017-3-16 19:15:57 不支持shared，后面会遇到volume的问题！
</span><span class='line'>    KUBELET_MOUNT="-v /var/lib/kubelet:/var/lib/kubelet:z"
</span><span class='line'>  
</span><span class='line'>[root@bigdata1 ~]# echo $KUBELET_MOUNTS
</span><span class='line'>-v /sys:/sys:rw -v /var/run:/var/run:rw -v /run:/run:rw -v /var/lib/docker:/var/lib/docker:rw -v /var/lib/kubelet:/var/lib/kubelet:z -v /var/log/containers:/var/log/containers:rw</span></code></pre></td></tr></table></div></figure>


<ul>
<li>问题3：cgroup问题</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Error: failed to run Kubelet: failed to get mounted cgroup subsystems: failed to find cgroup mounts
</span><span class='line'>failed to run Kubelet: failed to get mounted cgroup subsystems: failed to find cgroup mounts
</span><span class='line'>
</span><span class='line'>centos7 
</span><span class='line'>[root@k8s docker.service.d]# ll /sys/fs/cgroup/
</span><span class='line'>blkio/            cpuacct/          cpuset/           freezer/          memory/           net_cls,net_prio/ perf_event/       systemd/          
</span><span class='line'>cpu/              cpu,cpuacct/      devices/          hugetlb/          net_cls/          net_prio/         pids/             
</span><span class='line'>
</span><span class='line'>centos6
</span><span class='line'>http://wushank.blog.51cto.com/3489095/1203545
</span><span class='line'>[root@bigdata1 bin]# ls /cgroup/
</span><span class='line'>blkio  cpu  cpuacct  cpuset  devices  freezer  memory  net_cls
</span><span class='line'>
</span><span class='line'>把/cgroup加入到卷映射路径
</span><span class='line'>  KUBELET_MOUNTS="\
</span><span class='line'>    ${ROOTFS_MOUNT} \
</span><span class='line'>    -v /sys:/sys:rw \
</span><span class='line'>    -v /cgroup:/cgroup:rw \
</span><span class='line'>    -v /var/run:/var/run:rw \
</span><span class='line'>    -v /run:/run:rw \
</span><span class='line'>    -v /var/lib/docker:/var/lib/docker:rw \
</span><span class='line'>    ${KUBELET_MOUNT} \
</span><span class='line'>    -v /var/log/containers:/var/log/containers:rw"</span></code></pre></td></tr></table></div></figure>


<ul>
<li>问题4：再说版本，v1.3+的版本在centos6上运行kubelet报错：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@bigdata1 ~]# docker logs 7a2f7aec2239
</span><span class='line'>...
</span><span class='line'>E0228 10:56:05.408129    2516 kubelet.go:2049] Container runtime sanity check failed: container runtime version is older than 1.21</span></code></pre></td></tr></table></div></figure>


<p>1.3以上的版本都会报这个错。kubernetes用1.2.7的版本即可。</p>

<ul>
<li><p>问题5：dashboard/dns配置注意点</p></li>
<li><p>imagePullPolicy 就是个坑啊！改成IfNotPresent <a href="https://kubernetes.io/docs/user-guide/images/">https://kubernetes.io/docs/user-guide/images/</a></p></li>
<li>namespace 不能改，好像会写数据库然后指定的namespace就是kube-system</li>
<li>apiserver 由于没有addon-manager的支持，暂时使用http获取数据（DNS的问题确认了很久，kube2sky容器日志有报错，修改server地址为http方式才解决）</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 docker-multinode-centos6]# docker exec -ti 193863bc646b bash
</span><span class='line'>[root@redis-2212193268-0ovu7 /]# nslookup kubernetes.default
</span><span class='line'>Server:         10.0.0.10
</span><span class='line'>Address:        10.0.0.10#53
</span><span class='line'>
</span><span class='line'>Name:   kubernetes.default.svc.cluster.local
</span><span class='line'>Address: 10.0.0.1</span></code></pre></td></tr></table></div></figure>


<p>处理完以上问题，K8S集群就跑起来了，然后整合成开始用的脚本。当然后续还有很多工作，不仅仅是怎么用，还有一些其他辅助的软件需要配置和安装。</p>

<h2>监控</h2>

<ul>
<li><a href="https://kubernetes.io/docs/user-guide/monitoring/">Resource Usage Monitoring</a></li>
<li><a href="https://github.com/kubernetes/heapster/blob/master/docs/influxdb.md">Run Heapster in a Kubernetes cluster with an InfluxDB backend and a Grafana UI</a></li>
<li><a href="http://codingwater.org/2016/08/18/Kubernetes%E9%9B%86%E7%BE%A4%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7-Heapster/">Kubernetes集群性能监控&ndash;Heapster</a></li>
<li><a href="http://www.pangxie.space/docker/727">Kubernetes部署监控(Heapster+Influxdb+Grafana)-centos7</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>可以通过4194访问cAdvisor  &lt;http://www.dockone.io/article/page-46&gt;
</span><span class='line'>http://cu2:4194/containers/
</span><span class='line'>
</span><span class='line'>[root@cu2 influxdb]# kubectl create -f ./
</span><span class='line'>deployment "monitoring-grafana" created
</span><span class='line'>service "monitoring-grafana" created
</span><span class='line'>deployment "heapster" created
</span><span class='line'>service "heapster" created
</span><span class='line'>deployment "monitoring-influxdb" created
</span><span class='line'>service "monitoring-influxdb" created
</span><span class='line'>
</span><span class='line'>[root@cu2 influxdb]# kubectl get pods --namespace=kube-system -o wide
</span><span class='line'>NAME                                    READY     STATUS             RESTARTS   AGE       NODE
</span><span class='line'>heapster-2621086088-s77cl               0/1       CrashLoopBackOff   2          37s       192.168.0.148
</span><span class='line'>kube-dns-v8-00p5h                       4/4       Running            1          5h        192.168.0.174
</span><span class='line'>kubernetes-dashboard-2845140353-l7o8o   1/1       Running            0          5h        192.168.0.30
</span><span class='line'>monitoring-grafana-1501214244-kw3im     1/1       Running            0          37s       192.168.0.148
</span><span class='line'>monitoring-influxdb-3498630124-241tx    1/1       Running            0          37s       192.168.0.30
</span><span class='line'>
</span><span class='line'>第一次启动heapster失败，定位机器查看日志
</span><span class='line'>[root@cu3 ~]# docker logs aad68dd07ff8
</span><span class='line'>I0306 09:06:25.611251       1 heapster.go:71] /heapster --source=kubernetes:https://kubernetes.default --sink=influxdb:http://monitoring-influxdb:8086
</span><span class='line'>I0306 09:06:25.611523       1 heapster.go:72] Heapster version v1.3.0-beta.1
</span><span class='line'>F0306 09:06:25.611555       1 heapster.go:174] Failed to create source provide: open /var/run/secrets/kubernetes.io/serviceaccount/token: no such file or directory
</span><span class='line'>
</span><span class='line'>https://github.com/kubernetes/heapster/blob/master/docs/source-configuration.md 改成http
</span><span class='line'>
</span><span class='line'>重新加载
</span><span class='line'>[root@cu2 influxdb]# for file in * ; do sed -e "s|MASTER_IP|${IP_ADDRESS}|g" $file | kubectl apply -f - ; done
</span><span class='line'>deployment "monitoring-grafana" configured
</span><span class='line'>service "monitoring-grafana" configured
</span><span class='line'>deployment "heapster" configured
</span><span class='line'>service "heapster" configured
</span><span class='line'>deployment "monitoring-influxdb" configured
</span><span class='line'>service "monitoring-influxdb" configured
</span><span class='line'>
</span><span class='line'>[root@cu2 influxdb]# kubectl get service --namespace=kube-system -o wide
</span><span class='line'>NAME                   CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE       SELECTOR
</span><span class='line'>heapster               10.0.0.54    &lt;none&gt;        80/TCP          8m        k8s-app=heapster
</span><span class='line'>kube-dns               10.0.0.10    &lt;none&gt;        53/UDP,53/TCP   6h        k8s-app=kube-dns
</span><span class='line'>kubernetes-dashboard   10.0.0.181   nodes         80/TCP          6h        app=kubernetes-dashboard
</span><span class='line'>monitoring-grafana     10.0.0.220   &lt;none&gt;        80/TCP          8m        k8s-app=grafana
</span><span class='line'>monitoring-influxdb    10.0.0.223   &lt;none&gt;        8086/TCP        8m        k8s-app=influxdb
</span><span class='line'>
</span><span class='line'>浏览器访问grafana 登录：admin/admin
</span><span class='line'>http://10.0.0.220/
</span></code></pre></td></tr></table></div></figure>


<p>安装好监控后，dashboard也有图标了。</p>

<p><img src="/images/blogs/k8s-dashboard-pro.jpg" alt="" /></p>

<h4>某机器数据不显示问题定位</h4>

<p>原来是三台机器的，后面增加了148的机器进来。添加heapster监控后，就148机器图形显示不出来。并且dashboard的 148 Node 页面的 <strong> Conditions - Last heartbeat time </strong> 没显示内容。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 ~]# kubectl get services --all-namespaces
</span><span class='line'>NAMESPACE     NAME                   CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE
</span><span class='line'>default       kubernetes             10.0.0.1     &lt;none&gt;        443/TCP         1d
</span><span class='line'>kube-system   heapster               10.0.0.196   &lt;none&gt;        80/TCP          12m
</span><span class='line'>kube-system   kube-dns               10.0.0.10    &lt;none&gt;        53/UDP,53/TCP   21h
</span><span class='line'>kube-system   kubernetes-dashboard   10.0.0.181   nodes         80/TCP          21h
</span><span class='line'>kube-system   monitoring-grafana     10.0.0.215   &lt;none&gt;        80/TCP          12m
</span><span class='line'>kube-system   monitoring-influxdb    10.0.0.226   &lt;none&gt;        8086/TCP        12m
</span><span class='line'>
</span><span class='line'>查看接口
</span><span class='line'>https://github.com/kubernetes/heapster/blob/master/docs/debugging.md
</span><span class='line'>
</span><span class='line'>  http://10.0.0.196/metrics
</span><span class='line'>
</span><span class='line'>  这里没有148机器的key
</span><span class='line'>  http://10.0.0.196/api/v1/model/debug/allkeys
</span><span class='line'>
</span><span class='line'>  http://192.168.0.30:10255/stats/container/
</span><span class='line'>
</span><span class='line'>https://github.com/kubernetes/heapster/blob/master/docs/sink-configuration.md
</span><span class='line'>
</span><span class='line'>等到heapster机器运行命令，改下端口，日志输出详细点
</span><span class='line'>/ # /heapster --source=kubernetes:http://192.168.0.214:8080?inClusterConfig=false --sink=log --heapster-port=8083 -v 10
</span><span class='line'>
</span><span class='line'>  http://192.168.0.214:8080/api/v1/nodes
</span><span class='line'>  Node
</span><span class='line'>  Pod
</span><span class='line'>  Namespace
</span><span class='line'>  </span></code></pre></td></tr></table></div></figure>


<p>148机器的10255和4194端口都正常运行，heapster从148也获取到数据了。但是最后log输出的时刻没有148机器。系统时间？抱着尝试的心态改了一下，148的机器快了几分钟。</p>

<p>果不其然啊！！同步时间后监控图就显示出来了。</p>

<h2>后续学习操作</h2>

<ul>
<li>安全HTTPS <a href="https://kubernetes.io/docs/admin/authentication/#creating-certificates">https://kubernetes.io/docs/admin/authentication/#creating-certificates</a></li>
<li>register <a href="http://www.pangxie.space/docker/643">http://www.pangxie.space/docker/643</a> k8s版本旧的话很麻烦</li>
<li><a href="https://kubernetes.io/docs/tasks/">https://kubernetes.io/docs/tasks/</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/release-1.2/examples/redis/redis-controller.yaml">https://github.com/kubernetes/kubernetes/blob/release-1.2/examples/redis/redis-controller.yaml</a></li>
</ul>


<p>阿里云的镜像加速还是很赞的，由于我域名是在万网注册的本来就有账号，登录就能看到加速的地址，非常的方便。科技大学的加速镜像也很赞！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu1 ~]# cat /etc/sysconfig/docker
</span><span class='line'>...
</span><span class='line'>#other_args=" --registry-mirror=https://us69kjun.mirror.aliyuncs.com "
</span><span class='line'>other_args=" --registry-mirror=https://docker.mirrors.ustc.edu.cn "
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>有趣的命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://kubernetes.io/docs/user-guide/jsonpath/
</span><span class='line'>[root@cu2 ~]# kubectl get pods -o wide -l run=redis -o jsonpath={..podIP}
</span><span class='line'>10.1.75.2 10.1.75.3 10.1.58.3 10.1.58.2 10.1.33.3
</span><span class='line'>
</span><span class='line'>修改启动entry，以及网络共用
</span><span class='line'>docker run -ti --entrypoint=sh --net=container:8e9f21956469f4ef7e5b9d91798788ab83f380795d2825cdacae0ed28f5ba03b gcr.io/google_containers/skydns-amd64:1.0
</span><span class='line'>
</span><span class='line'>https://kubernetes.io/docs/tasks/kubectl/list-all-running-container-images/
</span><span class='line'>[root@cu2 ~]# kubectl get pods --all-namespaces -o jsonpath="{..image}" |\
</span><span class='line'>&gt; tr -s '[[:space:]]' '\n' |\
</span><span class='line'>&gt; sort |\
</span><span class='line'>&gt; uniq -c
</span><span class='line'>      2 gcr.io/google_containers/etcd-amd64:2.2.5
</span><span class='line'>      2 gcr.io/google_containers/exechealthz-amd64:1.0
</span><span class='line'>      2 gcr.io/google_containers/heapster-amd64:v1.3.0-beta.1
</span><span class='line'>      2 gcr.io/google_containers/heapster-grafana-amd64:v4.0.2
</span><span class='line'>      2 gcr.io/google_containers/heapster-influxdb-amd64:v1.1.1
</span><span class='line'>     10 gcr.io/google_containers/hyperkube-amd64:v1.2.7
</span><span class='line'>      2 gcr.io/google_containers/kube2sky-amd64:1.15
</span><span class='line'>      2 gcr.io/google_containers/kubernetes-dashboard-amd64:v1.5.1
</span><span class='line'>      2 gcr.io/google_containers/skydns-amd64:1.0
</span><span class='line'>      2 redis:3.2.8
</span><span class='line'>
</span><span class='line'>kubectl get pods --all-namespaces -o jsonpath="{.items[*].spec.containers[*].image}"
</span><span class='line'>
</span><span class='line'>[root@cu2 ~]# export POD_COL="custom-columns=NAME:.metadata.name,RESTARTS:.status.containerStatuses[*].restartCount,CONTAINERS:.spec.containers[*].name,IP:.status.podIP,HOST:.spec.nodeName"
</span><span class='line'>[root@cu2 ~]# kubectl get pods -o $POD_COL 
</span><span class='line'>
</span><span class='line'># 加label
</span><span class='line'>[root@cu2 ~]# cat /etc/hosts | grep -E "\scu[0-9]\s" | awk '{print "kubectl label nodes "$1" hostname="$2}' | while read line ; do sh -c "$line" ; done
</span><span class='line'>
</span><span class='line'>[root@cu2 kubernetes]# kubectl run redis --image=redis:3.2.8 
</span><span class='line'>[root@cu2 kubernetes]# kubectl scale --replicas=9 deployment/redis</span></code></pre></td></tr></table></div></figure>


<h2>其他参考</h2>

<p>纯手动安装，所有应用都作为服务启动
* <a href="http://chenguomin.blog.51cto.com/8794192/1828905">http://chenguomin.blog.51cto.com/8794192/1828905</a> 网络使用flannel、DNS的安装配置
* <a href="http://www.pangxie.space/docker/618">http://www.pangxie.space/docker/618</a>
* <a href="https://xuxinkun.github.io/2016/03/27/k8s-service/">https://xuxinkun.github.io/2016/03/27/k8s-service/</a> service是在防火墙做的跳转 => iptables -S -t nat</p>

<p>介绍
* <a href="http://www.infoq.com/cn/articles/kubernetes-and-cloud-native-applications-part01">http://www.infoq.com/cn/articles/kubernetes-and-cloud-native-applications-part01</a>
* <a href="http://www.codingwater.org/2016/08/25/Docker-Kubernetes-Intro/">http://www.codingwater.org/2016/08/25/Docker-Kubernetes-Intro/</a>
* <a href="https://github.com/kubernetes/kubernetes/tree/v1.0.1/cluster/addons/dns">https://github.com/kubernetes/kubernetes/tree/v1.0.1/cluster/addons/dns</a></p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/02/25/k8s-docker-multinode/">K8s集群部署</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-02-25T21:25:26+08:00" pubdate data-updated="true">Sat 2017-02-25 21:25</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p><strong>更新：2019-4-8</strong> 已经不适应了，参考使用kubeadm安装！！！</p>

<p>前面讲了在本机windows安装方式，最近在linux多机器上尝试部署并操作。</p>

<p>先看官网的文档<a href="https://kubernetes.io/docs/getting-started-guides/docker-multinode/">Portable Multi-Node Cluster</a>。这里根据文章进行实际操作记录下来，k8s是真的好用管理起来很方便。</p>

<h2>安装docker（on centos7）</h2>

<h4>不正确的打开方式</h4>

<p>不要用这种方式安装</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# yum install docker
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# docker -v
</span><span class='line'>Docker version 1.12.5, build 047e51b/1.12.5</span></code></pre></td></tr></table></div></figure>


<p>否则运行报错的daemon语句，报错：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s docker-multinode]# docker daemon -H unix:///var/run/docker-bootstrap.sock -p /var/run/docker-bootstrap.pid --iptables=false --ip-masq=false --bridge=none --graph=/var/lib/docker-bootstrap --exec-root=/var/run/docker-bootstrap
</span><span class='line'>exec: "dockerd": executable file not found in $PATH</span></code></pre></td></tr></table></div></figure>


<p>先清理旧的软件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum remove docker -y
</span><span class='line'>yum remove container-selinux -y
</span><span class='line'>yum remove docker-common -y</span></code></pre></td></tr></table></div></figure>


<h4>安装docker的正确姿势</h4>

<ul>
<li><a href="https://docs.docker.com/engine/installation/linux/centos/">Get Docker for CentOS</a></li>
</ul>


<p>变化很快，直接按官网的操作。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# yum install -y yum-utils
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# yum-config-manager --add-repo https://docs.docker.com/engine/installation/linux/repo_files/centos/docker.repo
</span><span class='line'>Loaded plugins: fastestmirror, langpacks
</span><span class='line'>Repository base is listed more than once in the configuration
</span><span class='line'>Repository updates is listed more than once in the configuration
</span><span class='line'>Repository extras is listed more than once in the configuration
</span><span class='line'>Repository centosplus is listed more than once in the configuration
</span><span class='line'>adding repo from: https://docs.docker.com/engine/installation/linux/repo_files/centos/docker.repo
</span><span class='line'>grabbing file https://docs.docker.com/engine/installation/linux/repo_files/centos/docker.repo to /etc/yum.repos.d/docker.repo
</span><span class='line'>repo saved to /etc/yum.repos.d/docker.repo
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# yum makecache fast
</span><span class='line'>[root@k8s ~]# yum -y install docker-engine
</span><span class='line'>
</span><span class='line'># 把保存数据的目录转移到大磁盘下面去
</span><span class='line'>先启动服务来产生docker目录
</span><span class='line'>[root@k8s ~]# service docker start
</span><span class='line'>[root@k8s ~]# service docker stop
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# rm -rf /var/lib/docker/
</span><span class='line'>[root@k8s ~]# ln -s /data/var/lib/docker /var/lib/</span></code></pre></td></tr></table></div></figure>


<h2>安装k8s</h2>

<ul>
<li><a href="https://kubernetes.io/docs/getting-started-guides/docker-multinode/">Portable Multi-Node Cluster</a></li>
</ul>


<h4>准备</h4>

<ul>
<li><a href="https://kubernetes.io/docs/user-guide/prereqs/">Installing and Setting up kubectl</a></li>
<li><a href="https://kubernetes.io/docs/getting-started-guides/kubectl/">https://kubernetes.io/docs/getting-started-guides/kubectl/</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 删除旧的容器
</span><span class='line'>[root@k8s docker-multinode]# docker rm -f `docker ps -a | grep -v IMAGE | awk '{print $1}'`
</span><span class='line'>[root@k8s docker-multinode]# docker ps -a
</span><span class='line'>
</span><span class='line'># 下载部署的工具
</span><span class='line'>[root@k8s ~]# yum install git -y
</span><span class='line'>[root@k8s ~]# git clone https://github.com/kubernetes/kube-deploy
</span><span class='line'>
</span><span class='line'># kubectl安装，需要代理你懂得 
</span><span class='line'>export NO_PROXY="localhost,127.0.0.1,10.0.0.0/8"
</span><span class='line'>export https_proxy=http://k8s:8118/
</span><span class='line'>export http_proxy=http://k8s:8118/
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100 48.0M  100 48.0M    0     0  1692k      0  0:00:29  0:00:29 --:--:-- 2351k
</span><span class='line'>[root@k8s ~]# chmod +x kubectl 
</span><span class='line'>[root@k8s ~]# mkdir ~/bin
</span><span class='line'>[root@k8s ~]# mv ./kubectl ~/bin/
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# source &lt;(kubectl completion bash)
</span><span class='line'>[root@k8s ~]# echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bashrc
</span><span class='line'>== 修改成下面的语句，不然你scp、rsync就不能用了: https://my.oschina.net/leejun2005/blog/342865
</span><span class='line'>== export PATH=~/bin:$PATH
</span><span class='line'>== [[ $- == *i* ]] && source &lt;(kubectl completion bash)
</span></code></pre></td></tr></table></div></figure>


<h4>启动master</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# cd kube-deploy/docker-multinode/
</span><span class='line'>[root@k8s docker-multinode]# ./master.sh 
</span><span class='line'>+++ [0206 19:07:23] K8S_VERSION is set to: v1.5.2
</span><span class='line'>+++ [0206 19:07:23] ETCD_VERSION is set to: 3.0.4
</span><span class='line'>+++ [0206 19:07:23] FLANNEL_VERSION is set to: v0.6.1
</span><span class='line'>+++ [0206 19:07:23] FLANNEL_IPMASQ is set to: true
</span><span class='line'>+++ [0206 19:07:23] FLANNEL_NETWORK is set to: 10.1.0.0/16
</span><span class='line'>+++ [0206 19:07:23] FLANNEL_BACKEND is set to: udp
</span><span class='line'>+++ [0206 19:07:23] RESTART_POLICY is set to: unless-stopped
</span><span class='line'>+++ [0206 19:07:23] MASTER_IP is set to: localhost
</span><span class='line'>+++ [0206 19:07:23] ARCH is set to: amd64
</span><span class='line'>+++ [0206 19:07:23] IP_ADDRESS is set to: 192.168.1.112
</span><span class='line'>+++ [0206 19:07:23] USE_CNI is set to: false
</span><span class='line'>+++ [0206 19:07:23] USE_CONTAINERIZED is set to: false
</span><span class='line'>+++ [0206 19:07:23] --------------------------------------------
</span><span class='line'>+++ [0206 19:07:23] Killing docker bootstrap...
</span><span class='line'>+++ [0206 19:07:24] Killing all kubernetes containers...
</span><span class='line'>Do you want to clean /var/lib/kubelet? [Y/n] y
</span><span class='line'>+++ [0206 19:07:27] Launching docker bootstrap...
</span><span class='line'>+++ [0206 19:07:28] Launching etcd...
</span><span class='line'>3ff0f0fd7a08282930449b2f496f786b9857f6290698d612cebc2086d1a1765c
</span><span class='line'>+++ [0206 19:07:31] Launching flannel...
</span><span class='line'>{"action":"set","node":{"key":"/coreos.com/network/config","value":"{ \"Network\": \"10.1.0.0/16\", \"Backend\": {\"Type\": \"udp\"}}","modifiedIndex":4,"createdIndex":4}}
</span><span class='line'>3651d077f453900a898ce6ad9fe67a7422f0c8084ec86b6e6a1a2ab6b9b1c629
</span><span class='line'>+++ [0206 19:07:33] FLANNEL_SUBNET is set to: 10.1.42.1/24
</span><span class='line'>+++ [0206 19:07:33] FLANNEL_MTU is set to: 1472
</span><span class='line'>+++ [0206 19:07:33] Restarting main docker daemon...
</span><span class='line'>+++ [0206 19:07:38] Restarted docker with the new flannel settings
</span><span class='line'>+++ [0206 19:07:38] Launching Kubernetes master components...
</span><span class='line'>d10130677853022fe37742437e39b21b3fcfbb90b3f24075457f469e238b0712
</span><span class='line'>+++ [0206 19:07:42] Done. It may take about a minute before apiserver is up.
</span><span class='line'>
</span><span class='line'>[root@k8s docker-multinode]# docker ps -a
</span><span class='line'>...一堆容器列表</span></code></pre></td></tr></table></div></figure>


<p>如果有问题基本就是防火墙的问题（我遇到过的啊，下载镜像和本地firewall设置的问题）。</p>

<p>上面安装kubectl时已经配置了代理地址。如果部署master的时刻pull镜像出错，那还得需要给docker配置代理增加配置 <strong> /etc/systemd/system/docker.service.d/http-proxy.conf </strong> / <strong> /usr/lib/systemd/system/docker.service </strong> 参考 <a href="https://docs.docker.com/engine/admin/systemd/#http-proxy">https://docs.docker.com/engine/admin/systemd/#http-proxy</a> 。具体错误详情及处理查看下面的【问题及处理】部分</p>

<p><strong>安装启动好</strong>后，就可以通过浏览器图形界面来管理集群了(dashboard启动有问题的话查看后面的问题处理)： <a href="http://k8s:8080/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard/#/workload?namespace=default">http://k8s:8080/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard/#/workload?namespace=default</a></p>

<h4>启动worker</h4>

<p>下载安装软件的工作这里就不帖了，和master一样的：安装git、clone kube-deploy、docker。</p>

<p>防火墙配置，master/slaves之间互通</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>centos7 firewall的add-source不知道怎么用的，反正加了地址也没效果；后面通过rule规则来实现。
</span><span class='line'>[root@bigdata-dev ~]# vi /etc/firewalld/zones/public.xml
</span><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;zone&gt;
</span><span class='line'>  &lt;rule family="ipv4"&gt;
</span><span class='line'>    &lt;source address="192.168.1.112/32"/&gt;
</span><span class='line'>    &lt;accept/&gt;
</span><span class='line'>  &lt;/rule&gt;
</span><span class='line'>  &lt;service name="ssh"/&gt;
</span><span class='line'>  &lt;port protocol="tcp" port="80"/&gt;
</span><span class='line'>  &lt;port protocol="tcp" port="6379"/&gt;
</span><span class='line'>  &lt;port protocol="tcp" port="8080"/&gt;
</span><span class='line'>&lt;/zone&gt;
</span><span class='line'>[root@bigdata-dev ~]# firewall-cmd --complete-reload
</span><span class='line'>success
</span><span class='line'>[root@bigdata-dev ~]# firewall-cmd --list-all
</span><span class='line'>public (active)
</span><span class='line'>  target: default
</span><span class='line'>  icmp-block-inversion: no
</span><span class='line'>  interfaces: p4p1
</span><span class='line'>  sources: 
</span><span class='line'>  services: ssh
</span><span class='line'>  ports: 80/tcp 6379/tcp 8080/tcp
</span><span class='line'>  protocols: 
</span><span class='line'>  masquerade: no
</span><span class='line'>  forward-ports: 
</span><span class='line'>  sourceports: 
</span><span class='line'>  icmp-blocks: 
</span><span class='line'>  rich rules: 
</span><span class='line'>        rule family="ipv4" source address="192.168.1.112/32" accept
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# cat /etc/firewalld/zones/public.xml
</span><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;zone&gt;
</span><span class='line'>  &lt;rule family="ipv4"&gt;
</span><span class='line'>    &lt;source address="192.168.1.248"/&gt;
</span><span class='line'>    &lt;accept/&gt;
</span><span class='line'>  &lt;/rule&gt;
</span><span class='line'>  &lt;service name="ssh"/&gt;
</span><span class='line'>  &lt;port protocol="tcp" port="6443"/&gt;
</span><span class='line'>  &lt;port protocol="tcp" port="2379"/&gt;
</span><span class='line'>  &lt;port protocol="tcp" port="8118"/&gt;
</span><span class='line'>&lt;/zone&gt;</span></code></pre></td></tr></table></div></figure>


<p>加载已经下载的镜像。从master拷贝过来（save/load）不要浪费VPN流量啦：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@bigdata-dev docker-multinode]# docker load &lt;k8s.tar</span></code></pre></td></tr></table></div></figure>


<p>运行worker启动脚本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 设置代理。如果有docker镜像下载失败的话再配置docker环境变量
</span><span class='line'>export NO_PROXY="localhost,127.0.0.1,10.0.0.0/8"
</span><span class='line'>export https_proxy=http://k8s:8118/
</span><span class='line'>export http_proxy=http://k8s:8118/
</span><span class='line'>
</span><span class='line'>[root@bigdata-dev docker-multinode]# export MASTER_IP=192.168.1.112 
</span><span class='line'>[root@bigdata-dev docker-multinode]# ./worker.sh 
</span><span class='line'>+++ [0208 08:59:37] K8S_VERSION is set to: v1.5.2
</span><span class='line'>+++ [0208 08:59:37] ETCD_VERSION is set to: 3.0.4
</span><span class='line'>+++ [0208 08:59:37] FLANNEL_VERSION is set to: v0.6.1
</span><span class='line'>+++ [0208 08:59:37] FLANNEL_IPMASQ is set to: true
</span><span class='line'>+++ [0208 08:59:37] FLANNEL_NETWORK is set to: 10.1.0.0/16
</span><span class='line'>+++ [0208 08:59:37] FLANNEL_BACKEND is set to: udp
</span><span class='line'>+++ [0208 08:59:37] RESTART_POLICY is set to: unless-stopped
</span><span class='line'>+++ [0208 08:59:37] MASTER_IP is set to: 192.168.1.112
</span><span class='line'>+++ [0208 08:59:37] ARCH is set to: amd64
</span><span class='line'>+++ [0208 08:59:37] IP_ADDRESS is set to: 192.168.1.248
</span><span class='line'>+++ [0208 08:59:37] USE_CNI is set to: false
</span><span class='line'>+++ [0208 08:59:37] USE_CONTAINERIZED is set to: false
</span><span class='line'>+++ [0208 08:59:37] --------------------------------------------
</span><span class='line'>+++ [0208 08:59:37] Killing all kubernetes containers...
</span><span class='line'>+++ [0208 08:59:37] Launching docker bootstrap...
</span><span class='line'>+++ [0208 08:59:38] Launching flannel...
</span><span class='line'>+++ [0208 08:59:39] FLANNEL_SUBNET is set to: 10.1.42.1/24
</span><span class='line'>+++ [0208 08:59:39] FLANNEL_MTU is set to: 1472
</span><span class='line'>+++ [0208 08:59:39] Restarting main docker daemon...
</span><span class='line'>+++ [0208 08:59:43] Restarted docker with the new flannel settings
</span><span class='line'>+++ [0208 08:59:43] Launching Kubernetes worker components...
</span><span class='line'>1ce6ee6af709485668c9f170b1bc234b34d55d18e53116295c887c88046ca231
</span><span class='line'>+++ [0208 08:59:44] Done. After about a minute the node should be ready.</span></code></pre></td></tr></table></div></figure>


<h2>查看集群状态</h2>

<p>安装好了后，需要学习基本的管理操作</p>

<ul>
<li>交互式的学习一些基本概念命令 <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/">Kubernetes Basics</a></li>
<li>常用的kubectl命令册子 <a href="https://kubernetes.io/docs/user-guide/kubectl-cheatsheet/">kubectl Cheat Sheet</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# kubectl cluster-info
</span><span class='line'>Kubernetes master is running at http://localhost:8080
</span><span class='line'>KubeDNS is running at http://localhost:8080/api/v1/proxy/namespaces/kube-system/services/kube-dns
</span><span class='line'>kubernetes-dashboard is running at http://localhost:8080/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard
</span><span class='line'>
</span><span class='line'>To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# kubectl get service
</span><span class='line'>NAME         CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
</span><span class='line'>kubernetes   10.0.0.1     &lt;none&gt;        443/TCP   16d
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# kubectl get nodes
</span><span class='line'>NAME            STATUS    AGE
</span><span class='line'>192.168.1.112   Ready     16d
</span><span class='line'>192.168.1.248   Ready     16d
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# kubectl get pods --namespace=kube-system
</span><span class='line'>NAME                                    READY     STATUS    RESTARTS   AGE
</span><span class='line'>k8s-master-192.168.1.112                4/4       Running   9          1d
</span><span class='line'>k8s-proxy-v1-4hp8c                      1/1       Running   0          1d
</span><span class='line'>k8s-proxy-v1-htrrf                      1/1       Running   0          1d
</span><span class='line'>kube-addon-manager-192.168.1.112        2/2       Running   0          1d
</span><span class='line'>kube-dns-4101612645-q0kcw               4/4       Running   0          1d
</span><span class='line'>kubernetes-dashboard-3543765157-hsls9   1/1       Running   0          1d
</span><span class='line'>
</span><span class='line'>dashboard运行正常的话，就可以通过浏览器查看以及管理集群
</span><span class='line'>== https://kubernetes.io/docs/user-guide/ui/
</span><span class='line'>== 走socks5代理
</span><span class='line'>http://k8s:8080/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard/#/workload?namespace=default</span></code></pre></td></tr></table></div></figure>


<h2>问题及处理</h2>

<p>镜像或者启动失败的问题可以 <strong>set -x</strong> 输出脚本调试信息，获取到出错位置的命令单独重新执行来定位。</p>

<p>另一种情况，脚本启动完成后，服务不能正常运行。重启机器，再次运行master后就不能访问dashboard了，把master机器的防火墙关闭就行了。github上有同样的一个问题<a href="https://github.com/kubernetes/dashboard/issues/916">https://github.com/kubernetes/dashboard/issues/916</a></p>

<p>处理定位问题步骤如下：</p>

<p>清理所有重新弄，无济于事</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker kill $(docker ps -q)
</span><span class='line'>docker rm $(docker ps -aq)
</span><span class='line'>[reboot]
</span><span class='line'>sudo rm -R /var/lib/kubelet
</span><span class='line'>sudo rm -R /var/run/kubernetes
</span><span class='line'>
</span><span class='line'>./turndown.sh & ./master.sh 
</span><span class='line'>kubectl get pods --namespace=kube-system # 显示的dashboard容器启动总是失败，可以通过kubectl logs/docker logs查看。</span></code></pre></td></tr></table></div></figure>


<p>重新定位问题</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>既然关闭防火墙能正常运行，下面通过拦截日志查看封堵日志
</span><span class='line'>[root@k8s ~]# firewall-cmd --set-log-denied=all
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# less /var/log/messages
</span><span class='line'>Feb 25 00:04:30 k8s kernel: XFS (dm-32): Unmounting Filesystem
</span><span class='line'>Feb 25 00:04:30 k8s kernel: XFS (dm-32): Mounting V5 Filesystem
</span><span class='line'>Feb 25 00:04:30 k8s kernel: XFS (dm-32): Ending clean mount
</span><span class='line'>Feb 25 00:04:32 k8s kernel: FINAL_REJECT: IN=docker0 OUT= PHYSIN=veth2fd9745 MAC=02:42:cf:c5:2c:da:02:42:0a:01:49:03:08:00 SRC=10.1.73.3 DST=192.168.1.112 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=11531 DF PROTO=TCP SPT=38734 DPT=6443 WINDOW=28640 RES=0x00 SYN URGP=0 
</span><span class='line'>Feb 25 00:04:33 k8s kernel: FINAL_REJECT: IN=docker0 OUT= PHYSIN=veth2fd9745 MAC=02:42:cf:c5:2c:da:02:42:0a:01:49:03:08:00 SRC=10.1.73.3 DST=192.168.1.112 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=11532 DF PROTO=TCP SPT=38734 DPT=6443 WINDOW=28640 RES=0x00 SYN URGP=0 
</span><span class='line'>Feb 25 00:04:33 k8s dockerd: time="2017-02-25T00:04:33.935301481+08:00" level=error msg="containerd: deleting container" error="exit status 1: \"container dcb4a44031b96470eaef50eb8ac4ee2b9f958906702d94645c3a45c4852b6335 does not exist\\none or more of the container deletions failed\\n\""
</span><span class='line'>Feb 25 00:04:34 k8s kernel: XFS (dm-32): Unmounting Filesystem
</span><span class='line'>Feb 25 00:04:35 k8s systemd-udevd: inotify_add_watch(7, /dev/dm-32, 10) failed: No such file or directory
</span><span class='line'>Feb 25 00:04:36 k8s systemd-udevd: inotify_add_watch(7, /dev/dm-32, 10) failed: No such file or directory
</span><span class='line'>Feb 25 00:04:36 k8s dockerd: time="2017-02-25T00:04:36.406470062+08:00" level=error msg="Handler for GET /v1.25/containers/5bd86339f0dcd513da632ec300d4235d8a09c3f9546f751ac8874de411de3c10/json returned error: No such container: 5bd86339f0dcd513da632ec300d4235d8a09c3f9546f751ac8874de411de3c10"
</span><span class='line'>可以看出访问的端口6443被拦截了</span></code></pre></td></tr></table></div></figure>


<p>开放6443端口dashboard启动成功（直接把放开ip段也行）。通过浏览器能正常访问</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# firewall-cmd --zone=public --add-port=6443/tcp --permanent
</span><span class='line'>success
</span><span class='line'>[root@k8s ~]# firewall-cmd --reload
</span><span class='line'>success
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# kubectl get pods --namespace=kube-system
</span><span class='line'>NAME                                    READY     STATUS    RESTARTS   AGE
</span><span class='line'>k8s-master-192.168.1.112                4/4       Running   1          9m
</span><span class='line'>k8s-proxy-v1-nzkgt                      1/1       Running   0          9m
</span><span class='line'>kube-addon-manager-192.168.1.112        2/2       Running   0          8m
</span><span class='line'>kube-dns-4101612645-k4j0s               4/4       Running   4          9m
</span><span class='line'>kubernetes-dashboard-3543765157-h5g5f   1/1       Running   6          9m
</span><span class='line'>等所有都Running才能通过dashboard查看</span></code></pre></td></tr></table></div></figure>


<h2>使用</h2>

<p>使用已有镜像（网上、本地）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# kubectl run hello-nginx --image=nginx --port=80
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# kubectl get pods
</span><span class='line'>NAME                           READY     STATUS    RESTARTS   AGE
</span><span class='line'>hello-nginx-2471083592-94pm7   1/1       Running   0          19m
</span><span class='line'>[root@k8s ~]# kubectl describe pod hello-nginx-2471083592-94pm7
</span><span class='line'>Name:           hello-nginx-2471083592-94pm7
</span><span class='line'>Namespace:      default
</span><span class='line'>Node:           192.168.1.248/192.168.1.248
</span><span class='line'>Start Time:     Fri, 24 Feb 2017 12:37:30 +0800
</span><span class='line'>Labels:         pod-template-hash=2471083592
</span><span class='line'>                run=hello-nginx
</span><span class='line'>Status:         Running
</span><span class='line'>IP:             10.1.42.3
</span><span class='line'>Controllers:    ReplicaSet/hello-nginx-2471083592</span></code></pre></td></tr></table></div></figure>


<p>查看到pod的ip，登录Node对应的机器就可以直接通过IP访问了。IP与flannel0网卡在同一网段。</p>

<p>定制镜像</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# docker pull centos:centos5
</span><span class='line'>[root@k8s ~]# docker pull centos:centos6
</span><span class='line'>[root@k8s ~]# docker pull centos:centos7
</span><span class='line'>
</span><span class='line'>把最新的修改提交保存为行的镜像。
</span><span class='line'>登录centos6，安装sshd后，启动sshd服务（产生key）。清理yum缓冲、临时文件/tmp、以及history等。写Dockerfile减小镜像的大小： https://hui.lu/reduce-docker-image-size/  
</span><span class='line'>[root@k8s ~]# docker run -t -i centos:centos6 
</span><span class='line'>...yum install -y openssh-server openssh-clients ; service sshd start ; yum clean all ; history -c ; rm -rf /tmp/*
</span><span class='line'>
</span><span class='line'>提交的名字一定要打标签tag
</span><span class='line'>[root@k8s ~]# docker ps -a
</span><span class='line'>[root@k8s ~]# docker commit CONTAINER_ID bigdata:v1
</span><span class='line'>查看下版本的历史
</span><span class='line'>[root@k8s ~]# docker history bigdata:v1
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# docker images
</span><span class='line'>[root@k8s ~]# docker save centos:centos5 centos:centos6 centos:centos7 bigdata:v1 &gt;bigdata.tar
</span><span class='line'>
</span><span class='line'>拷贝
</span><span class='line'>[root@bigdata-dev ~]# scp k8s:~/bigdata.tar ./
</span><span class='line'>centos.tar                                                                                                                                               100%  668MB  11.1MB/s   01:00    
</span><span class='line'>[root@bigdata-dev ~]# docker load &lt;bigdata.tar
</span><span class='line'>[root@bigdata-dev ~]# docker images
</span><span class='line'> 
</span><span class='line'>真正的跑自己的镜像
</span><span class='line'>[root@k8s ~]# kubectl run hadoop --image=bigdata:v1 --command -- /usr/sbin/sshd -D
</span><span class='line'>deployment "hadoop" created</span></code></pre></td></tr></table></div></figure>


<p>查看运行情况以及一些简单操作</p>

<ul>
<li><a href="https://kubernetes.io/docs/user-guide/debugging-pods-and-replication-controllers/">https://kubernetes.io/docs/user-guide/debugging-pods-and-replication-controllers/</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# kubectl get pods
</span><span class='line'>NAME                      READY     STATUS    RESTARTS   AGE
</span><span class='line'>hadoop-2607718808-cqx2n   1/1       Running   0          2h
</span><span class='line'>[root@k8s ~]# kubectl describe pods hadoop-2607718808-cqx2n
</span><span class='line'>通过输出信息中Node和IP即可通过登录主机（IP与flannel0网卡在同一网段）
</span><span class='line'>
</span><span class='line'>也可以通过kubectl来登录
</span><span class='line'>[root@k8s ~]# kubectl exec hadoop-2607718808-cqx2n -i -t -- bash 
</span><span class='line'>[root@hadoop-2607718808-cqx2n /]# 
</span><span class='line'>[root@hadoop-2607718808-cqx2n /]# ifconfig 
</span><span class='line'>eth0      Link encap:Ethernet  HWaddr 02:42:0A:01:49:02  
</span><span class='line'>          inet addr:10.1.73.2  Bcast:0.0.0.0  Mask:255.255.255.0
</span><span class='line'>          inet6 addr: fe80::42:aff:fe01:4902/64 Scope:Link
</span><span class='line'>          UP BROADCAST RUNNING MULTICAST  MTU:1472  Metric:1
</span><span class='line'>          RX packets:8 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>          collisions:0 txqueuelen:0 
</span><span class='line'>          RX bytes:648 (648.0 b)  TX bytes:648 (648.0 b)
</span><span class='line'>
</span><span class='line'>lo        Link encap:Local Loopback  
</span><span class='line'>          inet addr:127.0.0.1  Mask:255.0.0.0
</span><span class='line'>          inet6 addr: ::1/128 Scope:Host
</span><span class='line'>          UP LOOPBACK RUNNING  MTU:65536  Metric:1
</span><span class='line'>          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>          collisions:0 txqueuelen:1 
</span><span class='line'>          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# kubectl scale --replicas=4 deployment/hadoop
</span><span class='line'>[root@k8s ~]# kubectl get pods
</span><span class='line'>NAME                      READY     STATUS    RESTARTS   AGE
</span><span class='line'>hadoop-2607718808-0dzm6   1/1       Running   0          15s
</span><span class='line'>hadoop-2607718808-9twzq   1/1       Running   0          15s
</span><span class='line'>hadoop-2607718808-cqx2n   1/1       Running   0          6h
</span><span class='line'>hadoop-2607718808-k243d   1/1       Running   0          15s
</span><span class='line'>
</span><span class='line'>登上以及启动的机器
</span><span class='line'>[root@k8s ~]# kubectl exec hadoop-2607718808-cqx2n -i -t -- bash
</span><span class='line'>[root@hadoop-2607718808-cqx2n /]# 
</span><span class='line'>
</span><span class='line'>改变部署实例个数
</span><span class='line'>[root@k8s ~]# kubectl scale --replicas=2 deployment/hadoop
</span><span class='line'>deployment "hadoop" scaled
</span><span class='line'>[root@k8s ~]# kubectl get pods
</span><span class='line'>NAME                      READY     STATUS    RESTARTS   AGE
</span><span class='line'>hadoop-2607718808-cqx2n   1/1       Running   0          6h
</span><span class='line'>hadoop-2607718808-k243d   1/1       Running   0          9m</span></code></pre></td></tr></table></div></figure>


<h2>小结</h2>

<p>通过脚本来安装其实不难，就是要翻墙以及一些防火墙的设置需要特别的注意。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/02/08/k8s-minikube-on-windows/">K8s Minikube on Windows</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-02-08T22:50:06+08:00" pubdate data-updated="true">Wed 2017-02-08 22:50</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>在windows配置minikube需要先安装docker，或者更直接点的说就是需要docker一样的依赖环境（都是通过iso装载到虚拟机，我们这里不考虑iso内部的软件配置）。先安装docker会把这些依赖都配置好。</p>

<p>系统当前的版本不支持直接安装<a href="https://docs.docker.com/docker-for-windows/">Docker</a>（This version of Docker requires Windows 10 Pro, Enterprise or Education edition with a mininum build number of 10586, Please use <a href="https://www.docker.com/products/docker-toolbox">Docker Toolbox</a>），</p>

<ul>
<li><a href="https://docs.docker.com/toolbox/toolbox_install_windows/">https://docs.docker.com/toolbox/toolbox_install_windows/</a></li>
<li><a href="https://rominirani.com/tutorial-getting-started-with-kubernetes-on-your-windows-laptop-with-minikube-3269b54a226#.qvn9h99l4">Tutorial : Getting Started with Kubernetes on your Windows Laptop with Minikube</a></li>
<li><a href="https://blogs.msdn.microsoft.com/wasimbloch/2017/01/23/setting-up-kubernetes-on-windows10-laptop-with-minikube/">Setting up Kubernetes on Windows10 Laptop with Minikube use Hyper-V</a></li>
</ul>


<p>如果直接全部安装toolbox的VirtualBox、git的应该一切顺利的。由于已有cygwin，想着复用下结果惹了一身骚。</p>

<p>按照自己的安装过程，先介绍下配合cygwin安装docker，然后再介绍全部按官网的工具安装k8s。</p>

<h2>仅尝试Docker，不安装k8s</h2>

<p><em>注：不推荐了！！！可以更新系统或者安装toolbox</em> -20190316</p>

<p>但是不想安装git直接使用cygwin来代替。刚刚开始的时刻出现了一些理解上的偏差，后来查询start.sh脚本后大概了解到快捷方式、脚本内容后问题就迎刃而解。</p>

<p>先安装docker toolbox：先禁用windows的Hyper-V；安装时去掉git组件。</p>

<p>安装完成后，启动cygwin的命令行（不要用Docker的快捷图标启动）。然后进行如下配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@Lenovo-PC ~
</span><span class='line'>$ cd "C:\Program Files\Docker Toolbox"
</span><span class='line'>
</span><span class='line'>做一个c盘的映射
</span><span class='line'>winse@Lenovo-PC /cygdrive/c/Program Files/Docker Toolbox
</span><span class='line'>$ ll /
</span><span class='line'>...
</span><span class='line'>lrwxrwxrwx   1 winse None               11 Apr  5  2016 c -&gt; /cygdrive/c
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>根据cygwin的路径配置VirtualBox的路径
</span><span class='line'>winse@Lenovo-PC /cygdrive/c/Program Files/Docker Toolbox
</span><span class='line'>$ export VBOX_MSI_INSTALL_PATH="/cygdrive/c/Program Files/Oracle/VirtualBox/"
</span><span class='line'>
</span><span class='line'>首先下载boot2docker.iso到 C:\Users\winse\.docker\machine\cache\boot2docker.iso
</span><span class='line'>https://github.com/boot2docker/boot2docker/releases/download/v1.13.0/boot2docker.iso...
</span><span class='line'>
</span><span class='line'>创建一个空的clear脚本（cygwin没有包括clear脚本）
</span><span class='line'>winse@Lenovo-PC /cygdrive/c/Program Files/Docker Toolbox
</span><span class='line'>$ touch ~/bin/clear && chmod +x ~/bin/clear
</span><span class='line'>
</span><span class='line'># 启动
</span><span class='line'>winse@Lenovo-PC /cygdrive/c/Program Files/Docker Toolbox
</span><span class='line'>$ ./start.sh
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                        ##         .
</span><span class='line'>                  ## ## ##        ==
</span><span class='line'>               ## ## ## ## ##    ===
</span><span class='line'>           /"""""""""""""""""\___/ ===
</span><span class='line'>      ~~~ {~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~
</span><span class='line'>           \______ o           __/
</span><span class='line'>             \    \         __/
</span><span class='line'>              \____\_______/
</span><span class='line'>
</span><span class='line'>docker is configured to use the default machine with IP 192.168.99.100
</span><span class='line'>For help getting started, check out the docs at https://docs.docker.com
</span><span class='line'>
</span><span class='line'>Start interactive shell
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC ~
</span><span class='line'>$ docker run hello-world
</span><span class='line'>time="2017-02-08T22:48:33+08:00" level=warning msg="Unable to use system certificate pool: crypto/x509: system root pool is not available on Windows"
</span><span class='line'>Unable to find image 'hello-world:latest' locally
</span><span class='line'>latest: Pulling from library/hello-world
</span><span class='line'>78445dd45222: Pulling fs layer
</span><span class='line'>78445dd45222: Verifying Checksum
</span><span class='line'>78445dd45222: Download complete
</span><span class='line'>78445dd45222: Pull complete
</span><span class='line'>Digest: sha256:c5515758d4c5e1e838e9cd307f6c6a0d620b5e07e6f927b07d05f6d12a1ac8d7
</span><span class='line'>Status: Downloaded newer image for hello-world:latest
</span><span class='line'>
</span><span class='line'>Hello from Docker!
</span><span class='line'>This message shows that your installation appears to be working correctly.
</span><span class='line'>
</span><span class='line'>To generate this message, Docker took the following steps:
</span><span class='line'> 1. The Docker client contacted the Docker daemon.
</span><span class='line'> 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
</span><span class='line'> 3. The Docker daemon created a new container from that image which runs the
</span><span class='line'>    executable that produces the output you are currently reading.
</span><span class='line'> 4. The Docker daemon streamed that output to the Docker client, which sent it
</span><span class='line'>    to your terminal.
</span><span class='line'>
</span><span class='line'>To try something more ambitious, you can run an Ubuntu container with:
</span><span class='line'> $ docker run -it ubuntu bash
</span><span class='line'>
</span><span class='line'>Share images, automate workflows, and more with a free Docker ID:
</span><span class='line'> https://cloud.docker.com/
</span><span class='line'>
</span><span class='line'>For more examples and ideas, visit:
</span><span class='line'> https://docs.docker.com/engine/userguide/
</span></code></pre></td></tr></table></div></figure>


<h2>使用默认安装，并安装k8s</h2>

<p>由于cygwin的路径与windows的不兼容，而git bash则本身依托于windows的命令行的，兼容性方面更优。</p>

<p>重新安装Docker ToolBox，安装时选择git。</p>

<p>下载minikube需要的一些软件：</p>

<ul>
<li><a href="https://github.com/kubernetes/minikube/releases">minikube.exe</a></li>
<li><a href="https://github.com/kubernetes/minikube/blob/v0.16.0/README.md">minikube文档</a></li>
<li><a href="https://storage.googleapis.com/kubernetes-release/release/v1.5.2/bin/windows/amd64/kubectl.exe">kubectl.exe</a></li>
<li><a href="https://rominirani.com/tutorial-getting-started-with-kubernetes-on-your-windows-laptop-with-minikube-3269b54a226#.pg14q9wst">Tutorial : Getting Started with Kubernetes on your Windows Laptop with Minikube</a></li>
<li><a href="https://kubernetes.io/docs/tutorials/stateless-application/hello-minikube/">Hello Minikube On OS X</a></li>
<li><a href="https://kubernetes.io/docs/getting-started-guides/minikube/">Running Kubernetes Locally via Minikube</a></li>
</ul>


<p>下载minikube和kubectl放到PATH路径下（bin目录已经在PATH中）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>E:\local\bin&gt;dir
</span><span class='line'>...
</span><span class='line'>2017-02-08  14:05        50,735,616 kubectl.exe
</span><span class='line'>2017-02-08  11:22        84,239,872 minikube-windows-amd64.exe
</span><span class='line'>2017-02-08  11:25    &lt;SYMLINK&gt;      minikube.exe [minikube-windows-amd64.exe] （mklink minikube.exe minikube-windows-amd64.exe）</span></code></pre></td></tr></table></div></figure>


<p>运行 <strong>Docker Quickstart Terminal</strong> (这个快捷方式会先启动docker的虚拟机)，或者直接打开 C:\Program Files\Git\bin\bash.exe 执行如下命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>查看帮助
</span><span class='line'>winse@Lenovo-PC MINGW64 ~
</span><span class='line'>$ minikube start --help
</span><span class='line'>Starts a local kubernetes cluster using Virtualbox. This command
</span><span class='line'>assumes you already have Virtualbox installed.
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>设置代理: 老外的教程都很简单就成功，但是我们操作一堆问题，主要就是万恶的防火墙！！！
</span><span class='line'>winse@Lenovo-PC MINGW64 ~
</span><span class='line'>$ export HTTPS_PROXY=http://localhost:8118
</span><span class='line'>$ export HTTP_PROXY=http://localhost:8118
</span><span class='line'>$ export NO_PROXY="192.168.0.0/16"
</span><span class='line'>
</span><span class='line'>启动
</span><span class='line'>winse@Lenovo-PC MINGW64 ~
</span><span class='line'>$ minikube start --v=7 --logtostderr
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 ~
</span><span class='line'>$ minikube status
</span><span class='line'>minikubeVM: Running
</span><span class='line'>localkube: Running
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 ~
</span><span class='line'>$ kubectl get nodes
</span><span class='line'>NAME       STATUS    AGE
</span><span class='line'>minikube   Ready     3h</span></code></pre></td></tr></table></div></figure>


<h4>再次启动，添加代理参数后dashboard才正常运行</h4>

<ul>
<li><a href="https://kubernetes.io/docs/tutorials/stateless-application/hello-minikube/">https://kubernetes.io/docs/tutorials/stateless-application/hello-minikube/</a></li>
<li><a href="https://rominirani.com/tutorial-getting-started-with-kubernetes-on-your-windows-laptop-with-minikube-3269b54a226">https://rominirani.com/tutorial-getting-started-with-kubernetes-on-your-windows-laptop-with-minikube-3269b54a226</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@Lenovo-PC MINGW64 /c/Program Files/Git/bin
</span><span class='line'>$ minikube start --docker-env HTTP_PROXY=http://192.168.99.1:8118 --docker-env HTTPS_PROXY=http://192.168.99.1:8118
</span><span class='line'>Starting local Kubernetes cluster...
</span><span class='line'>Kubectl is now configured to use the cluster.
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /c/Program Files/Git/bin
</span><span class='line'>$ minikube status
</span><span class='line'>minikubeVM: Running
</span><span class='line'>localkube: Running
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /c/Program Files/Git/bin
</span><span class='line'>$ kubectl cluster-info
</span><span class='line'>Kubernetes master is running at https://192.168.99.100:8443
</span><span class='line'>KubeDNS is running at https://192.168.99.100:8443/api/v1/proxy/namespaces/kube-system/services/kube-dns
</span><span class='line'>kubernetes-dashboard is running at https://192.168.99.100:8443/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard
</span><span class='line'>
</span><span class='line'>To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
</span><span class='line'>
</span><span class='line'>#Open dashboard
</span><span class='line'>https://github.com/kubernetes/minikube/issues/379
</span><span class='line'>https://github.com/kubernetes/minikube/issues/522
</span><span class='line'>winse@Lenovo-PC MINGW64 /c/Program Files/Git/bin
</span><span class='line'>$ minikube dashboard
</span><span class='line'>Opening kubernetes dashboard in default browser...
</span><span class='line'>
</span><span class='line'>运行实例
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl get nodes
</span><span class='line'>NAME       STATUS    AGE
</span><span class='line'>minikube   Ready     8h
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl run hello-nginx --image=nginx --port=80
</span><span class='line'>deployment "hello-nginx" created
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe get pods
</span><span class='line'>NAME                           READY     STATUS              RESTARTS   AGE
</span><span class='line'>hello-nginx-2471083592-cgn29   0/1       ContainerCreating   0          19s
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe get pods
</span><span class='line'>NAME                           READY     STATUS             RESTARTS   AGE
</span><span class='line'>hello-nginx-2471083592-cgn29   0/1       ImagePullBackOff   0          3m
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe describe pod hello-nginx-2471083592-cgn29
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe expose deployment hello-nginx --type=NodePort
</span><span class='line'>service "hello-nginx" exposed
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe get services
</span><span class='line'>NAME          CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE
</span><span class='line'>hello-nginx   10.0.0.145   &lt;nodes&gt;       80:31570/TCP   1m
</span><span class='line'>kubernetes    10.0.0.1     &lt;none&gt;        443/TCP        9h
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe describe service hello-nginx
</span><span class='line'>Name:                   hello-nginx
</span><span class='line'>Namespace:              default
</span><span class='line'>Labels:                 run=hello-nginx
</span><span class='line'>Selector:               run=hello-nginx
</span><span class='line'>Type:                   NodePort
</span><span class='line'>IP:                     10.0.0.145
</span><span class='line'>Port:                   &lt;unset&gt; 80/TCP
</span><span class='line'>NodePort:               &lt;unset&gt; 31570/TCP
</span><span class='line'>Endpoints:              172.17.0.4:80
</span><span class='line'>Session Affinity:       None
</span><span class='line'>No events.
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ minikube service --url=true hello-nginx
</span><span class='line'>http://192.168.99.100:31570
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe logs hello-nginx-2471083592-cgn29
</span><span class='line'>172.17.0.1 - - [10/Feb/2017:02:07:53 +0000] "GET / HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.111 Safari/537.36" "-"
</span><span class='line'>172.17.0.1 - - [10/Feb/2017:02:07:54 +0000] "GET /favicon.ico HTTP/1.1" 404 571 "http://192.168.99.100:31570/" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.111 Safari/537.36" "-"
</span><span class='line'>2017/02/10 02:07:54 [error] 6#6: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 172.17.0.1, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.99.100:31570", referrer: "http://192.168.99.100:31570/"
</span><span class='line'>
</span><span class='line'>水平扩展
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe scale --replicas=3 deployment/hello-nginx
</span><span class='line'>deployment "hello-nginx" scaled
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe get deployment
</span><span class='line'>NAME          DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>hello-nginx   3         3         3            1           21m</span></code></pre></td></tr></table></div></figure>


<p>暂时还不清楚负载均衡是怎么弄的。这个三个应用pods其实是在一个内网（172.17.0.4/5/6），对外有一个服务（10.0.0.145）。</p>

<p>基本的安装过程先记录这么多。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/02/06/docker-http-proxy-and-save-reload/">Docker代理配置以及导入导出</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-02-06T08:40:09+08:00" pubdate data-updated="true">Mon 2017-02-06 08:40</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><h2>代理</h2>

<p>关于http代理服务器的搭建，如果有外（国）网机器，直接用squid建就行了 <a href="http://dockone.io/article/1380">使用Squid3搭建Docker镜像下载代理</a> 。
如果已有shadowsocks的代理，可以用privoxy转成http代理服务器。</p>

<ul>
<li>网上参考</li>
</ul>


<p><a href="http://nknu.net/proxy-configuration-for-docker-on-centos-7/">http://nknu.net/proxy-configuration-for-docker-on-centos-7/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Edit /etc/sysconfig/docker and add the following lines:
</span><span class='line'>HTTP_PROXY='http://user:password@proxy-host:proxy-port'
</span><span class='line'>HTTPS_PROXY='http://user:password@proxy-host:proxy-port'
</span><span class='line'>
</span><span class='line'>For those settings to be taken into account, you’ll need to restart your docker daemon:
</span><span class='line'># systemctl restart docker</span></code></pre></td></tr></table></div></figure>


<ul>
<li>官网文档</li>
</ul>


<p><a href="https://docs.docker.com/engine/admin/systemd/#http-proxy">https://docs.docker.com/engine/admin/systemd/#http-proxy</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s docker.service.d]# pwd
</span><span class='line'>/etc/systemd/system/docker.service.d
</span><span class='line'>[root@k8s docker.service.d]# cat http-proxy.conf 
</span><span class='line'>[Service]
</span><span class='line'>Environment="HTTP_PROXY=http://127.0.0.1:8118/" "NO_PROXY=localhost,127.0.0.1"
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>查看配置的环境变量是否生效
</span><span class='line'>$ sudo systemctl daemon-reload
</span><span class='line'>$ sudo service docker start
</span><span class='line'>$ sudo systemctl show --property Environment docker
</span><span class='line'>
</span><span class='line'>配置代理后下载google容器杠杠的
</span><span class='line'>[root@k8s docker-multinode]# docker pull gcr.io/google_containers/etcd-amd64:3.0.4
</span></code></pre></td></tr></table></div></figure>


<p>如果是自己编译的docker，自启动脚本配置可以参考：<a href="https://github.com/docker/docker/blob/master/contrib/init/systemd/docker.socket">https://github.com/docker/docker/blob/master/contrib/init/systemd/docker.socket</a></p>

<h2>导入导出</h2>

<p><a href="https://tuhrig.de/difference-between-save-and-export-in-docker/">https://tuhrig.de/difference-between-save-and-export-in-docker/</a></p>

<p>对于已经通过代理下载的docker，可以通过导入导出到另外的机器。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# docker save `docker images | grep -v TAG | awk '{print $1":"$2}'` &gt;k8s.tar
</span><span class='line'>
</span><span class='line'>[root@k8s data]# docker load &lt;k8s.tar
</span><span class='line'>0341ae9b0004: Loading layer [==================================================&gt;]  89.1 MB/89.1 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/kubernetes-dashboard-amd64:v1.5.0
</span><span class='line'>011b303988d2: Loading layer [==================================================&gt;]  5.05 MB/5.05 MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>596242791254: Loading layer [==================================================&gt;] 792.1 kB/792.1 kB
</span><span class='line'>4e504f64df23: Loading layer [==================================================&gt;]  5.29 MB/5.29 MB
</span><span class='line'>2897536d1f1f: Loading layer [==================================================&gt;] 3.584 kB/3.584 kB
</span><span class='line'>ae11e34e71e6: Loading layer [==================================================&gt;] 10.75 kB/10.75 kB
</span><span class='line'>81620de5436f: Loading layer [==================================================&gt;]  2.56 kB/2.56 kB
</span><span class='line'>77cb0f2fbaed: Loading layer [==================================================&gt;] 50.33 MB/50.33 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/kube-addon-manager-amd64:v6.1
</span><span class='line'>9007f5987db3: Loading layer [==================================================&gt;]  5.05 MB/5.05 MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>d41159f2130e: Loading layer [==================================================&gt;] 9.201 MB/9.201 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/dnsmasq-metrics-amd64:1.0
</span><span class='line'>2c84284818d1: Loading layer [==================================================&gt;] 1.312 MB/1.312 MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>5e47621858b3: Loading layer [==================================================&gt;] 38.51 MB/38.51 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/etcd-amd64:3.0.4
</span><span class='line'>b6ca02dfe5e6: Loading layer [==================================================&gt;] 128.9 MB/128.9 MB
</span><span class='line'>c2c974a0ae12: Loading layer [==================================================&gt;] 231.6 MB/231.6 MB
</span><span class='line'>88e4c6b7e766: Loading layer [==================================================&gt;] 25.09 kB/25.09 kB
</span><span class='line'>96257390754d: Loading layer [==================================================&gt;] 10.75 kB/10.75 kB
</span><span class='line'>36bd77066b3a: Loading layer [==================================================&gt;]  7.68 kB/7.68 kB
</span><span class='line'>6e833518b289: Loading layer [==================================================&gt;] 28.16 kB/28.16 kB
</span><span class='line'>88d2c1399894: Loading layer [==================================================&gt;] 11.78 kB/11.78 kB
</span><span class='line'>b857f858f4ad: Loading layer [==================================================&gt;] 46.08 kB/46.08 kB
</span><span class='line'>13da16246a77: Loading layer [==================================================&gt;] 56.58 MB/56.58 MB
</span><span class='line'>98a8cc89f2d0: Loading layer [==================================================&gt;] 4.608 kB/4.608 kB
</span><span class='line'>1b7eeaac3364: Loading layer [==================================================&gt;]  5.12 kB/5.12 kB
</span><span class='line'>c85758bfcfdf: Loading layer [==================================================&gt;] 153.9 MB/153.9 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/hyperkube-amd64:v1.5.2
</span><span class='line'>3fc666989c1d: Loading layer [==================================================&gt;] 5.046 MB/5.046 MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>9eed5e14d7fb: Loading layer [==================================================&gt;] 348.7 kB/348.7 kB
</span><span class='line'>00dc4ffe8624: Loading layer [==================================================&gt;]  2.56 kB/2.56 kB
</span><span class='line'>Loaded image: gcr.io/google_containers/kube-dnsmasq-amd64:1.4
</span><span class='line'>8ac8bfaff55a: Loading layer [==================================================&gt;] 1.293 MB/1.293 MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>dc978cfc3e09: Loading layer [==================================================&gt;] 7.279 MB/7.279 MB
</span><span class='line'>99740866972b: Loading layer [==================================================&gt;] 7.168 kB/7.168 kB
</span><span class='line'>Loaded image: gcr.io/google_containers/exechealthz-amd64:1.2
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>41ff149e94f2: Loading layer [==================================================&gt;] 748.5 kB/748.5 kB
</span><span class='line'>Loaded image: gcr.io/google_containers/pause-amd64:3.0
</span><span class='line'>b79219965469: Loading layer [==================================================&gt;] 45.91 MB/45.91 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/kubedns-amd64:1.9</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/02/04/privoxy-http-proxy-for-shadowsocks/">使用Privoxy把shadowsocks转换为Http代理</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-02-04T15:36:08+08:00" pubdate data-updated="true">Sat 2017-02-04 15:36</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://program-think.blogspot.com/2014/12/gfw-privoxy.html">https://program-think.blogspot.com/2014/12/gfw-privoxy.html</a></p>

<p>Privoxy是一个代理辅助工具，这里用Privoxy把Shadowsocks socks5代理转换为http代理。</p>

<p>kubernetes的docker容器需要访问google的服务，docker暂时只支持http代理，而我手上有的代理是 <a href="http://99ss.in">shadowsocks</a> 的。这里通过Privoxy把socks5转成http代理。</p>

<p>阿里云的主机优化：<a href="https://promotion.aliyun.com/ntms/act/qwbk.html">https://promotion.aliyun.com/ntms/act/qwbk.html</a></p>

<h2>安装Shadowsocks</h2>

<ul>
<li><a href="http://blog.lxx1.com/1420">http://blog.lxx1.com/1420</a></li>
<li><a href="https://shadowsocks.org/en/download/clients.html">https://shadowsocks.org/en/download/clients.html</a></li>
<li><a href="https://github.com/shadowsocks/shadowsocks/wiki/Shadowsocks-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E">Shadowsocks 使用说明</a></li>
<li><a href="https://github.com/shadowsocks/shadowsocks/wiki/Configuration-via-Config-File">Configuration via Config File</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# yum install epel-release python-pip -y
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# pip install shadowsocks
</span><span class='line'>Collecting shadowsocks
</span><span class='line'>  Downloading shadowsocks-2.8.2.tar.gz
</span><span class='line'>Installing collected packages: shadowsocks
</span><span class='line'>  Running setup.py install for shadowsocks ... done
</span><span class='line'>Successfully installed shadowsocks-2.8.2
</span><span class='line'>You are using pip version 8.1.2, however version 9.0.1 is available.
</span><span class='line'>You should consider upgrading via the 'pip install --upgrade pip' command.
</span><span class='line'>
</span><span class='line'>上面软件已经安装好了, 推荐更新下pip.
</span><span class='line'>[root@k8s ~]# pip install --upgrade pip
</span><span class='line'>Collecting pip
</span><span class='line'>  Downloading pip-9.0.1-py2.py3-none-any.whl (1.3MB)
</span><span class='line'>    100% |████████████████████████████████| 1.3MB 46kB/s 
</span><span class='line'>Installing collected packages: pip
</span><span class='line'>  Found existing installation: pip 8.1.2
</span><span class='line'>    Uninstalling pip-8.1.2:
</span><span class='line'>      Successfully uninstalled pip-8.1.2
</span><span class='line'>Successfully installed pip-9.0.1
</span></code></pre></td></tr></table></div></figure>


<p>填写shadowsocks服务端信息以及本地映射端口，启动Shandowsocks的客户端：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# cat /etc/shadowsocks.json 
</span><span class='line'>{
</span><span class='line'>"server": "xxxxxx",
</span><span class='line'>"server_port": xxx,
</span><span class='line'>"local_port": 1080,
</span><span class='line'>"password": "xxxxxxxx",
</span><span class='line'>"timeout": 600,
</span><span class='line'>"method": "rc4-md5",
</span><span class='line'>"fast_open": false,
</span><span class='line'>"workers": 1
</span><span class='line'>}
</span><span class='line'>[root@k8s ~]# sslocal -c /etc/shadowsocks.json </span></code></pre></td></tr></table></div></figure>


<p>配置防火墙（如果其他主机也需要用这个代理的话）</p>

<p><a href="https://havee.me/linux/2015-01/using-firewalls-on-centos-7.html">https://havee.me/linux/2015-01/using-firewalls-on-centos-7.html</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@bigdata-dev ~]# firewall-cmd --zone=public --add-port=1080/tcp --permanent
</span><span class='line'>[root@bigdata-dev ~]# firewall-cmd --reload</span></code></pre></td></tr></table></div></figure>


<h2>安装privoxy</h2>

<ul>
<li><a href="https://www.privoxy.org/sf-download-mirror/Win32/3.0.26%20%28stable%29/">windows版本下载地址</a></li>
<li><a href="http://www.ttlsa.com/linux/privoxy-convert-socks-proxy-to-http/">http://www.ttlsa.com/linux/privoxy-convert-socks-proxy-to-http/</a></li>
<li><a href="https://blog.phpgao.com/privoxy-shadowsocks.html">https://blog.phpgao.com/privoxy-shadowsocks.html</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# yum install privoxy -y
</span><span class='line'>
</span><span class='line'>查找listen-address行注释掉，在最后添加如下两行
</span><span class='line'>[root@k8s docker.service.d]# vi /etc/privoxy/config 
</span><span class='line'>...
</span><span class='line'>forward-socks5 / 127.0.0.1:1080 .
</span><span class='line'>listen-address k8s:8118
</span><span class='line'>
</span><span class='line'># 启动
</span><span class='line'>[root@k8s ~]# systemctl start privoxy
</span><span class='line'># 查看状态
</span><span class='line'>[root@k8s ~]# systemctl status privoxy
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# systemctl enable privoxy
</span><span class='line'>Created symlink from /etc/systemd/system/multi-user.target.wants/privoxy.service to /usr/lib/systemd/system/privoxy.service.
</span><span class='line'>
</span><span class='line'>如果其他机器需要用到代理的话，需要配置防火墙开放端口
</span><span class='line'>[root@k8s ~]# firewall-cmd --zone=public --add-port=8118/tcp --permanent
</span><span class='line'>[root@k8s ~]# firewall-cmd --reload </span></code></pre></td></tr></table></div></figure>


<p>通过curl加代理参数：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# curl google.com
</span><span class='line'>curl: (7) Failed to connect to 2404:6800:4008:802::200e: Network is unreachable
</span><span class='line'>[root@k8s ~]# 
</span><span class='line'>[root@k8s ~]# curl -x localhost:8118 google.com
</span><span class='line'>&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv="content-type" content="text/html;charset=utf-8"&gt;
</span><span class='line'>&lt;TITLE&gt;301 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
</span><span class='line'>&lt;H1&gt;301 Moved&lt;/H1&gt;
</span><span class='line'>The document has moved
</span><span class='line'>&lt;A HREF="http://www.google.com/"&gt;here&lt;/A&gt;.
</span><span class='line'>&lt;/BODY&gt;&lt;/HTML&gt;</span></code></pre></td></tr></table></div></figure>


<p>或者安装桌面环境，在本机调试会方便点，</p>

<p><a href="http://unix.stackexchange.com/questions/181503/how-to-install-desktop-environments-on-centos-7">http://unix.stackexchange.com/questions/181503/how-to-install-desktop-environments-on-centos-7</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum -y groups install "GNOME Desktop" </span></code></pre></td></tr></table></div></figure>


<p>然后firefox安装autoproxy，配置http代理。（firefox自带的代理有点抽风，不太好用）</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/15">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/13">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>
  <h1><a class='category' href='/blog/categories/recommend/'>Recommend</a></h1>
	<ul role="list">
		
			<li class="post">
				<a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/08/25/video-auto-translate/">视频自动翻译</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/06/09/reasonable-way-to-access-the-internet/">科学上网（续）</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/01/20/gitalk-on-octopress/">Gitalk on Octopress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/11/16/sphinx-generate-docs/">使用Sphinx生成/管理文档</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/10/30/windows-run-ubuntu/">Windows Run Ubuntu</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/30/kubeadm-install-kubenetes-on-centos7/">Kubeadm部署kubernetes</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/08/casperjs-crawler/">爬虫之CasperJS</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/05/23/spark-on-hive-speculation-shit-bug/">Hive on Spark预测性执行BUG一枚</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/27/vnc-server-on-centos7/">在Centos7上安装VNC Server</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/19/nginx-https/">Nginx配置https</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/09/19/163-open-movies-download/">批量下载163-open的视频</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/23/hadoop-guide-catalog/">[整理] Hadoop入门</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/04/rpm-build-your-package/">RPM打包</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/03/28/hive-on-spark/">Hive on Spark</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/11/22/gfw-ladder/">搭梯笔记</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/08/24/manual-install-supervisor/">Supervisor安装配置</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/10/16/spark-build-and-configuration/">编译/搭建Spark环境</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/08/25/step-by-step-found-java-oom-error/">查找逐步定位Java程序OOM的异常实践</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/30/hadoop2-snappy-compress/">Hadoop2 Snappy Compress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/27/start-redis/">[读读书]Redis入门指南</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/04/21/hadoop2-windows-startguide/">Windows下部署/配置/调试hadoop2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/30/git-cheatsheet/">GIT操作记录手册</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/18/jekyll-edit-link-in-web-page/">Jekyll页面添加编辑按钮</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/02/23/quickly-open-program-in-windows/">[Windows运行]快速打开程序</a>
			</li>
		
	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2023/02/01/register-openai/">注册OpenAI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/07/24/xinchuang-install-postgres/">信创环境迁移浅析-以Postgres为例</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/04/19/k8s-nfs-run-example/">K8S官方例子NFS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/04/14/k8s-nfs/">k8s共享存储使用NFS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/04/11/xiaomi-r4a-install-padavan/">Xiaomi R4a Install Padavan</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/04/06/minikube-guide/">Minikube Guide</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/03/26/k8s-ingress/">K8s Ingress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/03/18/k8s-guide-use-kubeadm/">k8s-v1.23.5安装指南 - 使用kubeadm</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/0/'>0</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/alluxio/'>alluxio</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/android/'>android</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/bigdata/'>bigdata</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blabla/'>blabla</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/debug/'>debug</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/deprecated/'>deprecated</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/devops/'>devops</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (16) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/es/'>es</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/flume/'>flume</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/git/'>git</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (44) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hbase/'>hbase</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hole/'>hole</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jenkins/'>jenkins</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jeykll/'>jeykll</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k2/'>k2</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kafka/'>kafka</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kubeadm/'>kubeadm</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/logstash/'>logstash</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/map/'>map</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nfs/'>nfs</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/openai/'>openai</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/openeuler/'>openeuler</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/r4a/'>r4a</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/recommend/'>recommend</a> (25) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/shell/'>shell</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/staf/'>staf</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tachyon/'>tachyon</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tez/'>tez</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tools/'>tools</a> (68) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/topics/'>topics</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/vagrant/'>vagrant</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/wsl/'>wsl</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/zookeeper/'>zookeeper</a> (1) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (229)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<!--
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
&#8211;>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2023 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1253103971'%3E%3C/span%3E%3Cscript src='https://s19.cnzz.com/z_stat.php%3Fid%3D1253103971%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winse.github.io" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>











</body>
</html>
