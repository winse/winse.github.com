
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="总有单机搞不定的时刻，并且手动切分很麻烦的时刻。不得不开始redis集群，官网的redis3不支持pipeline首先就排除了。 安装codis，需要先安装go。(官网入门文档](https://github.com/CodisLabs/codis/blob/master/doc/ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winse.github.io/posts/17">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/libs/jquery.toc.min.js" type="text/javascript"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

<script src="/javascripts/generate-toc.js" type="text/javascript"></script>


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43198550-1', 'auto');
  ga('send', 'pageview');

</script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停, 熙熙攘攘, 忙忙碌碌, 不知何畏.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winse.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/14/codis-guide/">Codis简单使用</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-07-14T19:35:23+08:00" pubdate data-updated="true">Thu 2016-07-14 19:35</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>总有单机搞不定的时刻，并且手动切分很麻烦的时刻。不得不开始redis集群，官网的redis3不支持pipeline首先就排除了。</p>

<p>安装codis，需要先安装go。(官网入门文档](<a href="https://github.com/CodisLabs/codis/blob/master/doc/tutorial_zh.md">https://github.com/CodisLabs/codis/blob/master/doc/tutorial_zh.md</a>)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 local]# tar zxvf go1.6.2.linux-amd64.tar.gz 
</span><span class='line'>
</span><span class='line'>[hadoop@cu2 ~]$ vi .bash_profile
</span><span class='line'>...
</span><span class='line'>export GOROOT=/usr/local/go
</span><span class='line'>export GOPATH=$HOME/codis
</span><span class='line'>
</span><span class='line'>PATH=$GOPATH/bin:$GOROOT/bin:$HOME/bin:$HADOOP_HOME/bin:$HIVE_HOME/bin:$PATH
</span><span class='line'>
</span><span class='line'>[hadoop@cu2 codis]$ source ~/.bash_profile </span></code></pre></td></tr></table></div></figure>


<p>git,make 这些要提前安装好。测试环境都编译过hadoop、spark肯定齐全的。</p>

<p>通过go在线安装（如果生产不能上网，可以先在测试环境安装好后，然后打包复制过去）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 codis]$ go get -u -d github.com/CodisLabs/codis
</span><span class='line'>package github.com/CodisLabs/codis: no buildable Go source files in /home/hadoop/codis/src/github.com/CodisLabs/codis
</span><span class='line'>[hadoop@cu2 codis]$ 
</span><span class='line'>
</span><span class='line'>&lt;&lt;安装依赖的工具
</span><span class='line'>[hadoop@cu2 codis]$ go get github.com/tools/godep
</span><span class='line'>
</span><span class='line'>[hadoop@cu2 codis]$ make
</span><span class='line'>GO15VENDOREXPERIMENT=0 GOPATH=`godep path` godep restore
</span><span class='line'>godep: [WARNING]: godep should only be used inside a valid go package directory and
</span><span class='line'>godep: [WARNING]: may not function correctly. You are probably outside of your $GOPATH.
</span><span class='line'>godep: [WARNING]:       Current Directory: /home/hadoop/codis/src/github.com/CodisLabs/codis
</span><span class='line'>godep: [WARNING]:       $GOPATH: /home/hadoop/codis/src/github.com/CodisLabs/codis/Godeps/_workspace
</span><span class='line'>       
</span><span class='line'>&lt;&lt;这里要等一段时间
</span><span class='line'>
</span><span class='line'>GOPATH=`godep path`:$GOPATH go build -o bin/codis-proxy ./cmd/proxy
</span><span class='line'>godep: WARNING: Godep workspaces (./Godeps/_workspace) are deprecated and support for them will be removed when go1.8 is released.
</span><span class='line'>godep: WARNING: Go version (go1.6) & $GO15VENDOREXPERIMENT= wants to enable the vendor experiment, but disabling because a Godep workspace (Godeps/_workspace) exists
</span><span class='line'>GOPATH=`godep path`:$GOPATH go build -o bin/codis-config ./cmd/cconfig
</span><span class='line'>godep: WARNING: Godep workspaces (./Godeps/_workspace) are deprecated and support for them will be removed when go1.8 is released.
</span><span class='line'>godep: WARNING: Go version (go1.6) & $GO15VENDOREXPERIMENT= wants to enable the vendor experiment, but disabling because a Godep workspace (Godeps/_workspace) exists
</span><span class='line'>make -j4 -C extern/redis-2.8.21/
</span><span class='line'>make[1]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21'
</span><span class='line'>cd src && make all
</span><span class='line'>make[2]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/src'
</span><span class='line'>rm -rf redis-server redis-sentinel redis-cli redis-benchmark redis-check-dump redis-check-aof *.o *.gcda *.gcno *.gcov redis.info lcov-html
</span><span class='line'>(cd ../deps && make distclean)
</span><span class='line'>make[3]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps'
</span><span class='line'>(cd hiredis && make clean) &gt; /dev/null || true
</span><span class='line'>(cd linenoise && make clean) &gt; /dev/null || true
</span><span class='line'>(cd lua && make clean) &gt; /dev/null || true
</span><span class='line'>(cd jemalloc && [ -f Makefile ] && make distclean) &gt; /dev/null || true
</span><span class='line'>(rm -f .make-*)
</span><span class='line'>make[3]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps'
</span><span class='line'>(rm -f .make-*)
</span><span class='line'>echo STD=-std=c99 -pedantic &gt;&gt; .make-settings
</span><span class='line'>echo WARN=-Wall -W &gt;&gt; .make-settings
</span><span class='line'>echo OPT=-O2 &gt;&gt; .make-settings
</span><span class='line'>echo MALLOC=jemalloc &gt;&gt; .make-settings
</span><span class='line'>echo CFLAGS= &gt;&gt; .make-settings
</span><span class='line'>echo LDFLAGS= &gt;&gt; .make-settings
</span><span class='line'>echo REDIS_CFLAGS= &gt;&gt; .make-settings
</span><span class='line'>echo REDIS_LDFLAGS= &gt;&gt; .make-settings
</span><span class='line'>echo PREV_FINAL_CFLAGS=-std=c99 -pedantic -Wall -W -O2 -g -ggdb   -I../deps/hiredis -I../deps/linenoise -I../deps/lua/src -DUSE_JEMALLOC -I../deps/jemalloc/include &gt;&gt; .make-settings
</span><span class='line'>echo PREV_FINAL_LDFLAGS=  -g -ggdb -rdynamic &gt;&gt; .make-settings
</span><span class='line'>(cd ../deps && make hiredis linenoise lua jemalloc)
</span><span class='line'>make[3]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps'
</span><span class='line'>(cd hiredis && make clean) &gt; /dev/null || true
</span><span class='line'>(cd linenoise && make clean) &gt; /dev/null || true
</span><span class='line'>(cd lua && make clean) &gt; /dev/null || true
</span><span class='line'>(cd jemalloc && [ -f Makefile ] && make distclean) &gt; /dev/null || true
</span><span class='line'>(rm -f .make-*)
</span><span class='line'>(echo "" &gt; .make-ldflags)
</span><span class='line'>(echo "" &gt; .make-cflags)
</span><span class='line'>MAKE hiredis
</span><span class='line'>cd hiredis && make static
</span><span class='line'>MAKE linenoise
</span><span class='line'>cd linenoise && make
</span><span class='line'>MAKE lua
</span><span class='line'>cd lua/src && make all CFLAGS="-O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL " MYLDFLAGS="" AR="ar rcu"
</span><span class='line'>MAKE jemalloc
</span><span class='line'>cd jemalloc && ./configure --with-jemalloc-prefix=je_ --enable-cc-silence CFLAGS="-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops " LDFLAGS=""
</span><span class='line'>make[4]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/linenoise'
</span><span class='line'>cc  -Wall -Os -g  -c linenoise.c
</span><span class='line'>make[4]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/lua/src'
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lapi.o lapi.c
</span><span class='line'>make[4]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/hiredis'
</span><span class='line'>cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  net.c
</span><span class='line'>checking for xsltproc... /usr/bin/xsltproc
</span><span class='line'>checking for gcc... gcc
</span><span class='line'>checking whether the C compiler works... yes
</span><span class='line'>checking for C compiler default output file name... a.out
</span><span class='line'>checking for suffix of executables... 
</span><span class='line'>checking whether we are cross compiling... no
</span><span class='line'>checking for suffix of object files... o
</span><span class='line'>checking whether we are using the GNU C compiler... cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  hiredis.c
</span><span class='line'>yes
</span><span class='line'>checking whether gcc accepts -g... yes
</span><span class='line'>checking for gcc option to accept ISO C89... none needed
</span><span class='line'>checking how to run the C preprocessor... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lcode.o lcode.c
</span><span class='line'>make[4]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/linenoise'
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ldebug.o ldebug.c
</span><span class='line'>gcc -E
</span><span class='line'>checking for grep that handles long lines and -e... /bin/grep
</span><span class='line'>checking for egrep... /bin/grep -E
</span><span class='line'>checking for ANSI C header files... yes
</span><span class='line'>checking for sys/types.h... yes
</span><span class='line'>checking for sys/stat.h... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ldo.o ldo.c
</span><span class='line'>yes
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ldump.o ldump.c
</span><span class='line'>checking for stdlib.h... ldo.c: In function ‘f_parser’:
</span><span class='line'>ldo.c:496: warning: unused variable ‘c’
</span><span class='line'>yes
</span><span class='line'>checking for string.h... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lfunc.o lfunc.c
</span><span class='line'>yes
</span><span class='line'>checking for memory.h... yes
</span><span class='line'>checking for strings.h... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lgc.o lgc.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o llex.o llex.c
</span><span class='line'>yes
</span><span class='line'>cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  sds.c
</span><span class='line'>checking for inttypes.h... yes
</span><span class='line'>checking for stdint.h... yes
</span><span class='line'>checking for unistd.h... yes
</span><span class='line'>checking whether byte ordering is bigendian... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lmem.o lmem.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lobject.o lobject.c
</span><span class='line'>no
</span><span class='line'>checking size of void *... cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  async.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lopcodes.o lopcodes.c
</span><span class='line'>8
</span><span class='line'>checking size of int... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lparser.o lparser.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lstate.o lstate.c
</span><span class='line'>4
</span><span class='line'>checking size of long... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lstring.o lstring.c
</span><span class='line'>8
</span><span class='line'>checking size of intmax_t... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ltable.o ltable.c
</span><span class='line'>8
</span><span class='line'>checking build system type... ar rcs libhiredis.a net.o hiredis.o sds.o async.o
</span><span class='line'>x86_64-unknown-linux-gnu
</span><span class='line'>checking host system type... x86_64-unknown-linux-gnu
</span><span class='line'>checking whether pause instruction is compilable... make[4]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/hiredis'
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ltm.o ltm.c
</span><span class='line'>yes
</span><span class='line'>checking whether SSE2 intrinsics is compilable... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lundump.o lundump.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lvm.o lvm.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lzio.o lzio.c
</span><span class='line'>yes
</span><span class='line'>checking for ar... ar
</span><span class='line'>checking whether __attribute__ syntax is compilable... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o strbuf.o strbuf.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o fpconv.o fpconv.c
</span><span class='line'>yes
</span><span class='line'>checking whether compiler supports -fvisibility=hidden... yes
</span><span class='line'>checking whether compiler supports -Werror... yes
</span><span class='line'>checking whether tls_model attribute is compilable... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lauxlib.o lauxlib.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lbaselib.o lbaselib.c
</span><span class='line'>yes
</span><span class='line'>checking for a BSD-compatible install... /usr/bin/install -c
</span><span class='line'>checking for ranlib... ranlib
</span><span class='line'>checking for ld... /usr/bin/ld
</span><span class='line'>checking for autoconf... /usr/bin/autoconf
</span><span class='line'>checking for memalign... yes
</span><span class='line'>checking for valloc... yes
</span><span class='line'>checking configured backtracing method... N/A
</span><span class='line'>checking for sbrk... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ldblib.o ldblib.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o liolib.o liolib.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lmathlib.o lmathlib.c
</span><span class='line'>yes
</span><span class='line'>checking whether utrace(2) is compilable... no
</span><span class='line'>checking whether valgrind is compilable... no
</span><span class='line'>checking STATIC_PAGE_SHIFT... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o loslib.o loslib.c
</span><span class='line'>12
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ltablib.o ltablib.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lstrlib.o lstrlib.c
</span><span class='line'>checking pthread.h usability... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o loadlib.o loadlib.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o linit.o linit.c
</span><span class='line'>yes
</span><span class='line'>checking pthread.h presence... yes
</span><span class='line'>checking for pthread.h... yes
</span><span class='line'>checking for pthread_create in -lpthread... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lua_cjson.o lua_cjson.c
</span><span class='line'>yes
</span><span class='line'>checking for _malloc_thread_cleanup... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lua_struct.o lua_struct.c
</span><span class='line'>no
</span><span class='line'>checking for _pthread_mutex_init_calloc_cb... no
</span><span class='line'>checking for TLS... yes
</span><span class='line'>checking whether a program using ffsl is compilable... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lua_cmsgpack.o lua_cmsgpack.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lua_bit.o lua_bit.c
</span><span class='line'>yes
</span><span class='line'>checking whether atomic(9) is compilable... no
</span><span class='line'>checking whether Darwin OSAtomic*() is compilable... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lua.o lua.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o luac.o luac.c
</span><span class='line'>no
</span><span class='line'>checking whether to force 32-bit __sync_{add,sub}_and_fetch()... no
</span><span class='line'>checking whether to force 64-bit __sync_{add,sub}_and_fetch()... no
</span><span class='line'>checking whether Darwin OSSpin*() is compilable... no
</span><span class='line'>checking for stdbool.h that conforms to C99... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o print.o print.c
</span><span class='line'>yes
</span><span class='line'>checking for _Bool... ar rcu liblua.a lapi.o lcode.o ldebug.o ldo.o ldump.o lfunc.o lgc.o llex.o lmem.o lobject.o lopcodes.o lparser.o lstate.o lstring.o ltable.o ltm.o lundump.o lvm.o lzio.o strbuf.o fpconv.o lauxlib.o lbaselib.o ldblib.o liolib.o lmathlib.o loslib.o ltablib.o lstrlib.o loadlib.o linit.o lua_cjson.o lua_struct.o lua_cmsgpack.o lua_bit.o        # DLL needs all object files
</span><span class='line'>ranlib liblua.a
</span><span class='line'>cc -o lua  lua.o liblua.a -lm 
</span><span class='line'>liblua.a(loslib.o): In function `os_tmpname':
</span><span class='line'>loslib.c:(.text+0x35): warning: the use of `tmpnam' is dangerous, better use `mkstemp'
</span><span class='line'>cc -o luac  luac.o print.o liblua.a -lm 
</span><span class='line'>yes
</span><span class='line'>make[4]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/lua/src'
</span><span class='line'>configure: creating ./config.status
</span><span class='line'>config.status: creating Makefile
</span><span class='line'>config.status: creating doc/html.xsl
</span><span class='line'>config.status: creating doc/manpages.xsl
</span><span class='line'>config.status: creating doc/jemalloc.xml
</span><span class='line'>config.status: creating include/jemalloc/jemalloc_macros.h
</span><span class='line'>config.status: creating include/jemalloc/jemalloc_protos.h
</span><span class='line'>config.status: creating include/jemalloc/internal/jemalloc_internal.h
</span><span class='line'>config.status: creating test/test.sh
</span><span class='line'>config.status: creating test/include/test/jemalloc_test.h
</span><span class='line'>config.status: creating config.stamp
</span><span class='line'>config.status: creating bin/jemalloc.sh
</span><span class='line'>config.status: creating include/jemalloc/jemalloc_defs.h
</span><span class='line'>config.status: creating include/jemalloc/internal/jemalloc_internal_defs.h
</span><span class='line'>config.status: creating test/include/test/jemalloc_test_defs.h
</span><span class='line'>config.status: executing include/jemalloc/internal/private_namespace.h commands
</span><span class='line'>config.status: executing include/jemalloc/internal/private_unnamespace.h commands
</span><span class='line'>config.status: executing include/jemalloc/internal/public_symbols.txt commands
</span><span class='line'>config.status: executing include/jemalloc/internal/public_namespace.h commands
</span><span class='line'>config.status: executing include/jemalloc/internal/public_unnamespace.h commands
</span><span class='line'>config.status: executing include/jemalloc/internal/size_classes.h commands
</span><span class='line'>config.status: executing include/jemalloc/jemalloc_protos_jet.h commands
</span><span class='line'>config.status: executing include/jemalloc/jemalloc_rename.h commands
</span><span class='line'>config.status: executing include/jemalloc/jemalloc_mangle.h commands
</span><span class='line'>config.status: executing include/jemalloc/jemalloc_mangle_jet.h commands
</span><span class='line'>config.status: executing include/jemalloc/jemalloc.h commands
</span><span class='line'>===============================================================================
</span><span class='line'>jemalloc version   : 3.6.0-0-g46c0af68bd248b04df75e4f92d5fb804c3d75340
</span><span class='line'>library revision   : 1
</span><span class='line'>
</span><span class='line'>CC                 : gcc
</span><span class='line'>CPPFLAGS           :  -D_GNU_SOURCE -D_REENTRANT
</span><span class='line'>CFLAGS             : -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -fvisibility=hidden
</span><span class='line'>LDFLAGS            : 
</span><span class='line'>EXTRA_LDFLAGS      : 
</span><span class='line'>LIBS               :  -lpthread
</span><span class='line'>RPATH_EXTRA        : 
</span><span class='line'>
</span><span class='line'>XSLTPROC           : /usr/bin/xsltproc
</span><span class='line'>XSLROOT            : 
</span><span class='line'>
</span><span class='line'>PREFIX             : /usr/local
</span><span class='line'>BINDIR             : /usr/local/bin
</span><span class='line'>INCLUDEDIR         : /usr/local/include
</span><span class='line'>LIBDIR             : /usr/local/lib
</span><span class='line'>DATADIR            : /usr/local/share
</span><span class='line'>MANDIR             : /usr/local/share/man
</span><span class='line'>
</span><span class='line'>srcroot            : 
</span><span class='line'>abs_srcroot        : /home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/jemalloc/
</span><span class='line'>objroot            : 
</span><span class='line'>abs_objroot        : /home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/jemalloc/
</span><span class='line'>
</span><span class='line'>JEMALLOC_PREFIX    : je_
</span><span class='line'>JEMALLOC_PRIVATE_NAMESPACE
</span><span class='line'>                   : je_
</span><span class='line'>install_suffix     : 
</span><span class='line'>autogen            : 0
</span><span class='line'>experimental       : 1
</span><span class='line'>cc-silence         : 1
</span><span class='line'>debug              : 0
</span><span class='line'>code-coverage      : 0
</span><span class='line'>stats              : 1
</span><span class='line'>prof               : 0
</span><span class='line'>prof-libunwind     : 0
</span><span class='line'>prof-libgcc        : 0
</span><span class='line'>prof-gcc           : 0
</span><span class='line'>tcache             : 1
</span><span class='line'>fill               : 1
</span><span class='line'>utrace             : 0
</span><span class='line'>valgrind           : 0
</span><span class='line'>xmalloc            : 0
</span><span class='line'>mremap             : 0
</span><span class='line'>munmap             : 0
</span><span class='line'>dss                : 0
</span><span class='line'>lazy_lock          : 0
</span><span class='line'>tls                : 1
</span><span class='line'>===============================================================================
</span><span class='line'>cd jemalloc && make CFLAGS="-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops " LDFLAGS="" lib/libjemalloc.a
</span><span class='line'>make[4]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/jemalloc'
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/jemalloc.o src/jemalloc.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/arena.o src/arena.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/atomic.o src/atomic.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/base.o src/base.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/bitmap.o src/bitmap.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/chunk.o src/chunk.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/chunk_dss.o src/chunk_dss.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/chunk_mmap.o src/chunk_mmap.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ckh.o src/ckh.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ctl.o src/ctl.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/extent.o src/extent.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/hash.o src/hash.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/huge.o src/huge.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/mb.o src/mb.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/mutex.o src/mutex.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/prof.o src/prof.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/quarantine.o src/quarantine.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/rtree.o src/rtree.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/stats.o src/stats.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/tcache.o src/tcache.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/util.o src/util.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/tsd.o src/tsd.c
</span><span class='line'>ar crus lib/libjemalloc.a src/jemalloc.o src/arena.o src/atomic.o src/base.o src/bitmap.o src/chunk.o src/chunk_dss.o src/chunk_mmap.o src/ckh.o src/ctl.o src/extent.o src/hash.o src/huge.o src/mb.o src/mutex.o src/prof.o src/quarantine.o src/rtree.o src/stats.o src/tcache.o src/util.o src/tsd.o
</span><span class='line'>make[4]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/jemalloc'
</span><span class='line'>make[3]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps'
</span><span class='line'>    CC adlist.o
</span><span class='line'>    CC ae.o
</span><span class='line'>    CC anet.o
</span><span class='line'>    CC dict.o
</span><span class='line'>anet.c: In function ‘anetSockName’:
</span><span class='line'>anet.c:565: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:563: note: initialized from here
</span><span class='line'>anet.c:569: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:567: note: initialized from here
</span><span class='line'>anet.c: In function ‘anetPeerToString’:
</span><span class='line'>anet.c:543: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:541: note: initialized from here
</span><span class='line'>anet.c:547: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:545: note: initialized from here
</span><span class='line'>anet.c: In function ‘anetTcpAccept’:
</span><span class='line'>anet.c:511: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:509: note: initialized from here
</span><span class='line'>anet.c:515: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:513: note: initialized from here
</span><span class='line'>    CC redis.o
</span><span class='line'>    CC sds.o
</span><span class='line'>    CC zmalloc.o
</span><span class='line'>    CC lzf_c.o
</span><span class='line'>    CC lzf_d.o
</span><span class='line'>    CC pqsort.o
</span><span class='line'>    CC zipmap.o
</span><span class='line'>    CC ziplist.o
</span><span class='line'>    CC sha1.o
</span><span class='line'>    CC release.o
</span><span class='line'>    CC networking.o
</span><span class='line'>    CC util.o
</span><span class='line'>    CC object.o
</span><span class='line'>    CC db.o
</span><span class='line'>    CC replication.o
</span><span class='line'>    CC rdb.o
</span><span class='line'>db.c: In function ‘scanGenericCommand’:
</span><span class='line'>db.c:454: warning: ‘pat’ may be used uninitialized in this function
</span><span class='line'>db.c:455: warning: ‘patlen’ may be used uninitialized in this function
</span><span class='line'>    CC t_string.o
</span><span class='line'>    CC t_list.o
</span><span class='line'>    CC t_set.o
</span><span class='line'>    CC t_zset.o
</span><span class='line'>    CC t_hash.o
</span><span class='line'>    CC config.o
</span><span class='line'>    CC aof.o
</span><span class='line'>    CC pubsub.o
</span><span class='line'>    CC multi.o
</span><span class='line'>    CC debug.o
</span><span class='line'>    CC sort.o
</span><span class='line'>    CC intset.o
</span><span class='line'>    CC syncio.o
</span><span class='line'>    CC migrate.o
</span><span class='line'>    CC endianconv.o
</span><span class='line'>    CC slowlog.o
</span><span class='line'>    CC scripting.o
</span><span class='line'>    CC bio.o
</span><span class='line'>    CC rio.o
</span><span class='line'>    CC rand.o
</span><span class='line'>    CC memtest.o
</span><span class='line'>    CC crc64.o
</span><span class='line'>    CC crc32.o
</span><span class='line'>    CC bitops.o
</span><span class='line'>    CC sentinel.o
</span><span class='line'>    CC notify.o
</span><span class='line'>    CC setproctitle.o
</span><span class='line'>    CC hyperloglog.o
</span><span class='line'>    CC latency.o
</span><span class='line'>    CC sparkline.o
</span><span class='line'>    CC slots.o
</span><span class='line'>    CC redis-cli.o
</span><span class='line'>    CC redis-benchmark.o
</span><span class='line'>    CC redis-check-dump.o
</span><span class='line'>    CC redis-check-aof.o
</span><span class='line'>    LINK redis-benchmark
</span><span class='line'>    LINK redis-check-dump
</span><span class='line'>    LINK redis-check-aof
</span><span class='line'>    LINK redis-server
</span><span class='line'>    INSTALL redis-sentinel
</span><span class='line'>    LINK redis-cli
</span><span class='line'>
</span><span class='line'>Hint: It's a good idea to run 'make test' ;)
</span><span class='line'>
</span><span class='line'>make[2]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/src'
</span><span class='line'>make[1]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21'
</span><span class='line'>[hadoop@cu2 codis]$ </span></code></pre></td></tr></table></div></figure>


<p>简单使用：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 codis]$ pwd
</span><span class='line'>/home/hadoop/codis/src/github.com/CodisLabs/codis
</span><span class='line'>[hadoop@cu2 codis]$ ll bin
</span><span class='line'>total 39856
</span><span class='line'>drwxrwxr-x 4 hadoop hadoop     4096 Jul 14 15:49 assets
</span><span class='line'>-rwxrwxr-x 1 hadoop hadoop 17329904 Jul 14 15:49 codis-config
</span><span class='line'>-rwxrwxr-x 1 hadoop hadoop 17151864 Jul 14 15:49 codis-proxy
</span><span class='line'>-rwxrwxr-x 1 hadoop hadoop  6313083 Jul 14 15:49 codis-server
</span><span class='line'>
</span><span class='line'>&lt;&lt;配置
</span><span class='line'>[hadoop@cu2 codis]$ vi config.ini 
</span><span class='line'>zk=cu3:2181
</span><span class='line'>dashboard_addr=cu2:18087
</span><span class='line'>session_max_timeout=0
</span><span class='line'>session_max_bufsize=1310720
</span><span class='line'>session_max_pipeline=10240000
</span><span class='line'>
</span><span class='line'>&lt;&lt;启动dashboard（大部分命令其实都可以通过网页来完成）
</span><span class='line'>[hadoop@cu2 codis]$ nohup bin/codis-config dashboard &gt;log/dashboard.log 2&gt;&1 &
</span><span class='line'>
</span><span class='line'>&lt;&lt;初始化1024 slot
</span><span class='line'>[hadoop@cu2 codis]$ bin/codis-config slot init
</span><span class='line'>{
</span><span class='line'>  "msg": "OK",
</span><span class='line'>  "ret": 0
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>&lt;&lt;启动redis server
</span><span class='line'>[hadoop@cu2 codis]$ bin/codis-server --port 16379 --daemonize yes
</span><span class='line'>
</span><span class='line'>&lt;&lt;在网页上分配好slot，或者：
</span><span class='line'>
</span><span class='line'>$ bin/codis-config slot range-set 0 511 1 online
</span><span class='line'>$ bin/codis-config slot range-set 512 1023 2 online
</span><span class='line'>
</span><span class='line'>&lt;&lt;然后启动proxy
</span><span class='line'>[hadoop@hadoop-master1 codis]$ nohup bin/codis-proxy -c config.ini -L proxy.log  --cpu=64 --addr=0.0.0.0:6372 --http-addr=0.0.0.0:11000 &gt;&gt;proxy.log 2&gt;&1 &
</span><span class='line'>
</span><span class='line'>&lt;&lt;客户端连接proxy
</span><span class='line'>[hadoop@cu2 codis]$ ~/redis/bin/redis-cli -p 19000
</span><span class='line'>&lt;&lt;不支持的命令
</span><span class='line'>127.0.0.1:19000&gt; keys *
</span><span class='line'>Error: Server closed the connection
</span><span class='line'>127.0.0.1:19000&gt; scan 0
</span><span class='line'>Error: Server closed the connection
</span><span class='line'>
</span><span class='line'>127.0.0.1:19000&gt; get a
</span><span class='line'>"b"
</span><span class='line'>
</span><span class='line'>127.0.0.1:19000&gt; select 2
</span><span class='line'>(error) ERR invalid DB index, only accept DB 0
</span><span class='line'>
</span><span class='line'>&lt;&lt;也可以单独连接到redis server，进行操作
</span><span class='line'>[hadoop@cu2 codis]$ ~/redis/bin/redis-cli -p 16378
</span><span class='line'># Keyspace
</span><span class='line'>db0:keys=6,expires=0,avg_ttl=0
</span><span class='line'>127.0.0.1:16378&gt; keys *
</span><span class='line'>1) "7"
</span><span class='line'>2) "1"
</span><span class='line'>3) "2"
</span><span class='line'>4) "4"
</span><span class='line'>5) "5"
</span><span class='line'>6) "a"</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/CodisLabs/codis/blob/master/doc/unsupported_cmds.md">codis不支持的命令</a>，基本上都是全局操作的命令。不影响使用，如果一定要使用，可以通过客户端单独连server执行。</p>

<p>有个疑问，怎么查看proxy写的数据放在那个slot？要学学go才行。</p>

<h2>安装参考</h2>

<ul>
<li><a href="https://lvs071103.gitbooks.io/codis/content/install.html">https://lvs071103.gitbooks.io/codis/content/install.html</a></li>
<li><a href="http://jicki.blog.51cto.com/1323993/1748549">http://jicki.blog.51cto.com/1323993/1748549</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/28/flume-kafka-elasticsearch-for-analyse/">使用 Flume+kafka+elasticsearch 处理数据</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-06-28T09:50:05+08:00" pubdate data-updated="true">Tue 2016-06-28 09:50</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>flume-1.6依赖的kafka、elasticsearch的版本与我这使用程序的版本不一致，部分jar依赖需要替换，flume-elasticsearch-sink源码需要进行一些修改来适配elasticsearch-2.2。</p>

<ul>
<li>flume-1.6.0</li>
<li>kafka_2.11-0.9.0.1(可以与0.8.2客户端通信, flume-kafka-channel-1.6.0不改)</li>
<li>elasticsearch-2.2.0</li>
</ul>


<p>由于版本的差异，需要替换/添加以下jar到 <code>flume/lib</code> 下：</p>

<p>使用 <code>mvn dependecy:copy-dependencies</code> 导出所需依赖的包</p>

<p>jackson一堆，hppc-0.7.1.jar，t-digest-3.0.jar，jsr166e-1.1.0.jar，guava-18.0.jar，lucene一堆，elasticsearch-2.2.0.jar。</p>

<p>远程调试配置：</p>

<p>source由于项目上的一些特殊规则，需要自己编写。通过远程DEBUG来打断点来排查BUG。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 flume]$ vi conf/flume-env.sh
</span><span class='line'>export JAVA_OPTS="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8092"</span></code></pre></td></tr></table></div></figure>


<h2>实战1</h2>

<p>KafkaChannel：考虑到其他功能也需要用到这些数据。</p>

<p>先写一个配置把flume自带功能跑通，这里用 netcat 作为输入运行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 flumebin]$ cat dta.flume 
</span><span class='line'>dta.sources=s1
</span><span class='line'>dta.channels=c1
</span><span class='line'>dta.sinks=k1
</span><span class='line'>
</span><span class='line'>dta.channels.c1.type=org.apache.flume.channel.kafka.KafkaChannel
</span><span class='line'>dta.channels.c1.capacity=10000
</span><span class='line'>dta.channels.c1.transactionCapacity=1000
</span><span class='line'>dta.channels.c1.brokerList=cu5:9093
</span><span class='line'>dta.channels.c1.topic=flume_cmdid_1234
</span><span class='line'>dta.channels.c1.groupId=flume_dta
</span><span class='line'>dta.channels.c1.zookeeperConnect=cu3:2181/kafka_0_9
</span><span class='line'>dta.channels.c1.parseAsFlumeEvent=false
</span><span class='line'>
</span><span class='line'>dta.sources.s1.channels=c1
</span><span class='line'>dta.sources.s1.type=netcat
</span><span class='line'>dta.sources.s1.bind=0.0.0.0
</span><span class='line'>dta.sources.s1.port=6666
</span><span class='line'>dta.sources.s1.max-line-length=88888888
</span><span class='line'>
</span><span class='line'>dta.sinks.k1.channel=c1
</span><span class='line'>dta.sinks.k1.type=elasticsearch
</span><span class='line'>dta.sinks.k1.hostNames=cu2:9300
</span><span class='line'>dta.sinks.k1.indexName=foo_index
</span><span class='line'>dta.sinks.k1.indexType=idcisp
</span><span class='line'>dta.sinks.k1.clusterName=eshore-cu
</span><span class='line'>dta.sinks.k1.batchSize=500
</span><span class='line'>dta.sinks.k1.ttl=5d
</span><span class='line'>dta.sinks.k1.serializer=com.eshore.zhfx.collector.InfoSecurityLogIndexRequestBuilderFactory
</span><span class='line'>dta.sinks.k1.serializer.idcispUrlBase64=true
</span><span class='line'>
</span><span class='line'>[hadoop@cu2 flumebin]$ bin/flume-ng agent --classpath flume-dta-source-2.1.jar  -n dta -c conf -f dta.flume
</span><span class='line'>
</span><span class='line'># 新开一个窗口
</span><span class='line'>[hadoop@cu2 ~]$ nc localhost 6666
</span></code></pre></td></tr></table></div></figure>


<p>kafka的主题、ES的索引可以不要手动建，当然为了更好的控制ES索引创建可以添加一个索引名的template。</p>

<p>InfoSecurityLogIndexRequestBuilderFactory 实现 ElasticSearchIndexRequestBuilderFactory 把原始记录转换成 ES 的JSON对象。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  private Counter allRecordMetric = MetricManager.getInstance().counter("all_infosecurity");
</span><span class='line'>  private Counter errorRecordMetric = MetricManager.getInstance().counter("error_infosecurity");
</span><span class='line'>  
</span><span class='line'>  public IndexRequestBuilder createIndexRequest(Client client, String indexPrefix, String indexType, Event event)
</span><span class='line'>      throws IOException {
</span><span class='line'>    allRecordMetric.inc();
</span><span class='line'>
</span><span class='line'>    String record = new String(event.getBody(), outputCharset);
</span><span class='line'>
</span><span class='line'>    context.put(ElasticSearchSinkConstants.INDEX_NAME, indexPrefix);
</span><span class='line'>    indexNameBuilder.configure(context);
</span><span class='line'>    IndexRequestBuilder indexRequestBuilder = client.prepareIndex(indexNameBuilder.getIndexName(event), indexType);
</span><span class='line'>
</span><span class='line'>    try {
</span><span class='line'>      Gson gson = new Gson();
</span><span class='line'>      IdcIspLog log = parseRecord(record);
</span><span class='line'>      BytesArray data = new BytesArray(gson.toJson(log));
</span><span class='line'>
</span><span class='line'>      indexRequestBuilder.setSource(data);
</span><span class='line'>      indexRequestBuilder.setRouting(log.commandld);
</span><span class='line'>    } catch (Exception e) {
</span><span class='line'>      LOG.error(e.getMessage(), e);
</span><span class='line'>      errorRecordMetric.inc();
</span><span class='line'>
</span><span class='line'>      indexRequestBuilder.setSource(record.getBytes(outputCharset));
</span><span class='line'>      // 保留错误的数据
</span><span class='line'>      indexRequestBuilder.setRouting("error");
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return indexRequestBuilder;
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<h2>实战2</h2>

<p>测试自定义的Source：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dta.sources=s1
</span><span class='line'>dta.channels=c1
</span><span class='line'>dta.sinks=k1
</span><span class='line'>
</span><span class='line'>dta.channels.c1.type=memory
</span><span class='line'>dta.channels.c1.capacity=1000000
</span><span class='line'>dta.channels.c1.transactionCapacity=1000000
</span><span class='line'>dta.channels.c1.byteCapacity=7000000000
</span><span class='line'>
</span><span class='line'>dta.sources.s1.channels=c1
</span><span class='line'>dta.sources.s1.type=com.eshore.zhfx.collector.CollectSource
</span><span class='line'>dta.sources.s1.spoolDir=/home/hadoop/flume/data/
</span><span class='line'>dta.sources.s1.trackerDir=/tmp/dtaspool
</span><span class='line'>
</span><span class='line'>dta.sinks.k1.channel=c1
</span><span class='line'>dta.sinks.k1.type=logger</span></code></pre></td></tr></table></div></figure>


<p>CollectSource 实现PollableSource 继承AbstractSource类。参考Flume开发文档: <a href="http://flume.apache.org/FlumeDeveloperGuide.html#source">http://flume.apache.org/FlumeDeveloperGuide.html#source</a>  <code>org.apache.flume.source.SequenceGeneratorSource</code> 类。</p>

<p>方法process主逻辑代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  public Status process() throws EventDeliveryException {
</span><span class='line'>    Status status = Status.READY;
</span><span class='line'>
</span><span class='line'>    try {
</span><span class='line'>      List&lt;Event&gt; events = readEvent(batchSize);
</span><span class='line'>      if (!events.isEmpty()) {
</span><span class='line'>        sourceCounter.addToEventReceivedCount(events.size());
</span><span class='line'>        sourceCounter.incrementAppendBatchReceivedCount();
</span><span class='line'>
</span><span class='line'>        getChannelProcessor().processEventBatch(events);
</span><span class='line'>        // 记录文件已经处理的位置
</span><span class='line'>        commit();
</span><span class='line'>
</span><span class='line'>        sourceCounter.addToEventAcceptedCount(events.size());
</span><span class='line'>        sourceCounter.incrementAppendBatchAcceptedCount();
</span><span class='line'>      }
</span><span class='line'>    } catch (ChannelException | IOException e) {
</span><span class='line'>      status = Status.BACKOFF;
</span><span class='line'>      Throwables.propagate(e);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return status;
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<h2>实例：Flume+Kafka+ES</h2>

<p>把两个实例整合起来，把实例1的Source替换下即可。</p>

<h2>附-kafka基本操作</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ bin/kafka-server-start.sh config/server1.properties 
</span><span class='line'>
</span><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ cat config/server1.properties 
</span><span class='line'>listeners=PLAINTEXT://:9093
</span><span class='line'>log.dirs=/tmp/kafka-logs1
</span><span class='line'>num.partitions=1
</span><span class='line'>zookeeper.connect=cu3,cu4,cu5/kafka_0_9
</span><span class='line'>
</span><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ bin/kafka-topics.sh --create --zookeeper cu3:2181/kafka_0_9 --replication 1 --partitions 1 --topic flume
</span><span class='line'>Created topic "flume".
</span><span class='line'>
</span><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ bin/kafka-topics.sh --list --zookeeper cu3:2181/kafka_0_9
</span><span class='line'>flume
</span><span class='line'>
</span><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ bin/kafka-console-producer.sh --broker-list cu5:9093 --topic flume
</span><span class='line'>
</span><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ bin/kafka-console-consumer.sh --zookeeper cu3:2181/kafka_0_9 --topic flume --from-beginning
</span><span class='line'>
</span><span class='line'>##添加kafka-manager：
</span><span class='line'>
</span><span class='line'>启动kafka添加JMX
</span><span class='line'>export JMX_PORT=19999
</span><span class='line'>nohup bin/kafka-server-start.sh config/server.properties &
</span><span class='line'>
</span><span class='line'># https://github.com/yahoo/kafka-manager/tree/1.3.1.8
</span><span class='line'>nohup bin/kafka-manager -Dhttp.port=9090 &
</span></code></pre></td></tr></table></div></figure>


<h2>附-Flume操作</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://flume.apache.org/FlumeUserGuide.html#fan-out-flow
</span><span class='line'>
</span><span class='line'>#conf/flume-env.sh
</span><span class='line'>export FLUME_JAVA_OPTS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=8092"
</span><span class='line'>bin/flume-ng agent --classpath "flume-dta-libs/*" -Dflume.root.logger=DEBUG,console  -n dta -c conf -f accesslog.flume
</span><span class='line'>
</span><span class='line'># with ganglia
</span><span class='line'>[ud@cu-ud1 apache-flume-1.6.0-bin]$ bin/flume-ng agent --classpath "/home/ud/collector/common-lib/*"  -Dflume.root.logger=Debug,console -Dflume.monitoring.type=ganglia -Dflume.monitoring.hosts=239.2.11.71:8649 -n dta -c conf -f accesslog.flume 
</span><span class='line'>
</span><span class='line'># windows
</span><span class='line'>bin\flume-ng.cmd agent -n agent -c conf -f helloworld.flume -property "flume.root.logger=INFO,console"</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/17/ganglia-install-on-centos-with-puppet/">使用Puppet安装配置Ganglia</a></h1>
    
    
      <p class="meta">
        








  



  
<time datetime="2016-06-17T09:30:50+08:00" pubdate data-updated="true">Fri 2016-06-17 09:30</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>前面写过完全纯手工和用yum安装依赖来安装ganglia的文章，最近生产安装了puppet，既然已经手上已有牛刀，杀鸡就不用再取菜刀了。今天记录下前几天使用puppet安装ganglia的经历。</p>

<h2>前提（自己操作过熟悉怎么用）</h2>

<ul>
<li>配置过私有仓库 (createrepo)</li>
<li>安装好puppet</li>
<li>编译过自己的rpm (rpmbuild)</li>
</ul>


<h2>编译gmetad，gmond，gweb</h2>

<p>点击链接下载SPEC：</p>

<ul>
<li><a href="/files/ganglia-puppet/gmetad.spec">gmetad.spec</a></li>
<li><a href="/files/ganglia-puppet/gmond.spec">gmond.spec</a></li>
<li><a href="/files/ganglia-puppet/gweb.spec">gweb.spec</a></li>
</ul>


<p>然后编译打包：</p>

<p>先手动编译安装 ganglia ，把依赖的问题处理好。编译安装没问题，然后再使用 rpmbuild 编译生成 rpm 包！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 1&gt; 建立目录结构
</span><span class='line'>mkdir ganglia-build
</span><span class='line'>cd ganglia-build
</span><span class='line'>mkdir BUILD RPMS SOURCES SPECS SRPMS
</span><span class='line'>
</span><span class='line'># 2&gt; 修改配置
</span><span class='line'># ganglia-web-3.7.1.tar.gz的makefile、conf_default.php.in修改下，根据等下要配置gmetad的参数进行修改
</span><span class='line'>
</span><span class='line'>less ganglia-web-3.7.1/Makefile 
</span><span class='line'>  # Location where gweb should be installed to (excluding conf, dwoo dirs).
</span><span class='line'>  GDESTDIR = /var/www/html/ganglia
</span><span class='line'>
</span><span class='line'>  # Location where default apache configuration should be installed to.
</span><span class='line'>  GCONFDIR = /usr/local/ganglia/etc/
</span><span class='line'>
</span><span class='line'>  # Gweb statedir (where conf dir and Dwoo templates dir are stored)
</span><span class='line'>  GWEB_STATEDIR = /var/www/html/ganglia
</span><span class='line'>
</span><span class='line'>  # Gmetad rootdir (parent location of rrd folder)
</span><span class='line'>  GMETAD_ROOTDIR = /data/ganglia
</span><span class='line'>
</span><span class='line'>  APACHE_USER = apache
</span><span class='line'>
</span><span class='line'># 连外网太慢，下载放到本地
</span><span class='line'>less ganglia-web-3.7.1/conf_default.php.in 
</span><span class='line'>  #$conf['cubism_js_path'] = "js/cubism.v1.min.js";
</span><span class='line'>  $conf['jquery_js_path'] = "js/jquery.min.js";
</span><span class='line'>  $conf['jquerymobile_js_path'] = "js/jquery.mobile.min.js";
</span><span class='line'>  $conf['jqueryui_js_path'] = "js/jquery-ui.min.js";
</span><span class='line'>  $conf['rickshaw_js_path'] = "js/rickshaw.min.js";
</span><span class='line'>  $conf['cubism_js_path'] = "js/cubism.v1.min.js";
</span><span class='line'>  $conf['d3_js_path'] = "js/d3.min.js";
</span><span class='line'>  $conf['protovis_js_path'] = "js/protovis.min.js";
</span><span class='line'>
</span><span class='line'># 3&gt; 源文件
</span><span class='line'># 把文件放到SOURCES目录下，
</span><span class='line'>ls SOURCES/
</span><span class='line'>  ganglia-3.7.2.tar.gz  ganglia-web-3.7.1.tar.gz
</span><span class='line'>
</span><span class='line'># 4&gt; 编译生成RPM
</span><span class='line'>rpmbuild -v -ba SPECS/gmetad.spec 
</span><span class='line'>rpmbuild -v -ba SPECS/gmond.spec 
</span><span class='line'>rpmbuild -v -ba SPECS/gweb.spec 
</span><span class='line'>
</span><span class='line'># 5&gt; 查看内容
</span><span class='line'>rpm -qpl RPMS/x86_64/ganglia-3.7.2-1.el6.x86_64.rpm </span></code></pre></td></tr></table></div></figure>


<h2>本地仓库</h2>

<p>这里假设已经把系统光盘做成了本地仓库。</p>

<p><strong>先安装httpd、php、createrepo</strong>，然后按照下面的步骤创建本地仓库：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 系统带的可以从光盘拷贝，直接映射到httpd的目录下即可
</span><span class='line'>[hadoop@hadoop-master1 rhel6.3]$ ls 
</span><span class='line'>Packages  repodata
</span><span class='line'>[hadoop@hadoop-master1 html]$ pwd
</span><span class='line'>/var/www/html
</span><span class='line'>[hadoop@hadoop-master1 html]$ ll
</span><span class='line'>lrwxrwxrwx.  1 root root   20 2月  15 2014 rhel6.3 -&gt; /opt/rhel6.3
</span><span class='line'>
</span><span class='line'>[hadoop@hadoop-master1 ~]$ sudo mkdir -p /opt/dta/repo
</span><span class='line'>[hadoop@hadoop-master1 ~]$ cd /opt/dta/repo
</span><span class='line'>[hadoop@hadoop-master1 repo]$ ls *.rpm
</span><span class='line'>gmetad-3.7.2-1.el6.x86_64.rpm  gmond-3.7.2-1.el6.x86_64.rpm  gweb-3.7.1-1.el6.x86_64.rpm  libconfuse-2.7-4.el6.x86_64.rpm
</span><span class='line'>
</span><span class='line'>[hadoop@hadoop-master1 repo]$ sudo createrepo .
</span><span class='line'>3/3 - libconfuse-2.7-4.el6.x86_64.rpm                                           
</span><span class='line'>Saving Primary metadata
</span><span class='line'>Saving file lists metadata
</span><span class='line'>Saving other metadata
</span><span class='line'>
</span><span class='line'># 映射到httpd目录下
</span><span class='line'>[hadoop@hadoop-master1 yum.repos.d]$ cd /var/www/html/
</span><span class='line'>[hadoop@hadoop-master1 html]$ sudo ln -s /opt/dta/repo dta
</span><span class='line'>
</span><span class='line'># 加入本地仓库源
</span><span class='line'>[hadoop@hadoop-master1 yum.repos.d]$ sudo cp puppet.repo dta.repo
</span><span class='line'>[hadoop@hadoop-master1 yum.repos.d]$ sudo vi dta.repo 
</span><span class='line'>[dta]
</span><span class='line'>name=DTA Local
</span><span class='line'>baseurl=http://hadoop-master1:801/dta
</span><span class='line'>enabled=1
</span><span class='line'>gpgcheck=0
</span></code></pre></td></tr></table></div></figure>


<p>注意： 在安装的时刻找不到gmond，可以先清理yum的缓冲： <code>yum clean all</code></p>

<h2>puppet模块</h2>

<p>添加了三个模块，用于主机添加repo配置和sudo配置，以及安装配置gmond。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master1 modules]# tree $PWD
</span><span class='line'>/etc/puppetlabs/code/environments/production/modules
</span><span class='line'>├── dtarepo
</span><span class='line'>│   ├── manifests
</span><span class='line'>│   │   └── init.pp
</span><span class='line'>│   └── templates
</span><span class='line'>│       └── dta.repo
</span><span class='line'>├── gmond
</span><span class='line'>│   ├── manifests
</span><span class='line'>│   │   └── init.pp
</span><span class='line'>│   └── templates
</span><span class='line'>│       └── gmond.conf
</span><span class='line'>└── sudo
</span><span class='line'>    ├── manifests
</span><span class='line'>    │   └── init.pp
</span><span class='line'>    └── templates
</span><span class='line'>        └── sudo.erb</span></code></pre></td></tr></table></div></figure>


<p>都比较简单，通过init.pp来进行配置，然后加载模板，写入到同步主机本地文件中。</p>

<ul>
<li>dtarepo</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./dtarepo/manifests/init.pp
</span><span class='line'>class dtarepo {
</span><span class='line'>
</span><span class='line'>file{'/etc/yum.repos.d/dta.repo':
</span><span class='line'>  ensure =&gt; file,
</span><span class='line'>  content =&gt; template('dtarepo/dta.repo'),
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>./dtarepo/templates/dta.repo
</span><span class='line'>[dta]
</span><span class='line'>name=DTA Local
</span><span class='line'>baseurl=http://hadoop-master1:801/dta
</span><span class='line'>enabled=1
</span><span class='line'>gpgcheck=0</span></code></pre></td></tr></table></div></figure>


<ul>
<li>sudo：用于sudo切root，方便调试</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./sudo/manifests/init.pp
</span><span class='line'>class sudo {
</span><span class='line'>
</span><span class='line'>if ( $::hostname =~ /(^cu-omc)/ ) {
</span><span class='line'>  $user = 'omc'
</span><span class='line'>} elsif ( $::hostname =~ /(^cu-uc)/ ) {
</span><span class='line'>  $user = 'uc'
</span><span class='line'>} elsif ( $::hostname =~ /(^cu-ud)/ ) {
</span><span class='line'>  $user = 'ud'
</span><span class='line'>} elsif ( $::hostname =~ /(^cu-db)/ ) {
</span><span class='line'>  $user = 'mysql'
</span><span class='line'>} else {
</span><span class='line'>  $user = 'hadoop'
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>file { "/etc/sudoers.d/10_$user":
</span><span class='line'>  ensure =&gt; file,
</span><span class='line'>  mode =&gt; '0440', 
</span><span class='line'>  content =&gt; template('sudo/sudo.erb'),
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>./sudo/templates/sudo.erb
</span><span class='line'>&lt;%= scope.lookupvar('sudo::user') %&gt; ALL=(ALL) NOPASSWD: ALL</span></code></pre></td></tr></table></div></figure>


<ul>
<li>gmond</li>
</ul>


<p>在默认的gmond.conf基础上修改一下两个配置: globals.deaf, cluster.name</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./gmond/manifests/init.pp
</span><span class='line'>class gmond {
</span><span class='line'>
</span><span class='line'>$deaf = $::hostname ? {
</span><span class='line'>  'hadoop-master1' =&gt; 'no',
</span><span class='line'>  'cu-omc1' =&gt; 'no',
</span><span class='line'>  default =&gt; 'yes',
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>if ( $::hostname =~ /(^cu-)/ ) {
</span><span class='line'>  $cluster_name = 'CU'
</span><span class='line'>} else {
</span><span class='line'>  $cluster_name = 'HADOOP'
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>package { 'gmond':
</span><span class='line'>  ensure =&gt; present,
</span><span class='line'>  before =&gt; File['/usr/local/ganglia/etc/gmond.conf'],
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>file { '/usr/local/ganglia/etc/gmond.conf':
</span><span class='line'>  ensure =&gt; file,
</span><span class='line'>  content =&gt; template('gmond/gmond.conf'),
</span><span class='line'>  notify =&gt; Service['gmond'],
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>service { 'gmond':
</span><span class='line'>  ensure    =&gt; running,
</span><span class='line'>  enable    =&gt; true,
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>./gmond/templates/gmond.conf
</span><span class='line'>/* This configuration is as close to 2.5.x default behavior as possible
</span><span class='line'>   The values closely match ./gmond/metric.h definitions in 2.5.x */
</span><span class='line'>globals {
</span><span class='line'>...
</span><span class='line'>  mute = no
</span><span class='line'>  deaf = &lt;%= scope.lookupvar('gmond::deaf') %&gt;
</span><span class='line'>  allow_extra_data = yes
</span><span class='line'>...
</span><span class='line'>cluster {
</span><span class='line'>  name = "&lt;%= scope.lookupvar('gmond::cluster_name') %&gt;"</span></code></pre></td></tr></table></div></figure>


<p>参考下逻辑即可（也可以通过hiera配置）。</p>

<p>最后在 site.pp 引用加载编写的Module：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master1 modules]# cd ../manifests/
</span><span class='line'>[root@hadoop-master1 manifests]# cat site.pp 
</span><span class='line'>file{'/etc/puppetlabs/mcollective/facts.yaml':
</span><span class='line'>  owner    =&gt; root,
</span><span class='line'>  group    =&gt; root,
</span><span class='line'>  mode     =&gt; '400',
</span><span class='line'>  loglevel =&gt; debug, # reduce noise in Puppet reports
</span><span class='line'>  content  =&gt; inline_template("&lt;%= scope.to_hash.reject { |k,v| k.to_s =~ /(uptime_seconds|timestamp|free)/ }.to_yaml %&gt;"), # exclude rapidly changing facts
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>include dtarepo
</span><span class='line'>include gmond
</span><span class='line'>
</span><span class='line'># include sudo
</span></code></pre></td></tr></table></div></figure>


<h2>一键安装</h2>

<p>安装gmetad：</p>

<p>首先在主机上安装gmetad，由于只需要在一台机器安装，配置没有整成模板，这里直接手动弄。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master1 dtarepo]# mco rpc package install package=gmetad -I cu-omc1 （或者直接yum install -y gmetad）
</span><span class='line'>
</span><span class='line'># 注意：主机多网卡时可能需要添加route
</span><span class='line'>[root@cu-omc1 ~]# route add -host 239.2.11.71 dev bond0
</span><span class='line'>
</span><span class='line'>[root@cu-omc1 ~]# /etc/ganglia/gmetad.conf 注意!! 这里的rrd_rootdir配置与上面gweb/makefile是对应的！！
</span><span class='line'>data_source "HADOOP" hadoop-master1
</span><span class='line'>data_source "CU" cu-omc1
</span><span class='line'>gridname "CQCU"
</span><span class='line'>rrd_rootdir "/data/ganglia/rrds"
</span></code></pre></td></tr></table></div></figure>


<p>注意： data_source 需要配合 gmond/manifests/init.pp 中的 deaf 属性值。</p>

<p><strong>php的时区调整</strong>：vi /etc/php.ini date.timezone = &ldquo;Asia/Shanghai&rdquo;</p>

<p>安装gmond：</p>

<p>在cu-omc2上安装gmond（正则表达式，想怎么匹配就怎么写）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master1 production]# mco shell -I /^cu-omc2/ run -- "/opt/puppetlabs/bin/puppet agent -t"</span></code></pre></td></tr></table></div></figure>


<p>puppet同步好后，就安装好puppet，以及启动gmond服务。</p>

<p>同时看看web是否已经有图像。<strong>不要看一分钟负载，搞一个明显一点的，如磁盘容量内存容量可以明确判断数据有没有采集到的。</strong> 没有话可以试着重启gmond:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master1 production]# mco shell -I /cu-/ run -- service gmond restart</span></code></pre></td></tr></table></div></figure>


<p>不要一次重启太多机器，时间比较长的话可以结合screen命令使用：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master1 ~]# screen
</span><span class='line'>[root@hadoop-master1 ~]# mco shell -I hadoop-slaver2 -I hadoop-slaver3 -I hadoop-slaver4  -I hadoop-slaver5 -I hadoop-slaver6 -I hadoop-slaver7 -I hadoop-slaver8 -I hadoop-slaver9  run -- service gmond restart ; 
</span><span class='line'>[root@hadoop-master1 ~]# for ((i=1;i&lt;17;i++)) ; do mco shell -I /hadoop-slaver${i}.$/ run -- service gmond restart ; sleep 60 ; done  
</span><span class='line'>
</span><span class='line'>[root@hadoop-master1 ~]# screen -ls 
</span><span class='line'>[root@hadoop-master1 ~]# screen -r 22929</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/15/elasticsearch-startguide/">Elasticsearch Startguide</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-06-15T08:40:28+08:00" pubdate data-updated="true">Wed 2016-06-15 08:40</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>如果有Lucene的使用经历，elasticsearch的入门还是比较简单的。直接解压启动命令就安装好了，然后就是添加一些plugins就OK了。</p>

<h2>安装</h2>

<p>从官网下载 <a href="https://www.elastic.co/downloads/elasticsearch">TAR包</a> ，解压后，运行 elasticsearch 脚本启动服务。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># -d 表示 daemonize 后台运行
</span><span class='line'>[hadoop@cu2 elasticsearch-2.2.0]$ bin/elasticsearch -d</span></code></pre></td></tr></table></div></figure>


<h2>插件</h2>

<p>大部分插件都是ajax方式的静态页面，可以通过plugin脚本安装，或者直接解压文件到plugins目录下面。</p>

<p>安装已经下载到本地的插件需要加file协议，不然程序会从官网下载。或者直接解压到plugins目录下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 elasticsearch-2.2.0]$ bin/plugin install file:///home/hadoop/elasticsearch-head-master.zip 
</span><span class='line'>-&gt; Installing from file:/home/hadoop/elasticsearch-head-master.zip...
</span><span class='line'>Trying file:/home/hadoop/elasticsearch-head-master.zip ...
</span><span class='line'>Downloading .........DONE
</span><span class='line'>Verifying file:/home/hadoop/elasticsearch-head-master.zip checksums if available ...
</span><span class='line'>NOTE: Unable to verify checksum for downloaded plugin (unable to find .sha1 or .md5 file to verify)
</span><span class='line'>Installed head into /home/hadoop/elasticsearch-2.2.0/plugins/head
</span></code></pre></td></tr></table></div></figure>


<p>windows</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>E:\local\usr\share\elasticsearch-2.3.3\bin&gt;plugin.bat install file:///D:/SOFTWARE/elasticsearch/elasticsearch-plugin/elasticsearch-head-master.zip</span></code></pre></td></tr></table></div></figure>


<p>安装好plugin后，打开浏览器查看索引情况： <a href="http://localhost:9200/_plugin/head/">http://localhost:9200/_plugin/head/</a></p>

<h2>插件高阶</h2>

<p>有些插件版本比较旧需要改一改，需要了解新版本的 elasticsearch-plugin 的规范：</p>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/plugins/2.3/installation.html">https://www.elastic.co/guide/en/elasticsearch/plugins/2.3/installation.html</a></p>

<p>新版本插件主要是需要增加一个描述文件：</p>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.3/breaking_20_plugin_and_packaging_changes.html#_plugins_require_descriptor_file">Plugins require descriptor file</a></p>

<p>遇到想安装的旧版本的plugin，描述文件写法可以参考 <a href="https://github.com/mobz/elasticsearch-head">elasticsearch-head</a> 。</p>

<p>可选插件：</p>

<ul>
<li>paramedic <a href="https://github.com/karmi/elasticsearch-paramedic">https://github.com/karmi/elasticsearch-paramedic</a></li>
<li>head <a href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a></li>
<li>kopf <a href="https://github.com/lmenezes/elasticsearch-kopf">https://github.com/lmenezes/elasticsearch-kopf</a></li>
</ul>


<h2>常用URL请求</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html
</span><span class='line'># 创建
</span><span class='line'>$ curl -XPUT 'http://localhost:9200/t_ods_idc_isp_log2/' -d '{
</span><span class='line'>    "settings" : {
</span><span class='line'>        "index" : {
</span><span class='line'>            "number_of_shards" : 3,
</span><span class='line'>            "number_of_replicas" : 0
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}'
</span><span class='line'>{"acknowledged":true}
</span><span class='line'>
</span><span class='line'># https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-put-mapping.html
</span><span class='line'># 更新
</span><span class='line'># mapping.json
</span><span class='line'>{
</span><span class='line'>  "properties": {
</span><span class='line'>      "author": {
</span><span class='line'>          "type": "string"
</span><span class='line'>      },
</span><span class='line'>...
</span><span class='line'>      "year": {
</span><span class='line'>          "type": "long",
</span><span class='line'>          "ignore_malformed": false,
</span><span class='line'>          "index": "analyzed"
</span><span class='line'>      },
</span><span class='line'>      "avaiable": {
</span><span class='line'>          "type": "boolean"
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>$ curl -XPUT 'localhost:9200/t_ods_idc_isp_log2/_mapping/default' -d @mapping.json
</span><span class='line'>
</span><span class='line'>$ curl -XPUT 'localhost:9200/t_ods_idc_isp_log2/_mapping/default' -d '
</span><span class='line'>{
</span><span class='line'>  "properties": {
</span><span class='line'>    "fDIID": {
</span><span class='line'>      "type": "string"
</span><span class='line'>    },
</span><span class='line'>...
</span><span class='line'>    "gatherTime": {
</span><span class='line'>      "type": "long"
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>'
</span><span class='line'>
</span><span class='line'># https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html
</span><span class='line'># 索引
</span><span class='line'># documents.json
</span><span class='line'>{ "index": {      "_index": "library",        "_type": "book",        "_id": "1"  } }
</span><span class='line'>{     "title": "All Quiet on the Western Front",  "otitle": "Im Westen nichts Neues",     "author": "Erich Maria Remarque",   "year": 1929,   "characters": ["Paul Baumer",   "Albert Kropp",     "Haie Westhus",     "Fredrich Muller",  "Stanislaus Katczinsky",    "Tjaden"],  "tags": ["novel"],  "copies": 1,    "available": true,  "section": 3 }
</span><span class='line'>{     "index": {      "_index": "library",        "_type": "book",        "_id": "2"  } }
</span><span class='line'>{     "title": "Catch-22",    "author": "Joseph Heller",  "year": 1961,   "characters": ["John Yossarian",    "Captain Aardvark",     "Chaplain Tappman",     "Colonel Cathcart",     "Doctor Daneeka"],  "tags": ["novel"],  "copies": 6,    "available": false,     "section": 1 }
</span><span class='line'>
</span><span class='line'>$ curl -s -XPOST localhost:9200/_bulk --data-binary @documents.json
</span><span class='line'>
</span><span class='line'># 删除
</span><span class='line'>$ curl -XDELETE 'http://localhost:9200/t_ods_idc_isp_log2/'
</span><span class='line'>{"acknowledged":true}
</span><span class='line'>
</span><span class='line'># https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-get-mapping.html
</span><span class='line'># https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-get-field-mapping.html
</span><span class='line'># 状态查看
</span><span class='line'>http://localhost:9200/_cat/health?v
</span><span class='line'>http://localhost:9200/_cat/nodes?v
</span><span class='line'>http://localhost:9200/_cat/indices?v
</span><span class='line'>
</span><span class='line'>curl -XGET 'http://localhost:9200/_all/_mapping/book/field/author'
</span><span class='line'>curl -XHEAD -i 'http://localhost:9200/twitter/tweet'
</span><span class='line'>curl localhost:9200/_stats
</span><span class='line'>curl -XGET 'http://localhost:9200/_all/_mapping/[type]'
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/08/rrc-apache-spark-source-inside-shell/">[读读书]Apache Spark源码剖析-Shell</a></h1>
    
    
      <p class="meta">
        








  



  
<time datetime="2016-05-08T21:41:01+08:00" pubdate data-updated="true">Sun 2016-05-08 21:41</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>本来第二篇应该是与 [第1章 初识Spark] 有关，但我们运行helloworld、以及提交任务都是通过脚本 <code>bin/spark-shell</code> ，完全不知道那些脚本是干啥的？而且，在开发环境运行shell来启动应用总觉得怪怪的，这篇先来简单了解脚本的功能、以及Launcher模块。</p>

<p><strong> 其实每个大数据的框架，shell脚本都是通用入口，也是研读源码的第一个突破口 </strong>。掌握脚本功能相当于熟悉了基本的API功能，把 spark/bin 目录下面的脚本理清楚，然后再去写搭建开发环境、编写调试helloworld就事半功倍了。</p>

<p>官网 <strong> Quick Start </strong> 提供的简短例子都是通过 bin/spark-shell 来运行的。Submit页面提供了 bin/spark-submit 提交jar发布任务的方式。 spark-shell，spark-submit 就是两个非常重要的脚本，这里就来看下这两个脚本。</p>

<h2>spark-shell - 对应[3.1 spark-shell]章节</h2>

<p>spark-shell 脚本的内容相对多一些，主要代码如下（其他代码都是为了兼容cygwin弄的，我们这里不关注）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SPARK_SUBMIT_OPTS="$SPARK_SUBMIT_OPTS -Dscala.usejavacp=true"
</span><span class='line'>trap onExit INT     # 程序终止(interrupt)信号, 在用户键入INTR字符(通常是Ctrl + C)时触发
</span><span class='line'>
</span><span class='line'>export SPARK_SUBMIT_OPTS
</span><span class='line'>"${SPARK_HOME}"/bin/spark-submit --class org.apache.spark.repl.Main --name "Spark shell" "$@"</span></code></pre></td></tr></table></div></figure>


<p>最终调用 bin/spark-submit 脚本。其实和我们自己提交 helloworld.jar 命令一样：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bin/spark-submit \
</span><span class='line'>  --class "HelloWorld" \
</span><span class='line'>  --master local[2] \
</span><span class='line'>  target/scala-2.10/helloworld_2.10-1.0.jar</span></code></pre></td></tr></table></div></figure>


<p>不过通过 bin/spark-shell 提交运行的类是spark自带，没有附加（不需要）额外的jar。这个后面再讲，我们也可以通过这种方式类运行公共位置的jar，可以减少一些不必要的网络带宽。</p>

<h2>spark-submit</h2>

<p>submit脚本更简单。就是把 <strong>org.apache.spark.deploy.SparkSubmit</strong> 和 <strong>输入参数</strong> 全部传递给脚本 bin/spark-class 。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>exec "${SPARK_HOME}"/bin/spark-class org.apache.spark.deploy.SparkSubmit "$@"</span></code></pre></td></tr></table></div></figure>


<h2>spark-class</h2>

<p>主要的功能都集中在 bin/spark-class。bin/spark-class脚本最终启动java、调用 <strong>Launcher模块</strong> 。而 <strong>Launcher模块</strong> 解析输入参数并输出 <strong>最终输出Driver启动的命令</strong>，然后shell再通过 <strong>exec</strong> 来运行Driver程序。</p>

<p>要讲清楚 bin/spark-class 相对复杂点：通过脚本传递参数，调用java处理参数，又输出脚本，最后运行脚本才真正运行了Driver。所以这里通过 <strong>脚本</strong> 和 <strong>程序</strong> 来进行说明。</p>

<h4>脚本</h4>

<ul>
<li>先加载环境变量配置文件</li>
<li>再获取 assembly.jar 位置</li>
<li>然后调用 <code>org.apache.spark.launcher.Main</code> ， Main类根据环境变量和传入参数算出真正执行的命令(具体在【程序】部分讲)。</li>
</ul>


<p>下面是核心脚本的内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>. "${SPARK_HOME}"/bin/load-spark-env.sh 
</span><span class='line'>  # 把load-spark-env.sh展开
</span><span class='line'>  . "${user_conf_dir}/spark-env.sh"
</span><span class='line'>  
</span><span class='line'>  ASSEMBLY_DIR1="${SPARK_HOME}/assembly/target/scala-2.10"  # 通过ASSEMBLY路径来判断SPARK_SCALA_VERSION，编译打包成tar的不需要这个变量
</span><span class='line'>  export SPARK_SCALA_VERSION="2.10"
</span><span class='line'>
</span><span class='line'>RUNNER="${JAVA_HOME}/bin/java"
</span><span class='line'>
</span><span class='line'>SPARK_ASSEMBLY_JAR=
</span><span class='line'>if [ -f "${SPARK_HOME}/RELEASE" ]; then
</span><span class='line'>  ASSEMBLY_DIR="${SPARK_HOME}/lib"
</span><span class='line'>else
</span><span class='line'>  ASSEMBLY_DIR="${SPARK_HOME}/assembly/target/scala-$SPARK_SCALA_VERSION"
</span><span class='line'>fi
</span><span class='line'>ASSEMBLY_JARS="$(ls -1 "$ASSEMBLY_DIR" | grep "^spark-assembly.*hadoop.*\.jar$" || true)"
</span><span class='line'>SPARK_ASSEMBLY_JAR="${ASSEMBLY_DIR}/${ASSEMBLY_JARS}"
</span><span class='line'>LAUNCH_CLASSPATH="$SPARK_ASSEMBLY_JAR"
</span><span class='line'>
</span><span class='line'>export _SPARK_ASSEMBLY="$SPARK_ASSEMBLY_JAR"
</span><span class='line'>
</span><span class='line'>CMD=()
</span><span class='line'>while IFS= read -d '' -r ARG; do
</span><span class='line'>  CMD+=("$ARG")
</span><span class='line'>done &lt; &lt;("$RUNNER" -cp "$LAUNCH_CLASSPATH" org.apache.spark.launcher.Main "$@")
</span><span class='line'>exec "${CMD[@]}"</span></code></pre></td></tr></table></div></figure>


<p>大部分内容都是准备环境变量，就最后几行代码比较复杂。这里设置DEBUG在脚本 <code>while</code> 循环打印每个输出的值看下输出的是什么。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 修改后的效果
</span><span class='line'>CMD=()
</span><span class='line'>while IFS= read -d '' -r ARG; do
</span><span class='line'>  echo "[DEBUG] $ARG"
</span><span class='line'>  CMD+=("$ARG")
</span><span class='line'>done &lt; &lt;(set -x; "$RUNNER" -cp "$LAUNCH_CLASSPATH" org.apache.spark.launcher.Main "$@")
</span><span class='line'>echo "${CMD[@]}"
</span><span class='line'>exec "${CMD[@]}"</span></code></pre></td></tr></table></div></figure>


<p>启动 bin/spark-shell（最终会调用 bin/spark-class，上面已经讲过脚本之间的关系），查看输出的调试信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 spark-1.6.0-bin-2.6.3]$ bin/spark-shell 
</span><span class='line'>++ /opt/jdk1.8.0/bin/java -cp /home/hadoop/spark-1.6.0-bin-2.6.3/lib/spark-assembly-1.6.0-hadoop2.6.3-ext-2.1.jar org.apache.spark.launcher.Main org.apache.spark.deploy.SparkSubmit --class org.apache.spark.repl.Main --name 'Spark shell'
</span><span class='line'>[DEBUG] /opt/jdk1.8.0/bin/java
</span><span class='line'>[DEBUG] -cp
</span><span class='line'>[DEBUG] /home/hadoop/spark/lib/mysql-connector-java-5.1.34.jar:/home/hadoop/spark-1.6.0-bin-2.6.3/conf/:/home/hadoop/spark-1.6.0-bin-2.6.3/lib/spark-assembly-1.6.0-hadoop2.6.3-ext-2.1.jar:/home/hadoop/spark-1.6.0-bin-2.6.3/lib/datanucleus-rdbms-3.2.9.jar:/home/hadoop/spark-1.6.0-bin-2.6.3/lib/datanucleus-core-3.2.10.jar:/home/hadoop/spark-1.6.0-bin-2.6.3/lib/datanucleus-api-jdo-3.2.6.jar:/home/hadoop/hadoop/etc/hadoop/
</span><span class='line'>[DEBUG] -Dscala.usejavacp=true
</span><span class='line'>[DEBUG] -Xms512m
</span><span class='line'>[DEBUG] -Xmx512m
</span><span class='line'>[DEBUG] org.apache.spark.deploy.SparkSubmit
</span><span class='line'>[DEBUG] --class
</span><span class='line'>[DEBUG] org.apache.spark.repl.Main
</span><span class='line'>[DEBUG] --name
</span><span class='line'>[DEBUG] Spark shell
</span><span class='line'>[DEBUG] spark-shell
</span><span class='line'>/opt/jdk1.8.0/bin/java -cp /home/hadoop/spark/lib/mysql-connector-java-5.1.34.jar:/home/hadoop/spark-1.6.0-bin-2.6.3/conf/:/home/hadoop/spark-1.6.0-bin-2.6.3/lib/spark-assembly-1.6.0-hadoop2.6.3-ext-2.1.jar:/home/hadoop/spark-1.6.0-bin-2.6.3/lib/datanucleus-rdbms-3.2.9.jar:/home/hadoop/spark-1.6.0-bin-2.6.3/lib/datanucleus-core-3.2.10.jar:/home/hadoop/spark-1.6.0-bin-2.6.3/lib/datanucleus-api-jdo-3.2.6.jar:/home/hadoop/hadoop/etc/hadoop/ -Dscala.usejavacp=true -Xms512m -Xmx512m org.apache.spark.deploy.SparkSubmit --class org.apache.spark.repl.Main --name 'Spark shell' spark-shell
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>从上面的调试信息可以看出：</p>

<ul>
<li><code>org.apache.spark.launcher.Main</code> 把传入参数整理后重新输出</li>
<li>脚本把java输出内容保存到 <code>CMD[@]</code> 数组中</li>
<li>最后使用exec来执行。</li>
</ul>


<p>根据上面 bin/spark-class 产生的启动命令可以直接在idea里面运行，效果与直接运行 bin/spark-shell 一样：</p>

<p><img src="/images/blogs/rrc-spark/idea-spark-shell.png" alt="" /></p>

<p><strong>注意：</strong> 这里的 spark-shell 是一个特殊的字符串，代码中会对其进行特殊处理不额外加载jar。类似的字符串还有： pyspark-shell, sparkr-shell, spark-internal（参看SparkSubmit），如果调用类就在SPARK_CLASSPATH可以使用它们减少不必要的网络传输。</p>

<h4>Launcher模块</h4>

<p>发现 shell 和 launcher的java代码 功能逻辑非常类似。比如说获取java程序路径的代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>List&lt;String&gt; buildJavaCommand(String extraClassPath) throws IOException {
</span><span class='line'>  ...
</span><span class='line'>  if (javaHome != null) {
</span><span class='line'>      cmd.add(join(File.separator, javaHome, "bin", "java"));
</span><span class='line'>  } else if ((envJavaHome = System.getenv("JAVA_HOME")) != null) {
</span><span class='line'>      cmd.add(join(File.separator, envJavaHome, "bin", "java"));
</span><span class='line'>  } else {
</span><span class='line'>      cmd.add(join(File.separator, System.getProperty("java.home"), "bin", "java"));
</span><span class='line'>  }
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>在shell脚本里面的处理是：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Find the java binary
</span><span class='line'>if [ -n "${JAVA_HOME}" ]; then
</span><span class='line'>  RUNNER="${JAVA_HOME}/bin/java"
</span><span class='line'>else
</span><span class='line'>  if [ `command -v java` ]; then
</span><span class='line'>  RUNNER="java"
</span><span class='line'>  else
</span><span class='line'>  echo "JAVA_HOME is not set" &gt;&2
</span><span class='line'>  exit 1
</span><span class='line'>  fi
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>


<p>对比两者，其实是用脚本更加直观。但是使用java编写一个模块更便于管理和扩展，稍微调整下就能复用代码。比如说要添加windows的cmd脚本、又或者为了兼容多个操作系统/多语言(python，r 等)。所以提取一个公共的 <strong>Launcher模块</strong> 出来其实是个挺不错的选择。同时对于不是很熟悉shell的程序员来说也更方便了解系统运作。</p>

<p><strong>Launcher模块</strong> 按功能可以分为 CommandBuilder 和 SparkLauncher 两个部分。</p>

<ol>
<li><p>CommandBuilder</p></li>
<li><p>SparkSubmitCommandBuilder: 解析用户输入的参数并输出命令给脚本使用</p></li>
<li>SparkClassCommandBuilder: 主要为后台进程产生启动命令（sbin目录下面的脚本）。</li>
</ol>


<p>1.1 公共类</p>

<ul>
<li>Main ： 统一入口</li>
<li>AbstractCommandBuilder : 提供构造命令的公共基类

<ul>
<li>buildJavaCommand

<ul>
<li>buildClassPath

<ul>
<li>SPARK_CLASSPATH</li>
<li>extraClassPath</li>
<li>getConfDir : 等于环境变量 $SPARK_CONF_DIR 或者 $SPARK_HOME/conf 的值</li>
<li>classes

<ul>
<li>SPARK_PREPEND_CLASSES</li>
<li>SPARK_TESTING</li>
</ul>
</li>
<li>findAssembly : 获取 spark-assembly-1.6.0-hadoop2.6.3.jar 的路径，lib 或者 assembly/target/scala-$SPARK_SCALA_VERSION 路径下

<ul>
<li>_SPARK_ASSEMBLY</li>
</ul>
</li>
<li>datanucleus-* : 从 lib / lib_managed/jars 目录下获取</li>
<li>HADOOP_CONF_DIR</li>
<li>YARN_CONF_DIR</li>
<li>SPARK_DIST_CLASSPATH</li>
</ul>
</li>
</ul>
</li>
<li>getEffectiveConfig : 获取 spark-defaults.conf 的内容</li>
</ul>
</li>
</ul>


<p>1.2 SparkSubmitCommandBuilder</p>

<p>主要的类以及参数：</p>

<ul>
<li>SparkSubmitCommandBuilder

<ul>
<li>构造函数调用OptionParser解析参数，解析handle有处理specialClasses！</li>
<li>buildSparkSubmitCommand

<ul>
<li>getEffectiveConfig</li>
<li>extraClassPath : spark.driver.extraClassPath</li>
<li>SPARK_SUBMIT_OPTS</li>
<li>SPARK_JAVA_OPTS</li>
<li>client模式下加载配置

<ul>
<li>spark.driver.memory / SPARK_DRIVER_MEMORY / SPARK_MEM / DEFAULT_MEM(1g)</li>
<li>DRIVER_EXTRA_JAVA_OPTIONS</li>
<li>DRIVER_EXTRA_LIBRARY_PATH</li>
</ul>
</li>
<li>buildSparkSubmitArgs</li>
</ul>
</li>
</ul>
</li>
<li>SparkSubmitOptionParser(子类需要实现handle方法)</li>
<li>SparkSubmitCommandBuilder$OptionParser 命令参数

<ul>
<li><code>bin/spark-submit -h</code> 查看可以<strong>设置的参数</strong></li>
<li>直接查看<a href="http://spark.apache.org/docs/latest/submitting-applications.html">官网文档</a></li>
</ul>
</li>
</ul>


<p>1.3 SparkClassCommandBuilder</p>

<p>主要CommandBuilder的功能上面已经都覆盖了，SparkClassCommandBuilder主要关注命令行可以设置哪些环境变量：</p>

<ul>
<li>org.apache.spark.deploy.master.Master

<ul>
<li>SPARK_DAEMON_JAVA_OPTS</li>
<li>SPARK_MASTER_OPTS</li>
<li>SPARK_DAEMON_MEMORY</li>
</ul>
</li>
<li>org.apache.spark.deploy.worker.Worker

<ul>
<li>SPARK_DAEMON_JAVA_OPTS</li>
<li>SPARK_WORKER_OPTS</li>
<li>SPARK_DAEMON_MEMORY</li>
</ul>
</li>
<li>org.apache.spark.deploy.history.HistoryServer

<ul>
<li>SPARK_DAEMON_JAVA_OPTS</li>
<li>SPARK_HISTORY_OPTS</li>
<li>SPARK_DAEMON_MEMORY</li>
</ul>
</li>
<li>org.apache.spark.executor.CoarseGrainedExecutorBackend

<ul>
<li>SPARK_JAVA_OPTS</li>
<li>SPARK_EXECUTOR_OPTS</li>
<li>SPARK_EXECUTOR_MEMORY</li>
</ul>
</li>
<li>org.apache.spark.executor.MesosExecutorBackend

<ul>
<li>SPARK_EXECUTOR_OPTS</li>
<li>SPARK_EXECUTOR_MEMORY</li>
</ul>
</li>
<li>org.apache.spark.deploy.ExternalShuffleService / org.apache.spark.deploy.mesos.MesosExternalShuffleService

<ul>
<li>SPARK_DAEMON_JAVA_OPTS</li>
<li>SPARK_SHUFFLE_OPTS</li>
<li>SPARK_DAEMON_MEMORY</li>
</ul>
</li>
<li>org.apache.spark.tools.

<ul>
<li>extraClassPath : spark-tools_.*.jar</li>
<li>SPARK_JAVA_OPTS</li>
<li>DEFAULT_MEM(1g)</li>
</ul>
</li>
<li>other

<ul>
<li>SPARK_JAVA_OPTS</li>
<li>SPARK_DRIVER_MEMORY</li>
</ul>
</li>
</ul>


<h4>SparkLauncher</h4>

<p>SparkLauncher提供了在程序中提交任务的方式。通过Driver端的支持获取程序执行动态（通过socket与Driver交互），为实现后端管理应用提供一种可行的方式。</p>

<p>SparkLauncher提交任务其中一部分还是使用spark-submit脚本，绕一圈又回到上面的参数解析生成命令然后exec执行。另外SparkLauncher通过启动 SocketServer(LauncherServer)接收来自Driver(LauncherBackend)任务执行情况的最新状态。</p>

<p><img src="/images/blogs/rrc-spark/spark-launcher.jpg" alt="" /></p>

<p>代码包括：</p>

<ul>
<li>SparkLauncher 主要是startApplication。其他都是解析设置参数，相当于把shell的工作用java重写了一遍</li>
<li>LauncherServer 服务SocketServer类</li>
<li>LauncherServer$ServerConnection 状态处理类</li>
<li>LauncherConnection 通信基类：接收、发送消息</li>
<li>LauncherProtocol 通信协议</li>
<li>ChildProcAppHandle : SparkAppHandle 接收到Driver的状态后，请求分发类</li>
</ul>


<p>具体功能的流转请下载代码 <a href="https://github.com/winse/spark-examples/blob/master/src/main/scala/com/github/winse/spark/HelloWorldLauncher.scala">HelloWorldLauncher.scala</a> ，然后本地调试一步步的追踪学习。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/18">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/16">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>
  <h1><a class='category' href='/blog/categories/recommend/'>Recommend</a></h1>
	<ul role="list">
		
			<li class="post">
				<a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/08/25/video-auto-translate/">视频自动翻译</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/06/09/reasonable-way-to-access-the-internet/">科学上网（续）</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/01/20/gitalk-on-octopress/">Gitalk on Octopress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/11/16/sphinx-generate-docs/">使用Sphinx生成/管理文档</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/10/30/windows-run-ubuntu/">Windows Run Ubuntu</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/30/kubeadm-install-kubenetes-on-centos7/">Kubeadm部署kubernetes</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/08/casperjs-crawler/">爬虫之CasperJS</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/05/23/spark-on-hive-speculation-shit-bug/">Hive on Spark预测性执行BUG一枚</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/27/vnc-server-on-centos7/">在Centos7上安装VNC Server</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/25/develop-environment-prepare/">[整理] 环境准备工具集</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/19/nginx-https/">Nginx配置https</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/09/19/163-open-movies-download/">批量下载163-open的视频</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/23/hadoop-guide-catalog/">[整理] Hadoop入门</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/04/rpm-build-your-package/">RPM打包</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/03/28/hive-on-spark/">Hive on Spark</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/11/22/gfw-ladder/">搭梯笔记</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/08/24/manual-install-supervisor/">Supervisor安装配置</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/10/16/spark-build-and-configuration/">编译/搭建Spark环境</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/08/25/step-by-step-found-java-oom-error/">查找逐步定位Java程序OOM的异常实践</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/30/hadoop2-snappy-compress/">Hadoop2 Snappy Compress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/27/start-redis/">[读读书]Redis入门指南</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/04/21/hadoop2-windows-startguide/">Windows下部署/配置/调试hadoop2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/30/git-cheatsheet/">GIT操作记录手册</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/18/jekyll-edit-link-in-web-page/">Jekyll页面添加编辑按钮</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/02/23/quickly-open-program-in-windows/">[Windows运行]快速打开程序</a>
			</li>
		
			<li class="post">
				<a href="/blog/2013/09/19/let-shell-command-efficient/">让敲Shell命令高效起来</a>
			</li>
		
	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/01/13/openeuler20-dot-03lts-sp3-install-docker/">欧拉20.03LTS_SP3安装docker</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/12/08/octopress-generate-toc/">octopress生成TOC</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/12/08/recommand-blogs/">认真的博客</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/09/15/k2-again/">斐讯K2刷机padavan</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/05/11/redmine-on-arm-pi/">在树莓派上部署redmine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/12/appium-android-auto-test/">appium-Android自动化测试</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/26/android-linux-via-termux/">Android Linux via Termux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/10/try-bk-dot-tencent-dot-com/">Try bk.tencent.com</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/0/'>0</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/alluxio/'>alluxio</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/android/'>android</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/bigdata/'>bigdata</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blabla/'>blabla</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/debug/'>debug</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/deprecated/'>deprecated</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/devops/'>devops</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (16) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/es/'>es</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/flume/'>flume</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/git/'>git</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (44) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hbase/'>hbase</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hole/'>hole</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jenkins/'>jenkins</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jeykll/'>jeykll</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k2/'>k2</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (9) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kafka/'>kafka</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kubeadm/'>kubeadm</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/logstash/'>logstash</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/map/'>map</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/recommend/'>recommend</a> (27) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/shell/'>shell</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/staf/'>staf</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tachyon/'>tachyon</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tez/'>tez</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tools/'>tools</a> (69) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/topics/'>topics</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/vagrant/'>vagrant</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/wsl/'>wsl</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/zookeeper/'>zookeeper</a> (1) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (220)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<!--
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
&#8211;>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1253103971'%3E%3C/span%3E%3Cscript src='https://s19.cnzz.com/z_stat.php%3Fid%3D1253103971%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winse.github.io" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>











</body>
</html>
