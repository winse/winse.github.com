
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="紧接上一篇优化的文章，在生产进行shard分库/分片操作后，部分大量zsort键值对拆散到多个redis实例。原来统计总量的命令现在需要汇总后才行。 今天就来说说Redis里面的批量操作，批量操作其实就是循环，把大部分的工作让机器做了。逻辑比较复杂的用比较实现，功能简单的用脚本即可。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winseliu.com/posts/15">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43198550-1', 'auto');
  ga('send', 'pageview');

</script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停, 熙熙攘攘, 忙忙碌碌, 不知何畏.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winseliu.com" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/17/redis-batch-operate/">Redis批量操作</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-08-17T15:33:47+08:00" pubdate data-updated="true">Wed 2016-08-17 15:33</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>紧接上一篇优化的文章，在生产进行shard分库/分片操作后，部分大量zsort键值对拆散到多个redis实例。原来统计总量的命令现在需要汇总后才行。</p>

<p>今天就来说说Redis里面的批量操作，批量操作其实就是循环，把大部分的工作让机器做了。逻辑比较复杂的用比较实现，功能简单的用脚本即可。</p>

<ul>
<li>单机用lua脚本</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># redis-cli
</span><span class='line'>
</span><span class='line'>eval "local aks=redis.call('keys', '*'); local res=0; for i,r in ipairs(aks) do res=res+redis.call('hlen', r) end; return res" 0</span></code></pre></td></tr></table></div></figure>


<p>通过keys获取所有的键（都是hash类型），然后计算出匹配的hash包括的键值对总数。</p>

<p>在<strong>同一个实例</strong>的小数据量的统计，lua脚本优势还是比较明显的：redis自带的还能编程。</p>

<ul>
<li>shell脚本</li>
</ul>


<p>看官网的文档：<a href="http://redis.io/topics/rediscli">the Redis command line interface</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## shell
</span><span class='line'>
</span><span class='line'>cat commands | redis-cli --raw
</span><span class='line'>
</span><span class='line'>## redis-cli
</span><span class='line'>
</span><span class='line'>127.0.0.1:6379&gt; CONFIG RESETSTAT
</span><span class='line'>OK
</span><span class='line'>...
</span><span class='line'>127.0.0.1:6379&gt; info stats
</span><span class='line'># Stats
</span><span class='line'>total_connections_received:2
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>注意：不要用循环然后调用<code>redis-cli COMMAND</code>，这种方式会产生很多的TCP连接，如果要执行的命令太多，可能导致TCP端口不够用。</p>

<p>还有 <code>redis-cli --stat</code>，<code>redis-cli --scan</code>，<code>redis-cli monitor</code> 这些命令挺有意思的。</p>

<ul>
<li>直接tcp连接管道操作</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## shell
</span><span class='line'>
</span><span class='line'>sed 's/$/^M/' commands &gt; test.redis.cmd
</span><span class='line'>cat test.redis.cmd | nc localhost 6379
</span><span class='line'>
</span><span class='line'>## redis-cli
</span><span class='line'>
</span><span class='line'>127.0.0.1:6379&gt; info stats
</span><span class='line'># Stats
</span><span class='line'>total_connections_received:1
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>通过tcp连接操作，一批次的操作就一个连接。但是，操作的时刻需要主要，linux的换行符是 <code>\n</code>，而redis需要的是 <code>\r\n</code>；还有通过tcp连接返回的结果是redis协议原始数据，没有经过处理，需要稍微看看协议规范<a href="http://redis.io/topics/protocol">Redis Protocol specification</a></p>

<ul>
<li>pipelining</li>
</ul>


<p>redis自带的管道功能，性能提升相当明显（<a href="http://redis.io/topics/pipelining#some-benchmark">官网数据</a>）。</p>

<p>原来看到过觉得高大上，准备试试。但是返回结果却只有一个成功数而已！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo 119.84.100.68 | xargs -I{} echo "1:ips:2016-08-16:{}" | while read cmd ; do echo -e "*2\r\n\$5\r\nzcard\r\n\$${#cmd}\r\n$cmd\r\n" ; done  | redis-cli -p 26379 --pipe
</span><span class='line'>All data transferred. Waiting for the last reply...
</span><span class='line'>Last reply received from server.
</span><span class='line'>errors: 0, replies: 1</span></code></pre></td></tr></table></div></figure>


<p>注意：redis-cli带的pipe就比较坑：最后只返回操作成功失败的统计数量，只适合用来做更新操作<a href="http://redis.io/topics/mass-insert">Redis Mass Insertion</a>！！</p>

<p>要用pipeline来实现查询的话，用java/scala等语言来弄吧。</p>

<p>最后帖一下用shell脚本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>day=${day:-`date "+%Y-%m-%d"`}
</span><span class='line'>key="1:ips:$day"
</span><span class='line'>
</span><span class='line'>for h in hadoop-master{1..4} ; do 
</span><span class='line'>  exists=$(redis-cli -h $h -p 6372 exists $key)
</span><span class='line'>  if [ $exists -gt 0 ] ; then
</span><span class='line'>    redis-cli -h $h -p 6372 zrange $key 0 -1 &gt; activeresourceip$day.data
</span><span class='line'>    for h in hadoop-master{1..4} ; do
</span><span class='line'>      cat activeresourceip$day.data | while read ip ; do echo -e "zcard $key:$ip\r" ; done | redis-cli -h $h -p 6372
</span><span class='line'>    done
</span><span class='line'>  fi
</span><span class='line'>done | awk '{s+=$1} END {print s}' </span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/28/redis-optimise/">Redis使用优化</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-07-28T08:22:26+08:00" pubdate data-updated="true">Thu 2016-07-28 08:22</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近对生产的Redis做了两个优化：Redis扩展、以及对简单键值对的存储优化（string改成hash形式）</p>

<h2>Redis扩展</h2>

<p>上一篇介绍的Codis安装。但是使用Pipeline操作时间比较长、连接数比较多的情况下，经常出现连接重置的情况。感觉不踏实，go也不懂感觉短时间处理不了这种问题。</p>

<p>寻求它法。前期是把不同业务数据写入不同的redis实例，根据业务来分。对于同一个业务来说，得根据key的hash来写入不同的实例，但是自己写的话得包装一堆东西。</p>

<p>jedis工具包括Shared的功能，根据写入key的hash映射到不同的redis实例。截取了部分Shared的主要代码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class Sharded&lt;R, S extends ShardInfo&lt;R&gt;&gt; {
</span><span class='line'>...
</span><span class='line'>    private void initialize(List&lt;S&gt; shards) {
</span><span class='line'>  nodes = new TreeMap&lt;Long, S&gt;();
</span><span class='line'>
</span><span class='line'>  for (int i = 0; i != shards.size(); ++i) {
</span><span class='line'>      final S shardInfo = shards.get(i);
</span><span class='line'>      if (shardInfo.getName() == null)
</span><span class='line'>      for (int n = 0; n &lt; 160 * shardInfo.getWeight(); n++) {
</span><span class='line'>          nodes.put(this.algo.hash("SHARD-" + i + "-NODE-" + n),
</span><span class='line'>              shardInfo);
</span><span class='line'>      }
</span><span class='line'>      else
</span><span class='line'>      for (int n = 0; n &lt; 160 * shardInfo.getWeight(); n++) {
</span><span class='line'>          nodes.put(
</span><span class='line'>              this.algo.hash(shardInfo.getName() + "*"
</span><span class='line'>                  + shardInfo.getWeight() + n), shardInfo);
</span><span class='line'>      }
</span><span class='line'>      resources.put(shardInfo, shardInfo.createResource());
</span><span class='line'>  }
</span><span class='line'>    }
</span><span class='line'>...   
</span><span class='line'>    public S getShardInfo(byte[] key) {
</span><span class='line'>  SortedMap&lt;Long, S&gt; tail = nodes.tailMap(algo.hash(key));
</span><span class='line'>  if (tail.isEmpty()) {
</span><span class='line'>      return nodes.get(nodes.firstKey());
</span><span class='line'>  }
</span><span class='line'>  return tail.get(tail.firstKey());
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public S getShardInfo(String key) {
</span><span class='line'>  return getShardInfo(SafeEncoder.encode(getKeyTag(key)));
</span><span class='line'>    }
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>使用的时刻很简单，通过ShardedJedis来进读写，大部分的操作与Jedis类似。只是有部分整个集群的操作不能用：keys/scan等。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  public List&lt;JedisShardInfo&gt; getShards(String sValue) {
</span><span class='line'>    String[] servers = sValue.split(",");
</span><span class='line'>
</span><span class='line'>    List&lt;JedisShardInfo&gt; shards = new ArrayList&lt;&gt;();
</span><span class='line'>    for (String server : servers) {
</span><span class='line'>      Pair&lt;String, Integer&gt; hp = parseServer(server);
</span><span class='line'>      shards.add(new JedisShardInfo(hp.getLeft(), hp.getRight(), Integer.MAX_VALUE));
</span><span class='line'>    }
</span><span class='line'>    return shards;
</span><span class='line'>  }
</span><span class='line'>  private ShardedJedisPool createRedisPool(String server) {
</span><span class='line'>    return new ShardedJedisPool(new GenericObjectPoolConfig(), getShards(server));
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>如果使用过程中要使用keys，可以通过getAllShards得到所有Jedis实例的键再进行处理：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  public Double zscore(String key, String member) {
</span><span class='line'>    try (ShardedJedis redis = getRedis()) {
</span><span class='line'>      return redis.zscore(key, member);
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  public void expires(List&lt;String&gt; patterns, int seconds) {
</span><span class='line'>    try (ShardedJedis shardedJedis = getRedis()) {
</span><span class='line'>      Set&lt;String&gt; keys = new HashSet&lt;&gt;();
</span><span class='line'>
</span><span class='line'>      for (Jedis redis : shardedJedis.getAllShards()) {
</span><span class='line'>        for (String p : patterns) {
</span><span class='line'>          keys.addAll(redis.keys(p)); // 调用单独实例的keys命令获取匹配的键
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      ShardedJedisPipeline pipeline = shardedJedis.pipelined();
</span><span class='line'>      for (String key : keys) {
</span><span class='line'>        pipeline.expire(key, seconds);
</span><span class='line'>      }
</span><span class='line'>      pipeline.sync();
</span><span class='line'>    }
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>进行多实例(集群)切分后，效果还是挺明显的。写入高峰期分流效果显著，负载均摊，可使用的内存也翻翻，键也基本平均分布（ <code>--maxmemory-policy volatile-lru</code> ）。生产实际效果：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@hadoop-master1 redis]$ sh stat_cluster.sh 
</span><span class='line'>
</span><span class='line'> * [ ============================================================&gt; ] 4 / 4
</span><span class='line'>
</span><span class='line'>hadoop-master1:
</span><span class='line'># Memory
</span><span class='line'>used_memory:44287785776
</span><span class='line'>used_memory_human:41.25G
</span><span class='line'>used_memory_rss:67458658304
</span><span class='line'>used_memory_peak:67981990576
</span><span class='line'>used_memory_peak_human:63.31G
</span><span class='line'>used_memory_lua:33792
</span><span class='line'>mem_fragmentation_ratio:1.52
</span><span class='line'>mem_allocator:jemalloc-3.6.0
</span><span class='line'># Keyspace
</span><span class='line'>db0:keys=72729777,expires=11967,avg_ttl=63510023
</span><span class='line'>
</span><span class='line'>hadoop-master2:
</span><span class='line'># Memory
</span><span class='line'>used_memory:50667945344
</span><span class='line'>used_memory_human:47.19G
</span><span class='line'>used_memory_rss:66036752384
</span><span class='line'>used_memory_peak:64424543672
</span><span class='line'>used_memory_peak_human:60.00G
</span><span class='line'>used_memory_lua:33792
</span><span class='line'>mem_fragmentation_ratio:1.30
</span><span class='line'>mem_allocator:jemalloc-3.6.0
</span><span class='line'># Keyspace
</span><span class='line'>db0:keys=100697581,expires=13426,avg_ttl=63509903
</span><span class='line'>
</span><span class='line'>hadoop-master3:
</span><span class='line'># Memory
</span><span class='line'>used_memory:56763389184
</span><span class='line'>used_memory_human:52.87G
</span><span class='line'>used_memory_rss:66324045824
</span><span class='line'>used_memory_peak:64424546136
</span><span class='line'>used_memory_peak_human:60.00G
</span><span class='line'>used_memory_lua:33792
</span><span class='line'>mem_fragmentation_ratio:1.17
</span><span class='line'>mem_allocator:jemalloc-3.6.0
</span><span class='line'># Keyspace
</span><span class='line'>db0:keys=94363547,expires=13544,avg_ttl=63505693
</span><span class='line'>
</span><span class='line'>hadoop-master4:
</span><span class='line'># Memory
</span><span class='line'>used_memory:54513952832
</span><span class='line'>used_memory_human:50.77G
</span><span class='line'>used_memory_rss:67257393152
</span><span class='line'>used_memory_peak:64820124928
</span><span class='line'>used_memory_peak_human:60.37G
</span><span class='line'>used_memory_lua:33792
</span><span class='line'>mem_fragmentation_ratio:1.23
</span><span class='line'>mem_allocator:jemalloc-3.6.0
</span><span class='line'># Keyspace
</span><span class='line'>db0:keys=83297543,expires=12418,avg_ttl=63507046
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Finished processing 4 / 4 hosts in 298.89 ms</span></code></pre></td></tr></table></div></figure>


<h2>存储优化</h2>

<p>实际环境中存在会大量的用到简单string键值对，挺耗内存的。其实使用hash（内部存储ziplist）能更有效的利用内存。</p>

<p>注意是ziplist形式的hash才能省内存！！如果是skiplist的hash会浪费内存。</p>

<ul>
<li><a href="http://webcache.googleusercontent.com/search?q=cache:yr96Qf3F0e4J:heylinux.com/archives/1920.html+&amp;cd=1&amp;hl=zh-CN&amp;ct=clnk&amp;gl=jp">内存优化之Redis数据结构的设计优化实践</a> heylinux.com/archives/1920.html 这篇文章可能访问不了，可以通过google/baidu的快照来查看</li>
<li><a href="http://redis4you.com/articles.php?id=008&amp;name=Understanding+hash-max-zipmap-entries+and+">Understanding hash-max-zipmap-entries and &ldquo;hash of hashes&rdquo; optimization</a></li>
<li><a href="http://redis.io/topics/memory-optimization">http://redis.io/topics/memory-optimization</a></li>
<li><a href="http://redis.io/topics/lru-cache">http://redis.io/topics/lru-cache</a></li>
<li><a href="https://segmentfault.com/a/1190000004708270">Redis内存优化</a></li>
</ul>


<p>下面引用官网对简单键值对和Hash的一个比较（Redis中key的相关特性不关注）: 对于小数据量的hash进行了优化</p>

<blockquote><p> a few keys use a lot more memory than a single key containing a hash with a few fields.</p>

<p> We use a trick.</p>

<p> But many times hashes contain just a few fields. When hashes are small we can instead just encode them in an O(N) data structure, like a linear array with length-prefixed key value pairs. Since we do this only when N is small</p>

<p> This does not work well just from the point of view of time complexity, but also from the point of view of constant times, since a linear array of key value pairs happens to play very well with the CPU cache (it has a better cache locality than a hash table).</p></blockquote>

<p>优化主要涉及到ziplist的两个参数，是一个cpu/memory之间的均衡关系。entries直接用默认的就好了，value最好不要大于254（ziplist节点entry大于254需要增加4个到5字节，来存储前一个entry的长度）。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hash-max-zipmap-entries 512 (hash-max-ziplist-entries for Redis &gt;= 2.6)
</span><span class='line'>hash-max-zipmap-value 64  (hash-max-ziplist-value for Redis &gt;= 2.6)</span></code></pre></td></tr></table></div></figure>


<p>简单列几条数据：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>3:0dc46077dfaa4970a1ec9f38cfc29277fa9e1012.ime.galileo.baidu.com  -&gt;  1469584847
</span><span class='line'>3:co4hk52ia0b1.5buzd.com                                          -&gt;  1468859527
</span><span class='line'>1:119.84.110.82_39502                                             -&gt;  1469666877</span></code></pre></td></tr></table></div></figure>


<p>原始key内容可以不需要，鉴于包括域名的key太长，直接对数据key取md5。以1亿键值对来进行估算，取md5的前五位作为key，后27位作为hash键值对的key。</p>

<p>扫描原始redis实例，然后把键值对转换后存储到新的实例。转换Scala代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import java.util.{List =&gt; JList}
</span><span class='line'>import org.apache.commons.codec.digest.DigestUtils
</span><span class='line'>import redis.clients.jedis._
</span><span class='line'>import scala.collection.JavaConversions._
</span><span class='line'>
</span><span class='line'>trait RedisUtils {
</span><span class='line'>
</span><span class='line'>  def md5(data: String): String = {
</span><span class='line'>    DigestUtils.md5Hex(data)
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  def Type(redis: Jedis, key: String) = redis.`type`(key)
</span><span class='line'>
</span><span class='line'>  def scan(redis: Jedis)(action: JList[String] =&gt; Unit): Unit = {
</span><span class='line'>    import scala.util.control.Breaks._
</span><span class='line'>
</span><span class='line'>    var cursor = "0"
</span><span class='line'>    breakable {
</span><span class='line'>      while (true) {
</span><span class='line'>        val res = redis.scan(cursor)
</span><span class='line'>
</span><span class='line'>        action(res.getResult())
</span><span class='line'>
</span><span class='line'>        cursor = res.getStringCursor
</span><span class='line'>        if (cursor.equals("0")) {
</span><span class='line'>          break
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  def printInfo(redis: Jedis): Unit = {
</span><span class='line'>    println(redis.info())
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  // 验证：
</span><span class='line'>  //  打印 **总共** 的键值对数量
</span><span class='line'>  //  eval "local aks=redis.call('keys', '*'); local res=0; for i,r in ipairs(aks) do res=res+redis.call('hlen', r) end; return res" 0
</span><span class='line'>  //  打印 **每个** hash包括的键值对个数
</span><span class='line'>  //  eval "local aks=redis.call('keys', '*'); local res={}; for i,r in ipairs(aks) do res[i]=redis.call('hlen', r) end; return res" 0
</span><span class='line'>  //
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>Object RedisTransfer extends RedisUtils {
</span><span class='line'>
</span><span class='line'>  def handle(key: String, value: String, tp: Pipeline): Unit = {
</span><span class='line'>    val m5 = md5(key)
</span><span class='line'>    tp.hset(m5.substring(0, 5), m5.substring(5), value)
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  def main(args: Array[String]) {
</span><span class='line'>    val Array(sHost, sPort, tHost, tPort) = args
</span><span class='line'>
</span><span class='line'>    val timeout = 60 * 1000
</span><span class='line'>    val source = new Jedis(sHost, sPort.toInt, timeout)
</span><span class='line'>    val sp = source.pipelined()
</span><span class='line'>    val target = new Jedis(tHost, tPort.toInt, timeout)
</span><span class='line'>    val tp = target.pipelined()
</span><span class='line'>
</span><span class='line'>    scan(source) { keys =&gt;
</span><span class='line'>      // 仅处理 string类型 的记录
</span><span class='line'>      val requests = for (key &lt;- keys) yield Some((key, sp.get(key)))
</span><span class='line'>      sp.sync()
</span><span class='line'>
</span><span class='line'>      for (
</span><span class='line'>        request &lt;- requests;
</span><span class='line'>        (key, resp) &lt;- request
</span><span class='line'>      ) {
</span><span class='line'>        try {
</span><span class='line'>          handle(key, resp.get(), tp)
</span><span class='line'>        } catch {
</span><span class='line'>          case e: Exception =&gt; println(s"fetch $key with exception, ${e.getMessage}")
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    tp.sync()
</span><span class='line'>
</span><span class='line'>    printInfo(target)
</span><span class='line'>
</span><span class='line'>    target.close()
</span><span class='line'>    source.close()
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>由于对数据进行了处理，对比不是很清晰，不能直接说省了多少空间。但是添加上面的处理后，原来30G（大概3亿多）的实例变成了15G。</p>

<h2>另一个案例</h2>

<p>另外对域名的实例做了下测试，6.4百万的键值对：707.29M内存：</p>

<p>md5前4个字符作为key，总共产生65536个键值对。每个hash大概包括100个kv。</p>

<ul>
<li>hash的key使用原来的键

<ul>
<li>不调ziplist_value的值，实际的转换成hash(skiplist)：939.6M，</li>
<li>ziplist_value修改成1024，转换成hash(ziplist)：513.78M</li>
</ul>
</li>
<li>md5的作为hash的新key：344.7M</li>
<li>md5的后28位作为hash的新key： 259.09M</li>
</ul>


<p>如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MD5:
</span><span class='line'>  3:0dc46077dfaa4970a1ec9f38cfc29277fa9e1012.ime.galileo.baidu.com
</span><span class='line'>  1356de078028ddf266c962533760b27c
</span><span class='line'>
</span><span class='line'>1356 -&gt; hash( 3:0dc46077dfaa4970a1ec9f38cfc29277fa9e1012.ime.galileo.baidu.com -&gt; 1469584847 )
</span><span class='line'>1356 -&gt; hash( 1356de078028ddf266c962533760b27c -&gt; 1469584847 )
</span><span class='line'>1356 -&gt; hash( de078028ddf266c962533760b27c -&gt; 1469584847 )</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/19/xss-blocked-by-naxsi/">使用 Naxsi 处理 XSS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-07-19T19:43:13+08:00" pubdate data-updated="true">Tue 2016-07-19 19:43</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前台安全检查时出现了【检测到目标URL存在跨站漏洞】，就是可以通过url带js来截取用户的信息。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>js/jquery/jquery-1.8.2.min.js/&lt;ScRipt&gt;jovoys(6258);&lt;/ScRipt&gt;</span></code></pre></td></tr></table></div></figure>


<p>XSS的一些简单介绍：</p>

<ul>
<li><a href="http://anti-hacker.blogspot.com/2008/01/xsscross-site-script.html">淺析XSS(Cross Site Script)漏洞原理</a></li>
<li><a href="http://www.freebuf.com/articles/web/42727.html">XSS的原理分析与解剖（第二篇）</a></li>
</ul>


<p>搜索到使用 <strong>naxsi</strong> 配合 <strong>nginx</strong> 有现成的解决方案，网上的资料很乱，直接看 <a href="https://github.com/nbs-system/naxsi/wiki">官方文档</a> 清晰一些。</p>

<ol>
<li>编译</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 sources]$ ll
</span><span class='line'>drwxrwxr-x  6 hadoop hadoop      4096 Sep 10  2015 naxsi-0.54
</span><span class='line'>-rw-r--r--  1 hadoop hadoop    192843 Jul 19 18:42 naxsi-0.54.zip
</span><span class='line'>drwxr-xr-x  9 hadoop hadoop      4096 Nov 11  2015 nginx-1.7.10
</span><span class='line'>
</span><span class='line'>[hadoop@cu2 sources]$ ll nginx-1.7.10/
</span><span class='line'>total 3180
</span><span class='line'>drwxr-xr-x  6 hadoop hadoop    4096 Nov 11  2015 auto
</span><span class='line'>-rw-r--r--  1 hadoop hadoop  246649 Feb 10  2015 CHANGES
</span><span class='line'>-rw-r--r--  1 hadoop hadoop  375103 Feb 10  2015 CHANGES.ru
</span><span class='line'>drwxr-xr-x  2 hadoop hadoop    4096 Nov 11  2015 conf
</span><span class='line'>-rwxr-xr-x  1 hadoop hadoop    2463 Feb 10  2015 configure
</span><span class='line'>drwxr-xr-x  4 hadoop hadoop    4096 Nov 11  2015 contrib
</span><span class='line'>drwxr-xr-x  2 hadoop hadoop    4096 Nov 11  2015 html
</span><span class='line'>-rw-r--r--  1 hadoop hadoop    1397 Feb 10  2015 LICENSE
</span><span class='line'>-rw-rw-r--  1 hadoop hadoop     342 Jul 19 18:44 Makefile
</span><span class='line'>drwxr-xr-x  2 hadoop hadoop    4096 Nov 11  2015 man
</span><span class='line'>drwxrwxr-x  4 hadoop hadoop    4096 Jul 19 18:45 objs
</span><span class='line'>-rw-r--r--  1 hadoop hadoop 2009464 Nov 11  2015 pcre-8.36.tar.gz
</span><span class='line'>-rw-r--r--  1 hadoop hadoop      49 Feb 10  2015 README
</span><span class='line'>drwxr-xr-x 10 hadoop hadoop    4096 Nov 11  2015 src
</span><span class='line'>-rw-r--r--  1 hadoop hadoop  571091 Nov 11  2015 zlib-1.2.8.tar.gz
</span><span class='line'>
</span><span class='line'>[hadoop@cu2 nginx-1.7.10]$ ./configure --add-module=../naxsi-x.xx/naxsi_src/ --prefix=/opt/nginx
</span><span class='line'>[hadoop@cu2 nginx-1.7.10]$ make && make install
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>配置</li>
</ol>


<p>需要在 nginx.conf 的http中引入 <strong>naxsi_core.rules</strong> ，在location中加入规则。</p>

<p>先把 naxsi_core.rules 拷贝到 nginx/conf 目录下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http {
</span><span class='line'>    include       mime.types;
</span><span class='line'>    include       naxsi_core.rules;
</span><span class='line'>  ...
</span><span class='line'>    server {
</span><span class='line'>  ...
</span><span class='line'>        location /omc {
</span><span class='line'>
</span><span class='line'>#Enable naxsi
</span><span class='line'>SecRulesEnabled;
</span><span class='line'>
</span><span class='line'>#Enable learning mide
</span><span class='line'>#LearningMode;
</span><span class='line'>
</span><span class='line'>#Define where blocked requests go
</span><span class='line'>DeniedUrl "/omc/error.jsp";
</span><span class='line'>
</span><span class='line'>#CheckRules, determining when naxsi needs to take action
</span><span class='line'>CheckRule "$SQL &gt;= 8" BLOCK;
</span><span class='line'>CheckRule "$RFI &gt;= 8" BLOCK;
</span><span class='line'>CheckRule "$TRAVERSAL &gt;= 4" BLOCK;
</span><span class='line'>CheckRule "$EVADE &gt;= 4" BLOCK;
</span><span class='line'>CheckRule "$XSS &gt;= 8" BLOCK;
</span><span class='line'>
</span><span class='line'>#naxsi logs goes there
</span><span class='line'>error_log logs/foo.log;
</span><span class='line'>
</span><span class='line'>                proxy_set_header        X-Real-IP $remote_addr;
</span><span class='line'>                proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>                proxy_set_header        Host $http_host;
</span><span class='line'>
</span><span class='line'>                proxy_pass http://localhost:8888/omc;
</span><span class='line'>        }
</span><span class='line'>      ...
</span><span class='line'>      </span></code></pre></td></tr></table></div></figure>


<ol>
<li>启动生效</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sbin/nginx -p $PWD</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/nbs-system/naxsi/wiki/naxsi-setup">https://github.com/nbs-system/naxsi/wiki/naxsi-setup</a>
<a href="https://github.com/nbs-system/naxsi/wiki/checkrules-bnf">https://github.com/nbs-system/naxsi/wiki/checkrules-bnf</a></p>

<p>检查会比较严格，添加后应用可能会报错，需要对 foo.log 中的情况进行确认，对规则进行一些修改。如不需要监控 cookie 里面的内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[omc@cu-omc1 nginx]$ vi conf/naxsi_core.rules 
</span><span class='line'>:%s/|$HEADERS_VAR:Cookie//</span></code></pre></td></tr></table></div></figure>


<p>还有一些 <code>%[2|3]</code> 的可能也需要改改。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>uri=/omc/Frame/Time.do&learning=0&vers=0.54&total_processed=404&total_blocked=10&block=1&zone0=BODY&id0=16&var_name0=</span></code></pre></td></tr></table></div></figure>


<p>根据请求的 id 去规则配置里面找具体的描述，然后 uri 和 var_name 查看具体的请求对症下药：去掉规则或者改请求。</p>

<p>如上面请求的 <strong>id0=16</strong> 对应 <strong>#@MainRule &ldquo;msg:empty POST&rdquo; id:16;</strong> 把请求修改成get即可。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/14/codis-guide/">Codis简单使用</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-07-14T19:35:23+08:00" pubdate data-updated="true">Thu 2016-07-14 19:35</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>总有单机搞不定的时刻，并且手动切分很麻烦的时刻。不得不开始redis集群，官网的redis3不支持pipeline首先就排除了。</p>

<p>安装codis，需要先安装go。(官网入门文档](<a href="https://github.com/CodisLabs/codis/blob/master/doc/tutorial_zh.md">https://github.com/CodisLabs/codis/blob/master/doc/tutorial_zh.md</a>)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu2 local]# tar zxvf go1.6.2.linux-amd64.tar.gz 
</span><span class='line'>
</span><span class='line'>[hadoop@cu2 ~]$ vi .bash_profile
</span><span class='line'>...
</span><span class='line'>export GOROOT=/usr/local/go
</span><span class='line'>export GOPATH=$HOME/codis
</span><span class='line'>
</span><span class='line'>PATH=$GOPATH/bin:$GOROOT/bin:$HOME/bin:$HADOOP_HOME/bin:$HIVE_HOME/bin:$PATH
</span><span class='line'>
</span><span class='line'>[hadoop@cu2 codis]$ source ~/.bash_profile </span></code></pre></td></tr></table></div></figure>


<p>git,make 这些要提前安装好。测试环境都编译过hadoop、spark肯定齐全的。</p>

<p>通过go在线安装（如果生产不能上网，可以先在测试环境安装好后，然后打包复制过去）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 codis]$ go get -u -d github.com/CodisLabs/codis
</span><span class='line'>package github.com/CodisLabs/codis: no buildable Go source files in /home/hadoop/codis/src/github.com/CodisLabs/codis
</span><span class='line'>[hadoop@cu2 codis]$ 
</span><span class='line'>
</span><span class='line'>&lt;&lt;安装依赖的工具
</span><span class='line'>[hadoop@cu2 codis]$ go get github.com/tools/godep
</span><span class='line'>
</span><span class='line'>[hadoop@cu2 codis]$ make
</span><span class='line'>GO15VENDOREXPERIMENT=0 GOPATH=`godep path` godep restore
</span><span class='line'>godep: [WARNING]: godep should only be used inside a valid go package directory and
</span><span class='line'>godep: [WARNING]: may not function correctly. You are probably outside of your $GOPATH.
</span><span class='line'>godep: [WARNING]:       Current Directory: /home/hadoop/codis/src/github.com/CodisLabs/codis
</span><span class='line'>godep: [WARNING]:       $GOPATH: /home/hadoop/codis/src/github.com/CodisLabs/codis/Godeps/_workspace
</span><span class='line'>       
</span><span class='line'>&lt;&lt;这里要等一段时间
</span><span class='line'>
</span><span class='line'>GOPATH=`godep path`:$GOPATH go build -o bin/codis-proxy ./cmd/proxy
</span><span class='line'>godep: WARNING: Godep workspaces (./Godeps/_workspace) are deprecated and support for them will be removed when go1.8 is released.
</span><span class='line'>godep: WARNING: Go version (go1.6) & $GO15VENDOREXPERIMENT= wants to enable the vendor experiment, but disabling because a Godep workspace (Godeps/_workspace) exists
</span><span class='line'>GOPATH=`godep path`:$GOPATH go build -o bin/codis-config ./cmd/cconfig
</span><span class='line'>godep: WARNING: Godep workspaces (./Godeps/_workspace) are deprecated and support for them will be removed when go1.8 is released.
</span><span class='line'>godep: WARNING: Go version (go1.6) & $GO15VENDOREXPERIMENT= wants to enable the vendor experiment, but disabling because a Godep workspace (Godeps/_workspace) exists
</span><span class='line'>make -j4 -C extern/redis-2.8.21/
</span><span class='line'>make[1]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21'
</span><span class='line'>cd src && make all
</span><span class='line'>make[2]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/src'
</span><span class='line'>rm -rf redis-server redis-sentinel redis-cli redis-benchmark redis-check-dump redis-check-aof *.o *.gcda *.gcno *.gcov redis.info lcov-html
</span><span class='line'>(cd ../deps && make distclean)
</span><span class='line'>make[3]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps'
</span><span class='line'>(cd hiredis && make clean) &gt; /dev/null || true
</span><span class='line'>(cd linenoise && make clean) &gt; /dev/null || true
</span><span class='line'>(cd lua && make clean) &gt; /dev/null || true
</span><span class='line'>(cd jemalloc && [ -f Makefile ] && make distclean) &gt; /dev/null || true
</span><span class='line'>(rm -f .make-*)
</span><span class='line'>make[3]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps'
</span><span class='line'>(rm -f .make-*)
</span><span class='line'>echo STD=-std=c99 -pedantic &gt;&gt; .make-settings
</span><span class='line'>echo WARN=-Wall -W &gt;&gt; .make-settings
</span><span class='line'>echo OPT=-O2 &gt;&gt; .make-settings
</span><span class='line'>echo MALLOC=jemalloc &gt;&gt; .make-settings
</span><span class='line'>echo CFLAGS= &gt;&gt; .make-settings
</span><span class='line'>echo LDFLAGS= &gt;&gt; .make-settings
</span><span class='line'>echo REDIS_CFLAGS= &gt;&gt; .make-settings
</span><span class='line'>echo REDIS_LDFLAGS= &gt;&gt; .make-settings
</span><span class='line'>echo PREV_FINAL_CFLAGS=-std=c99 -pedantic -Wall -W -O2 -g -ggdb   -I../deps/hiredis -I../deps/linenoise -I../deps/lua/src -DUSE_JEMALLOC -I../deps/jemalloc/include &gt;&gt; .make-settings
</span><span class='line'>echo PREV_FINAL_LDFLAGS=  -g -ggdb -rdynamic &gt;&gt; .make-settings
</span><span class='line'>(cd ../deps && make hiredis linenoise lua jemalloc)
</span><span class='line'>make[3]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps'
</span><span class='line'>(cd hiredis && make clean) &gt; /dev/null || true
</span><span class='line'>(cd linenoise && make clean) &gt; /dev/null || true
</span><span class='line'>(cd lua && make clean) &gt; /dev/null || true
</span><span class='line'>(cd jemalloc && [ -f Makefile ] && make distclean) &gt; /dev/null || true
</span><span class='line'>(rm -f .make-*)
</span><span class='line'>(echo "" &gt; .make-ldflags)
</span><span class='line'>(echo "" &gt; .make-cflags)
</span><span class='line'>MAKE hiredis
</span><span class='line'>cd hiredis && make static
</span><span class='line'>MAKE linenoise
</span><span class='line'>cd linenoise && make
</span><span class='line'>MAKE lua
</span><span class='line'>cd lua/src && make all CFLAGS="-O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL " MYLDFLAGS="" AR="ar rcu"
</span><span class='line'>MAKE jemalloc
</span><span class='line'>cd jemalloc && ./configure --with-jemalloc-prefix=je_ --enable-cc-silence CFLAGS="-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops " LDFLAGS=""
</span><span class='line'>make[4]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/linenoise'
</span><span class='line'>cc  -Wall -Os -g  -c linenoise.c
</span><span class='line'>make[4]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/lua/src'
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lapi.o lapi.c
</span><span class='line'>make[4]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/hiredis'
</span><span class='line'>cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  net.c
</span><span class='line'>checking for xsltproc... /usr/bin/xsltproc
</span><span class='line'>checking for gcc... gcc
</span><span class='line'>checking whether the C compiler works... yes
</span><span class='line'>checking for C compiler default output file name... a.out
</span><span class='line'>checking for suffix of executables... 
</span><span class='line'>checking whether we are cross compiling... no
</span><span class='line'>checking for suffix of object files... o
</span><span class='line'>checking whether we are using the GNU C compiler... cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  hiredis.c
</span><span class='line'>yes
</span><span class='line'>checking whether gcc accepts -g... yes
</span><span class='line'>checking for gcc option to accept ISO C89... none needed
</span><span class='line'>checking how to run the C preprocessor... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lcode.o lcode.c
</span><span class='line'>make[4]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/linenoise'
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ldebug.o ldebug.c
</span><span class='line'>gcc -E
</span><span class='line'>checking for grep that handles long lines and -e... /bin/grep
</span><span class='line'>checking for egrep... /bin/grep -E
</span><span class='line'>checking for ANSI C header files... yes
</span><span class='line'>checking for sys/types.h... yes
</span><span class='line'>checking for sys/stat.h... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ldo.o ldo.c
</span><span class='line'>yes
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ldump.o ldump.c
</span><span class='line'>checking for stdlib.h... ldo.c: In function ‘f_parser’:
</span><span class='line'>ldo.c:496: warning: unused variable ‘c’
</span><span class='line'>yes
</span><span class='line'>checking for string.h... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lfunc.o lfunc.c
</span><span class='line'>yes
</span><span class='line'>checking for memory.h... yes
</span><span class='line'>checking for strings.h... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lgc.o lgc.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o llex.o llex.c
</span><span class='line'>yes
</span><span class='line'>cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  sds.c
</span><span class='line'>checking for inttypes.h... yes
</span><span class='line'>checking for stdint.h... yes
</span><span class='line'>checking for unistd.h... yes
</span><span class='line'>checking whether byte ordering is bigendian... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lmem.o lmem.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lobject.o lobject.c
</span><span class='line'>no
</span><span class='line'>checking size of void *... cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  async.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lopcodes.o lopcodes.c
</span><span class='line'>8
</span><span class='line'>checking size of int... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lparser.o lparser.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lstate.o lstate.c
</span><span class='line'>4
</span><span class='line'>checking size of long... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lstring.o lstring.c
</span><span class='line'>8
</span><span class='line'>checking size of intmax_t... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ltable.o ltable.c
</span><span class='line'>8
</span><span class='line'>checking build system type... ar rcs libhiredis.a net.o hiredis.o sds.o async.o
</span><span class='line'>x86_64-unknown-linux-gnu
</span><span class='line'>checking host system type... x86_64-unknown-linux-gnu
</span><span class='line'>checking whether pause instruction is compilable... make[4]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/hiredis'
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ltm.o ltm.c
</span><span class='line'>yes
</span><span class='line'>checking whether SSE2 intrinsics is compilable... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lundump.o lundump.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lvm.o lvm.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lzio.o lzio.c
</span><span class='line'>yes
</span><span class='line'>checking for ar... ar
</span><span class='line'>checking whether __attribute__ syntax is compilable... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o strbuf.o strbuf.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o fpconv.o fpconv.c
</span><span class='line'>yes
</span><span class='line'>checking whether compiler supports -fvisibility=hidden... yes
</span><span class='line'>checking whether compiler supports -Werror... yes
</span><span class='line'>checking whether tls_model attribute is compilable... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lauxlib.o lauxlib.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lbaselib.o lbaselib.c
</span><span class='line'>yes
</span><span class='line'>checking for a BSD-compatible install... /usr/bin/install -c
</span><span class='line'>checking for ranlib... ranlib
</span><span class='line'>checking for ld... /usr/bin/ld
</span><span class='line'>checking for autoconf... /usr/bin/autoconf
</span><span class='line'>checking for memalign... yes
</span><span class='line'>checking for valloc... yes
</span><span class='line'>checking configured backtracing method... N/A
</span><span class='line'>checking for sbrk... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ldblib.o ldblib.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o liolib.o liolib.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lmathlib.o lmathlib.c
</span><span class='line'>yes
</span><span class='line'>checking whether utrace(2) is compilable... no
</span><span class='line'>checking whether valgrind is compilable... no
</span><span class='line'>checking STATIC_PAGE_SHIFT... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o loslib.o loslib.c
</span><span class='line'>12
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o ltablib.o ltablib.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lstrlib.o lstrlib.c
</span><span class='line'>checking pthread.h usability... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o loadlib.o loadlib.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o linit.o linit.c
</span><span class='line'>yes
</span><span class='line'>checking pthread.h presence... yes
</span><span class='line'>checking for pthread.h... yes
</span><span class='line'>checking for pthread_create in -lpthread... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lua_cjson.o lua_cjson.c
</span><span class='line'>yes
</span><span class='line'>checking for _malloc_thread_cleanup... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lua_struct.o lua_struct.c
</span><span class='line'>no
</span><span class='line'>checking for _pthread_mutex_init_calloc_cb... no
</span><span class='line'>checking for TLS... yes
</span><span class='line'>checking whether a program using ffsl is compilable... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lua_cmsgpack.o lua_cmsgpack.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lua_bit.o lua_bit.c
</span><span class='line'>yes
</span><span class='line'>checking whether atomic(9) is compilable... no
</span><span class='line'>checking whether Darwin OSAtomic*() is compilable... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o lua.o lua.c
</span><span class='line'>cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o luac.o luac.c
</span><span class='line'>no
</span><span class='line'>checking whether to force 32-bit __sync_{add,sub}_and_fetch()... no
</span><span class='line'>checking whether to force 64-bit __sync_{add,sub}_and_fetch()... no
</span><span class='line'>checking whether Darwin OSSpin*() is compilable... no
</span><span class='line'>checking for stdbool.h that conforms to C99... cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL    -c -o print.o print.c
</span><span class='line'>yes
</span><span class='line'>checking for _Bool... ar rcu liblua.a lapi.o lcode.o ldebug.o ldo.o ldump.o lfunc.o lgc.o llex.o lmem.o lobject.o lopcodes.o lparser.o lstate.o lstring.o ltable.o ltm.o lundump.o lvm.o lzio.o strbuf.o fpconv.o lauxlib.o lbaselib.o ldblib.o liolib.o lmathlib.o loslib.o ltablib.o lstrlib.o loadlib.o linit.o lua_cjson.o lua_struct.o lua_cmsgpack.o lua_bit.o        # DLL needs all object files
</span><span class='line'>ranlib liblua.a
</span><span class='line'>cc -o lua  lua.o liblua.a -lm 
</span><span class='line'>liblua.a(loslib.o): In function `os_tmpname':
</span><span class='line'>loslib.c:(.text+0x35): warning: the use of `tmpnam' is dangerous, better use `mkstemp'
</span><span class='line'>cc -o luac  luac.o print.o liblua.a -lm 
</span><span class='line'>yes
</span><span class='line'>make[4]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/lua/src'
</span><span class='line'>configure: creating ./config.status
</span><span class='line'>config.status: creating Makefile
</span><span class='line'>config.status: creating doc/html.xsl
</span><span class='line'>config.status: creating doc/manpages.xsl
</span><span class='line'>config.status: creating doc/jemalloc.xml
</span><span class='line'>config.status: creating include/jemalloc/jemalloc_macros.h
</span><span class='line'>config.status: creating include/jemalloc/jemalloc_protos.h
</span><span class='line'>config.status: creating include/jemalloc/internal/jemalloc_internal.h
</span><span class='line'>config.status: creating test/test.sh
</span><span class='line'>config.status: creating test/include/test/jemalloc_test.h
</span><span class='line'>config.status: creating config.stamp
</span><span class='line'>config.status: creating bin/jemalloc.sh
</span><span class='line'>config.status: creating include/jemalloc/jemalloc_defs.h
</span><span class='line'>config.status: creating include/jemalloc/internal/jemalloc_internal_defs.h
</span><span class='line'>config.status: creating test/include/test/jemalloc_test_defs.h
</span><span class='line'>config.status: executing include/jemalloc/internal/private_namespace.h commands
</span><span class='line'>config.status: executing include/jemalloc/internal/private_unnamespace.h commands
</span><span class='line'>config.status: executing include/jemalloc/internal/public_symbols.txt commands
</span><span class='line'>config.status: executing include/jemalloc/internal/public_namespace.h commands
</span><span class='line'>config.status: executing include/jemalloc/internal/public_unnamespace.h commands
</span><span class='line'>config.status: executing include/jemalloc/internal/size_classes.h commands
</span><span class='line'>config.status: executing include/jemalloc/jemalloc_protos_jet.h commands
</span><span class='line'>config.status: executing include/jemalloc/jemalloc_rename.h commands
</span><span class='line'>config.status: executing include/jemalloc/jemalloc_mangle.h commands
</span><span class='line'>config.status: executing include/jemalloc/jemalloc_mangle_jet.h commands
</span><span class='line'>config.status: executing include/jemalloc/jemalloc.h commands
</span><span class='line'>===============================================================================
</span><span class='line'>jemalloc version   : 3.6.0-0-g46c0af68bd248b04df75e4f92d5fb804c3d75340
</span><span class='line'>library revision   : 1
</span><span class='line'>
</span><span class='line'>CC                 : gcc
</span><span class='line'>CPPFLAGS           :  -D_GNU_SOURCE -D_REENTRANT
</span><span class='line'>CFLAGS             : -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -fvisibility=hidden
</span><span class='line'>LDFLAGS            : 
</span><span class='line'>EXTRA_LDFLAGS      : 
</span><span class='line'>LIBS               :  -lpthread
</span><span class='line'>RPATH_EXTRA        : 
</span><span class='line'>
</span><span class='line'>XSLTPROC           : /usr/bin/xsltproc
</span><span class='line'>XSLROOT            : 
</span><span class='line'>
</span><span class='line'>PREFIX             : /usr/local
</span><span class='line'>BINDIR             : /usr/local/bin
</span><span class='line'>INCLUDEDIR         : /usr/local/include
</span><span class='line'>LIBDIR             : /usr/local/lib
</span><span class='line'>DATADIR            : /usr/local/share
</span><span class='line'>MANDIR             : /usr/local/share/man
</span><span class='line'>
</span><span class='line'>srcroot            : 
</span><span class='line'>abs_srcroot        : /home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/jemalloc/
</span><span class='line'>objroot            : 
</span><span class='line'>abs_objroot        : /home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/jemalloc/
</span><span class='line'>
</span><span class='line'>JEMALLOC_PREFIX    : je_
</span><span class='line'>JEMALLOC_PRIVATE_NAMESPACE
</span><span class='line'>                   : je_
</span><span class='line'>install_suffix     : 
</span><span class='line'>autogen            : 0
</span><span class='line'>experimental       : 1
</span><span class='line'>cc-silence         : 1
</span><span class='line'>debug              : 0
</span><span class='line'>code-coverage      : 0
</span><span class='line'>stats              : 1
</span><span class='line'>prof               : 0
</span><span class='line'>prof-libunwind     : 0
</span><span class='line'>prof-libgcc        : 0
</span><span class='line'>prof-gcc           : 0
</span><span class='line'>tcache             : 1
</span><span class='line'>fill               : 1
</span><span class='line'>utrace             : 0
</span><span class='line'>valgrind           : 0
</span><span class='line'>xmalloc            : 0
</span><span class='line'>mremap             : 0
</span><span class='line'>munmap             : 0
</span><span class='line'>dss                : 0
</span><span class='line'>lazy_lock          : 0
</span><span class='line'>tls                : 1
</span><span class='line'>===============================================================================
</span><span class='line'>cd jemalloc && make CFLAGS="-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops " LDFLAGS="" lib/libjemalloc.a
</span><span class='line'>make[4]: Entering directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/jemalloc'
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/jemalloc.o src/jemalloc.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/arena.o src/arena.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/atomic.o src/atomic.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/base.o src/base.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/bitmap.o src/bitmap.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/chunk.o src/chunk.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/chunk_dss.o src/chunk_dss.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/chunk_mmap.o src/chunk_mmap.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ckh.o src/ckh.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ctl.o src/ctl.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/extent.o src/extent.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/hash.o src/hash.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/huge.o src/huge.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/mb.o src/mb.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/mutex.o src/mutex.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/prof.o src/prof.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/quarantine.o src/quarantine.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/rtree.o src/rtree.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/stats.o src/stats.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/tcache.o src/tcache.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/util.o src/util.c
</span><span class='line'>gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/tsd.o src/tsd.c
</span><span class='line'>ar crus lib/libjemalloc.a src/jemalloc.o src/arena.o src/atomic.o src/base.o src/bitmap.o src/chunk.o src/chunk_dss.o src/chunk_mmap.o src/ckh.o src/ctl.o src/extent.o src/hash.o src/huge.o src/mb.o src/mutex.o src/prof.o src/quarantine.o src/rtree.o src/stats.o src/tcache.o src/util.o src/tsd.o
</span><span class='line'>make[4]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps/jemalloc'
</span><span class='line'>make[3]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/deps'
</span><span class='line'>    CC adlist.o
</span><span class='line'>    CC ae.o
</span><span class='line'>    CC anet.o
</span><span class='line'>    CC dict.o
</span><span class='line'>anet.c: In function ‘anetSockName’:
</span><span class='line'>anet.c:565: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:563: note: initialized from here
</span><span class='line'>anet.c:569: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:567: note: initialized from here
</span><span class='line'>anet.c: In function ‘anetPeerToString’:
</span><span class='line'>anet.c:543: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:541: note: initialized from here
</span><span class='line'>anet.c:547: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:545: note: initialized from here
</span><span class='line'>anet.c: In function ‘anetTcpAccept’:
</span><span class='line'>anet.c:511: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:509: note: initialized from here
</span><span class='line'>anet.c:515: warning: dereferencing pointer ‘s’ does break strict-aliasing rules
</span><span class='line'>anet.c:513: note: initialized from here
</span><span class='line'>    CC redis.o
</span><span class='line'>    CC sds.o
</span><span class='line'>    CC zmalloc.o
</span><span class='line'>    CC lzf_c.o
</span><span class='line'>    CC lzf_d.o
</span><span class='line'>    CC pqsort.o
</span><span class='line'>    CC zipmap.o
</span><span class='line'>    CC ziplist.o
</span><span class='line'>    CC sha1.o
</span><span class='line'>    CC release.o
</span><span class='line'>    CC networking.o
</span><span class='line'>    CC util.o
</span><span class='line'>    CC object.o
</span><span class='line'>    CC db.o
</span><span class='line'>    CC replication.o
</span><span class='line'>    CC rdb.o
</span><span class='line'>db.c: In function ‘scanGenericCommand’:
</span><span class='line'>db.c:454: warning: ‘pat’ may be used uninitialized in this function
</span><span class='line'>db.c:455: warning: ‘patlen’ may be used uninitialized in this function
</span><span class='line'>    CC t_string.o
</span><span class='line'>    CC t_list.o
</span><span class='line'>    CC t_set.o
</span><span class='line'>    CC t_zset.o
</span><span class='line'>    CC t_hash.o
</span><span class='line'>    CC config.o
</span><span class='line'>    CC aof.o
</span><span class='line'>    CC pubsub.o
</span><span class='line'>    CC multi.o
</span><span class='line'>    CC debug.o
</span><span class='line'>    CC sort.o
</span><span class='line'>    CC intset.o
</span><span class='line'>    CC syncio.o
</span><span class='line'>    CC migrate.o
</span><span class='line'>    CC endianconv.o
</span><span class='line'>    CC slowlog.o
</span><span class='line'>    CC scripting.o
</span><span class='line'>    CC bio.o
</span><span class='line'>    CC rio.o
</span><span class='line'>    CC rand.o
</span><span class='line'>    CC memtest.o
</span><span class='line'>    CC crc64.o
</span><span class='line'>    CC crc32.o
</span><span class='line'>    CC bitops.o
</span><span class='line'>    CC sentinel.o
</span><span class='line'>    CC notify.o
</span><span class='line'>    CC setproctitle.o
</span><span class='line'>    CC hyperloglog.o
</span><span class='line'>    CC latency.o
</span><span class='line'>    CC sparkline.o
</span><span class='line'>    CC slots.o
</span><span class='line'>    CC redis-cli.o
</span><span class='line'>    CC redis-benchmark.o
</span><span class='line'>    CC redis-check-dump.o
</span><span class='line'>    CC redis-check-aof.o
</span><span class='line'>    LINK redis-benchmark
</span><span class='line'>    LINK redis-check-dump
</span><span class='line'>    LINK redis-check-aof
</span><span class='line'>    LINK redis-server
</span><span class='line'>    INSTALL redis-sentinel
</span><span class='line'>    LINK redis-cli
</span><span class='line'>
</span><span class='line'>Hint: It's a good idea to run 'make test' ;)
</span><span class='line'>
</span><span class='line'>make[2]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21/src'
</span><span class='line'>make[1]: Leaving directory `/home/hadoop/codis/src/github.com/CodisLabs/codis/extern/redis-2.8.21'
</span><span class='line'>[hadoop@cu2 codis]$ </span></code></pre></td></tr></table></div></figure>


<p>简单使用：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 codis]$ pwd
</span><span class='line'>/home/hadoop/codis/src/github.com/CodisLabs/codis
</span><span class='line'>[hadoop@cu2 codis]$ ll bin
</span><span class='line'>total 39856
</span><span class='line'>drwxrwxr-x 4 hadoop hadoop     4096 Jul 14 15:49 assets
</span><span class='line'>-rwxrwxr-x 1 hadoop hadoop 17329904 Jul 14 15:49 codis-config
</span><span class='line'>-rwxrwxr-x 1 hadoop hadoop 17151864 Jul 14 15:49 codis-proxy
</span><span class='line'>-rwxrwxr-x 1 hadoop hadoop  6313083 Jul 14 15:49 codis-server
</span><span class='line'>
</span><span class='line'>&lt;&lt;配置
</span><span class='line'>[hadoop@cu2 codis]$ vi config.ini 
</span><span class='line'>zk=cu3:2181
</span><span class='line'>dashboard_addr=cu2:18087
</span><span class='line'>session_max_timeout=0
</span><span class='line'>session_max_bufsize=1310720
</span><span class='line'>session_max_pipeline=10240000
</span><span class='line'>
</span><span class='line'>&lt;&lt;启动dashboard（大部分命令其实都可以通过网页来完成）
</span><span class='line'>[hadoop@cu2 codis]$ nohup bin/codis-config dashboard &gt;log/dashboard.log 2&gt;&1 &
</span><span class='line'>
</span><span class='line'>&lt;&lt;初始化1024 slot
</span><span class='line'>[hadoop@cu2 codis]$ bin/codis-config slot init
</span><span class='line'>{
</span><span class='line'>  "msg": "OK",
</span><span class='line'>  "ret": 0
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>&lt;&lt;启动redis server
</span><span class='line'>[hadoop@cu2 codis]$ bin/codis-server --port 16379 --daemonize yes
</span><span class='line'>
</span><span class='line'>&lt;&lt;在网页上分配好slot，或者：
</span><span class='line'>
</span><span class='line'>$ bin/codis-config slot range-set 0 511 1 online
</span><span class='line'>$ bin/codis-config slot range-set 512 1023 2 online
</span><span class='line'>
</span><span class='line'>&lt;&lt;然后启动proxy
</span><span class='line'>[hadoop@hadoop-master1 codis]$ nohup bin/codis-proxy -c config.ini -L proxy.log  --cpu=64 --addr=0.0.0.0:6372 --http-addr=0.0.0.0:11000 &gt;&gt;proxy.log 2&gt;&1 &
</span><span class='line'>
</span><span class='line'>&lt;&lt;客户端连接proxy
</span><span class='line'>[hadoop@cu2 codis]$ ~/redis/bin/redis-cli -p 19000
</span><span class='line'>&lt;&lt;不支持的命令
</span><span class='line'>127.0.0.1:19000&gt; keys *
</span><span class='line'>Error: Server closed the connection
</span><span class='line'>127.0.0.1:19000&gt; scan 0
</span><span class='line'>Error: Server closed the connection
</span><span class='line'>
</span><span class='line'>127.0.0.1:19000&gt; get a
</span><span class='line'>"b"
</span><span class='line'>
</span><span class='line'>127.0.0.1:19000&gt; select 2
</span><span class='line'>(error) ERR invalid DB index, only accept DB 0
</span><span class='line'>
</span><span class='line'>&lt;&lt;也可以单独连接到redis server，进行操作
</span><span class='line'>[hadoop@cu2 codis]$ ~/redis/bin/redis-cli -p 16378
</span><span class='line'># Keyspace
</span><span class='line'>db0:keys=6,expires=0,avg_ttl=0
</span><span class='line'>127.0.0.1:16378&gt; keys *
</span><span class='line'>1) "7"
</span><span class='line'>2) "1"
</span><span class='line'>3) "2"
</span><span class='line'>4) "4"
</span><span class='line'>5) "5"
</span><span class='line'>6) "a"</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/CodisLabs/codis/blob/master/doc/unsupported_cmds.md">codis不支持的命令</a>，基本上都是全局操作的命令。不影响使用，如果一定要使用，可以通过客户端单独连server执行。</p>

<p>有个疑问，怎么查看proxy写的数据放在那个slot？要学学go才行。</p>

<h2>安装参考</h2>

<ul>
<li><a href="https://lvs071103.gitbooks.io/codis/content/install.html">https://lvs071103.gitbooks.io/codis/content/install.html</a></li>
<li><a href="http://jicki.blog.51cto.com/1323993/1748549">http://jicki.blog.51cto.com/1323993/1748549</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/28/flume-kafka-elasticsearch-for-analyse/">使用 Flume+kafka+elasticsearch 处理数据</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-06-28T09:50:05+08:00" pubdate data-updated="true">Tue 2016-06-28 09:50</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>flume-1.6依赖的kafka、elasticsearch的版本与我这使用程序的版本不一致，部分jar依赖需要替换，flume-elasticsearch-sink源码需要进行一些修改来适配elasticsearch-2.2。</p>

<ul>
<li>flume-1.6.0</li>
<li>kafka_2.11-0.9.0.1(可以与0.8.2客户端通信, flume-kafka-channel-1.6.0不改)</li>
<li>elasticsearch-2.2.0</li>
</ul>


<p>由于版本的差异，需要替换/添加以下jar到 <code>flume/lib</code> 下：</p>

<p>使用 <code>mvn dependecy:copy-dependencies</code> 导出所需依赖的包</p>

<p>jackson一堆，hppc-0.7.1.jar，t-digest-3.0.jar，jsr166e-1.1.0.jar，guava-18.0.jar，lucene一堆，elasticsearch-2.2.0.jar。</p>

<p>远程调试配置：</p>

<p>source由于项目上的一些特殊规则，需要自己编写。通过远程DEBUG来打断点来排查BUG。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 flume]$ vi conf/flume-env.sh
</span><span class='line'>export JAVA_OPTS="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8092"</span></code></pre></td></tr></table></div></figure>


<h2>实战1</h2>

<p>KafkaChannel：考虑到其他功能也需要用到这些数据。</p>

<p>先写一个配置把flume自带功能跑通，这里用 netcat 作为输入运行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 flumebin]$ cat dta.flume 
</span><span class='line'>dta.sources=s1
</span><span class='line'>dta.channels=c1
</span><span class='line'>dta.sinks=k1
</span><span class='line'>
</span><span class='line'>dta.channels.c1.type=org.apache.flume.channel.kafka.KafkaChannel
</span><span class='line'>dta.channels.c1.capacity=10000
</span><span class='line'>dta.channels.c1.transactionCapacity=1000
</span><span class='line'>dta.channels.c1.brokerList=cu5:9093
</span><span class='line'>dta.channels.c1.topic=flume_cmdid_1234
</span><span class='line'>dta.channels.c1.groupId=flume_dta
</span><span class='line'>dta.channels.c1.zookeeperConnect=cu3:2181/kafka_0_9
</span><span class='line'>dta.channels.c1.parseAsFlumeEvent=false
</span><span class='line'>
</span><span class='line'>dta.sources.s1.channels=c1
</span><span class='line'>dta.sources.s1.type=netcat
</span><span class='line'>dta.sources.s1.bind=0.0.0.0
</span><span class='line'>dta.sources.s1.port=6666
</span><span class='line'>dta.sources.s1.max-line-length=88888888
</span><span class='line'>
</span><span class='line'>dta.sinks.k1.channel=c1
</span><span class='line'>dta.sinks.k1.type=elasticsearch
</span><span class='line'>dta.sinks.k1.hostNames=cu2:9300
</span><span class='line'>dta.sinks.k1.indexName=foo_index
</span><span class='line'>dta.sinks.k1.indexType=idcisp
</span><span class='line'>dta.sinks.k1.clusterName=eshore-cu
</span><span class='line'>dta.sinks.k1.batchSize=500
</span><span class='line'>dta.sinks.k1.ttl=5d
</span><span class='line'>dta.sinks.k1.serializer=com.eshore.zhfx.collector.InfoSecurityLogIndexRequestBuilderFactory
</span><span class='line'>dta.sinks.k1.serializer.idcispUrlBase64=true
</span><span class='line'>
</span><span class='line'>[hadoop@cu2 flumebin]$ bin/flume-ng agent --classpath flume-dta-source-2.1.jar  -n dta -c conf -f dta.flume
</span><span class='line'>
</span><span class='line'># 新开一个窗口
</span><span class='line'>[hadoop@cu2 ~]$ nc localhost 6666
</span></code></pre></td></tr></table></div></figure>


<p>kafka的主题、ES的索引可以不要手动建，当然为了更好的控制ES索引创建可以添加一个索引名的template。</p>

<p>InfoSecurityLogIndexRequestBuilderFactory 实现 ElasticSearchIndexRequestBuilderFactory 把原始记录转换成 ES 的JSON对象。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  private Counter allRecordMetric = MetricManager.getInstance().counter("all_infosecurity");
</span><span class='line'>  private Counter errorRecordMetric = MetricManager.getInstance().counter("error_infosecurity");
</span><span class='line'>  
</span><span class='line'>  public IndexRequestBuilder createIndexRequest(Client client, String indexPrefix, String indexType, Event event)
</span><span class='line'>      throws IOException {
</span><span class='line'>    allRecordMetric.inc();
</span><span class='line'>
</span><span class='line'>    String record = new String(event.getBody(), outputCharset);
</span><span class='line'>
</span><span class='line'>    context.put(ElasticSearchSinkConstants.INDEX_NAME, indexPrefix);
</span><span class='line'>    indexNameBuilder.configure(context);
</span><span class='line'>    IndexRequestBuilder indexRequestBuilder = client.prepareIndex(indexNameBuilder.getIndexName(event), indexType);
</span><span class='line'>
</span><span class='line'>    try {
</span><span class='line'>      Gson gson = new Gson();
</span><span class='line'>      IdcIspLog log = parseRecord(record);
</span><span class='line'>      BytesArray data = new BytesArray(gson.toJson(log));
</span><span class='line'>
</span><span class='line'>      indexRequestBuilder.setSource(data);
</span><span class='line'>      indexRequestBuilder.setRouting(log.commandld);
</span><span class='line'>    } catch (Exception e) {
</span><span class='line'>      LOG.error(e.getMessage(), e);
</span><span class='line'>      errorRecordMetric.inc();
</span><span class='line'>
</span><span class='line'>      indexRequestBuilder.setSource(record.getBytes(outputCharset));
</span><span class='line'>      // 保留错误的数据
</span><span class='line'>      indexRequestBuilder.setRouting("error");
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return indexRequestBuilder;
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<h2>实战2</h2>

<p>测试自定义的Source：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dta.sources=s1
</span><span class='line'>dta.channels=c1
</span><span class='line'>dta.sinks=k1
</span><span class='line'>
</span><span class='line'>dta.channels.c1.type=memory
</span><span class='line'>dta.channels.c1.capacity=1000000
</span><span class='line'>dta.channels.c1.transactionCapacity=1000000
</span><span class='line'>dta.channels.c1.byteCapacity=7000000000
</span><span class='line'>
</span><span class='line'>dta.sources.s1.channels=c1
</span><span class='line'>dta.sources.s1.type=com.eshore.zhfx.collector.CollectSource
</span><span class='line'>dta.sources.s1.spoolDir=/home/hadoop/flume/data/
</span><span class='line'>dta.sources.s1.trackerDir=/tmp/dtaspool
</span><span class='line'>
</span><span class='line'>dta.sinks.k1.channel=c1
</span><span class='line'>dta.sinks.k1.type=logger</span></code></pre></td></tr></table></div></figure>


<p>CollectSource 实现PollableSource 继承AbstractSource类。参考Flume开发文档: <a href="http://flume.apache.org/FlumeDeveloperGuide.html#source">http://flume.apache.org/FlumeDeveloperGuide.html#source</a>  <code>org.apache.flume.source.SequenceGeneratorSource</code> 类。</p>

<p>方法process主逻辑代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  public Status process() throws EventDeliveryException {
</span><span class='line'>    Status status = Status.READY;
</span><span class='line'>
</span><span class='line'>    try {
</span><span class='line'>      List&lt;Event&gt; events = readEvent(batchSize);
</span><span class='line'>      if (!events.isEmpty()) {
</span><span class='line'>        sourceCounter.addToEventReceivedCount(events.size());
</span><span class='line'>        sourceCounter.incrementAppendBatchReceivedCount();
</span><span class='line'>
</span><span class='line'>        getChannelProcessor().processEventBatch(events);
</span><span class='line'>        // 记录文件已经处理的位置
</span><span class='line'>        commit();
</span><span class='line'>
</span><span class='line'>        sourceCounter.addToEventAcceptedCount(events.size());
</span><span class='line'>        sourceCounter.incrementAppendBatchAcceptedCount();
</span><span class='line'>      }
</span><span class='line'>    } catch (ChannelException | IOException e) {
</span><span class='line'>      status = Status.BACKOFF;
</span><span class='line'>      Throwables.propagate(e);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return status;
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<h2>实例：Flume+Kafka+ES</h2>

<p>把两个实例整合起来，把实例1的Source替换下即可。</p>

<h2>附-kafka基本操作</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ bin/kafka-server-start.sh config/server1.properties 
</span><span class='line'>
</span><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ cat config/server1.properties 
</span><span class='line'>listeners=PLAINTEXT://:9093
</span><span class='line'>log.dirs=/tmp/kafka-logs1
</span><span class='line'>num.partitions=1
</span><span class='line'>zookeeper.connect=cu3,cu4,cu5/kafka_0_9
</span><span class='line'>
</span><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ bin/kafka-topics.sh --create --zookeeper cu3:2181/kafka_0_9 --replication 1 --partitions 1 --topic flume
</span><span class='line'>Created topic "flume".
</span><span class='line'>
</span><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ bin/kafka-topics.sh --list --zookeeper cu3:2181/kafka_0_9
</span><span class='line'>flume
</span><span class='line'>
</span><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ bin/kafka-console-producer.sh --broker-list cu5:9093 --topic flume
</span><span class='line'>
</span><span class='line'>[hadoop@cu5 kafka_2.11-0.9.0.1]$ bin/kafka-console-consumer.sh --zookeeper cu3:2181/kafka_0_9 --topic flume --from-beginning
</span><span class='line'>
</span><span class='line'>##添加kafka-manager：
</span><span class='line'>
</span><span class='line'>启动kafka添加JMX
</span><span class='line'>export JMX_PORT=19999
</span><span class='line'>nohup bin/kafka-server-start.sh config/server.properties &
</span><span class='line'>
</span><span class='line'># https://github.com/yahoo/kafka-manager/tree/1.3.1.8
</span><span class='line'>nohup bin/kafka-manager -Dhttp.port=9090 &
</span></code></pre></td></tr></table></div></figure>


<h2>附-Flume操作</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://flume.apache.org/FlumeUserGuide.html#fan-out-flow
</span><span class='line'>
</span><span class='line'>#conf/flume-env.sh
</span><span class='line'>export FLUME_JAVA_OPTS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=8092"
</span><span class='line'>bin/flume-ng agent --classpath "flume-dta-libs/*" -Dflume.root.logger=DEBUG,console  -n dta -c conf -f accesslog.flume
</span><span class='line'>
</span><span class='line'># with ganglia
</span><span class='line'>[ud@cu-ud1 apache-flume-1.6.0-bin]$ bin/flume-ng agent --classpath "/home/ud/collector/common-lib/*"  -Dflume.root.logger=Debug,console -Dflume.monitoring.type=ganglia -Dflume.monitoring.hosts=239.2.11.71:8649 -n dta -c conf -f accesslog.flume 
</span><span class='line'>
</span><span class='line'># windows
</span><span class='line'>bin\flume-ng.cmd agent -n agent -c conf -f helloworld.flume -property "flume.root.logger=INFO,console"</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/16">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/14">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>
  <h1><a class='category' href='/blog/categories/recommend/'>Recommend</a></h1>
	<ul role="list">
		
			<li class="post">
				<a href="/blog/2018/01/20/gitalk-on-octopress/">Gitalk on Octopress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/11/16/sphinx-generate-docs/">使用Sphinx生成/管理文档</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/08/10/java-bytecode-security/">保护/加密JAVA代码</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/30/kubeadm-install-kubenetes-on-centos7/">Kubeadm部署kubernetes</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/08/casperjs-crawler/">爬虫之CasperJS</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/05/23/spark-on-hive-speculation-shit-bug/">Hive on Spark预测性执行BUG一枚</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/23/hadoop-guide-catalog/">[整理] Hadoop入门</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/03/28/hive-on-spark/">Hive on Spark</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/01/23/install-and-config-ganglia-on-redhat-2/">安装配置Ganglia(2)</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/08/24/manual-install-supervisor/">Supervisor安装配置</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/10/16/spark-build-and-configuration/">编译/搭建Spark环境</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/08/25/step-by-step-found-java-oom-error/">查找逐步定位Java程序OOM的异常实践</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/30/hadoop2-snappy-compress/">Hadoop2 Snappy Compress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/27/start-redis/">[读读书]Redis入门指南</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/04/21/hadoop2-windows-startguide/">Windows下部署/配置/调试hadoop2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/30/git-cheatsheet/">GIT操作记录手册</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/18/jekyll-edit-link-in-web-page/">Jekyll页面添加编辑按钮</a>
			</li>
		
			<li class="post">
				<a href="/blog/2013/09/19/let-shell-command-efficient/">让敲Shell命令高效起来</a>
			</li>
		
	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/04/10/try-bk-dot-tencent-dot-com/">Try bk.tencent.com</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/20/jcef-build-on-win64/">编译JCEF - Win64</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/08/25/video-auto-translate/">视频自动翻译</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/20/k2-reburn/">斐讯K2刷机记录</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/19/install-macosx-on-vmware/">使用VMWare安装Mac OS X</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/10/java-source-annotation-processor/">使用注解生成代码</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/09/reasonable-way-to-access-the-internet/">科学上网（续）</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/alluxio/'>alluxio</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/android/'>android</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/bigdata/'>bigdata</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blabla/'>blabla</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/debug/'>debug</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/deprecated/'>deprecated</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/devops/'>devops</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/es/'>es</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/flume/'>flume</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/git/'>git</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (44) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hbase/'>hbase</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hole/'>hole</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jenkins/'>jenkins</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (9) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kafka/'>kafka</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kubeadm/'>kubeadm</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/logstash/'>logstash</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/map/'>map</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/recommend/'>recommend</a> (18) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/shell/'>shell</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/staf/'>staf</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tachyon/'>tachyon</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tez/'>tez</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tools/'>tools</a> (66) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/topics/'>topics</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/vagrant/'>vagrant</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/zookeeper/'>zookeeper</a> (1) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (213)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253461959'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1253461959%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winseliu.com" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>









</body>
</html>
