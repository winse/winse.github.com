<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Winse Blog]]></title>
  <link href="http://winseliu.com/atom.xml" rel="self"/>
  <link href="http://winseliu.com/"/>
  <updated>2018-01-30T22:43:51+08:00</updated>
  <id>http://winseliu.com/</id>
  <author>
    <name><![CDATA[Winse Liu]]></name>
    <email><![CDATA[winseliu@foxmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Map入门指南]]></title>
    <link href="http://winseliu.com/blog/2018/01/30/map-started-guide/"/>
    <updated>2018-01-30T13:37:51+08:00</updated>
    <id>http://winseliu.com/blog/2018/01/30/map-started-guide</id>
    <content type="html"><![CDATA[<p>最近了解了一些Map地图相关的知识点，把学习的资料罗列一下：</p>

<h2>坐标体系</h2>

<ul>
<li><a href="http://lbsyun.baidu.com/index.php?title=coordinate">坐标系</a></li>
<li><a href="http://outdoor.farig.net/help/livemapset.php">http://outdoor.farig.net/help/livemapset.php</a></li>
</ul>


<p>说明：</p>

<ul>
<li>WGS84：为一种大地坐标系，也是目前广泛使用的GPS全球卫星定位系统使用的坐标系。标准的Web墨卡托投影坐标系。</li>
<li>GCJ02：又称火星坐标系，是由中国国家测绘局制定的地理坐标系统，是由WGS84加密后得到的坐标系。指中国国家测绘局制订的加偏Web墨卡托投影，正式名称为GCJ-02，国内可用的地图多数属于这种坐标系。</li>
<li>BD09：为百度坐标系，在GCJ02坐标系基础上再次加密。其中bd09ll表示百度经纬度坐标，bd09mc表示百度墨卡托米制坐标。</li>
</ul>


<h4>地图API</h4>

<p>百度</p>

<ul>
<li><a href="http://api.map.baidu.com/lbsapi/getpoint/index.html">拾取坐标系统</a></li>
<li><a href="http://developer.51cto.com/art/201110/298662.htm">百度地图API开发指南</a></li>
<li><a href="http://developer.baidu.com/map/jsdemo.htm#i8_1">浏览器定位</a></li>
<li><a href="http://lbsyun.baidu.com/cms/jsapi/reference/jsapi_reference.html#a6b0">API v2.0 TileLayer</a></li>
<li><a href="http://lbsyun.baidu.com/cms/jsapi/reference/jsapi_reference.html#a0b0">API v2.0 Map</a></li>
</ul>


<p>腾讯</p>

<ul>
<li><a href="http://lbs.qq.com/tool/getpoint/index.html">坐标拾取器</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/guide-start.html">http://lbs.qq.com/javascript_v2/guide-start.html</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/demo.html">http://lbs.qq.com/javascript_v2/demo.html</a></li>
<li><a href="http://lbs.qq.com/webservice_v1/guide-gcoder.html">API 逆地址解析(坐标位置描述)</a></li>
<li><a href="http://lbs.qq.com/static_v2/guide-getImage.html">http://lbs.qq.com/static_v2/guide-getImage.html</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-geocoding-reverse">地址反查（坐标查位置）：逆地址解析</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-event-latlng">鼠标移动显示地图坐标信息</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-event-center">拖动地图显示地图中心坐标信息</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-search-circlebounds">周边（圆形区域）检索</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/sample/sample-search-circlebounds.html">http://lbs.qq.com/javascript_v2/sample/sample-search-circlebounds.html</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/doc/maptype.html">http://lbs.qq.com/javascript_v2/doc/maptype.html</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/doc/projection.html">http://lbs.qq.com/javascript_v2/doc/projection.html</a></li>
</ul>


<p>高德</p>

<ul>
<li><a href="http://lbs.amap.com/console/show/picker">坐标获取</a></li>
<li><a href="http://lbs.amap.com/api">http://lbs.amap.com/api</a></li>
<li><a href="https://lbs.amap.com/api/javascript-api/example/geocoder/regeocoding?demo">逆向地理编码（坐标-地址）</a></li>
</ul>


<p>国内其他</p>

<ul>
<li><a href="http://lbs.tianditu.com/server/search.html">http://lbs.tianditu.com/server/search.html</a></li>
</ul>


<p>Google</p>

<ul>
<li><a href="https://www.google.com/maps">获取地理位置的经纬度</a>直接搜就行了</li>
<li><a href="https://support.google.com/maps/answer/18539?co=GENIE.Platform%3DDesktop&amp;hl=zh-Hans">https://support.google.com/maps/answer/18539?co=GENIE.Platform%3DDesktop&amp;hl=zh-Hans</a></li>
<li><a href="https://developers.google.cn/maps/documentation/geocoding/intro?hl=zh-cn#GeocodingResponses">地理编码转换</a></li>
</ul>


<p>NOTE: Google的在Java里面用需要指定证书和代理：</p>

<ul>
<li><a href="https://stackoverflow.com/questions/120797/how-do-i-set-the-proxy-to-be-used-by-the-jvm">https://stackoverflow.com/questions/120797/how-do-i-set-the-proxy-to-be-used-by-the-jvm</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html">https://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html</a></li>
</ul>


<p>网页访问一次，把geo的CA证书保存到本地，然后导入到本地的证书库，加入到应用得启动参数里面：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>keytool -import -rfc -v -alias geo_ca -keystore truststore -file geo.cer
</span><span class='line'>
</span><span class='line'>java -Djava.net.useSystemProxies=true -Djavax.net.ssl.trustStore=.\security\truststore </span></code></pre></td></tr></table></div></figure>


<h4>各坐标系间的转换</h4>

<p>Example:</p>

<ul>
<li><a href="http://developer.baidu.com/map/jsdemo.htm#a5_1">google坐标转成百度坐标</a></li>
<li><a href="http://developer.baidu.com/map/jsdemo.htm#a5_2">原始坐标转成百度坐标</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-convertor-library">转换百度坐标为腾讯坐标</a></li>
</ul>


<p>坐标转换代码：</p>

<ul>
<li><a href="https://github.com/wandergis/coordtransform">https://github.com/wandergis/coordtransform</a></li>
</ul>


<h4>比例尺</h4>

<p>百度</p>

<ul>
<li><a href="http://lbsyun.baidu.com/index.php?title=jspopular/guide/widget">http://lbsyun.baidu.com/index.php?title=jspopular/guide/widget</a></li>
<li><a href="http://developer.baidu.com/map/jsdemo.htm#f0_4">http://developer.baidu.com/map/jsdemo.htm#f0_4</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>map.addControl(new BMap.ScaleControl());
</span><span class='line'>map.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
</span><span class='line'>map.enableContinuousZoom();    //启用地图惯性拖拽，默认禁用</span></code></pre></td></tr></table></div></figure>


<p>左下角标注的尺寸包括一个数字加一条线段，就是地图上与<strong>那条线等长的距离</strong>的实际距离为数字表示的长度。假设长度为一厘米，那就是说那一厘米在地图上同等长度实际是20m的距离，比例为1:2000。</p>

<p>在百度地图API中，平面坐标是以最大级别18级为基准的。就是说在<strong>18级平面坐标的一个单位就代表了屏幕上的1个像素</strong> （详细的内容后面讲，可以参考<a href="https://my.oschina.net/bv10000/blog/644520">百度地图API详解之地图坐标系统</a>）。</p>

<p>Android里面计算百度比例尺的方式：取两个点获取它们的经纬度，然后算两个点之间的距离。</p>

<ul>
<li><a href="http://blog.csdn.net/mnorst/article/details/12975413">百度地图和谷歌地图的比例尺和分辨率</a></li>
<li><a href="http://blog.csdn.net/mad1989/article/details/9361983">百度、google、高德 地图比例尺功能实现</a></li>
</ul>


<p>NOTE: 百度地图SDK还提供了标注工具(PushpinTool)，测距工具(DistanceTool)。</p>

<p>Google</p>

<ul>
<li>通过手动算出各级的比例尺 <a href="http://www.360doc.com/content/15/0319/13/9009195_456410364.shtml">http://www.360doc.com/content/15/0319/13/9009195_456410364.shtml</a></li>
</ul>


<p>Bing</p>

<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/aa940990.aspx">https://msdn.microsoft.com/en-us/library/aa940990.aspx</a></li>
<li><a href="https://blogs.bing.com/maps/2006/02/25/map-control-zoom-levels-gt-resolution">https://blogs.bing.com/maps/2006/02/25/map-control-zoom-levels-gt-resolution</a></li>
</ul>


<h2>深入了解地图 - 瓦片</h2>

<ul>
<li><a href="https://my.oschina.net/bv10000/blog/644520">百度地图API详解之地图坐标系统</a> <a href="http://www.jiazhengblog.com/blog/2011/07/02/289/">##</a></li>
<li><a href="https://segmentfault.com/a/1190000011276788">瓦片地图原理</a></li>
<li><a href="https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames">Mercator projection</a></li>
<li><a href="http://cntchen.github.io/2016/05/09/%E5%9B%BD%E5%86%85%E4%B8%BB%E8%A6%81%E5%9C%B0%E5%9B%BE%E7%93%A6%E7%89%87%E5%9D%90%E6%A0%87%E7%B3%BB%E5%AE%9A%E4%B9%89%E5%8F%8A%E8%AE%A1%E7%AE%97%E5%8E%9F%E7%90%86/">国内主要地图瓦片坐标系定义及计算原理</a></li>
<li><a href="http://blog.csdn.net/evkj2013/article/details/12855889">OpenStreetMap/Google/百度/Bing瓦片地图服务(TMS) </a></li>
<li><a href="http://blog.csdn.net/mygisforum/article/details/7582449">Google 地图切片URL地址解析 </a></li>
<li><a href="http://blog.csdn.net/mygisforum/article/details/8162751">Tiles à la Google Maps: Coordinates, Tile Bounds and Projection</a></li>
<li><a href="http://blog.csdn.net/mygisforum/article/details/22997879">腾讯与百度地图瓦片规则分析</a></li>
<li><a href="http://cntchen.github.io/2016/05/09/%E7%99%BE%E5%BA%A6JavaScirpt%20%20API%E4%B8%AD%E7%BB%8F%E7%BA%AC%E5%BA%A6%E5%9D%90%E6%A0%87%E8%BD%AC%E7%93%A6%E7%89%87%E5%9D%90%E6%A0%87bug/">百度JavaScript API中经纬度坐标转瓦片坐标bug</a></li>
<li><a href="http://blog.csdn.net/fredricen/article/details/77189453">2017版高德地图瓦片分析</a></li>
</ul>


<p>各种tile的地址路径</p>

<ul>
<li><a href="https://github.com/CntChen/tile-lnglat-transform">https://github.com/CntChen/tile-lnglat-transform</a></li>
<li>各种tile的地址路径 <a href="https://github.com/brandonxiang/MapViewer/blob/master/app.js">https://github.com/brandonxiang/MapViewer/blob/master/app.js</a></li>
<li><a href="https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames#Java">https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames#Java</a></li>
</ul>


<p><a href="http://apis.map.qq.com/jsapi?qt=translate&amp;type=3&amp;points=113.338191,23.138992&amp;output=jsonp&amp;pf=jsapi&amp;ref=jsapi&amp;cb=qq.maps._svcb3.cbjcznrony1">腾讯&#8221;矢量&#8221;地图 - 通过JSON传数据画Canvas</a></p>

<h2>国内百度腾讯网页端的实现</h2>

<p>现在的地图基本都是使用瓦片技术，计算步骤如下:</p>

<ul>
<li>首先，根据投影（墨卡托投影）把 经纬度（度） 转成 平面坐标（m）；</li>
<li>然后，更具比例尺把 平面坐标 转成 像素坐标；</li>
<li>最后，根据坐标的平移把窗口内的瓦片从服务端下载并进行展示。</li>
</ul>


<p>通过JS代码了解地图的实现：</p>

<h4>百度</h4>

<p>打开一个百度的应用 <a href="http://api.map.baidu.com/lbsapi/getpoint/index.html">http://api.map.baidu.com/lbsapi/getpoint/index.html</a> 然后在调试窗口运行转换经纬度的代码，然后进到对应的代码，打断点，然后艰辛进行与混淆的代码死磕！</p>

<p><img src="http://winseliu.com/images/blogs/baidu-map-debug.png" alt="" /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var projection =new BMap.MercatorProjection();
</span><span class='line'>var point = projection.lngLatToPoint(new BMap.Point(113.338191,23.138992));
</span><span class='line'>point
</span><span class='line'>Q {x: 12616886.99, y: 2631894}
</span><span class='line'>
</span><span class='line'>var projection =new BMap.MercatorProjection();
</span><span class='line'>var point = projection.pointToLngLat(new BMap.Pixel(12616886.99,2631894));
</span><span class='line'>point
</span><span class='line'>H {lng: 113.338191, lat: 23.138992}
</span></code></pre></td></tr></table></div></figure>


<p>从代码上看还是不难的，但是里面有一堆魔法数字完全不懂。</p>

<p>如果仅仅获取瓦片 <a href="https://github.com/CntChen/tile-lnglat-transform/">https://github.com/CntChen/tile-lnglat-transform/</a> 推荐使用这个项目。</p>

<p>这里仅仅是经纬度转换为平面坐标(m)的过程。我们在源码中查找 getTilesUrl 在5901行打个断点，然后在回到网页，移动一下地图。接下来，就可以调试整个过程了。</p>

<p><img src="http://winseliu.com/images/blogs/baidu-map-getTilesUrl.png" alt="" /></p>

<p>注意标识的两处，是进行层级缩放、计算出瓦片编号的代码。</p>

<h4>腾讯</h4>

<p>看过了百度的，再看腾讯的。然鹅并没有觉得轻松啊，两种不同的坐标系，做法差别还是挺大的。不过从命名上看腾讯算学术派的了。</p>

<ul>
<li>Projection 对象规范 <a href="http://lbs.qq.com/javascript_v2/doc/projection.html">http://lbs.qq.com/javascript_v2/doc/projection.html</a></li>
<li><a href="http://lbs.qq.com/javascript_v2/doc/maptype.html">http://lbs.qq.com/javascript_v2/doc/maptype.html</a></li>
</ul>


<p>打开 <a href="http://lbs.qq.com/javascript_v2/case-run.html#sample-geocoding-reverse">http://lbs.qq.com/javascript_v2/case-run.html#sample-geocoding-reverse</a> ，在 map.qq.com/js/v2.js 的 apiLoad 处打断点进行到真正的map的js文件。</p>

<p><img src="http://winseliu.com/images/blogs/tencent-debug-apiLoad.png" alt="" /></p>

<p>然后查找 fromLatLngToPoint ，再在界面动一下，就可以调试整个过程：</p>

<p><img src="http://winseliu.com/images/blogs/tencent-debug-fromLatLngToPoint.png" alt="" /></p>

<ul>
<li>fromLatLngToPoint</li>
<li>fromPointToLatLng</li>
</ul>


<p>调式的时刻可以顺便看看整个调用链，会发现：</p>

<p><img src="http://winseliu.com/images/blogs/tencent-debug-fromDivPixelToLatLng.png" alt="" /></p>

<ul>
<li>fromDivPixelToLatLng</li>
<li>fromLatLngToDivPixel</li>
</ul>


<p>fromDivPixelToLatLng的条用链，以及数据的传递如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fromDivPixelToLatLng 
</span><span class='line'>=&gt;
</span><span class='line'>
</span><span class='line'>-&gt;Rh 转成相对位置转成绝对坐标后，传入到Mc
</span><span class='line'>[
</span><span class='line'>a
</span><span class='line'>P {x: 930, y: -471}
</span><span class='line'>c
</span><span class='line'>ia {width: 1725872.4160540444, height: 794188.9248479041}
</span><span class='line'>b
</span><span class='line'>true
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>-&gt;Mc(g, a, h, f)  &lt;-&gt;  Gf 缩放后，调用fromPointToLatLng
</span><span class='line'>[
</span><span class='line'>g
</span><span class='line'>Sh {a: P, b: 0.7111111111111111, c: 40.74366543152521, d: true}
</span><span class='line'>a
</span><span class='line'>P {x: 1726802, y: 793718}
</span><span class='line'>h
</span><span class='line'>13
</span><span class='line'>f
</span><span class='line'>true
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>-&gt;fromPointToLatLng(Ad, e)
</span><span class='line'>[
</span><span class='line'>Ad
</span><span class='line'>P {x: 210.791259765625, y: 96.889404296875}
</span><span class='line'>e
</span><span class='line'>true
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>-&gt; Return value : u
</span><span class='line'>    lat:40.02892889530204
</span><span class='line'>    lng:116.42520904541016
</span></code></pre></td></tr></table></div></figure>


<p>从 坐标计算 经纬度 反过来了：</p>

<p><img src="http://winseliu.com/images/blogs/tencent-debug-fromPointToLatLng.png" alt="" /></p>

<p>腾讯的计算过程直接把 <strong>转平面坐标和转像素坐标</strong> 两个过程合并了。<strong>通过 fromLatLngToPoint 得到就是一个 像素坐标 的值</strong>，然后通过缩放就可以得到<strong>当前层级级别</strong>的 <strong>像素坐标</strong> 。</p>

<p>查找瓦片地址的代码，直接在代码里面查找 <code>x=</code> 在37823处代码都打断点，刷新重新加载瓦片就会进到断点。</p>

<p>然后查看调用链，</p>

<p><img src="http://winseliu.com/images/blogs/tencent-debug-tile.png" alt="" /></p>

<p>详细跟踪的话，会发现，每次加载都会计算左上角和右下角两个点的像素坐标 （窗口的bounds）。计算要加载的瓦片时，直接用最大减最小除以256（每个瓦片的像素），就得到要加载瓦片的编号了。</p>

<p>用了几天比较肤浅的跟了下QQ地图的功能，如果没有混淆应该看起来会爽很多。。。没有很深层次的东西，仅仅是一个源码调试过程的记载，一些理论原理的知识请查完文章中的链接。</p>

<h2>其他</h2>

<ul>
<li><a href="http://www.gpsspg.com/bs/sql.htm">http://www.gpsspg.com/bs/sql.htm</a> 基站数据</li>
<li><a href="http://greatmaps.codeplex.com/">http://greatmaps.codeplex.com/</a></li>
<li><a href="https://my.oschina.net/zhajiang/blog/424157">Leaflet调用腾讯地图</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Java中使用代理-基于Shandowsocks]]></title>
    <link href="http://winseliu.com/blog/2018/01/26/proxy-on-java-via-shandowsocks/"/>
    <updated>2018-01-26T20:50:05+08:00</updated>
    <id>http://winseliu.com/blog/2018/01/26/proxy-on-java-via-shandowsocks</id>
    <content type="html"><![CDATA[<p>在开发过程中，时不时需要要代理一下，来访问我们需要的资源，比方说：DEBUG生产<strong>集群</strong>的应用、还有在Java中翻墙等等。解决了全局的代理能完成我们访问到资源的时刻，又有新的要求，比方说：只有特定的资源走代理等等。</p>

<p>下面把要点简单罗列下，以供参考：</p>

<ul>
<li><a href="https://stackoverflow.com/questions/1432961/how-do-i-make-httpurlconnection-use-a-proxy">https://stackoverflow.com/questions/1432961/how-do-i-make-httpurlconnection-use-a-proxy</a></li>
<li><a href="http://www.aneasystone.com/archives/2015/12/java-and-http-using-proxy.html">http://www.aneasystone.com/archives/2015/12/java-and-http-using-proxy.html</a></li>
<li><a href="https://stackoverflow.com/questions/120797/how-do-i-set-the-proxy-to-be-used-by-the-jvm">https://stackoverflow.com/questions/120797/how-do-i-set-the-proxy-to-be-used-by-the-jvm</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html">https://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html</a></li>
</ul>


<p>JDK官网的都全部包括了，其他的辅助，看看人家的具体需求。</p>

<h2>Java全应用代理（全局）</h2>

<ul>
<li>走HTTP</li>
</ul>


<p>Shandowsocks转HTTP，前面Docker翻墙安装Kubernate有弄过，参考：<a href="http://winseliu.com/blog/2017/02/04/privoxy-http-proxy-for-shadowsocks/">Privoxy</a> 。</p>

<p>也可以直接用Shandowsocks提供的 <code>启用系统代理 -&gt; 系统代理模式 -&gt; 全局模式</code> 来转换，启用HTTP代理功能。（开全局模式，本地会把socks代理转成为一个http的代理）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-Dhttp.proxyHost=127.0.0.1
</span><span class='line'>-Dhttp.proxyPort=7070
</span><span class='line'>-Dhttps.proxyHost=127.0.0.1
</span><span class='line'>-Dhttps.proxyPort=7070
</span><span class='line'>-Dhttp.nonProxyHosts="localhost|127.0.0.1|192.168.*"</span></code></pre></td></tr></table></div></figure>


<blockquote><ul>
<li>http.proxyHost: the host name of the proxy server</li>
<li>http.proxyPort: the port number, the default value being 80.</li>
<li>http.nonProxyHosts:a list of hosts that should be reached directly, bypassing the proxy. This is a list of patterns separated by &lsquo;|&rsquo;. The patterns may start or end with a &lsquo;*&rsquo; for wildcards. Any host matching one of these patterns will be reached through a direct connection instead of through a proxy.</li>
</ul>
</blockquote>

<ul>
<li>走Socks</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-DsocksProxyHost=127.0.0.1 -DsocksProxyPort=7070</span></code></pre></td></tr></table></div></figure>


<ul>
<li>使用系统代理</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-Djava.net.useSystemProxies=true</span></code></pre></td></tr></table></div></figure>


<h2>部分（自动切换）</h2>

<ul>
<li>应用内通过 setProperty <strong>临时</strong> 设置</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>System.setProperty("http.proxyHost", proxyHost);
</span><span class='line'>System.setProperty("http.proxyPort", proxyPort);
</span><span class='line'>System.setProperty("https.proxyHost", proxyHost);
</span><span class='line'>System.setProperty("https.proxyPort", proxyPort);</span></code></pre></td></tr></table></div></figure>


<p>用完之后，取消设置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>System.clearProperty("http.proxyHost");
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<ul>
<li>请求时指定代理：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SocketAddress addr = new InetSocketAddress("webcache.example.com", 8080);
</span><span class='line'>Proxy proxy = new Proxy(Proxy.Type.HTTP, addr);
</span><span class='line'>
</span><span class='line'>URL url = new URL("http://java.example.org/");
</span><span class='line'>URLConnection conn = url.openConnection(proxy);</span></code></pre></td></tr></table></div></figure>


<ul>
<li>（选择性的）配置哪些访问走代理：ProxySelector</li>
</ul>


<p>任何请求访问网络之前，会被ProxySelector拦截。根据规则获取一个符合的Proxy（或者Proxy.NO_PROXY），然后通过这个代理去访问网络。</p>

<blockquote><p>As you can see, with Java SE 5.0, the developer gains quite a bit of control and flexibility when it comes to proxies. Still, there are situations where one would like to decide which proxy to use dynamically, for instance to do some load balancing between proxies, or depending on the destination, in which case the API described so far would be quite cumbersome. That&rsquo;s where the ProxySelector comes into play.</p>

<p>The best thing about the ProxySelector is that it is plugable! Which means that if you have needs that are not covered by the default one, you can write a replacement for it and plug it in!</p></blockquote>

<p>基本上看JDK官网的内容就好了，也参考下 <a href="http://archive.oreilly.com/pub/a/onjava/excerpt/jvntwkprg_3e/index.html?page=3#javanp3-CHP-7-SECT-4">URLs and URIs, Proxies and Passwords</a></p>

<p>注册自定义的Selector：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public static void main(String[] args) {
</span><span class='line'>    MyProxySelector ps = new MyProxySelector(ProxySelector.getDefault());
</span><span class='line'>    ProxySelector.setDefault(ps);
</span><span class='line'>    // rest of the application
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Selector实现：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class MyProxySelector extends ProxySelector {
</span><span class='line'>    // Keep a reference on the previous default
</span><span class='line'>    ProxySelector defsel = null;
</span><span class='line'>    
</span><span class='line'>    /*
</span><span class='line'>     * Inner class representing a Proxy and a few extra data
</span><span class='line'>     */
</span><span class='line'>    class InnerProxy {
</span><span class='line'>        Proxy proxy;
</span><span class='line'>        SocketAddress addr;
</span><span class='line'>        // How many times did we fail to reach this proxy?
</span><span class='line'>        int failedCount = 0;
</span><span class='line'>        
</span><span class='line'>        InnerProxy(InetSocketAddress a) {
</span><span class='line'>            this(a, Proxy.Type.HTTP);
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>        InnerProxy(InetSocketAddress a, Proxy.Type type) {
</span><span class='line'>            addr = a;
</span><span class='line'>            proxy = new Proxy(type, a);
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>        SocketAddress address() {
</span><span class='line'>            return addr;
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>        Proxy toProxy() {
</span><span class='line'>            return proxy;
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>        int failed() {
</span><span class='line'>            return ++failedCount;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    /*
</span><span class='line'>     * A list of proxies, indexed by their address.
</span><span class='line'>     */
</span><span class='line'>    HashMap&lt;SocketAddress, InnerProxy&gt; proxies = new HashMap&lt;SocketAddress, InnerProxy&gt;();
</span><span class='line'>
</span><span class='line'>    MyProxySelector(ProxySelector def) {
</span><span class='line'>        // Save the previous default
</span><span class='line'>        defsel = def;
</span><span class='line'>        
</span><span class='line'>        // Populate the HashMap (List of proxies)
</span><span class='line'>        InnerProxy i = new InnerProxy(new InetSocketAddress("webcache1.example.com", 8080));
</span><span class='line'>        proxies.put(i.address(), i);
</span><span class='line'>        i = new InnerProxy(new InetSocketAddress("webcache2.example.com", 8080));
</span><span class='line'>        proxies.put(i.address(), i);
</span><span class='line'>        i = new InnerProxy(new InetSocketAddress("webcache3.example.com", 8080));
</span><span class='line'>        proxies.put(i.address(), i);
</span><span class='line'>    }
</span><span class='line'>        
</span><span class='line'>    /*
</span><span class='line'>     * This is the method that the handlers will call.
</span><span class='line'>     * Returns a List of proxy.
</span><span class='line'>     */
</span><span class='line'>    public java.util.List&lt;Proxy&gt; select(URI uri) {
</span><span class='line'>        // Let's stick to the specs. 
</span><span class='line'>        if (uri == null) {
</span><span class='line'>            throw new IllegalArgumentException("URI can't be null.");
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>        /* 这里可以指定你自己的规则/配置
</span><span class='line'>         * If it's a http (or https) URL, then we use our own list.
</span><span class='line'>         */
</span><span class='line'>        String protocol = uri.getScheme();
</span><span class='line'>        if ("http".equalsIgnoreCase(protocol) ||
</span><span class='line'>                "https".equalsIgnoreCase(protocol)) {
</span><span class='line'>            ArrayList&lt;Proxy&gt; l = new ArrayList&lt;Proxy&gt;();
</span><span class='line'>            for (InnerProxy p : proxies.values()) {
</span><span class='line'>                l.add(p.toProxy());
</span><span class='line'>            }
</span><span class='line'>            return l;
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>        /*
</span><span class='line'>         * Not HTTP or HTTPS (could be SOCKS or FTP)
</span><span class='line'>         * defer to the default selector.
</span><span class='line'>         */
</span><span class='line'>        if (defsel != null) {
</span><span class='line'>            return defsel.select(uri);
</span><span class='line'>        } else {
</span><span class='line'>            ArrayList&lt;Proxy&gt; l = new ArrayList&lt;Proxy&gt;();
</span><span class='line'>            l.add(Proxy.NO_PROXY);
</span><span class='line'>            return l;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    /*
</span><span class='line'>     * Method called by the handlers when it failed to connect
</span><span class='line'>     * to one of the proxies returned by select().
</span><span class='line'>     */
</span><span class='line'>    public void connectFailed(URI uri, SocketAddress sa, IOException ioe) {
</span><span class='line'>        // Let's stick to the specs again.
</span><span class='line'>        if (uri == null || sa == null || ioe == null) {
</span><span class='line'>            throw new IllegalArgumentException("Arguments can't be null.");
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>        /*
</span><span class='line'>         * Let's lookup for the proxy 
</span><span class='line'>         */
</span><span class='line'>        InnerProxy p = proxies.get(sa); 
</span><span class='line'>        if (p != null) {
</span><span class='line'>            /*
</span><span class='line'>             * It's one of ours, if it failed more than 3 times
</span><span class='line'>             * let's remove it from the list.
</span><span class='line'>             */
</span><span class='line'>            if (p.failed() &gt;= 3)
</span><span class='line'>                    proxies.remove(sa);
</span><span class='line'>        } else {
</span><span class='line'>            /*
</span><span class='line'>             * Not one of ours, let's delegate to the default.
</span><span class='line'>             */
</span><span class='line'>            if (defsel != null)
</span><span class='line'>              defsel.connectFailed(uri, sa, ioe);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Logstash采集网站的访问日志]]></title>
    <link href="http://winseliu.com/blog/2018/01/20/logstash-monitor-myself-blog-accesslog/"/>
    <updated>2018-01-20T18:14:03+08:00</updated>
    <id>http://winseliu.com/blog/2018/01/20/logstash-monitor-myself-blog-accesslog</id>
    <content type="html"><![CDATA[<p>最近又重新接触了一下elasticsearch、logstash、kibana，蛮好用的一个日志框架。</p>

<p>同时好久没有更新网站内容、也没怎么关注，虽然有cnzz（umeng）的日志统计功能，但是毕竟是很小一段时间的。要是能够把日志都导出来，就可以用ELK来分析一下自己网站一年来文章的访问情况。</p>

<p>嗯，前阵子买了阿里云的一个VPN服务器，正好可以利用利用。把访问的日志情况通过http发送给logstash，然后存储下来，等过一段时间我们再回来分析分析这些日志。^^</p>

<h2>启动Logstash收集服务</h2>

<ul>
<li><a href="https://www.elastic.co/blog/introducing-logstash-input-http-plugin">https://www.elastic.co/blog/introducing-logstash-input-http-plugin</a></li>
<li><a href="https://discuss.elastic.co/t/post-data-to-logstash-using-http-input/69166/8">https://discuss.elastic.co/t/post-data-to-logstash-using-http-input/69166/8</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-json.html">https://www.elastic.co/guide/en/logstash/current/plugins-filters-json.html</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~/logstash-6.1.2/bin/logstash -e '
</span><span class='line'>input { 
</span><span class='line'>  http { 
</span><span class='line'>    port =&gt; 20000 
</span><span class='line'>    response_headers =&gt; {
</span><span class='line'>      "Access-Control-Allow-Origin" =&gt; "*"
</span><span class='line'>      "Content-Type" =&gt; "application/json"
</span><span class='line'>      "Access-Control-Allow-Headers" =&gt; "Origin, X-Requested-With, Content-Type, Accept"
</span><span class='line'>    }
</span><span class='line'>  } 
</span><span class='line'>} 
</span><span class='line'>filter {
</span><span class='line'>  if [message] =~ /^\s*$/ {
</span><span class='line'>    drop { }
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  json {
</span><span class='line'>    source =&gt; "message"
</span><span class='line'>  }
</span><span class='line'>  json {
</span><span class='line'>    source =&gt; "location"
</span><span class='line'>    target =&gt; "location"
</span><span class='line'>  }
</span><span class='line'>  mutate {
</span><span class='line'>    remove_field =&gt; [ "headers" ]
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>output { 
</span><span class='line'>  file { 
</span><span class='line'>    path =&gt; "winse-accesslog-%{+YYYY-MM-dd}.log"
</span><span class='line'>    codec =&gt; json_lines 
</span><span class='line'>  } 
</span><span class='line'>} 
</span><span class='line'>'</span></code></pre></td></tr></table></div></figure>


<h2>页面发送访问日志记录</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$.ajax({
</span><span class='line'>  type: "POST",
</span><span class='line'>  url: "http://SERVER:PORT",
</span><span class='line'>  data: JSON.stringify({
</span><span class='line'>    title: document.title,
</span><span class='line'>    location: JSON.stringify(location),
</span><span class='line'>    referrer: document.referrer,
</span><span class='line'>    userAgent: navigator.userAgent
</span><span class='line'>  }),
</span><span class='line'>  contentType: "application/json; charset=utf-8",
</span><span class='line'>  dataType: "json"
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Gitalk on Octopress]]></title>
    <link href="http://winseliu.com/blog/2018/01/20/gitalk-on-octopress/"/>
    <updated>2018-01-20T15:41:00+08:00</updated>
    <id>http://winseliu.com/blog/2018/01/20/gitalk-on-octopress</id>
    <content type="html"><![CDATA[<p>以前有添加过 多说 ，步骤都类似的。其实就是调用一个第三方的服务，把评论的数据存储在第三方。</p>

<p>可以先看看 <a href="https://github.com/gitalk/gitalk/blob/master/readme-cn.md">gitalk 的文档</a> ，分四步：</p>

<ul>
<li>注册一个github 的 <a href="https://github.com/settings/developers">OAuth Apps</a></li>
<li>添加div容器</li>
<li>加入css，js依赖</li>
<li>调用javascript显示</li>
</ul>


<h2>配置</h2>

<h4>注册一个github应用</h4>

<ul>
<li><a href="https://github.com/gitalk/gitalk/blob/master/readme-cn.md#%E4%BD%BF%E7%94%A8">使用</a></li>
<li><a href="https://github.com/settings/applications/new">https://github.com/settings/applications/new</a></li>
</ul>


<h4>在 <code>_layouts/post.html</code> 的 Comments 下添加一个 gitalk-container 的节点：</h4>

<p>（粘贴后把大括号和百分号之间的空格去掉）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{ % if site.disqus_short_name and page.comments == true % }
</span><span class='line'>  &lt;section&gt;
</span><span class='line'>    &lt;h1&gt;Comments&lt;/h1&gt;
</span><span class='line'>&lt;!-- gitalk评论 start --&gt;
</span><span class='line'>    &lt;div id="gitalk-container"&gt;&lt;/div&gt; 
</span><span class='line'>&lt;!-- gitalk评论 end --&gt;
</span><span class='line'>  &lt;/section&gt;
</span><span class='line'>{ % endif % }</span></code></pre></td></tr></table></div></figure>


<h4>在 <code>_includes</code> 目录下增加一个 gitalk.html 的页面，添加依赖并添加初始化代码：</h4>

<p>这里clientID，clientSecret对应第一步注册应用的id和secret。</p>

<p>在官网文档给的例子上调整了一下: id， body, createIssueManually。代码里面是通过 <code>labels + id</code> 来查询对应的issue：<a href="https://github.com/gitalk/gitalk/blob/9a2c6e94281a628a8e0f1ccbdceebd5d17bc1756/src/gitalk.jsx#L174">查询Issue源码</a></p>

<p>（粘贴后把大括号和百分号之间的空格去掉）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{ % if site.disqus_short_name and page.comments != false % }
</span><span class='line'>
</span><span class='line'>&lt;link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"&gt;
</span><span class='line'>&lt;script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"&gt;&lt;/script&gt;
</span><span class='line'>
</span><span class='line'>&lt;script&gt;
</span><span class='line'>
</span><span class='line'>var gitalk = new Gitalk({
</span><span class='line'>  clientID: 'c14f68eac6330d15d984',
</span><span class='line'>  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
</span><span class='line'>  repo: 'winse.github.com',
</span><span class='line'>  owner: 'winse',
</span><span class='line'>  admin: ['winse'],
</span><span class='line'>  id: location.pathname,
</span><span class='line'>  labels: ['Gitalk'],
</span><span class='line'>  body: "http://winseliu.com" + location.pathname,
</span><span class='line'>  createIssueManually: true,
</span><span class='line'>  
</span><span class='line'>  // facebook-like distraction free mode
</span><span class='line'>  distractionFreeMode: false
</span><span class='line'>})
</span><span class='line'>
</span><span class='line'>gitalk.render('gitalk-container')
</span><span class='line'>
</span><span class='line'>&lt;/script&gt;
</span><span class='line'>
</span><span class='line'>{ % endif % }</span></code></pre></td></tr></table></div></figure>


<p>然后在同一级目录的 after_footer.html 新增一条 这个新页面一个引用（粘贴后把大括号和百分号之间的空格去掉）:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{ % include gitalk.html % }</span></code></pre></td></tr></table></div></figure>


<h2>初始化</h2>

<ul>
<li><a href="https://github.com/gitalk/gitalk/wiki/%E8%AF%84%E8%AE%BA%E5%88%9D%E5%A7%8B%E5%8C%96">https://github.com/gitalk/gitalk/wiki/%E8%AF%84%E8%AE%BA%E5%88%9D%E5%A7%8B%E5%8C%96</a></li>
<li><a href="https://draveness.me/git-comments-initialize">https://draveness.me/git-comments-initialize</a></li>
<li><a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a></li>
</ul>


<p>其实就是在对应的repo下面建一个repo，注意下 <strong>labels</strong> 规则就行了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>username = "winse" # GitHub 用户名
</span><span class='line'>
</span><span class='line'># https://github.com/settings/tokens
</span><span class='line'>new_token = ""  # GitHub Token
</span><span class='line'>repo_name = "winse.github.com" # 存放 issues
</span><span class='line'>
</span><span class='line'>sitemap_url = "sitemap.xml" # sitemap
</span><span class='line'>kind = "Gitalk"
</span><span class='line'>
</span><span class='line'># 可以结合git的状态，added的调用命令创建一个issue
</span><span class='line'>
</span><span class='line'># 除了使用Token，也可以手动输入密码
</span><span class='line'>curl -H "Accept: application/json" -X POST -d '{"body": "http://winseliu.com/blog/2017/11/20/sed-debug-sedsed/", "labels": ["Gitalk", "/blog/2017/11/20/sed-debug-sedsed/"], "title": "gitalk 测试" }' -u $username https://api.github.com/repos/$username/$repo_name/issues
</span><span class='line'>Enter host password for user 'winse':
</span><span class='line'>
</span><span class='line'>OR
</span><span class='line'>
</span><span class='line'># https://developer.github.com/v3/auth/#basic-authentication
</span><span class='line'>curl -u username:token https://api.github.com/user
</span></code></pre></td></tr></table></div></figure>


<h2>参考</h2>

<ul>
<li><a href="http://qiubaiying.top/2017/12/19/%E4%B8%BA%E5%8D%9A%E5%AE%A2%E6%B7%BB%E5%8A%A0-Gitalk-%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6/">为博客添加 Gitalk 评论插件</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sed Debug: Sedsed]]></title>
    <link href="http://winseliu.com/blog/2017/11/20/sed-debug-sedsed/"/>
    <updated>2017-11-20T23:54:11+08:00</updated>
    <id>http://winseliu.com/blog/2017/11/20/sed-debug-sedsed</id>
    <content type="html"><![CDATA[<p>上一篇把html转成rst，但是页面之间的链接都断了。需要在标题前加上一个TAG，最终效果如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>.. _Creating Objects in New Mappings:
</span><span class='line'>
</span><span class='line'>Creating Objects in New Mappings
</span><span class='line'>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span><span class='line'>
</span><span class='line'>+ :ref:`Creating Objects in New Mappings`
</span></code></pre></td></tr></table></div></figure>


<p>想使用sed来实现这个功能，需要利用一些sed的高级功能，但默认sed是不能调试。这里使用sedsed来查看每一个操作的模式空间和缓冲空间，有点类似print调试。对于理解 sed 很有帮助，特别是对理解缓冲区和模式区数据的处理。</p>

<h4>安装 sedsed</h4>

<ul>
<li><a href="http://aurelio.net/projects/sedsed/#usage">官网文档</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /opt/
</span><span class='line'>git clone https://github.com/aureliojargas/sedsed</span></code></pre></td></tr></table></div></figure>


<p>看看实际的调试输出：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ansible sedsed]# echo -e "one\ntwo\nthree\nfour" | ./sedsed.py -d -f test/scripts/sort.gnu.sed 
</span><span class='line'>PATT:one$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:H
</span><span class='line'>PATT:one$
</span><span class='line'>HOLD:\none$
</span><span class='line'>COMM:$ !d
</span><span class='line'>PATT:two$
</span><span class='line'>HOLD:\none$
</span><span class='line'>COMM:H
</span><span class='line'>PATT:two$
</span><span class='line'>HOLD:\none\ntwo$
</span><span class='line'>COMM:$ !d
</span><span class='line'>PATT:three$
</span><span class='line'>HOLD:\none\ntwo$
</span><span class='line'>COMM:H
</span><span class='line'>PATT:three$
</span><span class='line'>HOLD:\none\ntwo\nthree$
</span><span class='line'>COMM:$ !d
</span><span class='line'>PATT:four$
</span><span class='line'>HOLD:\none\ntwo\nthree$
</span><span class='line'>COMM:H
</span><span class='line'>PATT:four$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM:$ !d
</span><span class='line'>PATT:four$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM:g
</span><span class='line'>PATT:\none\ntwo\nthree\nfour$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM:s/.//
</span><span class='line'>PATT:one\ntwo\nthree\nfour$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM:s/\n/&L&l/g
</span><span class='line'>PATT:one\nL\nltwo\nL\nlthree\nL\nlfour$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM:s/^/\\Na/
</span><span class='line'>PATT:\naone\nL\nltwo\nL\nlthree\nL\nlfour$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM:s/\nL/\\NA/
</span><span class='line'>PATT:\naone\nA\nltwo\nL\nlthree\nL\nlfour$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM:s/$/\\NL/
</span><span class='line'>PATT:\naone\nA\nltwo\nL\nlthree\nL\nlfour\nL$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM:b start
</span><span class='line'>COMM:/\nA$/ b exit
</span><span class='line'>COMM:s/\nb/\\Nl/
</span><span class='line'>PATT:\naone\nA\nltwo\nL\nlthree\nL\nlfour\nL$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM:s/\nB/\\NL/
</span><span class='line'>PATT:\naone\nA\nltwo\nL\nlthree\nL\nlfour\nL$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM:s/\(\na.*\nA\)\nl\([^\n]*\)\nL/\1\\Nb\2\\NB/
</span><span class='line'>PATT:\naone\nA\nbtwo\nB\nlthree\nL\nlfour\nL$
</span><span class='line'>HOLD:\none\ntwo\nthree\nfour$
</span><span class='line'>COMM::sort
</span><span class='line'>COMM:h
</span><span class='line'>......
</span><span class='line'>
</span><span class='line'>[root@ansible sedsed]# (date +'%w %d' ; date +'%-m %Y') | ./sedsed.py -d -f test/scripts/cal.sed
</span><span class='line'>......
</span></code></pre></td></tr></table></div></figure>


<h4>网上的一案例</h4>

<p>看到一个<a href="http://bbs.chinaunix.net/forum.php?mod=viewthread&amp;tid=3775201&amp;page=1#pid22315115">论坛帖子</a>上用sed实现 <strong>删除匹配的前两行和后三行</strong> ，看的不是很明白，帖子仅注意介绍流程，至于数据到底是怎么样的没有讲。如果知道 sedsed 这工具的话，运行一遍就全部清楚了：</p>

<p>sedsed.py 处理 <code>+</code> 加号有点问题，所以这里就处理匹配的前两行，看看具体的数据是怎么流转的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ansible sedsed]# echo -e "1\n2\n3\n4\n5\n6\n7\n8\n9\n10" | ./sedsed.py -d '/5/d;:go;1,2!{P;N;D};N;bgo' 
</span><span class='line'>PATT:1$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:/5/ d
</span><span class='line'>PATT:1$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM::go
</span><span class='line'>COMM:1,2 !{
</span><span class='line'>COMM:N
</span><span class='line'>PATT:1\n2$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:b go
</span><span class='line'>COMM:1,2 !{
</span><span class='line'>COMM:N
</span><span class='line'>PATT:1\n2\n3$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:b go
</span><span class='line'>COMM:1,2 !{
</span><span class='line'>COMM:P
</span><span class='line'>1
</span><span class='line'>PATT:1\n2\n3$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:N
</span><span class='line'>PATT:1\n2\n3\n4$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:D
</span><span class='line'>PATT:2\n3\n4$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:/5/ d
</span><span class='line'>PATT:2\n3\n4$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM::go
</span><span class='line'>COMM:1,2 !{
</span><span class='line'>COMM:P
</span><span class='line'>2
</span><span class='line'>PATT:2\n3\n4$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:N
</span><span class='line'>PATT:2\n3\n4\n5$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:D
</span><span class='line'>PATT:3\n4\n5$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:/5/ d
</span><span class='line'>PATT:6$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:/5/ d
</span><span class='line'>PATT:6$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM::go
</span><span class='line'>COMM:1,2 !{
</span><span class='line'>COMM:P
</span><span class='line'>6
</span><span class='line'>PATT:6$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:N
</span><span class='line'>PATT:6\n7$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:D
</span><span class='line'>PATT:7$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:/5/ d
</span><span class='line'>PATT:7$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM::go
</span><span class='line'>COMM:1,2 !{
</span><span class='line'>COMM:P
</span><span class='line'>7
</span><span class='line'>PATT:7$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:N
</span><span class='line'>PATT:7\n8$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:D
</span><span class='line'>PATT:8$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:/5/ d
</span><span class='line'>PATT:8$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM::go
</span><span class='line'>COMM:1,2 !{
</span><span class='line'>COMM:P
</span><span class='line'>8
</span><span class='line'>PATT:8$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:N
</span><span class='line'>PATT:8\n9$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:D
</span><span class='line'>PATT:9$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:/5/ d
</span><span class='line'>PATT:9$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM::go
</span><span class='line'>COMM:1,2 !{
</span><span class='line'>COMM:P
</span><span class='line'>9
</span><span class='line'>PATT:9$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:N
</span><span class='line'>PATT:9\n10$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:D
</span><span class='line'>PATT:10$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:/5/ d
</span><span class='line'>PATT:10$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM::go
</span><span class='line'>COMM:1,2 !{
</span><span class='line'>COMM:P
</span><span class='line'>10
</span><span class='line'>PATT:10$
</span><span class='line'>HOLD:$
</span><span class='line'>COMM:N
</span><span class='line'>10</span></code></pre></td></tr></table></div></figure>


<p>可以看到 <strong>PATT</strong> 模式空间把前面两行连到一起了，匹配到 <strong>5</strong> 的时刻其实模式空间的内容为 <strong>3\n4\n5</strong>，然后执行 <strong>d</strong> 这就相当于删除前两行了。</p>

<p>该命令会多输出最后一行：由于到最后一行，N 又读取了一次下一行（读到结束符），直接就返回没有执行 D 了。sed 文档中的描述如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  `D'
</span><span class='line'>      If pattern space contains no newline, start a normal new cycle as
</span><span class='line'>      if the `d' command was issued.  Otherwise, delete text in the
</span><span class='line'>      pattern space up to the first newline, and restart cycle with the
</span><span class='line'>      resultant pattern space, without reading a new line of input.
</span><span class='line'>  
</span><span class='line'>  `N'
</span><span class='line'>      Add a newline to the pattern space, then append the next line of
</span><span class='line'>      input to the pattern space.  If there is no more input then `sed'
</span><span class='line'>      exits without processing any more commands.</span></code></pre></td></tr></table></div></figure>


<p>修复就是：读到最后一行的时刻就不读下一行了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ansible sedsed]# echo -e "1\n2\n3\n4\n5\n6\n7\n8\n9\n10" | sed '/5/,+3d;:go;1,2!{P;$!N;D};N;bgo' </span></code></pre></td></tr></table></div></figure>


<h4>加标签</h4>

<p>Sphinx可以通过 <strong>ref</strong> 来访问整个文档中定义的标签。所以只需要在每个标题前加上TAG，然后把链接引用修改成 <strong>ref</strong> 的方式即可。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 文档加TAG：
</span><span class='line'>sed -i ' h;N; /\n=\+$/{ x;s/.*/.. _&:\n/;p; x };  P;D ' $(find . -name '*.rst')
</span><span class='line'>sed -i ' h;N; /\n-\+$/{ x;s/.*/.. _&:\n/;p; x };  P;D ' $(find . -name '*.rst')
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 修改链接引用：
</span><span class='line'>sed 's/\(`[[:alnum:] ]*`\)_/:ref:\1/ ' $(find . -name '*.rst')
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Gitlab on Docker]]></title>
    <link href="http://winseliu.com/blog/2017/11/20/gitlab-on-docker/"/>
    <updated>2017-11-20T21:38:21+08:00</updated>
    <id>http://winseliu.com/blog/2017/11/20/gitlab-on-docker</id>
    <content type="html"><![CDATA[<ul>
<li><a href="https://github.com/sameersbn/docker-gitlab">https://github.com/sameersbn/docker-gitlab</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./docker-download-mirror.sh sameersbn/redis sameersbn/gitlab:10.1.4 sameersbn/postgresql:9.6-2
</span><span class='line'>
</span><span class='line'># 最好，每个 docker-compose.yml 放不同的目录名称下！！
</span><span class='line'>mkdir gitlab
</span><span class='line'>cd !*
</span><span class='line'>
</span><span class='line'>wget https://raw.githubusercontent.com/sameersbn/docker-gitlab/master/docker-compose.yml
</span><span class='line'>sed -i '/GITLAB_HOST/s/.*/    - GITLAB_HOST=192.168.193.8/' docker-compose.yml 
</span><span class='line'>
</span><span class='line'>docker-compose up -d
</span><span class='line'>
</span><span class='line'>firewall-cmd --zone=public --add-port=80/tcp --permanent
</span><span class='line'>firewall-cmd --reload
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用Sphinx生成/管理文档]]></title>
    <link href="http://winseliu.com/blog/2017/11/16/sphinx-generate-docs/"/>
    <updated>2017-11-16T23:23:23+08:00</updated>
    <id>http://winseliu.com/blog/2017/11/16/sphinx-generate-docs</id>
    <content type="html"><![CDATA[<p>很多开源的软件都使用Sphinx来进行文档的管理，其中Ansible就是其中一个。</p>

<p>Sphinx使用 类MarkDown的reStructuredText格式 来进行内容的编写，然后使用 sphinx-build 命令来生成html文件。</p>

<h2>安装、入门</h2>

<ul>
<li><a href="http://www.sphinx-doc.org/en/stable/tutorial.html">http://www.sphinx-doc.org/en/stable/tutorial.html</a></li>
<li><a href="http://www.sphinx-doc.org/en/stable/rest.html">reStructuredText</a></li>
<li><a href="http://zh-sphinx-doc.readthedocs.io/en/latest/rest.html">reStructuredText 简介</a></li>
<li><a href="http://www.sphinx-doc.org/en/stable/markup/index.html">Sphinx Markup Constructs</a></li>
<li><a href="http://rest-sphinx-memo.readthedocs.io/en/latest/ReST.html">ReST – reStructuredText</a> GOOD!</li>
<li><a href="http://www.bijishequ.com/detail/261642">reStructuredText(rst)快速入门语法说明</a></li>
<li><a href="http://sphinx-doc.readthedocs.io/zh_CN/latest/rest.html#id9">章节</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install python-pip
</span><span class='line'>sudo pip install Sphinx
</span><span class='line'>
</span><span class='line'>sphinx-quickstart
</span></code></pre></td></tr></table></div></figure>


<p>引用：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>*重点(emphasis)通常显示为斜体*
</span><span class='line'>`解释文字(interpreted text)通常显示为斜体`
</span><span class='line'>
</span><span class='line'>**重点强调(strong emphasis)通常显示为粗体**
</span><span class='line'>
</span><span class='line'>``行内文本(inline literal)通常显示为等宽文本，空格可以保留，但是换行不可以。``
</span><span class='line'>
</span><span class='line'>章节头部由下线(也可有上线)和包含标点的标题 组合创建, 其中下线要至少等于标准文本的长度。
</span><span class='line'>可以表示标题的符号有 =、-、`、:、'、"、~、^、_ 、* 、+、 #、&lt;、&gt; 。
</span><span class='line'>对于相同的符号，有上标是一级标题，没有上标是二级标题。
</span><span class='line'>标题最多分六级，可以自由组合使用。
</span><span class='line'>
</span><span class='line'># with overline, for parts
</span><span class='line'>* with overline, for chapters
</span><span class='line'>=, for sections
</span><span class='line'>-, for subsections
</span><span class='line'>^, for subsubsections
</span><span class='line'>", for paragraphs
</span></code></pre></td></tr></table></div></figure>


<h2>主题</h2>

<ul>
<li><a href="http://www.sphinx-doc.org/en/stable/theming.html">http://www.sphinx-doc.org/en/stable/theming.html</a></li>
<li><a href="https://pypi.python.org/pypi/sphinx_rtd_theme">https://pypi.python.org/pypi/sphinx_rtd_theme</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo pip install sphinx_rtd_theme
</span><span class='line'>
</span><span class='line'>sed -i "/html_theme/s/.*/html_theme = 'sphinx_rtd_theme'/" conf.py
</span></code></pre></td></tr></table></div></figure>


<h2>管理历史文档</h2>

<ul>
<li><a href="http://zh-sphinx-doc.readthedocs.io/en/latest/intro.html#id2">不同文档系统的转换</a></li>
<li><a href="https://pypi.python.org/pypi/html2rest">https://pypi.python.org/pypi/html2rest</a></li>
</ul>


<p>先使用 html2rest 把html转成reStructuredText格式。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo pip install html2rest
</span><span class='line'>
</span><span class='line'>#JSON：原始文档层次结构
</span><span class='line'>  [
</span><span class='line'>  { "id": "a16", "pId": "a", "name": "Administration", "file": "output/AdministrativeDocumentation.html" }, 
</span><span class='line'>  { "id": "a1617", "pId": "a16", "name": "Basic Configuration Guide" },
</span><span class='line'>  { "id": "a161718", "pId": "a1617", "name": "Configuring Deployments", "file": "output/ConfiguringDeployments.html" }
</span><span class='line'>  ]
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>name=administration
</span><span class='line'>cat $name.json | jq '.[].file' | sed 's/"//g' | while read line ; do cp "$line" $name.origin/  ; done
</span><span class='line'>cd $name.origin
</span><span class='line'>ls | while read f ; do html2rest $f &gt;"../$name.rst/${f%%.*}.rst" ; done
</span></code></pre></td></tr></table></div></figure>


<p>这仅仅是把html转换成了reStructuredText格式，当然我们还可以做多一些的操作：把文件结构也创建出来。</p>

<p>docs-gen.sh脚本内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>JSON_FILE=~/administration.json
</span><span class='line'>
</span><span class='line'>function children(){
</span><span class='line'>local id=$1
</span><span class='line'>
</span><span class='line'>local name="$( cat "$JSON_FILE" | jq '.[] | select(.id=="'$id'")' | jq '.name' | sed 's/"//g' )"
</span><span class='line'>echo "id: $id, name: $name"
</span><span class='line'>
</span><span class='line'>local filename="$( echo $name | sed 's/[^[:alnum:]]//g' )"
</span><span class='line'>
</span><span class='line'>if [ ! -f "$filename.rst" ] ; then
</span><span class='line'>cat &gt; "$filename.rst" &lt;&lt;EOF
</span><span class='line'>$name
</span><span class='line'>======================================
</span><span class='line'>
</span><span class='line'>EOF
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>local nodes="$( cat "$JSON_FILE" | jq '.[] | select(.pId=="'$id'")' )"
</span><span class='line'>
</span><span class='line'>if [ "x$nodes" == "x" ] ; then 
</span><span class='line'>  return 1
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'># if have children, create folder and toc
</span><span class='line'>local foldername="$( echo $name | sed 's/[^[:alnum:]]//g' )"
</span><span class='line'>local names="$( echo "$nodes" | jq ".name" | sed 's/[^[:alnum:]]//g' )"
</span><span class='line'>local ids="$( echo "$nodes" | jq ".id" | sed 's/[^[:alnum:]]//g' )"
</span><span class='line'>
</span><span class='line'>if ! grep '.. toctree::' "$foldername.rst" ; then
</span><span class='line'>cat &gt;&gt;"$foldername.rst" &lt;&lt;EOF
</span><span class='line'>
</span><span class='line'>Contents:
</span><span class='line'>
</span><span class='line'>.. toctree::
</span><span class='line'>   :maxdepth: 3
</span><span class='line'>   :titlesonly:
</span><span class='line'>   :hidden:
</span><span class='line'>   :glob:
</span><span class='line'>   
</span><span class='line'>$( echo "$names" | sed "s#^#   $foldername/#" ) 
</span><span class='line'>
</span><span class='line'>EOF
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>mkdir -p "$foldername"
</span><span class='line'>pushd "$foldername"
</span><span class='line'>
</span><span class='line'>while read cid
</span><span class='line'>do 
</span><span class='line'>  children $cid
</span><span class='line'>done &lt; &lt;(echo "$ids")
</span><span class='line'>
</span><span class='line'>popd
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>children a
</span></code></pre></td></tr></table></div></figure>


<p>然后执行该命令，把目录、目录索引、临时文件创建好：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd ~/administration
</span><span class='line'>./docs-gen.sh</span></code></pre></td></tr></table></div></figure>


<p>然后就是把最开始转换的rst文件拷贝过来：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd ../administration.rst
</span><span class='line'>
</span><span class='line'>ls | while read f ; do 
</span><span class='line'>filename="$(echo $f | sed 's/.rst$//' | sed 's/[^[:alnum:]]//g' ).rst" ; 
</span><span class='line'>find ../administration/ -name "$filename" -exec /bin/cp -f $f {} \;  ;  
</span><span class='line'>done
</span><span class='line'>
</span><span class='line'>#再执行一遍docs-gen.sh，把目录的索引再（确认）添加一次文件末尾
</span><span class='line'>cd ../administration
</span><span class='line'>./docs-gen.sh
</span></code></pre></td></tr></table></div></figure>


<p>完后生成 <code>make html</code> ，直接打开 <strong>_build/html/index.html</strong> 查看下内容。</p>

<p>最后就是根据具体情况，做一些细微的调整了。</p>

<ul>
<li>处理图片，修改 /usr/local/lib/python2.7/dist-packages/html2rest.py</li>
<li>处理文档内互相引用的链接</li>
<li>给标题添加TAG</li>
</ul>


<h2>生成PDF</h2>

<p>除了生成html外，还可以直接编译成PDF，方便携带和查看。（官网是推荐使用latexpdf，但这得安装latex&hellip;）</p>

<ul>
<li><a href="https://www.quora.com/How-to-create-a-PDF-out-of-Sphinx-documentation-tool">https://www.quora.com/How-to-create-a-PDF-out-of-Sphinx-documentation-tool</a></li>
<li>Config value &lsquo;math_number_all&rsquo; already present <a href="https://github.com/sphinx-doc/sphinx/issues/2499">https://github.com/sphinx-doc/sphinx/issues/2499</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ansible workspace]# pip install rst2pdf
</span><span class='line'>
</span><span class='line'>[root@ansible workspace]# vi conf.py 
</span><span class='line'>...
</span><span class='line'>#extensions = ['sphinx.ext.doctest', 'sphinx.ext.todo', 'sphinx.ext.pngmath']
</span><span class='line'>extensions = ['sphinx.ext.doctest', 'sphinx.ext.todo', 'rst2pdf.pdfbuilder']
</span><span class='line'>
</span><span class='line'>pdf_documents = [('index', u'Workspace', u'Workspace Doc', u'winse'),]
</span><span class='line'>
</span><span class='line'>[root@ansible workspace]# sphinx-build -b pdf . _build/pdf
</span></code></pre></td></tr></table></div></figure>


<p>或者用 singlehtml 临时代替下也行。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>make singlehtml</span></code></pre></td></tr></table></div></figure>


<h2>MISC</h2>

<ul>
<li><a href="http://www.sphinx-doc.org/en/latest/markup/inline.html">Inline markup</a></li>
<li><a href="http://zh-sphinx-doc.readthedocs.io/en/latest/markup/inline.html">文档引用</a></li>
<li><a href="http://rest-sphinx-memo.readthedocs.io/en/latest/Sphinx.html#sphinx-inline-markup">Sphinx inline markup</a></li>
<li><a href="http://rest-sphinx-memo.readthedocs.io/en/latest/ReST.html#tables">表格</a> GOOD!</li>
<li><a href="http://openalea.gforge.inria.fr/doc/openalea/doc/_build/html/source/sphinx/rest_syntax.html#tables">table</a></li>
<li><a href="http://www.tablesgenerator.com/text_tables#">tablesgenerator</a> <a href="https://stackoverflow.com/questions/26609816/some-online-tool-or-automation-plugin-for-sublimetext-for-generating-sphinx-rst">&lt;-</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用TeamviewerVPN访问公司内网]]></title>
    <link href="http://winseliu.com/blog/2017/11/04/teamviewer-vpn-on-windows/"/>
    <updated>2017-11-04T22:26:50+08:00</updated>
    <id>http://winseliu.com/blog/2017/11/04/teamviewer-vpn-on-windows</id>
    <content type="html"><![CDATA[<p>一直以来都只是用Teamviewer的图形界面，如果仅仅针对单台机器操作还是蛮OK的。但是如果想要访问远程的整个集群，那就为难了。</p>

<p>以前通过 <strong> 公司的跳板机 </strong>，然后连接 <strong> 内网搭建的VPN </strong> 来实现 <strong> 透明 </strong> 的访问公司的环境。也折腾过自己买一台aliyun的机器搞一个外网IP，然后通过SSH的反向代理来间接的跳转访问公司内网，但成本都还是比较高的。</p>

<p>既然Teamviewer提供了一种远程访问的方式，那么能不能通过Teamviewer来实现代理，继而类似VPN的方式在家访问公司内网呢？</p>

<p>备注：一般都是双保险啊，Teamviewer和Anydesk都放一个！！！</p>

<h2>安装</h2>

<p>Teamviewer是提供了VPN的访问方式，需要在安装的时刻 选择【显示高级设置】，在下一步中选择【使用Teamviewer VPN】。连接的 <strong> 两台主机都需要安装Teamviewer VPN </strong> 的功能！！！</p>

<p><img src="http://winseliu.com/images/teamviewer-vpn-install.png" alt="" /></p>

<h2>使用VPN</h2>

<p><img src="http://winseliu.com/images/teamviewer-vpn-connect.png" alt="" /></p>

<h2>访问内网</h2>

<p>如果是Linux的话，可以在iptables上面配置SNAT，但是Linux Teamviewer暂时不支持VPN功能。
并且公司运行Teamviewer的机器是WIN7，不能通过运行nat命令（server版本才有）来设置转发。最后功夫不负有心人，找到了在win7下可以设置NAT的方法：</p>

<ul>
<li><a href="https://social.technet.microsoft.com/Forums/windows/en-US/30c1affa-cc6b-4eeb-9377-7600cc3f333a/nat-in-windows7?forum=w7itpronetworking">NAT in windows7</a></li>
<li><a href="https://www.onlinekosten.de/forum/showthread.php?p=2278439">AW: mit Teamviewer VPN ins interne Netzwerk?</a></li>
</ul>


<h4>转发配置</h4>

<ol>
<li>连接的两台机器都启动 <strong> Routing an Remote Access </strong> 系统服务。（修改注册表IPEnableRouter的，不弄也行）</li>
<li>在公司Teamviwer机器上，下载并安装 <a href="http://www.nat32.com/download2/nat32v2.zip">NAT</a> ，<a href="https://www.ntkernel.com/downloads/winpkflt_rtl.zip">配置工具</a></li>
<li>在公司Teamviwer机器上，打开配置工具 <strong> WinpkFilter - Internet Gateway </strong>，配置 本地连接 为Provider， Teamviewer VPN 为Client，然后启动 Start NAT。</li>
</ol>


<p><img src="http://winseliu.com/images/teamviewer-vpn-nat-config.png" alt="" /></p>

<ol>
<li>在本地机器上，添加route，把访问 公司内网IP 的数据转到公司Teamviewer VPN，这样我们就可以透明的访问公司的所有机器了。</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#网关填公司Teamviewer端的IP地址！！！
</span><span class='line'>C:\Windows\system32&gt;route add 192.168.193.0 mask 255.255.255.0 7.138.125.65 metric 1
</span><span class='line'>
</span><span class='line'>C:\Windows\system32&gt;ping 192.168.193.110
</span><span class='line'>
</span><span class='line'>正在 Ping 192.168.193.110 具有 32 字节的数据:
</span><span class='line'>来自 192.168.193.110 的回复: 字节=32 时间=22ms TTL=63
</span><span class='line'>来自 192.168.193.110 的回复: 字节=32 时间=21ms TTL=63
</span><span class='line'>来自 192.168.193.110 的回复: 字节=32 时间=21ms TTL=63
</span><span class='line'>
</span><span class='line'>192.168.193.110 的 Ping 统计信息:
</span><span class='line'>    数据包: 已发送 = 3，已接收 = 3，丢失 = 0 (0% 丢失)，
</span><span class='line'>往返行程的估计时间(以毫秒为单位):
</span><span class='line'>    最短 = 21ms，最长 = 22ms，平均 = 21ms</span></code></pre></td></tr></table></div></figure>


<p>完美，所有的事情Teamviewer都帮想到了并且实现了。</p>

<p>把上面的全部操作写到一个脚本，以后直接使用管理员权限运行即可：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-ADH7K1Q:~/bigendian$ cat VPN-Route.bat
</span><span class='line'>@setlocal enableextensions enabledelayedexpansion
</span><span class='line'>@echo on
</span><span class='line'>
</span><span class='line'>rem https://community.teamviewer.com/t5/Knowledge-Base/Are-there-parameters-to-start-TeamViewer/ta-p/4135
</span><span class='line'>rem teamviewer.exe -i &lt;ID&gt; -P &lt;Password&gt; [-m fileTransfer/vpn]
</span><span class='line'>start "teamviewer" "C:\Program Files (x86)\TeamViewer\TeamViewer.exe"
</span><span class='line'>
</span><span class='line'>set teamvpnipaddr=7.138.125.65
</span><span class='line'>
</span><span class='line'>:loop
</span><span class='line'>ping -n 1 !teamvpnipaddr! | find "TTL"
</span><span class='line'>if not errorlevel 1 goto :run
</span><span class='line'>if errorlevel 1 goto :endloop
</span><span class='line'>:endloop
</span><span class='line'>ping -n 2 127.0.0.1 &gt;nul: 2&gt;nul:
</span><span class='line'>cls
</span><span class='line'>goto :loop
</span><span class='line'>
</span><span class='line'>:run
</span><span class='line'>route delete 192.168.193.0
</span><span class='line'>route add 192.168.193.0 mask 255.255.255.0 !teamvpnipaddr! metric 1
</span><span class='line'>
</span><span class='line'>endlocal
</span><span class='line'>
</span><span class='line'>pause
</span></code></pre></td></tr></table></div></figure>


<h2>参考的原文：</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>Hello everybody, I investigated a lot for this issue.
</span><span class='line'>Establish a VPN session with TeamViewer to my home pc (remote side) and try to get access to this local network from my working place (local side).
</span><span class='line'>I found an solution i never read anywhere before. Since Windows 7 has removed NAT option using netsh it is difficult to solve it with windows on board tools only.
</span><span class='line'>- Install TeamViewer incl. VPN driver on both sides, activate unattended access on the remote side (my home pc). Use the button Show advanced options, and go to Advanced network options … Install VPN driver
</span><span class='line'>- Install WinPkFilter Device Driver on remote side (my home pc) and restart (http://www.nat32.com/v2/install.htm Download installer: http://www.ntkernel.com/downloads/winpkflt_rtl.zip . NAT32 you don't need. This WinPkFilter package contains a simple GUI to configure the NAT between the VPN interface (client) and the remote side LAN interface (provider). see following hints ...
</span><span class='line'>- Windows: Start RemoteAccess - service 'Routing an Remote Access'  and set to automatic (local/remote side).
</span><span class='line'>- Optional: On the remote side (my home pc), the registry has to be modified. Start the registry editor for example by Regedt32, and browse to HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters Set the parameter IPEnableRouter to “1”. Using console or batch as admin: reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" /v "IPEnableRouter" /t REG_DWORD /d "1". On my system it worked without this option, but according internet forums it seems to be recommended.
</span><span class='line'>- Now create a remote desktop session to your home pc and start also the VPN connection within this TeamViewer session (Menu / Extras / VPN). I created a free TeamViewer account and added all pc's to my computers to make the access to my machines easier.
</span><span class='line'>- On remode side (my home pc) where WinPkFilter is installed start the Internet Gateway GUI of WinPkFilter: Start / Programms / WinpkFilter / Internet Gateway. Select (double click) the ethernet adapter of your local privat lan and set NAT Status to 'Provider'. Select the TeamViewer VPN adapter and set NAT Status to 'client'. Press 'Start NAT'
</span><span class='line'> - On local side (my working place) Add a route to the local side (my working place) to give access to several devices that have the same subnet, add the route like this:
</span><span class='line'>
</span><span class='line'>route add &lt;base IP of remote devices&gt; mask 255.255.255.0 &lt;IP of Teamviewer VPN on remote PC&gt; 
</span><span class='line'>metric 1
</span><span class='line'>
</span><span class='line'>Example (home lan ip range: 192.168.2.x / TeamViewer VPN IP in home pc (remote side) 7.37.88.245
</span><span class='line'>route add 192.168.2.0 mask 255.255.255.0 7.37.88.245 metric 1 &lt;ENTER&gt;
</span><span class='line'>route add 192.168.2.0 mask 255.255.255.0 7.37.88.245 metric 1 -p &lt;ENTER&gt; (if persistent)
</span><span class='line'>Do delete the route route delete 192.168.2.0
</span><span class='line'>Now you should have access to your private home network. Good luck and have fun.
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Windows Run Ubuntu]]></title>
    <link href="http://winseliu.com/blog/2017/10/30/windows-run-ubuntu/"/>
    <updated>2017-10-30T07:17:53+08:00</updated>
    <id>http://winseliu.com/blog/2017/10/30/windows-run-ubuntu</id>
    <content type="html"><![CDATA[<p>最新版的Windows已经可以安装ubuntu了，算是微软开源后的一个阶段性的成果了。</p>

<p>功能和windows兼容性很强（不像cygwin），软链接、文件权限都是和系统一致的。并且基本所有ubuntu的功能都可以使用，安装jekyll、docker都很顺利。同时打开系统的程序也很方便。非常赞和值得程序员去尝试！！</p>

<p>本文后面会逐渐增加使用过程中的一些操作，今天先更新系统安装、octopress安装、docker安装。</p>

<h2>系统安装</h2>

<p>直接去微软的官网下载最新版系统ISO，然后安装系统 <strong> 专业版 </strong>（教育版比较干净一些，但是网上没有破解方式啊）。</p>

<h2>Ubuntu</h2>

<h4>安装Ubuntu</h4>

<p>最新版的Ubuntu已经进入到稳定版。直接打开商店，搜索Ubuntu，然后安装即可。大概200M的样子，很快就安装了。然后Launch会初始化创建用户。</p>

<p>相关的一些有用的文档：</p>

<ul>
<li><a href="https://msdn.microsoft.com/zh-cn/commandline/wsl/user-support">https://msdn.microsoft.com/zh-cn/commandline/wsl/user-support</a></li>
<li>权限相关 <a href="https://github.com/Microsoft/WSL/issues/81">https://github.com/Microsoft/WSL/issues/81</a></li>
</ul>


<h4>安装mintty</h4>

<ul>
<li><a href="https://superuser.com/questions/1110045/windows-10-bash-and-mintty">https://superuser.com/questions/1110045/windows-10-bash-and-mintty</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/22033219">https://zhuanlan.zhihu.com/p/22033219</a></li>
</ul>


<p>CMD方式操作Ubuntu太难受了，mintty操作就像SecurtCRT一样，简单方便。安装 <a href="https://github.com/mintty/wsltty">wsltty-1.8.0-install</a> ，使用mintty来运行ubuntu。</p>

<p>默认mintty的配置放在 <code>%APPDATA%\wsltty</code>。在子目录theme下可以 <a href="http://ciembor.github.io/4bit/">http://ciembor.github.io/4bit/</a> 下载一个主题放到该目录下，然后再mintty配置页面选择该主题。</p>

<h4>系统文件</h4>

<ul>
<li><a href="https://github.com/Microsoft/WSL/issues/402">https://github.com/Microsoft/WSL/issues/402</a></li>
</ul>


<p>root挂载点：<code>C:\Users\&lt;user&gt;\AppData\Local\lxss</code> or <code>C:\Users\&lt;username&gt;\AppData\Local\Packages\CanonicalGroupLimited.UbuntuonWindows_79rhkp1fndgsc\LocalState</code></p>

<h2>安装Jekyll</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># https://superuser.com/questions/116625/recursively-change-owner-windows-7
</span><span class='line'>#takeown /f "C:\path\to\folder" /r
</span><span class='line'>#icacls "C:\path\to\folder" /reset /T
</span><span class='line'>用powershell管理员权限 "提"权
</span><span class='line'>PS E:\winsegit\octopress&gt; takeown /F . /R
</span><span class='line'>修改就旧系统的文件属性：
</span><span class='line'>PS E:\winsegit\octopress&gt; cacls *.* /T /G Everyone:F
</span><span class='line'>
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install ruby-bundler
</span><span class='line'>sudo apt-get install ruby-dev
</span><span class='line'>sudo apt-get install make
</span><span class='line'>sudo apt-get install gcc
</span><span class='line'>bundle install
</span><span class='line'>
</span><span class='line'>sudo gem update
</span><span class='line'>sudo gem uninstall rake
</span><span class='line'>sudo gem install rake -v 10.5.0
</span><span class='line'>sudo apt-get install nodejs
</span><span class='line'>   
</span><span class='line'>rake preview
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~/winsegit/octopress$ rake preview
</span><span class='line'>/usr/lib/ruby/vendor_ruby/bundler/shared_helpers.rb:78: warning: Insecure world writable dir /mnt/c/Windows/System32 in PATH, mode 040777
</span><span class='line'>Starting to watch source with Jekyll and Compass. Starting Rack on port 4000
</span><span class='line'>/usr/lib/ruby/vendor_ruby/bundler/shared_helpers.rb:78: warning: Insecure world writable dir /mnt/c/Windows/System32 in PATH, mode 040777
</span><span class='line'>/usr/lib/ruby/vendor_ruby/bundler/shared_helpers.rb:78: warning: Insecure world writable dir /mnt/c/Windows/System32 in PATH, mode 040777
</span><span class='line'>/var/lib/gems/2.3.0/gems/liquid-2.6.1/lib/liquid/htmltags.rb:43: warning: key "index0" is duplicated and overwritten on line 46
</span><span class='line'>[2017-10-29 22:48:09] INFO  WEBrick 1.3.1
</span><span class='line'>[2017-10-29 22:48:09] INFO  ruby 2.3.1 (2016-04-26) [x86_64-linux-gnu]
</span><span class='line'>[2017-10-29 22:48:09] INFO  WEBrick::HTTPServer#start: pid=39 port=4000
</span><span class='line'>Configuration file: /mnt/e/winsegit/octopress/_config.yml
</span><span class='line'>            Source: source
</span><span class='line'>       Destination: public
</span><span class='line'>      Generating...
</span><span class='line'>                    done.
</span><span class='line'>                  </span></code></pre></td></tr></table></div></figure>


<p>上面warning提示也有对应的Issue，也没所谓暂时不理： <a href="https://github.com/Microsoft/WSL/issues/1426">https://github.com/Microsoft/WSL/issues/1426</a></p>

<h2>安装docker</h2>

<ul>
<li><a href="https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/#install-docker-ce-1">https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/#install-docker-ce-1</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-ADH7K1Q:~$ uname -r
</span><span class='line'>4.4.0-43-Microsoft
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ uname -a
</span><span class='line'>Linux DESKTOP-ADH7K1Q 4.4.0-43-Microsoft #1-Microsoft Wed Dec 31 14:42:53 PST 2014 x86_64 x86_64 x86_64 GNU/Linux
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$  sudo apt-get install \
</span><span class='line'>     apt-transport-https \
</span><span class='line'>     ca-certificates \
</span><span class='line'>     curl \
</span><span class='line'>     software-properties-common
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ lsb_release -cs
</span><span class='line'>xenial
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
</span><span class='line'>OK
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ sudo add-apt-repository \
</span><span class='line'>   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
</span><span class='line'>   $(lsb_release -cs) \
</span><span class='line'>   stable"
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ sudo apt-get update
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ sudo apt-get install docker-ce
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ sudo service docker start
</span><span class='line'> * Starting Docker: docker                                                                                                                     [ OK ]
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ sudo docker images
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ sudo docker ps
</span><span class='line'>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$
</span></code></pre></td></tr></table></div></figure>


<h2>运行windows系统应用</h2>

<ul>
<li><a href="https://www.howtogeek.com/285082/how-to-run-windows-programs-from-windows-10s-bash-shell/">https://www.howtogeek.com/285082/how-to-run-windows-programs-from-windows-10s-bash-shell/</a></li>
<li><a href="https://github.com/Microsoft/WSL/issues/333">https://github.com/Microsoft/WSL/issues/333</a></li>
<li><a href="https://msdn.microsoft.com/en-us/commandline/wsl/interop">https://msdn.microsoft.com/en-us/commandline/wsl/interop</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-ADH7K1Q:~$ ln -s /mnt/e/local/usr/share/npp/notepad++.exe text
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ cp -r ../winse-cygwin/new_post.sh ./
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ cat new_post.sh
</span><span class='line'>cd ~/winsegit/octopress/
</span><span class='line'>rake new_post["$1"] | tail -1 | awk -F: '{print $2}' | while read line
</span><span class='line'>do
</span><span class='line'>name=${line#source/_posts/}
</span><span class='line'>newpath=source/_stash/$name
</span><span class='line'>mv $line $newpath
</span><span class='line'>
</span><span class='line'>echo -e "\n\n--END" &gt;&gt;$newpath
</span><span class='line'>
</span><span class='line'>~/text $newpath &
</span><span class='line'>done
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ ./new_post.sh "windows run ubuntu"
</span><span class='line'>/usr/lib/ruby/vendor_ruby/bundler/shared_helpers.rb:78: warning: Insecure world writable dir /mnt/c in PATH, mode 040777
</span><span class='line'>mkdir -p source/_posts
</span></code></pre></td></tr></table></div></figure>


<h2>重新配置git</h2>

<p>用powershell修改原来的权限后，然后用shell来进行设置。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#powershell
</span><span class='line'>takeown /F . /R
</span><span class='line'>cacls *.* /T /G Everyone:F
</span><span class='line'>
</span><span class='line'>#ubuntu shell
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ cp -r ../winse-cygwin/.ssh ./
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~$ cd .ssh
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~/.ssh$ chmod 600 id_rsa authorized_keys
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~/.ssh$ chmod 644 id_rsa.pub config
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~/winsegit/octopress/_deploy$ rm -rf *
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~/winsegit/octopress/_deploy$ git clone git@github.com:winse/winse.github.com.git ./
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~/winsegit/octopress$ git config --global user.email winseliu@qq.com
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~/winsegit/octopress$ git config --global user.name winse
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~/winsegit/octopress$ rake preview
</span><span class='line'>winse@DESKTOP-ADH7K1Q:~/winsegit/octopress$ sh public.git.sh
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在Cenots7双击运行程序]]></title>
    <link href="http://winseliu.com/blog/2017/10/28/application-run-do-double-click-on-centos7/"/>
    <updated>2017-10-28T22:58:20+08:00</updated>
    <id>http://winseliu.com/blog/2017/10/28/application-run-do-double-click-on-centos7</id>
    <content type="html"><![CDATA[<p>Linux本来就是作为服务器来运行的，双击运行程序的需求比较少。但是还是有一些，同时也没有Windows桌面快捷方式那么的方便。</p>

<p>在Centos7中建立&#8221;快捷方式&#8221;双击运行，需要建立一个desktop类型的文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~] cat ~/Desktop/Cassandra.desktop
</span><span class='line'>[Desktop Entry]
</span><span class='line'>Name=Cassandra
</span><span class='line'>Comment=Launch Cassandra
</span><span class='line'>Exec=su - hadoop /home/hadoop/apache-cassandra-2.2.10/bin/cassandra -f
</span><span class='line'>Terminal=true
</span><span class='line'>Type=Application
</span></code></pre></td></tr></table></div></figure>


<p>右键创建快捷的方式，在Centos7上面没有找到。</p>

<blockquote><p>In Gnome :
- right click on the desktop and &lsquo;create launcher&rsquo;
- browse to the script location and give a name</p></blockquote>

<h2>参考</h2>

<ul>
<li><a href="https://unix.stackexchange.com/questions/189777/how-to-launch-shell-script-with-double-click-in-centos-7">https://unix.stackexchange.com/questions/189777/how-to-launch-shell-script-with-double-click-in-centos-7</a></li>
<li><a href="https://askubuntu.com/questions/138908/how-to-execute-a-script-just-by-double-clicking-like-exe-files-in-windows">https://askubuntu.com/questions/138908/how-to-execute-a-script-just-by-double-clicking-like-exe-files-in-windows</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用Flamegraph查看磁盘使用情况]]></title>
    <link href="http://winseliu.com/blog/2017/10/28/flamegraph-display-how-disk-be-used/"/>
    <updated>2017-10-28T19:08:14+08:00</updated>
    <id>http://winseliu.com/blog/2017/10/28/flamegraph-display-how-disk-be-used</id>
    <content type="html"><![CDATA[<p>以前有使用FlameGraph做Java程序的堆栈（热点代码）的显示。其实磁盘也可以使用类似的方式来显示查看占用情况，找出没用的数据。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/brendangregg/FlameGraph.git
</span><span class='line'>
</span><span class='line'>#使用管理员权限运行
</span><span class='line'>winse@Lenovo-PC /cygdrive/e/git/FlameGraph
</span><span class='line'>$ ./files.pl /cygdrive/c/ | ./flamegraph.pl --hash --countname=bytes &gt; /cygdrive/r/c.svg
</span></code></pre></td></tr></table></div></figure>


<p>然后浏览器查看即可，主要还是查看占用比。（但是不一定所有文件都包括在SVG里面）。</p>

<p>当然，默认官网提供的 files.pl 是获取所有的目录。我们可以做下层级控制，代码修改如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git diff
</span><span class='line'>diff --git a/files.pl b/files.pl
</span><span class='line'>index 27654be..5d1012e 100755
</span><span class='line'>--- a/files.pl
</span><span class='line'>+++ b/files.pl
</span><span class='line'>@@ -29,7 +29,16 @@ sub usage {
</span><span class='line'> usage() if @ARGV == 0 or $ARGV[0] eq "--help" or $ARGV[0] eq "-h";
</span><span class='line'>
</span><span class='line'> foreach my $dir (@ARGV) {
</span><span class='line'>-    find(\&wanted, $dir);
</span><span class='line'>+    find({
</span><span class='line'>+       preprocess =&gt; \&preprocess,
</span><span class='line'>+       wanted =&gt; \&wanted,
</span><span class='line'>+    }, $dir);
</span><span class='line'>+}
</span><span class='line'>+
</span><span class='line'>+sub preprocess {
</span><span class='line'>+       my $depth = $File::Find::dir =~ tr[/][];
</span><span class='line'>+       return @_ if $depth &lt; 8;
</span><span class='line'>+       return ;
</span><span class='line'> }
</span><span class='line'>
</span><span class='line'> sub wanted {
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://winseliu.com/images/blogs/flamegraph_disk.png" alt="" /></p>

<p>下列的文件夹可以排查下进行处理：</p>

<ul>
<li>C:\pagefile.sys C:\swapfile.sys : 系统属性-高级-性能选项-虚拟内存</li>
<li>C:\hiberfil.sys : powercfg -h -zie 60% ; powercfg.exe /hibernate off</li>
<li>C:\ProgramData\Package Cache</li>
</ul>


<h2>参考</h2>

<ul>
<li><a href="http://www.brendangregg.com/blog/2016-01-20/ebpf-offcpu-flame-graph.html">http://www.brendangregg.com/blog/2016-01-20/ebpf-offcpu-flame-graph.html</a></li>
<li><a href="https://support.microsoft.com/en-us/help/920730/how-to-disable-and-re-enable-hibernation-on-a-computer-that-is-running">https://support.microsoft.com/en-us/help/920730/how-to-disable-and-re-enable-hibernation-on-a-computer-that-is-running</a></li>
<li><a href="http://www.intowindows.com/how-to-reduce-hibernate-file-size-in-windows-7/">http://www.intowindows.com/how-to-reduce-hibernate-file-size-in-windows-7/</a></li>
<li><a href="http://www.brendangregg.com/blog/2017-02-05/file-system-flame-graph.html">http://www.brendangregg.com/blog/2017-02-05/file-system-flame-graph.html</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Docker多主机网络配置 - Macvlan]]></title>
    <link href="http://winseliu.com/blog/2017/10/08/docker-network-via-macvlan/"/>
    <updated>2017-10-08T10:27:54+08:00</updated>
    <id>http://winseliu.com/blog/2017/10/08/docker-network-via-macvlan</id>
    <content type="html"><![CDATA[<h2>参考</h2>

<ul>
<li><a href="https://docs.docker.com/engine/userguide/networking/get-started-macvlan/#macvlan-bridge-mode-example-usage">Get started with Macvlan network driver</a></li>
<li><a href="https://github.com/alfredhuang211/study-docker-doc/blob/master/docker%E8%B7%A8%E4%B8%BB%E6%9C%BAmacvlan%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE.md">docker跨主机macvlan网络配置</a></li>
<li><a href="https://blog.jessfraz.com/post/ips-for-all-the-things/">ip static</a></li>
<li><a href="https://stackoverflow.com/questions/35742807/docker-1-10-containers-ip-in-lan/39285950#39285950">Docker 1.12+ container&rsquo;s IP in LAN</a></li>
<li><a href="http://hustcat.github.io/docker-macvlan/">Docker自定义网络——MacVLAN</a> 这篇内容有点类似pipework。</li>
</ul>


<blockquote><p>Note: In Macvlan you are not able to ping or communicate with the default namespace IP address. For example, if you create a container and try to ping the Docker host’s eth0 it will not work. That traffic is explicitly filtered by the kernel modules themselves to offer additional provider isolation and security.</p></blockquote>

<h2>主机</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kube-master140 ~]# ip addr show ens33
</span><span class='line'>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
</span><span class='line'>    link/ether 00:0c:29:40:2d:15 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.191.140/24 brd 192.168.191.255 scope global dynamic ens33
</span><span class='line'>       valid_lft 1765sec preferred_lft 1765sec
</span><span class='line'>    inet6 fe80::1186:2fe5:9ee5:8790/64 scope link 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>
</span><span class='line'>[root@kube-worker141 ~]# ip addr show ens33
</span><span class='line'>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
</span><span class='line'>    link/ether 00:0c:29:2e:67:4d brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.191.141/24 brd 192.168.191.255 scope global dynamic ens33
</span><span class='line'>       valid_lft 1779sec preferred_lft 1779sec
</span><span class='line'>    inet6 fe80::dd23:1df6:b37:efae/64 scope link 
</span><span class='line'>       valid_lft forever preferred_lft forever</span></code></pre></td></tr></table></div></figure>


<h2>创建网络</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kube-worker141 ~]# docker network create \
</span><span class='line'>-d macvlan \
</span><span class='line'>--subnet=192.168.191.0/24 \
</span><span class='line'>--gateway=192.168.191.2 \
</span><span class='line'>-o parent=ens33 pub_net
</span><span class='line'>4370998ed03024bc0057a894f1280d5b0fcdba526fd9e8da612a3abb0dbc884b
</span><span class='line'>
</span><span class='line'>[root@kube-worker141 ~]# docker network list 
</span><span class='line'>NETWORK ID          NAME                DRIVER              SCOPE
</span><span class='line'>eee9236a36ba        bridge              bridge              local               
</span><span class='line'>ddc7f59215c1        host                host                local               
</span><span class='line'>d8dc7fbc40a6        none                null                local               
</span><span class='line'>4370998ed030        pub_net             macvlan             local               
</span><span class='line'>
</span><span class='line'>[root@kube-worker141 ~]# docker network inspect pub_net
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h2>使用</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker rm -f $( docker ps -a | grep -v IMAGE | awk '{print $1}' ) 
</span><span class='line'>
</span><span class='line'>[root@kube-worker141 ~]# docker run --net=pub_net --ip=192.168.191.200 --name c200 -tid busybox /bin/sh
</span><span class='line'>2e0a2ede40e80a2f1739330bb3a6c45b91ea08d78d26d165ad13945bedbea40f
</span><span class='line'>
</span><span class='line'>[root@kube-worker141 ~]# docker ps 
</span><span class='line'>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</span><span class='line'>2e0a2ede40e8        busybox             "/bin/sh"           13 seconds ago      Up 11 seconds                           c200
</span><span class='line'>[root@kube-worker141 ~]# docker exec c200 ifconfig 
</span><span class='line'>eth0      Link encap:Ethernet  HWaddr 02:42:C0:A8:BF:C8  
</span><span class='line'>          inet addr:192.168.191.200  Bcast:0.0.0.0  Mask:255.255.255.0
</span><span class='line'>          inet6 addr: fe80::42:c0ff:fea8:bfc8/64 Scope:Link
</span><span class='line'>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</span><span class='line'>          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>          collisions:0 txqueuelen:0 
</span><span class='line'>          RX bytes:0 (0.0 B)  TX bytes:648 (648.0 B)
</span><span class='line'>
</span><span class='line'>lo        Link encap:Local Loopback  
</span><span class='line'>          inet addr:127.0.0.1  Mask:255.0.0.0
</span><span class='line'>          inet6 addr: ::1/128 Scope:Host
</span><span class='line'>          UP LOOPBACK RUNNING  MTU:65536  Metric:1
</span><span class='line'>          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>          collisions:0 txqueuelen:1 
</span><span class='line'>          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
</span><span class='line'>
</span><span class='line'>[root@kube-worker141 ~]# docker exec c200 route -n
</span><span class='line'>Kernel IP routing table
</span><span class='line'>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span><span class='line'>0.0.0.0         192.168.191.2   0.0.0.0         UG    0      0        0 eth0
</span><span class='line'>192.168.191.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0
</span><span class='line'>[root@kube-worker141 ~]# docker exec c200 ping baidu.com 
</span><span class='line'>PING baidu.com (111.13.101.208): 56 data bytes
</span><span class='line'>64 bytes from 111.13.101.208: seq=0 ttl=128 time=45.029 ms
</span><span class='line'>64 bytes from 111.13.101.208: seq=1 ttl=128 time=44.616 ms
</span><span class='line'>
</span><span class='line'>#201
</span><span class='line'>[root@kube-worker141 ~]# docker run --net=pub_net --ip=192.168.191.201 -tid busybox /bin/sh 
</span><span class='line'>c8cfd3443f2b7b3973a06470cb95442eadface8d89c8cb1749ad73ebbd7e9e39
</span><span class='line'>
</span><span class='line'>##本地容器互通: 
</span><span class='line'>#: HOST141-200 ping HOST141-201
</span><span class='line'>[root@kube-worker141 ~]# docker exec c200 ping -W 10 192.168.191.201
</span><span class='line'>PING 192.168.191.201 (192.168.191.201): 56 data bytes
</span><span class='line'>64 bytes from 192.168.191.201: seq=0 ttl=64 time=0.523 ms
</span><span class='line'>
</span><span class='line'>#210 
</span><span class='line'>[root@kube-master ~]# docker run --net=pub_net --ip=192.168.191.210 -tid busybox /bin/sh 
</span><span class='line'>7929c136c3dbc646b68b3b7302e8525a25fe2f583db2246fea0da85a448b7b78
</span><span class='line'>
</span><span class='line'>##B访问A主机的容器: 
</span><span class='line'>#: HOST140 ping HOST141-201 
</span><span class='line'>[root@kube-master140 ~]# ping 192.168.191.201 
</span><span class='line'>PING 192.168.191.201 (192.168.191.201) 56(84) bytes of data.
</span><span class='line'>64 bytes from 192.168.191.201: icmp_seq=1 ttl=64 time=1.44 ms
</span><span class='line'>
</span><span class='line'>##A主机容器访问B主机容器: 
</span><span class='line'>#: HOST141-200 ping HOST140-210
</span><span class='line'>[root@kube-worker141 ~]# docker exec c200 ping -W 10 192.168.191.210
</span><span class='line'>PING 192.168.191.210 (192.168.191.210): 56 data bytes
</span><span class='line'>64 bytes from 192.168.191.210: seq=0 ttl=64 time=2.049 ms
</span><span class='line'>64 bytes from 192.168.191.210: seq=1 ttl=64 time=0.993 ms
</span><span class='line'>
</span><span class='line'>#主机与所在容器互相不能访问 (--!): 
</span><span class='line'>#: HOST141 ping HOST141-200
</span><span class='line'>[root@kube-worker141 ~]# ping 192.168.191.200
</span><span class='line'>PING 192.168.191.200 (192.168.191.200) 56(84) bytes of data.
</span><span class='line'>From 192.168.191.141 icmp_seq=1 Destination Host Unreachable
</span><span class='line'>From 192.168.191.141 icmp_seq=2 Destination Host Unreachable
</span><span class='line'>#: HOST141-200 ping HOST141
</span><span class='line'>[root@kube-worker1 ~]# docker exec c200 ping 192.168.191.141
</span></code></pre></td></tr></table></div></figure>


<p>针对主机与本机容器不能互通的问题，可以增加一张默认的网卡：<a href="https://success.docker.com/KBase/Multiple_Docker_Networks">Multiple Docker Networks</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#先通过默认网络创建
</span><span class='line'>[root@kube-worker1 ~]# docker run --name c200 -tid busybox /bin/sh                                   
</span><span class='line'>47b7c1813b95cbec471b1a6de6a870e5537cfa70d54120873a5edb4e444b373b
</span><span class='line'>#然后连接pub_net！
</span><span class='line'>[root@kube-worker1 ~]# docker network connect --ip=192.168.191.200 pub_net c200        
</span><span class='line'>[root@kube-worker1 ~]# docker exec c200 ip a
</span><span class='line'>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1
</span><span class='line'>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class='line'>    inet 127.0.0.1/8 scope host lo
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 ::1/128 scope host 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>14: eth0@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue 
</span><span class='line'>    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 172.18.0.2/16 scope global eth0
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 fe80::42:acff:fe12:2/64 scope link 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>16: eth1@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue 
</span><span class='line'>    link/ether 02:42:c0:a8:bf:c8 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.191.200/24 scope global eth1
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 fe80::42:c0ff:fea8:bfc8/64 scope link 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>       </span></code></pre></td></tr></table></div></figure>


<p>方式1：</p>

<p>与主机的通信，通过 172.18.0.0/24 的网络。其他的通过 192.168.191.0/24 。还是感觉有点鸡肋！！</p>

<p>方式2：</p>

<p>增加route：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#route add -host $container_ip gw $lan_router_ip $if_device_nic2
</span><span class='line'>
</span><span class='line'>[root@kube-worker1 ~]# route add -net 192.168.191.200 gw 172.18.0.1 netmask 255.255.255.255 dev docker0
</span><span class='line'>[root@kube-worker1 ~]# route -n
</span><span class='line'>Kernel IP routing table
</span><span class='line'>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span><span class='line'>0.0.0.0         192.168.191.2   0.0.0.0         UG    100    0        0 ens33
</span><span class='line'>172.17.3.0      192.168.191.140 255.255.255.0   UG    100    0        0 ens33
</span><span class='line'>172.17.4.0      0.0.0.0         255.255.255.0   U     425    0        0 kbr0
</span><span class='line'>172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
</span><span class='line'>192.168.191.0   0.0.0.0         255.255.255.0   U     100    0        0 ens33
</span><span class='line'>192.168.191.200 172.18.0.1      255.255.255.255 UGH   0      0        0 docker0
</span><span class='line'>[root@kube-worker1 ~]# ping 192.168.191.200
</span><span class='line'>PING 192.168.191.200 (192.168.191.200) 56(84) bytes of data.
</span><span class='line'>64 bytes from 192.168.191.200: icmp_seq=1 ttl=64 time=0.239 ms
</span><span class='line'>64 bytes from 192.168.191.200: icmp_seq=2 ttl=64 time=0.106 ms
</span><span class='line'>^C
</span><span class='line'>--- 192.168.191.200 ping statistics ---
</span><span class='line'>2 packets transmitted, 2 received, 0% packet loss, time 1000ms
</span><span class='line'>rtt min/avg/max/mdev = 0.106/0.172/0.239/0.067 ms
</span></code></pre></td></tr></table></div></figure>


<p>通过操作与pipework比较，互有优劣：</p>

<ul>
<li>pipework会创建网卡，然后所有的ip都是互通的，但是绑定、还得把主机的ip配置到br0上。</li>
<li>而docker-network的方式与主机互通需要做额外的配置。</li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Docker多主机网络配置 - Pipework]]></title>
    <link href="http://winseliu.com/blog/2017/10/07/docker-network-via-pipework/"/>
    <updated>2017-10-07T23:24:23+08:00</updated>
    <id>http://winseliu.com/blog/2017/10/07/docker-network-via-pipework</id>
    <content type="html"><![CDATA[<p>前面使用nat+route的方式手动连通两台机器上的docker容器。pipework是通过脚本的方式（手动）设置网络以及修改路由来进行配置的。</p>

<p>参考：</p>

<ul>
<li><a href="http://www.infoq.com/cn/articles/docker-network-and-pipework-open-source-explanation-practice">Docker网络详解及pipework源码解读与实践</a></li>
<li><a href="http://hongge.blog.51cto.com/2083180/1843169">docker技术剖析&ndash;docker网络（二）docker宿主机之间容器互通 for centos7.2</a> 步骤更详细一点</li>
<li><a href="http://tonybai.com/2016/02/15/understanding-docker-multi-host-networking/">理解Docker跨多主机容器网络</a></li>
</ul>


<blockquote><p>2、将物理网卡桥接到虚拟网桥，使得容器与宿主机配置在同一网段下</p>

<p>在各个宿主机上都建立一个新虚拟网桥设备br0，将各自物理网卡eth0桥接br0上，eth0的IP地址赋给br0；同时修改Docker daemon的DOCKER_OPTS，设置-b=br0（替代docker0），并限制Container IP地址的分配范围为同物理段地址（–fixed-cidr）。重启各个主机的Docker Daemon后，处于与宿主机在同一网段的Docker容器就可以实现跨主机访问了。这个方案同样存在局限和扩展性差的问题：比如需将物理网段的地址划分 成小块，分布到各个主机上，防止IP冲突；子网划分依赖物理交换机设置；Docker容器的主机地址空间大小依赖物理网络划分等。</p></blockquote>

<p>原理就是建立一条连接link，一端 <strong> 在主机 </strong> 一端 <strong> 在容器 </strong> ；然后手动配置容器ip和路由；最后把主机Ethernet和新建的Bridge桥接连接到物理网络。</p>

<p>容器的ip地址和主机的ip地址在一个网段内，所以在同一交换机下的所有主机、里面的容器都互通。</p>

<h2>查看原网络的信息：</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kube-worker1 ~]# nmcli d show ens33 
</span><span class='line'>GENERAL.DEVICE:                         ens33
</span><span class='line'>GENERAL.TYPE:                           ethernet
</span><span class='line'>GENERAL.HWADDR:                         00:0C:29:2E:67:4D
</span><span class='line'>GENERAL.MTU:                            1500
</span><span class='line'>GENERAL.STATE:                          100 (connected)
</span><span class='line'>GENERAL.CONNECTION:                     ens33
</span><span class='line'>GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveConnection/0
</span><span class='line'>WIRED-PROPERTIES.CARRIER:               on
</span><span class='line'>IP4.ADDRESS[1]:                         192.168.191.141/24
</span><span class='line'>IP4.GATEWAY:                            192.168.191.2
</span><span class='line'>IP4.ROUTE[1]:                           dst = 172.17.3.0/24, nh = 192.168.191.140, mt = 100
</span><span class='line'>IP4.DNS[1]:                             192.168.191.2
</span><span class='line'>IP4.DOMAIN[1]:                          localdomain
</span><span class='line'>IP6.ADDRESS[1]:                         fe80::3995:4490:e2e7:1d0f/64
</span><span class='line'>IP6.GATEWAY:                            </span></code></pre></td></tr></table></div></figure>


<h2>安装pipework</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/jpetazzo/pipework
</span><span class='line'>cp ~/pipework/pipework /usr/local/bin/</span></code></pre></td></tr></table></div></figure>


<h2>运行docker</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#设置ip转发
</span><span class='line'>echo 1 &gt; /proc/sys/net/ipv4/ip_forward
</span><span class='line'>
</span><span class='line'>vi /etc/sysctl.conf
</span><span class='line'>net.ipv4.ip_forward = 1  
</span><span class='line'>
</span><span class='line'>NAME=test1
</span><span class='line'>
</span><span class='line'>#如不需要安装软件，可以加 --net none
</span><span class='line'>docker run -itd --name $NAME centos /bin/bash
</span><span class='line'>
</span><span class='line'>#docker ps -a -f name=$NAME | grep $NAME && docker start $NAME 
</span><span class='line'>#docker exec test1 yum install -y iproute net-tools </span></code></pre></td></tr></table></div></figure>


<h2>配置网络</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function docker_container_ip () {
</span><span class='line'>  local name=$1
</span><span class='line'>  local ip=$2
</span><span class='line'>  local gateway=${3:-$GATEWAY}
</span><span class='line'>  
</span><span class='line'>  pipework br0 $name $ip@$gateway
</span><span class='line'>  #docker exec $name ifconfig 
</span><span class='line'>  #docker exec $name route -n 
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>function docker_hosted_bridge_network_reset () {
</span><span class='line'>  local ip=$1
</span><span class='line'>  local gateway=$2
</span><span class='line'>  local iface=$3
</span><span class='line'>  
</span><span class='line'>  if nmcli d show $iface | grep -i ethernet ; then
</span><span class='line'>    #把地址给网桥，然后把ethernet和bridge连起来：(SSH连接操作的话，需要一条命令搞定！修改br0地址后route会变)
</span><span class='line'>    ip addr add $ip dev br0 ; \
</span><span class='line'>    ip addr del $ip dev $iface ; \
</span><span class='line'>    brctl addif br0 $iface ; \
</span><span class='line'>    #ip route del default ; \
</span><span class='line'>    ip route add default via $gateway 
</span><span class='line'>  fi 
</span><span class='line'>  
</span><span class='line'>  brctl show br0
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>GATEWAY=$( route -n | grep '^0.0.0.0' | awk '{print $2}' )
</span><span class='line'>IFACE=$( route -n | grep '^0.0.0.0' | awk '{print $8}' )
</span><span class='line'>HOSTED_IPADDR=$( ip addr show $IFACE | grep "inet " | awk '{print $2}' )
</span></code></pre></td></tr></table></div></figure>


<p>设置容器的IP：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NAME=test1
</span><span class='line'>IP=192.168.191.210/24
</span><span class='line'>
</span><span class='line'>docker_container_ip $NAME $IP $GATEWAY
</span><span class='line'>docker_hosted_bridge_network_reset $HOSTED_IPADDR $GATEWAY $IFACE</span></code></pre></td></tr></table></div></figure>


<p>上面的方式配置方式<strong>重启就失效</strong>的，可以通过写配置文件的方式来永久生效。如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kube-worker1 ~]# cat /etc/sysconfig/network-scripts/ifcfg-ens33 
</span><span class='line'>TYPE=Ethernet
</span><span class='line'>DEVICE=ens33
</span><span class='line'>BRIDGE=br0
</span><span class='line'>[root@kube-worker1 ~]# cat /etc/sysconfig/network-scripts/ifcfg-br0 
</span><span class='line'>DEVICE=br0
</span><span class='line'>TYPE=Bridge
</span><span class='line'>ONBOOT=yes
</span><span class='line'>BOOTPROTO=static
</span><span class='line'>IPADDR=192.168.191.141
</span><span class='line'>NETMASK=255.255.255.0
</span><span class='line'>GATEWAY=192.168.191.2
</span><span class='line'>DNS1=192.168.191.2
</span><span class='line'>
</span><span class='line'>USERCTL=no</span></code></pre></td></tr></table></div></figure>


<h2>测试</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kube-worker1 ~]# screen
</span><span class='line'>
</span><span class='line'>  GATEWAY=$( route -n | grep '^0.0.0.0' | awk '{print $2}' )
</span><span class='line'>  IFACE=$( route -n | grep '^0.0.0.0' | awk '{print $8}' )
</span><span class='line'>  HOSTED_IPADDR=$( ip addr show $IFACE | grep "inet " | awk '{print $2}' )
</span><span class='line'>
</span><span class='line'>  docker run -itd --name test21 centos /bin/bash
</span><span class='line'>  docker run -itd --name test22 centos /bin/bash
</span><span class='line'>
</span><span class='line'>  docker_container_ip test21 192.168.191.231/24 $GATEWAY
</span><span class='line'>  docker_container_ip test22 192.168.191.232/24 $GATEWAY
</span><span class='line'>
</span><span class='line'>  docker exec test21 ping  192.168.191.140
</span><span class='line'>  docker exec test21 ping  192.168.191.141
</span><span class='line'>
</span><span class='line'>[root@kube-master ~]# screen #会话"不断"
</span><span class='line'>
</span><span class='line'>  docker_container_ip test11 192.168.191.221/24 $GATEWAY 
</span><span class='line'>  docker_container_ip test12 192.168.191.222/24 $GATEWAY
</span><span class='line'>
</span><span class='line'>  docker_hosted_bridge_network_reset $HOSTED_IPADDR $GATEWAY $IFACE
</span><span class='line'>
</span><span class='line'>  docker exec test11 ping 192.168.191.233</span></code></pre></td></tr></table></div></figure>


<p>注意：容器重启后，这些配置的网卡/路由都没有了，要重新配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kube-worker1 ~]# docker stop test21
</span><span class='line'>test21
</span><span class='line'>[root@kube-worker1 ~]# docker start test21
</span><span class='line'>test21
</span><span class='line'>[root@kube-worker1 ~]# pipework route test21 show 
</span><span class='line'>default via 172.18.0.1 dev eth0 
</span><span class='line'>172.18.0.0/16 dev eth0  proto kernel  scope link  src 172.18.0.2 
</span><span class='line'>
</span><span class='line'>[root@kube-worker1 ~]# docker_container_ip test21 192.168.191.231/24 $GATEWAY
</span><span class='line'>[root@kube-worker1 ~]# pipework route test21 show                            
</span><span class='line'>default via 192.168.191.2 dev eth1 
</span><span class='line'>172.18.0.0/16 dev eth0  proto kernel  scope link  src 172.18.0.2 
</span><span class='line'>192.168.191.0/24 dev eth1  proto kernel  scope link  src 192.168.191.231 
</span><span class='line'>
</span><span class='line'>[root@kube-worker1 ~]# docker exec test21 ping 192.168.191.140</span></code></pre></td></tr></table></div></figure>


<p>了解原理后，操作起来还是比较容易的。就是每次重启都要重新配置比较烦。可以写成脚本，启动docker容器的时刻就执行下网络配置。</p>

<p>pipework还可以用来配置vlan，暂时没这个需求，并且基本的操作都类似就没有实际操作了。</p>

<p>话说，<strong> pipework还可以用来创建多网卡的容器。用docker network connect其实更简单。 </strong></p>

<h2>后记</h2>

<p>除了通过pipework来实现共享物理网络外，docker network也可以实现这个功能：</p>

<ul>
<li><a href="https://stackoverflow.com/questions/35742807/docker-1-10-containers-ip-in-lan/35799206#35799206">Docker 1.10 container&rsquo;s IP in LAN</a></li>
<li><p><a href="https://gist.github.com/dreamcat4/bc202ae175b367bcbe693da7a52851af">using bridge driver and brctrl.md</a> 感觉原理也类似pipework，就是那一堆的netns让 docker network + docker run &ndash;net 实现了而已。</p></li>
<li><p>建立并配置Bridge：</p></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#中间会导致网络断掉，一条命令搞定才行
</span><span class='line'>docker network create --gateway=192.168.191.141 --subnet 192.168.191.0/24 --aux-address "DefaultGatewayIPv4=192.168.191.2" -o com.docker.network.bridge.name=br-home-net homenet ; \
</span><span class='line'>ip addr del 192.168.191.141/24 dev ens33 ; \
</span><span class='line'>brctl addif br-home-net ens33 
</span><span class='line'>
</span><span class='line'>#主机不上外网可以不加
</span><span class='line'>ip route add default via 192.168.191.2 ; 
</span><span class='line'>echo "nameserver 114.114.114.114" &gt;&gt;/etc/resolv.conf ; </span></code></pre></td></tr></table></div></figure>


<ul>
<li>测试 docker-net + bridge：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kube-worker1 ~]# ip a
</span><span class='line'>...
</span><span class='line'>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master br-home-net state UP qlen 1000
</span><span class='line'>    link/ether 00:0c:29:2e:67:4d brd ff:ff:ff:ff:ff:ff
</span><span class='line'>4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN 
</span><span class='line'>    link/ether 02:42:44:ef:32:28 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 172.18.0.1/16 scope global docker0
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>11: br-home-net: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP 
</span><span class='line'>    link/ether 02:42:84:97:c2:25 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.191.141/24 scope global br-home-net
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>    inet6 fe80::42:84ff:fe97:c225/64 scope link 
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>       
</span><span class='line'>[root@kube-worker1 ~]# docker run -tid --name c200 --net homenet --ip 192.168.191.200 busybox /bin/sh 
</span><span class='line'>2579c2ddd18d23322eb1e145ad630205933dbc527b8981169ec6b125da8d8f1e
</span><span class='line'>
</span><span class='line'>[root@kube-worker1 ~]# docker exec -ti c200 sh 
</span><span class='line'>/ # ip a
</span><span class='line'>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1
</span><span class='line'>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class='line'>    inet 127.0.0.1/8 scope host lo
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>12: eth0@if13: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue 
</span><span class='line'>    link/ether 02:42:c0:a8:bf:c8 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.191.200/24 scope global eth0
</span><span class='line'>       valid_lft forever preferred_lft forever
</span><span class='line'>/ # route -n
</span><span class='line'>Kernel IP routing table
</span><span class='line'>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span><span class='line'>0.0.0.0         192.168.191.2   0.0.0.0         UG    0      0        0 eth0
</span><span class='line'>192.168.191.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0
</span><span class='line'>/ # ping baidu.com 
</span><span class='line'>PING baidu.com (111.13.101.208): 56 data bytes
</span><span class='line'>64 bytes from 111.13.101.208: seq=0 ttl=128 time=48.225 ms
</span><span class='line'>^C
</span><span class='line'>--- baidu.com ping statistics ---
</span><span class='line'>1 packets transmitted, 1 packets received, 0% packet loss
</span><span class='line'>round-trip min/avg/max = 48.225/48.225/48.225 ms
</span><span class='line'>/ # ping 192.169.191.140
</span><span class='line'>PING 192.169.191.140 (192.169.191.140): 56 data bytes
</span><span class='line'>^C
</span><span class='line'>--- 192.169.191.140 ping statistics ---
</span><span class='line'>4 packets transmitted, 0 packets received, 100% packet loss
</span><span class='line'>/ # ping 192.168.191.140
</span><span class='line'>PING 192.168.191.140 (192.168.191.140): 56 data bytes
</span><span class='line'>64 bytes from 192.168.191.140: seq=0 ttl=64 time=2.572 ms
</span><span class='line'>64 bytes from 192.168.191.140: seq=1 ttl=64 time=1.076 ms
</span><span class='line'>^C
</span><span class='line'>--- 192.168.191.140 ping statistics ---
</span><span class='line'>2 packets transmitted, 2 packets received, 0% packet loss
</span><span class='line'>round-trip min/avg/max = 1.076/1.824/2.572 ms
</span><span class='line'>/ # ping 192.168.191.141
</span><span class='line'>PING 192.168.191.141 (192.168.191.141): 56 data bytes
</span><span class='line'>64 bytes from 192.168.191.141: seq=0 ttl=64 time=0.474 ms
</span><span class='line'>64 bytes from 192.168.191.141: seq=1 ttl=64 time=0.138 ms
</span><span class='line'>^C
</span><span class='line'>--- 192.168.191.141 ping statistics ---
</span><span class='line'>2 packets transmitted, 2 packets received, 0% packet loss
</span><span class='line'>round-trip min/avg/max = 0.138/0.306/0.474 ms
</span><span class='line'>/ # ping 192.168.191.1
</span><span class='line'>PING 192.168.191.1 (192.168.191.1): 56 data bytes
</span><span class='line'>64 bytes from 192.168.191.1: seq=0 ttl=128 time=1.068 ms
</span><span class='line'>64 bytes from 192.168.191.1: seq=1 ttl=128 time=0.603 ms
</span><span class='line'>^C
</span><span class='line'>--- 192.168.191.1 ping statistics ---
</span><span class='line'>2 packets transmitted, 2 packets received, 0% packet loss
</span><span class='line'>round-trip min/avg/max = 0.603/0.835/1.068 ms
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[STAF Start Guide]]></title>
    <link href="http://winseliu.com/blog/2017/10/06/staf-start-guide/"/>
    <updated>2017-10-06T08:07:49+08:00</updated>
    <id>http://winseliu.com/blog/2017/10/06/staf-start-guide</id>
    <content type="html"><![CDATA[<p>STAF(Software Testing Automation Framework) 是用来构建自动化测试的框架，用来部署测试环境。包括跨平台自动化部署的各种组件：config、process、handle、fs、log、monitor、queue、var、security等各种服务，还可以轻松的扩展。机器通过STAFProc启动的端口来进行通讯（set、query等）。</p>

<blockquote><p>STAF的作用实际上就是提供了机器之间的通信通道并提供基于这个通道的基础服务。</p></blockquote>

<h2>安装</h2>

<ul>
<li><a href="http://staf.sourceforge.net/current/STAFInstall.pdf">http://staf.sourceforge.net/current/STAFInstall.pdf</a></li>
<li><a href="http://blog.csdn.net/lsj6730960/article/details/6186861">STAF的原理及使用</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/opensource/os-test-stafstax/index.html">使用 STAF/STAX 实现测试自动化和持续集成</a></li>
</ul>


<p>直接用 <a href="http://staf.sourceforge.net/getcurrent.php">InstallAnywhere（IA）</a> 的方式安装。文档介绍了整个安装过程中做的所有事情，非常非常的详细。下面针对Linux的安装配置步骤：</p>

<ul>
<li>安装配置项（选项），三种方式选一种：
  交互方式
  文件方式
  默认值</li>
<li>环境变量：使用InstallAnywhere的方式会把环境变量配置好，文档中介绍了使用的环境变量。</li>
<li>启动：shell脚本、开机启动（centos7的服务配置可以参考文档的[Fedora 15 and later]部分）</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#安装（默认值）
</span><span class='line'>./STAF3426-setup-linux-amd64-NoJVM.bin -i silent -DACCEPT_LICENSE=1
</span><span class='line'>
</span><span class='line'>#启动
</span><span class='line'>su -
</span><span class='line'>/usr/local/staf/bin/STAFProc
</span><span class='line'>或者
</span><span class='line'>./startSTAFProc.sh 
</span><span class='line'>
</span><span class='line'>#测试
</span><span class='line'>[root@cdb1 staf]# staf local ping ping
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>PONG
</span><span class='line'>[root@cdb1 staf]# staf local process start command ifconfig
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>5
</span><span class='line'>#程序运行产生的输出是在运行的机器上的！
</span><span class='line'>[root@cdb1 staf]# less nohup.out 
</span><span class='line'>
</span><span class='line'>Machine          : cdb1
</span><span class='line'>Machine nickname : cdb1
</span><span class='line'>Startup time     : 20171006-08:50:55
</span><span class='line'>
</span><span class='line'>STAFProc version 3.4.26 initialized
</span><span class='line'>ens192: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span><span class='line'>        inet 192.168.193.101  netmask 255.255.192.0  broadcast 192.168.255.255
</span><span class='line'>        inet6 fe80::932a:7b98:cc20:f791  prefixlen 64  scopeid 0x20&lt;link&gt;
</span><span class='line'>        inet6 fe80::9ba3:ce9e:cc9c:477d  prefixlen 64  scopeid 0x20&lt;link&gt;
</span><span class='line'>        inet6 fe80::7d8c:b318:d441:70b2  prefixlen 64  scopeid 0x20&lt;link&gt;
</span><span class='line'>        ether 00:50:56:92:26:93  txqueuelen 1000  (Ethernet)
</span><span class='line'>        RX packets 11020400  bytes 3439058707 (3.2 GiB)
</span><span class='line'>        RX errors 0  dropped 717  overruns 0  frame 0
</span><span class='line'>        TX packets 9067587  bytes 3110097659 (2.8 GiB)
</span><span class='line'>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span><span class='line'>
</span><span class='line'>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
</span><span class='line'>        inet 127.0.0.1  netmask 255.0.0.0
</span><span class='line'>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
</span><span class='line'>        loop  txqueuelen 1  (Local Loopback)
</span><span class='line'>        RX packets 70483  bytes 10164575 (9.6 MiB)
</span><span class='line'>        RX errors 0  dropped 0  overruns 0  frame 0
</span><span class='line'>        TX packets 70483  bytes 10164575 (9.6 MiB)
</span><span class='line'>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#多机测试
</span><span class='line'>[root@cdb2 staf]# vi bin/STAF.cfg
</span><span class='line'>trust machine 192.168.193.101 level 5
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf cdb2 ping ping 
</span><span class='line'>[root@cdb1 staf]# staf cdb2 process start command ifconfig 
</span><span class='line'>[root@cdb2 staf]# less nohup.out 
</span><span class='line'>
</span><span class='line'>#安全退出
</span><span class='line'>STAF local SHUTDOWN SHUTDOWN
</span><span class='line'>C:\STAF\bin\STAF.exe local SHUTDOWN SHUTDOWN
</span></code></pre></td></tr></table></div></figure>


<h2>Getting Started</h2>

<p><a href="http://staf.sourceforge.net/current/STAFGS.pdf">http://staf.sourceforge.net/current/STAFGS.pdf</a></p>

<p>STAFGS 对所有的知识点都做了简单的介绍和归纳。更详细的需要看 User Guide 文档。</p>

<p>STAF is an Open Source automation framework designed around the idea of reusable components. It is intended to make it
easier to create automated testcases and workloads. STAF can help you increase the efficiency, productivity, and quality of
your testing by improving your level of automation and reuse in your individual testcases as well as your overall test
environment.</p>

<p>STAF operates in a peer-to-peer environment; in other words, there is no client-server hierarchy among machines
running STAF.</p>

<h4>Basic STAF Concepts</h4>

<p>STAF Instances
Since multiple instances of STAF can be run at the same time on the same system, a STAF Instance name is used to
specify a name for each STAF instance. You specify the instance name to be used by setting the environment variable
STAF_INSTANCE_NAME. The default instance name is &ldquo;STAF&rdquo;.</p>

<p>A basic description of each level follows</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Level 0 - No access
</span><span class='line'>Level 1 - Restricted access. Only PING and helps available.
</span><span class='line'>Level 2 - Limited access. Only query/view facilities available.
</span><span class='line'>Level 3 - Standard access. Non-destructive updates allowed, e.g., logging.
</span><span class='line'>Level 4 - Advanced access. Update abilities, e.g., copying files, deleting log files.
</span><span class='line'>Level 5 - All access, e.g., SHUTDOWN, Process invocation, Trust definition manipulation</span></code></pre></td></tr></table></div></figure>


<p>STAF requests submitted from the command line are generally used to query information from STAF services.</p>

<h4>STAF Commands</h4>

<p>You can also start STAFProc by simply typing STAFProc at a command prompt
window. ( /usr/local/staf/bin is in your PATH )</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>STAF  &lt;Endpoint&gt;/[&lt;Interface&gt;://]&lt;System Identifier&gt;[@&lt;Port&gt;]  &lt;Service&gt; &lt;Request&gt;
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local ping ping 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>PONG
</span><span class='line'>#没运行
</span><span class='line'>[root@cdb1 staf]# staf cdb2 ping ping 
</span><span class='line'>Error submitting request, RC: 16
</span><span class='line'>Additional info
</span><span class='line'>---------------
</span><span class='line'>STAFConnectionProviderConnect: Error performing test read on connected endpoint: recv() RC=111: 22, Endpoint: ssl://cdb2
</span><span class='line'>[root@cdb1 staf]# staf cdb2 ping ping 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>PONG
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local service help 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>*** SERVICE Service Help ***
</span><span class='line'>
</span><span class='line'>LIST    [ SERVICES | SERVICELOADERS | AUTHENTICATORS |
</span><span class='line'>          REQUESTS &lt;[PENDING] [COMPLETE] [LONG]&gt; | [SUMMARY] ]
</span><span class='line'>QUERY   SERVICE &lt;Service Name&gt; | SERVICELOADER &lt;ServiceLoader Name&gt; |
</span><span class='line'>        AUTHENTICATOR &lt;Authenticator Name&gt; | REQUEST &lt;Request Number&gt;
</span><span class='line'>ADD     SERVICE &lt;Service Name&gt; LIBRARY &lt;Library Name&gt;
</span><span class='line'>        [EXECUTE &lt;Executable&gt;] [OPTION &lt;Name[=Value]&gt;]...
</span><span class='line'>        [PARMS &lt;Parameters&gt;]
</span><span class='line'>REMOVE  SERVICE &lt;Service Name&gt;
</span><span class='line'>FREE    REQUEST &lt;Request Number&gt; [FORCE]
</span><span class='line'>HELP
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local shutdown help 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>*** SHUTDOWN Service Help ***
</span><span class='line'>
</span><span class='line'>SHUTDOWN
</span><span class='line'>
</span><span class='line'>NOTIFY REGISTER   [MACHINE &lt;Machine&gt;] [HANDLE &lt;Handle&gt; | NAME &lt;Name&gt;]
</span><span class='line'>                  [PRIORITY &lt;Priority&gt;]
</span><span class='line'>NOTIFY UNREGISTER [MACHINE &lt;Machine&gt;] [HANDLE &lt;Handle&gt; | NAME &lt;Name&gt;]
</span><span class='line'>                  [PRIORITY &lt;Priority&gt;]
</span><span class='line'>NOTIFY LIST
</span><span class='line'>
</span><span class='line'>HELP
</span><span class='line'>
</span><span class='line'>&gt;&gt;&gt;&gt; The information returned by Help show us the options we can place after "STAF local shutdown ....." 
</span><span class='line'>in command requests
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local service list 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>Name      Library    Executable
</span><span class='line'>--------- ---------- ----------
</span><span class='line'>CONFIG    &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>DELAY     &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>DIAG      &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>ECHO      &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>FS        &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>HANDLE    &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>HELP      &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>LIFECYCLE &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>MISC      &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>PING      &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>PROCESS   &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>QUEUE     &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>SEM       &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>SERVICE   &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>SHUTDOWN  &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>TRACE     &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>TRUST     &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>VAR       &lt;Internal&gt; &lt;None&gt;    
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local var list 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>STAF/Config/BootDrive             : /
</span><span class='line'>STAF/Config/CodePage              : UTF-8
</span><span class='line'>STAF/Config/ConfigFile            : /usr/local/staf/bin/STAF.cfg
</span><span class='line'>STAF/Config/DefaultAuthenticator  : none
</span><span class='line'>STAF/Config/DefaultInterface      : ssl
</span><span class='line'>STAF/Config/InstanceName          : STAF
</span><span class='line'>STAF/Config/Machine               : cdb1
</span><span class='line'>STAF/Config/MachineNickname       : cdb1
</span><span class='line'>STAF/Config/Mem/Physical/Bytes    : 3974971392
</span><span class='line'>STAF/Config/Mem/Physical/KB       : 3881808
</span><span class='line'>STAF/Config/Mem/Physical/MB       : 3790
</span><span class='line'>STAF/Config/OS/MajorVersion       : 3.10.0-693.el7.x86_64
</span><span class='line'>STAF/Config/OS/MinorVersion       : #1 SMP Tue Aug 22 21:09:27 UTC 2017
</span><span class='line'>STAF/Config/OS/Name               : Linux
</span><span class='line'>STAF/Config/OS/Revision           : x86_64
</span><span class='line'>STAF/Config/Processor/NumAvail    : 4
</span><span class='line'>STAF/Config/Sep/Command           : ;
</span><span class='line'>STAF/Config/Sep/File              : /
</span><span class='line'>STAF/Config/Sep/Line              : 
</span><span class='line'>
</span><span class='line'>STAF/Config/Sep/Path              : :
</span><span class='line'>STAF/Config/STAFRoot              : /usr/local/staf
</span><span class='line'>STAF/Config/StartupTime           : 20171006-10:33:42
</span><span class='line'>STAF/DataDir                      : /usr/local/staf/data/STAF
</span><span class='line'>STAF/Env/_                        : /usr/bin/nohup
</span><span class='line'>STAF/Env/CLASSPATH                : /usr/local/staf/lib/JSTAF.jar:/usr/local/staf/samples/demo/STAFDemo.jar:/usr/local/staf/samples/demo/STAFDemo.jar:/usr/local/staf/lib/JSTAF.jar:
</span><span class='line'>STAF/Env/HISTCONTROL              : ignoredups
</span><span class='line'>STAF/Env/HISTSIZE                 : 1000
</span><span class='line'>STAF/Env/HOME                     : /root
</span><span class='line'>STAF/Env/HOSTNAME                 : cdb1
</span><span class='line'>STAF/Env/JAVA_HOME                : /usr/local/jdk
</span><span class='line'>STAF/Env/LANG                     : en_US.UTF-8
</span><span class='line'>STAF/Env/LD_LIBRARY_PATH          : /usr/local/staf/lib:/usr/local/staf/lib:
</span><span class='line'>STAF/Env/LESSOPEN                 : ||/usr/bin/lesspipe.sh %s
</span><span class='line'>STAF/Env/LOGNAME                  : root
</span><span class='line'>STAF/Env/LS_COLORS                : rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=01;05;37;41:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=01;36:*.au=01;36:*.flac=01;36:*.mid=01;36:*.midi=01;36:*.mka=01;36:*.mp3=01;36:*.mpc=01;36:*.ogg=01;36:*.ra=01;36:*.wav=01;36:*.axa=01;36:*.oga=01;36:*.spx=01;36:*.xspf=01;36:
</span><span class='line'>STAF/Env/MAIL                     : /var/spool/mail/root
</span><span class='line'>STAF/Env/PATH                     : /usr/local/staf/bin:/usr/local/staf/bin:/usr/local/jdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin
</span><span class='line'>STAF/Env/PWD                      : /usr/local/staf
</span><span class='line'>STAF/Env/SELINUX_LEVEL_REQUESTED  : 
</span><span class='line'>STAF/Env/SELINUX_ROLE_REQUESTED   : 
</span><span class='line'>STAF/Env/SELINUX_USE_CURRENT_RANGE: 
</span><span class='line'>STAF/Env/SHELL                    : /bin/bash
</span><span class='line'>STAF/Env/SHLVL                    : 2
</span><span class='line'>STAF/Env/SSH_AUTH_SOCK            : /tmp/ssh-yEmD907zdB/agent.28259
</span><span class='line'>STAF/Env/SSH_CLIENT               : 192.168.193.10 34774 22
</span><span class='line'>STAF/Env/SSH_CONNECTION           : 192.168.193.10 34774 192.168.193.101 22
</span><span class='line'>STAF/Env/SSH_TTY                  : /dev/pts/2
</span><span class='line'>STAF/Env/STAF_INSTANCE_NAME       : STAF
</span><span class='line'>STAF/Env/STAFCONVDIR              : /usr/local/staf/codepage
</span><span class='line'>STAF/Env/TERM                     : vt100
</span><span class='line'>STAF/Env/USER                     : root
</span><span class='line'>STAF/Env/XDG_DATA_DIRS            : /root/.local/share/flatpak/exports/share/:/var/lib/flatpak/exports/share/:/usr/local/share/:/usr/share/
</span><span class='line'>STAF/Env/XDG_RUNTIME_DIR          : /run/user/0
</span><span class='line'>STAF/Env/XDG_SESSION_ID           : 2080
</span><span class='line'>STAF/Version                      : 3.4.26
</span><span class='line'>
</span><span class='line'>&gt;&gt;&gt;&gt; STAF predefines many useful variables, including information about the machine's Operating System 
</span><span class='line'>and File/Line/Path separators. 
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local var resolve system string {STAF/Config/Sep/File}
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>/
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local handle list handles
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>Handle Handle Name                     State      Last Used Date-Time
</span><span class='line'>------ ------------------------------- ---------- -------------------
</span><span class='line'>1      STAF_Process                    InProcess  20171006-10:33:42  
</span><span class='line'>2      STAF/Service/STAFServiceLoader1 InProcess  20171006-10:33:42  
</span><span class='line'>11     STAF/Client                     Registered 20171006-10:41:39  
</span><span class='line'>
</span><span class='line'>&gt;&gt;&gt;&gt; handle 1 is assigned to STAFProc. Each of the STAF/Client requests represent each 
</span><span class='line'>of the three "STAF local handle list handles" commands you submitted. Note that each request is assigned a new handle
</span><span class='line'>number, and that the previous handles have been deleted 
</span></code></pre></td></tr></table></div></figure>


<h4>Configuring STAF</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cdb1 staf]# staf local log log  machine logname log1 level info message test-message
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local log list machines
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>cdb1
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local log query machine cdb1 logname log1 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>Date-Time         Level Message     
</span><span class='line'>----------------- ----- ------------
</span><span class='line'>20171006-10:54:33 Info  test-message
</span><span class='line'>
</span><span class='line'>#配置
</span><span class='line'>[root@cdb1 staf]# echo "MACHINENICKNAME cdb1.dev" &gt;&gt;bin/STAF.cfg 
</span><span class='line'>[root@cdb1 staf]# staf local shutdown shutdown 
</span><span class='line'>[root@cdb1 staf]# ./startSTAFProc.sh 
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local log log  machine logname log3 level info message test-message
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local log list machines
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>cdb1
</span><span class='line'>cdb1.dev
</span><span class='line'>[root@cdb1 staf]# staf local log query machine cdb1.dev logname log3
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>Date-Time         Level Message     
</span><span class='line'>----------------- ----- ------------
</span><span class='line'>20171006-10:57:59 Info  test-message
</span><span class='line'>
</span><span class='line'>&gt;&gt;&gt;&gt; This primarily effects the data stored by
</span><span class='line'>services such as the Log and Monitor services, which store data based on the machine from which it came by using the
</span><span class='line'>STAF/Config/MachineNickname system variable as part of the directory path when creating logs and monitor data. By
</span><span class='line'>allowing the STAF/Config/MachineNickname system variable to be overridden, it allows you to better manage your
</span><span class='line'>data.
</span><span class='line'>Note that the machine nickname is not used to communicate with other systems and does not have any effect on trust. 
</span><span class='line'>
</span><span class='line'>#配置
</span><span class='line'>echo "SET DATADIR /data" &gt;&gt;bin/STAF.cfg
</span><span class='line'>...
</span><span class='line'>SET SYSTEM VAR Test/TestABC=websphere
</span><span class='line'>SET SYSTEM VAR Test/TestXYZ=150
</span><span class='line'>
</span><span class='line'>restart STAFProc and from a command prompt, try the STAF local var list command
</span><span class='line'>
</span><span class='line'>TRUST LEVEL 2 DEFAULT
</span><span class='line'>TRUST LEVEL 5 MACHINE 192.168.193.*
</span><span class='line'>TRUST LEVEL 4 MACHINE tcp://9.3.41.*
</span><span class='line'>TRUST LEVEL 5 MACHINE tcP://9.41.53.147
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local trust list 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>Type    Entry             Trust Level
</span><span class='line'>------- ----------------- -----------
</span><span class='line'>Default &lt;None&gt;            2          
</span><span class='line'>Machine *://192.168.193.* 5          
</span><span class='line'>Machine local://local     5          
</span><span class='line'>Machine tcp://9.3.41.*    4          
</span><span class='line'>Machine tcP://9.41.53.147 5          
</span></code></pre></td></tr></table></div></figure>


<h4>Using the Help Service</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cdb1 staf]# staf local help help 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>*** HELP Service Help ***
</span><span class='line'>
</span><span class='line'>REGISTER   SERVICE &lt;Name&gt; ERROR &lt;Number&gt; INFO &lt;String&gt; DESCRIPTION &lt;String&gt;
</span><span class='line'>
</span><span class='line'>UNREGISTER SERVICE &lt;Name&gt; ERROR &lt;Number&gt;
</span><span class='line'>
</span><span class='line'>[SERVICE &lt;Name&gt;] ERROR &lt;Number&gt;
</span><span class='line'>
</span><span class='line'>LIST SERVICES | [SERVICE &lt;Name&gt;] ERRORS
</span><span class='line'>
</span><span class='line'>HELP
</span><span class='line'>
</span><span class='line'>#错误码详情
</span><span class='line'>[root@cdb1 staf]# staf local error list 
</span><span class='line'>Error submitting request, RC: 2
</span><span class='line'>Additional info
</span><span class='line'>---------------
</span><span class='line'>error
</span><span class='line'>[root@cdb1 staf]# staf local help error 2
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>Description: Unknown service
</span><span class='line'>Details    : You have tried to submit a request to a service that is unknown to STAFProc.  Verify that you have correctly registered the service.
</span></code></pre></td></tr></table></div></figure>


<h4>Registering STAF Services</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http://staf.sourceforge.net/getservices.php 下载EventV315.tar
</span><span class='line'>[root@cdb1 staf]# tar xf EventV315.tar 
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# vi bin/STAF.cfg 
</span><span class='line'>...
</span><span class='line'>service Event library JSTAF execute /usr/local/staf/event/STAFEvent.jar
</span><span class='line'>
</span><span class='line'>[root@cdb1 staf]# staf local shutdown shutdown 
</span><span class='line'>[root@cdb1 staf]# ./startSTAFProc.sh 
</span><span class='line'>[root@cdb1 staf]# staf local service list 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>Name      Library    Executable                         
</span><span class='line'>--------- ---------- -----------------------------------
</span><span class='line'>...
</span><span class='line'>EVENT     JSTAF      /usr/local/staf/event/STAFEvent.jar
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>#帮助文档： http://staf.sourceforge.net/current/event.htm
</span></code></pre></td></tr></table></div></figure>


<h4>STAF Demo（<strong> 前提得安装上面的EVENT，并且STAFProc也得在图形界面Terminal启动！！ </strong>）</h4>

<ol>
<li>each machine must give the other machine a TRUST level of 5</li>
<li>samples\demo\STAFDemo.jar在CLASSPATH里面.</li>
<li>java STAFDemoController是图形界面程序！！</li>
<li>弹出的窗口【An Arbitrary Process:Handle X】的标题（界面没看到的话，可能是被遮住了）。</li>
</ol>


<p><strong> However, the STAFProcess window should be displayed on your remote machine。</strong></p>

<p>具体的代码解析查阅【8.2. STAF Demo Code - Leveraging STAF】这个章节。</p>

<h2>User&rsquo;s Guide</h2>

<ul>
<li><a href="http://staf.sourceforge.net/current/STAFUG.htm">http://staf.sourceforge.net/current/STAFUG.htm</a></li>
<li><a href="http://staf.sourceforge.net/current/STAFUG.htm#HDRJVMCFG">4.4.2 JSTAF service proxy library</a></li>
</ul>


<h2>STAX Getting Started</h2>

<p><a href="http://staf.sourceforge.net/current/staxgs.pdf">http://staf.sourceforge.net/current/staxgs.pdf</a></p>

<p>Verify that the CLASSPATH environment variable contains the JSTAF.jar file. JSTAF.jar contains the STAF Java APIs
to communicate with STAF from Java programs and is required to register STAF services written in Java.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cdb1 staf]# tar xf ~/STAXV3517.tar 
</span><span class='line'>[root@cdb1 staf]# vi bin/STAF.cfg 
</span><span class='line'>...
</span><span class='line'>SERVICE STAX LIBRARY JSTAF EXECUTE {STAF/Config/STAFRoot}/stax/STAX.jar OPTION J2=-Xmx2048m
</span><span class='line'>SERVICE EVENT LIBRARY JSTAF EXECUTE {STAF/Config/STAFRoot}/stax/STAFEvent.jar
</span><span class='line'>SET MAXQUEUESIZE 10000
</span></code></pre></td></tr></table></div></figure>


<p>If you do not want to include the JVM bin directory in your PATH, then you can use the
&ldquo;OPTION JVM=xxx&rdquo; to specify which Java executable to use for the services.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cdb1 staf]# staf local stax version 
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>3.5.17
</span><span class='line'>[root@cdb1 staf]# staf local stax version jython
</span><span class='line'>Response
</span><span class='line'>--------
</span><span class='line'>2.5.2-staf-v1
</span><span class='line'>[root@cdb1 staf]# 
</span></code></pre></td></tr></table></div></figure>


<p>Errors that occur when running the STAX service will be stored in its JVM log. This log is data/STAF/lang/java/jvm/STAFJVM1/JVMLog.1 in
your root STAF directory</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source /etc/profile
</span><span class='line'>cd stax
</span><span class='line'>java -jar STAXMon.jar
</span><span class='line'>
</span><span class='line'>&gt;&gt;&gt;&gt; You use script elements within your STAX jobs to define Python variables and execute Python code. However, also note that in most cases, all of
</span><span class='line'>the element content and element attributes in your STAX jobs will also be evaluated as Python code. 
</span><span class='line'>
</span><span class='line'>&lt;script&gt;testName = 'CoolTest1'&lt;/script&gt;
</span><span class='line'>&lt;testcase name="testName"&gt;
</span><span class='line'>&lt;testcase name="'%s Part A' % testName"&gt;
</span><span class='line'>&lt;testcase name="'%s Part A on machine %s' % (testName, machineName)"&gt;
</span><span class='line'>
</span><span class='line'>#DoesNothing.xml 
</span><span class='line'>&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
</span><span class='line'>&lt;!DOCTYPE stax SYSTEM "stax.dtd"&gt;
</span><span class='line'>
</span><span class='line'>&lt;stax&gt;
</span><span class='line'>
</span><span class='line'>  &lt;defaultcall function="main"/&gt;
</span><span class='line'>
</span><span class='line'>  &lt;function name="main"&gt;
</span><span class='line'>    &lt;nop/&gt;
</span><span class='line'>  &lt;/function&gt;
</span><span class='line'>
</span><span class='line'>&lt;/stax&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#generate dtd for xml editor
</span><span class='line'>set STAF_QUIET_MODE=1 (or if on Unix: export STAF_QUIET_MODE=1)
</span><span class='line'>STAF local STAX GET DTD &gt; stax.dtd
</span><span class='line'>set STAF_QUIET_MODE= (or if on Unix: unset STAF_QUIET_MODE)
</span><span class='line'>
</span><span class='line'>#RunNotepadProcess.xml
</span><span class='line'>&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
</span><span class='line'>&lt;!DOCTYPE stax SYSTEM "stax.dtd"&gt;
</span><span class='line'>
</span><span class='line'>&lt;stax&gt;
</span><span class='line'>
</span><span class='line'>  &lt;defaultcall function="main"/&gt;
</span><span class='line'>
</span><span class='line'>  &lt;function name="main"&gt;
</span><span class='line'>
</span><span class='line'>    &lt;process&gt;
</span><span class='line'>      &lt;location&gt;'local'&lt;/location&gt;
</span><span class='line'>      &lt;command&gt;'notepad'&lt;/command&gt;
</span><span class='line'>    &lt;/process&gt;
</span><span class='line'>
</span><span class='line'>  &lt;/function&gt;
</span><span class='line'>
</span><span class='line'>&lt;/stax&gt;</span></code></pre></td></tr></table></div></figure>


<p>结束任务，打开的程序也会被kill掉！！！</p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[连接树莓派]]></title>
    <link href="http://winseliu.com/blog/2017/10/05/respberrypi-connected-via/"/>
    <updated>2017-10-05T17:04:24+08:00</updated>
    <id>http://winseliu.com/blog/2017/10/05/respberrypi-connected-via</id>
    <content type="html"><![CDATA[<p>启动树莓派后，总得连上去操作才能告诉它做事情。最常用的就是通过SSH远程控制，前提是能连上网络、知道树莓派获取到的地址。下来把了解到的，以及自实践的连接方式做下小结。</p>

<h4>通过路由器</h4>

<p>网线、无线连接后，通过 <strong> 显示器 </strong> 、<strong> 路由管理界面 </strong> 获取树莓派的地址（在管理web界面有明确的respberrypi的字样）。</p>

<h4>通过USB</h4>

<ol>
<li>USB转COM</li>
</ol>


<p>USB连接电脑，连树莓派的GPIO对应的针。然后通过COM口协议与树莓派通信</p>

<ol>
<li>USB共享网络</li>
</ol>


<p>使用手机的USB共享网络。</p>

<p>USB连树莓派，Micro口连手机。手机上打开USB网络共享，树莓派中会建立一个usb0的网卡。这样就能通过这个网卡进行上网了（网上也有说同时打开wifi热点，没啥用啊，usb和wlan是两个不同的网段）。</p>

<p>手机上安装一个ssh的工具（juicessh等），先连上本地的shell，然后执行 <code>cat /proc/net/arp</code> 或者 <code>busybox arp -a</code> 查看与 rndis0 同一个网段的ip（一般就是连接到树莓派的地址了）。</p>

<p>在手机上安装一个IP扫描软件应该也行，但 <strong> 通过ARP是最简单最高效的方式了。</strong></p>

<p><img src="http://winseliu.com/images/blogs/raspberrypi-phone-usb-network.png" alt="" /></p>

<p>注意：busybox感觉像一个工具集，包含了很多linux的命令，并且有些命令参数比系统提供的更全，如 <code>tar -j</code> 。可以用 <code>busybox --help</code> 查看帮助。</p>

<h4>网线互联</h4>

<p>一跟网线直接连电脑和树莓派。</p>

<p>互传数据应该有用。当前感觉，这种方式没啥优势，有点鸡肋。上网比较麻烦：手动设置IP、域名解析、还要在电脑上面搞网卡绑定。</p>

<p>下面自动获取的方法（没试，应该是可以的吧）：</p>

<blockquote><p>网线直接把树莓派与电脑连接起来，电脑需要连wifi（如果不连接无法使用网络共享让树莓派获取到ip地址），在 设置->网络->wlan->网络与共享中心->wlan->属性->共享->允许​其它用户通过它来连接->确定。</p>

<p>稍等片刻树莓派应该就获取到一个ip地址了，此时打开命令提示符（我用的Xshell），运行arp -a命令，应该就可以看到​一个局域网段，如192.168.xx.1，通常以192.168开头，最后一位是1的那个接口，下面多出来的一条动态记录就是树莓派的。</p></blockquote>

<h2>参考：</h2>

<ul>
<li><a href="https://jingyan.baidu.com/article/676629977483b154d51b848e.html">使用Android手机作为树莓派的屏幕</a></li>
<li><a href="http://www.jianshu.com/p/f2e0a02c01d9">http://www.jianshu.com/p/f2e0a02c01d9</a></li>
<li><a href="http://blog.163.com/elliot_alderson/blog/static/26832905920161122104246919/">http://blog.163.com/elliot_alderson/blog/static/26832905920161122104246919/</a> 添加过ifcfg-usb0，但需要重启网卡才是设置IP地址，麻烦。</li>
<li><a href="http://blog.163.com/elliot_alderson/blog/static/268329059201611925543687/">树莓派安装kali linux （系统安装和初步配置）</a> 安装、gparted扩容</li>
</ul>


<h2>键盘输入、手机显示</h2>

<p>前提：安装screen。</p>

<ul>
<li>连接USB键盘，启动树莓派。</li>
<li>键盘盲打登录（输入：root回车centos回车screen -S pi）。</li>
<li>然后手机上ssh连接，进入pi的会话（screen -x pi）</li>
</ul>


<p>这样就能用键盘敲、手机看了！觉得挺好玩的。</p>

<h2>重新折腾树莓派</h2>

<ul>
<li>安装centos7: 密码root/centos</li>
</ul>


<p><a href="http://www.21ic.com/evm/trick/201605/675705.htm">http://www.21ic.com/evm/trick/201605/675705.htm</a></p>

<ul>
<li>扩大容量：</li>
</ul>


<p><a href="http://blog.csdn.net/qq_20480611/article/details/48657827">http://blog.csdn.net/qq_20480611/article/details/48657827</a></p>

<p>fdisk删掉分区然后重新加，重启后执行resize2fs</p>

<ul>
<li>安装wiringpi</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git://git.drogon.net/wiringPi
</span><span class='line'>cd wiringPi
</span><span class='line'>./build
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>epel</li>
</ul>


<p><a href="https://hobo.house/2016/03/03/installing-centos-on-the-raspberry-pi-2/">https://hobo.house/2016/03/03/installing-centos-on-the-raspberry-pi-2/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat &gt; /etc/yum.repos.d/epel-unsigned.repo &lt;&lt; EOF
</span><span class='line'>[epel]
</span><span class='line'>name=Epel rebuild for armhfp
</span><span class='line'>baseurl=https://armv7.dev.centos.org/repodir/epel-pass-1/
</span><span class='line'>enabled=1
</span><span class='line'>gpgcheck=0
</span><span class='line'>
</span><span class='line'>EOF
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[两台主机的docker通过route互联互通]]></title>
    <link href="http://winseliu.com/blog/2017/09/20/docker-manual-make-connect-each-other/"/>
    <updated>2017-09-20T18:34:52+08:00</updated>
    <id>http://winseliu.com/blog/2017/09/20/docker-manual-make-connect-each-other</id>
    <content type="html"><![CDATA[<p>前面一直用k8s的flannel来建立主机间docker容器的互联，但是当仅有两台机器用来做测试的时刻，安装一个flannel也是挺纠结的：麻烦、还有未知的问题，起一个服务在那里总会有那么些担忧。</p>

<p>其实可以直接通过建立路由来实现两台机器间容器的互联互通：<a href="http://www.pangxie.space/docker/139">Docker多台宿主机间的容器互联-centos7（直接路由）</a></p>

<p>两台主机（centos7/docker-1.12.6）：</p>

<ul>
<li>192.168.191.140 kube-master</li>
<li>192.168.191.141 kube-worker1</li>
</ul>


<h2>安装/配置docker</h2>

<p>这里不多讲了，参考 <a href="http://winseliu.com/blog/2017/07/30/kubeadm-install-kubenetes-on-centos7/">Kubeadm部署kubernetes</a> 进行docker的安装。</p>

<h2>建立新网卡，修改docker配置使用新网卡</h2>

<ul>
<li>安装/更新依赖</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install net-tools bridge-utils -y</span></code></pre></td></tr></table></div></figure>


<ul>
<li>关防火墙、关selinux</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setenforce 0
</span><span class='line'>
</span><span class='line'>vi /etc/selinux/config
</span><span class='line'>SELINUX=disabled
</span><span class='line'>
</span><span class='line'>systemctl stop firewalld
</span><span class='line'>systemctl disable firewalld</span></code></pre></td></tr></table></div></figure>


<ul>
<li>设置ip转发</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo 1 &gt; /proc/sys/net/ipv4/ip_forward
</span><span class='line'>
</span><span class='line'>vi /etc/sysctl.conf
</span><span class='line'>net.ipv4.ip_forward = 1  </span></code></pre></td></tr></table></div></figure>


<ul>
<li>删docker0，建kbr0</li>
</ul>


<p>先停docker！先停docker！先停docker！（好像docker会缓冲bridge的ip）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service docker stop
</span><span class='line'>brctl addbr kbr0
</span><span class='line'>ip link set dev docker0 down
</span><span class='line'>ip link del dev docker0</span></code></pre></td></tr></table></div></figure>


<p>下面的配置，两台机不同，如下：</p>

<table>
<thead>
<tr>
<th style="text-align:left;"> 192.168.191.140 kube-master                   </th>
<th style="text-align:left;"> 192.168.191.141 kube-worker1</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;"> vi /etc/sysconfig/network-scripts/ifcfg-kbr0</td>
<td></td>
</tr>
<tr>
<td style="text-align:left;"> DEVICE=kbr0                                   </td>
<td style="text-align:left;"> DEVICE=kbr0</td>
</tr>
<tr>
<td style="text-align:left;"> ONBOOT=yes                                    </td>
<td style="text-align:left;"> ONBOOT=yes</td>
</tr>
<tr>
<td style="text-align:left;"> BOOTPROTO=static                              </td>
<td style="text-align:left;"> BOOTPROTO=static</td>
</tr>
<tr>
<td style="text-align:left;"> IPADDR=172.17.3.1                             </td>
<td style="text-align:left;"> IPADDR=172.17.4.1</td>
</tr>
<tr>
<td style="text-align:left;"> NETMASK=255.255.255.0                         </td>
<td style="text-align:left;"> NETMASK=255.255.255.0</td>
</tr>
<tr>
<td style="text-align:left;"> GATEWAY=172.17.3.0                            </td>
<td style="text-align:left;"> GATEWAY=172.17.4.0</td>
</tr>
<tr>
<td style="text-align:left;"> USERCTL=no                                    </td>
<td style="text-align:left;"> USERCTL=no</td>
</tr>
<tr>
<td style="text-align:left;"> TYPE=Bridge                                   </td>
<td style="text-align:left;"> TYPE=Bridge</td>
</tr>
<tr>
<td style="text-align:left;"> IPV6INIT=no                                   </td>
<td style="text-align:left;"> IPV6INIT=no</td>
</tr>
<tr>
<td style="text-align:left;">&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</td>
<td style="text-align:left;">&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</td>
</tr>
<tr>
<td style="text-align:left;"> vi /etc/sysconfig/network-scripts/route-ens33 （ip对应的网卡名称）</td>
<td></td>
</tr>
<tr>
<td style="text-align:left;"> 172.17.4.0/24 via 192.168.191.141 dev ens33   </td>
<td style="text-align:left;"> 172.17.3.0/24 via 192.168.191.140 dev ens33</td>
</tr>
<tr>
<td style="text-align:left;">&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</td>
<td style="text-align:left;">&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</td>
</tr>
</tbody>
</table>


<p>参考： <a href="https://www.centos.org/docs/5/html/5.2/Deployment_Guide/s1-networkscripts-static-routes.html">Configuring Static Routes</a></p>

<ul>
<li>修改docker配置</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vi /usr/lib/systemd/system/docker.service     
</span><span class='line'>ExecStart=/usr/bin/dockerd --bridge=kbr0 
</span><span class='line'>
</span><span class='line'>systemctl daemon-reload </span></code></pre></td></tr></table></div></figure>


<ul>
<li>重新启动</li>
</ul>


<p>先起网卡！先起网卡！先起网卡！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service network restart
</span><span class='line'>
</span><span class='line'>systemctl start docker</span></code></pre></td></tr></table></div></figure>


<h2>最终效果</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>| 192.168.191.140 kube-master                                                   | 192.168.191.141 kube-worker1                            
</span><span class='line'>|:------------------------------------------------------------------------------|:-------------------------------------------------------
</span><span class='line'>| [root@kube-master ~]# ifconfig                                                | [root@kube-worker1 ~]# ifconfig
</span><span class='line'>| ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500                   | ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span><span class='line'>|         inet 192.168.191.140  netmask 255.255.255.0  broadcast 192.168.191.255|         inet 192.168.191.141  netmask 255.255.255.0  broadcast 192.168.191.255
</span><span class='line'>|         inet6 fe80::1186:2fe5:9ee5:8790  prefixlen 64  scopeid 0x20&lt;link&gt;     |         inet6 fe80::3995:4490:e2e7:1d0f  prefixlen 64  scopeid 0x20&lt;link&gt;
</span><span class='line'>|         ether 00:0c:29:40:2d:15  txqueuelen 1000  (Ethernet)                  |         ether 00:0c:29:2e:67:4d  txqueuelen 1000  (Ethernet)
</span><span class='line'>|         RX packets 18010  bytes 10754845 (10.2 MiB)                           |         RX packets 19871  bytes 12247126 (11.6 MiB)
</span><span class='line'>|         RX errors 0  dropped 0  overruns 0  frame 0                           |         RX errors 0  dropped 0  overruns 0  frame 0
</span><span class='line'>|         TX packets 4797  bytes 475332 (464.1 KiB)                             |         TX packets 5647  bytes 561624 (548.4 KiB)
</span><span class='line'>|         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0            |         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span><span class='line'>|                                                                               | 
</span><span class='line'>| kbr1: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500                            | kbr0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500
</span><span class='line'>|         inet 172.17.3.1  netmask 255.255.255.0  broadcast 172.17.3.255        |         inet 172.17.4.1  netmask 255.255.255.0  broadcast 172.17.4.255
</span><span class='line'>|         ether 00:00:00:00:00:00  txqueuelen 1000  (Ethernet)                  |         ether 00:00:00:00:00:00  txqueuelen 1000  (Ethernet)
</span><span class='line'>|         RX packets 179  bytes 13932 (13.6 KiB)                                |         RX packets 139  bytes 10492 (10.2 KiB)
</span><span class='line'>|         RX errors 0  dropped 0  overruns 0  frame 0                           |         RX errors 0  dropped 0  overruns 0  frame 0
</span><span class='line'>|         TX packets 43  bytes 3894 (3.8 KiB)                                   |         TX packets 36  bytes 3004 (2.9 KiB)
</span><span class='line'>|         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0            |         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span><span class='line'>|                                                                               | 
</span><span class='line'>| lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536                                  | lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
</span><span class='line'>|         inet 127.0.0.1  netmask 255.0.0.0                                     |         inet 127.0.0.1  netmask 255.0.0.0
</span><span class='line'>|         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;                          |         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
</span><span class='line'>|         loop  txqueuelen 1  (Local Loopback)                                  |         loop  txqueuelen 1  (Local Loopback)
</span><span class='line'>|         RX packets 140  bytes 11644 (11.3 KiB)                                |         RX packets 215  bytes 18260 (17.8 KiB)
</span><span class='line'>|         RX errors 0  dropped 0  overruns 0  frame 0                           |         RX errors 0  dropped 0  overruns 0  frame 0
</span><span class='line'>|         TX packets 140  bytes 11644 (11.3 KiB)                                |         TX packets 215  bytes 18260 (17.8 KiB)
</span><span class='line'>|         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0            |         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span><span class='line'>|                                                                               | 
</span><span class='line'>| [root@kube-master ~]# route -n                                                | [root@kube-worker1 ~]# route -n 
</span><span class='line'>| Kernel IP routing table                                                       | Kernel IP routing table
</span><span class='line'>| Destination     Gateway         Genmask         Flags Metric Ref    Use Iface | Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span><span class='line'>| 0.0.0.0         192.168.191.2   0.0.0.0         UG    100    0        0 ens33 | 0.0.0.0         192.168.191.2   0.0.0.0         UG    100    0        0 ens33
</span><span class='line'>| 172.17.3.0      0.0.0.0         255.255.255.0   U     427    0        0 kbr1  | 172.17.3.0      192.168.191.140 255.255.255.0   UG    100    0        0 ens33
</span><span class='line'>| 172.17.4.0      192.168.191.141 255.255.255.0   UG    100    0        0 ens33 | 172.17.4.0      0.0.0.0         255.255.255.0   U     425    0        0 kbr0
</span><span class='line'>| 192.168.191.0   0.0.0.0         255.255.255.0   U     100    0        0 ens33 | 192.168.191.0   0.0.0.0         255.255.255.0   U     100    0        0 ens33
</span><span class='line'>| [root@kube-master ~]#                                                         | [root@kube-worker1 ~]# 
</span><span class='line'>| [root@kube-master ~]# docker run -ti --rm busybox sh                          | [root@kube-worker1 ~]# docker run -ti --rm busybox sh                  
</span><span class='line'>| / # ifconfig                                                                  | / # ifconfig
</span><span class='line'>| eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:03:02                       | eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:04:02  
</span><span class='line'>|           inet addr:172.17.3.2  Bcast:0.0.0.0  Mask:255.255.255.0             |           inet addr:172.17.4.2  Bcast:0.0.0.0  Mask:255.255.255.0
</span><span class='line'>|           inet6 addr: fe80::42:acff:fe11:302/64 Scope:Link                    |           inet6 addr: fe80::42:acff:fe11:402/64 Scope:Link
</span><span class='line'>|           UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1                  |           UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</span><span class='line'>|           RX packets:23 errors:0 dropped:0 overruns:0 frame:0                 |           RX packets:16 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>|           TX packets:15 errors:0 dropped:0 overruns:0 carrier:0               |           TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>|           collisions:0 txqueuelen:0                                           |           collisions:0 txqueuelen:0 
</span><span class='line'>|           RX bytes:1870 (1.8 KiB)  TX bytes:1222 (1.1 KiB)                    |           RX bytes:1296 (1.2 KiB)  TX bytes:648 (648.0 B)
</span><span class='line'>|                                                                               | 
</span><span class='line'>| lo        Link encap:Local Loopback                                           | lo        Link encap:Local Loopback  
</span><span class='line'>|           inet addr:127.0.0.1  Mask:255.0.0.0                                 |           inet addr:127.0.0.1  Mask:255.0.0.0
</span><span class='line'>|           inet6 addr: ::1/128 Scope:Host                                      |           inet6 addr: ::1/128 Scope:Host
</span><span class='line'>|           UP LOOPBACK RUNNING  MTU:65536  Metric:1                            |           UP LOOPBACK RUNNING  MTU:65536  Metric:1
</span><span class='line'>|           RX packets:0 errors:0 dropped:0 overruns:0 frame:0                  |           RX packets:0 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>|           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0                |           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>|           collisions:0 txqueuelen:1                                           |           collisions:0 txqueuelen:1 
</span><span class='line'>|           RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)                              |           RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
</span><span class='line'>| / # ping 172.17.4.2                                                           | 
</span><span class='line'>| PING 172.17.4.2 (172.17.4.2): 56 data bytes                                   | / # ping 172.17.3.2
</span><span class='line'>| 64 bytes from 172.17.4.2: seq=0 ttl=62 time=2.598 ms                          | PING 172.17.3.2 (172.17.3.2): 56 data bytes
</span><span class='line'>| 64 bytes from 172.17.4.2: seq=1 ttl=62 time=1.569 ms                          | 64 bytes from 172.17.3.2: seq=0 ttl=62 time=1.421 ms
</span><span class='line'>| 64 bytes from 172.17.4.2: seq=2 ttl=62 time=1.194 ms                          | 64 bytes from 172.17.3.2: seq=1 ttl=62 time=1.446 ms
</span><span class='line'>| ^C                                                                            | ^C
</span><span class='line'>| --- 172.17.4.2 ping statistics ---                                            | --- 172.17.3.2 ping statistics ---
</span><span class='line'>| 3 packets transmitted, 3 packets received, 0% packet loss                     | 2 packets transmitted, 2 packets received, 0% packet loss
</span><span class='line'>| round-trip min/avg/max = 1.194/1.787/2.598 ms                                 | round-trip min/avg/max = 1.421/1.433/1.446 ms
</span><span class='line'>| 
</span><span class='line'>|-------------------------------------------------------------------------------|--------------------------------------------------------</span></code></pre></td></tr></table></div></figure>


<p>效果还不错，什么都没有安装route两台机器的docker就互联互通了。二三台机器使用这种方式最省事的，并且理论上效率也是最高的。</p>

<h2>其他参考</h2>

<ul>
<li><a href="http://www.infoq.com/cn/articles/docker-network-and-pipework-open-source-explanation-practice">Docker网络详解及pipework源码解读与实践</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用U盘安装Centos7]]></title>
    <link href="http://winseliu.com/blog/2017/09/19/os-install-via-usb/"/>
    <updated>2017-09-19T22:26:30+08:00</updated>
    <id>http://winseliu.com/blog/2017/09/19/os-install-via-usb</id>
    <content type="html"><![CDATA[<p>使用U盘安装操作系统，原来一直用 unetbootin-windows 但这次不好使，U盘重新格式化也不行。遇到的几个问题：</p>

<ol>
<li>有光驱最好啊，没光驱才用U盘安装啊！</li>
<li>U盘是否能被识别？安装系统嘛，你得屈就电脑，它不识别你就只能换另一个咯。旧的服务器识别USB3.0有问题。</li>
<li>进BIOS看启动项是否有你的U盘？把U盘的顺序调整到HDD的前面。与第二项是一起检测的。</li>
<li><p>做的系统：下载<a href="http://isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1708.iso">Minimal.iso</a>，用<a href="https://wiki.centos.org/zh/HowTos/InstallFromUSBkey">采用 Windows iso2usb</a> 把iso载入到U盘。</p></li>
<li><p>注意1： 看到 ntldr is missing 这样的提示，就可以去再重写一遍U盘了！</p></li>
<li>注意2： U盘必须是FAT32的！！</li>
</ol>


<p>安装系统的时刻，问题又来了：</p>

<ul>
<li>dracut_initqueue[599]: Warning: Could not boot</li>
</ul>


<p>找不到镜像。</p>

<p>处理： <strong> 等一段时间后会进行入到 Dracut shell </strong>, 查看下 /dev 下面有哪些磁盘设备。<strong> 最大/最后的那个磁盘设备 </strong> 一般就是你的U盘：如我的是 /dev/sdc1 。</p>

<p>CTRL+ALT+DELETE 重新启动，进入 CENTOS 安装界面启动选项时，按 TAB ，替换为如下内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vmlinux initrd=initrd.img
</span><span class='line'>inst.stage2=hd:/dev/sdc1 quit</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="http://m.blog.csdn.net/w_z_z_1991/article/details/41909851">http://m.blog.csdn.net/w_z_z_1991/article/details/41909851</a></li>
<li><a href="http://www.jianshu.com/p/e3cd90c540c3">http://www.jianshu.com/p/e3cd90c540c3</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Redmine部署以及插件安装]]></title>
    <link href="http://winseliu.com/blog/2017/09/18/redmine-deploy-and-install-plugins/"/>
    <updated>2017-09-18T23:46:24+08:00</updated>
    <id>http://winseliu.com/blog/2017/09/18/redmine-deploy-and-install-plugins</id>
    <content type="html"><![CDATA[<p>Redmine是类似JIRA的一个项目/BUG管理工具，使用ruby语言编写的。安装相对就麻烦一点，不熟嘛，一堆的东西要安装。有两种简单/傻瓜式的安装方式：</p>

<ul>
<li>bitnami-redmine，相当于一键安装；</li>
<li>docker + redmine，使用docker把所有的依赖都安装好，只需要配置remine即可。</li>
</ul>


<p>这里选择使用docker-compose来安装 <a href="https://github.com/sameersbn/docker-redmine">sameersbn/redmine:3.4.2</a></p>

<h2>部署</h2>

<p>先跑起来，然后再根据需求修改配置。搞得不好的话，重新安装也超级简单，是吧！</p>

<ul>
<li><a href="https://github.com/sameersbn/docker-redmine#quick-start">https://github.com/sameersbn/docker-redmine#quick-start</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -p /srv/docker/redmine/{redmine,postgresql}
</span><span class='line'>
</span><span class='line'>wget https://raw.githubusercontent.com/sameersbn/docker-redmine/master/docker-compose.yml
</span><span class='line'>docker-compose up
</span></code></pre></td></tr></table></div></figure>


<p>启动后，浏览器访问 <a href="http://HOSTED_IP:10083">http://HOSTED_IP:10083</a> ，使用 admin/admin 登录。</p>

<ul>
<li>重新弄，初始化：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker-compose rm -f 或者 docker-compose down
</span><span class='line'>
</span><span class='line'>rm -rf /srv/docker/redmine/redmine/tmp/*
</span><span class='line'>rm -rf /srv/docker/redmine/postgresql/* 
</span><span class='line'>
</span><span class='line'>docker-compose up --build
</span><span class='line'>
</span><span class='line'>#docker-compose up -d
</span><span class='line'>#docker-compose start</span></code></pre></td></tr></table></div></figure>


<h2>Theme主题</h2>

<ul>
<li><a href="https://github.com/sameersbn/docker-redmine#themes">https://github.com/sameersbn/docker-redmine#themes</a></li>
<li><a href="http://www.redmine.org/projects/redmine/wiki/Themes">http://www.redmine.org/projects/redmine/wiki/Themes</a></li>
<li><a href="https://www.redmineup.com/pages/themes/a1">https://www.redmineup.com/pages/themes/a1</a></li>
</ul>


<p>改头换面，下载主题后放到 /srv/docker/redmine/redmine/themes/ 目录下。然后 <strong> 重启容器 </strong>，再重新登录，修改 <strong> 管理 - 配置 - 显示 - 主题 - A1 </strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s redmine]# ll /srv/docker/redmine/redmine/themes/
</span><span class='line'>total 0
</span><span class='line'>drwxr-xr-x. 6 es es 69 Sep 18 23:38 a1
</span></code></pre></td></tr></table></div></figure>


<h2>Plugins</h2>

<p>有些插件不兼容3.4，注意版本的选择！以下是在3.4下面安装使用的插件：</p>

<ul>
<li><a href="http://www.redmine.org/projects/redmine/wiki/Plugins">http://www.redmine.org/projects/redmine/wiki/Plugins</a></li>
<li><a href="http://www.redmine.org/plugins/clipboard_image_paste">http://www.redmine.org/plugins/clipboard_image_paste</a></li>
<li><a href="https://github.com/peclik/clipboard_image_paste">https://github.com/peclik/clipboard_image_paste</a></li>
<li><a href="http://www.redmine.org/plugins/redmine_checklists">http://www.redmine.org/plugins/redmine_checklists</a></li>
<li><a href="http://www.redmine.org/plugins/redmine_agile">http://www.redmine.org/plugins/redmine_agile</a></li>
<li><a href="https://github.com/paginagmbh/redmine_lightbox2.git">https://github.com/paginagmbh/redmine_lightbox2.git</a></li>
<li><a href="https://github.com/paginagmbh/redmine_lightbox2">https://github.com/paginagmbh/redmine_lightbox2</a></li>
<li><a href="http://www.redmine.org/plugins/mega_calendar">http://www.redmine.org/plugins/mega_calendar</a></li>
<li><a href="https://github.com/berti92/mega_calendar/wiki/Installation">https://github.com/berti92/mega_calendar/wiki/Installation</a></li>
<li><a href="http://www.redmine.org/plugins/redmine_work_time">http://www.redmine.org/plugins/redmine_work_time</a></li>
<li><a href="http://www.redmine.org/plugins/redmine_issue_templates">http://www.redmine.org/plugins/redmine_issue_templates</a></li>
<li>Kanban</li>
<li><a href="http://www.redmine.org/plugins/redhopper">http://www.redmine.org/plugins/redhopper</a></li>
<li><a href="http://www.redmine.org/plugins/redhopper">http://www.redmine.org/plugins/redhopper</a></li>
<li><a href="http://www.redmine.org/plugins/deployer">http://www.redmine.org/plugins/deployer</a></li>
<li><a href="https://github.com/zapic0/deployer">https://github.com/zapic0/deployer</a></li>
<li><a href="http://www.redmine.org/plugins/redmine-ckeditor">http://www.redmine.org/plugins/redmine-ckeditor</a></li>
<li><a href="https://github.com/a-ono/redmine_ckeditor">https://github.com/a-ono/redmine_ckeditor</a></li>
<li><a href="http://www.redmine.org/plugins/apijs">http://www.redmine.org/plugins/apijs</a> 有一些依赖要安装，没用到的可以不安装apijs这个插件。</li>
<li><a href="https://www.luigifab.info/redmine/en/apijs.php">https://www.luigifab.info/redmine/en/apijs.php</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s plugins]# sed -i '/haml/s/^/#/' redhopper/Gemfile           
</span><span class='line'>[root@k8s plugins]# mv apijs redmine_apijs
</span><span class='line'>
</span><span class='line'>[root@k8s redmine]# ll /srv/docker/redmine/redmine/plugins/
</span><span class='line'>total 0
</span><span class='line'>drwxr-xr-x.  8 es es 118 Sep 18 14:05 clipboard_image_paste
</span><span class='line'>drwxr-xr-x. 10 es es 212 Sep 18 19:18 deployer
</span><span class='line'>drwxr-xr-x.  7 es es 160 Sep 18 12:00 issuefy
</span><span class='line'>drwxr-xr-x.  4 es es  60 Sep 18 11:59 line_numbers
</span><span class='line'>drwxr-xr-x.  8 es es 182 Sep 17 18:05 mega_calendar
</span><span class='line'>drwxr-xr-x.  6 es es 158 Sep 18 12:00 open_flash_chart
</span><span class='line'>drwxrwxr-x.  8 es es 225 Sep 18 22:15 redhopper
</span><span class='line'>drwxr-xr-x.  9 es es 156 Sep  6 19:02 redmine_agile
</span><span class='line'>drwxr-xr-x.  7 es es 133 Sep 18 22:00 redmine_apijs
</span><span class='line'>drwxr-xr-x. 10 es es 119 Aug 30 21:46 redmine_checklists
</span><span class='line'>drwxr-xr-x.  9 es es 158 Sep 18 19:19 redmine_ckeditor
</span><span class='line'>drwxr-xr-x.  8 es es 221 Sep 18 12:01 redmine_code_review
</span><span class='line'>drwxr-xr-x.  8 es es 252 Sep 18 12:01 redmine_dashboard
</span><span class='line'>drwxr-xr-x.  3 es es  70 Sep 18 12:00 redmine_embedded_video
</span><span class='line'>drwxr-xr-x.  2 es es  78 Sep 18 12:00 redmine_gist
</span><span class='line'>drwxrwxr-x.  8 es es 129 Aug  5 10:52 redmine_issue_templates
</span><span class='line'>drwxr-xr-x.  8 es es 170 Sep 18 17:46 redmine_lightbox2
</span><span class='line'>drwxr-xr-x.  8 es es 160 Mar  5  2017 redmine_work_time</span></code></pre></td></tr></table></div></figure>


<p>不重启容器的话，可以登录到容器把 ~/data/plugins 拷贝到 ~/redmine/plugins 下面，然后执行下面的命令进行更新：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@f0481f5f8cda:/home/redmine/redmine# 
</span><span class='line'>bundle install --without development test
</span><span class='line'>bundle exec rake redmine:plugins:migrate RAILS_ENV=production
</span><span class='line'>
</span><span class='line'>supervisorctl restart unicorn
</span></code></pre></td></tr></table></div></figure>


<h2>其他的一些插件</h2>

<ul>
<li><a href="http://www.redmine.org/plugins/dmsf">http://www.redmine.org/plugins/dmsf</a></li>
<li><a href="https://github.com/danmunn/redmine_dmsf">https://github.com/danmunn/redmine_dmsf</a></li>
<li><a href="http://www.redmine.org/plugins/redmine_git_hosting">http://www.redmine.org/plugins/redmine_git_hosting</a> X</li>
<li><a href="http://www.redmine.org/plugins/redmine_upwork_plugin">http://www.redmine.org/plugins/redmine_upwork_plugin</a></li>
<li><a href="https://github.com/alexbevi/redmine_knowledgebase">https://github.com/alexbevi/redmine_knowledgebase</a></li>
<li><a href="https://github.com/danmunn/redmine_dmsf">https://github.com/danmunn/redmine_dmsf</a></li>
<li><a href="https://github.com/jbox-web/redmine_jenkins">https://github.com/jbox-web/redmine_jenkins</a></li>
<li><a href="https://github.com/masweetman/issue_charts">https://github.com/masweetman/issue_charts</a></li>
<li>3.3.x</li>
<li><a href="http://www.redmine.org/plugins/redmine_pivot_table">http://www.redmine.org/plugins/redmine_pivot_table</a></li>
<li><a href="https://www.redmine.org/plugins/advanced_roadmap_v2">https://www.redmine.org/plugins/advanced_roadmap_v2</a></li>
<li><a href="https://github.com/Coren/redmine_advanced_roadmap_v2">https://github.com/Coren/redmine_advanced_roadmap_v2</a></li>
<li><a href="https://github.com/Loriowar/redmine_issues_tree">https://github.com/Loriowar/redmine_issues_tree</a></li>
<li><a href="https://github.com/speedy32129/projects_show">https://github.com/speedy32129/projects_show</a></li>
</ul>


<h2>参考</h2>

<ul>
<li><a href="https://github.com/bitnami/bitnami-docker-redmine">https://github.com/bitnami/bitnami-docker-redmine</a></li>
<li><a href="http://11398377.blog.51cto.com/11388377/1875686">http://11398377.blog.51cto.com/11388377/1875686</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Docker Compose入门]]></title>
    <link href="http://winseliu.com/blog/2017/09/17/docker-compose-hello/"/>
    <updated>2017-09-17T08:48:25+08:00</updated>
    <id>http://winseliu.com/blog/2017/09/17/docker-compose-hello</id>
    <content type="html"><![CDATA[<p>使用Docker也一段时间了，一开始直接使用命令行 docker run 来启动的，后面使用 k8s 来管理，对于多机环境来说还是挺方便的。但是如果仅仅是单机上面跑docker容器，安装一套 k8s 的话也挺尴尬的。</p>

<p>docker提供了compose编排的功能，通过配置文件的方式来启动、管理（多）容器的运行。有点启动脚本的意思，当然也包含一些管理的元素，对容器LifeCycle的管理。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s composetest]# docker version
</span><span class='line'>Client:
</span><span class='line'> Version:      1.12.6
</span><span class='line'> API version:  1.24
</span><span class='line'> Go version:   go1.6.4
</span><span class='line'> Git commit:   78d1802
</span><span class='line'> Built:        Tue Jan 10 20:20:01 2017
</span><span class='line'> OS/Arch:      linux/amd64
</span><span class='line'>
</span><span class='line'>Server:
</span><span class='line'> Version:      1.12.6
</span><span class='line'> API version:  1.24
</span><span class='line'> Go version:   go1.6.4
</span><span class='line'> Git commit:   78d1802
</span><span class='line'> Built:        Tue Jan 10 20:20:01 2017
</span><span class='line'> OS/Arch:      linux/amd64
</span><span class='line'> 
</span><span class='line'>[root@k8s composetest]# docker-compose version
</span><span class='line'>docker-compose version 1.16.1, build 6d1ac21
</span><span class='line'>docker-py version: 2.5.1
</span><span class='line'>CPython version: 2.7.13
</span><span class='line'>OpenSSL version: OpenSSL 1.0.1t  3 May 2016
</span></code></pre></td></tr></table></div></figure>


<p>docker的版本需要和compose配置的版本适配： <a href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a> ，docker-1.12的话，compose version不能高于 2.1。<a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#build">Compose file version 2</a> 。</p>

<p>先安装官网的helloworld来运行一个例子：</p>

<ul>
<li><a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></li>
<li><a href="https://docs.docker.com/compose/gettingstarted/#prerequisites">https://docs.docker.com/compose/gettingstarted/#prerequisites</a></li>
</ul>


<h2>安装：</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 浏览器下载docker-compose
</span><span class='line'>https://github.com/docker/compose/releases/download/1.16.1/docker-compose-Linux-x86_64
</span><span class='line'>
</span><span class='line'>[root@k8s opt]# cd /usr/local/bin/
</span><span class='line'>[root@k8s bin]# rz
</span><span class='line'>rz waiting to receive.
</span><span class='line'>Starting zmodem transfer.  Press Ctrl+C to cancel.
</span><span class='line'>Transferring docker-compose-Linux-x86_64 (1)...
</span><span class='line'>  100%    8648 KB    4324 KB/sec    00:00:02       0 Errors  
</span><span class='line'>
</span><span class='line'>[root@k8s bin]# mv docker-compose-Linux-x86_64 docker-compose
</span><span class='line'>[root@k8s bin]# chmod +x docker-compose 
</span></code></pre></td></tr></table></div></figure>


<h2>Hello World:</h2>

<p>官网是一个访问量统计的例子，通过python网站结合redis来实现。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s composetest]# ll
</span><span class='line'>total 16
</span><span class='line'>-rw-r--r--. 1 root root 303 Sep 17 08:09 app.py
</span><span class='line'>-rw-r--r--. 1 root root 112 Sep 17 08:39 docker-compose.yml
</span><span class='line'>-rw-r--r--. 1 root root 114 Sep 17 08:42 Dockerfile
</span><span class='line'>-rw-r--r--. 1 root root  13 Sep 17 08:09 requirements.txt
</span><span class='line'>
</span><span class='line'>[root@k8s composetest]# cat app.py 
</span><span class='line'>from flask import Flask
</span><span class='line'>from redis import Redis
</span><span class='line'>
</span><span class='line'>app = Flask(__name__)
</span><span class='line'>redis = Redis(host='redis', port=6379)
</span><span class='line'>
</span><span class='line'>@app.route('/')
</span><span class='line'>def hello():
</span><span class='line'>  count = redis.incr('hits')
</span><span class='line'>  return 'Hello World! I have been seen {} times.\n'.format(count)
</span><span class='line'>
</span><span class='line'>if __name__ == "__main__":
</span><span class='line'>  app.run(host="0.0.0.0", debug=True)
</span><span class='line'>
</span><span class='line'>[root@k8s composetest]# cat requirements.txt 
</span><span class='line'>flask
</span><span class='line'>redis
</span><span class='line'>
</span><span class='line'>[root@k8s composetest]# cat Dockerfile 
</span><span class='line'>FROM python:3.4-alpine
</span><span class='line'>
</span><span class='line'>ADD . /code
</span><span class='line'>WORKDIR /code
</span><span class='line'>
</span><span class='line'>RUN pip install -r requirements.txt
</span><span class='line'>
</span><span class='line'>CMD ["python", "app.py"]
</span><span class='line'>
</span><span class='line'>[root@k8s composetest]# cat docker-compose.yml 
</span><span class='line'>version: '2.1'
</span><span class='line'>services:
</span><span class='line'>  web:
</span><span class='line'>    build: .
</span><span class='line'>    ports:
</span><span class='line'>      - "5000:5000"
</span><span class='line'>  redis:
</span><span class='line'>    image: "redis:alpine"
</span></code></pre></td></tr></table></div></figure>


<p>依赖的镜像可以提前下载好，可以不修改docker配置的情况下来下载，参考<a href="https://raw.githubusercontent.com/winse/shell-not-just-on-work/master/docker-download-mirror.sh">docker-download-mirror.sh</a></p>

<p>写好配置后，运行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s composetest]# docker-compose up --build
</span><span class='line'>Building web
</span><span class='line'>Step 1 : FROM python:3.4-alpine
</span><span class='line'> ---&gt; 27a0e572c13a
</span><span class='line'>Step 2 : ADD . /code
</span><span class='line'> ---&gt; 84082044fb5e
</span><span class='line'>Removing intermediate container 7c4675b618da
</span><span class='line'>Step 3 : WORKDIR /code
</span><span class='line'> ---&gt; Running in a014af85b748
</span><span class='line'> ---&gt; 2ada42bd756c
</span><span class='line'>Removing intermediate container a014af85b748
</span><span class='line'>Step 4 : RUN pip install -r requirements.txt
</span><span class='line'> ---&gt; Running in 4be6f8f5c8b8
</span><span class='line'>Collecting flask (from -r requirements.txt (line 1))
</span><span class='line'>  Downloading Flask-0.12.2-py2.py3-none-any.whl (83kB)
</span><span class='line'>Collecting redis (from -r requirements.txt (line 2))
</span><span class='line'>  Downloading redis-2.10.6-py2.py3-none-any.whl (64kB)
</span><span class='line'>Collecting Jinja2&gt;=2.4 (from flask-&gt;-r requirements.txt (line 1))
</span><span class='line'>  Downloading Jinja2-2.9.6-py2.py3-none-any.whl (340kB)
</span><span class='line'>Collecting click&gt;=2.0 (from flask-&gt;-r requirements.txt (line 1))
</span><span class='line'>  Downloading click-6.7-py2.py3-none-any.whl (71kB)
</span><span class='line'>Collecting itsdangerous&gt;=0.21 (from flask-&gt;-r requirements.txt (line 1))
</span><span class='line'>  Downloading itsdangerous-0.24.tar.gz (46kB)
</span><span class='line'>Collecting Werkzeug&gt;=0.7 (from flask-&gt;-r requirements.txt (line 1))
</span><span class='line'>  Downloading Werkzeug-0.12.2-py2.py3-none-any.whl (312kB)
</span><span class='line'>Collecting MarkupSafe&gt;=0.23 (from Jinja2&gt;=2.4-&gt;flask-&gt;-r requirements.txt (line 1))
</span><span class='line'>  Downloading MarkupSafe-1.0.tar.gz
</span><span class='line'>Building wheels for collected packages: itsdangerous, MarkupSafe
</span><span class='line'>  Running setup.py bdist_wheel for itsdangerous: started
</span><span class='line'>  Running setup.py bdist_wheel for itsdangerous: finished with status 'done'
</span><span class='line'>  Stored in directory: /root/.cache/pip/wheels/fc/a8/66/24d655233c757e178d45dea2de22a04c6d92766abfb741129a
</span><span class='line'>  Running setup.py bdist_wheel for MarkupSafe: started
</span><span class='line'>  Running setup.py bdist_wheel for MarkupSafe: finished with status 'done'
</span><span class='line'>  Stored in directory: /root/.cache/pip/wheels/88/a7/30/e39a54a87bcbe25308fa3ca64e8ddc75d9b3e5afa21ee32d57
</span><span class='line'>Successfully built itsdangerous MarkupSafe
</span><span class='line'>Installing collected packages: MarkupSafe, Jinja2, click, itsdangerous, Werkzeug, flask, redis
</span><span class='line'>Successfully installed Jinja2-2.9.6 MarkupSafe-1.0 Werkzeug-0.12.2 click-6.7 flask-0.12.2 itsdangerous-0.24 redis-2.10.6
</span><span class='line'> ---&gt; ee3e476d4fad
</span><span class='line'>Removing intermediate container 4be6f8f5c8b8
</span><span class='line'>Step 5 : CMD python app.py
</span><span class='line'> ---&gt; Running in f2f9eefe782e
</span><span class='line'> ---&gt; 08e3065107b2
</span><span class='line'>Removing intermediate container f2f9eefe782e
</span><span class='line'>Successfully built 08e3065107b2
</span><span class='line'>Recreating composetest_web_1 ... 
</span><span class='line'>Recreating composetest_web_1
</span><span class='line'>Starting composetest_redis_1 ... 
</span><span class='line'>Recreating composetest_web_1 ... done
</span><span class='line'>Attaching to composetest_redis_1, composetest_web_1
</span><span class='line'>redis_1  | 1:C 17 Sep 00:43:45.012 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
</span><span class='line'>redis_1  | 1:C 17 Sep 00:43:45.013 # Redis version=4.0.1, bits=64, commit=00000000, modified=0, pid=1, just started
</span><span class='line'>redis_1  | 1:C 17 Sep 00:43:45.013 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 * Running mode=standalone, port=6379.
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 # Server initialized
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 * DB loaded from disk: 0.000 seconds
</span><span class='line'>redis_1  | 1:M 17 Sep 00:43:45.020 * Ready to accept connections
</span><span class='line'>web_1    |  * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)
</span><span class='line'>web_1    |  * Restarting with stat
</span><span class='line'>web_1    |  * Debugger is active!
</span><span class='line'>web_1    |  * Debugger PIN: 175-303-648</span></code></pre></td></tr></table></div></figure>


<p>查看容器状态：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s opt]# curl http://0.0.0.0:5000/
</span><span class='line'>Hello World! I have been seen 1 times.
</span><span class='line'>[root@k8s opt]# curl http://0.0.0.0:5000/
</span><span class='line'>Hello World! I have been seen 2 times.
</span><span class='line'>
</span><span class='line'>[root@k8s composetest]# docker-compose ps 
</span><span class='line'>       Name                      Command               State           Ports         
</span><span class='line'>-------------------------------------------------------------------------------------
</span><span class='line'>composetest_redis_1   docker-entrypoint.sh redis ...   Up      6379/tcp              
</span><span class='line'>composetest_web_1     python app.py                    Up      0.0.0.0:5000-&gt;5000/tcp
</span><span class='line'>
</span><span class='line'>##
</span><span class='line'>docker-compose rm -f # Remove stopped containers
</span><span class='line'>docker-compose down  # Stop and remove containers, networks, images, and volumes
</span></code></pre></td></tr></table></div></figure>


<h2>其他</h2>

<p>后台运行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose up -d
</span><span class='line'>$ docker-compose ps</span></code></pre></td></tr></table></div></figure>


<p>在指定容器内执行命令：有点类似 docker exec/kubectl exec</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose run web env</span></code></pre></td></tr></table></div></figure>


<p><a href="https://docs.docker.com/compose/production/#deploying-changes">单独编译运行</a> 仅更改过内容的容器：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose build web
</span><span class='line'>$ docker-compose up --no-deps -d web</span></code></pre></td></tr></table></div></figure>


<p>配置<a href="https://docs.docker.com/compose/extends/#extending-services">复用/覆写</a>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
</span><span class='line'>
</span><span class='line'># A
</span><span class='line'>webapp:
</span><span class='line'>  build: .
</span><span class='line'>  ports:
</span><span class='line'>    - "8000:8000"
</span><span class='line'>  volumes:
</span><span class='line'>    - "/data"
</span><span class='line'>   
</span><span class='line'># EA   
</span><span class='line'>web:
</span><span class='line'>  extends:
</span><span class='line'>    file: common-services.yml
</span><span class='line'>    service: webapp
</span><span class='line'>    </span></code></pre></td></tr></table></div></figure>


<h2>学习</h2>

<ul>
<li><a href="https://yeasy.gitbooks.io/docker_practice/content/compose/commands.html">Compose 命令</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Zookeeper ACL]]></title>
    <link href="http://winseliu.com/blog/2017/09/02/zookeeper-acl/"/>
    <updated>2017-09-02T23:14:55+08:00</updated>
    <id>http://winseliu.com/blog/2017/09/02/zookeeper-acl</id>
    <content type="html"><![CDATA[<p>集群又一次进行安检，SSH躲不过需要升级的，这次还加了hadoop security和zookeeper acl的bug。以前没太在意这些内容，既然安全检查出来了，还是需要处理的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ZooKeeper 未授权访问【原理扫描】
</span><span class='line'>详细描述  ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现，是Hadoop和Hbase的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。 
</span><span class='line'>ZooKeeper的目标就是封装好复杂易出错的关键服务，将简单易用的接口和性能高效、功能稳定的系统提供给用户。 
</span><span class='line'>在通常情况下，zookeeper允许未经授权的访问。
</span><span class='line'>解决办法  为ZooKeeper配置相应的访问权限。 
</span><span class='line'>
</span><span class='line'>方式一： 
</span><span class='line'>1）增加一个认证用户 
</span><span class='line'>addauth digest 用户名:密码明文 
</span><span class='line'>eg. addauth digest user1:password1 
</span><span class='line'>2）设置权限 
</span><span class='line'>setAcl /path auth:用户名:密码明文:权限 
</span><span class='line'>eg. setAcl /test auth:user1:password1:cdrwa 
</span><span class='line'>3）查看Acl设置 
</span><span class='line'>getAcl /path 
</span><span class='line'>
</span><span class='line'>方式二： 
</span><span class='line'>setAcl /path digest:用户名:密码密文:权限
</span><span class='line'>
</span><span class='line'>威胁分值  5.0
</span><span class='line'>危险插件  否
</span><span class='line'>发现日期  2015-02-10
</span></code></pre></td></tr></table></div></figure>


<h2>Zookeeper权限基本知识点、操作</h2>

<ul>
<li><a href="https://zookeeper.apache.org/doc/r3.3.3/zookeeperProgrammers.html#sc_ZooKeeperAccessControl">https://zookeeper.apache.org/doc/r3.3.3/zookeeperProgrammers.html#sc_ZooKeeperAccessControl</a></li>
<li><a href="https://my.oschina.net/guol/blog/1358538">https://my.oschina.net/guol/blog/1358538</a></li>
<li><a href="http://blog.csdn.net/xyang81/article/details/53147894">http://blog.csdn.net/xyang81/article/details/53147894</a></li>
<li><a href="https://ihong5.wordpress.com/2014/07/24/apache-zookeeper-setting-acl-in-zookeeper-client/">https://ihong5.wordpress.com/2014/07/24/apache-zookeeper-setting-acl-in-zookeeper-client/</a></li>
<li><a href="https://zookeeper.apache.org/doc/r3.3.3/zookeeperStarted.html">https://zookeeper.apache.org/doc/r3.3.3/zookeeperStarted.html</a></li>
</ul>


<p>Note also that an ACL pertains only to a specific znode. In particular it does not apply to children. ACL在znode上无继承性，也就是说子znode不会继承父znode的ACL权限.</p>

<ul>
<li>world has a single id, anyone, that represents anyone.</li>
<li>auth doesn&rsquo;t use any id, represents any authenticated user.</li>
<li>digest uses a username:password string to generate MD5 hash which is then used as an ACL ID identity. Authentication is done by sending the username:password in clear text. When used in the ACL the expression will be the username:base64 encoded SHA1 password digest.</li>
<li>ip uses the client host IP as an ACL ID identity. The ACL expression is of the form addr/bits(3.5+) where the most significant bits of addr are matched against the most significant bits of the client host IP.</li>
</ul>


<p>zookeeper的ACL格式为 schema:id:permissions 。模式就是上面列的几种，再加一个super。创建的节点默认权限为 world:anyone:rwadc 表示所有人都对这个节点有rwadc的权限。</p>

<ul>
<li>Create：允许对子节点Create 操作</li>
<li>Read：允许对本节点GetChildren 和GetData 操作</li>
<li>Write ：允许对本节点SetData 操作</li>
<li>Delete ：允许对子节点Delete 操作</li>
<li>Admin ：允许对本节点setAcl 操作</li>
</ul>


<h2>Auth授权</h2>

<p>不需要id，当前 &ldquo;登录&rdquo; 的所有users都有权限（sasl、kerberos这些授权方式不懂，囧)。虽然不需要id，但是格式还得按照 scheme:id:perm 的写法。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 15] setAcl /c auth:rwadc  
</span><span class='line'>auth:rwadc does not have the form scheme:id:perm
</span><span class='line'>Acl is not valid : /c
</span><span class='line'>
</span><span class='line'>[zk: k8s(CONNECTED) 13] addauth digest a:a
</span><span class='line'>[zk: k8s(CONNECTED) 14] addauth digest b:b
</span><span class='line'>[zk: k8s(CONNECTED) 15] addauth digest c:c
</span><span class='line'>[zk: k8s(CONNECTED) 16] create /e e
</span><span class='line'>Created /e
</span><span class='line'>[zk: k8s(CONNECTED) 17] setAcl /e auth::cdrwa
</span><span class='line'>...省略节点输出信息
</span><span class='line'>
</span><span class='line'>[zk: k8s(CONNECTED) 18] getAcl /e
</span><span class='line'>'digest,'a:mDmPUap4qvYwm+PZOtJ/scGyHLY=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'b:+F8zPn3x1CLx3qpYHEaRwIheWcc=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'c:K7CO7OxIfBOQxczG+7FI9BdZ6/s=
</span><span class='line'>: cdrwa</span></code></pre></td></tr></table></div></figure>


<p>id随便写也可以，zookeeper都不记录的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 9] addauth digest hdfs:hdfs    
</span><span class='line'>[zk: localhost:2181(CONNECTED) 10] setAcl /c auth:x:x:rwadc
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 11] getAcl /c               
</span><span class='line'>'digest,'user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'hdfs:0wpra2yK6RCUB9sbo0BkElpzcl8=
</span><span class='line'>: cdrwa</span></code></pre></td></tr></table></div></figure>


<p>也可以对根 / 授权，这样客户端就不能随便在根下面新建节点了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 9] addauth digest user:password    
</span><span class='line'>[zk: localhost:2181(CONNECTED) 21] setAcl / auth::rawdc
</span><span class='line'>
</span><span class='line'>重新登录
</span><span class='line'>[zk: localhost:2181(CONNECTED) 0] ls /
</span><span class='line'>Authentication is not valid : /
</span><span class='line'>[zk: localhost:2181(CONNECTED) 1] getAcl /
</span><span class='line'>'digest,'user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=
</span><span class='line'>: cdrwa
</span></code></pre></td></tr></table></div></figure>


<p>还原</p>

<p>使用有权限的用户/实例，如果都忘了那就只能放绝招：使用超级管理员登录，重新设置权限为world即可。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 26] setAcl / world:anyone:cdrwa</span></code></pre></td></tr></table></div></figure>


<h2>Digest</h2>

<p>直接用起来比 auth 简单，直接把密文交给zookeeper。首先得生成对应用户的密码。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s zookeeper-3.4.10]# java -cp zookeeper-3.4.10.jar:lib/* org.apache.zookeeper.server.auth.DigestAuthenticationProvider user:password
</span><span class='line'>user:password-&gt;user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=
</span><span class='line'>
</span><span class='line'>[root@k8s zookeeper-3.4.10]# java -cp zookeeper-3.4.10.jar:lib/* org.apache.zookeeper.server.auth.DigestAuthenticationProvider es:es
</span><span class='line'>es:es-&gt;es:KiHfMOSWCTgPKpz78IL/6qO8AEE=</span></code></pre></td></tr></table></div></figure>


<p>scheme是digest的时候，id需要密文。通过Zookeeper的客户端编码方式添加认证（登录），digest对应的auth数据是明文。</p>

<p>ACL授权一样使用 setAcl ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$$ A实例
</span><span class='line'>[zk: localhost:2181(CONNECTED) 17] setAcl /b digest:user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=:cdrwa
</span><span class='line'>和md5密码类似，数据库被盗了，如果是常用的密码会被猜出来
</span><span class='line'>[zk: localhost:2181(CONNECTED) 18] getAcl /b
</span><span class='line'>'digest,'user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=
</span><span class='line'>: cdrwa
</span><span class='line'>
</span><span class='line'>$$ B实例
</span><span class='line'>重新登录：
</span><span class='line'>[zk: k8s:2181(CONNECTED) 2] ls /b
</span><span class='line'>Authentication is not valid : /b
</span><span class='line'>
</span><span class='line'>$$ A实例
</span><span class='line'>[zk: localhost:2181(CONNECTED) 20] create /b/bb ''
</span><span class='line'>Authentication is not valid : /b/bb
</span><span class='line'>[zk: localhost:2181(CONNECTED) 21] addauth digest user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=
</span><span class='line'>[zk: localhost:2181(CONNECTED) 22] create /b/bb ''                                 
</span><span class='line'>Authentication is not valid : /b/bb
</span><span class='line'>
</span><span class='line'># 需要使用明文登录
</span><span class='line'>[zk: localhost:2181(CONNECTED) 23] addauth digest user:password
</span><span class='line'>[zk: localhost:2181(CONNECTED) 24] create /b/bb '' 
</span><span class='line'>Created /b/bb 
</span><span class='line'>
</span><span class='line'># 权限没有继承性
</span><span class='line'>[zk: localhost:2181(CONNECTED) 25] getAcl /b/bb
</span><span class='line'>'world,'anyone
</span><span class='line'>: cdrwa</span></code></pre></td></tr></table></div></figure>


<h1>IP</h1>

<p>ip的权限配置更简单些。逻辑就是匹配客户端的IP地址，在权限IP地址段范围内的才能访问。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$$ A实例
</span><span class='line'>[zk: localhost:2181(CONNECTED) 18] setAcl /i ip:127.0.0.1:cdrwa
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 19] getAcl /i
</span><span class='line'>'ip,'127.0.0.1
</span><span class='line'>: cdrwa
</span><span class='line'>[zk: localhost:2181(CONNECTED) 24] get /i
</span><span class='line'>Authentication is not valid : /i
</span><span class='line'>
</span><span class='line'>咋回事呢，就是本地还没权限？有时可localhost不一定对应127.0.0.1的。。。
</span><span class='line'>
</span><span class='line'>$$ B实例
</span><span class='line'>[root@k8s zookeeper-3.4.10]# bin/zkCli.sh -server 127.0.0.1
</span><span class='line'>[zk: 127.0.0.1(CONNECTED) 0] get /i
</span><span class='line'>i
</span><span class='line'>...
</span><span class='line'>改成另一个网卡的ip地址
</span><span class='line'>[zk: 127.0.0.1(CONNECTED) 1] setAcl /i ip:192.168.191.138:cdrwa
</span><span class='line'>...
</span><span class='line'>[zk: 127.0.0.1(CONNECTED) 2] getAcl /i
</span><span class='line'>'ip,'192.168.191.138
</span><span class='line'>: cdrwa
</span><span class='line'>[zk: 127.0.0.1(CONNECTED) 3] get /i
</span><span class='line'>Authentication is not valid : /i
</span><span class='line'>
</span><span class='line'>$$ C实例
</span><span class='line'>用主机名(191.138)登录的实例
</span><span class='line'>[zk: k8s(CONNECTED) 19] get /i
</span><span class='line'>i</span></code></pre></td></tr></table></div></figure>


<h2>超级管理员</h2>

<p>如果权限设置错了，咋办？</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: k8s(CONNECTED) 21] setAcl /i ip:192.168.191.0/24:cdrwa                   
</span><span class='line'>Acl is not valid : /i
</span><span class='line'>
</span><span class='line'>[zk: k8s(CONNECTED) 25] setAcl /i ip:192.168.191.0:cdrwa
</span><span class='line'>
</span><span class='line'>[zk: k8s(CONNECTED) 26] getAcl /i
</span><span class='line'>'ip,'192.168.191.0
</span><span class='line'>: cdrwa
</span><span class='line'>[zk: k8s(CONNECTED) 27] get /i
</span><span class='line'>Authentication is not valid : /i</span></code></pre></td></tr></table></div></figure>


<p>除非把客户端的ip地址换成 192.168.191.0 否则就访问不了了。</p>

<p>此时需要超级管理员才行，不然真没办法折腾了。（不知道为啥）是可以删掉（特指我当前的环境啊），但是这样数据就没有了啊！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 26] getAcl /i
</span><span class='line'>'ip,'192.168.191.0
</span><span class='line'>: cdrwa
</span><span class='line'>[zk: localhost:2181(CONNECTED) 27] delete /i
</span><span class='line'>[zk: localhost:2181(CONNECTED) 28] ls /
</span><span class='line'>[a, b, c, zookeeper, d, e]
</span><span class='line'>[zk: localhost:2181(CONNECTED) 29] ls /i
</span><span class='line'>Node does not exist: /i</span></code></pre></td></tr></table></div></figure>


<p>如果数据很重要，重启后用超级管理员的方式找回密码还是很划的来的。</p>

<ul>
<li><a href="https://community.hortonworks.com/articles/29900/zookeeper-using-superdigest-to-gain-full-access-to.html">https://community.hortonworks.com/articles/29900/zookeeper-using-superdigest-to-gain-full-access-to.html</a></li>
</ul>


<p>用 DigestAuthenticationProvider 加密就不操作了，直接用 es:es 对应的 es:es->es:KiHfMOSWCTgPKpz78IL/6qO8AEE= 作为管理员的账号密码。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export SERVER_JVMFLAGS=-Dzookeeper.DigestAuthenticationProvider.superDigest=es:KiHfMOSWCTgPKpz78IL/6qO8AEE=
</span><span class='line'>
</span><span class='line'>[root@k8s zookeeper-3.4.10]# bin/zkServer.sh stop
</span><span class='line'>[root@k8s zookeeper-3.4.10]# bin/zkServer.sh start
</span><span class='line'>ZooKeeper JMX enabled by default
</span><span class='line'>Using config: /opt/zookeeper-3.4.10/bin/../conf/zoo.cfg
</span><span class='line'>Starting zookeeper ... STARTED
</span><span class='line'>
</span><span class='line'>$$ A实例
</span><span class='line'>[root@k8s zookeeper-3.4.10]# bin/zkCli.sh 
</span><span class='line'>[zk: localhost:2181(CONNECTED) 0] get /i
</span><span class='line'>Authentication is not valid : /i
</span><span class='line'>[zk: localhost:2181(CONNECTED) 1] getAcl /i
</span><span class='line'>'ip,'192.168.191.0
</span><span class='line'>: cdrwa
</span><span class='line'>[zk: localhost:2181(CONNECTED) 2] addauth digest es:es
</span><span class='line'>[zk: localhost:2181(CONNECTED) 3] get /i
</span><span class='line'>i
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 4] setAcl /i world:anyone:cdrwa
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>$$ B实例
</span><span class='line'>[zk: localhost:2181(CONNECTED) 0] get /i
</span><span class='line'>i
</span><span class='line'>[zk: localhost:2181(CONNECTED) 1] getAcl /i
</span><span class='line'>'world,'anyone
</span><span class='line'>: cdrwa
</span></code></pre></td></tr></table></div></figure>


<h2>实践&mdash;好玩</h2>

<p>权限可以直接在创建的时刻指定：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>create /mynode content digest:user:tpUq/4Pn5A64fVZyQ0gOJ8ZWqkY=:cdrwa</span></code></pre></td></tr></table></div></figure>


<p>也可以一次性设置N个权限：</p>

<p>注：以下操作都是超级管理员登录的窗口，所以不存在权限的问题。想怎么改就怎么改</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setAcl /i ip:192.168.191.0:cdrwa,ip:127.0.0.1:cdrwa,ip:192.168.191.138:cdrwa
</span><span class='line'>
</span><span class='line'>getAcl /i
</span><span class='line'>'ip,'192.168.191.0
</span><span class='line'>: cdrwa
</span><span class='line'>'ip,'127.0.0.1
</span><span class='line'>: cdrwa
</span><span class='line'>'ip,'192.168.191.138
</span><span class='line'>: cdrwa
</span></code></pre></td></tr></table></div></figure>


<p>但是，使用ip、digest、word重设权限后，会覆盖旧的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 7] setAcl /i ip:0.0.0.0:cdrwa
</span><span class='line'>[zk: localhost:2181(CONNECTED) 8] getAcl /i
</span><span class='line'>'ip,'0.0.0.0
</span><span class='line'>: cdrwa
</span><span class='line'>
</span><span class='line'>[zk: localhost:2181(CONNECTED) 15] setAcl /i world:anyone:cdraw
</span><span class='line'>[zk: localhost:2181(CONNECTED) 16] getAcl /i
</span><span class='line'>'world,'anyone
</span><span class='line'>: cdrwa
</span></code></pre></td></tr></table></div></figure>


<p>3.4的版本不支持ip段（3.5应该是ok的）： <a href="https://github.com/apache/zookeeper/blob/release-3.4.10/src/java/main/org/apache/zookeeper/server/auth/IPAuthenticationProvider.java#L114">IPAuthenticationProvider</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public boolean isValid(String id) {
</span><span class='line'>    return addr2Bytes(id) != null;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>可以找对应版本的源码（远程）调试下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s zookeeper-3.4.10]# export SERVER_JVMFLAGS="-Dzookeeper.DigestAuthenticationProvider.superDigest=es:KiHfMOSWCTgPKpz78IL/6qO8AEE= -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005"
</span><span class='line'>[root@k8s zookeeper-3.4.10]# bin/zkServer.sh start
</span></code></pre></td></tr></table></div></figure>


<p>auth的权限比较有意思：自家兄弟添加、排除异己；permission按最新的算</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[zk: localhost:2181(CONNECTED) 21] setAcl /i auth::cdrwa,ip:0.0.0.0:cd
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 22] getAcl /i
</span><span class='line'>'ip,'0.0.0.0
</span><span class='line'>: cd
</span><span class='line'>'digest,'es:KiHfMOSWCTgPKpz78IL/6qO8AEE=
</span><span class='line'>: cdrwa
</span><span class='line'>
</span><span class='line'># auth add
</span><span class='line'>[zk: localhost:2181(CONNECTED) 27] addauth digest m:m
</span><span class='line'>[zk: localhost:2181(CONNECTED) 28] addauth digest n:n
</span><span class='line'>[zk: localhost:2181(CONNECTED) 29] setAcl /i auth::cdrwa
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 30] getAcl /i
</span><span class='line'>'digest,'es:KiHfMOSWCTgPKpz78IL/6qO8AEE=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'m:WZiIgWqJgd8EQVBh55Bslf/7JRc=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'n:TZ3f1UF7B75EF5g6qWR0VmEvb/s=
</span><span class='line'>: cdrwa
</span><span class='line'>
</span><span class='line'># perm
</span><span class='line'>[zk: localhost:2181(CONNECTED) 31] addauth digest z:z
</span><span class='line'>[zk: localhost:2181(CONNECTED) 32] addauth digest l:l
</span><span class='line'>[zk: localhost:2181(CONNECTED) 33] setAcl /i auth:z:z:cd
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 34] getAcl /i
</span><span class='line'>'digest,'es:KiHfMOSWCTgPKpz78IL/6qO8AEE=
</span><span class='line'>: cd
</span><span class='line'>'digest,'m:WZiIgWqJgd8EQVBh55Bslf/7JRc=
</span><span class='line'>: cd
</span><span class='line'>'digest,'n:TZ3f1UF7B75EF5g6qWR0VmEvb/s=
</span><span class='line'>: cd
</span><span class='line'>'digest,'z:cOgtYxFOAwKiTCMigcN2j2fFI3c=
</span><span class='line'>: cd
</span><span class='line'>'digest,'l:gdlgatwJdq7uG8kFfIjcIZj0tnQ=
</span><span class='line'>: cd
</span><span class='line'>
</span><span class='line'>可以看到全部变成cd了
</span><span class='line'>
</span><span class='line'>[zk: localhost:2181(CONNECTED) 35] setAcl /i auth:z:z:cdraw
</span><span class='line'>...
</span><span class='line'>[zk: localhost:2181(CONNECTED) 36] getAcl /i               
</span><span class='line'>'digest,'es:KiHfMOSWCTgPKpz78IL/6qO8AEE=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'m:WZiIgWqJgd8EQVBh55Bslf/7JRc=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'n:TZ3f1UF7B75EF5g6qWR0VmEvb/s=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'z:cOgtYxFOAwKiTCMigcN2j2fFI3c=
</span><span class='line'>: cdrwa
</span><span class='line'>'digest,'l:gdlgatwJdq7uG8kFfIjcIZj0tnQ=
</span><span class='line'>: cdrwa
</span><span class='line'>
</span><span class='line'>全部变成cdrwa
</span></code></pre></td></tr></table></div></figure>


<p>我觉得用 auth 设置权限是最保险的，不会搞错了出现自己都访问不了的情况。</p>

<h2>后记</h2>

<p>ok，到此基本的知识点算大概了解了。还有自定义实现授权的provider，这有点高级了有兴趣的自己去看官方文档了。</p>

<p>但是因为权限没有继承关系，像一些开源项目用到zookeeper的话，怎么进行加密呢？所有子目录都一个个的加？或者自定义根路径（chroot）让别人猜不到？</p>

<p>还有像zookeeper自己的目录 /zookeeper ，怎么进行权限管理呢？</p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
</feed>
