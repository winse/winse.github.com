<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Winse Blog]]></title>
  <link href="http://winseliu.com/atom.xml" rel="self"/>
  <link href="http://winseliu.com/"/>
  <updated>2017-02-13T15:10:58+08:00</updated>
  <id>http://winseliu.com/</id>
  <author>
    <name><![CDATA[Winse Liu]]></name>
    <email><![CDATA[winseliu@foxmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[K8s Minikube on Windows]]></title>
    <link href="http://winseliu.com/blog/2017/02/08/k8s-minikube-on-windows/"/>
    <updated>2017-02-08T22:50:06+08:00</updated>
    <id>http://winseliu.com/blog/2017/02/08/k8s-minikube-on-windows</id>
    <content type="html"><![CDATA[<p>在windows配置minikube需要先安装docker，或者更直接点的说就是需要docker一样的依赖环境（都是通过iso装载到虚拟机，我们这里不考虑iso内部的软件配置）。先安装docker会把这些依赖都配置好。</p>

<p>系统当前的版本不支持直接安装<a href="https://docs.docker.com/docker-for-windows/">Docker</a>（This version of Docker requires Windows 10 Pro, Enterprise or Education edition with a mininum build number of 10586, Please use <a href="https://www.docker.com/products/docker-toolbox">Docker Toolbox</a>），</p>

<ul>
<li><a href="https://docs.docker.com/toolbox/toolbox_install_windows/">https://docs.docker.com/toolbox/toolbox_install_windows/</a></li>
<li><a href="https://rominirani.com/tutorial-getting-started-with-kubernetes-on-your-windows-laptop-with-minikube-3269b54a226#.qvn9h99l4">Tutorial : Getting Started with Kubernetes on your Windows Laptop with Minikube</a></li>
<li><a href="https://blogs.msdn.microsoft.com/wasimbloch/2017/01/23/setting-up-kubernetes-on-windows10-laptop-with-minikube/">Setting up Kubernetes on Windows10 Laptop with Minikube use Hyper-V</a></li>
</ul>


<p>如果直接全部安装toolbox的VirtualBox、git的应该一切顺利的。由于已有cygwin，想着复用下结果惹了一身骚。</p>

<p>按照自己的安装过程，先介绍下配合cygwin安装docker，然后再介绍全部按官网的工具安装k8s。</p>

<h2>仅尝试Docker，不安装k8s</h2>

<p>但是不想安装git直接使用cygwin来代替。刚刚开始的时刻出现了一些理解上的偏差，后来查询start.sh脚本后大概了解到快捷方式、脚本内容后问题就迎刃而解。</p>

<p>先安装docker toolbox：先禁用windows的Hyper-V；安装时去掉git组件。</p>

<p>安装完成后，启动cygwin的命令行（不要用Docker的快捷图标启动）。然后进行如下配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@Lenovo-PC ~
</span><span class='line'>$ cd "C:\Program Files\Docker Toolbox"
</span><span class='line'>
</span><span class='line'>做一个c盘的映射
</span><span class='line'>winse@Lenovo-PC /cygdrive/c/Program Files/Docker Toolbox
</span><span class='line'>$ ll /
</span><span class='line'>...
</span><span class='line'>lrwxrwxrwx   1 winse None               11 Apr  5  2016 c -&gt; /cygdrive/c
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>根据cygwin的路径配置VirtualBox的路径
</span><span class='line'>winse@Lenovo-PC /cygdrive/c/Program Files/Docker Toolbox
</span><span class='line'>$ export VBOX_MSI_INSTALL_PATH="/cygdrive/c/Program Files/Oracle/VirtualBox/"
</span><span class='line'>
</span><span class='line'>首先下载boot2docker.iso到 C:\Users\winse\.docker\machine\cache\boot2docker.iso
</span><span class='line'>https://github.com/boot2docker/boot2docker/releases/download/v1.13.0/boot2docker.iso...
</span><span class='line'>
</span><span class='line'>创建一个空的clear脚本（cygwin没有包括clear脚本）
</span><span class='line'>winse@Lenovo-PC /cygdrive/c/Program Files/Docker Toolbox
</span><span class='line'>$ touch ~/bin/clear && chmod +x ~/bin/clear
</span><span class='line'>
</span><span class='line'># 启动
</span><span class='line'>winse@Lenovo-PC /cygdrive/c/Program Files/Docker Toolbox
</span><span class='line'>$ ./start.sh
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                        ##         .
</span><span class='line'>                  ## ## ##        ==
</span><span class='line'>               ## ## ## ## ##    ===
</span><span class='line'>           /"""""""""""""""""\___/ ===
</span><span class='line'>      ~~~ {~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~
</span><span class='line'>           \______ o           __/
</span><span class='line'>             \    \         __/
</span><span class='line'>              \____\_______/
</span><span class='line'>
</span><span class='line'>docker is configured to use the default machine with IP 192.168.99.100
</span><span class='line'>For help getting started, check out the docs at https://docs.docker.com
</span><span class='line'>
</span><span class='line'>Start interactive shell
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC ~
</span><span class='line'>$ docker run hello-world
</span><span class='line'>time="2017-02-08T22:48:33+08:00" level=warning msg="Unable to use system certificate pool: crypto/x509: system root pool is not available on Windows"
</span><span class='line'>Unable to find image 'hello-world:latest' locally
</span><span class='line'>latest: Pulling from library/hello-world
</span><span class='line'>78445dd45222: Pulling fs layer
</span><span class='line'>78445dd45222: Verifying Checksum
</span><span class='line'>78445dd45222: Download complete
</span><span class='line'>78445dd45222: Pull complete
</span><span class='line'>Digest: sha256:c5515758d4c5e1e838e9cd307f6c6a0d620b5e07e6f927b07d05f6d12a1ac8d7
</span><span class='line'>Status: Downloaded newer image for hello-world:latest
</span><span class='line'>
</span><span class='line'>Hello from Docker!
</span><span class='line'>This message shows that your installation appears to be working correctly.
</span><span class='line'>
</span><span class='line'>To generate this message, Docker took the following steps:
</span><span class='line'> 1. The Docker client contacted the Docker daemon.
</span><span class='line'> 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
</span><span class='line'> 3. The Docker daemon created a new container from that image which runs the
</span><span class='line'>    executable that produces the output you are currently reading.
</span><span class='line'> 4. The Docker daemon streamed that output to the Docker client, which sent it
</span><span class='line'>    to your terminal.
</span><span class='line'>
</span><span class='line'>To try something more ambitious, you can run an Ubuntu container with:
</span><span class='line'> $ docker run -it ubuntu bash
</span><span class='line'>
</span><span class='line'>Share images, automate workflows, and more with a free Docker ID:
</span><span class='line'> https://cloud.docker.com/
</span><span class='line'>
</span><span class='line'>For more examples and ideas, visit:
</span><span class='line'> https://docs.docker.com/engine/userguide/
</span></code></pre></td></tr></table></div></figure>


<h2>使用默认安装，并安装k8s</h2>

<p>由于cygwin的路径与windows的不兼容，而git bash则本身依托于windows的命令行的，兼容性方面更优。</p>

<p>重新安装Docker ToolBox，安装时选择git。</p>

<p>下载minikube需要的一些软件：</p>

<ul>
<li><a href="https://github.com/kubernetes/minikube/releases">minikube.exe</a></li>
<li><a href="https://github.com/kubernetes/minikube/blob/v0.16.0/README.md">minikube文档</a></li>
<li><a href="https://storage.googleapis.com/kubernetes-release/release/v1.5.2/bin/windows/amd64/kubectl.exe">kubectl.exe</a></li>
<li><a href="https://rominirani.com/tutorial-getting-started-with-kubernetes-on-your-windows-laptop-with-minikube-3269b54a226#.pg14q9wst">Tutorial : Getting Started with Kubernetes on your Windows Laptop with Minikube</a></li>
<li><a href="https://kubernetes.io/docs/tutorials/stateless-application/hello-minikube/">Hello Minikube On OS X</a></li>
<li><a href="https://kubernetes.io/docs/getting-started-guides/minikube/">Running Kubernetes Locally via Minikube</a></li>
</ul>


<p>下载minikube和kubectl放到PATH路径下（bin目录已经在PATH中）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>E:\local\bin&gt;dir
</span><span class='line'>...
</span><span class='line'>2017-02-08  14:05        50,735,616 kubectl.exe
</span><span class='line'>2017-02-08  11:22        84,239,872 minikube-windows-amd64.exe
</span><span class='line'>2017-02-08  11:25    &lt;SYMLINK&gt;      minikube.exe [minikube-windows-amd64.exe] （mklink minikube.exe minikube-windows-amd64.exe）</span></code></pre></td></tr></table></div></figure>


<p>运行 <strong>Docker Quickstart Terminal</strong> (这个快捷方式会先启动docker的虚拟机)，或者直接打开 C:\Program Files\Git\bin\bash.exe 执行如下命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>查看帮助
</span><span class='line'>winse@Lenovo-PC MINGW64 ~
</span><span class='line'>$ minikube start --help
</span><span class='line'>Starts a local kubernetes cluster using Virtualbox. This command
</span><span class='line'>assumes you already have Virtualbox installed.
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>设置代理: 老外的教程都很简单就成功，但是我们操作一堆问题，主要就是万恶的防火墙！！！
</span><span class='line'>winse@Lenovo-PC MINGW64 ~
</span><span class='line'>$ export HTTPS_PROXY=http://localhost:8118
</span><span class='line'>$ export HTTP_PROXY=http://localhost:8118
</span><span class='line'>$ export NO_PROXY="192.168.0.0/16"
</span><span class='line'>
</span><span class='line'>启动
</span><span class='line'>winse@Lenovo-PC MINGW64 ~
</span><span class='line'>$ minikube start --v=7 --logtostderr
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 ~
</span><span class='line'>$ minikube status
</span><span class='line'>minikubeVM: Running
</span><span class='line'>localkube: Running
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 ~
</span><span class='line'>$ kubectl get nodes
</span><span class='line'>NAME       STATUS    AGE
</span><span class='line'>minikube   Ready     3h</span></code></pre></td></tr></table></div></figure>


<h4>再次启动，添加代理参数后dashboard才正常运行</h4>

<ul>
<li><a href="https://kubernetes.io/docs/tutorials/stateless-application/hello-minikube/">https://kubernetes.io/docs/tutorials/stateless-application/hello-minikube/</a></li>
<li><a href="https://rominirani.com/tutorial-getting-started-with-kubernetes-on-your-windows-laptop-with-minikube-3269b54a226">https://rominirani.com/tutorial-getting-started-with-kubernetes-on-your-windows-laptop-with-minikube-3269b54a226</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@Lenovo-PC MINGW64 /c/Program Files/Git/bin
</span><span class='line'>$ minikube start --docker-env HTTP_PROXY=http://192.168.99.1:8118 --docker-env HTTPS_PROXY=http://192.168.99.1:8118
</span><span class='line'>Starting local Kubernetes cluster...
</span><span class='line'>Kubectl is now configured to use the cluster.
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /c/Program Files/Git/bin
</span><span class='line'>$ minikube status
</span><span class='line'>minikubeVM: Running
</span><span class='line'>localkube: Running
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /c/Program Files/Git/bin
</span><span class='line'>$ kubectl cluster-info
</span><span class='line'>Kubernetes master is running at https://192.168.99.100:8443
</span><span class='line'>KubeDNS is running at https://192.168.99.100:8443/api/v1/proxy/namespaces/kube-system/services/kube-dns
</span><span class='line'>kubernetes-dashboard is running at https://192.168.99.100:8443/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard
</span><span class='line'>
</span><span class='line'>To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
</span><span class='line'>
</span><span class='line'>#open dashboard
</span><span class='line'>https://github.com/kubernetes/minikube/issues/379
</span><span class='line'>https://github.com/kubernetes/minikube/issues/522
</span><span class='line'>winse@Lenovo-PC MINGW64 /c/Program Files/Git/bin
</span><span class='line'>$ minikube dashboard
</span><span class='line'>Opening kubernetes dashboard in default browser...
</span><span class='line'>
</span><span class='line'>运行实例
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl get nodes
</span><span class='line'>NAME       STATUS    AGE
</span><span class='line'>minikube   Ready     8h
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl run hello-nginx --image=nginx --port=80
</span><span class='line'>deployment "hello-nginx" created
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe get pods
</span><span class='line'>NAME                           READY     STATUS              RESTARTS   AGE
</span><span class='line'>hello-nginx-2471083592-cgn29   0/1       ContainerCreating   0          19s
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe get pods
</span><span class='line'>NAME                           READY     STATUS             RESTARTS   AGE
</span><span class='line'>hello-nginx-2471083592-cgn29   0/1       ImagePullBackOff   0          3m
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe describe pod hello-nginx-2471083592-cgn29
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe expose deployment hello-nginx --type=NodePort
</span><span class='line'>service "hello-nginx" exposed
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe get services
</span><span class='line'>NAME          CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE
</span><span class='line'>hello-nginx   10.0.0.145   &lt;nodes&gt;       80:31570/TCP   1m
</span><span class='line'>kubernetes    10.0.0.1     &lt;none&gt;        443/TCP        9h
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe describe service hello-nginx
</span><span class='line'>Name:                   hello-nginx
</span><span class='line'>Namespace:              default
</span><span class='line'>Labels:                 run=hello-nginx
</span><span class='line'>Selector:               run=hello-nginx
</span><span class='line'>Type:                   NodePort
</span><span class='line'>IP:                     10.0.0.145
</span><span class='line'>Port:                   &lt;unset&gt; 80/TCP
</span><span class='line'>NodePort:               &lt;unset&gt; 31570/TCP
</span><span class='line'>Endpoints:              172.17.0.4:80
</span><span class='line'>Session Affinity:       None
</span><span class='line'>No events.
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ minikube service --url=true hello-nginx
</span><span class='line'>http://192.168.99.100:31570
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe logs hello-nginx-2471083592-cgn29
</span><span class='line'>172.17.0.1 - - [10/Feb/2017:02:07:53 +0000] "GET / HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.111 Safari/537.36" "-"
</span><span class='line'>172.17.0.1 - - [10/Feb/2017:02:07:54 +0000] "GET /favicon.ico HTTP/1.1" 404 571 "http://192.168.99.100:31570/" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.111 Safari/537.36" "-"
</span><span class='line'>2017/02/10 02:07:54 [error] 6#6: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 172.17.0.1, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.99.100:31570", referrer: "http://192.168.99.100:31570/"
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe scale --replicas=3 deployment/hello-nginx
</span><span class='line'>deployment "hello-nginx" scaled
</span><span class='line'>
</span><span class='line'>winse@Lenovo-PC MINGW64 /e/local/home/k8s
</span><span class='line'>$ kubectl.exe get deployment
</span><span class='line'>NAME          DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>hello-nginx   3         3         3            1           21m</span></code></pre></td></tr></table></div></figure>


<p>暂时还不清楚负载均衡是怎么弄的。这个三个应用pods其实是在一个内网（172.17.0.4/5/6），对外有一个服务（10.0.0.145）。</p>

<p>基本的安装过程先记录这么多。</p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Docker代理配置以及导入导出]]></title>
    <link href="http://winseliu.com/blog/2017/02/06/docker-http-proxy-and-save-reload/"/>
    <updated>2017-02-06T08:40:09+08:00</updated>
    <id>http://winseliu.com/blog/2017/02/06/docker-http-proxy-and-save-reload</id>
    <content type="html"><![CDATA[<h2>代理</h2>

<p>关于http代理服务器的搭建，如果有外（国）网机器，直接用squid建就行了 <a href="http://dockone.io/article/1380">使用Squid3搭建Docker镜像下载代理</a> 。如果已有shadowsocks的代理，可以用privoxy转成http代理服务器。</p>

<ul>
<li>网上参考</li>
</ul>


<p><a href="http://nknu.net/proxy-configuration-for-docker-on-centos-7/">http://nknu.net/proxy-configuration-for-docker-on-centos-7/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Edit /etc/sysconfig/docker and add the following lines:
</span><span class='line'>HTTP_PROXY='http://user:password@proxy-host:proxy-port'
</span><span class='line'>HTTPS_PROXY='http://user:password@proxy-host:proxy-port'
</span><span class='line'>
</span><span class='line'>For those settings to be taken into account, you’ll need to restart your docker daemon:
</span><span class='line'># systemctl restart docker</span></code></pre></td></tr></table></div></figure>


<ul>
<li>官网文档</li>
</ul>


<p><a href="https://docs.docker.com/engine/admin/systemd/#http-proxy">https://docs.docker.com/engine/admin/systemd/#http-proxy</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s docker.service.d]# pwd
</span><span class='line'>/etc/systemd/system/docker.service.d
</span><span class='line'>[root@k8s docker.service.d]# cat http-proxy.conf 
</span><span class='line'>[Service]
</span><span class='line'>Environment="HTTP_PROXY=http://127.0.0.1:8118/"
</span><span class='line'>
</span><span class='line'>查看配置的环境变量是否生效
</span><span class='line'>$ sudo systemctl show --property Environment docker
</span><span class='line'>
</span><span class='line'>配置代理后下载google容器杠杠的
</span><span class='line'>[root@k8s docker-multinode]# docker pull gcr.io/google_containers/etcd-amd64:3.0.4
</span></code></pre></td></tr></table></div></figure>


<p>如果是自己编译的docker，自启动配置可以参考：<a href="https://github.com/docker/docker/blob/master/contrib/init/systemd/docker.socket">https://github.com/docker/docker/blob/master/contrib/init/systemd/docker.socket</a></p>

<h2>导入导出</h2>

<p><a href="https://tuhrig.de/difference-between-save-and-export-in-docker/">https://tuhrig.de/difference-between-save-and-export-in-docker/</a></p>

<p>对于已经通过代理下载的docker，可以通过导入导出到另外的机器。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# docker save `docker images | grep -v TAG | awk '{print $1}'` &gt;k8s.tar
</span><span class='line'>
</span><span class='line'>[root@k8s data]# docker load &lt;k8s.tar
</span><span class='line'>0341ae9b0004: Loading layer [==================================================&gt;]  89.1 MB/89.1 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/kubernetes-dashboard-amd64:v1.5.0
</span><span class='line'>011b303988d2: Loading layer [==================================================&gt;]  5.05 MB/5.05 MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>596242791254: Loading layer [==================================================&gt;] 792.1 kB/792.1 kB
</span><span class='line'>4e504f64df23: Loading layer [==================================================&gt;]  5.29 MB/5.29 MB
</span><span class='line'>2897536d1f1f: Loading layer [==================================================&gt;] 3.584 kB/3.584 kB
</span><span class='line'>ae11e34e71e6: Loading layer [==================================================&gt;] 10.75 kB/10.75 kB
</span><span class='line'>81620de5436f: Loading layer [==================================================&gt;]  2.56 kB/2.56 kB
</span><span class='line'>77cb0f2fbaed: Loading layer [==================================================&gt;] 50.33 MB/50.33 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/kube-addon-manager-amd64:v6.1
</span><span class='line'>9007f5987db3: Loading layer [==================================================&gt;]  5.05 MB/5.05 MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>d41159f2130e: Loading layer [==================================================&gt;] 9.201 MB/9.201 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/dnsmasq-metrics-amd64:1.0
</span><span class='line'>2c84284818d1: Loading layer [==================================================&gt;] 1.312 MB/1.312 MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>5e47621858b3: Loading layer [==================================================&gt;] 38.51 MB/38.51 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/etcd-amd64:3.0.4
</span><span class='line'>b6ca02dfe5e6: Loading layer [==================================================&gt;] 128.9 MB/128.9 MB
</span><span class='line'>c2c974a0ae12: Loading layer [==================================================&gt;] 231.6 MB/231.6 MB
</span><span class='line'>88e4c6b7e766: Loading layer [==================================================&gt;] 25.09 kB/25.09 kB
</span><span class='line'>96257390754d: Loading layer [==================================================&gt;] 10.75 kB/10.75 kB
</span><span class='line'>36bd77066b3a: Loading layer [==================================================&gt;]  7.68 kB/7.68 kB
</span><span class='line'>6e833518b289: Loading layer [==================================================&gt;] 28.16 kB/28.16 kB
</span><span class='line'>88d2c1399894: Loading layer [==================================================&gt;] 11.78 kB/11.78 kB
</span><span class='line'>b857f858f4ad: Loading layer [==================================================&gt;] 46.08 kB/46.08 kB
</span><span class='line'>13da16246a77: Loading layer [==================================================&gt;] 56.58 MB/56.58 MB
</span><span class='line'>98a8cc89f2d0: Loading layer [==================================================&gt;] 4.608 kB/4.608 kB
</span><span class='line'>1b7eeaac3364: Loading layer [==================================================&gt;]  5.12 kB/5.12 kB
</span><span class='line'>c85758bfcfdf: Loading layer [==================================================&gt;] 153.9 MB/153.9 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/hyperkube-amd64:v1.5.2
</span><span class='line'>3fc666989c1d: Loading layer [==================================================&gt;] 5.046 MB/5.046 MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>9eed5e14d7fb: Loading layer [==================================================&gt;] 348.7 kB/348.7 kB
</span><span class='line'>00dc4ffe8624: Loading layer [==================================================&gt;]  2.56 kB/2.56 kB
</span><span class='line'>Loaded image: gcr.io/google_containers/kube-dnsmasq-amd64:1.4
</span><span class='line'>8ac8bfaff55a: Loading layer [==================================================&gt;] 1.293 MB/1.293 MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>dc978cfc3e09: Loading layer [==================================================&gt;] 7.279 MB/7.279 MB
</span><span class='line'>99740866972b: Loading layer [==================================================&gt;] 7.168 kB/7.168 kB
</span><span class='line'>Loaded image: gcr.io/google_containers/exechealthz-amd64:1.2
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;] 1.024 kB/1.024 kB
</span><span class='line'>41ff149e94f2: Loading layer [==================================================&gt;] 748.5 kB/748.5 kB
</span><span class='line'>Loaded image: gcr.io/google_containers/pause-amd64:3.0
</span><span class='line'>b79219965469: Loading layer [==================================================&gt;] 45.91 MB/45.91 MB
</span><span class='line'>Loaded image: gcr.io/google_containers/kubedns-amd64:1.9</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用Privoxy把shadowsocks转换为Http代理]]></title>
    <link href="http://winseliu.com/blog/2017/02/04/privoxy-http-proxy-for-shadowsocks/"/>
    <updated>2017-02-04T15:36:08+08:00</updated>
    <id>http://winseliu.com/blog/2017/02/04/privoxy-http-proxy-for-shadowsocks</id>
    <content type="html"><![CDATA[<p><a href="https://program-think.blogspot.com/2014/12/gfw-privoxy.html">https://program-think.blogspot.com/2014/12/gfw-privoxy.html</a></p>

<p>Privoxy是一个代理辅助工具，这里用Privoxy把Shadowsocks socks5代理转换为http代理。</p>

<p>kubernetes的docker容器需要访问google的服务，docker暂时只支持http代理，而我手上有的代理是 <a href="http://99ss.in">shadowsocks</a> 的。这里通过Privoxy把socks5转成http代理。</p>

<h2>安装Shadowsocks</h2>

<ul>
<li><a href="http://blog.lxx1.com/1420">http://blog.lxx1.com/1420</a></li>
<li><a href="https://shadowsocks.org/en/download/clients.html">https://shadowsocks.org/en/download/clients.html</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# yum install epel-release
</span><span class='line'>[root@k8s ~]# yum install python-pip
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# pip install shadowsocks
</span><span class='line'>Collecting shadowsocks
</span><span class='line'>  Downloading shadowsocks-2.8.2.tar.gz
</span><span class='line'>Installing collected packages: shadowsocks
</span><span class='line'>  Running setup.py install for shadowsocks ... done
</span><span class='line'>Successfully installed shadowsocks-2.8.2
</span><span class='line'>You are using pip version 8.1.2, however version 9.0.1 is available.
</span><span class='line'>You should consider upgrading via the 'pip install --upgrade pip' command.
</span><span class='line'>
</span><span class='line'>上面软件已经安装好了, 推荐更新下pip.
</span><span class='line'>[root@k8s ~]# pip install --upgrade pip
</span><span class='line'>Collecting pip
</span><span class='line'>  Downloading pip-9.0.1-py2.py3-none-any.whl (1.3MB)
</span><span class='line'>    100% |████████████████████████████████| 1.3MB 46kB/s 
</span><span class='line'>Installing collected packages: pip
</span><span class='line'>  Found existing installation: pip 8.1.2
</span><span class='line'>    Uninstalling pip-8.1.2:
</span><span class='line'>      Successfully uninstalled pip-8.1.2
</span><span class='line'>Successfully installed pip-9.0.1
</span></code></pre></td></tr></table></div></figure>


<p>填写shadowsocks服务端信息以及本地映射端口，启动客户端</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# cat /etc/shadowsocks.json 
</span><span class='line'>{
</span><span class='line'>"server": "xxxxxx",
</span><span class='line'>"server_port": xxx,
</span><span class='line'>"local_port": 1080,
</span><span class='line'>"password": "xxxxxxxx",
</span><span class='line'>"timeout": 600,
</span><span class='line'>"method": "rc4-md5",
</span><span class='line'>"fast_open": false,
</span><span class='line'>"workers": 1
</span><span class='line'>}
</span><span class='line'>[root@k8s ~]# sslocal -c /etc/shadowsocks.json </span></code></pre></td></tr></table></div></figure>


<p>配置防火墙，如果其他主机也需要用这个代理的话</p>

<p><a href="https://havee.me/linux/2015-01/using-firewalls-on-centos-7.html">https://havee.me/linux/2015-01/using-firewalls-on-centos-7.html</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@bigdata-dev ~]# firewall-cmd --zone=public --add-port=1080/tcp --permanent
</span><span class='line'>[root@bigdata-dev ~]# firewall-cmd --reload</span></code></pre></td></tr></table></div></figure>


<h2>安装privoxy</h2>

<ul>
<li><a href="https://www.privoxy.org/sf-download-mirror/Win32/3.0.26%20%28stable%29/">windows版本下载地址</a></li>
<li><a href="http://www.ttlsa.com/linux/privoxy-convert-socks-proxy-to-http/">http://www.ttlsa.com/linux/privoxy-convert-socks-proxy-to-http/</a></li>
<li><a href="https://blog.phpgao.com/privoxy-shadowsocks.html">https://blog.phpgao.com/privoxy-shadowsocks.html</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# yum install privoxy -y
</span><span class='line'>
</span><span class='line'>查找listen-address行注释掉，在最后添加如下两行
</span><span class='line'>[root@k8s docker.service.d]# cat /etc/privoxy/config 
</span><span class='line'>...
</span><span class='line'>forward-socks5 / 127.0.0.1:1080 .
</span><span class='line'>listen-address k8s:8118
</span><span class='line'>
</span><span class='line'># 启动
</span><span class='line'>[root@k8s ~]# systemctl start privoxy
</span><span class='line'># 查看状态
</span><span class='line'>[root@k8s ~]# systemctl status privoxy
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# systemctl enable privoxy
</span><span class='line'>Created symlink from /etc/systemd/system/multi-user.target.wants/privoxy.service to /usr/lib/systemd/system/privoxy.service.
</span><span class='line'>
</span><span class='line'>如果其他机器需要用到代理的话，需要配置防火墙开放端口
</span><span class='line'>[root@k8s ~]# firewall-cmd --zone=public --add-port=8118/tcp --permanent
</span><span class='line'>[root@k8s ~]# firewall-cmd --reload </span></code></pre></td></tr></table></div></figure>


<p>在本机调试会方便点，安装桌面环境</p>

<p><a href="http://unix.stackexchange.com/questions/181503/how-to-install-desktop-environments-on-centos-7">http://unix.stackexchange.com/questions/181503/how-to-install-desktop-environments-on-centos-7</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum -y groups install "GNOME Desktop" </span></code></pre></td></tr></table></div></figure>


<p>然后firefox安装autoproxy，配置http代理。（firefox自带的代理有点抽风，不太好用）</p>

<p>或者通过curl加代理参数：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# curl google.com
</span><span class='line'>curl: (7) Failed to connect to 2404:6800:4008:802::200e: Network is unreachable
</span><span class='line'>[root@k8s ~]# 
</span><span class='line'>[root@k8s ~]# curl -x localhost:8118 google.com
</span><span class='line'>&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv="content-type" content="text/html;charset=utf-8"&gt;
</span><span class='line'>&lt;TITLE&gt;301 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
</span><span class='line'>&lt;H1&gt;301 Moved&lt;/H1&gt;
</span><span class='line'>The document has moved
</span><span class='line'>&lt;A HREF="http://www.google.com/"&gt;here&lt;/A&gt;.
</span><span class='line'>&lt;/BODY&gt;&lt;/HTML&gt;</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在Centos7上安装VNC Server]]></title>
    <link href="http://winseliu.com/blog/2017/01/27/vnc-server-on-centos7/"/>
    <updated>2017-01-27T16:43:51+08:00</updated>
    <id>http://winseliu.com/blog/2017/01/27/vnc-server-on-centos7</id>
    <content type="html"><![CDATA[<h2>安装</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@bigdata-dev ~]# yum install -y tigervnc-server
</span><span class='line'>
</span><span class='line'>首先查看原来的默认配置
</span><span class='line'>[root@bigdata-dev ~]# cat /lib/systemd/system/vncserver@.service 
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>Type=forking
</span><span class='line'># Clean any existing files in /tmp/.X11-unix environment
</span><span class='line'>ExecStartPre=/bin/sh -c '/usr/bin/vncserver -kill %i &gt; /dev/null 2&gt;&1 || :'
</span><span class='line'>ExecStart=/usr/sbin/runuser -l &lt;USER&gt; -c "/usr/bin/vncserver %i"
</span><span class='line'>PIDFile=/home/&lt;USER&gt;/.vnc/%H%i.pid
</span><span class='line'>ExecStop=/bin/sh -c '/usr/bin/vncserver -kill %i &gt; /dev/null 2&gt;&1 || :'
</span><span class='line'>
</span><span class='line'>复制一份修改，已root用户为例。其他用户类推
</span><span class='line'>[root@bigdata-dev system]# cp vncserver@.service vncserver@:1.service 
</span><span class='line'>[root@bigdata-dev system]# vi vncserver@\:1.service 
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>Type=forking
</span><span class='line'># Clean any existing files in /tmp/.X11-unix environment
</span><span class='line'>ExecStartPre=/bin/sh -c '/usr/bin/vncserver -kill %i &gt; /dev/null 2&gt;&1 || :'
</span><span class='line'>ExecStart=/usr/sbin/runuser -l root -c "/usr/bin/vncserver %i"
</span><span class='line'>PIDFile=/root/.vnc/%H%i.pid
</span><span class='line'>ExecStop=/bin/sh -c '/usr/bin/vncserver -kill %i &gt; /dev/null 2&gt;&1 || :'
</span><span class='line'>
</span><span class='line'>[root@bigdata-dev system]# systemctl daemon-reload
</span><span class='line'>[root@bigdata-dev system]# systemctl enable vncserver@:1.service
</span><span class='line'>Created symlink from /etc/systemd/system/multi-user.target.wants/vncserver@:1.service to /etc/systemd/system/vncserver@:1.service.
</span><span class='line'>[root@bigdata-dev system]# systemctl start vncserver@:1.service
</span><span class='line'>[root@bigdata-dev system]# systemctl status vncserver@:1.service
</span><span class='line'>● vncserver@:1.service - Remote desktop service (VNC)
</span><span class='line'>   Loaded: loaded (/etc/systemd/system/vncserver@:1.service; enabled; vendor preset: disabled)
</span><span class='line'>   Active: active (running) since Wed 2017-01-25 14:28:04 CST; 27s ago
</span><span class='line'>   
</span><span class='line'>[root@bigdata-dev system]# vncpasswd 
</span><span class='line'>Password:
</span><span class='line'>Verify:
</span><span class='line'>[root@bigdata-dev system]# 
</span><span class='line'>[root@bigdata-dev system]# 
</span><span class='line'>[root@bigdata-dev system]# systemctl restart vncserver@:1.service
</span><span class='line'>http://www.aboutyun.com/thread-17535-1-1.html
</span><span class='line'>[root@bigdata-dev system]# systemctl status firewalld.service
</span><span class='line'>● firewalld.service - firewalld - dynamic firewall daemon
</span><span class='line'>   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
</span><span class='line'>   Active: inactive (dead)
</span><span class='line'>     Docs: man:firewalld(1)</span></code></pre></td></tr></table></div></figure>


<h2>下载客户端并访问</h2>

<p><a href="https://www.realvnc.com/download/viewer/">https://www.realvnc.com/download/viewer/</a> 访问VNC服务的地址 HOST:5901</p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[整理] 环境准备工具集]]></title>
    <link href="http://winseliu.com/blog/2017/01/25/develop-environment-prepare/"/>
    <updated>2017-01-25T10:57:18+08:00</updated>
    <id>http://winseliu.com/blog/2017/01/25/develop-environment-prepare</id>
    <content type="html"><![CDATA[<p>工具其实很重要，不仅仅是帮你把东西管理起来，而是工具是一整套的解决方案，是前辈多年总结实践的成果。</p>

<p>初出茅庐的时刻，总觉得工具麻烦，写个java程序还得写个pom，直接把jar放到lib下然后加入classpath就好了。殊不知，后面还有打包，进阶后还要看源码等等问题接踵而来。慢慢把maven用起来，又觉得apache的访问太慢（忍了），项目组内部分功能，开始全部放一个parent下面（也还行）。但后面编译打包太麻烦，尝试在项目组自己建立maven私有仓库。</p>

<p>这里把这几年使用的工具罗列下：</p>

<p>私有仓库：</p>

<ul>
<li>Nexus 如：项目组私有仓库</li>
<li>YUM repo: createrepo <a href="http://winseliu.com/blog/2016/06/17/ganglia-install-on-centos-with-puppet/">使用Puppet安装配置Ganglia</a> 如：生产环境YUM仓库</li>
<li><a href="http://winseliu.com/blog/2016/04/04/rpm-build-your-package/">RPM打包</a></li>
<li>Docker register [TODO]</li>
<li><a href="http://winseliu.com/blog/2016/03/11/install-and-config-openvpn/">OpenVPN</a> 如：访问只能内网访问的服务组（OA、SSH）</li>
</ul>


<p>软件使用：</p>

<ul>
<li><a href="http://winseliu.com/images/blogs/linux-101-hacks-review-securecrt-config.png">SecureCRT</a> 如：访问只能内网访问的单服务（无依赖）</li>
<li><a href="http://winseliu.com/blog/2015/11/22/gfw-ladder/">翻墙</a> google值得拥有</li>
<li><a href="http://winseliu.com/blog/2015/04/12/optimize-system-ramdisk/">内存盘</a></li>
<li><a href="http://winseliu.com/blog/2012/10/08/eclipse-remote-debugging-java-applications/">远程调试</a> <a href="http://winseliu.com/blog/2014/04/22/remote-debug-hadoop2/">远程调试hadoop2以及错误处理方法</a></li>
<li><a href="http://winseliu.com/blog/2014/02/23/quickly-open-program-in-windows/">WIN + R 快速打开程序</a></li>
<li><a href="http://winseliu.com/blog/2013/09/19/let-shell-command-efficient/">Shell</a></li>
<li><a href="http://winseliu.com/blog/2014/10/18/docker-dnsmasq-handler-hosts-build-hadoop-cluster/">Dnsmasq</a></li>
<li><a href="http://winseliu.com/blog/2015/09/06/squid-http-proxy-server-install/">squid</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jarsperreports生成PDF中文问题]]></title>
    <link href="http://winseliu.com/blog/2017/01/21/jarsperreports-pdf-chinese/"/>
    <updated>2017-01-21T12:06:31+08:00</updated>
    <id>http://winseliu.com/blog/2017/01/21/jarsperreports-pdf-chinese</id>
    <content type="html"><![CDATA[<ul>
<li><a href="http://blog.csdn.net/magicboylinw/article/details/8574202">JasperReport Studio生成PDF中文乱码的解决方案</a></li>
</ul>


<p>上个月弄JarsperReport报表，当时就有中文不能显示的问题。由于比较忙一直没有处理(能显示English基本能满足要求)，最近又遇到决定把它倒腾倒腾解决掉。</p>

<p>这里简单罗列下步骤，清楚怎么弄了其实非常简单。</p>

<ol>
<li>添加Jasperreport需要的字体（注意不是系统字体哦）： Window - Preferences - Jaspersoft Studio - Fonts - Add按钮</li>
<li>编辑弹出框Font Family：Family Name简单易记的就行（相当于唯一标识），添加Normal/Bold字体TTF的（微软雅黑是ttc的可以网上找工具转成ttf），PDF Details选择Identity-H、以及Embed this font in PDF document.</li>
<li>在报表jrxml中设置需要显示中文的文字字体为 <strong> 微软雅黑 </strong>（刚刚设置的名称），重新编译生成jasper文件。预览导出PDF已经可以正常显示中文了。</li>
<li><strong>导出字体为jar</strong>：回到Preferences字体配置页面，点击Export按钮把字体导出为jar。</li>
<li>把上面导出的jar放到应用的lib目录下。</li>
</ol>


<p>完成上面的步骤PDF就能展示中文了。</p>

<p>字体比较大，可以直接把jar加启动tomcat的classpath: Debug Configurations - Apache Tomcat - Classpath - User Entries 。</p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Nginx Https With Tomcat Http]]></title>
    <link href="http://winseliu.com/blog/2017/01/20/nginx-https-with-tomcat-http/"/>
    <updated>2017-01-20T20:03:19+08:00</updated>
    <id>http://winseliu.com/blog/2017/01/20/nginx-https-with-tomcat-http</id>
    <content type="html"><![CDATA[<p>昨天配置了HTTPS了，nginx https代理访问应用的http登录页也确实没有问题的。一切都是那么的完美，然而今天一早测试的姐姐告诉我：登录失败报错400 Bad Request The plain HTTP request was sent to HTTPS port.</p>

<ul>
<li>nginx 1.10.2</li>
<li>tomcat 8.0.38</li>
</ul>


<h2>初步定位问题</h2>

<p>然后想起有看到过红薯蜀黍的 <a href="https://www.oschina.net/question/12_213459">https://www.oschina.net/question/12_213459</a> 如下：（注：最终版在最后，如果有兴趣可以看看心路历程）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># tomcat server.xml
</span><span class='line'>  &lt;Service name="Catalina"&gt;
</span><span class='line'>    &lt;Connector port="9000" protocol="HTTP/1.1"
</span><span class='line'>               connectionTimeout="20000"
</span><span class='line'>               URIEncoding="UTF-8" 
</span><span class='line'>               redirectPort="14443"
</span><span class='line'>               scheme="https" 
</span><span class='line'>               proxyPort="14443" /&gt;
</span><span class='line'>  ...
</span><span class='line'>
</span><span class='line'>    &lt;Engine name="Catalina" defaultHost="localhost"&gt;
</span><span class='line'>
</span><span class='line'>      &lt;Host name="localhost"  appBase="webapps"
</span><span class='line'>            unpackWARs="true" autoDeploy="true"&gt;
</span><span class='line'>
</span><span class='line'>      &lt;Valve className="org.apache.catalina.valves.RemoteIpValve"
</span><span class='line'>                remoteIpHeader="x-forwarded-for"
</span><span class='line'>                remoteIpProxiesHeader="x-forwarded-by"
</span><span class='line'>                protocolHeader="x-forwarded-proto"
</span><span class='line'>            /&gt;
</span><span class='line'>  
</span><span class='line'># nginx 
</span><span class='line'>    server {
</span><span class='line'>        listen       14443 ssl;
</span><span class='line'>        server_name localhost;
</span><span class='line'>
</span><span class='line'>        ssl on;
</span><span class='line'>        ssl_certificate      nginx.crt;
</span><span class='line'>        ssl_certificate_key  nginx.key;
</span><span class='line'>
</span><span class='line'>        ssl_session_cache    shared:SSL:10m;
</span><span class='line'>        ssl_session_timeout  5m;
</span><span class='line'>
</span><span class='line'>        ssl_ciphers  HIGH:!aNULL:!MD5;
</span><span class='line'>        ssl_prefer_server_ciphers  on;
</span><span class='line'>
</span><span class='line'>        location / {
</span><span class='line'>            root   html;
</span><span class='line'>            index  index.html index.htm;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        location /omc {
</span><span class='line'>          proxy_set_header Host $http_host;
</span><span class='line'>          proxy_set_header X-Real-IP $remote_addr;
</span><span class='line'>          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>          proxy_set_header X-Forwarded-Proto https;
</span><span class='line'>          proxy_connect_timeout      240;
</span><span class='line'>          proxy_send_timeout         240;
</span><span class='line'>          proxy_read_timeout         240;
</span><span class='line'>  
</span><span class='line'>          proxy_pass http://localhost:9000;
</span><span class='line'>          proxy_redirect off;
</span><span class='line'>          #proxy_redirect https://$host/ / ;
</span><span class='line'>      }
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<p>登录确实请求确实都是https请求了，但是重定向(302)返回的https的端口丢失了（即被替换为默认的443）。查了很多资料，先弄了一个折中的处理方式，把hostname替换掉，即最后注释的那一行proxy_redirect。</p>

<p>查看的文章多半是http问题和多了端口的问题。我这是少端口了，但是还是有参考价值对proxy_redirect和port_in_redirect多了解一点：</p>

<ul>
<li><a href="http://fuxueliang.com/config/2013/07/05/resolve-the-redirect-problem-when-configuring-nginx-and-tomcat-integration/">nginx 和 Tomcat 集成后发生的重定向问题分析和解决</a></li>
<li><a href="http://feitianbenyue.iteye.com/blog/2056357">Nginx SSL+tomcat集群,request.getScheme() 取到https正确的协议</a></li>
<li><a href="https://www.oschina.net/question/12_213459">Nginx + Tomcat + HTTPS 配置原来不需要在 Tomcat 上启用 SSL 支持</a></li>
<li><a href="http://webapp.org.ua/sysadmin/setting-up-nginx-ssl-reverse-proxy-for-tomcat/">Setting up NGINX SSL reverse proxy for Tomcat</a></li>
</ul>


<p>还有一些没啥卵用，还带点误导性质的，但是还是得把它帖出来（蜜汁尴尬）：(注：不是说人家的有错，而是说和上面的Valve结合后不行了)</p>

<ul>
<li><a href="http://m.blog.csdn.net/article/details?id=52539175">解决nginx https代理tomcat redirect问题</a></li>
</ul>


<h2>关于redirectPort</h2>

<p>但是终究不是一种的解决问题的办法，而且怎么看怎么感觉Connector的redirectPort咋一点作用都没有呢？并且翻到一篇关于Valve的文章，感觉应该用远程调试看看为什么端口变成默认的了。</p>

<p>先看<a href="http://tomcat.apache.org/tomcat-8.0-doc/config/http.html">redirectPort</a>，仅当http请求有安全约束才会转到端口使用SSL传输。so，redirectPort在这里没啥卵用</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>redirectPort 
</span><span class='line'>If this Connector is supporting non-SSL requests, and a request is received for which a matching &lt;security-constraint&gt; requires SSL transport, Catalina will automatically redirect the request to the port number specified here.</span></code></pre></td></tr></table></div></figure>


<p>web.xml里面可以配置security-constraint节点</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;security-constraint&gt; 
</span><span class='line'>&lt;web-resource-collection&gt; 
</span><span class='line'>&lt;web-resource-name&gt;services&lt;/web-resource-name&gt; 
</span><span class='line'>&lt;url-pattern&gt;/login/*&lt;/url-pattern&gt; 
</span><span class='line'>&lt;/web-resource-collection&gt; 
</span><span class='line'>&lt;user-data-constraint&gt; 
</span><span class='line'>&lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt; 
</span><span class='line'>&lt;/user-data-constraint&gt; 
</span><span class='line'>&lt;/security-constraint&gt;</span></code></pre></td></tr></table></div></figure>


<p></p>

<ul>
<li><a href="https://zm6.sm-tc.cn/?src=l4uLj8XQ0IiIiNGTlpGKh5abnNGckJLQs5aRiofQzc%2FOytLPydDOzsbNy8bRl4uS&amp;uid=994acb90d7abb10312dae9cc39c4e4dd&amp;hid=3e89e83b734878f3fb6350c5ec9107a2&amp;pos=8&amp;cid=9&amp;time=1484906401433&amp;from=click&amp;restype=1&amp;pagetype=0000004000000402&amp;bu=structure_web_kv&amp;query=nginx+https+tomcat&amp;mode=&amp;v=1&amp;uc_param_str=dnntnwvepffrgibijbprsvdsei">Nginx+Tomcat+SSL免费证书配置</a></li>
</ul>


<h2>Valve问题所在，解决https以及端口问题的源泉</h2>

<ul>
<li><a href="https://zm6.sm-tc.cn/?src=l4uLj8XQ0IiIiNGShpeenJTKx9GckJLQvo2LlpyTmtCMkI2Lz8bG0IyQjYvPzs%2FN0M3PzsnQyMvOz8fRl4uS&amp;uid=994acb90d7abb10312dae9cc39c4e4dd&amp;hid=3e89e83b734878f3fb6350c5ec9107a2&amp;pos=10&amp;cid=9&amp;time=1484906401433&amp;from=click&amp;restype=1&amp;pagetype=0000004000000402&amp;bu=structure_web_info&amp;query=nginx+https+tomcat&amp;mode=&amp;v=1&amp;uc_param_str=dnntnwvepffrgibijbprsvdsei">nginx ssL +tomcat实现https</a></li>
</ul>


<p>由于是https请求，tcpdump从端口查到的数据都是看不懂的。并且不知道问题是在tomcat还是nginx，只能想着远程调试看看端口是在什么时刻被修改的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu1 apache-tomcat-8.0.38]# export JPDA_ADDRESS=8000
</span><span class='line'>[root@cu1 apache-tomcat-8.0.38]# bin/catalina.sh jpda run
</span><span class='line'>
</span><span class='line'># 本地pom.xml
</span><span class='line'>&lt;dependency&gt;
</span><span class='line'>    &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
</span><span class='line'>    &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;
</span><span class='line'>    &lt;version&gt;8.0.38&lt;/version&gt;
</span><span class='line'>&lt;/dependency&gt;</span></code></pre></td></tr></table></div></figure>


<p>然后本地maven项目临时加入tomcat的包，开启VPN在eclipse的 <code>org.apache.catalina.connector.ResponseFacade.sendRedirect(String)</code> 打断点调试。然后定位到 <code>org.apache.coyote.Request.setServerPort(int)</code>， 最终确定在 <code>org.apache.catalina.valves.RemoteIpValve.setPorts(Request, int)</code> 。RemoteIpValve类里面的Header和nginx中配置的Header是对应的。</p>

<h2>最终成果</h2>

<p>https配置的方法查看前一篇文章。</p>

<p>还有tomcat里面Header是不区分大小写的： <code>org.apache.tomcat.util.http.MimeHeaders.getValue(String)</code>
如果配置proxyPort（而不是Valve的话）取到协议好像会不对(没验证)，并且配置Valve可以不影响Connector。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># nginx
</span><span class='line'>    server {
</span><span class='line'>        listen       14443 ssl;
</span><span class='line'>        server_name localhost;
</span><span class='line'>
</span><span class='line'>        ssl on;
</span><span class='line'>        ssl_certificate      nginx.crt;
</span><span class='line'>        ssl_certificate_key  nginx.key;
</span><span class='line'>
</span><span class='line'>        ssl_session_cache    shared:SSL:10m;
</span><span class='line'>        ssl_session_timeout  5m;
</span><span class='line'>
</span><span class='line'>        ssl_ciphers  HIGH:!aNULL:!MD5;
</span><span class='line'>        ssl_prefer_server_ciphers  on;
</span><span class='line'>
</span><span class='line'>        location / {
</span><span class='line'>            root   html;
</span><span class='line'>            index  index.html index.htm;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        location /omc {
</span><span class='line'>        port_in_redirect on;
</span><span class='line'>
</span><span class='line'>        proxy_set_header Host $http_host;
</span><span class='line'>        proxy_set_header X-Forwarded-Host $http_host;
</span><span class='line'>        proxy_set_header X-Real-IP $remote_addr;
</span><span class='line'>        proxy_set_header X-Forwarded-Port $server_port; # 自定义port header
</span><span class='line'>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>        proxy_set_header X-Forwarded-Proto https;
</span><span class='line'>        proxy_connect_timeout      240;
</span><span class='line'>        proxy_send_timeout         240;
</span><span class='line'>        proxy_read_timeout         240;
</span><span class='line'>
</span><span class='line'>        proxy_pass http://localhost:9000;
</span><span class='line'>        #proxy_redirect default;
</span><span class='line'>        proxy_redirect off;
</span><span class='line'>        #proxy_redirect https://$host/ / ;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'># tomcat server.xml
</span><span class='line'>  &lt;Service name="Catalina"&gt;
</span><span class='line'>    &lt;Connector port="9000" protocol="HTTP/1.1"
</span><span class='line'>               connectionTimeout="20000"
</span><span class='line'>               URIEncoding="UTF-8"
</span><span class='line'>               redirectPort="8443"
</span><span class='line'>                /&gt;
</span><span class='line'>  ...
</span><span class='line'>    &lt;Engine name="Catalina" defaultHost="localhost"&gt;
</span><span class='line'>  ...
</span><span class='line'>      &lt;Host name="localhost"  appBase="webapps"
</span><span class='line'>            unpackWARs="true" autoDeploy="true"&gt;
</span><span class='line'>          ...
</span><span class='line'>            &lt;Valve className="org.apache.catalina.valves.RemoteIpValve"
</span><span class='line'>                  portHeader="x-forwarded-port"
</span><span class='line'>                  remoteIpHeader="x-forwarded-for"
</span><span class='line'>                  proxiesHeader="x-forwarded-by"
</span><span class='line'>                  protocolHeader="x-forwarded-proto"
</span><span class='line'>            /&gt;</span></code></pre></td></tr></table></div></figure>


<h2>福利</h2>

<p>nginx https代理tomcat <a href="https:">https:</a> 其实就是和http代理一样，很简单。记得删掉上面的removeipvalve。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># tomcat server.xml
</span><span class='line'>&lt;Connector
</span><span class='line'>           protocol="org.apache.coyote.http11.Http11AprProtocol"
</span><span class='line'>           port="9443" maxThreads="200"
</span><span class='line'>           scheme="https" secure="true" SSLEnabled="true"
</span><span class='line'>           SSLCertificateFile="/home/cu/tools/apache-tomcat-8.0.38/conf/nginx.crt"
</span><span class='line'>           SSLCertificateKeyFile="/home/cu/tools/apache-tomcat-8.0.38/conf/nginx.key"
</span><span class='line'>           SSLVerifyClient="optional" SSLProtocol="TLSv1+TLSv1.1+TLSv1.2"/&gt;
</span><span class='line'>
</span><span class='line'># nginx
</span><span class='line'>location /omc {
</span><span class='line'>proxy_set_header Host $http_host;
</span><span class='line'>proxy_set_header X-Forwarded-Host $http_host;
</span><span class='line'>proxy_set_header X-Real-IP $remote_addr;
</span><span class='line'>proxy_connect_timeout      240;
</span><span class='line'>proxy_send_timeout         240;
</span><span class='line'>proxy_read_timeout         240;
</span><span class='line'>
</span><span class='line'>proxy_redirect off;
</span><span class='line'>proxy_pass https://localhost:9443;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://my.oschina.net/zhlmmc/blog/42125">https://my.oschina.net/zhlmmc/blog/42125</a></li>
</ul>


<p>nginx websockt:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>    location /omc/webSocket {
</span><span class='line'>            proxy_pass http://localhost:8888/omc/webSocket;
</span><span class='line'>            proxy_redirect off;
</span><span class='line'>
</span><span class='line'>            proxy_http_version 1.1;
</span><span class='line'>            proxy_set_header Upgrade $http_upgrade;
</span><span class='line'>            proxy_set_header Connection "upgrade";
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<p>文件大小：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>proxy_read_timeout 86400;
</span><span class='line'>proxy_send_timeout 86400;
</span><span class='line'>
</span><span class='line'>client_max_body_size 1024m;</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Nginx配置https]]></title>
    <link href="http://winseliu.com/blog/2017/01/19/nginx-https/"/>
    <updated>2017-01-19T15:53:45+08:00</updated>
    <id>http://winseliu.com/blog/2017/01/19/nginx-https</id>
    <content type="html"><![CDATA[<p>很早前弄过https，当时只是玩玩实际工作中并没有用到。现在业务需要得配置https。欠的债总是要还的，使用puppet的时刻默认全部信任不走证书认证。这里为了安装tomcat的https还是绕不过去。硬着头皮整吧。</p>

<h2>编译</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[... nginx-1.10.2]$ tar zxvf zlib-1.2.8.tar.gz 
</span><span class='line'>[... nginx-1.10.2]$ tar zxvf pcre-8.36.tar.gz 
</span><span class='line'>
</span><span class='line'>[... nginx-1.10.2]$ mv zlib-1.2.8 src/zlib
</span><span class='line'>[... nginx-1.10.2]$ mv pcre-8.36 src/pcre
</span><span class='line'>
</span><span class='line'>[... nginx-1.10.2]$ ./configure --prefix=/home/hadoop/nginx --with-http_ssl_module --with-pcre=src/pcre --with-zlib=src/zlib
</span><span class='line'>[... nginx-1.10.2]$ make && make install</span></code></pre></td></tr></table></div></figure>


<h2>生成证书</h2>

<p>先整一个能访问的https，再通过本地CA来进行授权（本地浏览器安装这个CA），最后处理chrome sha-1的问题。</p>

<ul>
<li>自己签发（无CA）</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># RSA密钥
</span><span class='line'>[hadoop@cu1 conf]$ openssl genrsa -des3 -out server.key 1024
</span><span class='line'>Generating RSA private key, 1024 bit long modulus
</span><span class='line'>...........++++++
</span><span class='line'>................++++++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>Enter pass phrase for server.key:
</span><span class='line'>Verifying - Enter pass phrase for server.key:
</span><span class='line'># 拷贝一个不需要输入密码的密钥文件
</span><span class='line'>[hadoop@cu1 conf]$ cp server.key server.key.org
</span><span class='line'>[hadoop@cu1 conf]$ openssl rsa -in server.key.org -out server.key
</span><span class='line'>Enter pass phrase for server.key.org:
</span><span class='line'>writing RSA key
</span><span class='line'>
</span><span class='line'># 需要提交给 SSL 认证机构的(生成一个证书请求)
</span><span class='line'>[hadoop@cu1 conf]$ openssl req -new -key server.key -out server.csr
</span><span class='line'>You are about to be asked to enter information that will be incorporated
</span><span class='line'>into your certificate request.
</span><span class='line'>What you are about to enter is what is called a Distinguished Name or a DN.
</span><span class='line'>There are quite a few fields but you can leave some blank
</span><span class='line'>For some fields there will be a default value,
</span><span class='line'>If you enter '.', the field will be left blank.
</span><span class='line'>-----
</span><span class='line'>Country Name (2 letter code) [XX]:CN
</span><span class='line'>State or Province Name (full name) []:GD
</span><span class='line'>Locality Name (eg, city) [Default City]:GZ
</span><span class='line'>Organization Name (eg, company) [Default Company Ltd]:Eshore
</span><span class='line'>Organizational Unit Name (eg, section) []:CU
</span><span class='line'>Common Name (eg, your name or your server's hostname) []:cu.eshore.cn
</span><span class='line'>Email Address []:ca@eshore.cn
</span><span class='line'>
</span><span class='line'>Please enter the following 'extra' attributes
</span><span class='line'>to be sent with your certificate request
</span><span class='line'>A challenge password []:
</span><span class='line'>An optional company name []:
</span><span class='line'>
</span><span class='line'># 认证机构颁发(自己签发证书)
</span><span class='line'>[hadoop@cu1 conf]$ openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt
</span><span class='line'>Signature ok
</span><span class='line'>subject=/C=CN/ST=Guangdong/L=Guangzhou/O=Eshore/OU=CU/CN=cu1
</span><span class='line'>Getting Private key
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>本地CA授权 &amp; SHA2(推荐)</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu1 apache-tomcat-8.0.38]# ll /etc/pki/CA
</span><span class='line'>total 16
</span><span class='line'>drwxr-xr-x. 2 root root 4096 Mar  1  2016 certs 存放CA签署（颁发）过的数字证书（证书备份目录）
</span><span class='line'>drwxr-xr-x. 2 root root 4096 Mar  1  2016 crl 吊销的证书
</span><span class='line'>drwxr-xr-x. 2 root root 4096 Mar  1  2016 newcerts
</span><span class='line'>drwx------. 2 root root 4096 Mar  1  2016 private 用于存放CA的私钥
</span><span class='line'>[root@cu1 apache-tomcat-8.0.38]# ll /etc/pki/tls/
</span><span class='line'>total 24
</span><span class='line'>lrwxrwxrwx  1 root root    19 May 22  2015 cert.pem -&gt; certs/ca-bundle.crt
</span><span class='line'>drwxr-xr-x. 2 root root  4096 Mar 22  2016 certs
</span><span class='line'>drwxr-xr-x. 2 root root  4096 Mar 22  2016 misc
</span><span class='line'>-rw-r--r--  1 root root 10906 Feb 24  2016 openssl.cnf openssl的CA主配置文件
</span><span class='line'>drwxr-xr-x. 2 root root  4096 Mar  1  2016 private 证书密钥存放目录
</span><span class='line'>
</span><span class='line'># 修改配置(一部分为默认值，一部分与sha2有关)
</span><span class='line'>[root@cu1 pki]# pwd
</span><span class='line'>/etc/pki
</span><span class='line'>[root@cu1 pki]# vi tls/openssl.cnf 
</span><span class='line'>修改一些参数，后面的文件是修改后的
</span><span class='line'>[root@cu1 pki]# diff /home/hadoop/openssl.cnf tls/openssl.cnf 
</span><span class='line'>50c50
</span><span class='line'>&lt; certificate   = $dir/cacert.pem       # The CA certificate
</span><span class='line'>---
</span><span class='line'>&gt; certificate   = $dir/ca.crt   # The CA certificate
</span><span class='line'>55c55
</span><span class='line'>&lt; private_key   = $dir/private/cakey.pem# The private key
</span><span class='line'>---
</span><span class='line'>&gt; private_key   = $dir/private/ca.key # The private key
</span><span class='line'>74c74
</span><span class='line'>&lt; default_crl_days= 30                  # how long before next CRL
</span><span class='line'>---
</span><span class='line'>&gt; default_crl_days= 365                 # how long before next CRL
</span><span class='line'>86,87c86,87
</span><span class='line'>&lt; stateOrProvinceName   = match
</span><span class='line'>&lt; organizationName      = match
</span><span class='line'>---
</span><span class='line'>&gt; stateOrProvinceName   = optional
</span><span class='line'>&gt; organizationName      = optional
</span><span class='line'>107c107
</span><span class='line'>&lt; default_md            = sha1
</span><span class='line'>---
</span><span class='line'>&gt; default_md            = sha256
</span><span class='line'>126c126
</span><span class='line'>&lt; # req_extensions = v3_req # The extensions to add to a certificate request
</span><span class='line'>---
</span><span class='line'>&gt; req_extensions = v3_req # The extensions to add to a certificate request
</span><span class='line'>130c130
</span><span class='line'>&lt; countryName_default           = XX
</span><span class='line'>---
</span><span class='line'>&gt; countryName_default           = CN
</span><span class='line'>135c135
</span><span class='line'>&lt; #stateOrProvinceName_default  = Default Province
</span><span class='line'>---
</span><span class='line'>&gt; #stateOrProvinceName_default  = GD
</span><span class='line'>
</span><span class='line'># CA证书
</span><span class='line'>清理原来的旧文件
</span><span class='line'>[root@cu1 pki]# cd CA
</span><span class='line'>[root@cu1 CA]# rm -rf index.txt* serial*
</span><span class='line'>[root@cu1 CA]# rm cacert.pem private/cakey.pem 
</span><span class='line'>初始化
</span><span class='line'>[root@cu1 CA]# touch index.txt serial
</span><span class='line'>[root@cu1 CA]# echo 01 &gt; serial 
</span><span class='line'>
</span><span class='line'>[root@cu1 CA]# openssl genrsa -out private/ca.key 2048
</span><span class='line'>Generating RSA private key, 2048 bit long modulus
</span><span class='line'>.........................................................................+++
</span><span class='line'>...........................+++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>
</span><span class='line'>[root@cu1 CA]# chmod 600 private/ca.key 
</span><span class='line'>
</span><span class='line'>[root@cu1 CA]# openssl req -new -x509 -key private/ca.key -out ca.crt
</span><span class='line'>You are about to be asked to enter information that will be incorporated
</span><span class='line'>into your certificate request.
</span><span class='line'>What you are about to enter is what is called a Distinguished Name or a DN.
</span><span class='line'>There are quite a few fields but you can leave some blank
</span><span class='line'>For some fields there will be a default value,
</span><span class='line'>If you enter '.', the field will be left blank.
</span><span class='line'>-----
</span><span class='line'>Country Name (2 letter code) [CN]:CN
</span><span class='line'>State or Province Name (full name) []:GD
</span><span class='line'>Locality Name (eg, city) [Default City]:GZ
</span><span class='line'>Organization Name (eg, company) [Default Company Ltd]:Eshore
</span><span class='line'>Organizational Unit Name (eg, section) []:CU   
</span><span class='line'>Common Name (eg, your name or your server's hostname) []:eshore.cn
</span><span class='line'>Email Address []:ca@eshore.cn
</span><span class='line'>
</span><span class='line'># 应用端证书的新建
</span><span class='line'>[root@cu1 conf]# openssl genrsa -out nginx.key 2048
</span><span class='line'>Generating RSA private key, 2048 bit long modulus
</span><span class='line'>...................................................................+++
</span><span class='line'>.....+++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>[root@cu1 conf]# 
</span><span class='line'>
</span><span class='line'>[root@cu1 conf]# openssl req -new -key nginx.key -out nginx.csr
</span><span class='line'>You are about to be asked to enter information that will be incorporated
</span><span class='line'>into your certificate request.
</span><span class='line'>What you are about to enter is what is called a Distinguished Name or a DN.
</span><span class='line'>There are quite a few fields but you can leave some blank
</span><span class='line'>For some fields there will be a default value,
</span><span class='line'>If you enter '.', the field will be left blank.
</span><span class='line'>-----
</span><span class='line'>Country Name (2 letter code) [CN]:CN
</span><span class='line'>State or Province Name (full name) []:GD
</span><span class='line'>Locality Name (eg, city) [Default City]:GZ
</span><span class='line'>Organization Name (eg, company) [Default Company Ltd]:Eshore
</span><span class='line'>Organizational Unit Name (eg, section) []:Cu
</span><span class='line'>Common Name (eg, your name or your server's hostname) []:cu.eshore.cn
</span><span class='line'>Email Address []:cu@eshore.cn
</span><span class='line'>
</span><span class='line'>Please enter the following 'extra' attributes
</span><span class='line'>to be sent with your certificate request
</span><span class='line'>A challenge password []:
</span><span class='line'>An optional company name []:
</span><span class='line'>
</span><span class='line'>查看是否为sha-2
</span><span class='line'>[root@cu1 conf]# openssl req -in nginx.csr -text | grep sha256
</span><span class='line'>
</span><span class='line'># 应用端证书颁发 方式二选一
</span><span class='line'>* 默认的方式，但不是sha-2。把生成的证书请求csr文件发到CA服务器上，在CA上执行：
</span><span class='line'>签发过程其实默认使用配置中的ca.crt和ca.key这两个文件.
</span><span class='line'>[root@cu1 conf]# openssl ca -in nginx.csr -out nginx.crt
</span><span class='line'>Using configuration from /etc/pki/tls/openssl.cnf
</span><span class='line'>Check that the request matches the signature
</span><span class='line'>Signature ok
</span><span class='line'>Certificate Details:
</span><span class='line'>        Serial Number: 1 (0x1)
</span><span class='line'>        Validity
</span><span class='line'>            Not Before: Jan 19 07:24:24 2017 GMT
</span><span class='line'>            Not After : Jan 19 07:24:24 2018 GMT
</span><span class='line'>        Subject:
</span><span class='line'>            countryName               = CN
</span><span class='line'>            stateOrProvinceName       = GD
</span><span class='line'>            organizationName          = Eshore
</span><span class='line'>            organizationalUnitName    = Cu
</span><span class='line'>            commonName                = cu.eshore.cn
</span><span class='line'>            emailAddress              = cu@eshore.cn
</span><span class='line'>        X509v3 extensions:
</span><span class='line'>            X509v3 Basic Constraints: 
</span><span class='line'>                CA:FALSE
</span><span class='line'>            Netscape Comment: 
</span><span class='line'>                OpenSSL Generated Certificate
</span><span class='line'>            X509v3 Subject Key Identifier: 
</span><span class='line'>                7B:3D:E8:18:D9:77:20:8F:A2:76:7F:6C:F2:01:65:49:3F:92:1A:7F
</span><span class='line'>            X509v3 Authority Key Identifier: 
</span><span class='line'>                keyid:5F:8C:1E:3D:F7:A1:86:82:22:F5:88:12:36:16:82:49:B6:9C:84:F1
</span><span class='line'>
</span><span class='line'>Certificate is to be certified until Jan 19 07:24:24 2018 GMT (365 days)
</span><span class='line'>Sign the certificate? [y/n]:y
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>1 out of 1 certificate requests certified, commit? [y/n]y
</span><span class='line'>Write out database with 1 new entries
</span><span class='line'>Data Base Updated
</span><span class='line'>[root@cu1 conf]# 
</span><span class='line'>
</span><span class='line'>* sha-2签名算法
</span><span class='line'>http://www.ibm.com/support/knowledgecenter/zh/SSPMR3_9.0.0/com.ibm.tivoli.tem.doc_9.0/SUA_9.0/com.ibm.license.mgmt.doc/security/t_generate_certificate_CA.html
</span><span class='line'>[root@cu1 conf]# openssl x509 -req -days 365 -in nginx.csr -CA /etc/pki/CA/ca.crt -CAkey /etc/pki/CA/private/ca.key -CAserial /etc/pki/CA/serial -sha256 -out nginx.crt 
</span><span class='line'>Signature ok
</span><span class='line'>subject=/C=CN/ST=GD/L=GZ/O=Eshore/OU=Cu/CN=cu.eshore.cn/emailAddress=cu@eshore.cn
</span><span class='line'>Getting CA Private Key
</span></code></pre></td></tr></table></div></figure>


<p>生成key和csr请求可以一条命令搞定(==后期增加，和本文的一些配置有出处==)：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://www.digicert.com/easy-csr/openssl.htm
</span><span class='line'>
</span><span class='line'>openssl req -new -newkey rsa:2048 -nodes -out star_winse_com.csr -keyout star_winse_com.key -subj "/C=CN/ST=GD/L=GZ/O=winse/CN=*.winse.com"</span></code></pre></td></tr></table></div></figure>


<h2>nginx配置</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server {
</span><span class='line'>    listen       14443 ssl;
</span><span class='line'>    server_name  cu.eshore.cn;
</span><span class='line'>
</span><span class='line'>    ssl on;
</span><span class='line'>    ssl_certificate      nginx.crt;
</span><span class='line'>    ssl_certificate_key  nginx.key;
</span><span class='line'>
</span><span class='line'>    ssl_session_cache    shared:SSL:1m;
</span><span class='line'>    ssl_session_timeout  5m;
</span><span class='line'>
</span><span class='line'>    ssl_ciphers  HIGH:!aNULL:!MD5;
</span><span class='line'>    ssl_prefer_server_ciphers  on;
</span><span class='line'>
</span><span class='line'>    location / {
</span><span class='line'>        root   html;
</span><span class='line'>        index  index.html index.htm;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    location /omc {
</span><span class='line'>        proxy_set_header        X-Real-IP $remote_addr;
</span><span class='line'>        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>        proxy_set_header        Host $http_host;
</span><span class='line'>
</span><span class='line'>        proxy_pass http://localhost:9000;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>MAKR</p>

<blockquote><p>同时，为了统一，你可以把这三个文件都移动到 /etc/ssl/private/ 目录。
然后可以修改 Nginx 配置文件
server { <br/>
    listen 80;
    listen [::]:80 ssl ipv6only=on;<br/>
    listen 443 ssl;
    listen [::]:443 ssl ipv6only=on;
    server_name example.com;
    ssl on;
    ssl_certificate /etc/ssl/private/example_com.crt;
    ssl_certificate_key /etc/ssl/private/example_com.key;
}</p>

<p>server_names barretlee.com *.barretlee.com
ssl on;
ssl_certificate /etc/nginx/ssl/barretlee.com.crt;
ssl_certificate_key /etc/nginx/ssl/barretlee.com.key;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
ssl_ciphers &ldquo;EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4EECDH EDH+aRSA RC4 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !MEDIUM&rdquo;;</p>

<h1>Add perfect forward secrecy</h1>

<p>ssl_prefer_server_ciphers on;
add_header Strict-Transport-Security &ldquo;max-age=31536000; includeSubdomains&rdquo;;</p>

<p>同时，如果是全站 HTTPS 并且不考虑 HTTP 的话，可以加入 HSTS 告诉你的浏览器本
网站全站加密，并且强制用 HTTPS 访问
        add_header Strict-Transport-Security max-age=63072000;
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
同时也可以单独开一个 Nginx 配置，把 HTTP 的访问请求都用 301 跳转到 HTTPS</p>

<p>浏览器访问HTTP的请求重定向到HTTPS
If they come here using HTTP, bounce them to the correct scheme
error_page 497 <a href="https://$host:$server_port$request_uri;">https://$host:$server_port$request_uri;</a></p></blockquote>

<p>curl访问(把CA证书内容加入到ca-bundle.crt)：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master2 nginx]# curl https://www.winse.com
</span><span class='line'>curl: (60) Peer certificate cannot be authenticated with known CA certificates
</span><span class='line'>More details here: http://curl.haxx.se/docs/sslcerts.html
</span><span class='line'>
</span><span class='line'>curl performs SSL certificate verification by default, using a "bundle"
</span><span class='line'> of Certificate Authority (CA) public keys (CA certs). If the default
</span><span class='line'> bundle file isn't adequate, you can specify an alternate file
</span><span class='line'> using the --cacert option.
</span><span class='line'>If this HTTPS server uses a certificate signed by a CA represented in
</span><span class='line'> the bundle, the certificate verification probably failed due to a
</span><span class='line'> problem with the certificate (it might be expired, or the name might
</span><span class='line'> not match the domain name in the URL).
</span><span class='line'>If you'd like to turn off curl's verification of the certificate, use
</span><span class='line'> the -k (or --insecure) option.
</span><span class='line'> 
</span><span class='line'>[root@hadoop-master2 CA]# cp /etc/pki/tls/certs/ca-bundle.crt{,.bak}
</span><span class='line'>[root@hadoop-master2 CA]# cat /etc/pki/CA/ca.crt &gt;&gt; /etc/pki/tls/certs/ca-bundle.crt
</span><span class='line'>[root@hadoop-master2 CA]# 
</span><span class='line'>[root@hadoop-master2 CA]# curl https://www.winse.com
</span><span class='line'>curl: (51) SSL: certificate subject name 'winse.com' does not match target host name 'www.winse.com'
</span><span class='line'>[root@hadoop-master2 CA]# curl https://winse.com
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h2>tomcat配置https</h2>

<p>直接使用nginx的key和crt，需要安装APR.</p>

<ul>
<li><a href="http://stackoverflow.com/questions/8716259/what-does-the-apr-based-apache-tomcat-native-library-was-not-found-mean">http://stackoverflow.com/questions/8716259/what-does-the-apr-based-apache-tomcat-native-library-was-not-found-mean</a></li>
<li><a href="http://stackoverflow.com/questions/4278047/apr-based-apache-tomcat-native-library-was-not-found-on-the-java-library-path">http://stackoverflow.com/questions/4278047/apr-based-apache-tomcat-native-library-was-not-found-on-the-java-library-path</a></li>
<li><a href="http://jmchung.github.io/blog/2013/09/06/centos-installing-apache-portable-runtime-apr-for-tomcat/">http://jmchung.github.io/blog/2013/09/06/centos-installing-apache-portable-runtime-apr-for-tomcat/</a></li>
<li><a href="https://tomcat.apache.org/native-doc/">https://tomcat.apache.org/native-doc/</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@cu1 apache-tomcat-8.0.38]# yum install tomcat-native
</span><span class='line'>[root@cu1 apache-tomcat-8.0.38]# less conf/server.xml 
</span><span class='line'>&lt;Connector
</span><span class='line'>           protocol="org.apache.coyote.http11.Http11AprProtocol"
</span><span class='line'>           port="9443" maxThreads="200"
</span><span class='line'>           scheme="https" secure="true" SSLEnabled="true"
</span><span class='line'>           SSLCertificateFile="/home/cu/tools/apache-tomcat-8.0.38/conf/nginx.crt"
</span><span class='line'>           SSLCertificateKeyFile="/home/cu/tools/apache-tomcat-8.0.38/conf/nginx.key"
</span><span class='line'>           SSLVerifyClient="optional" SSLProtocol="TLSv1+TLSv1.1+TLSv1.2"/&gt;</span></code></pre></td></tr></table></div></figure>


<h2>本地访问</h2>

<p>把/etc/pki/CA目录下的ca.crt拷贝本地，安装到<strong>受信任的根证书颁发机构</strong>目录下面。然后https访问即可。</p>

<h2>参考</h2>

<ul>
<li>V<a href="http://seanlook.com/2015/01/18/openssl-self-sign-ca/">基于OpenSSL自建CA和颁发SSL证书</a></li>
<li><p>V<a href="http://blog.csdn.net/napolunyishi/article/details/42425827">CentOS6.5下openssl加密解密及CA自签颁发证书详解</a></p></li>
<li><p><a href="http://fengwan.blog.51cto.com/508652/1869743">OpenSSL生成自签名的sha256泛域名证书</a></p></li>
<li><p><a href="http://blog.csdn.net/kent7306/article/details/50547388">tomcat配置https单向认证笔记</a></p></li>
<li><a href="https://tomcat.apache.org/tomcat-7.0-doc/ssl-howto.html">SSL/TLS Configuration HOW-TO</a></li>
<li><p><a href="https://www.oschina.net/question/12_23148">5分钟内搞定 Tomcat 的 SSL 配置</a></p></li>
<li><p><a href="http://www.freehao123.com/startssl-ssl/">StartSSL免费SSL证书</a></p></li>
<li><a href="http://nginx.org/en/docs/http/configuring_https_servers.html#single_http_https_server">http://nginx.org/en/docs/http/configuring_https_servers.html#single_http_https_server</a></li>
<li>Redirect http to https in nginx <a href="http://serverfault.com/questions/338700/redirect-http-mydomain-com12345-to-https-mydomain-com12345-in-nginx">http://serverfault.com/questions/338700/redirect-http-mydomain-com12345-to-https-mydomain-com12345-in-nginx</a></li>
</ul>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[elasticsearch5安装Head插件]]></title>
    <link href="http://winseliu.com/blog/2016/12/14/elasticsearch5-head-plugin-config/"/>
    <updated>2016-12-14T20:16:39+08:00</updated>
    <id>http://winseliu.com/blog/2016/12/14/elasticsearch5-head-plugin-config</id>
    <content type="html"><![CDATA[<p>新版本ES5和原来的有写不同，head等一些插件不能直接安装，需要单独起一个程序然后通过ajax的方式获取数据。</p>

<p>下载 elasticsearch-5.1.1 ，修改配置 <strong> network.host: cu-ud1 </strong>，然后启动服务 bin/elasticsearch -d 。</p>

<p>Head插件安装相对比较麻烦。在windows一些插件安装不了，现在能上外网的Linux下载依赖，然后把全部的包复制到生产环境。最后配置并启动head服务。</p>

<ul>
<li><a href="https://github.com/mobz/elasticsearch-head#running-with-built-in-server">https://github.com/mobz/elasticsearch-head#running-with-built-in-server</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu2 elasticsearch-head]$ npm install
</span><span class='line'>
</span><span class='line'>[ud@cu-ud1 ~]$ xz -d node-v6.9.2-linux-x64.tar.xz 
</span><span class='line'>[ud@cu-ud1 ~]$ tar xvf node-v6.9.2-linux-x64.tar 
</span><span class='line'>[ud@cu-ud1 node-v6.9.2-linux-x64]$ vi ~/.bash_profile 
</span><span class='line'>...
</span><span class='line'>NODE_HOME=/home/ud/node-v6.9.2-linux-x64
</span><span class='line'>PATH=$NODE_HOME/bin:$PATH
</span><span class='line'>export PATH
</span><span class='line'>
</span><span class='line'>[ud@cu-ud1 ~]$ tar zxvf elasticsearch-head-standalone.tar.gz 
</span><span class='line'>
</span><span class='line'>[ud@cu-ud1 elasticsearch-5.1.1]$ vi config/elasticsearch.yml 
</span><span class='line'>...
</span><span class='line'>http.cors.enabled: true
</span><span class='line'>http.cors.allow-origin: "*"
</span><span class='line'>
</span><span class='line'>[ud@cu-ud1 elasticsearch-head]$ node_modules/grunt/bin/grunt server
</span></code></pre></td></tr></table></div></figure>


<p>然后浏览器访问9100端口即可。</p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Spark2-0 & Kafka0-10-1订阅多个单只读一个分区]]></title>
    <link href="http://winseliu.com/blog/2016/12/09/spark2-0-kafka0-10-1-partitions-work-incorrent/"/>
    <updated>2016-12-09T12:02:38+08:00</updated>
    <id>http://winseliu.com/blog/2016/12/09/spark2-0-kafka0-10-1-partitions-work-incorrent</id>
    <content type="html"><![CDATA[<p>同事在使用Spark-Kafka-Streaming的时刻遇到只能读取一个分区的情况，最后他找到问题所在。这里记录下，说白了就是Spark-2.0.0默认是用Kafka-0.10.0.1，自己换程序版本有风险！</p>

<h2>问题的关键点</h2>

<ul>
<li>Kafka-0.10.1.0</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org/apache/kafka/clients/consumer/KafkaConsumer.java
</span><span class='line'>    private void updateFetchPositions(Set&lt;TopicPartition&gt; partitions) {
</span><span class='line'>        // lookup any positions for partitions which are awaiting reset (which may be the
</span><span class='line'>        // case if the user called seekToBeginning or seekToEnd. We do this check first to
</span><span class='line'>        // avoid an unnecessary lookup of committed offsets (which typically occurs when
</span><span class='line'>        // the user is manually assigning partitions and managing their own offsets).
</span><span class='line'>        fetcher.resetOffsetsIfNeeded(partitions);
</span><span class='line'>
</span><span class='line'>        if (!subscriptions.hasAllFetchPositions()) {
</span><span class='line'>            // if we still don't have offsets for all partitions, then we should either seek
</span><span class='line'>            // to the last committed position or reset using the auto reset policy
</span><span class='line'>
</span><span class='line'>            // first refresh commits for all assigned partitions
</span><span class='line'>            coordinator.refreshCommittedOffsetsIfNeeded();
</span><span class='line'>
</span><span class='line'>            // then do any offset lookups in case some positions are not known
</span><span class='line'>            fetcher.updateFetchPositions(partitions);
</span><span class='line'>        }
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Kafka-0.10.0.1</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org.apache.kafka.clients.consumer.KafkaConsumer#updateFetchPositions
</span><span class='line'>    private void updateFetchPositions(Set&lt;TopicPartition&gt; partitions) {
</span><span class='line'>        // refresh commits for all assigned partitions
</span><span class='line'>        coordinator.refreshCommittedOffsetsIfNeeded();
</span><span class='line'>
</span><span class='line'>        // then do any offset lookups in case some positions are not known
</span><span class='line'>        fetcher.updateFetchPositions(partitions);
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<h2>问题描述以及说明</h2>

<p>当订阅同一个主题的多个分区时，每次SparkStreaming会获取每次处理的Offset。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org.apache.spark.streaming.kafka010.DirectKafkaInputDStream#latestOffsets
</span><span class='line'>  protected def latestOffsets(): Map[TopicPartition, Long] = {
</span><span class='line'>    val c = consumer
</span><span class='line'>    c.poll(0)
</span><span class='line'>    val parts = c.assignment().asScala
</span><span class='line'>
</span><span class='line'>    // make sure new partitions are reflected in currentOffsets
</span><span class='line'>    val newPartitions = parts.diff(currentOffsets.keySet)
</span><span class='line'>    // position for new partitions determined by auto.offset.reset if no commit
</span><span class='line'>    currentOffsets = currentOffsets ++ newPartitions.map(tp =&gt; tp -&gt; c.position(tp)).toMap
</span><span class='line'>    // don't want to consume messages, so pause
</span><span class='line'>    c.pause(newPartitions.asJava)
</span><span class='line'>    // find latest available offsets
</span><span class='line'>    c.seekToEnd(currentOffsets.keySet.asJava)
</span><span class='line'>    parts.map(tp =&gt; tp -&gt; c.position(tp)).toMap
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  override def compute(validTime: Time): Option[KafkaRDD[K, V]] = {
</span><span class='line'>    val untilOffsets = clamp(latestOffsets())
</span><span class='line'>    val offsetRanges = untilOffsets.map { case (tp, uo) =&gt;
</span><span class='line'>      val fo = currentOffsets(tp)
</span><span class='line'>      OffsetRange(tp.topic, tp.partition, fo, uo)
</span><span class='line'>    }
</span><span class='line'>    val rdd = new KafkaRDD[K, V](
</span><span class='line'>      context.sparkContext, executorKafkaParams, offsetRanges.toArray, getPreferredHosts, true)
</span><span class='line'>... </span></code></pre></td></tr></table></div></figure>


<p>如果使用kafka-0.10.1.0时，seekToEnd会重置当前客户端分区实例的position为null。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org.apache.kafka.clients.consumer.KafkaConsumer#seekToEnd
</span><span class='line'>    public void seekToEnd(Collection&lt;TopicPartition&gt; partitions) {
</span><span class='line'>        acquire();
</span><span class='line'>        try {
</span><span class='line'>            Collection&lt;TopicPartition&gt; parts = partitions.size() == 0 ? this.subscriptions.assignedPartitions() : partitions;
</span><span class='line'>            for (TopicPartition tp : parts) {
</span><span class='line'>                log.debug("Seeking to end of partition {}", tp);
</span><span class='line'>                subscriptions.needOffsetReset(tp, OffsetResetStrategy.LATEST);
</span><span class='line'>            }
</span><span class='line'>        } finally {
</span><span class='line'>            release();
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>org.apache.kafka.clients.consumer.internals.SubscriptionState#needOffsetReset(TopicPartition, OffsetResetStrategy)
</span><span class='line'>    public void needOffsetReset(TopicPartition partition, OffsetResetStrategy offsetResetStrategy) {
</span><span class='line'>        assignedState(partition).awaitReset(offsetResetStrategy);
</span><span class='line'>    } 
</span><span class='line'>org.apache.kafka.clients.consumer.internals.SubscriptionState.TopicPartitionState#awaitReset
</span><span class='line'>        private void awaitReset(OffsetResetStrategy strategy) {
</span><span class='line'>            this.resetStrategy = strategy;
</span><span class='line'>            this.position = null;
</span><span class='line'>        }</span></code></pre></td></tr></table></div></figure>


<p>此时再调用position一个个分区的获取最新位置信息。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>org.apache.kafka.clients.consumer.KafkaConsumer#position
</span><span class='line'>    public long position(TopicPartition partition) {
</span><span class='line'>        acquire();
</span><span class='line'>        try {
</span><span class='line'>            if (!this.subscriptions.isAssigned(partition))
</span><span class='line'>                throw new IllegalArgumentException("You can only check the position for partitions assigned to this consumer.");
</span><span class='line'>            Long offset = this.subscriptions.position(partition);
</span><span class='line'>            if (offset == null) {
</span><span class='line'>                updateFetchPositions(Collections.singleton(partition));
</span><span class='line'>                offset = this.subscriptions.position(partition);
</span><span class='line'>            }
</span><span class='line'>            return offset;
</span><span class='line'>        } finally {
</span><span class='line'>            release();
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    private void updateFetchPositions(Set&lt;TopicPartition&gt; partitions) {
</span><span class='line'>        // lookup any positions for partitions which are awaiting reset (which may be the
</span><span class='line'>        // case if the user called seekToBeginning or seekToEnd. We do this check first to
</span><span class='line'>        // avoid an unnecessary lookup of committed offsets (which typically occurs when
</span><span class='line'>        // the user is manually assigning partitions and managing their own offsets).
</span><span class='line'>        fetcher.resetOffsetsIfNeeded(partitions);
</span><span class='line'>
</span><span class='line'>        if (!subscriptions.hasAllFetchPositions()) {
</span><span class='line'>            // if we still don't have offsets for all partitions, then we should either seek
</span><span class='line'>            // to the last committed position or reset using the auto reset policy
</span><span class='line'>
</span><span class='line'>            // first refresh commits for all assigned partitions
</span><span class='line'>            coordinator.refreshCommittedOffsetsIfNeeded();
</span><span class='line'>
</span><span class='line'>            // then do any offset lookups in case some positions are not known
</span><span class='line'>            fetcher.updateFetchPositions(partitions);
</span><span class='line'>        }
</span><span class='line'>    } 
</span><span class='line'>
</span><span class='line'>org.apache.kafka.clients.consumer.internals.Fetcher#resetOffsetsIfNeeded
</span><span class='line'>    public void resetOffsetsIfNeeded(Set&lt;TopicPartition&gt; partitions) {
</span><span class='line'>        for (TopicPartition tp : partitions) {
</span><span class='line'>            // TODO: If there are several offsets to reset, we could submit offset requests in parallel
</span><span class='line'>            if (subscriptions.isAssigned(tp) && subscriptions.isOffsetResetNeeded(tp))
</span><span class='line'>                resetOffset(tp);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>org.apache.kafka.clients.consumer.internals.SubscriptionState.TopicPartitionState#seek
</span><span class='line'>        private void seek(long offset) {
</span><span class='line'>            this.position = offset;
</span><span class='line'>            this.resetStrategy = null;
</span><span class='line'>        } </span></code></pre></td></tr></table></div></figure>


<p>新版本KafkaConsumer先更新位置，最终调用seek设置position以及重置resetStrategy。</p>

<p>但是后面又额外多了一个判断！！检测所有的分区，只要有一个有问题就重新获取position，最对有问题啊！尽管后面又调用updateFetchPositions但是环境已经变了啊！！导致多个分区的情况下只能读取一个分区的数据。</p>

<p>问题找到了，直接客户端用旧的就行了。</p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jasperreports使用小结]]></title>
    <link href="http://winseliu.com/blog/2016/12/01/jasperreports-brief-summary/"/>
    <updated>2016-12-01T12:04:32+08:00</updated>
    <id>http://winseliu.com/blog/2016/12/01/jasperreports-brief-summary</id>
    <content type="html"><![CDATA[<p>最近接了一个报表的任务，原来也有接触过，但是仅限于了解没有真正的动手画过。这里把从选型到最后成型一路下来遇到的问题整理下。</p>

<p>主要两个大问题：环境的搭建，以及子报表(嵌套报表)的配置。</p>

<h2>选择Jasperreports</h2>

<p>知道的有Birts、Pentaho、FineReport感觉其实都差不多，大家各自都取长补当更多。由于一穷二白的，没有弄过。网上找了和SpringMVC结合的都是Jasperreport的文章，就这么草率的定下来了。</p>

<p>基本的操作都类似，报表HelloWorld还是比较简单的。下载<a href="http://community.jaspersoft.com/project/jaspersoft-studio">jaspersoftstudio</a>最新版，然后了解各个区域的作用。</p>

<ul>
<li><a href="http://www.lai18.com/content/9047924.html">JasperReport入门</a></li>
<li><a href="http://blog.csdn.net/bryanliu1982/article/details/598176">JasperReport Tutorial（翻译）</a></li>
</ul>


<blockquote><p>一个完全的报表模板包括如下几个区域：title, pageHeader, columnHeader, groupHeader, detail, groupFooter, columnFoter, pageFooter, summary</p></blockquote>

<h2>整合SpringMVC</h2>

<p>原来做报表的同时都是直接连数据库的，过程中遇到各种问题。很多没法维护的事情发生：改个字段，数据库测试/生产链接等等。我这里直接选择通过JavaBean来传递数据。</p>

<ul>
<li>*<a href="http://blog.csdn.net/hwt_211/article/details/19904333">SpringMVC整合jasperreport做报表</a></li>
<li><a href="http://www.javacoder.cn/?p=188">Spring MVC中使用JasperReport</a></li>
<li><a href="http://zzc1684.iteye.com/blog/2189000">SpringMVC与iReport(JasperReports) 5.6整合开发实例</a></li>
</ul>


<p>贴代码之前先说PDF报表字体的问题，本来报表是加粗的，但是服务器生成浏览的时刻没有效果。发现还需要单独添加字体的包：<a href="http://stackoverflow.com/questions/25977427/bold-not-working-in-jaspersoft-studio-for-fonts-other-than-sans-serif">pdf - Bold not working in Jaspersoft Studio for fonts other than sans serif</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#maven
</span><span class='line'>&lt;properties&gt;
</span><span class='line'>      &lt;spring.version&gt;4.2.5.RELEASE&lt;/spring.version&gt;
</span><span class='line'>...
</span><span class='line'>      &lt;dependency&gt;
</span><span class='line'>          &lt;groupId&gt;net.sf.jasperreports&lt;/groupId&gt;
</span><span class='line'>          &lt;artifactId&gt;jasperreports&lt;/artifactId&gt;
</span><span class='line'>          &lt;version&gt;6.3.1&lt;/version&gt;
</span><span class='line'>      &lt;/dependency&gt;
</span><span class='line'>      &lt;dependency&gt;
</span><span class='line'>          &lt;groupId&gt;net.sf.jasperreports&lt;/groupId&gt;
</span><span class='line'>          &lt;artifactId&gt;jasperreports-fonts&lt;/artifactId&gt;
</span><span class='line'>          &lt;version&gt;6.0.0&lt;/version&gt;
</span><span class='line'>      &lt;/dependency&gt;
</span><span class='line'>      &lt;dependency&gt;
</span><span class='line'>          &lt;groupId&gt;com.itextpdf&lt;/groupId&gt;
</span><span class='line'>          &lt;artifactId&gt;itextpdf&lt;/artifactId&gt;
</span><span class='line'>          &lt;version&gt;5.5.10&lt;/version&gt;
</span><span class='line'>      &lt;/dependency&gt;
</span><span class='line'>      &lt;dependency&gt;
</span><span class='line'>          &lt;groupId&gt;com.itextpdf&lt;/groupId&gt;
</span><span class='line'>          &lt;artifactId&gt;itext-asian&lt;/artifactId&gt;
</span><span class='line'>          &lt;version&gt;5.2.0&lt;/version&gt;
</span><span class='line'>      &lt;/dependency&gt;
</span><span class='line'>      &lt;dependency&gt;
</span><span class='line'>          &lt;groupId&gt;org.codehaus.groovy&lt;/groupId&gt;
</span><span class='line'>          &lt;artifactId&gt;groovy-all&lt;/artifactId&gt;
</span><span class='line'>          &lt;version&gt;2.4.7&lt;/version&gt;
</span><span class='line'>      &lt;/dependency&gt;
</span><span class='line'>
</span><span class='line'># spring mvc xml
</span><span class='line'>  &lt;bean id="viewResolver" class="org.springframework.web.servlet.view.ResourceBundleViewResolver"&gt;
</span><span class='line'>      &lt;property name="order" value="0"&gt;&lt;/property&gt;
</span><span class='line'>      &lt;property name="basename" value="views"&gt;&lt;/property&gt;
</span><span class='line'>  &lt;/bean&gt;
</span><span class='line'>  &lt;bean class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;
</span><span class='line'>      &lt;property name="order" value="1"&gt;&lt;/property&gt;
</span><span class='line'>      &lt;property name="viewClass"&gt;
</span><span class='line'>          &lt;value&gt;org.springframework.web.servlet.view.JstlView&lt;/value&gt;
</span><span class='line'>      &lt;/property&gt;
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'># views.properties
</span><span class='line'>HELLO.(class)=org.springframework.web.servlet.view.jasperreports.JasperReportsPdfView 
</span><span class='line'>HELLO.url=/WEB-INF/report/helloworld.jasper
</span><span class='line'>HELLO.reportDataKey=datasource
</span><span class='line'>
</span><span class='line'># java Controller
</span><span class='line'>@Controller
</span><span class='line'>@RequestMapping("/report")
</span><span class='line'>public class HelloReportController {
</span><span class='line'>
</span><span class='line'>  @RequestMapping("/hello.pdf")
</span><span class='line'>  public ModelAndView printExpress() {
</span><span class='line'>      ModelAndView mv = new ModelAndView("HELLO");
</span><span class='line'>
</span><span class='line'>      // 如果直接传对象bean不行，需要使用list传值
</span><span class='line'>      List&lt;HelloWorldData&gt; list = new ArrayList&lt;&gt;();
</span><span class='line'>      list.add(new HelloWorldData("jarperreport", "Hi"));
</span><span class='line'>
</span><span class='line'>      mv.addObject("datasource", list);
</span><span class='line'>      return mv;
</span><span class='line'>  }
</span></code></pre></td></tr></table></div></figure>


<p>最后通过浏览器就能查看报表的PDF文件了。</p>

<p>前端所有的页面都是通过ajax来获取展示的，这里通过jquery-media.js来进行展示（生成内嵌的iframe），这也是上面的地址加上pdf后缀的原因。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># html
</span><span class='line'>&lt;div class="modal-body" style="max-height: 900px; padding: 10px;"&gt;
</span><span class='line'>  &lt;a class="media" href="${contextPath}${url}"&gt;&lt;/a&gt;
</span><span class='line'>&lt;/div&gt;
</span><span class='line'>
</span><span class='line'># jquery
</span><span class='line'>$('a.media', $modal).media({width:"100%", height:600});</span></code></pre></td></tr></table></div></figure>


<h2>子报表</h2>

<p>有一个结账的报表，既要展示汇总信息，还得把详情列表也输出出来。一开始的JavaBean：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class InvoiceData {
</span><span class='line'>  private String roomNo;
</span><span class='line'>  private List&lt;InvoiceDetailData&gt; details;
</span><span class='line'>  ...
</span><span class='line'>}
</span><span class='line'>public class InvoiceDetailData {
</span><span class='line'>  private String date;
</span><span class='line'>  private String amount;
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>但是简单报表是一维的，不能展示list里面的内容。网上一堆资料都是简单的案例，涉及多维度的就Table、Crosstable、Subreport这几个控件。Table的样式调起来麻烦，数据也不知道怎么搞。子报表至少看起来合乎逻辑，操作起来也简单。画好图标以及把对应的字段对应好后，子报表的Datasource直接填 <code>$F{details}</code> 。</p>

<p>修改views.properties，写好controller后，启动竟然报<strong>找不到details子报表</strong>路径。根据文章修改如下：</p>

<ul>
<li>*<a href="http://docs.spring.io/autorepo/docs/spring-framework/3.0.0.M3/reference/html/ch17s07.html">Working with Sub-Reports</a></li>
<li><a href="https://www.tutorialspoint.com/jasper_reports/jasper_create_subreports.htm">Create SubReports</a></li>
<li>*<a href="http://it.zhaozhao.info/archives/5581">在 Spring MVC 3.1.2.RELEASE 产出 JasperReports 4.7.1 子报表（Subreport）</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 主报表
</span><span class='line'># 类型必须加哦！
</span><span class='line'>  &lt;parameter name="DetailSubReport" class="net.sf.jasperreports.engine.JasperReport"/&gt;
</span><span class='line'>  ...
</span><span class='line'>  &lt;subreport&gt;
</span><span class='line'>      &lt;reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="520" height="167" uuid="8d69d85b-4fcf-482a-836c-c1698ce42dcd"/&gt;
</span><span class='line'>      &lt;dataSourceExpression&gt;&lt;![CDATA[$F{details}]]&gt;&lt;/dataSourceExpression&gt;
</span><span class='line'>      &lt;subreportExpression&gt;&lt;![CDATA[$P{DetailSubReport}]]&gt;&lt;/subreportExpression&gt;
</span><span class='line'>  &lt;/subreport&gt;
</span><span class='line'>  
</span><span class='line'># views.properties
</span><span class='line'>Invoice.(class)=org.springframework.web.servlet.view.jasperreports.JasperReportsPdfView 
</span><span class='line'>Invoice.url=/WEB-INF/report/invoice.jasper
</span><span class='line'>Invoice.reportDataKey=datasource
</span><span class='line'>Invoice.subReportUrls=DetailSubReport=/WEB-INF/report/InvoiceDetail.jasper</span></code></pre></td></tr></table></div></figure>


<p>罗马建成非一日之功，再次编译启动后，再次报错，这次的是<strong>类型错误</strong>。感觉正在慢慢向成功靠近。修改类型后最后启动展示搞定。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># javabean
</span><span class='line'>public class InvoiceData {
</span><span class='line'>  private JRDataSource details;
</span><span class='line'>  
</span><span class='line'>  public void setDetails(JRDataSource details) {
</span><span class='line'>      this.details = details;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  public void setDetails(List&lt;InvoiceDetailData&gt; details) {
</span><span class='line'>      this.details = new JRBeanCollectionDataSource(details);
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'># 主报表
</span><span class='line'>  &lt;field name="details" class="net.sf.jasperreports.engine.JRDataSource"&gt;
</span><span class='line'>      &lt;fieldDescription&gt;&lt;![CDATA[details]]&gt;&lt;/fieldDescription&gt;
</span><span class='line'>  &lt;/field&gt;</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Play2开发环境搭建]]></title>
    <link href="http://winseliu.com/blog/2016/11/10/play2-development-environment-with-eclipse/"/>
    <updated>2016-11-10T11:56:07+08:00</updated>
    <id>http://winseliu.com/blog/2016/11/10/play2-development-environment-with-eclipse</id>
    <content type="html"><![CDATA[<p>用惯了MAVEN后，在用SBT真有种生不如死的感觉。Maven更沉稳成熟些，SBT感觉首先不熟（入门也没maven简单）并且随性。</p>

<p>好了抱怨了这么多。入题，主要碰到的就是两个问题：</p>

<ol>
<li>Play2的HelloWorld主要卡在网络（也就是sbt的配置）；</li>
<li>导入Eclipse。由于有Maven缺各种插件的体验，这里直接用官网的生成好.class/.project再导入已经存在的项目。</li>
</ol>


<p>接下来一步步的介绍环境的搭建。</p>

<h4>下载Play2和SBT</h4>

<p>下载官网的<a href="https://playframework.com/download">Offline Distribution</a> ,解压后把 <code>activator-dist-1.3.12/repository</code> 的所有文件拷贝到 <code>~/.ivy2/cache</code> 。反正都会下载到这个目录，拷贝更快。</p>

<p>下载<a href="http://www.scala-sbt.org/download.html">SBT</a> ,下载zip就好。</p>

<h4>配置</h4>

<ol>
<li>在 activator-dist-1.3.12 创建 conf/sbtconfig.txt 。同时在 sbt/conf/sbtconfig.txt 加上同样的语句：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-Dsbt.override.build.repos=true</span></code></pre></td></tr></table></div></figure>


<ol>
<li>添加获取jar的repo地址，新建 ~/.sbt/repositories 文件</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[repositories]
</span><span class='line'>  local
</span><span class='line'>  local-maven: file:///D:/maven/.m2/repository/
</span><span class='line'>  cu: http://cu1:8081/nexus/content/groups/public/
</span><span class='line'>  #oschina: http://maven.oschina.net/content/groups/public/
</span><span class='line'>  jcenter: https://jcenter.bintray.com/
</span><span class='line'>  typesafe-ivy-releases: https://repo.typesafe.com/typesafe/ivy-releases/, [organization]/[module]/[revision]/[type]s/[artifact](-[classifier]).[ext], bootOnly
</span><span class='line'>  maven-central
</span><span class='line'>  ivy-typesafe: http://dl.bintray.com/typesafe/ivy-releases, [organization]/[module]/(scala_[scalaVersion]/)(sbt_[sbtVersion]/)[revision]/[type]s/[artifact](-[classifier]).[ext]
</span><span class='line'>  ivy-sbt-plugin: http://dl.bintray.com/sbt/sbt-plugin-releases/, [organization]/[module]/(scala_[scalaVersion]/)(sbt_[sbtVersion]/)[revision]/[type]s/[artifact](-[classifier]).[ext]</span></code></pre></td></tr></table></div></figure>


<p>配置相关参考：</p>

<ul>
<li><a href="http://9leg.com/scala/2015/10/17/scala-play-setting.html">http://9leg.com/scala/2015/10/17/scala-play-setting.html</a></li>
<li><a href="https://afoo.me/posts/2014-11-05-how-make-sbt-jump-over-GFW.html">https://afoo.me/posts/2014-11-05-how-make-sbt-jump-over-GFW.html</a></li>
<li><a href="https://www.jfrog.com/confluence/display/RTF/SBT+Repositories">https://www.jfrog.com/confluence/display/RTF/SBT+Repositories</a> +</li>
<li><a href="http://www.scala-sbt.org/0.13/docs/zh-cn/Library-Dependencies.html">http://www.scala-sbt.org/0.13/docs/zh-cn/Library-Dependencies.html</a></li>
<li><a href="http://www.scala-sbt.org/0.13/docs/Proxy-Repositories.html">http://www.scala-sbt.org/0.13/docs/Proxy-Repositories.html</a></li>
</ul>


<h4>创建新项目</h4>

<ul>
<li><a href="https://playframework.com/documentation/2.5.x/Tutorials">https://playframework.com/documentation/2.5.x/Tutorials</a></li>
</ul>


<p>添加环境变量自己主动点，activator和sbt都加一下。然后运行 activator new 根据模板创建项目。也可以参考官网的直接写build.sbt。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>R:\&gt;activator new helloworld play-java
</span><span class='line'>ACTIVATOR_HOME=E:\local\usr\share\activator-dist-1.3.12
</span><span class='line'>
</span><span class='line'>Fetching the latest list of templates...
</span><span class='line'>
</span><span class='line'>OK, application "helloworld" is being created using the "play-java" template.
</span><span class='line'>
</span><span class='line'>To run "helloworld" from the command line, "cd helloworld" then:
</span><span class='line'>R:\\helloworld/activator run
</span><span class='line'>
</span><span class='line'>To run the test for "helloworld" from the command line, "cd helloworld" then:
</span><span class='line'>R:\\helloworld/activator test
</span><span class='line'>
</span><span class='line'>To run the Activator UI for "helloworld" from the command line, "cd helloworld" then:
</span><span class='line'>R:\\helloworld/activator ui</span></code></pre></td></tr></table></div></figure>


<p>创建好项目后，运行 activator run 看看效果：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>R:\helloworld&gt;activator run
</span><span class='line'>ACTIVATOR_HOME=E:\local\usr\share\activator-dist-1.3.12
</span><span class='line'>[info] Loading project definition from R:\helloworld\project
</span><span class='line'>[info] Updating {file:/R:/helloworld/project/}helloworld-build...
</span><span class='line'>[info] Resolving org.fusesource.jansi#jansi;1.4 ...
</span><span class='line'>[info] Done updating.
</span><span class='line'>[info] Set current project to helloworld (in build file:/R:/helloworld/)
</span><span class='line'>[info] Updating {file:/R:/helloworld/}root...
</span><span class='line'>[info] Resolving jline#jline;2.12.1 ...
</span><span class='line'>[info] Done updating.
</span><span class='line'>
</span><span class='line'>--- (Running the application, auto-reloading is enabled) ---
</span><span class='line'>
</span><span class='line'>[info] p.c.s.NettyServer - Listening for HTTP on /0:0:0:0:0:0:0:0:9000
</span><span class='line'>
</span><span class='line'>(Server started, use Ctrl+D to stop and go back to the console...)
</span></code></pre></td></tr></table></div></figure>


<p>打开浏览器访问 <a href="http://localhost:9000">http://localhost:9000</a> ,访问的时刻可能会实时的编译会等一段时间。</p>

<h4>导入eclipse</h4>

<p>前面已经把helloworld跑起来了，接下来是把功能导入eclipse。直接导入或者手动加classpath挺麻烦的，play的一些配置会最终会编译class的。</p>

<p>这里使用 sbteclipse 来生成 eclipse 项目需要的文件。</p>

<ul>
<li><a href="https://www.playframework.com/documentation/2.5.x/IDE">https://www.playframework.com/documentation/2.5.x/IDE</a></li>
<li><a href="https://github.com/typesafehub/sbteclipse">https://github.com/typesafehub/sbteclipse</a></li>
<li><a href="https://github.com/typesafehub/sbteclipse/wiki/Using-sbteclipse">https://github.com/typesafehub/sbteclipse/wiki/Using-sbteclipse</a></li>
</ul>


<p>需要配置二个文件，先添加插件、然后修改配置。</p>

<p>在 helloworld/project/plugins.sbt 最后添加 sbteclipse 插件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>addSbtPlugin("com.typesafe.sbteclipse" % "sbteclipse-plugin" % "5.0.1")</span></code></pre></td></tr></table></div></figure>


<p>在 helloworld/build.sbt 最后添加配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import com.typesafe.sbteclipse.plugin.EclipsePlugin.EclipseKeys
</span><span class='line'>// Compile the project before generating Eclipse files, so that generated .scala or .class files for views and routes are present
</span><span class='line'>EclipseKeys.preTasks := Seq(compile in Compile)
</span><span class='line'>EclipseKeys.projectFlavor := EclipseProjectFlavor.Java           // Java project. Don't expect Scala IDE
</span><span class='line'>EclipseKeys.createSrc := EclipseCreateSrc.Default + EclipseCreateSrc.ManagedClasses // Use .class files instead of generated .scala files for views and routes
</span><span class='line'>EclipseKeys.withSource := false
</span><span class='line'>EclipseKeys.withJavadoc := false</span></code></pre></td></tr></table></div></figure>


<p>然后用 sbt eclipse 生成IDE项目所需文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>R:\helloworld&gt;sbt
</span><span class='line'>Java HotSpot(TM) 64-Bit Server VM warning: ignoring option MaxPermSize=256m; support was removed in 8
</span><span class='line'>[info] Loading project definition from R:\helloworld\project
</span><span class='line'>[info] Updating {file:/R:/helloworld/project/}helloworld-build...
</span><span class='line'>[info] Resolving org.fusesource.jansi#jansi;1.4 ...
</span><span class='line'>[info] Done updating.
</span><span class='line'>[info] Set current project to helloworld (in build file:/R:/helloworld/)
</span><span class='line'>
</span><span class='line'>[helloworld] $ eclipse
</span><span class='line'>[info] About to create Eclipse project files for your project(s).
</span><span class='line'>[info] Updating {file:/R:/helloworld/}root...
</span><span class='line'>[info] Resolving jline#jline;2.12.1 ...
</span><span class='line'>[info] Done updating.
</span><span class='line'>[info] Compiling 6 Scala sources and 10 Java sources to R:\helloworld\target\scala-2.11\classes...
</span><span class='line'>[info] Successfully created Eclipse project files for project(s):
</span><span class='line'>[info] helloworld
</span><span class='line'>
</span><span class='line'>[helloworld] $ compile
</span><span class='line'>[success] Total time: 3 s, completed 2016-11-10 13:11:49
</span><span class='line'>
</span><span class='line'>[helloworld] $ eclipse
</span><span class='line'>[info] About to create Eclipse project files for your project(s).
</span><span class='line'>[info] Successfully created Eclipse project files for project(s):
</span><span class='line'>[info] helloworld
</span><span class='line'>[helloworld] $</span></code></pre></td></tr></table></div></figure>


<p>我这是专门重新弄的一个工程，依赖是原来已经下载好了的（下载需要等一段时间）。</p>

<p>然后导入已经存在的项目即可。看最终效果图：</p>

<p><img src="http://winseliu.com/images/blogs/play2-dev.jpg" alt="" /></p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[红帽6升级SSH]]></title>
    <link href="http://winseliu.com/blog/2016/10/20/ssh-upgrade-on-centos6/"/>
    <updated>2016-10-20T19:29:50+08:00</updated>
    <id>http://winseliu.com/blog/2016/10/20/ssh-upgrade-on-centos6</id>
    <content type="html"><![CDATA[<p>安全检查报告SSH版本太低存在漏洞需要进行升级，但是红帽没有现成的高版本打包好SSH的rpm。自己动手丰衣足食，没有网上一些朋友遇到那么多的问题，但是也是这纠结过程。</p>

<p>搞一台身边的机器测试安装，如果远程机器搞不好就连不上了！！先手动编译安装一遍，把编译需要的依赖都安装好，然后再rpmbuild就会比较顺利。</p>

<h2>运维同事编译安装的步骤</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>加载光盘的packages
</span><span class='line'># mount -o loop disk1.iso /mnt/disk
</span><span class='line'># vi /etc/yum.repo.d/local.repo
</span><span class='line'>
</span><span class='line'>[root@localhost SOURCES]# ll *.tar.gz
</span><span class='line'>-rw-r--r--. 1 root   root   1499808 3月  10 2016 openssh-7.2p2.tar.gz
</span><span class='line'>-rw-r--r--. 1 root   root   5489494 10月 20 16:41 openssl-1.0.2j.tar.gz
</span><span class='line'>-rw-r--r--. 1 root   root     29229 6月  26 2004 x11-ssh-askpass-1.2.4.1.tar.gz
</span><span class='line'>
</span><span class='line'>一、升级 Zlib
</span><span class='line'>1、下载最新版本 Zlib
</span><span class='line'># ./configure --prefix=/usr/local/zlib
</span><span class='line'>本次遇到GCC未安装
</span><span class='line'>yum -y install gcc
</span><span class='line'>./configure --prefix=/usr/local/zlib
</span><span class='line'># make
</span><span class='line'># make install
</span><span class='line'>这样，就把 zlib 编译安装在 /usr/local/zilib 中了。
</span><span class='line'>二、升级 OpenSSL
</span><span class='line'>1、下载最新版本 OpenSSL
</span><span class='line'>which openssl    查看到当前是在/usr/bin/openssl
</span><span class='line'># ./config --prefix=/usr --shared
</span><span class='line'>本次遇到系统时间不对的，修改好系统时间后config正常。
</span><span class='line'># make
</span><span class='line'># make test （这一步很重要哦！是进行 SSL 加密协议的完整测试，如果出现错误就要一定先找出哪里的原因，否则一味继续可能导致最终 SSH 不能使用，后果很严重哦！）
</span><span class='line'># make install
</span><span class='line'>三、升级 OpenSSH
</span><span class='line'>1、下载最新版本 OpenSSH
</span><span class='line'>#  ./configure --prefix=/usr --sysconfdir=/etc/ssh --with-pam --with-zlib=/usr/local/zlib --with-ssl-dir=/usr/bin/openssl --with-md5-passwords 
</span><span class='line'>（注意，如果 configure 时提示 PAM 有错误，那一般是因为系统中没有安装 pam-devel RPM 包，找到安装光盘，安装 pam-devel 就可以解决啦）如果是sshkeygen提示错误，需要make  clean再重新编译
</span><span class='line'>本次安装过程提示了pam问题,cd /opt/cdrom-mirror/Packages
</span><span class='line'>rpm -ivh pam-devel-1.1.1-10.el6_2.1.x86_64.rpm
</span><span class='line'>./configure --prefix=/usr --sysconfdir=/etc/ssh --with-pam --with-zlib=/usr/local/zlib --with-ssl-dir=/usr/bin/openssl --with-md5-passwords 
</span><span class='line'># make
</span><span class='line'># make install
</span><span class='line'>ssh -V 
</span></code></pre></td></tr></table></div></figure>


<h2>编译RPM包</h2>

<p>机器太多，不太可能一台台的编译安装。首先用rpmbuild打包，然后用createrepo制作本地私有仓库。主要是openssl打包比较纠结！OpenSSH完全依赖OpenSSL的，所以OpenSSL的版本一定要先编译安装好，然后再编译OpenSSH。相应的包下面都有对应的spec文件。</p>

<p>实际操作过程是先打包OpenSSH的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> cd
</span><span class='line'> mkdir rpmbuild
</span><span class='line'> cd rpmbuild/
</span><span class='line'> mkdir -pv {BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
</span><span class='line'>
</span><span class='line'> cd SOURCES/
</span><span class='line'> cd ../SPECS/
</span><span class='line'> cp ~/updatessh/openssh-7.2p2/contrib/redhat/openssh.spec ./
</span><span class='line'> cd ..
</span><span class='line'> cd SOURCES/
</span><span class='line'> vi /etc/resolv.conf
</span><span class='line'> wget http://pkgs.fedoraproject.org/repo/pkgs/openssh/x11-ssh-askpass-1.2.4.1.tar.gz/8f2e41f3f7eaa8543a2440454637f3c3/x11-ssh-askpass-1.2.4.1.tar.gz
</span><span class='line'> wget http://pkgs.fedoraproject.org/repo/pkgs/openssh/openssh-7.2p2.tar.gz/13009a9156510d8f27e752659075cced/openssh-7.2p2.tar.gz
</span><span class='line'> cd ..
</span><span class='line'> yum groupinstall "X Window System" "Desktop" "Desktop Platform" "General Purpose Desktop"
</span><span class='line'> yum -y install libX11-devel
</span><span class='line'> yum install imake
</span><span class='line'> yum provides \*/Intrinsic.h
</span><span class='line'> yum install libXt-devel
</span><span class='line'> yum search gtk
</span><span class='line'> yum install gtk2 gtk2-devel
</span><span class='line'> vi SPECS/openssh.spec
</span><span class='line'> rpmbuild -bb SPECS/openssh.spec</span></code></pre></td></tr></table></div></figure>


<p>然后坑就摆在那里了：重启sshd失败。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 在rpmbuild\RPMS\x86_64目录下面创建createrepo私有仓库
</span><span class='line'># /etc/yum.repo.d/local.repo增加节点
</span><span class='line'>
</span><span class='line'># yum install openssh 
</span><span class='line'>
</span><span class='line'># 重启
</span><span class='line'>[root@localhost ~]# service sshd restart
</span><span class='line'>然后启动了[失败]（具体错没记下来）</span></code></pre></td></tr></table></div></figure>


<p>感觉是OpenSSL的问题了。然后打包好OpenSSL后安装竟然报错：找不到libssl的动态链接库</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Error: Package: wget-1.12-1.4.el6.x86_64 (@anaconda-RedHatEnterpriseLinux-201206132210.x86_64/6.3)
</span><span class='line'>           Requires: libcrypto.so.10()(64bit)
</span><span class='line'>           Removing: openssl-1.0.0-20.el6_2.5.x86_64 (@cdrom)
</span><span class='line'>               libcrypto.so.10()(64bit)
</span><span class='line'>           Updated By: openssl-1.0.2j-1.x86_64 (upgrade)
</span><span class='line'>               Not found
</span><span class='line'>Error: Package: 1:wpa_supplicant-0.7.3-3.el6.x86_64 (@cdrom)
</span><span class='line'>           Requires: libssl.so.10()(64bit)
</span><span class='line'>           Removing: openssl-1.0.0-20.el6_2.5.x86_64 (@cdrom)
</span><span class='line'>               libssl.so.10()(64bit)
</span><span class='line'>           Updated By: openssl-1.0.2j-1.x86_64 (upgrade)
</span><span class='line'>               Not found</span></code></pre></td></tr></table></div></figure>


<p>官方的出的spec打包的rpm安装后竟然会少东西。百思不得其解，通过查看cdrom openssl-1.0.0-20.el6_2.5.x86_64.rpm与rpmbuild openssl-1.0.2j-1.x86_64.rpm的确还不同：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# rpm -qlp /opt/cdrom/Packages/openssl-1.0.0-20.el6_2.5.x86_64.rpm | grep libssl
</span><span class='line'>...
</span><span class='line'>/usr/lib64/libssl.so.1.0.0
</span><span class='line'>/usr/lib64/libssl.so.10
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# rpm -qlp /opt/cdrom/Packages/openssl-1.0.0-20.el6_2.5.x86_64.rpm | grep libssl
</span><span class='line'>...
</span><span class='line'>/usr/lib64/libssl.so.1.0.0</span></code></pre></td></tr></table></div></figure>


<p>在spec里面增加libssl.so.10软链接也没用。rpm并没有提供libssl.so.10的 <strong> provide </strong> 服务（可以通过<a href="http://stackoverflow.com/questions/25638461/how-can-i-make-rpm-tell-what-libraries-are-provided-inside-it">rpm -qip &ndash;provides RPM</a>查看）。</p>

<p>实在想不出办法了，只能先看下官网怎么打包的。最后通过查看 openssl-1.0.0-20.el6_2.5.src.rpm 的打包spec是进行定制了的，把原来编译生成的动态链接库so.$(SHLIB_MAJOR).$(SHLIB_MINOR)文件名改成so.$(SHLIB_SONAMEVER)。主要的两个patch为：</p>

<ul>
<li>openssl-1.0.0-beta3-soversion.patch</li>
<li>openssl-1.0.0-beta4-redhat.patch</li>
</ul>


<p>参考修改如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>修改Makefile
</span><span class='line'>diff -u openssl-1.0.2j/Makefile.org rpmbuild/SOURCES/openssl-1.0.2j/Makefile.org
</span><span class='line'>--- openssl-1.0.2j/Makefile.org 2016-09-26 17:49:07.000000000 +0800
</span><span class='line'>+++ rpmbuild/SOURCES/openssl-1.0.2j/Makefile.org        2016-10-20 15:28:32.000000000 +0800
</span><span class='line'>@@ -10,6 +10,7 @@
</span><span class='line'> SHLIB_MAJOR=
</span><span class='line'> SHLIB_MINOR=
</span><span class='line'> SHLIB_EXT=
</span><span class='line'>+SHLIB_SONAMEVER=10
</span><span class='line'> PLATFORM=dist
</span><span class='line'> OPTIONS=
</span><span class='line'> CONFIGURE_ARGS=
</span><span class='line'>@@ -342,10 +343,9 @@
</span><span class='line'> link-shared:
</span><span class='line'>        @ set -e; for i in $(SHLIBDIRS); do \
</span><span class='line'>                $(MAKE) -f $(HERE)/Makefile.shared -e $(BUILDENV) \
</span><span class='line'>-                       LIBNAME=$$i LIBVERSION=$(SHLIB_MAJOR).$(SHLIB_MINOR) \
</span><span class='line'>+                       LIBNAME=$$i LIBVERSION=$(SHLIB_SONAMEVER) \
</span><span class='line'>                        LIBCOMPATVERSIONS=";$(SHLIB_VERSION_HISTORY)" \
</span><span class='line'>                        symlink.$(SHLIB_TARGET); \
</span><span class='line'>-               libs="$$libs -l$$i"; \
</span><span class='line'>        done
</span><span class='line'> 
</span><span class='line'> build-shared: do_$(SHLIB_TARGET) link-shared
</span><span class='line'>@@ -356,7 +356,7 @@
</span><span class='line'>                        libs="$(LIBKRB5) $$libs"; \
</span><span class='line'>                fi; \
</span><span class='line'>                $(CLEARENV) && $(MAKE) -f Makefile.shared -e $(BUILDENV) \
</span><span class='line'>-                       LIBNAME=$$i LIBVERSION=$(SHLIB_MAJOR).$(SHLIB_MINOR) \
</span><span class='line'>+                       LIBNAME=$$i LIBVERSION=$(SHLIB_SONAMEVER) \
</span><span class='line'>                        LIBCOMPATVERSIONS=";$(SHLIB_VERSION_HISTORY)" \
</span><span class='line'>                        LIBDEPS="$$libs $(EX_LIBS)" \
</span><span class='line'>                        link_a.$(SHLIB_TARGET); \
</span><span class='line'>
</span><span class='line'>修改Configure1
</span><span class='line'>diff -u openssl-1.0.2j/Configure rpmbuild/SOURCES/openssl-1.0.2j/Configure
</span><span class='line'>--- openssl-1.0.2j/Configure    2016-09-26 17:49:07.000000000 +0800
</span><span class='line'>+++ rpmbuild/SOURCES/openssl-1.0.2j/Configure   2016-10-20 16:40:33.000000000 +0800
</span><span class='line'>@@ -1781,7 +1781,7 @@
</span><span class='line'>        elsif ($shared_extension ne "" && $shared_extension =~ /^\.s([ol])\.[^\.]*\.[^\.]*$/)
</span><span class='line'>                {
</span><span class='line'>                my $sotmp = $1;
</span><span class='line'>-               s/^SHARED_LIBS_LINK_EXTS=.*/SHARED_LIBS_LINK_EXTS=.s$sotmp.\$(SHLIB_MAJOR) .s$sotmp/;
</span><span class='line'>+               s/^SHARED_LIBS_LINK_EXTS=.*/SHARED_LIBS_LINK_EXTS=.s$sotmp.\$(SHLIB_SONAMEVER) .s$sotmp/;
</span><span class='line'>                }
</span><span class='line'>        elsif ($shared_extension ne "" && $shared_extension =~ /^\.[^\.]*\.[^\.]*\.dylib$/)
</span><span class='line'>                {
</span><span class='line'>
</span><span class='line'>修改Configure2
</span><span class='line'>rpmbuild/SOURCES/openssl-1.0.2j/Configure 文件中 so.\$(SHLIB_MAJOR).\$(SHLIB_MINOR) 替换成 so.\$(SHLIB_SONAMEVER)
</span><span class='line'>
</span><span class='line'>修改spec
</span><span class='line'>[root@localhost ~]# diff openssl-1.0.2j/openssl.spec rpmbuild/SPECS/openssl.spec
</span><span class='line'>110a111,121
</span><span class='line'>&gt; version=%{version}
</span><span class='line'>&gt; soversion=10
</span><span class='line'>&gt; rename so.${soversion} so.${version} $RPM_BUILD_ROOT%{_libdir}/*.so.${soversion}
</span><span class='line'>&gt; for lib in $RPM_BUILD_ROOT/usr/lib64/*.so.${version} ; do
</span><span class='line'>&gt;         chmod 755 ${lib}
</span><span class='line'>&gt;         ln -s -f `basename ${lib}` $RPM_BUILD_ROOT/usr/lib64/`basename ${lib} .${version}`
</span><span class='line'>&gt;         ln -s -f `basename ${lib}` $RPM_BUILD_ROOT/usr/lib64/`basename ${lib} .${version}`.${soversion}
</span><span class='line'>&gt; 
</span><span class='line'>&gt; done
</span><span class='line'>&gt; </span></code></pre></td></tr></table></div></figure>


<p>然后打包OpenSSL，用Yum更新OpenSSL；再打包OpenSSH，最后再用Yum安装OpenSSH。</p>

<h2>配置</h2>

<p>打包好完成后完成大半的任务了，但是重启过程出现了一些问题：</p>

<ol>
<li>error while loading shared libraries: libcrypto.so.10: cannot enable executable stack as shared object requires: Permission denied</li>
</ol>


<p>运行： <code>execstack -c libcrypto.so.10</code> 解决。 <a href="http://www.linuxquestions.org/questions/linux-kernel-70/longterm-and-grsec-on-slackware-13-0-a-903612/">http://www.linuxquestions.org/questions/linux-kernel-70/longterm-and-grsec-on-slackware-13-0-a-903612/</a></p>

<ol>
<li>重启后远程密码登录上不，但是机器重启是可以登录的，而且su通过密码也是可以切换的。</li>
</ol>


<p>由于su切换没问题，应该不是加解密的问题。最后经常是selinux的问题： <code>setenforce 0 ; vi /etc/selinux/config</code> 完成配置。</p>

<p>到此纠结的SSH升级告一段落。后面上百台机器通过puppet就可以搞定了。</p>

<p>最后分享一个牛逼到不能再牛逼升级配置的文章： <a href="http://www.tsingfun.com/html/2016/env_0330/1332.html">http://www.tsingfun.com/html/2016/env_0330/1332.html</a> 包括了升级过程中你遇到和没遇到的所有问题了。</p>

<h2>再记</h2>

<p>在测试机上面搞的都是默认的配置啊，安全级别本来就不高。但是到生产就不同了，本来加了防护的。需要特别注意！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#centos6.8
</span><span class='line'>#直接用openssl-1.0.1e-48.el6
</span><span class='line'>[root@localhost yum.repos.d]# mount -o loop CentOS-6.8-x86_64-bin-DVD1.iso /opt/cdrom
</span><span class='line'>[root@localhost yum.repos.d]# vi local.repo
</span><span class='line'>
</span><span class='line'>[root@localhost rpmbuild]#  yum groupinstall "X Window System" "Desktop" "Desktop Platform" "General Purpose Desktop"
</span><span class='line'>
</span><span class='line'>[root@localhost yum.repos.d]# yum install -y libX11-devel imake libXt-devel gtk2 gtk2-devel 
</span><span class='line'>
</span><span class='line'>[root@localhost rpmbuild]# yum install -y rpm-build
</span><span class='line'>[root@localhost rpmbuild]# yum install -y openssl-devel   krb5-devel pam-devel 
</span><span class='line'>
</span><span class='line'>[root@localhost rpmbuild]# yum install gcc
</span><span class='line'>
</span><span class='line'>[root@localhost rpmbuild]# rpmbuild -bb SPEC/openssh.spec
</span><span class='line'>
</span><span class='line'>自己做的repo：
</span><span class='line'>
</span><span class='line'>[root@hadoop-master1 ssh]# ll
</span><span class='line'>total 6192
</span><span class='line'>-rw-r--r-- 1 root root  439708 Oct 21 17:53 openssh-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root   41752 Oct 21 17:53 openssh-askpass-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root   22684 Oct 21 17:53 openssh-askpass-gnome-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root  581836 Oct 21 17:53 openssh-clients-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root   16948 Oct 21 17:53 openssh-debuginfo-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root  391544 Oct 21 17:53 openssh-server-7.2p2-1.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 root root 3226970 Oct 21 17:23 openssl-1.0.1e-48.el6.src.rpm
</span><span class='line'>-rw-r--r-- 1 root root 1595916 May 12 18:49 openssl-1.0.1e-48.el6.x86_64.rpm
</span><span class='line'>drwxr-xr-x 2 root root    4096 Oct 21 18:47 repodata
</span><span class='line'>
</span><span class='line'>注意点：
</span><span class='line'>
</span><span class='line'>1 selinux关掉
</span><span class='line'>
</span><span class='line'>2 开个telnet以防万一
</span><span class='line'>
</span><span class='line'>yum install telnet-server
</span><span class='line'>chkconfig telnet on
</span><span class='line'>service xinetd restart
</span><span class='line'>
</span><span class='line'>3 PAM
</span><span class='line'>vi /etc/ssh/sshd_config
</span><span class='line'>UsePAM no（反正要确认pam，或者看看/etc/pam.d/sshd是否满足要求）
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SparkSQL查看调试生成代码]]></title>
    <link href="http://winseliu.com/blog/2016/10/12/sparksql-view-and-debug-generatecode/"/>
    <updated>2016-10-12T19:48:58+08:00</updated>
    <id>http://winseliu.com/blog/2016/10/12/sparksql-view-and-debug-generatecode</id>
    <content type="html"><![CDATA[<p>网站和一些书籍都有介绍SparkSQL（DataFrame）会根据相应的操作生成最终运行的语句。这里从一个简单的、低级的问题入手到最后通过查看生成的代码查找问题的根源，并简单介绍怎么来调试SparkSQL。</p>

<p>问题来源：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>case class Access(id:String,url:String,time:String){
</span><span class='line'>def compute():(String, Int)
</span><span class='line'>}
</span><span class='line'>Object Access {
</span><span class='line'>def apply(row:Row): Option[Access]
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'># main
</span><span class='line'>df.map(Access(_)).filter(!_.isEmpty).map(_.get).map(_.compute)</span></code></pre></td></tr></table></div></figure>


<p>运行之后 compute 总是报 NullPointerException 异常。按RDD以及Scala的操作都是没法理解的，怎么就变成 <code>Access(null,null,null)</code> 了呢？后面尽管改成 <code>df.flatMap(Access(_)).map(_.compute)</code> 后运行正常了，但是还是想看看SparkSQL到底干了啥！！！</p>

<h2>SparkSQL干了什么</h2>

<p>Spark RDD是在 RDD#compute 中明确定义好了操作的。而SparkSQL的操作最终转换成了LogicalPlan，看不出它做了什么东东。</p>

<p>其实，与数据库SQL的explain看执行计划类似，SparkSQL也有explain的方法来查看程序的执行计划。（这里代码全部贴出来了，根据情况自己去掉注释啊）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>object AccessAnalyser {
</span><span class='line'>
</span><span class='line'>  def main(args: Array[String]): Unit = {
</span><span class='line'>
</span><span class='line'>    // conf
</span><span class='line'>
</span><span class='line'>    // clean
</span><span class='line'>    new File("target/generated-sources").listFiles().filter(_.isFile()).foreach(_.delete)
</span><span class='line'>
</span><span class='line'>    sys.props("org.codehaus.janino.source_debugging.enable") = "true"
</span><span class='line'>    sys.props("org.codehaus.janino.source_debugging.dir") = "target/generated-sources"
</span><span class='line'>
</span><span class='line'>    val input = "r:/match10.dat"
</span><span class='line'>    val output = "r:/output"
</span><span class='line'>    def delete(f: File): Unit = {
</span><span class='line'>      if (f.isDirectory) f.listFiles().foreach(delete)
</span><span class='line'>      f.delete()
</span><span class='line'>    }
</span><span class='line'>    delete(new File(output))
</span><span class='line'>
</span><span class='line'>    // program
</span><span class='line'>
</span><span class='line'>    val conf = new SparkConf().setAppName("DPI Analyser").setMaster("local[10]")
</span><span class='line'>    // fix windows path.
</span><span class='line'>    conf.set(/*SQLConf.WAREHOUSE_PATH*/ "spark.sql.warehouse.dir", "spark-warehouse")
</span><span class='line'>
</span><span class='line'>    val sc = new SparkContext(conf)
</span><span class='line'>    val sqlContext = new SQLContext(sc)
</span><span class='line'>
</span><span class='line'>    import sqlContext.implicits._
</span><span class='line'>    import org.apache.spark.sql.functions._
</span><span class='line'>
</span><span class='line'>    val df = sqlContext.read
</span><span class='line'>      .format("com.databricks.spark.csv")
</span><span class='line'>      .option("header", "false") // Use first line of all files as header
</span><span class='line'>      .option("quote", "'")
</span><span class='line'>      .option("escape", "'")
</span><span class='line'>      .option("delimiter", ",")
</span><span class='line'>      .load(input)
</span><span class='line'>
</span><span class='line'>    df
</span><span class='line'>      .flatMap(Access(_))
</span><span class='line'>      //      .map(Access(_)).filter((t: Option[Access]) =&gt; !t.isEmpty).map(_.get) // sparksql不合适用Option
</span><span class='line'>      .map(_.compute)
</span><span class='line'>      .explain(true)
</span><span class='line'>      //      .toDF("id", "score")
</span><span class='line'>      //      .groupBy("id").agg(sum("score") as "score")
</span><span class='line'>      //      .sort("score", "id")
</span><span class='line'>      //      .repartition(1)
</span><span class='line'>      //      .write.format("com.databricks.spark.csv").save(output)
</span><span class='line'>
</span><span class='line'>    sc.stop()
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>运行上面的代码，在console窗口输出了任务的执行计划：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>== Parsed Logical Plan ==
</span><span class='line'>'SerializeFromObject [staticinvoke(class org.apache.spark.unsafe.types.UTF8String, StringType, fromString, assertnotnull(input[0, scala.Tuple2, true], top level non-flat input object)._1, true) AS _1#20, assertnotnull(input[0, scala.Tuple2, true], top level non-flat input object)._2 AS _2#21]
</span><span class='line'>+- 'MapElements &lt;function1&gt;, obj#19: scala.Tuple2
</span><span class='line'>   +- 'DeserializeToObject unresolveddeserializer(newInstance(class com.github.winse.spark.access.Access)), obj#18: com.github.winse.spark.access.Access
</span><span class='line'>      +- SerializeFromObject [staticinvoke(class org.apache.spark.unsafe.types.UTF8String, StringType, fromString, assertnotnull(input[0, com.github.winse.spark.access.Access, true], top level non-flat input object).id, true) AS id#12, staticinvoke(class org.apache.spark.unsafe.types.UTF8String, StringType, fromString, assertnotnull(input[0, com.github.winse.spark.access.Access, true], top level non-flat input object).url, true) AS url#13, staticinvoke(class org.apache.spark.unsafe.types.UTF8String, StringType, fromString, assertnotnull(input[0, com.github.winse.spark.access.Access, true], top level non-flat input object).time, true) AS time#14]
</span><span class='line'>         +- MapPartitions &lt;function1&gt;, obj#11: com.github.winse.spark.access.Access
</span><span class='line'>            +- DeserializeToObject createexternalrow(_c0#0.toString, _c1#1.toString, _c2#2.toString, StructField(_c0,StringType,true), StructField(_c1,StringType,true), StructField(_c2,StringType,true)), obj#10: org.apache.spark.sql.Row
</span><span class='line'>               +- Relation[_c0#0,_c1#1,_c2#2] csv
</span><span class='line'>
</span><span class='line'>== Physical Plan ==
</span><span class='line'>*SerializeFromObject [staticinvoke(class org.apache.spark.unsafe.types.UTF8String, StringType, fromString, assertnotnull(input[0, scala.Tuple2, true], top level non-flat input object)._1, true) AS _1#20, assertnotnull(input[0, scala.Tuple2, true], top level non-flat input object)._2 AS _2#21]
</span><span class='line'>+- *MapElements &lt;function1&gt;, obj#19: scala.Tuple2
</span><span class='line'>   +- MapPartitions &lt;function1&gt;, obj#11: com.github.winse.spark.access.Access
</span><span class='line'>      +- DeserializeToObject createexternalrow(_c0#0.toString, _c1#1.toString, _c2#2.toString, StructField(_c0,StringType,true), StructField(_c1,StringType,true), StructField(_c2,StringType,true)), obj#10: org.apache.spark.sql.Row
</span><span class='line'>         +- *Scan csv [_c0#0,_c1#1,_c2#2] Format: CSV, InputPaths: file:/r:/match10.dat, PushedFilters: [], ReadSchema: struct&lt;_c0:string,_c1:string,_c2:string&gt;</span></code></pre></td></tr></table></div></figure>


<p>OK，看到执行计划了，那生成的代码长什么样呢？以及怎么调试这些生成的代码呢？</p>

<h2>Hack 源码</h2>

<p>在进行调试之前，先改一下代码重新编译下catalyst用于调试，并替换maven下面的spark-catalyst_2.11 ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@Lenovo-PC ~/git/spark/sql/catalyst
</span><span class='line'>$ git diff .
</span><span class='line'>diff --git a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala b/sql/catalyst/                                                                                          src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala
</span><span class='line'>index 16fb1f6..56bfbf7 100644
</span><span class='line'>--- a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala
</span><span class='line'>+++ b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala
</span><span class='line'>@@ -854,7 +854,7 @@ object CodeGenerator extends Logging {
</span><span class='line'>     val parentClassLoader = new ParentClassLoader(Utils.getContextOrSparkClassLoader)
</span><span class='line'>     evaluator.setParentClassLoader(parentClassLoader)
</span><span class='line'>     // Cannot be under package codegen, or fail with java.lang.InstantiationException
</span><span class='line'>-    evaluator.setClassName("org.apache.spark.sql.catalyst.expressions.GeneratedClass")
</span><span class='line'>     evaluator.setDefaultImports(Array(
</span><span class='line'>       classOf[Platform].getName,
</span><span class='line'>       classOf[InternalRow].getName,
</span><span class='line'>@@ -875,12 +875,14 @@ object CodeGenerator extends Logging {
</span><span class='line'>
</span><span class='line'>     logDebug({
</span><span class='line'>       // Only add extra debugging info to byte code when we are going to print the source code.
</span><span class='line'>-      evaluator.setDebuggingInformation(true, true, false)
</span><span class='line'>+      evaluator.setDebuggingInformation(true, true, true)
</span><span class='line'>       s"\n$formatted"
</span><span class='line'>     })
</span><span class='line'>
</span><span class='line'>     try {
</span><span class='line'>-      evaluator.cook("generated.java", code.body)
</span><span class='line'>+      evaluator.cook(code.body)
</span><span class='line'>       recordCompilationStats(evaluator)
</span><span class='line'>     } catch {
</span><span class='line'>       case e: Exception =&gt;
</span><span class='line'>
</span><span class='line'>E:\git\spark\sql\catalyst&gt;mvn clean package -DskipTests -Dmaven.test.skip=true
</span></code></pre></td></tr></table></div></figure>


<p>SparkSQL生成代码用的是janino，官网文档有提供debugging的资料：<a href="http://janino-compiler.github.io/janino/#debugging">http://janino-compiler.github.io/janino/#debugging</a> 。简单说明下三处修改：</p>

<ul>
<li>查看org.codehaus.janino.Scanner构造方法，如果配置了debugging以及optionalFileName==null就会把源码保存到临时文件。</li>
<li>一开始没想到要注释掉setClassName的，后面把CodeGenerator#doCompile拷贝出来慢慢和官网提供的例子对，就把setClassName换成setExtendedClass竟然成了弹出了源码页面。又看到下面就setExtendedClass就注释掉setClassName就ok了。</li>
<li>源代码里面的参数不能查看的，就是编译的时刻把这个选项去掉了。把debugVars设置为true。</li>
</ul>


<h2>运行调试</h2>

<p>先做好调试准备工作：</p>

<ul>
<li>在compute方法里面打一个断点然后调试运行</li>
<li>修改log4j日志级别: log4j.logger.org.apache.spark.sql.catalyst.expressions.codegen=DEBUG</li>
<li>把项目导入eclipse（IDEA弹不出源代码）</li>
</ul>


<p>然后运行。点击Debug视图的GeneratedIterator，在弹出的代码视图点击查找源码按钮，再弹出的添加源代码对话框（Edit Source Lookup Path）添加路径target/generated-sources（注意这里要用绝对路径）！接下来就一步步的调就行了。</p>

<p><img src="http://winseliu.com/images/blogs/sparksql-debug.png" alt="" /></p>

<p>调试着生成的代码能更好的理解前面explain的执行计划。看到代码就好理解最开始的Access(null,null,null)了：对象到字段反序列化的问题。</p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Maven创建自己的Archetype]]></title>
    <link href="http://winseliu.com/blog/2016/10/12/maven-create-ourself-archetype/"/>
    <updated>2016-10-12T12:06:53+08:00</updated>
    <id>http://winseliu.com/blog/2016/10/12/maven-create-ourself-archetype</id>
    <content type="html"><![CDATA[<p>最近经常用到scala，创建的小工程也挺多的。每次都的复制一些properties和plugins挺繁琐的。准备自己搞一个archetype，以后直接用archetype生成一步到位（相当于一个模板）。</p>

<ul>
<li><a href="https://my.oschina.net/wangrikui/blog/498807">https://my.oschina.net/wangrikui/blog/498807</a></li>
<li><a href="http://www.cnblogs.com/whitewolf/p/3606034.html">http://www.cnblogs.com/whitewolf/p/3606034.html</a></li>
</ul>


<h2>首先创建一个模板工程</h2>

<p>把需要修改的属性和插件，以及一些常用到的文件都放置好，如log4j.properties等。</p>

<h2>使用命令创建archetype工程</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mvn clean archetype:create-from-project</span></code></pre></td></tr></table></div></figure>


<p><strong> 注意：</strong> maven-archetype-plugin插件需要定位mvn.bat，而我的maven-3.3.9的命令名称为mvn.cmd，需要简单暴力的复制一个。</p>

<p>生成后，在 <strong> target\generated-sources\archetype </strong> 目录即为创建archetype工程。</p>

<h2>清理IDE相关文件</h2>

<p>target\generated-sources\archetype\src\main\resources\META-INF\maven 下面的 archetype-metadata.xml 为Archetype的元数据（真正包括那些文件的配置）。可以根据实际情况进行编辑</p>

<p>文件夹 target\generated-sources\archetype\src\main\resources\archetype-resources 下包括所有（新建时）需要拷贝的文件，但同时目录下面也包括了IDE相关文件，可以把这些文件<strong> 删掉 </strong> 。</p>

<h2>本地安装</h2>

<p>清理完文件后，回到 target\generated-sources\archetype 执行 <code>mvn install</code> 把这个原型(Archetype)安装到本地。</p>

<h2>使用</h2>

<ul>
<li><a href="https://my.oschina.net/u/225373/blog/468035">https://my.oschina.net/u/225373/blog/468035</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mvn archetype:generate -B \
</span><span class='line'>-DarchetypeGroupId=com.example -DarchetypeArtifactId=scala-simple-archetype -DarchetypeVersion=1.0 \
</span><span class='line'>-DarchetypeCatalog=local \
</span><span class='line'>-DgroupId=com.github.winse -DartifactId=Hello</span></code></pre></td></tr></table></div></figure>


<p>注意 <strong> archetypeCatalog </strong> 属性，如果不配置为本地（local/internal ）的话要等很久（可以用-X输出调试信息查看操作停在哪）。对于intellij idea可以在 Default Settings - Build,Exection,Deployment - Build Tools - Maven - Runner 加上 VM Options 参数。</p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[批量下载163-open的视频]]></title>
    <link href="http://winseliu.com/blog/2016/09/19/163-open-movies-download/"/>
    <updated>2016-09-19T23:19:31+08:00</updated>
    <id>http://winseliu.com/blog/2016/09/19/163-open-movies-download</id>
    <content type="html"><![CDATA[<p>163的视频资源还是挺丰富的，默认情况下必须用客户端下载。感觉挺麻烦的，对于网络慢的情况可能要下很久，如果能用下载工具批量下载就好了。</p>

<p>首先从视频播放页面获取下载的地址(查看下载按钮的js):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>appsrc : 'http://mov.bn.netease.com/open-movie/nos/mp4/2015/01/19/SAFDACJPD_sd.m3u8',</span></code></pre></td></tr></table></div></figure>


<ul>
<li>然后从列表页获取列表所有视频的详情URL，</li>
<li>然后从详情URL获取appsrc的地址，</li>
<li>最后把后缀m3u8改成mp4。当然还可以把视频的名称优化下。</li>
</ul>


<p>下面结合【chrome调试工具】、【notepad++】、【shell】来获取视频的下载地址：</p>

<ol>
<li>F12使用js获取列表详情URL</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$("#list2").find("tr &gt;td.u-ctitle a").each(function(i,node){console.log($(node).attr("href"));})</span></code></pre></td></tr></table></div></figure>


<p>使用notepad++的<strong>列处理</strong>功能 处理chrome输出的信息只留下URL保存到url.txt，如 <code>http://open.163.com/movie/2008/1/1/H/M6SGF6VB4_M6SGL3P1H.html</code> 。</p>

<p>这里用同样的步骤也把视频列表的名称获取到，用于后面的视频重命名：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$("#list2").find("tr &gt;td.u-ctitle a").each(function(i,node){console.log($(node).text());})</span></code></pre></td></tr></table></div></figure>


<ol>
<li>使用SHELL获取详情页面的URL</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat url.txt | while read line ; do if [ "$line" != '' ] ; then curl -s $line | grep -a appsrc ; fi ; done</span></code></pre></td></tr></table></div></figure>


<p>获取到的数据同样包含一些不需要的信息，使用notepad++进行裁剪。提取 <code>http://mov.bn.netease.com/open-movie/nos/mp4/2015/01/19/SAFDCDGNA_sd.m3u8</code>  的视频地址，使用replace把m3u8替换成mp4，然后把URL复制到<strong>迅雷下载的下载框</strong>即可批量下载了。</p>

<ol>
<li>重命名</li>
</ol>


<p>给获取到的视频的名称加上顺序标识，然后弄成重命名的命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mv SAFD8B131_sd.mp4  01机器学习的动机与应用.mp4
</span><span class='line'>mv SAFD8D355_sd.mp4  02监督学习应用.梯度下降.mp4
</span><span class='line'>mv SAFD8O947_sd.mp4  03欠拟合与过拟合的概念.mp4
</span><span class='line'>mv SAFD8PQO8_sd.mp4  04牛顿方法.mp4
</span><span class='line'>mv SAFD94US8_sd.mp4  05生成学习算法.mp4
</span><span class='line'>mv SAFD97CGO_sd.mp4  06朴素贝叶斯算法.mp4
</span><span class='line'>mv SAFD9I82D_sd.mp4  07最优间隔分类器问题.mp4
</span><span class='line'>mv SAFD9L3B9_sd.mp4  08顺序最小优化算法.mp4
</span><span class='line'>mv SAFD9VGEO_sd.mp4  09经验风险最小化.mp4
</span><span class='line'>mv SAFDA37TS_sd.mp4  10特征选择.mp4
</span><span class='line'>mv SAFDACJPD_sd.mp4  11贝叶斯统计正则化.mp4
</span><span class='line'>mv SAFDAHG1C_sd.mp4  12K-means算法.mp4
</span><span class='line'>mv SAFDAQ19J_sd.mp4  13高斯混合模型.mp4
</span><span class='line'>mv SAFDB0UUS_sd.mp4  14主成分分析法.mp4
</span><span class='line'>mv SAFDB7QLL_sd.mp4  15奇异值分解.mp4
</span><span class='line'>mv SAFDBF188_sd.mp4  16马尔可夫决策过程.mp4
</span><span class='line'>mv SAFDBM41T_sd.mp4  17离散与维数灾难.mp4
</span><span class='line'>mv SAFDBTL6V_sd.mp4  18线性二次型调节控制.mp4
</span><span class='line'>mv SAFDC4B84_sd.mp4  19微分动态规划.mp4
</span><span class='line'>mv SAFDCDGNA_sd.mp4  20策略搜索.mp4</span></code></pre></td></tr></table></div></figure>


<p>以上几个步骤就能完美的实现视频的下载。步骤比较多，但是还是很有成就感啊，程序员的逗逼方法。</p>

<h2>附</h2>

<p>几年前下载TED视频的脚本(全部用脚本来实现，其实拆分步骤或许是更好的选择简单些)：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget -qO- http://open.163.com/ted/ | iconv -f gbk -t utf-8 | awk '{if($0 ~ /&lt;a href="http:\/\/v\.163\.com\/movie/ ){print}}' \  
</span><span class='line'> | sed -n 's/.*&lt;a href="\([^"]*\)".*/\1/p' \  
</span><span class='line'> | while read url  
</span><span class='line'>do   
</span><span class='line'>        echo $url;  
</span><span class='line'>        wget -qO- "$url" | iconv -f gbk -t utf-8 | awk '/appsrc: \047http:\/\//{if(match($0,/http:[^\047]*/))print substr($0,RSTART,RLENGTH);}' \  
</span><span class='line'> | sed -e s/-list\.m3u8/.mp4/ -e s/movie/movieMP4/  
</span><span class='line'>done  </span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Zookeeper节点切换]]></title>
    <link href="http://winseliu.com/blog/2016/09/12/zookeeper-switch-node/"/>
    <updated>2016-09-12T16:51:39+08:00</updated>
    <id>http://winseliu.com/blog/2016/09/12/zookeeper-switch-node</id>
    <content type="html"><![CDATA[<p>收告警邮件实在是收到烦了，zookeeper实例的机器挂掉了，机器一直没人处理。最后最终还是改了告警的脚本（呵呵，等到快出问题的时刻才告警）。</p>

<p>过程中也尝试了添加删除节点，下面是对本次体验的一些记载。</p>

<h2>告警的检查脚本帖出来：</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>msg=`$HADOOP_HOME/bin/hdfs getconf -confKey ha.zookeeper.quorum 2&gt;/dev/null`
</span><span class='line'>
</span><span class='line'>zks_total=`echo "$msg" | awk 'BEGIN{RS=","; } {print}' | grep -v '^$' `
</span><span class='line'>total_count=`echo "$zks_total" | wc -l `
</span><span class='line'>
</span><span class='line'>lost_zks=`echo "$zks_total" |  while read zk  ; do if ! echo mntr | nc ${zk//:/ } | grep zk_server_state &gt;/dev/null ; then echo "$zk " ; fi ; done  `
</span><span class='line'>lost_count=`echo "$lost_zks" | grep -v "^$" | wc -l ` 
</span><span class='line'>lost_zks=`echo $lost_zks `
</span><span class='line'>
</span><span class='line'>message="Zookeepers total: $total_count, dead: $lost_count"
</span><span class='line'>if  [[ "$lost_count" != 0 ]]
</span><span class='line'>then
</span><span class='line'>  message="$message;  Dead: $lost_zks"
</span><span class='line'>fi 
</span><span class='line'>
</span><span class='line'>if (( $lost_count*2 &gt; $total_count )) ; then
</span><span class='line'>        echo "CRITICAL - $message"
</span><span class='line'>        exit 2
</span><span class='line'>elif (( $total_count/2 == $lost_count )) ; then
</span><span class='line'>        echo "WARNING - $message"
</span><span class='line'>        exit 1
</span><span class='line'>else 
</span><span class='line'>        echo "OK - $message"
</span><span class='line'>        exit 0
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>


<h2>zookeeper3.5</h2>

<p>zookeeper3.5的版本已经有动态增删节点的功能。</p>

<ul>
<li><a href="https://zookeeper.apache.org/doc/trunk/zookeeperReconfig.html">ZooKeeper Dynamic Reconfiguration</a></li>
<li><a href="https://www.usenix.org/sites/default/files/conference/protected-files/shraer_atc12_slides.pdf">Dynamic Reconfiguration of Primary/Backup Clusters</a></li>
</ul>


<h2>手动割接问题节点</h2>

<p>生产的是3.4的，不支持reconfig的命令。只能手动切换，在测试环境通过不同的端口来模拟3台机器：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@cu3 zktest]$ mv zoo_sample.cfg zoo1.cfg
</span><span class='line'>[hadoop@cu3 zktest]$ sed -e 's/12181/22181/' -e 's/data1/data2/' zoo1.cfg &gt;zoo2.cfg
</span><span class='line'>[hadoop@cu3 zktest]$ sed -e 's/12181/32181/' -e 's/data1/data3/' zoo1.cfg &gt;zoo3.cfg
</span><span class='line'>[hadoop@cu3 zktest]$ cat zoo3.cfg 
</span><span class='line'>tickTime=2000
</span><span class='line'>initLimit=10
</span><span class='line'>syncLimit=5
</span><span class='line'>#maxClientCnxns=60
</span><span class='line'>
</span><span class='line'>dataDir=/home/hadoop/zktest/data3
</span><span class='line'>clientPort=32181
</span><span class='line'>
</span><span class='line'>server.1=localhost:13888:13999
</span><span class='line'>server.2=localhost:23888:23999
</span><span class='line'>server.3=localhost:33888:33999
</span><span class='line'>
</span><span class='line'>[hadoop@cu3 zktest]$ for i in {1..3} ; do echo $i &gt;data$i/myid ; done 
</span><span class='line'>
</span><span class='line'># 添加两个便利的函数
</span><span class='line'>[hadoop@cu3 zktest]$ function zkstat { 
</span><span class='line'>&gt; for i in {1..4} ; do ( echo "${i}2181 =&gt; `cat data$i/zookeeper_server.pid` : `echo mntr | nc localhost ${i}2181 | grep zk_server_state | awk '{print $2}' ` " ) ; done
</span><span class='line'>&gt; }
</span><span class='line'>
</span><span class='line'>[hadoop@cu3 zktest]$ function zkstart { 
</span><span class='line'>&gt; for i in "$@" ; do (cd data$i ; ~/zookeeper-3.4.6/bin/zkServer.sh start /home/hadoop/zktest/zoo$i.cfg ) ; done
</span><span class='line'>&gt; }
</span><span class='line'>
</span><span class='line'>[hadoop@cu3 zktest]$ zkstart {1..3}
</span></code></pre></td></tr></table></div></figure>


<h4>切换时，Leader一直不变</h4>

<p>模拟server.1进程down掉，用一个新的server.4代替: 切换的过程中不能停leader！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 配置server.4
</span><span class='line'>[hadoop@cu3 zktest]$ sed -e 's/12181/42181/' -e 's/data1/data4/' zoo1.cfg &gt;zoo4.cfg
</span><span class='line'>[hadoop@cu3 zktest]$ mkdir data4
</span><span class='line'>[hadoop@cu3 zktest]$ echo 4 &gt; data4/myid
</span><span class='line'>
</span><span class='line'># 去掉server.1，添加server.4
</span><span class='line'>[hadoop@cu3 zktest]$ vi zoo4.cfg 
</span><span class='line'>...
</span><span class='line'>server.4=localhost:43888:43999
</span><span class='line'>
</span><span class='line'>[hadoop@cu3 zktest]$ zkstat
</span><span class='line'>12181 =&gt; 20750 : follower 
</span><span class='line'>22181 =&gt; 21037 : leader 
</span><span class='line'>32181 =&gt; 21075 : follower 
</span><span class='line'>42181 =&gt; 19757 :  
</span><span class='line'>
</span><span class='line'># 停server.1
</span><span class='line'>[hadoop@cu3 zktest]$ kill 20750
</span><span class='line'>
</span><span class='line'># 启动server.4
</span><span class='line'>[hadoop@cu3 zktest]$ zkstart {2..4}
</span><span class='line'>[hadoop@cu3 zktest]$ zkstat 
</span><span class='line'>12181 =&gt; 20750 :  
</span><span class='line'>22181 =&gt; 21037 : leader 
</span><span class='line'>32181 =&gt; 21075 : follower 
</span><span class='line'>42181 =&gt; 21246 : follower 
</span><span class='line'>
</span><span class='line'>此时server.4是新的配置，server.2和server.3是旧的配置。
</span><span class='line'>
</span><span class='line'># 停server.3，注意这里不能停leader！！
</span><span class='line'>[hadoop@cu3 zktest]$ kill 21075
</span><span class='line'>[hadoop@cu3 zktest]$ zkstat
</span><span class='line'>12181 =&gt; 20750 :  
</span><span class='line'>22181 =&gt; 21037 : leader 
</span><span class='line'>32181 =&gt; 21075 :  
</span><span class='line'>42181 =&gt; 21246 : follower 
</span><span class='line'>
</span><span class='line'># server.3的配置：server.1换成server.4
</span><span class='line'>[hadoop@cu3 zktest]$ vi zoo3.cfg 
</span><span class='line'>[hadoop@cu3 zktest]$ zkstart 3
</span><span class='line'>JMX enabled by default
</span><span class='line'>Using config: /home/hadoop/zktest/zoo3.cfg
</span><span class='line'>Starting zookeeper ... STARTED
</span><span class='line'>[hadoop@cu3 zktest]$ zkstat
</span><span class='line'>12181 =&gt; 20750 :  
</span><span class='line'>22181 =&gt; 21037 : leader 
</span><span class='line'>32181 =&gt; 21791 : follower 
</span><span class='line'>42181 =&gt; 21246 : follower 
</span><span class='line'>
</span><span class='line'>3个server有两个已经是新的配置，现在停掉leader后重新选举也是ok的。
</span><span class='line'>
</span><span class='line'># 最后停leader，修改zoo2.cfg。集群down节点成功切换！！
</span><span class='line'>[hadoop@cu3 zktest]$ zkstat
</span><span class='line'>12181 =&gt; 20750 :  
</span><span class='line'>22181 =&gt; 22044 : follower 
</span><span class='line'>32181 =&gt; 21791 : follower 
</span><span class='line'>42181 =&gt; 21246 : leader </span></code></pre></td></tr></table></div></figure>


<h4>中间停Leader，重新选领导失败</h4>

<p>现在再测试下中间过程停leader会是什么效果呢？</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 先zoo4挂掉了，用zoo1来补充。
</span><span class='line'>[hadoop@cu3 zktest]$ zkstat
</span><span class='line'>12181 =&gt; 20750 :  
</span><span class='line'>22181 =&gt; 22044 : leader 
</span><span class='line'>32181 =&gt; 21791 : follower 
</span><span class='line'>42181 =&gt; 21246 : 
</span><span class='line'>
</span><span class='line'>配置 zoo1: 
</span><span class='line'>
</span><span class='line'># 修改zoo1的配置 和 myid，不能用原来的旧id: Have smaller server identifier, so dropping the connection: (3, 1)
</span><span class='line'>server.5=localhost:13888:13999
</span><span class='line'>server.2=localhost:23888:23999
</span><span class='line'>server.3=localhost:33888:33999
</span><span class='line'>
</span><span class='line'># 此时zoo2，zoo3的配置为：
</span><span class='line'>server.2=localhost:23888:23999
</span><span class='line'>server.3=localhost:33888:33999
</span><span class='line'>server.4=localhost:43888:43999
</span><span class='line'>
</span><span class='line'># 启动zoo1
</span><span class='line'>[hadoop@cu3 zktest]$ zkstart 1
</span><span class='line'>[hadoop@cu3 zktest]$ zkstat
</span><span class='line'>12181 =&gt; 22439 : follower 
</span><span class='line'>22181 =&gt; 22044 : leader 
</span><span class='line'>32181 =&gt; 21791 : follower 
</span><span class='line'>42181 =&gt; 21246 :  
</span><span class='line'>
</span><span class='line'>如果这里停的leader，zoo1收不到大于1/2的投票？
</span><span class='line'>
</span><span class='line'>[hadoop@cu3 zktest]$ kill 22044
</span><span class='line'>[hadoop@cu3 zktest]$ zkstat
</span><span class='line'>12181 =&gt; 22439 :  
</span><span class='line'>22181 =&gt; 22044 :  
</span><span class='line'>32181 =&gt; 21791 :  
</span><span class='line'>42181 =&gt; 21246 :  
</span><span class='line'>[hadoop@cu3 zktest]$ jps -m | grep zktest
</span><span class='line'>21791 QuorumPeerMain /home/hadoop/zktest/zoo3.cfg
</span><span class='line'>22439 QuorumPeerMain /home/hadoop/zktest/zoo1.cfg
</span><span class='line'>
</span><span class='line'>服务挂了！！
</span></code></pre></td></tr></table></div></figure>


<p>正常切换后，应用不需要修改。只要zkserver中的一台zk服务器能连接就可以了。但可能监控的需要进行修改，因为原来是监控所有服务的，配置可能需要进行相应的修改。</p>

<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Puppet批量修改用户密码]]></title>
    <link href="http://winseliu.com/blog/2016/09/06/puppet-modify-password/"/>
    <updated>2016-09-06T11:00:57+08:00</updated>
    <id>http://winseliu.com/blog/2016/09/06/puppet-modify-password</id>
    <content type="html"><![CDATA[<ol>
<li>先在一台机器修改成想要修改的密码，然后获取该用户的信息。</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@hadoop-master1 ~]# puppet resource user root
</span><span class='line'>user { 'root':
</span><span class='line'>  ensure           =&gt; 'present',
</span><span class='line'>  comment          =&gt; 'root',
</span><span class='line'>  gid              =&gt; '0',
</span><span class='line'>  home             =&gt; '/root',
</span><span class='line'>  password         =&gt; '$6$C6EXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',
</span><span class='line'>  password_max_age =&gt; '99999',
</span><span class='line'>  password_min_age =&gt; '0',
</span><span class='line'>  shell            =&gt; '/bin/bash',
</span><span class='line'>  uid              =&gt; '0',
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>保存到文件 user.pp ，使用 <code>puppet apply user.pp</code> 测试看看文件是否有问题。毕竟是生产，出了问题就要进机房的啊，谨慎点好。</p></li>
<li><p>把用户的资源信息写入的site.pp(不知道是啥的话，去看看puppet的文档先)。先搞几台机器测试下 <code>puppet agent -t</code></p></li>
<li><p>然后使用 <code>mco puppet runall 10</code> 全部同步进行密码修改。或者 <code>mco shell run -- /opt/puppetlabs/bin/puppet agent -t</code></p></li>
</ol>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Maven压缩js/css功能实践]]></title>
    <link href="http://winseliu.com/blog/2016/08/19/j2ee-maven-resources-compress/"/>
    <updated>2016-08-19T16:34:28+08:00</updated>
    <id>http://winseliu.com/blog/2016/08/19/j2ee-maven-resources-compress</id>
    <content type="html"><![CDATA[<p>为了节约网络带宽，一般在发布项目时对资源(js/css)文件进行压缩（去掉空行、精简代码等）。但是要做到兼容开发与生产还是的下一番功夫才行。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ls -l src/main/webapp/static/assets/js/ | head
</span><span class='line'>total 3120
</span><span class='line'>-rwxrwxr--+ 1 winse None  24804 Aug 10 17:40 bootbox.js
</span><span class='line'>-rwxrwxr--+ 1 winse None  71315 Aug 10 17:40 bootstrap.js
</span><span class='line'>-rwxrwxr--+ 1 winse None  13905 Aug 10 17:40 bootstrap-colorpicker.js
</span><span class='line'>-rwxrwxr--+ 1 winse None  49319 Aug 10 17:40 bootstrap-multiselect.js
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>$ ls -l target/dist/js/ | head
</span><span class='line'>total 1368
</span><span class='line'>-rwxrwx---+ 1 winse None   8943 Aug 19 16:53 bootbox-min.js
</span><span class='line'>-rwxrwx---+ 1 winse None   8057 Aug 19 16:53 bootstrap-colorpicker-min.js
</span><span class='line'>-rwxrwx---+ 1 winse None  38061 Aug 19 16:53 bootstrap-min.js
</span><span class='line'>-rwxrwx---+ 1 winse None  18232 Aug 19 16:53 bootstrap-multiselect-min.js
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>项目中原本使用dist(压缩)、assets目录放置js/css等资源，在部署的时刻替换dist为assets，有点麻烦。首先想到的<strong>用nginx进行url重写</strong>，但是需要增加一个服务有点麻烦，能不能直接用spring来实现呢？</p>

<ul>
<li>自定义一个handler类</li>
</ul>


<p>查看Spring的 <code>mvc:resources</code> 实现，相当于注册了一个 <code>location -&gt; ResourceHttpRequestHandler</code> 的映射。
第一种尝试自动化的方式就是自定义handler类来进行资源的定位。增加 StaticRequestHandler 的处理类，增加配置 location 和 compressLocation 的配置：首先去查找压缩文件([NAME]-min.js)，找不到然后再找源文件([NAME].js)位置。</p>

<p>主要修改 getResource 方法，具体完整代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## java
</span><span class='line'>public class StaticRequestHandler extends ResourceHttpRequestHandler {
</span><span class='line'>
</span><span class='line'>  private final static Log logger = LogFactory.getLog(ResourceHttpRequestHandler.class);
</span><span class='line'>
</span><span class='line'>  private String location;
</span><span class='line'>  private String compressLocation;
</span><span class='line'>
</span><span class='line'>  private Resource locationResource;
</span><span class='line'>  private Resource compressLocationResource;
</span><span class='line'>
</span><span class='line'>  public void setLocation(String location) {
</span><span class='line'>      this.location = location;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  public void setCompressLocation(String compressLocation) {
</span><span class='line'>      this.compressLocation = compressLocation;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  @Override
</span><span class='line'>  public void afterPropertiesSet() throws Exception {
</span><span class='line'>      super.afterPropertiesSet();
</span><span class='line'>
</span><span class='line'>      this.locationResource = getWebApplicationContext().getResource(location);
</span><span class='line'>      super.setLocations(Collections.singletonList(this.locationResource));
</span><span class='line'>
</span><span class='line'>      this.compressLocationResource = getWebApplicationContext().getResource(compressLocation);
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  @Override
</span><span class='line'>  protected Resource getResource(HttpServletRequest request) {
</span><span class='line'>      String path = (String) request.getAttribute(HandlerMapping.PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE);
</span><span class='line'>      if (path == null) {
</span><span class='line'>          throw new IllegalStateException("Required request attribute '"
</span><span class='line'>                  + HandlerMapping.PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE + "' is not set");
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      if (!StringUtils.hasText(path) || isInvalidPath(path)) {
</span><span class='line'>          if (logger.isDebugEnabled()) {
</span><span class='line'>              logger.debug("Ignoring invalid resource path [" + path + "]");
</span><span class='line'>          }
</span><span class='line'>          return null;
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      Resource res = null;
</span><span class='line'>      if (path.endsWith(".css")) {
</span><span class='line'>          res = findResource(compressLocationResource, path.substring(0, path.length() - 4) + ".min.css");
</span><span class='line'>      } else if (path.endsWith(".js")) {
</span><span class='line'>          res = findResource(compressLocationResource, path.substring(0, path.length() - 3) + ".min.js");
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      if (res == null) {
</span><span class='line'>          res = findResource(locationResource, path);
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      return res;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  private Resource findResource(Resource location, String path) {
</span><span class='line'>      try {
</span><span class='line'>          if (logger.isDebugEnabled()) {
</span><span class='line'>              logger.debug("Trying relative path [" + path + "] against base location: " + location);
</span><span class='line'>          }
</span><span class='line'>          Resource resource = location.createRelative(path);
</span><span class='line'>          if (resource.exists() && resource.isReadable()) {
</span><span class='line'>              if (logger.isDebugEnabled()) {
</span><span class='line'>                  logger.debug("Found matching resource: " + resource);
</span><span class='line'>              }
</span><span class='line'>              return resource;
</span><span class='line'>          } else if (logger.isTraceEnabled()) {
</span><span class='line'>              logger.trace("Relative resource doesn't exist or isn't readable: " + resource);
</span><span class='line'>          }
</span><span class='line'>      } catch (IOException ex) {
</span><span class='line'>          logger.debug("Failed to create relative resource - trying next resource location", ex);
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      return null;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>## spring config
</span><span class='line'>  &lt;!-- 静态资源 --&gt;
</span><span class='line'>  &lt;!-- &lt;mvc:resources mapping="/static/**" location="/static/" /&gt; --&gt;
</span><span class='line'>
</span><span class='line'>  &lt;bean class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping"&gt;
</span><span class='line'>      &lt;property name="mappings"&gt;
</span><span class='line'>          &lt;value&gt;
</span><span class='line'>              /static/assets/**=staticRequestHandler
</span><span class='line'>          &lt;/value&gt;
</span><span class='line'>      &lt;/property&gt;
</span><span class='line'>  &lt;/bean&gt;
</span><span class='line'>  &lt;bean id="staticRequestHandler" class="com.hotel.servlet.resource.StaticRequestHandler"&gt;
</span><span class='line'>      &lt;property name="location" value="/static/assets/" /&gt;
</span><span class='line'>      &lt;property name="compressLocation" value="/static/dist/" /&gt;
</span><span class='line'>  &lt;/bean&gt;</span></code></pre></td></tr></table></div></figure>


<p>这种方式实现了自动定位压缩资源 <code>min.js</code> 的功能，但是压缩还是不能自动化而且不能实时的更新（min要单独压缩产生），并且调试和生产环境还是需要手动的修改配置来切换。</p>

<p>有没有更好的自动化的实现开发环境和生产环境分开呢？</p>

<ul>
<li>Maven打包时压缩然后替换源文件</li>
</ul>


<p>使用 <strong>yuicompressor-maven-plugin</strong> 插件压缩资源，然后把压缩资源<strong>先</strong>打包放置到assets目录下。</p>

<p>注意： yuicomressor 插件的 nosuffix 配置为 true ! 这样压缩后的文件名和源文件名称才一样。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## spring config
</span><span class='line'>  &lt;!-- 静态资源 --&gt;
</span><span class='line'>  &lt;mvc:resources mapping="/static/**" location="/static/" /&gt;
</span><span class='line'>
</span><span class='line'>## maven pom.xml
</span><span class='line'>      &lt;profile&gt;
</span><span class='line'>          &lt;id&gt;release&lt;/id&gt;
</span><span class='line'>
</span><span class='line'>          &lt;build&gt;
</span><span class='line'>              &lt;plugins&gt;
</span><span class='line'>                  &lt;!-- http://alchim.sourceforge.net/yuicompressor-maven-plugin/compress-mojo.html --&gt;
</span><span class='line'>                  &lt;plugin&gt;
</span><span class='line'>                      &lt;groupId&gt;net.alchim31.maven&lt;/groupId&gt;
</span><span class='line'>                      &lt;artifactId&gt;yuicompressor-maven-plugin&lt;/artifactId&gt;
</span><span class='line'>                      &lt;version&gt;1.3.2&lt;/version&gt;
</span><span class='line'>                      &lt;executions&gt;
</span><span class='line'>                          &lt;execution&gt;
</span><span class='line'>                              &lt;id&gt;compress_js_css&lt;/id&gt;
</span><span class='line'>                              &lt;phase&gt;process-resources&lt;/phase&gt;
</span><span class='line'>                              &lt;goals&gt;
</span><span class='line'>                                  &lt;goal&gt;compress&lt;/goal&gt;
</span><span class='line'>                              &lt;/goals&gt;
</span><span class='line'>                          &lt;/execution&gt;
</span><span class='line'>                      &lt;/executions&gt;
</span><span class='line'>                      &lt;configuration&gt;
</span><span class='line'>                          &lt;encoding&gt;UTF-8&lt;/encoding&gt;
</span><span class='line'>                          &lt;nosuffix&gt;true&lt;/nosuffix&gt;
</span><span class='line'>                          &lt;skip&gt;false&lt;/skip&gt;
</span><span class='line'>
</span><span class='line'>                          &lt;jswarn&gt;false&lt;/jswarn&gt;
</span><span class='line'>                          &lt;nomunge&gt;false&lt;/nomunge&gt;
</span><span class='line'>                          &lt;preserveAllSemiColons&gt;false&lt;/preserveAllSemiColons&gt;
</span><span class='line'>
</span><span class='line'>                          &lt;sourceDirectory&gt;src/main/webapp/static/assets&lt;/sourceDirectory&gt;
</span><span class='line'>                          &lt;outputDirectory&gt;${project.build.directory}/dist&lt;/outputDirectory&gt;
</span><span class='line'>                      &lt;/configuration&gt;
</span><span class='line'>                  &lt;/plugin&gt;
</span><span class='line'>
</span><span class='line'>                  &lt;plugin&gt;
</span><span class='line'>                      &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
</span><span class='line'>                      &lt;version&gt;2.6&lt;/version&gt;
</span><span class='line'>                      &lt;configuration&gt;
</span><span class='line'>                          &lt;webResources&gt;
</span><span class='line'>                              &lt;resource&gt;
</span><span class='line'>                                  &lt;directory&gt;${project.build.directory}/dist&lt;/directory&gt;
</span><span class='line'>                                  &lt;targetPath&gt;static/assets&lt;/targetPath&gt;
</span><span class='line'>                                  &lt;filtering&gt;false&lt;/filtering&gt;
</span><span class='line'>                              &lt;/resource&gt;
</span><span class='line'>                          &lt;/webResources&gt;
</span><span class='line'>                      &lt;/configuration&gt;
</span><span class='line'>                  &lt;/plugin&gt;
</span><span class='line'>                  
</span><span class='line'>              &lt;/plugins&gt;
</span><span class='line'>          &lt;/build&gt;
</span><span class='line'>      &lt;/profile&gt;</span></code></pre></td></tr></table></div></figure>


<p>war插件添加了自定义webResources资源，首先把压缩的文件拷贝到对应目录，maven发现文件已经存在就不会再拷贝同名的文件。这样源文件就相当于被替换成压缩的资源了。</p>

<h2>总结</h2>

<p>使用maven插件压缩打包，完美的解决js/css压缩导致的开发和生产不兼容问题。</p>

<h2>后记</h2>

<p>jsp使用了tag的地方总是会产生很多的空行，看着挺烦的。其实可以通过在jsp开头添加 trimDirectiveWhitespaces 属性来去掉空行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%@ page language="java" trimDirectiveWhitespaces="true" contentType="text/html; charset=utf-8" pageEncoding="utf-8"%&gt;</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Redis批量操作]]></title>
    <link href="http://winseliu.com/blog/2016/08/17/redis-batch-operate/"/>
    <updated>2016-08-17T15:33:47+08:00</updated>
    <id>http://winseliu.com/blog/2016/08/17/redis-batch-operate</id>
    <content type="html"><![CDATA[<p>紧接上一篇优化的文章，在生产进行shard分库/分片操作后，部分大量zsort键值对拆散到多个redis实例。原来统计总量的命令现在需要汇总后才行。</p>

<p>今天就来说说Redis里面的批量操作，批量操作其实就是循环，把大部分的工作让机器做了。逻辑比较复杂的用比较实现，功能简单的用脚本即可。</p>

<ul>
<li>单机用lua脚本</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># redis-cli
</span><span class='line'>
</span><span class='line'>eval "local aks=redis.call('keys', '*'); local res=0; for i,r in ipairs(aks) do res=res+redis.call('hlen', r) end; return res" 0</span></code></pre></td></tr></table></div></figure>


<p>通过keys获取所有的键（都是hash类型），然后计算出匹配的hash包括的键值对总数。</p>

<p>在<strong>同一个实例</strong>的小数据量的统计，lua脚本优势还是比较明显的：redis自带的还能编程。</p>

<ul>
<li>shell脚本</li>
</ul>


<p>看官网的文档：<a href="http://redis.io/topics/rediscli">the Redis command line interface</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## shell
</span><span class='line'>
</span><span class='line'>cat commands | redis-cli --raw
</span><span class='line'>
</span><span class='line'>## redis-cli
</span><span class='line'>
</span><span class='line'>127.0.0.1:6379&gt; CONFIG RESETSTAT
</span><span class='line'>OK
</span><span class='line'>...
</span><span class='line'>127.0.0.1:6379&gt; info stats
</span><span class='line'># Stats
</span><span class='line'>total_connections_received:2
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>注意：不要用循环然后调用<code>redis-cli COMMAND</code>，这种方式会产生很多的TCP连接，如果要执行的命令太多，可能导致TCP端口不够用。</p>

<p>还有 <code>redis-cli --stat</code>，<code>redis-cli --scan</code>，<code>redis-cli monitor</code> 这些命令挺有意思的。</p>

<ul>
<li>直接tcp连接管道操作</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## shell
</span><span class='line'>
</span><span class='line'>sed 's/$/^M/' commands &gt; test.redis.cmd
</span><span class='line'>cat test.redis.cmd | nc localhost 6379
</span><span class='line'>
</span><span class='line'>## redis-cli
</span><span class='line'>
</span><span class='line'>127.0.0.1:6379&gt; info stats
</span><span class='line'># Stats
</span><span class='line'>total_connections_received:1
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>通过tcp连接操作，一批次的操作就一个连接。但是，操作的时刻需要主要，linux的换行符是 <code>\n</code>，而redis需要的是 <code>\r\n</code>；还有通过tcp连接返回的结果是redis协议原始数据，没有经过处理，需要稍微看看协议规范<a href="http://redis.io/topics/protocol">Redis Protocol specification</a></p>

<ul>
<li>pipelining</li>
</ul>


<p>redis自带的管道功能，性能提升相当明显（<a href="http://redis.io/topics/pipelining#some-benchmark">官网数据</a>）。</p>

<p>原来看到过觉得高大上，准备试试。但是返回结果却只有一个成功数而已！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo 119.84.100.68 | xargs -I{} echo "1:ips:2016-08-16:{}" | while read cmd ; do echo -e "*2\r\n\$5\r\nzcard\r\n\$${#cmd}\r\n$cmd\r\n" ; done  | redis-cli -p 26379 --pipe
</span><span class='line'>All data transferred. Waiting for the last reply...
</span><span class='line'>Last reply received from server.
</span><span class='line'>errors: 0, replies: 1</span></code></pre></td></tr></table></div></figure>


<p>注意：redis-cli带的pipe就比较坑：最后只返回操作成功失败的统计数量，只适合用来做更新操作<a href="http://redis.io/topics/mass-insert">Redis Mass Insertion</a>！！</p>

<p>要用pipeline来实现查询的话，用java/scala等语言来弄吧。</p>

<p>最后帖一下用shell脚本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>day=${day:-`date "+%Y-%m-%d"`}
</span><span class='line'>key="1:ips:$day"
</span><span class='line'>
</span><span class='line'>for h in hadoop-master{1..4} ; do 
</span><span class='line'>  exists=$(redis-cli -h $h -p 6372 exists $key)
</span><span class='line'>  if [ $exists -gt 0 ] ; then
</span><span class='line'>    redis-cli -h $h -p 6372 zrange $key 0 -1 &gt; activeresourceip$day.data
</span><span class='line'>    for h in hadoop-master{1..4} ; do
</span><span class='line'>      cat activeresourceip$day.data | while read ip ; do echo -e "zcard $key:$ip\r" ; done | redis-cli -h $h -p 6372
</span><span class='line'>    done
</span><span class='line'>  fi
</span><span class='line'>done | awk '{s+=$1} END {print s}' </span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
]]></content>
  </entry>
  
</feed>
