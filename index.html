
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="看 Yi官方文档，一开始摸不着头脑，不知道从哪里入手。 网上找了一些资料，查到了苏洋的博客，先把环境搭建起来。 基于 Docker 的深度学习环境：Windows
使用 Docker 快速上手 Stability AI 的 SDXL 1.0 正式版-Linux 为了在 Windows11 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winse.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/libs/jquery.toc.min.js" type="text/javascript"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

<script src="/javascripts/generate-toc.js" type="text/javascript"></script>


  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D3G1YVNBK4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-D3G1YVNBK4');
</script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停都是风景, 熙熙攘攘都向最好, 忙忙碌碌都为明朝, 何畏之.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winse.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
  <li><a href="/tool/">Tools</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2024/01/15/aigc-setup-on-windows-wsl-2/">AIGC Setup on Win11 WSL2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2024-01-15T01:25:22+08:00" pubdate data-updated="true">Mon 2024-01-15 01:25</time>
		
        
		
      </p>
    
  </header>



  <div class="entry-content"><p>看 <a href="https://github.com/01-ai/Yi">Yi</a>官方文档，一开始摸不着头脑，不知道从哪里入手。 网上找了一些资料，查到了苏洋的博客，先把环境搭建起来。</p>

<ul>
<li><a href="https://soulteary.com/2023/07/29/docker-based-deep-learning-environment-under-windows.html">基于 Docker 的深度学习环境：Windows</a></li>
<li><a href="https://soulteary.com/2023/07/29/get-started-with-stability-ai-sdxl-1-0-release-using-docker.html">使用 Docker 快速上手 Stability AI 的 SDXL 1.0 正式版-Linux</a></li>
</ul>


<p>为了在 Windows11 机器方便使用GPU，以及开源很多工程都提供docker入门，但WSL2慢，考虑本地已经搞了一个WSL1了会不会冲突，同时虚拟机里面也安装不了WSL2，VMWare桌面虚拟机的话直接使用GPU没有很好的方式等等，纠结了一天，最终还是选了安装 WSL2+Docker Desktop。</p>

<p>跟着文章，你将会了解Windows+WLS2+Docker怎么跑GPU模型，以及在国内怎么下载模型文件。</p>

<h2>使用WSL2</h2>

<p>在 启用或关闭Windows功能 中选择 虚拟机平台。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsl --update
</span><span class='line'>wsl --set-default-version 2</span></code></pre></td></tr></table></div></figure>


<p>然后在微软商店Microsoft Store里面安装 <strong>Ubuntu-20.04</strong> （版本选20或者22）的系统（通过应用商店的话就规避了可能安装同一个的Linux的问题：已经安装 在应用商店的按钮不是[获取]是[打开]）。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-BR4MG38:~$ cat /etc/os-release
</span><span class='line'>NAME="Ubuntu"
</span><span class='line'>VERSION="20.04.6 LTS (Focal Fossa)"
</span><span class='line'>ID=ubuntu
</span><span class='line'>ID_LIKE=debian
</span><span class='line'>PRETTY_NAME="Ubuntu 20.04.6 LTS"
</span><span class='line'>VERSION_ID="20.04"
</span><span class='line'>HOME_URL="https://www.ubuntu.com/"
</span><span class='line'>SUPPORT_URL="https://help.ubuntu.com/"
</span><span class='line'>BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
</span><span class='line'>PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
</span><span class='line'>VERSION_CODENAME=focal
</span><span class='line'>UBUNTU_CODENAME=focal
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-BR4MG38:~$ uname -a
</span><span class='line'>Linux DESKTOP-BR4MG38 5.15.133.1-microsoft-standard-WSL2 #1 SMP Thu Oct 5 21:02:42 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux</span></code></pre></td></tr></table></div></figure>


<p>对比WSL1，WSL2的 <code>ip a</code> ，WSL2还是干净很多，把宿主机的一些信息合并到linux里面了（如：hosts）。</p>

<h2>Docker Desktop + WSL2</h2>

<ul>
<li><p><a href="https://docs.docker.com/desktop/install/windows-install/">https://docs.docker.com/desktop/install/windows-install/</a></p></li>
<li><p>微软的安装内容讲的差不多，增加了使用vscode的内容
<a href="https://learn.microsoft.com/en-us/windows/wsl/tutorials/wsl-containers#develop-in-remote-containers-using-vs-code">https://learn.microsoft.com/en-us/windows/wsl/tutorials/wsl-containers#develop-in-remote-containers-using-vs-code</a></p></li>
</ul>


<p>通过exe安装，安装过程中选择使用WSL2，装好后wsl显示多出了两个linux。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>C:\Users\P15&gt;wsl -l -v
</span><span class='line'>  NAME                   STATE           VERSION
</span><span class='line'>* Ubuntu                 Stopped         1
</span><span class='line'>  Ubuntu-20.04           Running         2
</span><span class='line'>  docker-desktop-data    Running         2
</span><span class='line'>  docker-desktop         Running         2</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-BR4MG38:~$ su -
</span><span class='line'>root@DESKTOP-BR4MG38:~# echo "winse ALL=(ALL:ALL) NOPASSWD: ALL" &gt;&gt;/etc/sudoers
</span><span class='line'>
</span><span class='line'>root@DESKTOP-BR4MG38:~# sed -i.bak -e 's|archive.ubuntu.com/ubuntu/|mirrors.aliyun.com/ubuntu/|' -e 's|security.ubuntu.com/ubuntu/|mirrors.aliyun.com/ubuntu/|' /etc/apt/sources.list
</span></code></pre></td></tr></table></div></figure>


<p>在 WSL-Ubuntu 里面可以直接用 Win11 的程序，直接查看docker的信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-BR4MG38:~$ docker version
</span><span class='line'>Client: Docker Engine - Community
</span><span class='line'> Cloud integration: v1.0.35+desktop.5
</span><span class='line'> Version:           24.0.7
</span><span class='line'> API version:       1.43
</span><span class='line'> Go version:        go1.20.10
</span><span class='line'> Git commit:        afdd53b
</span><span class='line'> Built:             Thu Oct 26 09:08:17 2023
</span><span class='line'> OS/Arch:           linux/amd64
</span><span class='line'> Context:           default
</span><span class='line'>
</span><span class='line'>Server: Docker Desktop
</span><span class='line'> Engine:
</span><span class='line'>  Version:          24.0.7
</span><span class='line'>  API version:      1.43 (minimum version 1.12)
</span><span class='line'>  Go version:       go1.20.10
</span><span class='line'>  Git commit:       311b9ff
</span><span class='line'>  Built:            Thu Oct 26 09:08:02 2023
</span><span class='line'>  OS/Arch:          linux/amd64
</span><span class='line'>  Experimental:     false
</span><span class='line'> containerd:
</span><span class='line'>  Version:          1.6.25
</span><span class='line'>  GitCommit:        d8f198a4ed8892c764191ef7b3b06d8a2eeb5c7f
</span><span class='line'> runc:
</span><span class='line'>  Version:          1.1.10
</span><span class='line'>  GitCommit:        v1.1.10-0-g18a0cb0
</span><span class='line'> docker-init:
</span><span class='line'>  Version:          0.19.0
</span><span class='line'>  GitCommit:        de40ad0
</span><span class='line'>  
</span><span class='line'>winse@DESKTOP-BR4MG38:~$ which docker
</span><span class='line'>/usr/bin/docker
</span><span class='line'>winse@DESKTOP-BR4MG38:~$ ll  /usr/bin/docker
</span><span class='line'>lrwxrwxrwx 1 root root 48 Jan 13 11:03 /usr/bin/docker -&gt; /mnt/wsl/docker-desktop/cli-tools/usr/bin/docker*
</span></code></pre></td></tr></table></div></figure>


<p>其实用的就是windows的docker</p>

<p><img src="/images/blogs/ai/wsl2-docker-cli.png" alt="" /></p>

<p>镜像加速</p>

<p><img src="/images/blogs/ai/docker-mirror.png" alt="" /></p>

<p>保存会重启docker，再查看docker的信息，确认Registry Mirrors：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-BR4MG38:~$ docker info
</span><span class='line'>Client: Docker Engine - Community
</span><span class='line'> Version:    24.0.7
</span><span class='line'> Context:    default
</span><span class='line'> Debug Mode: false
</span><span class='line'> Plugins:
</span><span class='line'>  buildx: Docker Buildx (Docker Inc.)
</span><span class='line'>    Version:  v0.12.0-desktop.2
</span><span class='line'>    Path:     /usr/local/lib/docker/cli-plugins/docker-buildx
</span><span class='line'>  compose: Docker Compose (Docker Inc.)
</span><span class='line'>    Version:  v2.23.3-desktop.2
</span><span class='line'>    Path:     /usr/local/lib/docker/cli-plugins/docker-compose
</span><span class='line'>  dev: Docker Dev Environments (Docker Inc.)
</span><span class='line'>    Version:  v0.1.0
</span><span class='line'>    Path:     /usr/local/lib/docker/cli-plugins/docker-dev
</span><span class='line'>  extension: Manages Docker extensions (Docker Inc.)
</span><span class='line'>    Version:  v0.2.21
</span><span class='line'>    Path:     /usr/local/lib/docker/cli-plugins/docker-extension
</span><span class='line'>  feedback: Provide feedback, right in your terminal! (Docker Inc.)
</span><span class='line'>    Version:  0.1
</span><span class='line'>    Path:     /usr/local/lib/docker/cli-plugins/docker-feedback
</span><span class='line'>  init: Creates Docker-related starter files for your project (Docker Inc.)
</span><span class='line'>    Version:  v0.1.0-beta.10
</span><span class='line'>    Path:     /usr/local/lib/docker/cli-plugins/docker-init
</span><span class='line'>  sbom: View the packaged-based Software Bill Of Materials (SBOM) for an image (Anchore Inc.)
</span><span class='line'>    Version:  0.6.0
</span><span class='line'>    Path:     /usr/local/lib/docker/cli-plugins/docker-sbom
</span><span class='line'>  scan: Docker Scan (Docker Inc.)
</span><span class='line'>    Version:  v0.26.0
</span><span class='line'>    Path:     /usr/local/lib/docker/cli-plugins/docker-scan
</span><span class='line'>  scout: Docker Scout (Docker Inc.)
</span><span class='line'>    Version:  v1.2.0
</span><span class='line'>    Path:     /usr/local/lib/docker/cli-plugins/docker-scout
</span><span class='line'>
</span><span class='line'>Server:
</span><span class='line'> Containers: 1
</span><span class='line'>  Running: 1
</span><span class='line'>  Paused: 0
</span><span class='line'>  Stopped: 0
</span><span class='line'> Images: 5
</span><span class='line'> Server Version: 24.0.7
</span><span class='line'> Storage Driver: overlay2
</span><span class='line'>  Backing Filesystem: extfs
</span><span class='line'>  Supports d_type: true
</span><span class='line'>  Using metacopy: false
</span><span class='line'>  Native Overlay Diff: true
</span><span class='line'>  userxattr: false
</span><span class='line'> Logging Driver: json-file
</span><span class='line'> Cgroup Driver: cgroupfs
</span><span class='line'> Cgroup Version: 1
</span><span class='line'> Plugins:
</span><span class='line'>  Volume: local
</span><span class='line'>  Network: bridge host ipvlan macvlan null overlay
</span><span class='line'>  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
</span><span class='line'> Swarm: inactive
</span><span class='line'> Runtimes: io.containerd.runc.v2 runc
</span><span class='line'> Default Runtime: runc
</span><span class='line'> Init Binary: docker-init
</span><span class='line'> containerd version: d8f198a4ed8892c764191ef7b3b06d8a2eeb5c7f
</span><span class='line'> runc version: v1.1.10-0-g18a0cb0
</span><span class='line'> init version: de40ad0
</span><span class='line'> Security Options:
</span><span class='line'>  seccomp
</span><span class='line'>   Profile: unconfined
</span><span class='line'> Kernel Version: 5.15.133.1-microsoft-standard-WSL2
</span><span class='line'> Operating System: Docker Desktop
</span><span class='line'> OSType: linux
</span><span class='line'> Architecture: x86_64
</span><span class='line'> CPUs: 16
</span><span class='line'> Total Memory: 31.26GiB
</span><span class='line'> Name: docker-desktop
</span><span class='line'> ID: 340fee1c-e22a-485c-a973-f0e26d7535c9
</span><span class='line'> Docker Root Dir: /var/lib/docker
</span><span class='line'> Debug Mode: false
</span><span class='line'> HTTP Proxy: http.docker.internal:3128
</span><span class='line'> HTTPS Proxy: http.docker.internal:3128
</span><span class='line'> No Proxy: hubproxy.docker.internal
</span><span class='line'> Experimental: false
</span><span class='line'> Insecure Registries:
</span><span class='line'>  hubproxy.docker.internal:5555
</span><span class='line'>  127.0.0.0/8
</span><span class='line'> Registry Mirrors:
</span><span class='line'>  https://us69kjun.mirror.aliyuncs.com/
</span><span class='line'>  https://docker.mirrors.ustc.edu.cn/
</span><span class='line'>  https://hub-mirror.c.163.com/
</span><span class='line'>  https://mirror.baidubce.com/
</span><span class='line'> Live Restore Enabled: false
</span><span class='line'>
</span><span class='line'>WARNING: No blkio throttle.read_bps_device support
</span><span class='line'>WARNING: No blkio throttle.write_bps_device support
</span><span class='line'>WARNING: No blkio throttle.read_iops_device support
</span><span class='line'>WARNING: No blkio throttle.write_iops_device support
</span><span class='line'>WARNING: daemon is not using the default seccomp profile</span></code></pre></td></tr></table></div></figure>


<h2>GPU</h2>

<h3>Driver</h3>

<p>根据Win11机器的显卡安装最新版本驱动（不要在WSL中安装任何Linux版的Nvidia驱动！）</p>

<p><a href="https://www.nvidia.com/Download/index.aspx">https://www.nvidia.com/Download/index.aspx</a></p>

<p>输入nvidia-smi，查验是否安装成功。WSL2里面啥都不用做，在WSL2命令行直接就能查看nvidia-smi。</p>

<p>启动docker也能一样查看</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-BR4MG38:stable-diffusion-taiyi$ docker run -it --rm --gpus all ubuntu nvidia-smi
</span></code></pre></td></tr></table></div></figure>


<p>其实这个启动的container也是一个WSL2。注意：WSL中不需要安装任何Linux版的Nvidia驱动！</p>

<p>验证 WLS2中Docker跑起来的容器 是否能够正常调用GPU：</p>

<ul>
<li><a href="https://soulteary.com/2023/07/29/docker-based-deep-learning-environment-under-windows.html">https://soulteary.com/2023/07/29/docker-based-deep-learning-environment-under-windows.html</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-BR4MG38:~$ docker pull nvcr.io/nvidia/pytorch:23.07-py3
</span><span class='line'>23.07-py3: Pulling from nvidia/pytorch
</span><span class='line'>3153aa388d02: Pulling fs layer
</span><span class='line'>...
</span><span class='line'>ee3f0ae6e80f: Pull complete
</span><span class='line'>d4528227b5b8: Pull complete
</span><span class='line'>Digest: sha256:c53e8702a4ccb3f55235226dab29ef5d931a2a6d4d003ab47ca2e7e670f7922b
</span><span class='line'>Status: Downloaded newer image for nvcr.io/nvidia/pytorch:23.07-py3
</span><span class='line'>nvcr.io/nvidia/pytorch:23.07-py3
</span><span class='line'>
</span><span class='line'>What's Next?
</span><span class='line'>  1. Sign in to your Docker account → docker login
</span><span class='line'>  2. View a summary of image vulnerabilities and recommendations → docker scout quickview nvcr.io/nvidia/pytorch:23.07-py3
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-BR4MG38:~$ docker run -it --gpus=all --rm nvcr.io/nvidia/pytorch:23.07-py3 nvidia-smi
</span><span class='line'>
</span><span class='line'>=============
</span><span class='line'>== PyTorch ==
</span><span class='line'>=============
</span><span class='line'>
</span><span class='line'>NVIDIA Release 23.07 (build 63867923)
</span><span class='line'>PyTorch Version 2.1.0a0+b5021ba
</span><span class='line'>
</span><span class='line'>Container image Copyright (c) 2023, NVIDIA CORPORATION & AFFILIATES. All rights reserved.
</span><span class='line'>
</span><span class='line'>Copyright (c) 2014-2023 Facebook Inc.
</span><span class='line'>Copyright (c) 2011-2014 Idiap Research Institute (Ronan Collobert)
</span><span class='line'>Copyright (c) 2012-2014 Deepmind Technologies    (Koray Kavukcuoglu)
</span><span class='line'>Copyright (c) 2011-2012 NEC Laboratories America (Koray Kavukcuoglu)
</span><span class='line'>Copyright (c) 2011-2013 NYU                      (Clement Farabet)
</span><span class='line'>Copyright (c) 2006-2010 NEC Laboratories America (Ronan Collobert, Leon Bottou, Iain Melvin, Jason Weston)
</span><span class='line'>Copyright (c) 2006      Idiap Research Institute (Samy Bengio)
</span><span class='line'>Copyright (c) 2001-2004 Idiap Research Institute (Ronan Collobert, Samy Bengio, Johnny Mariethoz)
</span><span class='line'>Copyright (c) 2015      Google Inc.
</span><span class='line'>Copyright (c) 2015      Yangqing Jia
</span><span class='line'>Copyright (c) 2013-2016 The Caffe contributors
</span><span class='line'>All rights reserved.
</span><span class='line'>
</span><span class='line'>Various files include modifications (c) NVIDIA CORPORATION & AFFILIATES.  All rights reserved.
</span><span class='line'>
</span><span class='line'>This container image and its contents are governed by the NVIDIA Deep Learning Container License.
</span><span class='line'>By pulling and using the container, you accept the terms and conditions of this license:
</span><span class='line'>https://developer.nvidia.com/ngc/nvidia-deep-learning-container-license
</span><span class='line'>
</span><span class='line'>NOTE: The SHMEM allocation limit is set to the default of 64MB.  This may be
</span><span class='line'>   insufficient for PyTorch.  NVIDIA recommends the use of the following flags:
</span><span class='line'>   docker run --gpus all --ipc=host --ulimit memlock=-1 --ulimit stack=67108864 ...
</span><span class='line'>
</span><span class='line'>Sat Jan 13 14:01:37 2024
</span><span class='line'>+---------------------------------------------------------------------------------------+
</span><span class='line'>| NVIDIA-SMI 535.146.01             Driver Version: 537.99       CUDA Version: 12.2     |
</span><span class='line'>|-----------------------------------------+----------------------+----------------------+
</span><span class='line'>| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |
</span><span class='line'>| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |
</span><span class='line'>|                                         |                      |               MIG M. |
</span><span class='line'>|=========================================+======================+======================|
</span><span class='line'>|   0  Quadro T2000                   On  | 00000000:01:00.0  On |                  N/A |
</span><span class='line'>| N/A   43C    P8               6W /  60W |    856MiB /  4096MiB |      9%      Default |
</span><span class='line'>|                                         |                      |                  N/A |
</span><span class='line'>+-----------------------------------------+----------------------+----------------------+
</span><span class='line'>
</span><span class='line'>+---------------------------------------------------------------------------------------+
</span><span class='line'>| Processes:                                                                            |
</span><span class='line'>|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |
</span><span class='line'>|        ID   ID                                                             Usage      |
</span><span class='line'>|=======================================================================================|
</span><span class='line'>|    0   N/A  N/A        27      G   /Xwayland                                 N/A      |
</span><span class='line'>|    0   N/A  N/A        41      G   /Xwayland                                 N/A      |
</span><span class='line'>|    0   N/A  N/A        42      G   /Xwayland                                 N/A      |
</span><span class='line'>+---------------------------------------------------------------------------------------+
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-BR4MG38:~$ docker run --rm --gpus all nvcr.io/nvidia/k8s/cuda-sample:nbody nbody -gpu -benchmark
</span><span class='line'>Unable to find image 'nvcr.io/nvidia/k8s/cuda-sample:nbody' locally
</span><span class='line'>nbody: Pulling from nvidia/k8s/cuda-sample
</span><span class='line'>22c5ef60a68e: Pull complete
</span><span class='line'>1939e4248814: Pull complete
</span><span class='line'>548afb82c856: Pull complete
</span><span class='line'>a424d45fd86f: Pull complete
</span><span class='line'>207b64ab7ce6: Pull complete
</span><span class='line'>f65423f1b49b: Pull complete
</span><span class='line'>2b60900a3ea5: Pull complete
</span><span class='line'>e9bff09d04df: Pull complete
</span><span class='line'>edc14edf1b04: Pull complete
</span><span class='line'>1f37f461c076: Pull complete
</span><span class='line'>9026fb14bf88: Pull complete
</span><span class='line'>Digest: sha256:59261e419d6d48a772aad5bb213f9f1588fcdb042b115ceb7166c89a51f03363
</span><span class='line'>Status: Downloaded newer image for nvcr.io/nvidia/k8s/cuda-sample:nbody
</span><span class='line'>Run "nbody -benchmark [-numbodies=&lt;numBodies&gt;]" to measure performance.
</span><span class='line'>        -fullscreen       (run n-body simulation in fullscreen mode)
</span><span class='line'>        -fp64             (use double precision floating point values for simulation)
</span><span class='line'>        -hostmem          (stores simulation data in host memory)
</span><span class='line'>        -benchmark        (run benchmark to measure performance)
</span><span class='line'>        -numbodies=&lt;N&gt;    (number of bodies (&gt;= 1) to run in simulation)
</span><span class='line'>        -device=&lt;d&gt;       (where d=0,1,2.... for the CUDA device to use)
</span><span class='line'>        -numdevices=&lt;i&gt;   (where i=(number of CUDA devices &gt; 0) to use for simulation)
</span><span class='line'>        -compare          (compares simulation results running once on the default GPU and once on the CPU)
</span><span class='line'>        -cpu              (run n-body simulation on the CPU)
</span><span class='line'>        -tipsy=&lt;file.bin&gt; (load a tipsy model file for simulation)
</span><span class='line'>
</span><span class='line'>NOTE: The CUDA Samples are not meant for performance measurements. Results may vary when GPU Boost is enabled.
</span><span class='line'>
</span><span class='line'>&gt; Windowed mode
</span><span class='line'>&gt; Simulation data stored in video memory
</span><span class='line'>&gt; Single precision floating point simulation
</span><span class='line'>&gt; 1 Devices used for simulation
</span><span class='line'>GPU Device 0: "Turing" with compute capability 7.5
</span><span class='line'>
</span><span class='line'>&gt; Compute 7.5 CUDA device: [Quadro T2000]
</span><span class='line'>16384 bodies, total time for 10 iterations: 64.071 ms
</span><span class='line'>= 41.897 billion interactions per second
</span><span class='line'>= 837.937 single-precision GFLOP/s at 20 flops per interaction
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#再跑一遍
</span><span class='line'>winse@DESKTOP-BR4MG38:~$ docker run --rm --gpus all nvcr.io/nvidia/k8s/cuda-sample:nbody nbody -gpu -benchmark
</span><span class='line'>Run "nbody -benchmark [-numbodies=&lt;numBodies&gt;]" to measure performance.
</span><span class='line'>        -fullscreen       (run n-body simulation in fullscreen mode)
</span><span class='line'>        -fp64             (use double precision floating point values for simulation)
</span><span class='line'>        -hostmem          (stores simulation data in host memory)
</span><span class='line'>        -benchmark        (run benchmark to measure performance)
</span><span class='line'>        -numbodies=&lt;N&gt;    (number of bodies (&gt;= 1) to run in simulation)
</span><span class='line'>        -device=&lt;d&gt;       (where d=0,1,2.... for the CUDA device to use)
</span><span class='line'>        -numdevices=&lt;i&gt;   (where i=(number of CUDA devices &gt; 0) to use for simulation)
</span><span class='line'>        -compare          (compares simulation results running once on the default GPU and once on the CPU)
</span><span class='line'>        -cpu              (run n-body simulation on the CPU)
</span><span class='line'>        -tipsy=&lt;file.bin&gt; (load a tipsy model file for simulation)
</span><span class='line'>
</span><span class='line'>NOTE: The CUDA Samples are not meant for performance measurements. Results may vary when GPU Boost is enabled.
</span><span class='line'>
</span><span class='line'>&gt; Windowed mode
</span><span class='line'>&gt; Simulation data stored in video memory
</span><span class='line'>&gt; Single precision floating point simulation
</span><span class='line'>&gt; 1 Devices used for simulation
</span><span class='line'>GPU Device 0: "Turing" with compute capability 7.5
</span><span class='line'>
</span><span class='line'>&gt; Compute 7.5 CUDA device: [Quadro T2000]
</span><span class='line'>16384 bodies, total time for 10 iterations: 23.398 ms
</span><span class='line'>= 114.724 billion interactions per second
</span><span class='line'>= 2294.490 single-precision GFLOP/s at 20 flops per interaction
</span></code></pre></td></tr></table></div></figure>


<h3>WSL2 cuda-toolkit</h3>

<p>开发环境/运行环境
* <a href="https://zhuanlan.zhihu.com/p/555151725">https://zhuanlan.zhihu.com/p/555151725</a>
* <a href="https://docs.nvidia.com/cuda/wsl-user-guide/index.html#cuda-support-for-WSL2">https://docs.nvidia.com/cuda/wsl-user-guide/index.html#cuda-support-for-WSL2</a>
* <a href="https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=WSL-Ubuntu&amp;target_version=2.0&amp;target_type=deb_network">https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=WSL-Ubuntu&amp;target_version=2.0&amp;target_type=deb_network</a></p>

<p><img src="/images/blogs/ai/wsl2-cuda.png" alt="" /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget https://developer.download.nvidia.com/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-keyring_1.1-1_all.deb
</span><span class='line'>sudo dpkg -i cuda-keyring_1.1-1_all.deb
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get -y install cuda-toolkit-12-3</span></code></pre></td></tr></table></div></figure>


<p>运行安装：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>(demo_env) winse@DESKTOP-BR4MG38:ai$ wget https://developer.download.nvidia.com/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-keyring_1.1-1_all.deb
</span><span class='line'>--2024-01-14 23:53:22--  https://developer.download.nvidia.com/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-keyring_1.1-1_all.deb
</span><span class='line'>Resolving developer.download.nvidia.com (developer.download.nvidia.com)... 152.199.39.144, 72.21.80.5, 72.21.80.6, ...
</span><span class='line'>Connecting to developer.download.nvidia.com (developer.download.nvidia.com)|152.199.39.144|:443... connected.
</span><span class='line'>HTTP request sent, awaiting response... 301 Moved Permanently
</span><span class='line'>Location: https://developer.download.nvidia.cn/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-keyring_1.1-1_all.deb [following]
</span><span class='line'>--2024-01-14 23:53:23--  https://developer.download.nvidia.cn/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-keyring_1.1-1_all.deb
</span><span class='line'>Resolving developer.download.nvidia.cn (developer.download.nvidia.cn)... 59.36.216.26, 59.36.216.27, 175.4.58.180, ...
</span><span class='line'>Connecting to developer.download.nvidia.cn (developer.download.nvidia.cn)|59.36.216.26|:443... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 4328 (4.2K) [application/x-deb]
</span><span class='line'>Saving to: ‘cuda-keyring_1.1-1_all.deb’
</span><span class='line'>
</span><span class='line'>cuda-keyring_1.1-1_all.deb      100%[====================================================&gt;]   4.23K  --.-KB/s    in 0s
</span><span class='line'>
</span><span class='line'>2024-01-14 23:53:23 (1.61 GB/s) - ‘cuda-keyring_1.1-1_all.deb’ saved [4328/4328]
</span><span class='line'>
</span><span class='line'>(demo_env) winse@DESKTOP-BR4MG38:ai$
</span><span class='line'>(demo_env) winse@DESKTOP-BR4MG38:ai$ sudo dpkg -i cuda-keyring_1.1-1_all.deb
</span><span class='line'>(demo_env) winse@DESKTOP-BR4MG38:ai$ sudo apt-get update
</span><span class='line'>(demo_env) winse@DESKTOP-BR4MG38:ai$ sudo apt-get -y install cuda-toolkit-12-3
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) winse@DESKTOP-BR4MG38:~$ vi .bashrc
</span><span class='line'>
</span><span class='line'>export PATH=/usr/local/cuda/bin:$PATH
</span></code></pre></td></tr></table></div></figure>


<p>新打开一个shell：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) winse@DESKTOP-BR4MG38:~$ nvcc -V
</span><span class='line'>nvcc: NVIDIA (R) Cuda compiler driver
</span><span class='line'>Copyright (c) 2005-2023 NVIDIA Corporation
</span><span class='line'>Built on Wed_Nov_22_10:17:15_PST_2023
</span><span class='line'>Cuda compilation tools, release 12.3, V12.3.107
</span><span class='line'>Build cuda_12.3.r12.3/compiler.33567101_0</span></code></pre></td></tr></table></div></figure>


<h3>cuDNN</h3>

<p><a href="https://developer.nvidia.com/cudnn">https://developer.nvidia.com/cudnn</a></p>

<p>NVIDIA CUDA® Deep Neural Network library 支持神经网络的推理。</p>

<p>注册下载对应CUDA的版本 <a href="https://developer.nvidia.com/rdp/cudnn-download">https://developer.nvidia.com/rdp/cudnn-download</a></p>

<p>注意：如果不在WSL2-Ubuntu中直接使用cuDNN，后续通过容器直接拉取包含cuDNN的容器，就可以省略这一部分。</p>

<p><a href="https://docs.nvidia.com/deeplearning/cudnn/install-guide/index.html#installlinux-deb">https://docs.nvidia.com/deeplearning/cudnn/install-guide/index.html#installlinux-deb</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#sudo dpkg -i cudnn-local-repo-ubuntu2004-8.9.6.50_1.0-1_amd64.deb
</span><span class='line'>#sudo dpkg -r cudnn-local-repo-ubuntu2004-8.9.6.50
</span><span class='line'>#sudo rm /etc/apt/sources.list.d/cudnn-local-ubuntu2004-8.9.6.50.list
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:i$ sudo dpkg -i cudnn-local-repo-ubuntu2004-8.9.7.29_1.0-1_amd64.deb
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:i$ sudo cp /var/cudnn-local-repo-ubuntu2004-8.9.7.29/cudnn-local-30472A84-keyring.gpg /usr/share/keyrings/
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:i$ sudo apt install zlib1g
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:i$ sudo apt update
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:i$ apt search libcudnn8
</span><span class='line'>Sorting... Done
</span><span class='line'>Full Text Search... Done
</span><span class='line'>libcudnn8/unknown 8.9.7.29-1+cuda12.2 amd64
</span><span class='line'>  cuDNN runtime libraries
</span><span class='line'>
</span><span class='line'>libcudnn8-dev/unknown 8.9.7.29-1+cuda12.2 amd64
</span><span class='line'>  cuDNN development libraries and headers
</span><span class='line'>
</span><span class='line'>libcudnn8-samples/unknown 8.9.7.29-1+cuda12.2 amd64
</span><span class='line'>  cuDNN samples
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:i$ sudo apt install libcudnn8 libcudnn8-dev libcudnn8-samples
</span></code></pre></td></tr></table></div></figure>


<p>校验是否安装成功</p>

<p><a href="https://docs.nvidia.com/deeplearning/cudnn/install-guide/index.html#verify">https://docs.nvidia.com/deeplearning/cudnn/install-guide/index.html#verify</a></p>

<p>运行报错参考 <a href="https://forums.developer.nvidia.com/t/freeimage-is-not-set-up-correctly-please-ensure-freeimae-is-set-up-correctly/66950">https://forums.developer.nvidia.com/t/freeimage-is-not-set-up-correctly-please-ensure-freeimae-is-set-up-correctly/66950</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) winse@DESKTOP-BR4MG38:i$ cp -r /usr/src/cudnn_samples_v8 ./
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:i$ cd cudnn_samples_v8/mnistCUDNN/
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:mnistCUDNN$
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:mnistCUDNN$ sudo apt-get install libfreeimage3 libfreeimage-dev
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:mnistCUDNN$ make clean && make
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:mnistCUDNN$ ./mnistCUDNN
</span><span class='line'>Executing: mnistCUDNN
</span><span class='line'>cudnnGetVersion() : 8907 , CUDNN_VERSION from cudnn.h : 8907 (8.9.7)
</span><span class='line'>Host compiler version : GCC 9.4.0
</span><span class='line'>
</span><span class='line'>There are 1 CUDA capable devices on your machine :
</span><span class='line'>device 0 : sms 16  Capabilities 7.5, SmClock 1785.0 Mhz, MemSize (Mb) 4095, MemClock 6001.0 Mhz, Ecc=0, boardGroupID=0
</span><span class='line'>Using device 0
</span><span class='line'>
</span><span class='line'>Testing single precision
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>Result of classification: 1 3 5
</span><span class='line'>
</span><span class='line'>Test passed!
</span><span class='line'>
</span><span class='line'>Testing half precision (math in single precision)
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>Result of classification: 1 3 5
</span><span class='line'>
</span><span class='line'>Test passed!
</span></code></pre></td></tr></table></div></figure>


<h3>nvidia-container-toolkit???</h3>

<p>Docker Desktop + WSL2不用安装 nvidia-container-toolkit ???</p>

<h2>WSL2 Python - conda</h2>

<p>下载安装conda</p>

<ul>
<li><a href="https://blog.csdn.net/weixin_44029053/article/details/119480776">https://blog.csdn.net/weixin_44029053/article/details/119480776</a></li>
</ul>


<h3>下载miniconda</h3>

<p><a href="https://docs.conda.io/projects/miniconda/en/latest/">https://docs.conda.io/projects/miniconda/en/latest/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -p ~/miniconda3
</span><span class='line'>wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda3/miniconda.sh
</span><span class='line'>bash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3
</span><span class='line'>rm -rf ~/miniconda3/miniconda.sh
</span><span class='line'>
</span><span class='line'>~/miniconda3/bin/conda init bash</span></code></pre></td></tr></table></div></figure>


<p>运行脚本安装：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@DESKTOP-BR4MG38:ai$ mkdir miniconda3
</span><span class='line'>winse@DESKTOP-BR4MG38:ai$ cd miniconda3/
</span><span class='line'>winse@DESKTOP-BR4MG38:miniconda3$
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-BR4MG38:miniconda3$ bash miniconda.sh -b -u -p ~/miniconda3
</span><span class='line'>PREFIX=/home/winse/miniconda3
</span><span class='line'>Unpacking payload ...
</span><span class='line'>
</span><span class='line'>Installing base environment...
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Downloading and Extracting Packages:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Downloading and Extracting Packages:
</span><span class='line'>
</span><span class='line'>Preparing transaction: done
</span><span class='line'>Executing transaction: done
</span><span class='line'>installation finished.
</span><span class='line'>
</span><span class='line'>winse@DESKTOP-BR4MG38:miniconda3$ ~/miniconda3/bin/conda init bash
</span><span class='line'>no change     /home/winse/miniconda3/condabin/conda
</span><span class='line'>no change     /home/winse/miniconda3/bin/conda
</span><span class='line'>no change     /home/winse/miniconda3/bin/conda-env
</span><span class='line'>no change     /home/winse/miniconda3/bin/activate
</span><span class='line'>no change     /home/winse/miniconda3/bin/deactivate
</span><span class='line'>no change     /home/winse/miniconda3/etc/profile.d/conda.sh
</span><span class='line'>no change     /home/winse/miniconda3/etc/fish/conf.d/conda.fish
</span><span class='line'>no change     /home/winse/miniconda3/shell/condabin/Conda.psm1
</span><span class='line'>no change     /home/winse/miniconda3/shell/condabin/conda-hook.ps1
</span><span class='line'>no change     /home/winse/miniconda3/lib/python3.11/site-packages/xontrib/conda.xsh
</span><span class='line'>no change     /home/winse/miniconda3/etc/profile.d/conda.csh
</span><span class='line'>modified      /home/winse/.bashrc
</span><span class='line'>
</span><span class='line'>==&gt; For changes to take effect, close and re-open your current shell. &lt;==
</span></code></pre></td></tr></table></div></figure>


<h3>添加源：</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
</span><span class='line'>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
</span><span class='line'>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/
</span><span class='line'>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/msys2/
</span><span class='line'>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda/
</span><span class='line'>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/menpo/
</span><span class='line'>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch/
</span><span class='line'>conda config --set show_channel_urls yes 
</span><span class='line'>
</span><span class='line'>conda config --show channels
</span><span class='line'>#conda config --remove-key channels
</span></code></pre></td></tr></table></div></figure>


<h3>运行测试GPU</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>conda create -n demo_env python=3.8
</span><span class='line'>conda activate demo_env
</span><span class='line'>conda install pytorch==1.6.0 cudatoolkit=10.1 torchaudio=0.6.0 -c pytorch
</span><span class='line'>
</span><span class='line'>#conda list
</span><span class='line'>#conda deactivate
</span><span class='line'>
</span><span class='line'>#conda env list
</span><span class='line'>#conda remove -n demo_env --all
</span><span class='line'>#conda env remove --name old_name
</span></code></pre></td></tr></table></div></figure>


<p>验证是否安装成功
在我们到demo_env环境下，打开Python，输入以下语句：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(demo_env) winse@DESKTOP-BR4MG38:ai$ python
</span><span class='line'>Python 3.8.18 | packaged by conda-forge | (default, Dec 23 2023, 17:21:28)
</span><span class='line'>[GCC 12.3.0] on linux
</span><span class='line'>Type "help", "copyright", "credits" or "license" for more information.
</span><span class='line'>&gt;&gt;&gt; import torch
</span><span class='line'>&gt;&gt;&gt; x = torch.rand(5,3)
</span><span class='line'>&gt;&gt;&gt; print(x)
</span><span class='line'>tensor([[0.4343, 0.3966, 0.1862],
</span><span class='line'>        [0.1502, 0.0788, 0.7713],
</span><span class='line'>        [0.3505, 0.7065, 0.9952],
</span><span class='line'>        [0.6420, 0.2574, 0.7550],
</span><span class='line'>        [0.8292, 0.7714, 0.9014]])
</span><span class='line'>&gt;&gt;&gt; print(torch.cuda.is_available())
</span><span class='line'>True
</span></code></pre></td></tr></table></div></figure>


<h2>模型下载</h2>

<p><strong>非常重要，不然时间都浪费等待下载上了。模型动辄几G，稍微大一点的就几十G，是需要慎重和反复探索。</strong></p>

<p>一开始用代理和GIT下载的，又慢又浪费时间又浪费空间。放着下了一晚，早起起来磁盘空间不够 o(╥﹏╥)o 。</p>

<p><img src="/images/blogs/ai/git-down-ai-models.png" alt="" /></p>

<p>参考 <a href="https://soulteary.com/2024/01/09/summary-of-reliable-download-solutions-for-ai-models.html">https://soulteary.com/2024/01/09/summary-of-reliable-download-solutions-for-ai-models.html</a></p>

<h3>国内的modelscope下载</h3>

<p>modelscope它还结合了aliyun提供了一定时长的免费环境，在本地折腾折腾后再上去跑跑。这里只通过它去下载模型（下载的方式是没有.git的文件，少占一半多的磁盘空间）。</p>

<ul>
<li><a href="https://modelscope.cn/docs/%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8B%E8%BD%BD">https://modelscope.cn/docs/%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8B%E8%BD%BD</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) winse@DESKTOP-BR4MG38:ai$ conda activate demo
</span><span class='line'>
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:ai$ pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
</span><span class='line'>
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:ai$ pip install modelscope
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:ai$ python -c "from modelscope.hub.snapshot_download import snapshot_download;snapshot_download('damo/nlp_xlmr_named-entity-recognition_viet-ecommerce-title', cache_dir='./')"
</span><span class='line'>2024-01-14 16:52:36,017 - modelscope - INFO - PyTorch version 1.11.0+cu113 Found.
</span><span class='line'>2024-01-14 16:52:36,018 - modelscope - INFO - Loading ast index from /home/winse/.cache/modelscope/ast_indexer
</span><span class='line'>2024-01-14 16:52:36,050 - modelscope - INFO - Loading done! Current index file version is 1.11.0, with md5 85336421feb1dc1ec9dde85ceee20f42 and a total number of 953 components indexed
</span><span class='line'>2024-01-14 16:52:36,757 - modelscope - WARNING - Model revision not specified, use revision: v1.0.0
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1.19k/1.19k [00:00&lt;00:00, 12.3MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 238/238 [00:00&lt;00:00, 1.97MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 238/238 [00:00&lt;00:00, 1.81MB/s]
</span><span class='line'>Downloading: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉| 1.04G/1.04G [00:36&lt;00:00, 30.1MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2.68k/2.68k [00:00&lt;00:00, 18.2MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2.68k/2.68k [00:00&lt;00:00, 27.7MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4.83M/4.83M [00:00&lt;00:00, 7.97MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 150/150 [00:00&lt;00:00, 1.58MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8.68M/8.68M [00:00&lt;00:00, 11.3MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 470/470 [00:00&lt;00:00, 4.53MB/s]
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:ai$ python -c "from modelscope.hub.snapshot_download import snapshot_download;snapshot_download('Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-v0.1', cache_dir='./')"
</span><span class='line'>2024-01-15 08:19:52,588 - modelscope - INFO - PyTorch version 1.11.0+cu113 Found.
</span><span class='line'>2024-01-15 08:19:52,589 - modelscope - INFO - Loading ast index from /home/winse/.cache/modelscope/ast_indexer
</span><span class='line'>2024-01-15 08:19:52,741 - modelscope - INFO - Loading done! Current index file version is 1.11.0, with md5 85336421feb1dc1ec9dde85ceee20f42 and a total number of 953 components indexed
</span><span class='line'>2024-01-15 08:19:53,874 - modelscope - WARNING - Model revision not specified, use revision: v1.0.0
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 257k/257k [00:00&lt;00:00, 1.48MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████| 600/600 [00:00&lt;00:00, 488kB/s]
</span><span class='line'>Downloading: 100%|██████████████████████████████████████████████████████████████████| 793/793 [00:00&lt;00:00, 1.35MB/s]
</span><span class='line'>Downloading: 100%|██████████████████████████████████████████████████████████████████| 884/884 [00:00&lt;00:00, 1.47MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████| 4.56k/4.56k [00:00&lt;00:00, 220kB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████| 146/146 [00:00&lt;00:00, 251kB/s]
</span><span class='line'>Downloading: 100%|█████████████████████████████████████████████████████████████▉| 3.20G/3.20G [01:29&lt;00:00, 38.5MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 319M/319M [00:39&lt;00:00, 8.39MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 571k/571k [00:00&lt;00:00, 2.35MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 583k/583k [00:00&lt;00:00, 2.16MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 571k/571k [00:00&lt;00:00, 2.10MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████| 539/539 [00:00&lt;00:00, 924kB/s]
</span><span class='line'>Downloading: 100%|█████████████████████████████████████████████████████████████████| 196k/196k [00:00&lt;00:00, 998kB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 226k/226k [00:00&lt;00:00, 1.24MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████| 342/342 [00:00&lt;00:00, 617kB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 390M/390M [00:30&lt;00:00, 13.5MB/s]
</span><span class='line'>Downloading: 100%|█████████████████████████████████████████████████████████████▉| 1.13G/1.13G [00:41&lt;00:00, 29.3MB/s]
</span><span class='line'>Downloading: 100%|██████████████████████████████████████████████████████████████| 8.90k/8.90k [00:00&lt;00:00, 3.09MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████| 298/298 [00:00&lt;00:00, 482kB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████| 186/186 [00:00&lt;00:00, 304kB/s]
</span><span class='line'>Downloading: 100%|█████████████████████████████████████████████████████████████▉| 3.89G/3.89G [02:12&lt;00:00, 31.6MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 477k/477k [00:00&lt;00:00, 2.02MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 477k/477k [00:00&lt;00:00, 1.72MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 198k/198k [00:00&lt;00:00, 1.01MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████| 212k/212k [00:00&lt;00:00, 1.10MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████| 555/555 [00:00&lt;00:00, 933kB/s]
</span><span class='line'>Downloading: 100%|█████████████████████████████████████████████████████████████████| 107k/107k [00:00&lt;00:00, 782kB/s]
</span></code></pre></td></tr></table></div></figure>


<p>对比一下git和直接下载空间的占用，时间就更加不用说了。</p>

<p><img src="/images/blogs/ai/download-vs.png" alt="" /></p>

<h3>modelscope</h3>

<p>把整个流程跑一下，跑个简单的例子：</p>

<p>环境安装
<a href="https://modelscope.cn/docs/%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85">https://modelscope.cn/docs/%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85</a></p>

<p>运行时依赖</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(demo) winse@DESKTOP-BR4MG38:ai$ pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
</span><span class='line'>#pip config set global.index-url https://mirrors.cloud.aliyuncs.com/pypi/simple 
</span><span class='line'>#pip config set install.trusted-host mirrors.cloud.aliyuncs.com
</span><span class='line'>
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:ai$ pip3 install torch==1.11.0 torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu113
</span><span class='line'>
</span><span class='line'>$ pip install transformers sentencepiece pyvi
</span></code></pre></td></tr></table></div></figure>


<p>测试模型：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>https://modelscope.cn/models/damo/nlp_xlmr_named-entity-recognition_viet-ecommerce-title/summary
</span><span class='line'>
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:ai$ python
</span><span class='line'>Python 3.8.18 | packaged by conda-forge | (default, Dec 23 2023, 17:21:28)
</span><span class='line'>[GCC 12.3.0] on linux
</span><span class='line'>Type "help", "copyright", "credits" or "license" for more information.
</span><span class='line'>&gt;&gt;&gt; from modelscope.pipelines import pipeline
</span><span class='line'>2024-01-15 01:22:20,476 - modelscope - INFO - PyTorch version 1.11.0+cu113 Found.
</span><span class='line'>2024-01-15 01:22:20,478 - modelscope - INFO - Loading ast index from /home/winse/.cache/modelscope/ast_indexer
</span><span class='line'>2024-01-15 01:22:20,498 - modelscope - INFO - Loading done! Current index file version is 1.11.0, with md5 85336421feb1dc1ec9dde85ceee20f42 and a total number of 953 components indexed
</span><span class='line'>&gt;&gt;&gt; from modelscope.utils.constant import Tasks
</span><span class='line'>&gt;&gt;&gt; ner_pipeline = pipeline(Tasks.named_entity_recognition, 'damo/nlp_xlmr_named-entity-recognition_viet-ecommerce-title', model_revision='v1.0.1')
</span><span class='line'>2024-01-15 01:22:28,618 - modelscope - INFO - initiate model from damo/nlp_xlmr_named-entity-recognition_viet-ecommerce-title
</span><span class='line'>2024-01-15 01:22:28,620 - modelscope - INFO - initiate model from location damo/nlp_xlmr_named-entity-recognition_viet-ecommerce-title.
</span><span class='line'>2024-01-15 01:22:28,630 - modelscope - INFO - initialize model from damo/nlp_xlmr_named-entity-recognition_viet-ecommerce-title
</span><span class='line'>2024-01-15 01:22:30,945 - modelscope - INFO - head has no _keys_to_ignore_on_load_missing
</span><span class='line'>2024-01-15 01:22:34,599 - modelscope - INFO - All model checkpoint weights were used when initializing ModelForTokenClassificationWithCRF.
</span><span class='line'>
</span><span class='line'>2024-01-15 01:22:34,599 - modelscope - INFO - All the weights of ModelForTokenClassificationWithCRF were initialized from the model checkpoint If your task is similar to the task the model of the checkpoint was trained on, you can already use ModelForTokenClassificationWithCRF for predictions without further training.
</span><span class='line'>&gt;&gt;&gt; result = ner_pipeline('Nón vành dễ thương cho bé gái')
</span><span class='line'>&gt;&gt;&gt; print(result)
</span><span class='line'>{'output': [{'type': 'product', 'start': 0, 'end': 8, 'prob': 0.98140895, 'span': 'Nón vành'}, {'type': 'style', 'start': 9, 'end': 18, 'prob': 0.99752563, 'span': 'dễ thương'}, {'type': 'consumer_group', 'start': 23, 'end': 29, 'prob': 0.99895895, 'span': 'bé gái'}]}
</span><span class='line'>&gt;&gt;&gt;
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h3>TODO</h3>

<ul>
<li>huggingface</li>
</ul>


<p>国外的，后续用到了再补</p>

<ul>
<li>downloader（跳过）</li>
</ul>


<p>当然，如果进场要用到各种工具的特定版本来下载依赖，用一个docker镜像来作为下载器，也是不错的方法</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#Python轻量环境
</span><span class='line'>docker pull python:3.10-slim
</span><span class='line'>
</span><span class='line'>@1
</span><span class='line'>#将本地目录挂载到容器里，一会作为模型下载目录使用
</span><span class='line'>docker run --rm -it -v `pwd`:/models python:3.10-slim bash
</span><span class='line'>
</span><span class='line'>sed -i 's/snapshot.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list.d/debian.sources
</span><span class='line'>pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
</span><span class='line'>
</span><span class='line'>cd /models
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>@2
</span><span class='line'>#创建一个持续运行的 Python 容器
</span><span class='line'>docker run -d --name=downloader -v `pwd`:/models python:3.10-slim tail -f /etc/hosts
</span><span class='line'>#使用命令进入容器进行配置和下载模型
</span><span class='line'>docker exec -it downloader bash
</span></code></pre></td></tr></table></div></figure>


<h2>太乙模型</h2>

<h3>[尝试/试错]</h3>

<p>开始是参照 <a href="https://soulteary.com/2022/12/09/use-docker-to-quickly-get-started-with-the-chinese-stable-diffusion-model-taiyi.html">使用 Docker 来快速上手中文 Stable Diffusion 模型：太乙</a> 文章里面说的蛮简单的，想着我这个WSL2+GPU应该也是可以的。</p>

<p>开始的时刻还是git clone的，等到怕了，几个小时还不一定成功，后面才改成下载的方式！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#git clone https://huggingface.co/IDEA-CCNL/Taiyi-Stable-Diffusion-1B-Chinese-v0.1
</span><span class='line'>winse@DESKTOP-BR4MG38:/mnt/i/ai/stable-diffusion-taiyi$ git clone https://www.modelscope.cn/Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-v0.1.git
</span><span class='line'>Cloning into 'Taiyi-Stable-Diffusion-1B-Chinese-v0.1'...
</span><span class='line'>remote: Enumerating objects: 85, done.
</span><span class='line'>remote: Counting objects: 100% (6/6), done.
</span><span class='line'>remote: Compressing objects: 100% (6/6), done.
</span><span class='line'>remote: Total 85 (delta 2), reused 0 (delta 0), pack-reused 79
</span><span class='line'>Unpacking objects: 100% (85/85), 3.61 GiB | 1.98 MiB/s, done.
</span><span class='line'>Filtering content: 100% (5/5), 8.92 GiB | 1.71 MiB/s, done.
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#镜像也下载了好几次 才pull下来
</span><span class='line'>winse@DESKTOP-BR4MG38:/mnt/i/ai$ docker pull soulteary/stable-diffusion:taiyi-0.1
</span><span class='line'>taiyi-0.1: Pulling from soulteary/stable-diffusion
</span><span class='line'>a404e5416296: Pull complete
</span><span class='line'>af6d12d8d61a: Pull complete
</span><span class='line'>bc57d500b85c: Pull complete
</span><span class='line'>fcd60060414d: Pull complete
</span><span class='line'>65b27d733eb0: Pull complete
</span><span class='line'>266c4315d44f: Pull complete
</span><span class='line'>7ed4190451a3: Pull complete
</span><span class='line'>975671c72e25: Pull complete
</span><span class='line'>213ba1e17e15: Pull complete
</span><span class='line'>37bbbc68318a: Pull complete
</span><span class='line'>80438d07027f: Pull complete
</span><span class='line'>74c79bc62d3a: Pull complete
</span><span class='line'>f8054e9907fb: Pull complete
</span><span class='line'>dc8d44bb4941: Pull complete
</span><span class='line'>625444b7a83c: Pull complete
</span><span class='line'>0b90667ff465: Pull complete
</span><span class='line'>67d73c5193e1: Pull complete
</span><span class='line'>Digest: sha256:69cc4b5fc890dd7ccffff9dbfc2eb2262a0a727574b8beeeafe621f9ef135d16
</span><span class='line'>Status: Downloaded newer image for soulteary/stable-diffusion:taiyi-0.1
</span><span class='line'>docker.io/soulteary/stable-diffusion:taiyi-0.1
</span><span class='line'>
</span><span class='line'>What's Next?
</span><span class='line'>  View a summary of image vulnerabilities and recommendations → docker scout quickview soulteary/stable-diffusion:taiyi-0.1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#这也是得在纯Linux机器上的Docker才行的
</span><span class='line'>#wget https://github.com/soulteary/docker-stable-diffusion-taiyi/blob/main/docker-compose.yml
</span><span class='line'>#我这就直接运行
</span><span class='line'>winse@DESKTOP-BR4MG38:stable-diffusion-taiyi$ docker run --gpus all --rm -it -v $(pwd)/Taiyi-Stable-Diffusion-1B-Chinese-v0.1:/stable-diffusion-webui/models/Taiyi-Stable-Diffusion-1B-Chinese-v0.1 -p 7860:7860 soulteary/stable-diffusion:taiyi-0.1
</span><span class='line'>
</span><span class='line'>#Windows cmd
</span><span class='line'>#docker run --gpus all --ipc=host --ulimit memlock=-1 --ulimit stack=67108864 --rm -it -v C:/docker-sdxl/stabilityai/:/app/stabilityai -p 7860:7860 soulteary/sdxl:runtime
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>运行起来后访问 <a href="http://localhost:7860/">http://localhost:7860/</a> ，输入 小船，河流，星空，星星，山峦，油画 查看Win11的任务管理器，GPU是打满了的，但生成的图片是全黑，啥都没有！</p>

<h3>WSL-Ubuntu部署</h3>

<p>试了很多次都不行，最后还是回到原点，不能偷懒，先把效果跑出来：</p>

<ul>
<li><a href="https://modelscope.cn/models/Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-v0.1/summary#%E4%BD%BF%E7%94%A8-usage">https://modelscope.cn/models/Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-v0.1/summary#%E4%BD%BF%E7%94%A8-usage</a></li>
</ul>


<h4>安装依赖（通过代理）</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#https://stackoverflow.com/questions/37776228/pycharm-python-opencv-and-cv2-install-error
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:~$ pip3 install opencv-python
</span><span class='line'>
</span><span class='line'>$ pip install diffusers
</span><span class='line'>
</span><span class='line'>##pip install accelerate
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:~$ unset all_proxy && unset ALL_PROXY
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:~$ pip install pysocks
</span><span class='line'>
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:~$ export ALL_PROXY=socks5://172.22.240.1:23333 HTTPS_PROXY=socks5://172.22.240.1:23333 HTTP_PROXY=socks5://172.22.240.1:23333
</span><span class='line'>(demo) winse@DESKTOP-BR4MG38:~$ pip install git+https://github.com/huggingface/accelerate  
</span></code></pre></td></tr></table></div></figure>


<h4>测试（跑了一个小时，-_-||）（此时还没安装cuDNN）：</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(demo) winse@DESKTOP-BR4MG38:ai$ python
</span><span class='line'>Python 3.8.18 | packaged by conda-forge | (default, Dec 23 2023, 17:21:28)
</span><span class='line'>[GCC 12.3.0] on linux
</span><span class='line'>Type "help", "copyright", "credits" or "license" for more information.
</span><span class='line'>&gt;&gt;&gt; from modelscope.utils.constant import Tasks
</span><span class='line'>2024-01-15 10:07:41,619 - modelscope - INFO - PyTorch version 1.11.0+cu113 Found.
</span><span class='line'>2024-01-15 10:07:41,630 - modelscope - INFO - Loading ast index from /home/winse/.cache/modelscope/ast_indexer
</span><span class='line'>2024-01-15 10:07:41,751 - modelscope - INFO - Loading done! Current index file version is 1.11.0, with md5 85336421feb1dc1ec9dde85ceee20f42 and a total number of 953 components indexed
</span><span class='line'>&gt;&gt;&gt; from modelscope.pipelines import pipeline
</span><span class='line'>&gt;&gt;&gt; import cv2
</span><span class='line'>&gt;&gt;&gt; pipe = pipeline(task=Tasks.text_to_image_synthesis, model='Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-v0.1', model_revision='v1.0.0')
</span><span class='line'>Loading pipeline components...:   0%|                                                          | 0/7 [00:00&lt;?, ?it/s]
</span><span class='line'>/home/winse/miniconda3/envs/demo/lib/python3.8/site-packages/transformers/models/clip/feature_extraction_clip.py:28: 
</span><span class='line'>FutureWarning: The class CLIPFeatureExtractor is deprecated and will be removed in version 5 of Transformers. Please use CLIPImageProcessor instead.
</span><span class='line'>  warnings.warn(
</span><span class='line'>Loading pipeline components...:  57%|████████████████████████████▌                     | 4/7 [00:32&lt;00:23,  7.83s/it]
</span><span class='line'>`text_config_dict` is provided which will be used to initialize `CLIPTextConfig`. The value `text_config["id2label"]` will be overriden.
</span><span class='line'>`text_config_dict` is provided which will be used to initialize `CLIPTextConfig`. The value `text_config["bos_token_id"]` will be overriden.
</span><span class='line'>`text_config_dict` is provided which will be used to initialize `CLIPTextConfig`. The value `text_config["eos_token_id"]` will be overriden.
</span><span class='line'>Loading pipeline components...: 100%|██████████████████████████████████████████████████| 7/7 [03:23&lt;00:00, 29.02s/it]
</span><span class='line'>&gt;&gt;&gt; prompt = '飞流直下三千尺，油画'
</span><span class='line'>&gt;&gt;&gt; output = pipe({'text': prompt})
</span><span class='line'>/home/winse/miniconda3/envs/demo/lib/python3.8/site-packages/diffusers/pipelines/stable_diffusion/pipeline_stable_diffusion.py:889: FutureWarning: `callback_steps` is deprecated and will be removed in version 1.0.0. Passing `callback_steps` as an input argument to `__call__` is deprecated, consider using `callback_on_step_end`
</span><span class='line'>  deprecate(
</span><span class='line'>We strongly recommend passing in an `attention_mask` since your input_ids may be padded. See https://huggingface.co/docs/transformers/troubleshooting#incorrect-output-when-padding-tokens-arent-masked.
</span><span class='line'>You may ignore this warning if your `pad_token_id` (0) is identical to the `bos_token_id` (0), `eos_token_id` (2), or the `sep_token_id` (None), and your input is not padded.
</span><span class='line'>100%|██████████████████████████████████████████████████████████████████████████████| 50/50 [1:03:11&lt;00:00, 75.83s/it]
</span><span class='line'>&gt;&gt;&gt; cv2.imwrite('result.png', output['output_imgs'][0])
</span><span class='line'>True
</span><span class='line'>&gt;&gt;&gt;</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/blogs/ai/taiyi-result.png" alt="" /></p>

<h4>再测个快的</h4>

<p>有 cuDNN 加持确实快，10分钟就跑出来了！没安装之前时间估计是三个小时的！！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; import torch
</span><span class='line'>&gt;&gt;&gt; from diffusers import StableDiffusionPipeline
</span><span class='line'>&gt;&gt;&gt; torch.backends.cudnn.benchmark = True
</span><span class='line'>
</span><span class='line'>&gt;&gt;&gt; pipe = StableDiffusionPipeline.from_pretrained("Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-v0.1", torch_dtype=torch.float16)
</span><span class='line'>Loading pipeline components...:  57%|████████████████████████████▌                     | 4/7 [00:05&lt;00:03,  1.32s/it]`text_config_dict` is provided which will be used to initialize `CLIPTextConfig`. The value `text_config["id2label"]` will be overriden.
</span><span class='line'>`text_config_dict` is provided which will be used to initialize `CLIPTextConfig`. The value `text_config["bos_token_id"]` will be overriden.
</span><span class='line'>`text_config_dict` is provided which will be used to initialize `CLIPTextConfig`. The value `text_config["eos_token_id"]` will be overriden.
</span><span class='line'>Loading pipeline components...: 100%|██████████████████████████████████████████████████| 7/7 [00:32&lt;00:00,  4.58s/it]
</span><span class='line'>&gt;&gt;&gt; pipe.to('cuda')
</span><span class='line'>StableDiffusionPipeline {
</span><span class='line'>  "_class_name": "StableDiffusionPipeline",
</span><span class='line'>  "_diffusers_version": "0.25.0",
</span><span class='line'>  "_name_or_path": "Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-v0.1",
</span><span class='line'>  "feature_extractor": [
</span><span class='line'>    "transformers",
</span><span class='line'>    "CLIPFeatureExtractor"
</span><span class='line'>  ],
</span><span class='line'>  "image_encoder": [
</span><span class='line'>    null,
</span><span class='line'>    null
</span><span class='line'>  ],
</span><span class='line'>  "requires_safety_checker": true,
</span><span class='line'>  "safety_checker": [
</span><span class='line'>    "stable_diffusion",
</span><span class='line'>    "StableDiffusionSafetyChecker"
</span><span class='line'>  ],
</span><span class='line'>  "scheduler": [
</span><span class='line'>    "diffusers",
</span><span class='line'>    "PNDMScheduler"
</span><span class='line'>  ],
</span><span class='line'>  "text_encoder": [
</span><span class='line'>    "transformers",
</span><span class='line'>    "BertModel"
</span><span class='line'>  ],
</span><span class='line'>  "tokenizer": [
</span><span class='line'>    "transformers",
</span><span class='line'>    "BertTokenizer"
</span><span class='line'>  ],
</span><span class='line'>  "unet": [
</span><span class='line'>    "diffusers",
</span><span class='line'>    "UNet2DConditionModel"
</span><span class='line'>  ],
</span><span class='line'>  "vae": [
</span><span class='line'>    "diffusers",
</span><span class='line'>    "AutoencoderKL"
</span><span class='line'>  ]
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>&gt;&gt;&gt;
</span><span class='line'>&gt;&gt;&gt; prompt = '飞流直下三千尺，油画'
</span><span class='line'>&gt;&gt;&gt; image = pipe(prompt, guidance_scale=7.5).images[0]
</span><span class='line'>100%|████████████████████████████████████████████████████████████████████████████████| 50/50 [09:32&lt;00:00, 11.45s/it]
</span><span class='line'>&gt;&gt;&gt; image.save("飞流.png")
</span><span class='line'>&gt;&gt;&gt;
</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/blogs/ai/taiyi-cudnn-result.png" alt="" /></p>

<h2>改一下conda的名字</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(demo) winse@DESKTOP-BR4MG38:ai$ conda deactivate
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:ai$ conda rename -n demo modelscope
</span><span class='line'>Source:      /home/winse/miniconda3/envs/demo
</span><span class='line'>Destination: /home/winse/miniconda3/envs/modelscope
</span><span class='line'>Packages: 22
</span><span class='line'>Files: 33924
</span><span class='line'>
</span><span class='line'>Downloading and Extracting Packages:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Downloading and Extracting Packages:
</span><span class='line'>
</span><span class='line'>Preparing transaction: done
</span><span class='line'>Verifying transaction: done
</span><span class='line'>Executing transaction: done
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:ai$ conda env list
</span><span class='line'># conda environments:
</span><span class='line'>#
</span><span class='line'>base                  *  /home/winse/miniconda3
</span><span class='line'>modelscope               /home/winse/miniconda3/envs/modelscope
</span></code></pre></td></tr></table></div></figure>


<h2>模型下载脚本</h2>

<p>比如下载：<a href="https://modelscope.cn/models/Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-EN-v0.1/summary">https://modelscope.cn/models/Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-EN-v0.1/summary</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ tail -16 ~/.bashrc
</span><span class='line'>
</span><span class='line'>function modelscope_download() {
</span><span class='line'>model=$1
</span><span class='line'>
</span><span class='line'>conda activate modelscope
</span><span class='line'>
</span><span class='line'>#pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
</span><span class='line'>#pip install modelscope
</span><span class='line'>
</span><span class='line'>python -c "from modelscope.hub.snapshot_download import snapshot_download;snapshot_download('$model', cache_dir='./')"
</span><span class='line'>
</span><span class='line'>conda deactivate
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>$ source ~/.bashrc
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:ai$ modelscope_download "Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-EN-v0.1"
</span><span class='line'>2024-01-15 15:17:13,613 - modelscope - INFO - PyTorch version 1.11.0+cu113 Found.
</span><span class='line'>2024-01-15 15:17:13,614 - modelscope - INFO - Loading ast index from /home/winse/.cache/modelscope/ast_indexer
</span><span class='line'>2024-01-15 15:17:13,637 - modelscope - INFO - Loading done! Current index file version is 1.11.0, with md5 85336421feb1dc1ec9dde85ceee20f42 and a total number of 953 components indexed
</span><span class='line'>2024-01-15 15:17:16,879 - modelscope - WARNING - Model revision not specified, use revision: v1.0.0
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████| 2.31M/2.31M [00:00&lt;00:00, 6.01MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████████████████████████████████████| 612/612 [00:00&lt;00:00, 436kB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████████████████████████████████████| 547/547 [00:00&lt;00:00, 804kB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████████| 743/743 [00:00&lt;00:00, 1.25MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████████████████████████████████| 4.46k/4.46k [00:00&lt;00:00, 244kB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████████████████████████████████████| 139/139 [00:00&lt;00:00, 231kB/s]
</span><span class='line'>Downloading: 100%|██████████████████████████████████████████████████████████████████████████████████████████▉| 3.20G/3.20G [02:36&lt;00:00, 22.0MB/s]
</span><span class='line'>Downloading: 100%|█████████████████████████████████████████████████████████████████████████████████████████████| 319M/319M [00:39&lt;00:00, 8.40MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████| 2.11M/2.11M [00:00&lt;00:00, 4.05MB/s]
</span><span class='line'>Downloading: 100%|█████████████████████████████████████████████████████████████████████████████████████████████| 512k/512k [00:00&lt;00:00, 1.28MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████████████████████████████████████| 543/543 [00:00&lt;00:00, 845kB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████████████████████████████████████| 342/342 [00:00&lt;00:00, 521kB/s]
</span><span class='line'>Downloading: 100%|██████████████████████████████████████████████████████████████████████████████████████████▉| 1.13G/1.13G [01:22&lt;00:00, 14.8MB/s]
</span><span class='line'>Downloading: 100%|█████████████████████████████████████████████████████████████████████████████████████████████| 469M/469M [00:12&lt;00:00, 39.0MB/s]
</span><span class='line'>Downloading: 100%|█████████████████████████████████████████████████████████████████████████████████████████████| 5.00/5.00 [00:00&lt;00:00, 6.02kB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████| 7.97k/7.97k [00:00&lt;00:00, 7.06MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████████████████████████████████████| 284/284 [00:00&lt;00:00, 441kB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████████████████████████████████████| 389/389 [00:00&lt;00:00, 348kB/s]
</span><span class='line'>Downloading: 100%|██████████████████████████████████████████████████████████████████████████████████████████▉| 11.3G/11.3G [04:07&lt;00:00, 49.0MB/s]
</span><span class='line'>Downloading: 100%|████████████████████████████████████████████████████████████████████████████████████████████████| 697/697 [00:00&lt;00:00, 950kB/s]
</span><span class='line'>Downloading: 100%|█████████████████████████████████████████████████████████████████████████████████████████████| 939k/939k [00:00&lt;00:00, 2.50MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████| 2.87M/2.87M [00:00&lt;00:00, 5.79MB/s]
</span><span class='line'>Downloading: 100%|███████████████████████████████████████████████████████████████████████████████████████████| 3.44M/3.44M [00:00&lt;00:00, 6.17MB/s]
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#tree -L 2
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:ai$ tree -L 1 Fengshenbang/
</span><span class='line'>Fengshenbang/
</span><span class='line'>├── Taiyi-Stable-Diffusion-1B-Chinese-EN-v0.1
</span><span class='line'>└── Taiyi-Stable-Diffusion-1B-Chinese-v0.1
</span><span class='line'>
</span><span class='line'>2 directories, 0 files
</span></code></pre></td></tr></table></div></figure>


<p>再跑一个中英文的模型试试</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) winse@DESKTOP-BR4MG38:ai$ conda activate modelscope
</span><span class='line'>(modelscope) winse@DESKTOP-BR4MG38:ai$
</span><span class='line'>(modelscope) winse@DESKTOP-BR4MG38:ai$ python
</span><span class='line'>Python 3.8.18 | packaged by conda-forge | (default, Dec 23 2023, 17:21:28)
</span><span class='line'>[GCC 12.3.0] on linux
</span><span class='line'>Type "help", "copyright", "credits" or "license" for more information.
</span><span class='line'>&gt;&gt;&gt; from diffusers import StableDiffusionPipeline
</span><span class='line'>&gt;&gt;&gt; pipe = StableDiffusionPipeline.from_pretrained("Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-EN-v0.1").to("cuda")
</span><span class='line'>Loading pipeline components...:  43%|█████████████████████████████████▊                                             | 3/7 [00:17&lt;00:21,  5.46s/it]/home/winse/miniconda3/envs/modelscope/lib/python3.8/site-packages/transformers/models/clip/feature_extraction_clip.py:28: FutureWarning: The class CLIPFeatureExtractor is deprecated and will be removed in version 5 of Transformers. Please use CLIPImageProcessor instead.
</span><span class='line'>  warnings.warn(
</span><span class='line'>Loading pipeline components...:  86%|███████████████████████████████████████████████████████████████████▋           | 6/7 [00:17&lt;00:01,  1.90s/it]`text_config_dict` is provided which will be used to initialize `CLIPTextConfig`. The value `text_config["id2label"]` will be overriden.
</span><span class='line'>`text_config_dict` is provided which will be used to initialize `CLIPTextConfig`. The value `text_config["bos_token_id"]` will be overriden.
</span><span class='line'>`text_config_dict` is provided which will be used to initialize `CLIPTextConfig`. The value `text_config["eos_token_id"]` will be overriden.
</span><span class='line'>Loading pipeline components...: 100%|███████████████████████████████████████████████████████████████████████████████| 7/7 [00:27&lt;00:00,  3.87s/it]
</span><span class='line'>&gt;&gt;&gt;
</span><span class='line'>&gt;&gt;&gt; prompt = '小桥流水人家，Van Gogh style'
</span><span class='line'>&gt;&gt;&gt; image = pipe(prompt, guidance_scale=10).images[0]
</span><span class='line'>100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 50/50 [14:19&lt;00:00, 17.19s/it]
</span><span class='line'>&gt;&gt;&gt; image.save("小桥.png")
</span><span class='line'>&gt;&gt;&gt;</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/blogs/ai/taiyi-zh-en-result.png" alt="" /></p>

<h2>太乙webui - 亦步亦趋</h2>

<p>这里记录了安装的详细过程，比较繁琐，如果直接安装可以跳到[太乙webui - 纯净版]。</p>

<ul>
<li><a href="https://github.com/IDEA-CCNL/stable-diffusion-webui/blob/master/README.md">https://github.com/IDEA-CCNL/stable-diffusion-webui/blob/master/README.md</a></li>
<li><a href="https://github.com/soulteary/docker-stable-diffusion-taiyi/blob/main/docker/Dockerfile">https://github.com/soulteary/docker-stable-diffusion-taiyi/blob/main/docker/Dockerfile</a></li>
<li><a href="https://github.com/IDEA-CCNL/stable-diffusion-webui/blob/master/webui.sh">https://github.com/IDEA-CCNL/stable-diffusion-webui/blob/master/webui.sh</a></li>
</ul>


<p>选一个跟我现在用的环境一样的版本和系统：<a href="https://hub.docker.com/r/nvidia/cuda/tags">https://hub.docker.com/r/nvidia/cuda/tags</a></p>

<p>镜像的描述：CUDA and cuDNN images from gitlab.com/nvidia/cuda</p>

<h3>试错</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(modelscope) winse@DESKTOP-BR4MG38:ai$ docker pull nvidia/cuda:12.3.1-devel-ubuntu20.04
</span><span class='line'>12.3.1-devel-ubuntu20.04: Pulling from nvidia/cuda
</span><span class='line'>12.3.1-devel-ubuntu20.04: Pulling from nvidia/cuda
</span><span class='line'>25ad149ed3cf: Pull complete
</span><span class='line'>ba7b66a9df40: Pull complete
</span><span class='line'>520797292d92: Pull complete
</span><span class='line'>c5f2ffd06d8b: Pull complete
</span><span class='line'>1698c67699a3: Pull complete
</span><span class='line'>16dd7c0d35aa: Pull complete
</span><span class='line'>568cac1e538c: Pull complete
</span><span class='line'>6252d19a7f1d: Pull complete
</span><span class='line'>f573e2686be4: Pull complete
</span><span class='line'>0074e75104ac: Pull complete
</span><span class='line'>df35fae9e247: Pull complete
</span><span class='line'>Digest: sha256:befbdfddbb52727f9ce8d0c574cac0f631c606b1e6f0e523f3a0777fe2720c99
</span><span class='line'>Status: Downloaded newer image for nvidia/cuda:12.3.1-devel-ubuntu20.04
</span><span class='line'>docker.io/nvidia/cuda:12.3.1-devel-ubuntu20.04
</span><span class='line'>
</span><span class='line'>What's Next?
</span><span class='line'>  1. Sign in to your Docker account → docker login
</span><span class='line'>  2. View a summary of image vulnerabilities and recommendations → docker scout quickview nvidia/cuda:12.3.1-devel-ubuntu20.04
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(modelscope) winse@DESKTOP-BR4MG38:ai$ docker run --rm --gpus all --ipc host --ulimit memlock=-1 --ulimit stack=67108864 -it -v /mnt/i/ai:/app/stabilityai -p 7860:7860 docker.io/nvidia/cuda:12.3.1-devel-ubuntu20.04
</span><span class='line'>docker: Error response from daemon: failed to create task for container: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: error during container init: error running hook #0: error running hook: exit status 1, stdout: , stderr: Auto-detected mode as 'legacy'
</span><span class='line'>nvidia-container-cli: requirement error: unsatisfied condition: cuda&gt;=12.3, please update your driver to a newer version, or use an earlier cuda container: unknown.
</span></code></pre></td></tr></table></div></figure>


<h3>重新下载镜像并配置</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(modelscope) winse@DESKTOP-BR4MG38:ai$ nvidia-smi
</span><span class='line'>Mon Jan 15 17:04:18 2024
</span><span class='line'>+---------------------------------------------------------------------------------------+
</span><span class='line'>| NVIDIA-SMI 535.146.01             Driver Version: 537.99       CUDA Version: 12.2     |
</span><span class='line'>|-----------------------------------------+----------------------+----------------------+
</span><span class='line'>| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |
</span><span class='line'>| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |
</span><span class='line'>|                                         |                      |               MIG M. |
</span><span class='line'>|=========================================+======================+======================|
</span><span class='line'>|   0  Quadro T2000                   On  | 00000000:01:00.0  On |                  N/A |
</span><span class='line'>| N/A   46C    P8               6W /  60W |    589MiB /  4096MiB |      7%      Default |
</span><span class='line'>|                                         |                      |                  N/A |
</span><span class='line'>+-----------------------------------------+----------------------+----------------------+
</span><span class='line'>
</span><span class='line'>+---------------------------------------------------------------------------------------+
</span><span class='line'>| Processes:                                                                            |
</span><span class='line'>|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |
</span><span class='line'>|        ID   ID                                                             Usage      |
</span><span class='line'>|=======================================================================================|
</span><span class='line'>|    0   N/A  N/A        39      G   /Xwayland                                 N/A      |
</span><span class='line'>|    0   N/A  N/A        42      G   /Xwayland                                 N/A      |
</span><span class='line'>|    0   N/A  N/A        44      G   /Xwayland                                 N/A      |
</span><span class='line'>+---------------------------------------------------------------------------------------+</span></code></pre></td></tr></table></div></figure>


<p>版本不能高于本地CUDA，重新下载镜像：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(modelscope) winse@DESKTOP-BR4MG38:ai$ docker pull nvidia/cuda:12.2.2-devel-ubuntu20.04
</span><span class='line'>12.2.2-devel-ubuntu20.04: Pulling from nvidia/cuda
</span><span class='line'>12.2.2-devel-ubuntu20.04: Pulling from nvidia/cuda
</span><span class='line'>96d54c3075c9: Pull complete
</span><span class='line'>db26cf78ae4f: Pull complete
</span><span class='line'>5adc7ab504d3: Pull complete
</span><span class='line'>e4f230263527: Pull complete
</span><span class='line'>95e3f492d47e: Pull complete
</span><span class='line'>35dd1979297e: Pull complete
</span><span class='line'>39a2c88664b3: Pull complete
</span><span class='line'>d8f6b6cd09da: Pull complete
</span><span class='line'>fe19bbed4a4a: Pull complete
</span><span class='line'>469ef7e9efe0: Pull complete
</span><span class='line'>e30c6425f419: Pull complete
</span><span class='line'>Digest: sha256:b7074ef6f9aa30c27fe747f3a7e10402ec442f001290718c73e0972d1ee61342
</span><span class='line'>Status: Downloaded newer image for nvidia/cuda:12.2.2-devel-ubuntu20.04
</span><span class='line'>docker.io/nvidia/cuda:12.2.2-devel-ubuntu20.04
</span><span class='line'>
</span><span class='line'>What's Next?
</span><span class='line'>  1. Sign in to your Docker account → docker login
</span><span class='line'>  2. View a summary of image vulnerabilities and recommendations → docker scout quickview nvidia/cuda:12.2.2-devel-ubuntu20.04
</span></code></pre></td></tr></table></div></figure>


<h3>运行容器实例</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(modelscope) winse@DESKTOP-BR4MG38:P15$ docker run --rm --gpus all --ipc host --ulimit memlock=-1 --ulimit stack=67108864 -it -v /mnt/i/ai:/app/stabilityai -p 7860:7860 docker.io/nvidia/cuda:12.2.2-devel-ubuntu20.04
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>==========
</span><span class='line'>== CUDA ==
</span><span class='line'>==========
</span><span class='line'>
</span><span class='line'>CUDA Version 12.2.2
</span><span class='line'>
</span><span class='line'>Container image Copyright (c) 2016-2023, NVIDIA CORPORATION & AFFILIATES. All rights reserved.
</span><span class='line'>
</span><span class='line'>This container image and its contents are governed by the NVIDIA Deep Learning Container License.
</span><span class='line'>By pulling and using the container, you accept the terms and conditions of this license:
</span><span class='line'>https://developer.nvidia.com/ngc/nvidia-deep-learning-container-license
</span><span class='line'>
</span><span class='line'>A copy of this license is made available in this container at /NGC-DL-CONTAINER-LICENSE for your convenience.
</span><span class='line'>
</span><span class='line'>root@41af85cb0007:/# nvidia-smi 
</span><span class='line'>Mon Jan 15 13:25:43 2024       
</span><span class='line'>+---------------------------------------------------------------------------------------+
</span><span class='line'>| NVIDIA-SMI 535.146.01             Driver Version: 537.99       CUDA Version: 12.2     |
</span><span class='line'>|-----------------------------------------+----------------------+----------------------+
</span><span class='line'>| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |
</span><span class='line'>| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |
</span><span class='line'>|                                         |                      |               MIG M. |
</span><span class='line'>|=========================================+======================+======================|
</span><span class='line'>|   0  Quadro T2000                   On  | 00000000:01:00.0  On |                  N/A |
</span><span class='line'>| N/A   43C    P8               3W /  60W |    620MiB /  4096MiB |      2%      Default |
</span><span class='line'>|                                         |                      |                  N/A |
</span><span class='line'>+-----------------------------------------+----------------------+----------------------+
</span><span class='line'>
</span><span class='line'>+---------------------------------------------------------------------------------------+
</span><span class='line'>| Processes:                                                                            |
</span><span class='line'>|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |
</span><span class='line'>|        ID   ID                                                             Usage      |
</span><span class='line'>|=======================================================================================|
</span><span class='line'>|  No running processes found                                                           |
</span><span class='line'>+---------------------------------------------------------------------------------------+
</span><span class='line'>root@41af85cb0007:/# docker ps -a 
</span><span class='line'>bash: docker: command not found
</span><span class='line'>root@41af85cb0007:/# python -V 
</span><span class='line'>bash: python: command not found
</span></code></pre></td></tr></table></div></figure>


<p>尽管用的是WSL 2 based engine，但是不是Windows管理的。</p>

<h3>配值webui</h3>

<p>[解决被官方忽视的 AI 容器应用问题] <a href="https://soulteary.com/2022/12/09/use-docker-to-quickly-get-started-with-the-chinese-stable-diffusion-model-taiyi.html">https://soulteary.com/2022/12/09/use-docker-to-quickly-get-started-with-the-chinese-stable-diffusion-model-taiyi.html</a>
<a href="https://github.com/soulteary/docker-stable-diffusion-taiyi/blob/main/docker/Dockerfile">https://github.com/soulteary/docker-stable-diffusion-taiyi/blob/main/docker/Dockerfile</a>
是对官方的依赖安装的拆解。可以参考，还是不建议这么搞，如果能促成源头修正那就是另一种说法了。</p>

<p>由于他的镜像我也跑不起来，所以直接按照官方来安装，参考借鉴他遇到解决过的问题。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@41af85cb0007:/# sed -i.bak -e 's|archive.ubuntu.com/ubuntu/|mirrors.tuna.tsinghua.edu.cn/ubuntu/|' -e 's|security.ubuntu.com/ubuntu/|mirrors.tuna.tsinghua.edu.cn/ubuntu/|' /etc/apt/sources.list
</span><span class='line'>
</span><span class='line'>root@41af85cb0007:/# apt update 
</span><span class='line'>
</span><span class='line'>root@41af85cb0007:/# apt install -y git wget curl iputils-ping iproute2 traceroute
</span><span class='line'>
</span><span class='line'>root@41af85cb0007:/# wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
</span><span class='line'>
</span><span class='line'>root@41af85cb0007:/# bash Miniconda3-latest-Linux-x86_64.sh -b
</span><span class='line'>PREFIX=/root/miniconda3
</span><span class='line'>Unpacking payload ...
</span><span class='line'>                                                                                                                                                                                                           
</span><span class='line'>Installing base environment...
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Downloading and Extracting Packages:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Downloading and Extracting Packages:
</span><span class='line'>
</span><span class='line'>Preparing transaction: done
</span><span class='line'>Executing transaction: done
</span><span class='line'>installation finished.
</span><span class='line'>
</span><span class='line'>root@41af85cb0007:/# /root/miniconda3/bin/conda init bash 
</span><span class='line'>no change     /root/miniconda3/condabin/conda
</span><span class='line'>no change     /root/miniconda3/bin/conda
</span><span class='line'>no change     /root/miniconda3/bin/conda-env
</span><span class='line'>no change     /root/miniconda3/bin/activate
</span><span class='line'>no change     /root/miniconda3/bin/deactivate
</span><span class='line'>no change     /root/miniconda3/etc/profile.d/conda.sh
</span><span class='line'>no change     /root/miniconda3/etc/fish/conf.d/conda.fish
</span><span class='line'>no change     /root/miniconda3/shell/condabin/Conda.psm1
</span><span class='line'>no change     /root/miniconda3/shell/condabin/conda-hook.ps1
</span><span class='line'>no change     /root/miniconda3/lib/python3.11/site-packages/xontrib/conda.xsh
</span><span class='line'>no change     /root/miniconda3/etc/profile.d/conda.csh
</span><span class='line'>modified      /root/.bashrc
</span><span class='line'>
</span><span class='line'>==&gt; For changes to take effect, close and re-open your current shell. &lt;==
</span><span class='line'>
</span><span class='line'>root@41af85cb0007:/# source ~/.bashrc
</span><span class='line'>(base) root@41af85cb0007:/# 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#https://github.com/IDEA-CCNL/stable-diffusion-webui/zipball/master/
</span><span class='line'>#https://github.com/IDEA-CCNL/stable-diffusion-webui/tarball/master/
</span><span class='line'>#https://docs.github.com/en/repositories/working-with-files/using-files/downloading-source-code-archives#source-code-archive-urls
</span><span class='line'>(base) root@41af85cb0007:/opt# wget -c https://github.com/IDEA-CCNL/stable-diffusion-webui/archive/refs/heads/master.tar.gz -O stable-diffusion-webui.tgz
</span><span class='line'>
</span><span class='line'>(base) root@41af85cb0007:/opt# tar zxf stable-diffusion-webui.tgz 
</span><span class='line'>(base) root@41af85cb0007:/opt# mv stable-diffusion-webui-master stable-diffusion-webui
</span><span class='line'>(base) root@41af85cb0007:/opt# cd stable-diffusion-webui
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#@@ 反正走代理，没必要
</span><span class='line'>#(webui) root@41af85cb0007:/opt/stable-diffusion-webui# pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
</span><span class='line'>#Writing to /root/.config/pip/pip.conf
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#https://github.com/AUTOMATIC1111/stable-diffusion-webui/issues/4345
</span><span class='line'>#https://stackoverflow.com/questions/75099182/stable-diffusion-error-couldnt-install-torch-no-matching-distribution-found
</span><span class='line'>#ERROR: Ignored the following versions that require a different python version: 1.6.2 Requires-Python &gt;=3.7,&lt;3.10; 1.6.3 Requires-Python &gt;=3.7,&lt;3.10; 1.7.0 Requires-Python &gt;=3.7,&lt;3.10; 1.7.1 Requires-Python &gt;=3.7,&lt;3.10
</span><span class='line'>(base) root@41af85cb0007:/opt/stable-diffusion-webui# conda create -n py39 python=3.9
</span><span class='line'>(base) root@41af85cb0007:/opt/stable-diffusion-webui# conda activate py39
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#@@ 用到github，得socks代理一下，@@先去掉代理不然又解析不了@@
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# unset all_proxy && unset ALL_PROXY && unset https_proxy && unset HTTPS_PROXY
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# pip install pysocks
</span><span class='line'>Collecting pysocks
</span><span class='line'>  WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(&lt;pip._vendor.urllib3.connection.HTTPSConnection object at 0x7fca218ae370&gt;, 'Connection to files.pythonhosted.org timed out. (connect timeout=15)')': /packages/8d/59/b4572118e098ac8e46e399a1dd0f2d85403ce8bbaad9ec79373ed6badaf9/PySocks-1.7.1-py3-none-any.whl
</span><span class='line'>  Downloading PySocks-1.7.1-py3-none-any.whl (16 kB)
</span><span class='line'>Installing collected packages: pysocks
</span><span class='line'>Successfully installed pysocks-1.7.1
</span><span class='line'>WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#?? ImportError: libGL.so.1: cannot open shared object file: No such file or directory
</span><span class='line'>
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# apt-get install ffmpeg libsm6 libxext6  -y
</span><span class='line'>...
</span><span class='line'>Setting up tzdata (2023c-0ubuntu0.20.04.2) ...
</span><span class='line'>debconf: unable to initialize frontend: Dialog
</span><span class='line'>debconf: (No usable dialog-like program is installed, so the dialog based frontend cannot be used. at /usr/share/perl5/Debconf/FrontEnd/Dialog.pm line 76.)
</span><span class='line'>debconf: falling back to frontend: Readline
</span><span class='line'>Configuring tzdata
</span><span class='line'>------------------
</span><span class='line'>
</span><span class='line'>Please select the geographic area in which you live. Subsequent configuration questions will narrow this down by presenting a list of cities, representing the time zones in which they are located.
</span><span class='line'>
</span><span class='line'>  1. Africa  2. America  3. Antarctica  4. Australia  5. Arctic  6. Asia  7. Atlantic  8. Europe  9. Indian  10. Pacific  11. SystemV  12. US  13. Etc
</span><span class='line'>Geographic area: 6
</span><span class='line'>
</span><span class='line'>Please select the city or region corresponding to your time zone.
</span><span class='line'>
</span><span class='line'>  1. Aden      9. Baghdad   17. Chita       25. Dushanbe     33. Irkutsk    41. Kashgar       49. Macau         57. Omsk        65. Rangoon        73. Taipei    81. Ujung_Pandang  89. Yekaterinburg
</span><span class='line'>  2. Almaty    10. Bahrain  18. Choibalsan  26. Famagusta    34. Istanbul   42. Kathmandu     50. Magadan       58. Oral        66. Riyadh         74. Tashkent  82. Ulaanbaatar    90. Yerevan
</span><span class='line'>  3. Amman     11. Baku     19. Chongqing   27. Gaza         35. Jakarta    43. Khandyga      51. Makassar      59. Phnom_Penh  67. Sakhalin       75. Tbilisi   83. Urumqi
</span><span class='line'>  4. Anadyr    12. Bangkok  20. Colombo     28. Harbin       36. Jayapura   44. Kolkata       52. Manila        60. Pontianak   68. Samarkand      76. Tehran    84. Ust-Nera
</span><span class='line'>  5. Aqtau     13. Barnaul  21. Damascus    29. Hebron       37. Jerusalem  45. Krasnoyarsk   53. Muscat        61. Pyongyang   69. Seoul          77. Tel_Aviv  85. Vientiane
</span><span class='line'>  6. Aqtobe    14. Beirut   22. Dhaka       30. Ho_Chi_Minh  38. Kabul      46. Kuala_Lumpur  54. Nicosia       62. Qatar       70. Shanghai       78. Thimphu   86. Vladivostok
</span><span class='line'>  7. Ashgabat  15. Bishkek  23. Dili        31. Hong_Kong    39. Kamchatka  47. Kuching       55. Novokuznetsk  63. Qostanay    71. Singapore      79. Tokyo     87. Yakutsk
</span><span class='line'>  8. Atyrau    16. Brunei   24. Dubai       32. Hovd         40. Karachi    48. Kuwait        56. Novosibirsk   64. Qyzylorda   72. Srednekolymsk  80. Tomsk     88. Yangon
</span><span class='line'>Time zone: 70
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Current default time zone: 'Asia/Shanghai'
</span><span class='line'>Local time is now:      Tue Jan 16 02:00:49 CST 2024.
</span><span class='line'>Universal Time is now:  Mon Jan 15 18:00:49 UTC 2024.
</span><span class='line'>Run 'dpkg-reconfigure tzdata' if you wish to change it.
</span><span class='line'>
</span><span class='line'>Setting up libxcb-present0:amd64 (1.14-2) ...
</span><span class='line'>Setting up libglib2.0-data (2.64.6-1~ubuntu20.04.6) ...
</span><span class='line'>Setting up libslang2:amd64 (2.3.2-4) ...
</span><span class='line'>....
</span><span class='line'>Setting up libavdevice58:amd64 (7:4.2.7-0ubuntu0.1) ...
</span><span class='line'>Setting up ffmpeg (7:4.2.7-0ubuntu0.1) ...
</span><span class='line'>Processing triggers for libc-bin (2.31-0ubuntu9.12) ...
</span><span class='line'>/sbin/ldconfig.real: /lib/x86_64-linux-gnu/libcudadebugger.so.1 is not a symbolic link
</span><span class='line'>
</span><span class='line'>/sbin/ldconfig.real: /lib/x86_64-linux-gnu/libcuda.so.1 is not a symbolic link
</span><span class='line'>
</span><span class='line'>Processing triggers for libgdk-pixbuf2.0-0:amd64 (2.40.0+dfsg-3ubuntu0.4) ...
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#@@ 改改改：1 可以root跑，2 直接用当前项目，下载没带.git， 3 使用conda管理环境
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# diff -u webui.sh.back  webui.sh
</span><span class='line'>--- webui.sh.back       2024-01-16 02:10:15.775277218 +0800
</span><span class='line'>+++ webui.sh    2024-01-16 02:41:22.748823781 +0800
</span><span class='line'>@@ -64,23 +64,23 @@
</span><span class='line'> if [[ $(id -u) -eq 0 ]]
</span><span class='line'> then
</span><span class='line'>     printf "\n%s\n" "${delimiter}"
</span><span class='line'>-    printf "\e[1m\e[31mERROR: This script must not be launched as root, aborting...\e[0m"
</span><span class='line'>-    printf "\n%s\n" "${delimiter}"
</span><span class='line'>-    exit 1
</span><span class='line'>+#    printf "\e[1m\e[31mERROR: This script must not be launched as root, aborting...\e[0m"
</span><span class='line'>+#    printf "\n%s\n" "${delimiter}"
</span><span class='line'>+#    exit 1
</span><span class='line'> else
</span><span class='line'>     printf "\n%s\n" "${delimiter}"
</span><span class='line'>     printf "Running on \e[1m\e[32m%s\e[0m user" "$(whoami)"
</span><span class='line'>     printf "\n%s\n" "${delimiter}"
</span><span class='line'> fi
</span><span class='line'> 
</span><span class='line'>-if [[ -d .git ]]
</span><span class='line'>-then
</span><span class='line'>+#if [[ -d .git ]]
</span><span class='line'>+#then
</span><span class='line'>     printf "\n%s\n" "${delimiter}"
</span><span class='line'>     printf "Repo already cloned, using it as install directory"
</span><span class='line'>     printf "\n%s\n" "${delimiter}"
</span><span class='line'>     install_dir="${PWD}/../"
</span><span class='line'>     clone_dir="${PWD##*/}"
</span><span class='line'>-fi
</span><span class='line'>+#fi
</span><span class='line'>
</span><span class='line'> # Check prerequisites
</span><span class='line'> for preq in "${GIT}" "${python_cmd}"
</span><span class='line'>@@ -120,19 +120,20 @@
</span><span class='line'> cd "${install_dir}"/"${clone_dir}"/ || { printf "\e[1m\e[31mERROR: Can't cd to %s/%s/, aborting...\e[0m" "${install_dir}" "${clone_dir}"; exit 1; }
</span><span class='line'> if [[ ! -d "${venv_dir}" ]]
</span><span class='line'> then
</span><span class='line'>-    "${python_cmd}" -m venv "${venv_dir}"
</span><span class='line'>+#    "${python_cmd}" -m venv "${venv_dir}"
</span><span class='line'>+    mkdir -p "${venv_dir}"
</span><span class='line'>     first_launch=1
</span><span class='line'> fi
</span><span class='line'> # shellcheck source=/dev/null
</span><span class='line'>-if [[ -f "${venv_dir}"/bin/activate ]]
</span><span class='line'>-then
</span><span class='line'>-    source "${venv_dir}"/bin/activate
</span><span class='line'>-else
</span><span class='line'>-    printf "\n%s\n" "${delimiter}"
</span><span class='line'>-    printf "\e[1m\e[31mERROR: Cannot activate python venv, aborting...\e[0m"
</span><span class='line'>-    printf "\n%s\n" "${delimiter}"
</span><span class='line'>-    exit 1
</span><span class='line'>-fi
</span><span class='line'>+#if [[ -f "${venv_dir}"/bin/activate ]]
</span><span class='line'>+#then
</span><span class='line'>+#    source "${venv_dir}"/bin/activate
</span><span class='line'>+#else
</span><span class='line'>+#    printf "\n%s\n" "${delimiter}"
</span><span class='line'>+#    printf "\e[1m\e[31mERROR: Cannot activate python venv, aborting...\e[0m"
</span><span class='line'>+#    printf "\n%s\n" "${delimiter}"
</span><span class='line'>+#    exit 1
</span><span class='line'>+#fi
</span><span class='line'>
</span><span class='line'> printf "\n%s\n" "${delimiter}"
</span><span class='line'> printf "Launching launch.py..."
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# export HTTPS_PROXY=socks5://172.22.240.1:23333
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# bash webui.sh
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>Install script for stable-diffusion + Web UI
</span><span class='line'>Tested on Debian 11 (Bullseye)
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>Repo already cloned, using it as install directory
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>Launching launch.py...
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>Python 3.9.18 (main, Sep 11 2023, 13:41:44) 
</span><span class='line'>[GCC 11.2.0]
</span><span class='line'>Commit hash: &lt;none&gt;
</span><span class='line'>Installing torch and torchvision
</span><span class='line'>Installing gfpgan
</span><span class='line'>Installing clip
</span><span class='line'>Cloning Stable Diffusion into repositories/stable-diffusion...
</span><span class='line'>Cloning Taming Transformers into repositories/taming-transformers...
</span><span class='line'>Cloning K-diffusion into repositories/k-diffusion...
</span><span class='line'>Cloning CodeFormer into repositories/CodeFormer...
</span><span class='line'>Cloning BLIP into repositories/BLIP...
</span><span class='line'>Installing requirements for CodeFormer
</span><span class='line'>Installing requirements for Web UI
</span><span class='line'>repositories/Taiyi-Stable-Diffusion-1B-Chinese-v0.1/feature_extractor/preprocessor_config.json | File missing.
</span><span class='line'>repositories/Taiyi-Stable-Diffusion-1B-Chinese-v0.1 does not exist or file is missing. (1)Do you want to redownload the Taiyi model? Or (2)move your downloaded Taiyi model path? 1/2: 2
</span><span class='line'>
</span><span class='line'>Detection failed, please reconfirm that the model has been moved to: repositories/Taiyi-Stable-Diffusion-1B-Chinese-v0.1
</span><span class='line'>Please move the Taiyi model to: repositories/Taiyi-Stable-Diffusion-1B-Chinese-v0.1. Completed? y: y
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>???
</span><span class='line'>  File "/root/miniconda3/envs/py39/lib/python3.9/site-packages/httpx/_transports/default.py", line 275, in __init__
</span><span class='line'>    self._pool = httpcore.AsyncConnectionPool(
</span><span class='line'>TypeError: __init__() got an unexpected keyword argument 'socket_options'
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#https://github.com/AUTOMATIC1111/stable-diffusion-webui/issues/13236
</span><span class='line'>
</span><span class='line'>#pip install -U httpcore
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# pip3 install httpx==0.24.1
</span><span class='line'>
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# unset all_proxy && unset ALL_PROXY && unset https_proxy && unset HTTPS_PROXY && unset http_proxy && unset HTTP_PROXY
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# bash webui.sh
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>???
</span><span class='line'>ImportError: cannot import name '_compare_version' from 'torchmetrics.utilities.imports' (/root/miniconda3/envs/py39/lib/python3.9/site-packages/torchmetrics/utilities/imports.py)    
</span><span class='line'>
</span><span class='line'>#https://github.com/AUTOMATIC1111/stable-diffusion-webui/issues/11648
</span><span class='line'>#conda list torchmetrics
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# conda install --force-reinstall torchmetrics==0.11.4
</span><span class='line'>
</span><span class='line'>pip install torchmetrics==0.11.4 torch==1.13.1+cu117 torchvision==0.14.1+cu117 torchtext==0.14.1 torchaudio==0.13.1 torchdata==0.5.1 --extra-index-url https://download.pytorch.org/whl/cu117
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>???
</span><span class='line'>
</span><span class='line'>export COMMANDLINE_ARGS="--lowvram --precision full --no-half --skip-torch-cuda-test"
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>???
</span><span class='line'>RuntimeError: Cannot add middleware after an application has started
</span><span class='line'>
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# pip install fastapi==0.90.1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>@@终于启动了
</span><span class='line'>(py39) root@41af85cb0007:/opt/stable-diffusion-webui# bash webui.sh
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>Install script for stable-diffusion + Web UI
</span><span class='line'>Tested on Debian 11 (Bullseye)
</span><span class='line'>################################################################
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>Repo already cloned, using it as install directory
</span><span class='line'>################################################################
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>Create and activate python venv
</span><span class='line'>################################################################
</span><span class='line'>
</span><span class='line'>################################################################
</span><span class='line'>Launching launch.py...
</span><span class='line'>################################################################
</span><span class='line'>Python 3.9.18 (main, Sep 11 2023, 13:41:44)
</span><span class='line'>[GCC 11.2.0]
</span><span class='line'>Commit hash: &lt;none&gt;
</span><span class='line'>Installing requirements for Web UI
</span><span class='line'>Obtaining file:///opt/stable-diffusion-webui
</span><span class='line'>ERROR: file:///opt/stable-diffusion-webui does not appear to be a Python project: neither 'setup.py' nor 'pyproject.toml' found.
</span><span class='line'>Launching Web UI with arguments: --lowvram --precision full --no-half --ckpt /opt/stable-diffusion-webui/repositories/Taiyi-Stable-Diffusion-1B-Chinese-v0.1/Taiyi-Stable-Diffusion-1B-Chinese-v0.1.ckpt --listen --port 12345
</span><span class='line'>LatentDiffusion: Running in eps-prediction mode
</span><span class='line'>DiffusionWrapper has 859.52 M params.
</span><span class='line'>making attention of type 'vanilla' with 512 in_channels
</span><span class='line'>Working with z of shape (1, 4, 32, 32) = 4096 dimensions.
</span><span class='line'>making attention of type 'vanilla' with 512 in_channels
</span><span class='line'>Loading weights [e2e75020] from /opt/stable-diffusion-webui/repositories/Taiyi-Stable-Diffusion-1B-Chinese-v0.1/Taiyi-Stable-Diffusion-1B-Chinese-v0.1.ckpt
</span><span class='line'>Applying cross attention optimization (Doggettx).
</span><span class='line'>Model loaded.
</span><span class='line'>Loaded a total of 0 textual inversion embeddings.
</span><span class='line'>Embeddings:
</span><span class='line'>Running on local URL:  http://0.0.0.0:12345
</span><span class='line'>
</span><span class='line'>To create a public link, set `share=True` in `launch()`.
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>启动镜像的时刻忘了挂数据U盘了，直接全部拷贝到容器里面：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) root@41af85cb0007:/opt/stable-diffusion-webui/repositories# mkdir Taiyi-Stable-Diffusion-1B-Chinese-v0.1 
</span><span class='line'>
</span><span class='line'>#(base) winse@DESKTOP-BR4MG38:Taiyi-Stable-Diffusion-1B-Chinese-v0.1$ tar tf 1.tar * 
</span><span class='line'>#(base) winse@DESKTOP-BR4MG38:Taiyi-Stable-Diffusion-1B-Chinese-v0.1$ docker cp 1.tar 41af85cb0007:/opt/stable-diffusion-webui/repositories/Taiyi-Stable-Diffusion-1B-Chinese-v0.1/
</span><span class='line'>
</span><span class='line'>(base) root@41af85cb0007:/opt/stable-diffusion-webui/repositories/Taiyi-Stable-Diffusion-1B-Chinese-v0.1# tar xf 1.tar 
</span><span class='line'>(base) root@41af85cb0007:/opt/stable-diffusion-webui/repositories/Taiyi-Stable-Diffusion-1B-Chinese-v0.1# rm -rf 1.tar 
</span><span class='line'>(base) root@41af85cb0007:/opt/stable-diffusion-webui/repositories/Taiyi-Stable-Diffusion-1B-Chinese-v0.1# ll
</span><span class='line'>total 4084196
</span><span class='line'>drwxr-xr-x 9 root  root        4096 Jan 15 17:57 ./
</span><span class='line'>drwxrwxr-x 9 root  root        4096 Jan 15 17:42 ../
</span><span class='line'>-rwxrwxrwx 1 webui webui 4182159787 Jan 15 00:26 Taiyi-Stable-Diffusion-1B-Chinese-v0.1.ckpt*
</span><span class='line'>-rwxrwxrwx 1 webui webui        146 Jan 15 00:19 configuration.json*
</span><span class='line'>drwxrwxrwx 2 webui webui       4096 Jan 15 17:50 feature_extractor/
</span><span class='line'>-rwxrwxrwx 1 webui webui        539 Jan 15 00:22 model_index.json*
</span><span class='line'>drwxrwxrwx 2 webui webui       4096 Jan 15 17:50 safety_checker/
</span><span class='line'>drwxrwxrwx 2 webui webui       4096 Jan 15 17:50 scheduler/
</span><span class='line'>drwxrwxrwx 2 webui webui       4096 Jan 15 17:50 text_encoder/
</span><span class='line'>drwxrwxrwx 2 webui webui       4096 Jan 15 17:50 tokenizer/
</span><span class='line'>drwxrwxrwx 2 webui webui       4096 Jan 15 17:50 unet/
</span><span class='line'>drwxrwxrwx 2 webui webui       4096 Jan 15 17:50 vae/
</span></code></pre></td></tr></table></div></figure>


<h2>太乙webui - 纯净版</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) winse@DESKTOP-BR4MG38:P15$ cat /etc/os-release 
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:P15$ cat /etc/issue
</span><span class='line'>Ubuntu 20.04.6 LTS \n \l
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:P15$ nvidia-smi
</span><span class='line'>Tue Jan 16 07:09:11 2024       
</span><span class='line'>+---------------------------------------------------------------------------------------+
</span><span class='line'>| NVIDIA-SMI 535.146.01             Driver Version: 537.99       CUDA Version: 12.2     |
</span><span class='line'>|-----------------------------------------+----------------------+----------------------+
</span><span class='line'>| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |
</span><span class='line'>| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |
</span><span class='line'>|                                         |                      |               MIG M. |
</span><span class='line'>|=========================================+======================+======================|
</span><span class='line'>|   0  Quadro T2000                   On  | 00000000:01:00.0  On |                  N/A |
</span><span class='line'>| N/A   50C    P8               4W /  60W |    537MiB /  4096MiB |      1%      Default |
</span><span class='line'>|                                         |                      |                  N/A |
</span><span class='line'>+-----------------------------------------+----------------------+----------------------+
</span><span class='line'>
</span><span class='line'>+---------------------------------------------------------------------------------------+
</span><span class='line'>| Processes:                                                                            |
</span><span class='line'>|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |
</span><span class='line'>|        ID   ID                                                             Usage      |
</span><span class='line'>|=======================================================================================|
</span><span class='line'>|    0   N/A  N/A        32      G   /Xwayland                                 N/A      |
</span><span class='line'>|    0   N/A  N/A        39      G   /Xwayland                                 N/A      |
</span><span class='line'>|    0   N/A  N/A        41      G   /Xwayland                                 N/A      |
</span><span class='line'>+---------------------------------------------------------------------------------------+</span></code></pre></td></tr></table></div></figure>


<p>选一个跟我现在用的环境一样的版本和系统：<a href="https://hub.docker.com/r/nvidia/cuda/tags">https://hub.docker.com/r/nvidia/cuda/tags</a> CUDA and cuDNN images from gitlab.com/nvidia/cuda</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) winse@DESKTOP-BR4MG38:P15$ docker pull nvidia/cuda:12.2.2-devel-ubuntu20.04
</span><span class='line'>
</span><span class='line'>(base) winse@DESKTOP-BR4MG38:P15$ docker run --gpus all --ipc host --ulimit memlock=-1 --ulimit stack=67108864 -it -v /mnt/i/ai:/app/stabilityai -p 7860:7860 docker.io/nvidia/cuda:12.2.2-devel-ubuntu20.04
</span><span class='line'>
</span><span class='line'>root@c65a73d918b1:/# sed -i.bak -e 's|archive.ubuntu.com/ubuntu/|mirrors.tuna.tsinghua.edu.cn/ubuntu/|' -e 's|security.ubuntu.com/ubuntu/|mirrors.tuna.tsinghua.edu.cn/ubuntu/|' /etc/apt/sources.list
</span><span class='line'>root@c65a73d918b1:/# apt update 
</span><span class='line'>
</span><span class='line'>root@c65a73d918b1:/# apt install -y git wget vim
</span><span class='line'>
</span><span class='line'>root@c65a73d918b1:/# cd 
</span><span class='line'>root@c65a73d918b1:~# wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
</span><span class='line'>root@c65a73d918b1:~# bash Miniconda3-latest-Linux-x86_64.sh -b -u                
</span><span class='line'>root@c65a73d918b1:~# ~/miniconda3/bin/conda init bash
</span><span class='line'>root@c65a73d918b1:~# source ~/.bashrc
</span><span class='line'>(base) root@c65a73d918b1:~# 
</span><span class='line'>
</span><span class='line'>(base) root@c65a73d918b1:~# wget -c https://github.com/IDEA-CCNL/stable-diffusion-webui/archive/refs/heads/master.tar.gz -O - | tar zxf - 
</span><span class='line'>(base) root@c65a73d918b1:~# mv stable-diffusion-webui-master stable-diffusion-webui        
</span><span class='line'>
</span><span class='line'>(base) root@c65a73d918b1:~# cd stable-diffusion-webui
</span><span class='line'>(base) root@c65a73d918b1:~/stable-diffusion-webui# conda create -n py3.10 python=3.10
</span><span class='line'>(base) root@c65a73d918b1:~/stable-diffusion-webui# conda activate py3.10
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# mkdir .git 
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# diff -u webui.sh.back  webui.sh 
</span><span class='line'>--- webui.sh.back       2024-01-15 23:39:24.271256229 +0000
</span><span class='line'>+++ webui.sh    2024-01-15 23:42:17.070404354 +0000
</span><span class='line'>@@ -64,9 +64,6 @@
</span><span class='line'> if [[ $(id -u) -eq 0 ]]
</span><span class='line'> then
</span><span class='line'>     printf "\n%s\n" "${delimiter}"
</span><span class='line'>-    printf "\e[1m\e[31mERROR: This script must not be launched as root, aborting...\e[0m"
</span><span class='line'>-    printf "\n%s\n" "${delimiter}"
</span><span class='line'>-    exit 1
</span><span class='line'> else
</span><span class='line'>     printf "\n%s\n" "${delimiter}"
</span><span class='line'>     printf "Running on \e[1m\e[32m%s\e[0m user" "$(whoami)"
</span><span class='line'>@@ -120,19 +117,11 @@
</span><span class='line'> cd "${install_dir}"/"${clone_dir}"/ || { printf "\e[1m\e[31mERROR: Can't cd to %s/%s/, aborting...\e[0m" "${install_dir}" "${clone_dir}"; exit 1; }
</span><span class='line'> if [[ ! -d "${venv_dir}" ]]
</span><span class='line'> then
</span><span class='line'>-    "${python_cmd}" -m venv "${venv_dir}"
</span><span class='line'>+#    "${python_cmd}" -m venv "${venv_dir}"
</span><span class='line'>+    mkdir -p "${venv_dir}"
</span><span class='line'>     first_launch=1
</span><span class='line'> fi
</span><span class='line'> # shellcheck source=/dev/null
</span><span class='line'>-if [[ -f "${venv_dir}"/bin/activate ]]
</span><span class='line'>-then
</span><span class='line'>-    source "${venv_dir}"/bin/activate
</span><span class='line'>-else
</span><span class='line'>-    printf "\n%s\n" "${delimiter}"
</span><span class='line'>-    printf "\e[1m\e[31mERROR: Cannot activate python venv, aborting...\e[0m"
</span><span class='line'>-    printf "\n%s\n" "${delimiter}"
</span><span class='line'>-    exit 1
</span><span class='line'>-fi
</span><span class='line'>
</span><span class='line'> printf "\n%s\n" "${delimiter}"
</span><span class='line'> printf "Launching launch.py..."
</span><span class='line'> 
</span><span class='line'>
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
</span><span class='line'>
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# pip install pysocks
</span><span class='line'>
</span><span class='line'>#https://github.com/invoke-ai/InvokeAI/issues/3560#issuecomment-1689474997
</span><span class='line'>#https://blog.csdn.net/shark1357/article/details/131238924
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# pip install tb-nightly -i https://mirrors.aliyun.com/pypi/simple
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# pip install gfpgan==1.3.8
</span><span class='line'>
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# apt-get install ffmpeg libsm6 libxext6  -y
</span><span class='line'>
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# pip install httpcore httpx==0.24.1 torchmetrics==0.11.4 fastapi==0.90.1
</span><span class='line'>
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# vi webui-user.sh
</span><span class='line'>
</span><span class='line'>export COMMANDLINE_ARGS="--lowvram --precision full --no-half --skip-torch-cuda-test"
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(py3.10) root@c65a73d918b1:~# cd stable-diffusion-webui/repositories/
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui/repositories# ln -s /app/stabilityai/Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-v0.1/
</span><span class='line'>
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui/repositories#  ll Taiyi-Stable-Diffusion-1B-Chinese-v0.1
</span><span class='line'>lrwxrwxrwx 1 root root 69 Jan 16 07:58 Taiyi-Stable-Diffusion-1B-Chinese-v0.1 -&gt; /app/stabilityai/Fengshenbang/Taiyi-Stable-Diffusion-1B-Chinese-v0.1//
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# pip install socksio httpx[socks]
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#@@ 加代理下载部署时需要的github代码
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# export HTTPS_PROXY=socks5://172.22.240.1:23333
</span><span class='line'>(py3.10) root@c65a73d918b1:~/stable-diffusion-webui# bash webui.sh --port 7860
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>然后在Windows浏览器访问： <a href="http://localhost:7860/">http://localhost:7860/</a></p>

<p><img src="/images/blogs/ai/webui.png" alt="" /></p>

<p><img src="/images/blogs/ai/webui2.png" alt="" /></p>

<h2>TODO</h2>

<p>汉化： <a href="https://github.com/VinsonLaro/stable-diffusion-webui-chinese">https://github.com/VinsonLaro/stable-diffusion-webui-chinese</a></p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/11/18/reinstall-redmine-on-respberry2/">Reinstall Redmine on Raspberry2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2023-11-18T09:55:24+08:00" pubdate data-updated="true">Sat 2023-11-18 09:55</time>
		
        
		
      </p>
    
  </header>



  <div class="entry-content"><p>年前把树莓派拯救了回来 <a href="https://winse.github.io/blog/2023/03/25/reinstall-raspberry2/">重新折腾raspberry2</a> 由于年底了新平台慢慢成型，可能会用到BUG跟踪，想着不能浪费，能用则用能省者省的原则，把老古董用起来。</p>

<p>原来在树莓派2上安装过redmine的 <a href="https://winse.github.io/blog/2020/05/11/redmine-on-arm-pi/">在树莓派上部署redmine</a> 不过有些年头了，一开始想着刻舟求剑的方法能参照绝不死脑细胞的原则，现实则是四处碰壁。</p>

<p>这个配置确实有点拿不出手了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>top - 14:01:28 up 1 min,  1 user,  load average: 1.87, 0.63, 0.22
</span><span class='line'>Tasks: 130 total,   1 running, 129 sleeping,   0 stopped,   0 zombie
</span><span class='line'>%Cpu0  :  0.0 us,  0.0 sy,  0.0 ni, 99.7 id,  0.0 wa,  0.0 hi,  0.3 si,  0.0 st
</span><span class='line'>%Cpu1  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span><span class='line'>%Cpu2  :  0.3 us,  0.3 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span><span class='line'>%Cpu3  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span><span class='line'>MiB Mem :    922.0 total,    643.8 free,     79.7 used,    198.5 buff/cache
</span><span class='line'>MiB Swap:    100.0 total,    100.0 free,      0.0 used.    788.3 avail Mem 
</span></code></pre></td></tr></table></div></figure>


<h2>参照学习</h2>

<p>原来老版本安装的是 postgres9.6 + redmine3.4 的版本，2020年的时刻这些版本都还当时热乎着的，当时也用上了原来的数据以及插件都还想和原来一样使用。现在再来安装这个版本已经时过境迁了，官方的postgres9.6已经归档了。</p>

<p>1、ubuntu-14官方不支持以后，postgresql官网和各种镜像的网站的都没有该版本的9.6的源码。</p>

<p>2、找一个相对旧一些的操作系统ubuntu-20(focal)支持postgres9.6的，然后试着按原来源码编译的方式打包postgres-9.6 armv7的版本。</p>

<p>安装编译的依赖，编译打包除了慢一点（一个通宵）看起来都通过了（中间过程漫长有冗长没细细的看）。</p>

<p>打包好deb，等安装的时刻，就出现依赖不对找不到了。齐了怪了，编译都“通过”了，安装就不行，perl缺的依赖又找不到对应的版本。又重新弄了两遍！！！这个时间和精神消耗，我这身子骨已经跟它耗不起了。改变方式。</p>

<p>3、docker postgres有镜像也是11之后的，更别说是armv7的9.6了。</p>

<p>4、经过几天的折腾，狠狠心咬咬牙，换最新版本。只能最后再迁移数据，这样估计快一点。</p>

<h2>实践与改进</h2>

<p>确定使用最新的版本后，找到 <a href="https://github.com/sameersbn/docker-redmine/releases/tag/5.1.0">sameersbn/redmine:5.10</a> 然后用的是postgres-15数据库。在上面折腾的过程中，已经找过armv7的postgres数据库了，这次直接基于官方armv7-postgres-15作为基础来构建我这个应用数据库的镜像。</p>

<h3>postgres</h3>

<p>编译 armv7-postgres15 除了在LANG上有一些些错之外，其他都是挺顺利的。修改的内容以及Dockerfile内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:/opt/docker-postgresql-15-20230628# vim runtime/functions 
</span><span class='line'>
</span><span class='line'>300         if [[ -z $(psql -U ${PG_USER} -Atc "SELECT 1 FROM pg_catalog.pg_user WHERE usename = '${DB_USER}'";) ]]; then
</span><span class='line'>301           #psql -U ${PG_USER} -c "CREATE ROLE \"${DB_USER}\" with LOGIN CREATEDB PASSWORD '${DB_PASS}';" &gt;/dev/null
</span><span class='line'>302           psql -U ${PG_USER} -c "CREATE ROLE \"${DB_USER}\" SUPERUSER CREATEDB CREATEROLE LOGIN PASSWORD '${DB_PASS}';" &gt;/dev/null
</span><span class='line'>303         fi
</span><span class='line'>
</span><span class='line'>root@raspberrypi:/opt/docker-postgresql-15-20230628# cat Dockerfile 
</span><span class='line'>FROM arm32v7/postgres:15-bullseye
</span><span class='line'>
</span><span class='line'>LABEL maintainer="sameer@damagehead.com"
</span><span class='line'>
</span><span class='line'>ENV LC_ALL="en_US.UTF-8" \
</span><span class='line'>    LC_CTYPE="en_US.UTF-8"
</span><span class='line'>
</span><span class='line'>ENV PG_APP_HOME="/etc/docker-postgresql" \
</span><span class='line'>    PG_VERSION=15 \
</span><span class='line'>    PG_USER=postgres \
</span><span class='line'>    PG_HOME=/var/lib/postgresql \
</span><span class='line'>    PG_RUNDIR=/run/postgresql \
</span><span class='line'>    PG_LOGDIR=/var/log/postgresql \
</span><span class='line'>    PG_CERTDIR=/etc/postgresql/certs
</span><span class='line'>
</span><span class='line'>ENV PG_BINDIR=/usr/lib/postgresql/${PG_VERSION}/bin \
</span><span class='line'>    PG_DATADIR=${PG_HOME}/${PG_VERSION}/main
</span><span class='line'>
</span><span class='line'>RUN echo "LC_ALL=en_US.UTF-8" &gt;&gt; /etc/environment
</span><span class='line'>RUN echo "en_US.UTF-8 UTF-8" &gt;&gt; /etc/locale.gen
</span><span class='line'>RUN echo "LANG=en_US.UTF-8" &gt; /etc/locale.conf
</span><span class='line'>
</span><span class='line'>RUN sed -i 's@http://deb.debian.org@http://mirrors.aliyun.com@g' /etc/apt/sources.list \
</span><span class='line'> && apt-get update \
</span><span class='line'> && DEBIAN_FRONTEND=noninteractive apt-get install -y acl sudo locales \
</span><span class='line'> && update-locale LANG=C.UTF-8 LC_MESSAGES=POSIX \
</span><span class='line'> && locale-gen en_US.UTF-8 \
</span><span class='line'> && DEBIAN_FRONTEND=noninteractive dpkg-reconfigure locales \
</span><span class='line'> && mkdir -p /etc/postgresql/${PG_VERSION}/main \
</span><span class='line'> && ln -sf ${PG_DATADIR}/postgresql.conf /etc/postgresql/${PG_VERSION}/main/postgresql.conf \
</span><span class='line'> && ln -sf ${PG_DATADIR}/pg_hba.conf /etc/postgresql/${PG_VERSION}/main/pg_hba.conf \
</span><span class='line'> && ln -sf ${PG_DATADIR}/pg_ident.conf /etc/postgresql/${PG_VERSION}/main/pg_ident.conf \
</span><span class='line'> && rm -rf ${PG_HOME} \
</span><span class='line'> && rm -rf /var/lib/apt/lists/*
</span><span class='line'>
</span><span class='line'>COPY runtime/ ${PG_APP_HOME}/
</span><span class='line'>
</span><span class='line'>COPY entrypoint.sh /sbin/entrypoint.sh
</span><span class='line'>
</span><span class='line'>RUN chmod 755 /sbin/entrypoint.sh
</span><span class='line'>
</span><span class='line'>EXPOSE 5432/tcp
</span><span class='line'>
</span><span class='line'>WORKDIR ${PG_HOME}
</span><span class='line'>
</span><span class='line'>ENTRYPOINT ["/sbin/entrypoint.sh"]
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h3>redmine</h3>

<p>再编译redmine，这个构建镜像的时刻下载依赖太慢了，可能是安装的这些软件对树莓派2要求有点过高了，多次没响应远程断掉导致要重新弄。用了screen也没有效果。</p>

<ol>
<li>开一个screen的窗口，再启动一个容器。</li>
<li>在容器里面手动安装先把依赖搞定后，最后把容器提交作为一个镜像。</li>
<li>在这个镜像的基础上再构建redmine应用的镜像。</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~/docker-redmine-5.1.0# docker run -ti arm32v7/ruby:2.7.8-bullseye bash 
</span><span class='line'>
</span><span class='line'>root@e76bef6f1a9c:/# 
</span><span class='line'>wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - 
</span><span class='line'>echo 'deb http://apt.postgresql.org/pub/repos/apt/ bullseye-pgdg main' &gt; /etc/apt/sources.list.d/pgdg.list 
</span><span class='line'>
</span><span class='line'>sed -i 's@http://deb.debian.org@https://mirrors.aliyun.com@g' /etc/apt/sources.list && apt-get update
</span><span class='line'>#sed -i 's@http://deb.debian.org@https://mirrors.ustc.edu.cn@g' /etc/apt/sources.list && apt-get update
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 去掉mysql和ruby依赖
</span><span class='line'>apt-get install --no-install-recommends -y \
</span><span class='line'>      supervisor logrotate nginx postgresql-client ca-certificates sudo tzdata \
</span><span class='line'>      imagemagick subversion git cvs bzr mercurial darcs rsync locales openssh-client \
</span><span class='line'>      gcc g++ make patch pkg-config gettext-base libc6-dev zlib1g-dev libxml2-dev \
</span><span class='line'>      libpq5 libyaml-0-2 libcurl4 libssl1.1 uuid-dev xz-utils \
</span><span class='line'>      libxslt1.1 libffi7 zlib1g gsfonts vim-tiny ghostscript sqlite3 libsqlite3-dev 
</span><span class='line'>  
</span><span class='line'>update-locale LANG=C.UTF-8 LC_MESSAGES=POSIX
</span><span class='line'>
</span><span class='line'>gem install --no-document bundler
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 修改redmine的安装脚本
</span><span class='line'># @see https://mirrors.tuna.tsinghua.edu.cn/help/rubygems/
</span><span class='line'>root@raspberrypi:/opt/docker-redmine-5.1.0# vi assets/build/install.sh 
</span><span class='line'>  7 BUILD_DEPENDENCIES="wget libcurl4-openssl-dev libssl-dev libmagickcore-dev libmagickwand-dev \
</span><span class='line'>  8                     libpq-dev libxslt1-dev libffi-dev libyaml-dev \
</span><span class='line'>  9                     libsqlite3-dev"
</span><span class='line'>
</span><span class='line'> 41   exec_as_redmine wget --no-check-certificate "http://www.redmine.org/releases/redmine-${REDMINE_VERSION}.tar.gz" -O /tmp/redmine-${RE    DMINE_VERSION}.tar.gz
</span><span class='line'> 
</span><span class='line'>104 exec_as_redmine gem sources --add https://mirrors.tuna.tsinghua.edu.cn/rubygems/ --remove https://rubygems.org/
</span><span class='line'>105 exec_as_redmine bundle config mirror.https://rubygems.org https://mirrors.tuna.tsinghua.edu.cn/rubygems
</span><span class='line'>106 exec_as_redmine bundle install -j$(nproc)
</span><span class='line'>
</span><span class='line'># 拷贝到容器安装redmine
</span><span class='line'>root@raspberrypi:~/docker-redmine-5.1.0# docker cp assets/build/install.sh  e76bef6f1a9c:/opt/
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>root@e76bef6f1a9c:/# cd /opt/
</span><span class='line'>export RUBY_VERSION=2.7 \
</span><span class='line'>   REDMINE_VERSION=5.1.0 \
</span><span class='line'>   REDMINE_USER="redmine" \
</span><span class='line'>   REDMINE_HOME="/home/redmine" \
</span><span class='line'>   REDMINE_LOG_DIR="/var/log/redmine" \
</span><span class='line'>   REDMINE_ASSETS_DIR="/etc/docker-redmine" \
</span><span class='line'>   RAILS_ENV=production
</span><span class='line'>
</span><span class='line'>export REDMINE_INSTALL_DIR="${REDMINE_HOME}/redmine" \
</span><span class='line'>   REDMINE_DATA_DIR="${REDMINE_HOME}/data" \
</span><span class='line'>   REDMINE_BUILD_ASSETS_DIR="${REDMINE_ASSETS_DIR}/build" \
</span><span class='line'>   REDMINE_RUNTIME_ASSETS_DIR="${REDMINE_ASSETS_DIR}/runtime"
</span><span class='line'>
</span><span class='line'>root@e76bef6f1a9c:/# bash -x install.sh
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 安装好后，停掉容器提交作为镜像
</span><span class='line'>root@raspberrypi:~/docker-redmine-5.1.0# docker stop e76bef6f1a9c
</span><span class='line'>root@raspberrypi:~/docker-redmine-5.1.0# docker commit e76bef6f1a9c arm32v7/ruby:2.7.8-bullseye-redmine-base
</span><span class='line'>
</span><span class='line'>root@raspberrypi:/opt/docker-redmine-5.1.0# cat Dockerfile 
</span><span class='line'>#FROM arm32v7/ruby:2.7.8-bullseye AS add-apt-repositories
</span><span class='line'>#
</span><span class='line'>#RUN sed -i 's@http://deb.debian.org@https://mirrors.aliyun.com@g' /etc/apt/sources.list \
</span><span class='line'># && apt-get update \
</span><span class='line'># && DEBIAN_FRONTEND=noninteractive apt-get install -y wget gnupg2 \
</span><span class='line'># && apt-key adv --keyserver keyserver.ubuntu.com --recv E1DD270288B4E6030699E45FA1715D88E1DF1F24 \
</span><span class='line'># && apt-key adv --keyserver keyserver.ubuntu.com --recv 80F70E11F0F0D5F10CB20E62F5DA5F09C3173AA6 \
</span><span class='line'># && apt-key adv --keyserver keyserver.ubuntu.com --recv 8B3981E7A6852F782CC4951600A6F0A3C300EE8C \
</span><span class='line'># && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - \
</span><span class='line'># && echo 'deb http://apt.postgresql.org/pub/repos/apt/ bullseye-pgdg main' &gt; /etc/apt/sources.list.d/pgdg.list 
</span><span class='line'>
</span><span class='line'>FROM arm32v7/ruby:2.7.8-bullseye-redmine-base
</span><span class='line'>
</span><span class='line'>LABEL maintainer="sameer@damagehead.com"
</span><span class='line'>
</span><span class='line'>ENV RUBY_VERSION=2.7 \
</span><span class='line'>    REDMINE_VERSION=5.1.0 \
</span><span class='line'>    REDMINE_USER="redmine" \
</span><span class='line'>    REDMINE_HOME="/home/redmine" \
</span><span class='line'>    REDMINE_LOG_DIR="/var/log/redmine" \
</span><span class='line'>    REDMINE_ASSETS_DIR="/etc/docker-redmine" \
</span><span class='line'>    RAILS_ENV=production
</span><span class='line'>
</span><span class='line'>ENV REDMINE_INSTALL_DIR="${REDMINE_HOME}/redmine" \
</span><span class='line'>    REDMINE_DATA_DIR="${REDMINE_HOME}/data" \
</span><span class='line'>    REDMINE_BUILD_ASSETS_DIR="${REDMINE_ASSETS_DIR}/build" \
</span><span class='line'>    REDMINE_RUNTIME_ASSETS_DIR="${REDMINE_ASSETS_DIR}/runtime"
</span><span class='line'>
</span><span class='line'>#COPY --from=add-apt-repositories /etc/apt/trusted.gpg /etc/apt/trusted.gpg
</span><span class='line'>#
</span><span class='line'>#COPY --from=add-apt-repositories /etc/apt/sources.list /etc/apt/sources.list
</span><span class='line'>#COPY --from=add-apt-repositories /etc/apt/sources.list.d/pgdg.list /etc/apt/sources.list.d/
</span><span class='line'>#
</span><span class='line'>#RUN sed -i 's@http://deb.debian.org@https://mirrors.aliyun.com@g' /etc/apt/sources.list \
</span><span class='line'># && apt-get update \
</span><span class='line'># && DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
</span><span class='line'>#      supervisor logrotate nginx postgresql-client ca-certificates sudo tzdata \
</span><span class='line'>#      imagemagick subversion git cvs rsync locales openssh-client \
</span><span class='line'>#      gcc g++ make patch pkg-config gettext-base libxml2-dev \
</span><span class='line'>#      python3-pil python3-scour libimage-exiftool-perl ffmpegthumbnailer \
</span><span class='line'>#      libpq5 libyaml-0-2 libcurl4 libssl1.1 uuid-dev xz-utils \
</span><span class='line'>#      libxslt1.1 vim-tiny sqlite3 libsqlite3-dev \
</span><span class='line'># && update-locale LANG=C.UTF-8 LC_MESSAGES=POSIX \
</span><span class='line'># && gem install --no-document bundler \
</span><span class='line'># && rm -rf /var/lib/apt/lists/*
</span><span class='line'>
</span><span class='line'>#COPY assets/build/ ${REDMINE_BUILD_ASSETS_DIR}/
</span><span class='line'>#
</span><span class='line'>#RUN bash ${REDMINE_BUILD_ASSETS_DIR}/install.sh
</span><span class='line'>
</span><span class='line'>COPY assets/runtime/ ${REDMINE_RUNTIME_ASSETS_DIR}/
</span><span class='line'>
</span><span class='line'>COPY assets/tools/ /usr/bin/
</span><span class='line'>
</span><span class='line'>COPY entrypoint.sh /sbin/entrypoint.sh
</span><span class='line'>
</span><span class='line'>COPY VERSION /VERSION
</span><span class='line'>
</span><span class='line'>RUN chmod 755 /sbin/entrypoint.sh \
</span><span class='line'> && sed -i '/session    required     pam_loginuid.so/c\#session    required   pam_loginuid.so' /etc/pam.d/cron
</span><span class='line'>
</span><span class='line'>EXPOSE 80/tcp 443/tcp
</span><span class='line'>
</span><span class='line'>WORKDIR ${REDMINE_INSTALL_DIR}
</span><span class='line'>
</span><span class='line'>ENTRYPOINT ["/sbin/entrypoint.sh"]
</span><span class='line'>
</span><span class='line'>CMD ["app:start"]
</span><span class='line'>
</span><span class='line'>root@raspberrypi:/opt/docker-redmine-5.1.0# make build
</span><span class='line'>
</span><span class='line'>root@raspberrypi:/opt/docker-redmine-5.1.0# docker images 
</span><span class='line'>REPOSITORY             TAG                           IMAGE ID       CREATED        SIZE
</span><span class='line'>sameersbn/postgresql   15-20230628                   cedece0ace69   1 hours ago   324MB
</span><span class='line'>sameersbn/redmine      latest                        f1ab03480a1e   1 hours ago   953MB
</span><span class='line'>arm32v7/ruby           2.7.8-bullseye-redmine-base   3ee3b95c4c85   1 hours ago   953MB
</span><span class='line'>arm32v7/postgres       15-bullseye                   c8e0db9da7af   8 days ago     314MB
</span><span class='line'>arm32v7/ruby           2.7.8-bullseye                8100b7e215f8   6 months ago   667MB
</span></code></pre></td></tr></table></div></figure>


<h3>redmine-3.4的数据迁移到redmine-5.1</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@1cd14c92899a:/var/lib/postgresql# docker ps 
</span><span class='line'>CONTAINER ID   IMAGE                        COMMAND                  CREATED        STATUS      PORTS                                 NAMES
</span><span class='line'>458df7209e1b   sameersbn/redmine:3.4.6      "/sbin/entrypoint.sh…"   6 months ago   Up 2 days   443/tcp, 172.21.37.204:8081-&gt;80/tcp   redmine_redmine_1
</span><span class='line'>884a04c9f985   sameersbn/postgresql:9.6-2   "/sbin/entrypoint.sh"    2 years ago    Up 2 days   5432/tcp                              redmine_postgresql_1
</span><span class='line'>
</span><span class='line'>root@1cd14c92899a:/var/lib/postgresql# pg_dump -U postgres -Cc -d redmine_production &gt;redmine.dump 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 把redmine-5.1的也导出来一份对照，把库里已有的数据保留，在旧sql里面去掉5存在的记录（不然导入报逐渐冲突导入失败的）。
</span><span class='line'>
</span><span class='line'># 配置数据导入，增加旧版本需要的字段。
</span><span class='line'>ALTER TABLE projects
</span><span class='line'>  ADD COLUMN customers_deploys_notifications_emails character varying,
</span><span class='line'>  ADD COLUMN deploys_notifications_emails character varying,
</span><span class='line'>  ADD COLUMN abbreviation character varying
</span><span class='line'>  ;
</span><span class='line'>
</span><span class='line'>ALTER TABLE trackers
</span><span class='line'>  ADD COLUMN is_in_chlog boolean DEFAULT false NOT NULL
</span><span class='line'>  ;
</span><span class='line'>
</span><span class='line'>ALTER TABLE users
</span><span class='line'>  ADD COLUMN identity_url character varying
</span><span class='line'>  ;
</span><span class='line'>
</span><span class='line'>删掉空的表和数据还原部分。把需要的，保留有数据的表。
</span></code></pre></td></tr></table></div></figure>


<p>数据库备份处理不好要重新做的话，要删除对应的文件内容，然后重启即可。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~/docker-redmine-5.1.0# docker-compose down 
</span><span class='line'>root@raspberrypi:~/docker-redmine-5.1.0# rm -rf /srv/docker/redmine
</span><span class='line'>
</span><span class='line'>root@raspberrypi:~/docker-redmine-5.1.0# docker-compose up 
</span></code></pre></td></tr></table></div></figure>


<h3>图片附件解压文件</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:/# tar zxvf srv-docker-redmine.tar.gz /srv/docker/redmine/redmine/files 
</span></code></pre></td></tr></table></div></figure>


<h3>redmine插件</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:/srv/docker/redmine/redmine/plugins# unzip clipboard_image_paste-1.13.zip 
</span><span class='line'>root@raspberrypi:/srv/docker/redmine/redmine/plugins# mv clipboard_image_paste-1.13 clipboard_image_paste
</span><span class='line'>root@raspberrypi:/srv/docker/redmine/redmine/plugins# rm clipboard_image_paste-1.13.zip 
</span><span class='line'>root@raspberrypi:~/docker-redmine-5.1.0# docker-compose up -d 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>root@raspberrypi:/srv/docker/redmine/redmine/plugins# less clipboard_image_paste/init.rb
</span><span class='line'> 30 # @see https://github.com/paginagmbh/redmine_lightbox2/blob/master/init.rb
</span><span class='line'> 31 if Rails::VERSION::MAJOR &gt;= 5
</span><span class='line'> 32   ActiveSupport::Reloader.to_prepare do
</span><span class='line'> 33     require_dependency 'clipboard_image_paste/hooks'
</span><span class='line'> 34     require_dependency 'clipboard_image_paste/attachment_patch'
</span><span class='line'> 35   end 
</span><span class='line'> 36 elsif Rails::VERSION::MAJOR &gt;= 3
</span><span class='line'>
</span><span class='line'># @see https://github.com/peclik/clipboard_image_paste/pull/91/commits/570acebeb5dded80f24e7b01ffddbec09c9eccb6
</span><span class='line'>root@raspberrypi:/srv/docker/redmine/redmine/plugins# less clipboard_image_paste/lib/clipboard_image_paste/attachment_patch.rb
</span><span class='line'> 25       #alias_method_chain :save_attachments, :pasted_images
</span><span class='line'> 26       alias_method :save_attachmenets_without_pasted_images, :save_attachments
</span><span class='line'> 27       alias_method :save_attachments, :save_attachments_with_pasted_images
</span><span class='line'> 
</span><span class='line'>root@raspberrypi:~/docker-redmine-5.1.0# docker-compose restart redmine 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>lightbox2
</span><span class='line'>https://github.com/theforeman/redmine_lightbox2/commit/9c8b41f6893d4a92bb30923684bad7a1b40fdb62
</span><span class='line'>
</span><span class='line'>apijs
</span><span class='line'>https://www.luigifab.fr/en/redmine/apijs.php
</span><span class='line'>
</span><span class='line'>pi@raspberrypi:/srv/docker/redmine/redmine-logs $ docker logs -n 50 1e966fec7f9b
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h3>docker-compose</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># @see https://github.com/docker/compose/releases/
</span><span class='line'>
</span><span class='line'>root@raspberrypi:/usr/local/bin# ln -s docker-compose-linux-armv7 docker-compose
</span></code></pre></td></tr></table></div></figure>


<h2>反思与深思</h2>

<p>搞搞简单的文字还行，图片大了要计算的话就卡了！！！还是用4吧！！！</p>

<p>pi4上安装简单多了，直接在机器上编译一下镜像就可以了：</p>

<ol>
<li>postgres的用户修改下权限;</li>
<li>redmine去掉mysql的依赖。</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>#@ pi2
</span><span class='line'>root@1cd14c92899a:/var/lib/postgresql# pg_dump -U redmine -Cc -d redmine_production &gt;redmine.dump        
</span><span class='line'>
</span><span class='line'>#@ pi4
</span><span class='line'>root@d744a148ea59:/var/lib/postgresql# psql -U redmine -d postgres -f redmine.dump 
</span><span class='line'>
</span><span class='line'># srv的话，只需要复制redmine下的files、plugins。
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/04/09/dingtalk-with-openai/">钉钉群机器人对接ChatGPT</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2023-04-09T19:25:42+08:00" pubdate data-updated="true">Sun 2023-04-09 19:25</time>
		
        
		
      </p>
    
  </header>



  <div class="entry-content"><p>前面一段时刻，通过 <a href="https://github.com/zhayujie/bot-on-anything">https://github.com/zhayujie/bot-on-anything</a> 对接过个人微信的群，但是没过多久微信就被警告不能扫码了，前几天更新了钉钉机器人的对接方法，尝试了一下感觉还行马马虎虎。</p>

<p>当然过程是揪心的：钉钉文档在更新升级，bot这边的文档太简单，需要对着代码，然后对着dingtalk官方的文档对照着去排查。</p>

<h2>第一步 首先是创建企业内部机器人，获取Secret</h2>

<p>平时对接的告警机器人是只能发消息的，不能接收消息。</p>

<p>在钉钉APP中创建一个组织，然后在以这个组织登录 <a href="https://open-dev.dingtalk.com/v1/fe/old#/corprobot">https://open-dev.dingtalk.com/v1/fe/old#/corprobot</a> 然后再点击 创建机器人：</p>

<p>其中基础信息中的AppSecret后面会用到，对应dingtalk_secret：</p>

<p><img src="/images/blogs/openai/dingtalk1.png" alt="机器人基础信息" /></p>

<p>然后配置接受消息的地址：就是钉钉服务器收到消息后，把消息转发到你的服务器（公网可访问的）地址。服务器出口IP：就是你部署服务器的公网IP，为了验证信息的合法性的一个参数。</p>

<p><img src="/images/blogs/openai/dingtalk2.png" alt="服务配置" /></p>

<p>创建好机器人后，在版本管理和发布页签中，上线机器人。这样我们在组织的群里面就能选择这个机器人了。</p>

<h2>第二步 把机器人加入组织群，获取Token</h2>

<p>选择 群设置 - 机器人 - 添加机器人，把刚刚创建的机器人加入到我们组织/公司群，然后查看机器人的设置，会提供一个webhook的地址，这一串地址中就包括了一个access_token的字符串参数，就是后面需要用的dingtalk_token。</p>

<p><img src="/images/blogs/openai/dingtalk3.png" alt="机器人管理" /></p>

<p><img src="/images/blogs/openai/dingtalk4.png" alt="机器人设置/配置页面" /></p>

<h2>第三步 配置bot，启动服务</h2>

<p>配置bot-on-anything的config.json，修改 channel - type 的类型为 dingtalk，dingtalk的参数为：机器人应用凭证的AppSecret对应dingtalk_secret；发布机器人，把机器人加入到群后，机器人设置页面的webhook地址上的access_token对应的是dingtalk_token。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"channel": {
</span><span class='line'>    "type": "dingtalk",
</span><span class='line'>    "single_chat_prefix": ["bot", "@bot"],
</span><span class='line'>    "single_chat_reply_prefix": "[bot] ",
</span><span class='line'>    "group_chat_prefix": ["@bot"],
</span><span class='line'>    "group_name_white_list": ["ChatGPT测试群"],
</span><span class='line'>    "image_create_prefix": ["画", "看", "找一张"],
</span><span class='line'>
</span><span class='line'>    "wechat": {
</span><span class='line'>    },
</span><span class='line'>
</span><span class='line'>    "wechat_mp": {
</span><span class='line'>      "token": "2023...",
</span><span class='line'>      "port": "3000"
</span><span class='line'>    },
</span><span class='line'>
</span><span class='line'>    "dingtalk": {
</span><span class='line'>      "image_create_prefix": ["画", "draw", "Draw"],
</span><span class='line'>      "port": "3000",
</span><span class='line'>      "dingtalk_token": "d55566a9e90...",
</span><span class='line'>      "dingtalk_post_token": "",
</span><span class='line'>      "dingtalk_secret": "PUMsK......"
</span><span class='line'>    },
</span><span class='line'>  </span></code></pre></td></tr></table></div></figure>


<p>启动服务，愉快的耍起来。</p>

<h2>第四步 小小改进</h2>

<ul>
<li>fix images <a href="https://github.com/zhayujie/bot-on-anything/issues/274#issuecomment-1501081485">https://github.com/zhayujie/bot-on-anything/issues/274#issuecomment-1501081485</a></li>
<li>add groups <a href="https://github.com/zhayujie/bot-on-anything/issues/274#issuecomment-1508274056">https://github.com/zhayujie/bot-on-anything/issues/274#issuecomment-1508274056</a></li>
</ul>


<p>在测试图片消息的时刻，发现还不太支持，还有回复消息at提问的人也小小改进了一下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat dingtalk_channel.py 
</span><span class='line'># encoding:utf-8
</span><span class='line'>import json
</span><span class='line'>import hmac
</span><span class='line'>import hashlib
</span><span class='line'>import base64
</span><span class='line'>import time
</span><span class='line'>import requests
</span><span class='line'>from urllib.parse import quote_plus
</span><span class='line'>from common import log
</span><span class='line'>from flask import Flask, request, render_template, make_response
</span><span class='line'>from common import const
</span><span class='line'>from common import functions
</span><span class='line'>from config import channel_conf
</span><span class='line'>from config import channel_conf_val
</span><span class='line'>from channel.channel import Channel
</span><span class='line'>
</span><span class='line'>class DingTalkChannel(Channel):
</span><span class='line'>    def __init__(self):
</span><span class='line'>        self.dingtalk_token = channel_conf(const.DINGTALK).get('dingtalk_token')
</span><span class='line'>        self.dingtalk_post_token = channel_conf(const.DINGTALK).get('dingtalk_post_token')
</span><span class='line'>        self.dingtalk_secret = channel_conf(const.DINGTALK).get('dingtalk_secret')
</span><span class='line'>        log.info("[DingTalk] dingtalk_secret={}, dingtalk_token={} dingtalk_post_token={}".format(self.dingtalk_secret, self.dingtalk_token, self.dingtalk_post_token))
</span><span class='line'>
</span><span class='line'>    def startup(self):
</span><span class='line'>        http_app.run(host='0.0.0.0', port=channel_conf(const.DINGTALK).get('port'))
</span><span class='line'>        
</span><span class='line'>    def notify_dingtalk(self, data):
</span><span class='line'>        timestamp = round(time.time() * 1000)
</span><span class='line'>        secret_enc = bytes(self.dingtalk_secret, encoding='utf-8')
</span><span class='line'>        string_to_sign = '{}\n{}'.format(timestamp, self.dingtalk_secret)
</span><span class='line'>        string_to_sign_enc = bytes(string_to_sign, encoding='utf-8')
</span><span class='line'>        hmac_code = hmac.new(secret_enc, string_to_sign_enc,
</span><span class='line'>                             digestmod=hashlib.sha256).digest()
</span><span class='line'>        sign = quote_plus(base64.b64encode(hmac_code))
</span><span class='line'>
</span><span class='line'>        notify_url = f"https://oapi.dingtalk.com/robot/send?access_token={self.dingtalk_token}&timestamp={timestamp}&sign={sign}"
</span><span class='line'>        try:
</span><span class='line'>            r = requests.post(notify_url, json=data)
</span><span class='line'>            reply = r.json()
</span><span class='line'>            # log.info("[DingTalk] reply={}".format(str(reply)))
</span><span class='line'>        except Exception as e:
</span><span class='line'>            log.error(e)
</span><span class='line'>
</span><span class='line'>    def handle(self, resp):
</span><span class='line'>        reply = "您好，有什么我可以帮助您解答的问题吗？"
</span><span class='line'>        prompt = resp['text']['content']
</span><span class='line'>        prompt = prompt.strip()
</span><span class='line'>        if str(prompt) != 0:
</span><span class='line'>            conversation_id = resp['conversationId']
</span><span class='line'>            sender_id = resp['senderId']
</span><span class='line'>            context = dict()
</span><span class='line'>            img_match_prefix = functions.check_prefix(
</span><span class='line'>                prompt, channel_conf_val(const.DINGTALK, 'image_create_prefix'))
</span><span class='line'>            if img_match_prefix:
</span><span class='line'>                prompt = prompt.split(img_match_prefix, 1)[1].strip()
</span><span class='line'>                context['type'] = 'IMAGE_CREATE'
</span><span class='line'>            id = sender_id
</span><span class='line'>            nick = resp['senderNick']
</span><span class='line'>            staffid = resp['senderStaffId']
</span><span class='line'>            context['from_user_id'] = str(id)
</span><span class='line'>            reply = super().build_reply_content(prompt, context)
</span><span class='line'>        if img_match_prefix and isinstance(reply, list):
</span><span class='line'>            images = ""
</span><span class='line'>            for url in reply:
</span><span class='line'>                images += f"!['IMAGE_CREATE']({url})\n"
</span><span class='line'>            reply = images
</span><span class='line'>            resp = {
</span><span class='line'>                "msgtype": "markdown",
</span><span class='line'>                "markdown": {
</span><span class='line'>                    "title": "IMAGE @" + nick + " ", 
</span><span class='line'>                    "text": images + " \n " + "@" + nick
</span><span class='line'>                },
</span><span class='line'>                "at": {
</span><span class='line'>                    "atUserIds": [
</span><span class='line'>                        staffid
</span><span class='line'>                    ],
</span><span class='line'>                    "isAtAll": False
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        else:
</span><span class='line'>            resp = {
</span><span class='line'>                "msgtype": "text",
</span><span class='line'>                "text": {
</span><span class='line'>                    "content": reply
</span><span class='line'>                },
</span><span class='line'>                "at": {
</span><span class='line'>                    "atUserIds": [
</span><span class='line'>                       staffid 
</span><span class='line'>                    ],
</span><span class='line'>                    "isAtAll": False
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        return resp 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>dd = DingTalkChannel()
</span><span class='line'>http_app = Flask(__name__,)
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>@http_app.route("/", methods=['POST'])
</span><span class='line'>def chat():
</span><span class='line'>    log.info("[DingTalk] chat_headers={}".format(str(request.headers)))
</span><span class='line'>    log.info("[DingTalk] chat={}".format(str(request.data)))
</span><span class='line'>    token = request.headers.get('token')
</span><span class='line'>    if dd.dingtalk_post_token and token != dd.dingtalk_post_token:
</span><span class='line'>        return {'ret': 203}
</span><span class='line'>    data = json.loads(request.data)
</span><span class='line'>    if data:
</span><span class='line'>        content = data['text']['content']
</span><span class='line'>        if not content:
</span><span class='line'>            return
</span><span class='line'>        reply = dd.handle(resp=data);
</span><span class='line'>        dd.notify_dingtalk(reply)
</span><span class='line'>        return {'ret': 200}
</span><span class='line'>    return {'ret': 201}
</span></code></pre></td></tr></table></div></figure>


<h2>后续</h2>

<p>增加单聊，多机器人配置</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"dingtalk": {
</span><span class='line'>  "image_create_prefix": ["画", "draw", "Draw"],
</span><span class='line'>  "port": "3000",
</span><span class='line'>  "dingtalk_token": "方式1",
</span><span class='line'>  "dingtalk_post_token": "",
</span><span class='line'>  "dingtalk_secret": "",
</span><span class='line'>  "dingtalk_robots": ["方式2-key123", "方式2-group123"],
</span><span class='line'>  "方式2-key123": {
</span><span class='line'>      "dingtalk_key": "AppKey",
</span><span class='line'>      "dingtalk_secret": "AppSecret",
</span><span class='line'>      "dingtalk_token": "webhook-access-token",
</span><span class='line'>      "dingtalk_post_token": ""
</span><span class='line'>  },
</span><span class='line'>  "方式2-group123": { 
</span><span class='line'>      "dingtalk_group": "群名",
</span><span class='line'>      "dingtalk_secret": "AppSecret",
</span><span class='line'>      "dingtalk_token": "webhook-access-token",
</span><span class='line'>      "dingtalk_post_token": ""
</span><span class='line'>  }
</span><span class='line'>},
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>源代码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># encoding:utf-8
</span><span class='line'>import json
</span><span class='line'>import hmac
</span><span class='line'>import hashlib
</span><span class='line'>import base64
</span><span class='line'>import time
</span><span class='line'>import requests
</span><span class='line'>from urllib.parse import quote_plus
</span><span class='line'>from common import log
</span><span class='line'>from flask import Flask, request, render_template, make_response
</span><span class='line'>from common import const
</span><span class='line'>from common import functions
</span><span class='line'>from config import channel_conf
</span><span class='line'>from config import channel_conf_val
</span><span class='line'>from channel.channel import Channel
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>class DingTalkHandler():
</span><span class='line'>    def __init__(self, config):
</span><span class='line'>        self.dingtalk_key = config.get('dingtalk_key')
</span><span class='line'>        self.dingtalk_secret = config.get('dingtalk_secret')
</span><span class='line'>        self.dingtalk_token = config.get('dingtalk_token')
</span><span class='line'>        self.dingtalk_post_token = config.get('dingtalk_post_token')
</span><span class='line'>        self.access_token = None
</span><span class='line'>        log.info("[DingTalk] AppKey={}, AppSecret={} Token={} post Token={}".format(self.dingtalk_key, self.dingtalk_secret, self.dingtalk_token, self.dingtalk_post_token))
</span><span class='line'>
</span><span class='line'>    def notify_dingtalk_webhook(self, data):
</span><span class='line'>        timestamp = round(time.time() * 1000)
</span><span class='line'>        secret_enc = bytes(self.dingtalk_secret, encoding='utf-8')
</span><span class='line'>        string_to_sign = '{}\n{}'.format(timestamp, self.dingtalk_secret)
</span><span class='line'>        string_to_sign_enc = bytes(string_to_sign, encoding='utf-8')
</span><span class='line'>        hmac_code = hmac.new(secret_enc, string_to_sign_enc,
</span><span class='line'>                             digestmod=hashlib.sha256).digest()
</span><span class='line'>        sign = quote_plus(base64.b64encode(hmac_code))
</span><span class='line'>
</span><span class='line'>        notify_url = f"https://oapi.dingtalk.com/robot/send?access_token={self.dingtalk_token}&timestamp={timestamp}&sign={sign}"
</span><span class='line'>        try:
</span><span class='line'>            log.info("[DingTalk] url={}".format(str(notify_url)))
</span><span class='line'>            r = requests.post(notify_url, json=data)
</span><span class='line'>            reply = r.json()
</span><span class='line'>            log.info("[DingTalk] reply={}".format(str(reply)))
</span><span class='line'>        except Exception as e:
</span><span class='line'>            log.error(e)
</span><span class='line'>
</span><span class='line'>    def get_token_internal(self):
</span><span class='line'>        access_token_url = 'https://api.dingtalk.com/v1.0/oauth2/accessToken'
</span><span class='line'>        try:
</span><span class='line'>            r = requests.post(access_token_url, json={"appKey": self.dingtalk_key, "appSecret": self.dingtalk_secret})
</span><span class='line'>        except:
</span><span class='line'>            raise Exception("DingTalk token获取失败!!!")
</span><span class='line'>
</span><span class='line'>        data = json.loads(r.content)
</span><span class='line'>        access_token = data['accessToken']
</span><span class='line'>        expire_in = data['expireIn']
</span><span class='line'>        
</span><span class='line'>        self.access_token = access_token
</span><span class='line'>        self.expire_at = int(expire_in) + time.time()
</span><span class='line'>
</span><span class='line'>        return self.access_token
</span><span class='line'>    
</span><span class='line'>    def get_token(self):
</span><span class='line'>        if self.access_token is None or self.expire_at &lt;= time.time():
</span><span class='line'>            self.get_token_internal()
</span><span class='line'>        
</span><span class='line'>        return self.access_token
</span><span class='line'>    
</span><span class='line'>    def get_post_url(self, data):
</span><span class='line'>        type = data['conversationType']
</span><span class='line'>        if type == "1":
</span><span class='line'>            return f"https://api.dingtalk.com/v1.0/robot/oToMessages/batchSend"
</span><span class='line'>        else:
</span><span class='line'>            return f"https://api.dingtalk.com/v1.0/robot/groupMessages/send"
</span><span class='line'>    
</span><span class='line'>    def build_response(self, reply, data):
</span><span class='line'>        type = data['conversationType']
</span><span class='line'>        if type == "1":
</span><span class='line'>            return self.build_oto_response(reply, data)
</span><span class='line'>        else:
</span><span class='line'>            return self.build_group_response(reply, data)
</span><span class='line'>
</span><span class='line'>    def build_oto_response(self, reply, data):
</span><span class='line'>        conversation_id = data['conversationId']
</span><span class='line'>        prompt = data['text']['content']
</span><span class='line'>        prompt = prompt.strip()
</span><span class='line'>        img_match_prefix = functions.check_prefix(
</span><span class='line'>            prompt, channel_conf_val(const.DINGTALK, 'image_create_prefix'))
</span><span class='line'>        nick = data['senderNick']
</span><span class='line'>        staffid = data['senderStaffId']
</span><span class='line'>        robotCode = data['robotCode']
</span><span class='line'>        if img_match_prefix and isinstance(reply, list):
</span><span class='line'>            images = ""
</span><span class='line'>            for url in reply:
</span><span class='line'>                images += f"!['IMAGE_CREATE']({url})\n"
</span><span class='line'>            reply = images
</span><span class='line'>            resp = {
</span><span class='line'>                "msgKey": "sampleMarkdown",
</span><span class='line'>                "msgParam": json.dumps({
</span><span class='line'>                    "title": "IMAGE @" + nick + " ", 
</span><span class='line'>                    "text": images + " \n " + "@" + nick
</span><span class='line'>                }),
</span><span class='line'>                "robotCode": robotCode,
</span><span class='line'>                "userIds": [staffid]
</span><span class='line'>            }
</span><span class='line'>        else:
</span><span class='line'>            resp = {
</span><span class='line'>                "msgKey": "sampleText",
</span><span class='line'>                "msgParam": json.dumps({
</span><span class='line'>                    "content": reply
</span><span class='line'>                }),
</span><span class='line'>                "robotCode": robotCode,
</span><span class='line'>                "userIds": [staffid]
</span><span class='line'>            }
</span><span class='line'>        return resp
</span><span class='line'>    
</span><span class='line'>    def build_group_response(self, reply, data):
</span><span class='line'>        conversation_id = data['conversationId']
</span><span class='line'>        prompt = data['text']['content']
</span><span class='line'>        prompt = prompt.strip()
</span><span class='line'>        img_match_prefix = functions.check_prefix(
</span><span class='line'>            prompt, channel_conf_val(const.DINGTALK, 'image_create_prefix'))
</span><span class='line'>        nick = data['senderNick']
</span><span class='line'>        staffid = data['senderStaffId']
</span><span class='line'>        robot_code = data['robotCode']
</span><span class='line'>        if img_match_prefix and isinstance(reply, list):
</span><span class='line'>            images = ""
</span><span class='line'>            for url in reply:
</span><span class='line'>                images += f"!['IMAGE_CREATE']({url})\n"
</span><span class='line'>            reply = images
</span><span class='line'>            resp = {
</span><span class='line'>                "msgKey": "sampleMarkdown",
</span><span class='line'>                "msgParam": json.dumps({
</span><span class='line'>                    "title": "IMAGE @" + nick + " ", 
</span><span class='line'>                    "text": images + " \n " + "@" + nick
</span><span class='line'>                }),
</span><span class='line'>                "robotCode": robot_code,
</span><span class='line'>                "openConversationId": conversation_id,
</span><span class='line'>                "at": {
</span><span class='line'>                    "atUserIds": [
</span><span class='line'>                        staffid
</span><span class='line'>                    ],
</span><span class='line'>                    "isAtAll": False
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        else:
</span><span class='line'>            resp = {
</span><span class='line'>                "msgKey": "sampleText",
</span><span class='line'>                "msgParam": json.dumps({
</span><span class='line'>                    "content": reply + " \n " + "@" + nick
</span><span class='line'>                }),
</span><span class='line'>                "robotCode": robot_code,
</span><span class='line'>                "openConversationId": conversation_id,
</span><span class='line'>                "at": {
</span><span class='line'>                    "atUserIds": [
</span><span class='line'>                       staffid 
</span><span class='line'>                    ],
</span><span class='line'>                    "isAtAll": False
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        return resp
</span><span class='line'>    
</span><span class='line'>    
</span><span class='line'>    def build_webhook_response(self, reply, data):
</span><span class='line'>        conversation_id = data['conversationId']
</span><span class='line'>        prompt = data['text']['content']
</span><span class='line'>        prompt = prompt.strip()
</span><span class='line'>        img_match_prefix = functions.check_prefix(
</span><span class='line'>            prompt, channel_conf_val(const.DINGTALK, 'image_create_prefix'))
</span><span class='line'>        nick = data['senderNick']
</span><span class='line'>        staffid = data['senderStaffId']
</span><span class='line'>        robotCode = data['robotCode']
</span><span class='line'>        if img_match_prefix and isinstance(reply, list):
</span><span class='line'>            images = ""
</span><span class='line'>            for url in reply:
</span><span class='line'>                images += f"!['IMAGE_CREATE']({url})\n"
</span><span class='line'>            reply = images
</span><span class='line'>            resp = {
</span><span class='line'>                "msgtype": "markdown",
</span><span class='line'>                "markdown": {
</span><span class='line'>                    "title": "IMAGE @" + nick + " ", 
</span><span class='line'>                    "text": images + " \n " + "@" + nick
</span><span class='line'>                },
</span><span class='line'>                "at": {
</span><span class='line'>                    "atUserIds": [
</span><span class='line'>                        staffid
</span><span class='line'>                    ],
</span><span class='line'>                    "isAtAll": False
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        else:
</span><span class='line'>            resp = {
</span><span class='line'>                "msgtype": "text",
</span><span class='line'>                "text": {
</span><span class='line'>                    "content": reply
</span><span class='line'>                },
</span><span class='line'>                "at": {
</span><span class='line'>                    "atUserIds": [
</span><span class='line'>                       staffid 
</span><span class='line'>                    ],
</span><span class='line'>                    "isAtAll": False
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        return resp
</span><span class='line'>    
</span><span class='line'>    def chat(self, channel, data):
</span><span class='line'>        reply = channel.handle(data)
</span><span class='line'>        type = data['conversationType']
</span><span class='line'>        if type == "1":
</span><span class='line'>            reply_json = self.build_response(reply, data)
</span><span class='line'>            self.notify_dingtalk(data, reply_json)
</span><span class='line'>        else:
</span><span class='line'>            # group的不清楚怎么@，先用webhook调用
</span><span class='line'>            reply_json = self.build_webhook_response(reply, data)
</span><span class='line'>            self.notify_dingtalk_webhook(reply_json)
</span><span class='line'>        
</span><span class='line'>
</span><span class='line'>    def notify_dingtalk(self, data, reply_json):
</span><span class='line'>        headers = {
</span><span class='line'>            'content-type': 'application/json', 
</span><span class='line'>            'x-acs-dingtalk-access-token': self.get_token()
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        notify_url = self.get_post_url(data)
</span><span class='line'>        try:
</span><span class='line'>            r = requests.post(notify_url, json=reply_json, headers=headers)
</span><span class='line'>            resp = r.json()
</span><span class='line'>            log.info("[DingTalk] response={}".format(str(resp)))
</span><span class='line'>        except Exception as e:
</span><span class='line'>            log.error(e)
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>class DingTalkChannel(Channel):
</span><span class='line'>    def __init__(self):
</span><span class='line'>        log.info("[DingTalk] started.")
</span><span class='line'>
</span><span class='line'>    def startup(self):
</span><span class='line'>        http_app.run(host='0.0.0.0', port=channel_conf(const.DINGTALK).get('port'))
</span><span class='line'>
</span><span class='line'>    def handle(self, data):
</span><span class='line'>        reply = "您好，有什么我可以帮助您解答的问题吗？"
</span><span class='line'>        prompt = data['text']['content']
</span><span class='line'>        prompt = prompt.strip()
</span><span class='line'>        if str(prompt) != 0:
</span><span class='line'>            conversation_id = data['conversationId']
</span><span class='line'>            sender_id = data['senderId']
</span><span class='line'>            context = dict()
</span><span class='line'>            img_match_prefix = functions.check_prefix(
</span><span class='line'>                prompt, channel_conf_val(const.DINGTALK, 'image_create_prefix'))
</span><span class='line'>            if img_match_prefix:
</span><span class='line'>                prompt = prompt.split(img_match_prefix, 1)[1].strip()
</span><span class='line'>                context['type'] = 'IMAGE_CREATE'
</span><span class='line'>            id = sender_id
</span><span class='line'>            context['from_user_id'] = str(id)
</span><span class='line'>            reply = super().build_reply_content(prompt, context)
</span><span class='line'>        return reply
</span><span class='line'>         
</span><span class='line'>
</span><span class='line'>dd = DingTalkChannel()
</span><span class='line'>handlers = dict()
</span><span class='line'>robots = channel_conf(const.DINGTALK).get('dingtalk_robots')
</span><span class='line'>if robots and len(robots) &gt; 0:
</span><span class='line'>    for robot in robots:
</span><span class='line'>        robot_config = channel_conf(const.DINGTALK).get(robot)
</span><span class='line'>        robot_key = robot_config.get('dingtalk_key')
</span><span class='line'>        group_name = robot_config.get('dingtalk_group')
</span><span class='line'>        handlers[group_name or robot_key] = DingTalkHandler(robot_config)
</span><span class='line'>else:
</span><span class='line'>    handlers['DEFAULT'] = DingTalkHandler(channel_conf(const.DINGTALK))
</span><span class='line'>http_app = Flask(__name__,)
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>@http_app.route("/", methods=['POST'])
</span><span class='line'>def chat():
</span><span class='line'>    log.info("[DingTalk] chat_headers={}".format(str(request.headers)))
</span><span class='line'>    log.info("[DingTalk] chat={}".format(str(request.data)))
</span><span class='line'>    token = request.headers.get('token')
</span><span class='line'>    data = json.loads(request.data)
</span><span class='line'>    if data:
</span><span class='line'>        content = data['text']['content']
</span><span class='line'>        if not content:
</span><span class='line'>            return
</span><span class='line'>        code = data['robotCode']
</span><span class='line'>        group_name = None
</span><span class='line'>        if 'conversationTitle' in data:
</span><span class='line'>            group_name = data['conversationTitle']
</span><span class='line'>        handler = handlers.get(group_name, handlers.get(code, handlers.get('DEFAULT')))
</span><span class='line'>        if handler.dingtalk_post_token and token != handler.dingtalk_post_token:
</span><span class='line'>            return {'ret': 203}
</span><span class='line'>        handler.chat(dd, data)
</span><span class='line'>        return {'ret': 200}
</span><span class='line'>    
</span><span class='line'>    return {'ret': 201}
</span><span class='line'>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/03/26/clash-on-raspberry4/">树莓派4安装Clash</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2023-03-26T00:31:01+08:00" pubdate data-updated="true">Sun 2023-03-26 00:31</time>
		
        
		
      </p>
    
  </header>



  <div class="entry-content"><h2>安装Clash</h2>

<p>参考：<a href="https://mraddict.top/posts/clash-on-rpi/">https://mraddict.top/posts/clash-on-rpi/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@ubuntu:~# arch
</span><span class='line'>
</span><span class='line'># 下载上传clash
</span><span class='line'>root@ubuntu:~# mv clash-linux-arm64 /usr/local/bin/
</span><span class='line'>
</span><span class='line'>root@ubuntu:~# cd /usr/local/bin/
</span><span class='line'>root@ubuntu:/usr/local/bin# chmod +x clash-linux-arm64 
</span><span class='line'>root@ubuntu:/usr/local/bin# ln -s clash-linux-arm64 clash
</span><span class='line'>root@ubuntu:/usr/local/bin# ls clash*
</span><span class='line'>clash  clash-linux-arm64
</span><span class='line'>root@ubuntu:/usr/local/bin# ls -l clash*
</span><span class='line'>lrwxrwxrwx 1 root root      17 Mar 24 21:43 clash -&gt; clash-linux-arm64
</span><span class='line'>-rwxr-xr-x 1 root root 8978432 Jan 29 18:59 clash-linux-arm64
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 启动一次，会生成配置和下载Country.mmdb文件：
</span><span class='line'>root@ubuntu:/usr/local/bin# clash
</span><span class='line'>INFO[0000] Can't find config, create a initial config file 
</span><span class='line'>INFO[0000] Can't find MMDB, start download              
</span><span class='line'>INFO[0344] Mixed(http+socks) proxy listening at: 127.0.0.1:7890 
</span><span class='line'>
</span><span class='line'># clash-ui
</span><span class='line'>root@ubuntu:/usr/local/bin# cd ~/.config/clash
</span><span class='line'>root@ubuntu:~/.config/clash# git clone --branch gh-pages https://github.com/Dreamacro/clash-dashboard.git    
</span><span class='line'>Cloning into 'clash-dashboard'...
</span><span class='line'>remote: Enumerating objects: 3951, done.
</span><span class='line'>remote: Counting objects: 100% (232/232), done.
</span><span class='line'>remote: Compressing objects: 100% (172/172), done.
</span><span class='line'>remote: Total 3951 (delta 79), reused 189 (delta 56), pack-reused 3719
</span><span class='line'>Receiving objects: 100% (3951/3951), 4.87 MiB | 21.00 KiB/s, done.
</span><span class='line'>Resolving deltas: 100% (2240/2240), done.
</span></code></pre></td></tr></table></div></figure>


<p>配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## 配置文件：https://github.com/Dreamacro/clash/wiki/Configuration#introduction
</span><span class='line'>## 下载服务提供的订阅地址内容，保存到文件。
</span><span class='line'>
</span><span class='line'>root@ubuntu:~/.config/clash# ln -s Clash_1679667989.yaml config.yaml
</span><span class='line'>root@ubuntu:~/.config/clash# vi config.yaml 
</span><span class='line'>  11 mode: rule
</span><span class='line'>  12 log-level: debug
</span><span class='line'>  13 external-ui: clash-dashboard
</span><span class='line'>  14 external-controller: '0.0.0.0:9090'
</span><span class='line'>  
</span><span class='line'>
</span><span class='line'>root@ubuntu:~/.config/clash# clash
</span><span class='line'>INFO[0000] Start initial compatible provider 🎬哔哩哔哩      
</span><span class='line'>INFO[0000] Start initial compatible provider ⚓️其他流量     
</span><span class='line'>INFO[0000] Start initial compatible provider ✈️Telegram 
</span><span class='line'>INFO[0000] Start initial compatible provider 🎬Netflix   
</span><span class='line'>INFO[0000] Start initial compatible provider 🍎苹果服务      
</span><span class='line'>INFO[0000] Start initial compatible provider 🎬Youtube   
</span><span class='line'>INFO[0000] Start initial compatible provider 🎬国外媒体      
</span><span class='line'>INFO[0000] Start initial compatible provider 🚀直接连接      
</span><span class='line'>INFO[0000] Start initial compatible provider 🔰国外流量      
</span><span class='line'>INFO[0000] Start initial compatible provider Ⓜ️ 微软服务    
</span><span class='line'>INFO[0000] HTTP proxy listening at: 127.0.0.1:7890      
</span><span class='line'>INFO[0000] RESTful API listening at: [::]:9090          
</span><span class='line'>INFO[0000] SOCKS proxy listening at: 127.0.0.1:7891     
</span><span class='line'>INFO[0000] Redirect proxy listening at: 127.0.0.1:7892 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 打开 http://192.168.123.41:9090/ui/#/settings 页面后，添加一下服务器的ip地址，就可以访问了。
</span></code></pre></td></tr></table></div></figure>


<h2>安装conda</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 用代理下载后面的数据
</span><span class='line'>root@ubuntu:~# export http_proxy="http://127.0.0.1:7890"
</span><span class='line'>root@ubuntu:~# export https_proxy="http://127.0.0.1:7890"
</span><span class='line'>
</span><span class='line'>root@ubuntu:~# wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-aarch64.sh     
</span><span class='line'>--2023-03-24 23:16:35--  https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-aarch64.sh
</span><span class='line'>Connecting to 127.0.0.1:7890... connected.
</span><span class='line'>Proxy request sent, awaiting response... 302 Found
</span><span class='line'>Location: https://github.com/conda-forge/miniforge/releases/download/22.11.1-4/Miniforge3-Linux-aarch64.sh [following]
</span><span class='line'>--2023-03-24 23:16:35--  https://github.com/conda-forge/miniforge/releases/download/22.11.1-4/Miniforge3-Linux-aarch64.sh
</span><span class='line'>Reusing existing connection to github.com:443.
</span><span class='line'>Proxy request sent, awaiting response... 302 Found
</span><span class='line'>Location: https://objects.githubusercontent.com/github-production-release-asset-2e65be/221584272/97169057-ca90-4fce-873e-a7d6d2e1db90?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20230324%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230324T151635Z&X-Amz-Expires=300&X-Amz-Signature=c46561816462b1e2bcd82d8b99f8ce840f4ff9b6214fda083828079783d43f0f&X-Amz-SignedHeaders=host&actor_id=0&key_id=0&repo_id=221584272&response-content-disposition=attachment%3B%20filename%3DMiniforge3-Linux-aarch64.sh&response-content-type=application%2Foctet-stream [following]
</span><span class='line'>--2023-03-24 23:16:36--  https://objects.githubusercontent.com/github-production-release-asset-2e65be/221584272/97169057-ca90-4fce-873e-a7d6d2e1db90?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20230324%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230324T151635Z&X-Amz-Expires=300&X-Amz-Signature=c46561816462b1e2bcd82d8b99f8ce840f4ff9b6214fda083828079783d43f0f&X-Amz-SignedHeaders=host&actor_id=0&key_id=0&repo_id=221584272&response-content-disposition=attachment%3B%20filename%3DMiniforge3-Linux-aarch64.sh&response-content-type=application%2Foctet-stream
</span><span class='line'>Connecting to 127.0.0.1:7890... connected.
</span><span class='line'>Proxy request sent, awaiting response... 200 OK
</span><span class='line'>Length: 53550114 (51M) [application/octet-stream]
</span><span class='line'>Saving to: ‘Miniforge3-Linux-aarch64.sh.1’
</span><span class='line'>
</span><span class='line'>Miniforge3-Linux-aarch64.sh.1                    1%[&gt;                                                                                                  ] 752.00K  9.01KB/s    in 74s     
</span><span class='line'>
</span><span class='line'>2023-03-24 23:17:51 (10.2 KB/s) - Connection closed at byte 770048. Retrying.
</span><span class='line'>
</span><span class='line'>## 默认用的是direct，没有翻墙。在9090/ui页面先把原来的[连接]停掉，然后把[代理]切换到香港的节点
</span><span class='line'>
</span><span class='line'>--2023-03-24 23:17:52--  (try: 2)  https://objects.githubusercontent.com/github-production-release-asset-2e65be/221584272/97169057-ca90-4fce-873e-a7d6d2e1db90?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20230324%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230324T151635Z&X-Amz-Expires=300&X-Amz-Signature=c46561816462b1e2bcd82d8b99f8ce840f4ff9b6214fda083828079783d43f0f&X-Amz-SignedHeaders=host&actor_id=0&key_id=0&repo_id=221584272&response-content-disposition=attachment%3B%20filename%3DMiniforge3-Linux-aarch64.sh&response-content-type=application%2Foctet-stream
</span><span class='line'>Connecting to 127.0.0.1:7890... connected.
</span><span class='line'>Proxy request sent, awaiting response... 206 Partial Content
</span><span class='line'>Length: 53550114 (51M), 52780066 (50M) remaining [application/octet-stream]
</span><span class='line'>Saving to: ‘Miniforge3-Linux-aarch64.sh.1’
</span><span class='line'>
</span><span class='line'>Miniforge3-Linux-aarch64.sh.1                  100%[+=================================================================================================&gt;]  51.07M  2.79MB/s    in 21s     
</span><span class='line'>
</span><span class='line'>2023-03-24 23:18:14 (2.39 MB/s) - ‘Miniforge3-Linux-aarch64.sh.1’ saved [53550114/53550114]
</span><span class='line'>
</span><span class='line'>root@ubuntu:~# 
</span><span class='line'>
</span><span class='line'>root@ubuntu:~# rm -rf Miniforge3-Linux-aarch64.sh
</span><span class='line'>root@ubuntu:~# mv Miniforge3-Linux-aarch64.sh.1 Miniforge3-Linux-aarch64.sh
</span><span class='line'>root@ubuntu:~# chmod +x Miniforge3-Linux-aarch64.sh
</span><span class='line'>
</span><span class='line'>root@ubuntu:~# rm -rf /usr/local/miniforge3
</span><span class='line'>root@ubuntu:~# ./Miniforge3-Linux-aarch64.sh 
</span><span class='line'>
</span><span class='line'>Welcome to Miniforge3 22.11.1-4
</span><span class='line'>
</span><span class='line'>In order to continue the installation process, please review the license
</span><span class='line'>agreement.
</span><span class='line'>Please, press ENTER to continue
</span><span class='line'>&gt;&gt;&gt;  
</span><span class='line'>Miniforge installer code uses BSD-3-Clause license as stated below.
</span><span class='line'>
</span><span class='line'>Binary packages that come with it have their own licensing terms
</span><span class='line'>and by installing miniforge you agree to the licensing terms of individual
</span><span class='line'>packages as well. They include different OSI-approved licenses including
</span><span class='line'>the GNU General Public License and can be found in pkgs/&lt;pkg-name&gt;/info/licenses
</span><span class='line'>folders.
</span><span class='line'>
</span><span class='line'>Miniforge installer comes with a boostrapping executable that is used
</span><span class='line'>when installing miniforge and is deleted after miniforge is installed.
</span><span class='line'>The bootstrapping executable uses micromamba, cli11, cpp-filesystem,
</span><span class='line'>curl, c-ares, krb5, libarchive, libev, lz4, nghttp2, openssl, libsolv,
</span><span class='line'>nlohmann-json, reproc and zstd which are licensed under BSD-3-Clause,
</span><span class='line'>MIT and OpenSSL licenses. Licenses and copyright notices of these
</span><span class='line'>projects can be found at the following URL.
</span><span class='line'>https://github.com/conda-forge/micromamba-feedstock/tree/master/recipe.
</span><span class='line'>
</span><span class='line'>=============================================================================
</span><span class='line'>
</span><span class='line'>Copyright (c) 2019-2022, conda-forge
</span><span class='line'>All rights reserved.
</span><span class='line'>
</span><span class='line'>Redistribution and use in source and binary forms, with or without
</span><span class='line'>modification, are permitted provided that the following conditions are met:
</span><span class='line'>
</span><span class='line'>1. Redistributions of source code must retain the above copyright notice, this
</span><span class='line'>list of conditions and the following disclaimer.
</span><span class='line'>
</span><span class='line'>2. Redistributions in binary form must reproduce the above copyright notice,
</span><span class='line'>this list of conditions and the following disclaimer in the documentation
</span><span class='line'>and/or other materials provided with the distribution.
</span><span class='line'>
</span><span class='line'>3. Neither the name of the copyright holder nor the names of its contributors
</span><span class='line'>may be used to endorse or promote products derived from this software without
</span><span class='line'>specific prior written permission.
</span><span class='line'>
</span><span class='line'>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
</span><span class='line'>ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
</span><span class='line'>WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
</span><span class='line'>DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
</span><span class='line'>FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
</span><span class='line'>DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
</span><span class='line'>SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
</span><span class='line'>CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
</span><span class='line'>OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
</span><span class='line'>OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Do you accept the license terms? [yes|no]
</span><span class='line'>[no] &gt;&gt;&gt; yes
</span><span class='line'>
</span><span class='line'>Miniforge3 will now be installed into this location:
</span><span class='line'>/root/miniforge3
</span><span class='line'>
</span><span class='line'>  - Press ENTER to confirm the location
</span><span class='line'>  - Press CTRL-C to abort the installation
</span><span class='line'>  - Or specify a different location below
</span><span class='line'>
</span><span class='line'>[/root/miniforge3] &gt;&gt;&gt; /usr/local/miniforge3   
</span><span class='line'>PREFIX=/usr/local/miniforge3
</span><span class='line'>Unpacking payload ...
</span><span class='line'>Extracting ca-certificates-2022.12.7-h4fd8a4c_0.conda
</span><span class='line'>Extracting ld_impl_linux-aarch64-2.40-h2d8c526_0.conda
</span><span class='line'>Extracting libgomp-12.2.0-h607ecd0_19.tar.bz2
</span><span class='line'>Extracting libstdcxx-ng-12.2.0-hc13a102_19.tar.bz2
</span><span class='line'>Extracting python_abi-3.10-3_cp310.conda
</span><span class='line'>Extracting tzdata-2022g-h191b570_0.conda
</span><span class='line'>Extracting _openmp_mutex-4.5-2_gnu.tar.bz2
</span><span class='line'>Extracting libgcc-ng-12.2.0-h607ecd0_19.tar.bz2
</span><span class='line'>Extracting bzip2-1.0.8-hf897c2e_4.tar.bz2
</span><span class='line'>Extracting libffi-3.4.2-h3557bc0_5.tar.bz2
</span><span class='line'>Extracting libnsl-2.0.0-hf897c2e_0.tar.bz2
</span><span class='line'>Extracting libuuid-2.32.1-hf897c2e_1000.tar.bz2
</span><span class='line'>Extracting libzlib-1.2.13-h4e544f5_4.tar.bz2
</span><span class='line'>Extracting ncurses-6.3-headf329_1.tar.bz2
</span><span class='line'>Extracting openssl-3.0.8-hb4cce97_0.conda
</span><span class='line'>Extracting xz-5.2.6-h9cdd2b7_0.tar.bz2
</span><span class='line'>Extracting libsqlite-3.40.0-hf9034f9_0.tar.bz2
</span><span class='line'>Extracting readline-8.1.2-h38e3740_0.tar.bz2
</span><span class='line'>Extracting tk-8.6.12-hd8af866_0.tar.bz2
</span><span class='line'>Extracting zstd-1.5.2-h44f6412_6.conda
</span><span class='line'>Extracting python-3.10.9-ha43d526_0_cpython.conda
</span><span class='line'>Extracting certifi-2022.12.7-pyhd8ed1ab_0.conda
</span><span class='line'>Extracting charset-normalizer-2.1.1-pyhd8ed1ab_0.tar.bz2
</span><span class='line'>Extracting colorama-0.4.6-pyhd8ed1ab_0.tar.bz2
</span><span class='line'>Extracting idna-3.4-pyhd8ed1ab_0.tar.bz2
</span><span class='line'>Extracting pluggy-1.0.0-pyhd8ed1ab_5.tar.bz2
</span><span class='line'>Extracting pycosat-0.6.4-py310h761cc84_1.tar.bz2
</span><span class='line'>Extracting pycparser-2.21-pyhd8ed1ab_0.tar.bz2
</span><span class='line'>Extracting pysocks-1.7.1-pyha2e5f31_6.tar.bz2
</span><span class='line'>Extracting ruamel.yaml.clib-0.2.7-py310hb89b984_1.conda
</span><span class='line'>Extracting setuptools-65.6.3-pyhd8ed1ab_0.conda
</span><span class='line'>Extracting toolz-0.12.0-pyhd8ed1ab_0.tar.bz2
</span><span class='line'>Extracting wheel-0.38.4-pyhd8ed1ab_0.tar.bz2
</span><span class='line'>Extracting cffi-1.15.1-py310hf0c4615_3.conda
</span><span class='line'>Extracting pip-23.0-pyhd8ed1ab_0.conda
</span><span class='line'>Extracting ruamel.yaml-0.17.21-py310h761cc84_2.tar.bz2
</span><span class='line'>Extracting tqdm-4.64.1-pyhd8ed1ab_0.tar.bz2
</span><span class='line'>Extracting brotlipy-0.7.0-py310h761cc84_1005.tar.bz2
</span><span class='line'>Extracting cryptography-39.0.1-py310he4ba0b1_0.conda
</span><span class='line'>Extracting zstandard-0.19.0-py310hde4b81c_1.conda
</span><span class='line'>Extracting conda-package-streaming-0.7.0-pyhd8ed1ab_1.conda
</span><span class='line'>Extracting pyopenssl-23.0.0-pyhd8ed1ab_0.conda
</span><span class='line'>Extracting conda-package-handling-2.0.2-pyh38be061_0.conda
</span><span class='line'>Extracting urllib3-1.26.14-pyhd8ed1ab_0.conda
</span><span class='line'>Extracting requests-2.28.2-pyhd8ed1ab_0.conda
</span><span class='line'>Extracting conda-22.11.1-py310h4c7bcd0_1.conda
</span><span class='line'>
</span><span class='line'>Installing base environment...
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                                           __
</span><span class='line'>          __  ______ ___  ____ _____ ___  / /_  ____ _
</span><span class='line'>         / / / / __ `__ \/ __ `/ __ `__ \/ __ \/ __ `/
</span><span class='line'>        / /_/ / / / / / / /_/ / / / / / / /_/ / /_/ /
</span><span class='line'>       / .___/_/ /_/ /_/\__,_/_/ /_/ /_/_.___/\__,_/
</span><span class='line'>      /_/
</span><span class='line'>
</span><span class='line'>Transaction
</span><span class='line'>
</span><span class='line'>  Prefix: /usr/local/miniforge3
</span><span class='line'>
</span><span class='line'>  Updating specs:
</span><span class='line'>
</span><span class='line'>   - conda-forge/linux-aarch64::ca-certificates==2022.12.7=h4fd8a4c_0[md5=2450fbcaf65634e0d071e47e2b8487b4]
</span><span class='line'>   - conda-forge/linux-aarch64::ld_impl_linux-aarch64==2.40=h2d8c526_0[md5=16246d69e945d0b1969a6099e7c5d457]
</span><span class='line'>   - conda-forge/linux-aarch64::libgomp==12.2.0=h607ecd0_19[md5=65b9cb876525dcb2e74a90cf02c6762a]
</span><span class='line'>   - conda-forge/linux-aarch64::libstdcxx-ng==12.2.0=hc13a102_19[md5=981741cd4321edd5c504b48f74fe91f2]
</span><span class='line'>   - conda-forge/linux-aarch64::python_abi==3.10=3_cp310[md5=7f4f00b03d3a7c4d4b8b987e5da461a9]
</span><span class='line'>   - conda-forge/noarch::tzdata==2022g=h191b570_0[md5=51fc4fcfb19f5d95ffc8c339db5068e8]
</span><span class='line'>   - conda-forge/linux-aarch64::_openmp_mutex==4.5=2_gnu[md5=6168d71addc746e8f2b8d57dfd2edcea]
</span><span class='line'>   - conda-forge/linux-aarch64::libgcc-ng==12.2.0=h607ecd0_19[md5=8456a29b6d9fc3123ccb9a966b6b2c49]
</span><span class='line'>   - conda-forge/linux-aarch64::bzip2==1.0.8=hf897c2e_4[md5=2d787570a729e273a4e75775ddf3348a]
</span><span class='line'>   - conda-forge/linux-aarch64::libffi==3.4.2=h3557bc0_5[md5=dddd85f4d52121fab0a8b099c5e06501]
</span><span class='line'>   - conda-forge/linux-aarch64::libnsl==2.0.0=hf897c2e_0[md5=36fdbc05c9d9145ece86f5a63c3f352e]
</span><span class='line'>   - conda-forge/linux-aarch64::libuuid==2.32.1=hf897c2e_1000[md5=e038da5ef9095b0d79aac14a311394e7]
</span><span class='line'>   - conda-forge/linux-aarch64::libzlib==1.2.13=h4e544f5_4[md5=88596b6277fe6d39f046983aae6044db]
</span><span class='line'>   - conda-forge/linux-aarch64::ncurses==6.3=headf329_1[md5=486b68148e121bc8bbadc3cefae4c04f]
</span><span class='line'>   - conda-forge/linux-aarch64::openssl==3.0.8=hb4cce97_0[md5=268fe30a14a3f40fe54da04fc053fd2d]
</span><span class='line'>   - conda-forge/linux-aarch64::xz==5.2.6=h9cdd2b7_0[md5=83baad393a31d59c20b63ba4da6592df]
</span><span class='line'>   - conda-forge/linux-aarch64::libsqlite==3.40.0=hf9034f9_0[md5=9afb0d5dbaa403858a660cd0b4a31d29]
</span><span class='line'>   - conda-forge/linux-aarch64::readline==8.1.2=h38e3740_0[md5=3cdbfb7d7b63ae2c2d35bb167d257ecd]
</span><span class='line'>   - conda-forge/linux-aarch64::tk==8.6.12=hd8af866_0[md5=7894e82ff743bd96c76585ddebe28e2a]
</span><span class='line'>   - conda-forge/linux-aarch64::zstd==1.5.2=h44f6412_6[md5=6d0d1cd6d184129eabb96bb220afb5b2]
</span><span class='line'>   - conda-forge/linux-aarch64::python==3.10.9=ha43d526_0_cpython[md5=24478dd738f2d557efe2a4fc6a248eb3]
</span><span class='line'>   - conda-forge/noarch::certifi==2022.12.7=pyhd8ed1ab_0[md5=fb9addc3db06e56abe03e0e9f21a63e6]
</span><span class='line'>   - conda-forge/noarch::charset-normalizer==2.1.1=pyhd8ed1ab_0[md5=c1d5b294fbf9a795dec349a6f4d8be8e]
</span><span class='line'>   - conda-forge/noarch::colorama==0.4.6=pyhd8ed1ab_0[md5=3faab06a954c2a04039983f2c4a50d99]
</span><span class='line'>   - conda-forge/noarch::idna==3.4=pyhd8ed1ab_0[md5=34272b248891bddccc64479f9a7fffed]
</span><span class='line'>   - conda-forge/noarch::pluggy==1.0.0=pyhd8ed1ab_5[md5=7d301a0d25f424d96175f810935f0da9]
</span><span class='line'>   - conda-forge/linux-aarch64::pycosat==0.6.4=py310h761cc84_1[md5=c701cff6d6e7907c93ab603e58082a7c]
</span><span class='line'>   - conda-forge/noarch::pycparser==2.21=pyhd8ed1ab_0[md5=076becd9e05608f8dc72757d5f3a91ff]
</span><span class='line'>   - conda-forge/noarch::pysocks==1.7.1=pyha2e5f31_6[md5=2a7de29fb590ca14b5243c4c812c8025]
</span><span class='line'>   - conda-forge/linux-aarch64::ruamel.yaml.clib==0.2.7=py310hb89b984_1[md5=89972c78c36ed3261c22bde7c012be03]
</span><span class='line'>   - conda-forge/noarch::setuptools==65.6.3=pyhd8ed1ab_0[md5=9600fc9524d3f821e6a6d58c52f5bf5a]
</span><span class='line'>   - conda-forge/noarch::toolz==0.12.0=pyhd8ed1ab_0[md5=92facfec94bc02d6ccf42e7173831a36]
</span><span class='line'>   - conda-forge/noarch::wheel==0.38.4=pyhd8ed1ab_0[md5=c829cfb8cb826acb9de0ac1a2df0a940]
</span><span class='line'>   - conda-forge/linux-aarch64::cffi==1.15.1=py310hf0c4615_3[md5=a2bedcb1d205485ea32fe5d2bd6fd970]
</span><span class='line'>   - conda-forge/noarch::pip==23.0=pyhd8ed1ab_0[md5=85b35999162ec95f9f999bac15279c02]
</span><span class='line'>   - conda-forge/linux-aarch64::ruamel.yaml==0.17.21=py310h761cc84_2[md5=98c0b13f20fcb4f5080554d137e39b37]
</span><span class='line'>   - conda-forge/noarch::tqdm==4.64.1=pyhd8ed1ab_0[md5=5526ff3f88f9db87bb0924b9ce575345]
</span><span class='line'>   - conda-forge/linux-aarch64::brotlipy==0.7.0=py310h761cc84_1005[md5=66934993368d01f896652925d3ac7e66]
</span><span class='line'>   - conda-forge/linux-aarch64::cryptography==39.0.1=py310he4ba0b1_0[md5=3129345d217e5fd6488df794e49e327b]
</span><span class='line'>   - conda-forge/linux-aarch64::zstandard==0.19.0=py310hde4b81c_1[md5=d4b3cc980179c38949c83fe23057d97c]
</span><span class='line'>   - conda-forge/noarch::conda-package-streaming==0.7.0=pyhd8ed1ab_1[md5=1a2fa9e53cfbc2e4d9ab21990805a436]
</span><span class='line'>   - conda-forge/noarch::pyopenssl==23.0.0=pyhd8ed1ab_0[md5=d41957700e83bbb925928764cb7f8878]
</span><span class='line'>   - conda-forge/noarch::conda-package-handling==2.0.2=pyh38be061_0[md5=44800e9bd13143292097c65e57323038]
</span><span class='line'>   - conda-forge/noarch::urllib3==1.26.14=pyhd8ed1ab_0[md5=01f33ad2e0aaf6b5ba4add50dad5ad29]
</span><span class='line'>   - conda-forge/noarch::requests==2.28.2=pyhd8ed1ab_0[md5=11d178fc55199482ee48d6812ea83983]
</span><span class='line'>   - conda-forge/linux-aarch64::conda==22.11.1=py310h4c7bcd0_1[md5=a71c4cc6bd77f61c0c1601b28291c460]
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  Package                      Version  Build               Channel           Size
</span><span class='line'>────────────────────────────────────────────────────────────────────────────────────
</span><span class='line'>  Install:
</span><span class='line'>────────────────────────────────────────────────────────────────────────────────────
</span><span class='line'>
</span><span class='line'>  + _openmp_mutex                  4.5  2_gnu               conda-forge     Cached
</span><span class='line'>  + brotlipy                     0.7.0  py310h761cc84_1005  conda-forge     Cached
</span><span class='line'>  + bzip2                        1.0.8  hf897c2e_4          conda-forge     Cached
</span><span class='line'>  + ca-certificates          2022.12.7  h4fd8a4c_0          conda-forge     Cached
</span><span class='line'>  + certifi                  2022.12.7  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + cffi                        1.15.1  py310hf0c4615_3     conda-forge     Cached
</span><span class='line'>  + charset-normalizer           2.1.1  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + colorama                     0.4.6  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + conda                      22.11.1  py310h4c7bcd0_1     conda-forge     Cached
</span><span class='line'>  + conda-package-handling       2.0.2  pyh38be061_0        conda-forge     Cached
</span><span class='line'>  + conda-package-streaming      0.7.0  pyhd8ed1ab_1        conda-forge     Cached
</span><span class='line'>  + cryptography                39.0.1  py310he4ba0b1_0     conda-forge     Cached
</span><span class='line'>  + idna                           3.4  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + ld_impl_linux-aarch64         2.40  h2d8c526_0          conda-forge     Cached
</span><span class='line'>  + libffi                       3.4.2  h3557bc0_5          conda-forge     Cached
</span><span class='line'>  + libgcc-ng                   12.2.0  h607ecd0_19         conda-forge     Cached
</span><span class='line'>  + libgomp                     12.2.0  h607ecd0_19         conda-forge     Cached
</span><span class='line'>  + libnsl                       2.0.0  hf897c2e_0          conda-forge     Cached
</span><span class='line'>  + libsqlite                   3.40.0  hf9034f9_0          conda-forge     Cached
</span><span class='line'>  + libstdcxx-ng                12.2.0  hc13a102_19         conda-forge     Cached
</span><span class='line'>  + libuuid                     2.32.1  hf897c2e_1000       conda-forge     Cached
</span><span class='line'>  + libzlib                     1.2.13  h4e544f5_4          conda-forge     Cached
</span><span class='line'>  + ncurses                        6.3  headf329_1          conda-forge     Cached
</span><span class='line'>  + openssl                      3.0.8  hb4cce97_0          conda-forge     Cached
</span><span class='line'>  + pip                           23.0  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + pluggy                       1.0.0  pyhd8ed1ab_5        conda-forge     Cached
</span><span class='line'>  + pycosat                      0.6.4  py310h761cc84_1     conda-forge     Cached
</span><span class='line'>  + pycparser                     2.21  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + pyopenssl                   23.0.0  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + pysocks                      1.7.1  pyha2e5f31_6        conda-forge     Cached
</span><span class='line'>  + python                      3.10.9  ha43d526_0_cpython  conda-forge     Cached
</span><span class='line'>  + python_abi                    3.10  3_cp310             conda-forge     Cached
</span><span class='line'>  + readline                     8.1.2  h38e3740_0          conda-forge     Cached
</span><span class='line'>  + requests                    2.28.2  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + ruamel.yaml                0.17.21  py310h761cc84_2     conda-forge     Cached
</span><span class='line'>  + ruamel.yaml.clib             0.2.7  py310hb89b984_1     conda-forge     Cached
</span><span class='line'>  + setuptools                  65.6.3  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + tk                          8.6.12  hd8af866_0          conda-forge     Cached
</span><span class='line'>  + toolz                       0.12.0  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + tqdm                        4.64.1  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + tzdata                       2022g  h191b570_0          conda-forge     Cached
</span><span class='line'>  + urllib3                    1.26.14  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + wheel                       0.38.4  pyhd8ed1ab_0        conda-forge     Cached
</span><span class='line'>  + xz                           5.2.6  h9cdd2b7_0          conda-forge     Cached
</span><span class='line'>  + zstandard                   0.19.0  py310hde4b81c_1     conda-forge     Cached
</span><span class='line'>  + zstd                         1.5.2  h44f6412_6          conda-forge     Cached
</span><span class='line'>
</span><span class='line'>  Summary:
</span><span class='line'>
</span><span class='line'>  Install: 46 packages
</span><span class='line'>
</span><span class='line'>  Total download: 0 B
</span><span class='line'>
</span><span class='line'>────────────────────────────────────────────────────────────────────────────────────
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Transaction starting
</span><span class='line'>Linking ca-certificates-2022.12.7-h4fd8a4c_0
</span><span class='line'>Linking ld_impl_linux-aarch64-2.40-h2d8c526_0
</span><span class='line'>Linking libgomp-12.2.0-h607ecd0_19
</span><span class='line'>Linking libstdcxx-ng-12.2.0-hc13a102_19
</span><span class='line'>Linking python_abi-3.10-3_cp310
</span><span class='line'>Linking tzdata-2022g-h191b570_0
</span><span class='line'>Linking _openmp_mutex-4.5-2_gnu
</span><span class='line'>Linking libgcc-ng-12.2.0-h607ecd0_19
</span><span class='line'>Linking bzip2-1.0.8-hf897c2e_4
</span><span class='line'>Linking libffi-3.4.2-h3557bc0_5
</span><span class='line'>Linking libnsl-2.0.0-hf897c2e_0
</span><span class='line'>Linking libuuid-2.32.1-hf897c2e_1000
</span><span class='line'>Linking libzlib-1.2.13-h4e544f5_4
</span><span class='line'>Linking ncurses-6.3-headf329_1
</span><span class='line'>Linking openssl-3.0.8-hb4cce97_0
</span><span class='line'>Linking xz-5.2.6-h9cdd2b7_0
</span><span class='line'>Linking libsqlite-3.40.0-hf9034f9_0
</span><span class='line'>Linking readline-8.1.2-h38e3740_0
</span><span class='line'>Linking tk-8.6.12-hd8af866_0
</span><span class='line'>Linking zstd-1.5.2-h44f6412_6
</span><span class='line'>Linking python-3.10.9-ha43d526_0_cpython
</span><span class='line'>Linking certifi-2022.12.7-pyhd8ed1ab_0
</span><span class='line'>Linking charset-normalizer-2.1.1-pyhd8ed1ab_0
</span><span class='line'>Linking colorama-0.4.6-pyhd8ed1ab_0
</span><span class='line'>Linking idna-3.4-pyhd8ed1ab_0
</span><span class='line'>Linking pluggy-1.0.0-pyhd8ed1ab_5
</span><span class='line'>Linking pycosat-0.6.4-py310h761cc84_1
</span><span class='line'>Linking pycparser-2.21-pyhd8ed1ab_0
</span><span class='line'>Linking pysocks-1.7.1-pyha2e5f31_6
</span><span class='line'>Linking ruamel.yaml.clib-0.2.7-py310hb89b984_1
</span><span class='line'>Linking setuptools-65.6.3-pyhd8ed1ab_0
</span><span class='line'>Linking toolz-0.12.0-pyhd8ed1ab_0
</span><span class='line'>Linking wheel-0.38.4-pyhd8ed1ab_0
</span><span class='line'>Linking cffi-1.15.1-py310hf0c4615_3
</span><span class='line'>Linking pip-23.0-pyhd8ed1ab_0
</span><span class='line'>Linking ruamel.yaml-0.17.21-py310h761cc84_2
</span><span class='line'>Linking tqdm-4.64.1-pyhd8ed1ab_0
</span><span class='line'>Linking brotlipy-0.7.0-py310h761cc84_1005
</span><span class='line'>Linking cryptography-39.0.1-py310he4ba0b1_0
</span><span class='line'>Linking zstandard-0.19.0-py310hde4b81c_1
</span><span class='line'>Linking conda-package-streaming-0.7.0-pyhd8ed1ab_1
</span><span class='line'>Linking pyopenssl-23.0.0-pyhd8ed1ab_0
</span><span class='line'>Linking conda-package-handling-2.0.2-pyh38be061_0
</span><span class='line'>Linking urllib3-1.26.14-pyhd8ed1ab_0
</span><span class='line'>Linking requests-2.28.2-pyhd8ed1ab_0
</span><span class='line'>Linking conda-22.11.1-py310h4c7bcd0_1
</span><span class='line'>Transaction finished
</span><span class='line'>installation finished.
</span><span class='line'>Do you wish the installer to initialize Miniforge3
</span><span class='line'>by running conda init? [yes|no]
</span><span class='line'>[no] &gt;&gt;&gt; yes
</span><span class='line'>no change     /usr/local/miniforge3/condabin/conda
</span><span class='line'>no change     /usr/local/miniforge3/bin/conda
</span><span class='line'>no change     /usr/local/miniforge3/bin/conda-env
</span><span class='line'>no change     /usr/local/miniforge3/bin/activate
</span><span class='line'>no change     /usr/local/miniforge3/bin/deactivate
</span><span class='line'>no change     /usr/local/miniforge3/etc/profile.d/conda.sh
</span><span class='line'>no change     /usr/local/miniforge3/etc/fish/conf.d/conda.fish
</span><span class='line'>no change     /usr/local/miniforge3/shell/condabin/Conda.psm1
</span><span class='line'>no change     /usr/local/miniforge3/shell/condabin/conda-hook.ps1
</span><span class='line'>no change     /usr/local/miniforge3/lib/python3.10/site-packages/xontrib/conda.xsh
</span><span class='line'>no change     /usr/local/miniforge3/etc/profile.d/conda.csh
</span><span class='line'>modified      /root/.bashrc
</span><span class='line'>
</span><span class='line'>==&gt; For changes to take effect, close and re-open your current shell. &lt;==
</span><span class='line'>
</span><span class='line'>If you'd prefer that conda's base environment not be activated on startup, 
</span><span class='line'>   set the auto_activate_base parameter to false: 
</span><span class='line'>
</span><span class='line'>conda config --set auto_activate_base false
</span><span class='line'>
</span><span class='line'>Thank you for installing Miniforge3!
</span><span class='line'>root@ubuntu:~# 
</span></code></pre></td></tr></table></div></figure>


<p>这里修改了 /root/.bashrc 添加了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># &gt;&gt;&gt; conda initialize &gt;&gt;&gt;
</span><span class='line'># !! Contents within this block are managed by 'conda init' !!
</span><span class='line'>__conda_setup="$('/usr/local/miniforge3/bin/conda' 'shell.bash' 'hook' 2&gt; /dev/null)"
</span><span class='line'>if [ $? -eq 0 ]; then
</span><span class='line'>    eval "$__conda_setup"
</span><span class='line'>else
</span><span class='line'>    if [ -f "/usr/local/miniforge3/etc/profile.d/conda.sh" ]; then
</span><span class='line'>        . "/usr/local/miniforge3/etc/profile.d/conda.sh"
</span><span class='line'>    else
</span><span class='line'>        export PATH="/usr/local/miniforge3/bin:$PATH"
</span><span class='line'>    fi
</span><span class='line'>fi
</span><span class='line'>unset __conda_setup
</span><span class='line'># &lt;&lt;&lt; conda initialize &lt;&lt;&lt;
</span></code></pre></td></tr></table></div></figure>


<p>为了重新加载环境变量，新开一个窗口，查看版本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) root@ubuntu:~# python -V
</span><span class='line'>Python 3.10.9
</span><span class='line'>(base) root@ubuntu:~# 
</span><span class='line'>(base) root@ubuntu:~# conda -V
</span><span class='line'>conda 22.11.1
</span><span class='line'>
</span><span class='line'>(base) root@ubuntu:~# python3
</span><span class='line'>Python 3.10.9 | packaged by conda-forge | (main, Feb  2 2023, 20:11:30) [GCC 11.3.0] on linux
</span><span class='line'>Type "help", "copyright", "credits" or "license" for more information.
</span><span class='line'>&gt;&gt;&gt; import platform
</span><span class='line'>&gt;&gt;&gt; platform.architecture()
</span><span class='line'>('64bit', 'ELF')
</span><span class='line'>&gt;&gt;&gt; </span></code></pre></td></tr></table></div></figure>


<p>使用conda新建一个python3.8的配置 <a href="https://conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html">https://conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html</a> ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) root@ubuntu:~# conda info --envs
</span><span class='line'># conda environments:
</span><span class='line'>#
</span><span class='line'>base                  *  /usr/local/miniforge3
</span><span class='line'>
</span><span class='line'>(base) root@ubuntu:~# export http_proxy="http://127.0.0.1:7890"
</span><span class='line'>(base) root@ubuntu:~# export https_proxy="http://127.0.0.1:7890" 
</span><span class='line'>
</span><span class='line'>(base) root@ubuntu:~# conda create -n openai python=3.8 
</span><span class='line'>Collecting package metadata (current_repodata.json): done
</span><span class='line'>Solving environment: done
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>==&gt; WARNING: A newer version of conda exists. &lt;==
</span><span class='line'>  current version: 22.11.1
</span><span class='line'>  latest version: 23.1.0
</span><span class='line'>
</span><span class='line'>Please update conda by running
</span><span class='line'>
</span><span class='line'>    $ conda update -n base -c conda-forge conda
</span><span class='line'>
</span><span class='line'>Or to minimize the number of packages updated during conda update use
</span><span class='line'>
</span><span class='line'>     conda install conda=23.1.0
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>## Package Plan ##
</span><span class='line'>
</span><span class='line'>  environment location: /usr/local/miniforge3/envs/openai
</span><span class='line'>
</span><span class='line'>  added / updated specs:
</span><span class='line'>    - python=3.8
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>The following packages will be downloaded:
</span><span class='line'>
</span><span class='line'>    package                    |            build
</span><span class='line'>    ---------------------------|-----------------
</span><span class='line'>    pypy3.8-7.3.11             |       hf9a8208_0        31.6 MB  conda-forge
</span><span class='line'>    ------------------------------------------------------------
</span><span class='line'>                                           Total:        31.6 MB
</span><span class='line'>
</span><span class='line'>The following NEW packages will be INSTALLED:
</span><span class='line'>
</span><span class='line'>  _openmp_mutex      conda-forge/linux-aarch64::_openmp_mutex-4.5-2_gnu 
</span><span class='line'>  bzip2              conda-forge/linux-aarch64::bzip2-1.0.8-hf897c2e_4 
</span><span class='line'>  ca-certificates    conda-forge/linux-aarch64::ca-certificates-2022.12.7-h4fd8a4c_0 
</span><span class='line'>  expat              conda-forge/linux-aarch64::expat-2.5.0-ha18d298_0 
</span><span class='line'>  gdbm               conda-forge/linux-aarch64::gdbm-1.18-h0a1914f_2 
</span><span class='line'>  libffi             conda-forge/linux-aarch64::libffi-3.4.2-h3557bc0_5 
</span><span class='line'>  libgcc-ng          conda-forge/linux-aarch64::libgcc-ng-12.2.0-h607ecd0_19 
</span><span class='line'>  libgomp            conda-forge/linux-aarch64::libgomp-12.2.0-h607ecd0_19 
</span><span class='line'>  libsqlite          conda-forge/linux-aarch64::libsqlite-3.40.0-hf9034f9_0 
</span><span class='line'>  libstdcxx-ng       conda-forge/linux-aarch64::libstdcxx-ng-12.2.0-hc13a102_19 
</span><span class='line'>  libzlib            conda-forge/linux-aarch64::libzlib-1.2.13-h4e544f5_4 
</span><span class='line'>  ncurses            conda-forge/linux-aarch64::ncurses-6.3-headf329_1 
</span><span class='line'>  openssl            conda-forge/linux-aarch64::openssl-3.1.0-hb4cce97_0 
</span><span class='line'>  pip                conda-forge/noarch::pip-23.0.1-pyhd8ed1ab_0 
</span><span class='line'>  pypy3.8            conda-forge/linux-aarch64::pypy3.8-7.3.11-hf9a8208_0 
</span><span class='line'>  python             conda-forge/linux-aarch64::python-3.8.16-0_73_pypy 
</span><span class='line'>  python_abi         conda-forge/linux-aarch64::python_abi-3.8-3_pypy38_pp73 
</span><span class='line'>  readline           conda-forge/linux-aarch64::readline-8.2-h8fc344f_1 
</span><span class='line'>  setuptools         conda-forge/noarch::setuptools-67.6.0-pyhd8ed1ab_0 
</span><span class='line'>  sqlite             conda-forge/linux-aarch64::sqlite-3.40.0-h69ca7e5_0 
</span><span class='line'>  tk                 conda-forge/linux-aarch64::tk-8.6.12-hd8af866_0 
</span><span class='line'>  wheel              conda-forge/noarch::wheel-0.40.0-pyhd8ed1ab_0 
</span><span class='line'>  xz                 conda-forge/linux-aarch64::xz-5.2.6-h9cdd2b7_0 
</span><span class='line'>  zlib               conda-forge/linux-aarch64::zlib-1.2.13-h4e544f5_4 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Proceed ([y]/n)? y
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Downloading and Extracting Packages
</span><span class='line'>                                                                                                                                                                                          
</span><span class='line'>Preparing transaction: done
</span><span class='line'>Verifying transaction: done
</span><span class='line'>Executing transaction: done
</span><span class='line'>#
</span><span class='line'># To activate this environment, use
</span><span class='line'>#
</span><span class='line'>#     $ conda activate openai
</span><span class='line'>#
</span><span class='line'># To deactivate an active environment, use
</span><span class='line'>#
</span><span class='line'>#     $ conda deactivate
</span><span class='line'>
</span><span class='line'>(base) root@ubuntu:~# 
</span></code></pre></td></tr></table></div></figure>


<p>激活配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(base) root@ubuntu:~# conda activate openai
</span><span class='line'>(openai) root@ubuntu:~# 
</span><span class='line'>(openai) root@ubuntu:~# python --version
</span><span class='line'>Python 3.8.16 | packaged by conda-forge | (a9dbdca6, Jan 29 2023, 10:19:50)
</span><span class='line'>[PyPy 7.3.11 with GCC 11.3.0]
</span><span class='line'>(openai) root@ubuntu:~# pip --version 
</span><span class='line'>pip 23.0.1 from /usr/local/miniforge3/envs/openai/lib/pypy3.8/site-packages/pip (python 3.8)
</span><span class='line'>(openai) root@ubuntu:~# git clone https://github.com/zhayujie/bot-on-anything
</span><span class='line'>Cloning into 'bot-on-anything'...
</span><span class='line'>remote: Enumerating objects: 644, done.
</span><span class='line'>remote: Counting objects: 100% (271/271), done.
</span><span class='line'>remote: Compressing objects: 100% (116/116), done.
</span><span class='line'>remote: Total 644 (delta 190), reused 194 (delta 154), pack-reused 373
</span><span class='line'>Receiving objects: 100% (644/644), 588.10 KiB | 448.00 KiB/s, done.
</span><span class='line'>Resolving deltas: 100% (373/373), done.
</span><span class='line'>(openai) root@ubuntu:~# 
</span><span class='line'>(openai) root@ubuntu:~# pip3 install itchat-uos==1.5.0.dev0
</span><span class='line'>Collecting itchat-uos==1.5.0.dev0
</span><span class='line'>  Downloading itchat_uos-1.5.0.dev0-py3-none-any.whl (52 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 52.5/52.5 kB 244.0 kB/s eta 0:00:00
</span><span class='line'>Collecting requests
</span><span class='line'>  Downloading requests-2.28.2-py3-none-any.whl (62 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 62.8/62.8 kB 409.1 kB/s eta 0:00:00
</span><span class='line'>Collecting pyqrcode
</span><span class='line'>  Downloading PyQRCode-1.2.1.zip (41 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 41.9/41.9 kB 961.5 kB/s eta 0:00:00
</span><span class='line'>  Preparing metadata (setup.py) ... done
</span><span class='line'>Collecting pypng
</span><span class='line'>  Downloading pypng-0.20220715.0-py3-none-any.whl (58 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 58.1/58.1 kB 540.0 kB/s eta 0:00:00
</span><span class='line'>Collecting charset-normalizer&lt;4,&gt;=2
</span><span class='line'>  Downloading charset_normalizer-3.1.0-py3-none-any.whl (46 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 46.2/46.2 kB 642.4 kB/s eta 0:00:00
</span><span class='line'>Collecting idna&lt;4,&gt;=2.5
</span><span class='line'>  Downloading idna-3.4-py3-none-any.whl (61 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 61.5/61.5 kB 567.0 kB/s eta 0:00:00
</span><span class='line'>Collecting urllib3&lt;1.27,&gt;=1.21.1
</span><span class='line'>  Downloading urllib3-1.26.15-py2.py3-none-any.whl (140 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 140.9/140.9 kB 1.0 MB/s eta 0:00:00
</span><span class='line'>Collecting certifi&gt;=2017.4.17
</span><span class='line'>  Downloading certifi-2022.12.7-py3-none-any.whl (155 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 155.3/155.3 kB 1.2 MB/s eta 0:00:00
</span><span class='line'>Building wheels for collected packages: pyqrcode
</span><span class='line'>  Building wheel for pyqrcode (setup.py) ... done
</span><span class='line'>  Created wheel for pyqrcode: filename=PyQRCode-1.2.1-py3-none-any.whl size=36228 sha256=ba8cd080e7793f5e55c14fa704e57c1459ae29aa6481c719833bf9e148de5ad0
</span><span class='line'>  Stored in directory: /root/.cache/pip/wheels/5f/46/eb/231c89e0ae989c528db1a30d3aae90c4fee29f14d4e0369312
</span><span class='line'>Successfully built pyqrcode
</span><span class='line'>Installing collected packages: pyqrcode, pypng, urllib3, idna, charset-normalizer, certifi, requests, itchat-uos
</span><span class='line'>Successfully installed certifi-2022.12.7 charset-normalizer-3.1.0 idna-3.4 itchat-uos-1.5.0.dev0 pypng-0.20220715.0 pyqrcode-1.2.1 requests-2.28.2 urllib3-1.26.15
</span><span class='line'>WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv
</span><span class='line'>(openai) root@ubuntu:~# 
</span><span class='line'>(openai) root@ubuntu:~# pip3 install --upgrade openai
</span><span class='line'>Collecting openai
</span><span class='line'>  Downloading openai-0.27.2-py3-none-any.whl (70 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 70.1/70.1 kB 277.1 kB/s eta 0:00:00
</span><span class='line'>Requirement already satisfied: requests&gt;=2.20 in /usr/local/miniforge3/envs/openai/lib/python3.8/site-packages (from openai) (2.28.2)
</span><span class='line'>Collecting tqdm
</span><span class='line'>  Downloading tqdm-4.65.0-py3-none-any.whl (77 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 77.1/77.1 kB 394.8 kB/s eta 0:00:00
</span><span class='line'>Collecting aiohttp
</span><span class='line'>  Downloading aiohttp-3.8.4.tar.gz (7.3 MB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 7.3/7.3 MB 2.1 MB/s eta 0:00:00
</span><span class='line'>  Installing build dependencies ... done
</span><span class='line'>  Getting requirements to build wheel ... done
</span><span class='line'>  Installing backend dependencies ... done
</span><span class='line'>  Preparing metadata (pyproject.toml) ... done
</span><span class='line'>Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /usr/local/miniforge3/envs/openai/lib/python3.8/site-packages (from requests&gt;=2.20-&gt;openai) (3.1.0)
</span><span class='line'>Requirement already satisfied: idna&lt;4,&gt;=2.5 in /usr/local/miniforge3/envs/openai/lib/python3.8/site-packages (from requests&gt;=2.20-&gt;openai) (3.4)
</span><span class='line'>Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /usr/local/miniforge3/envs/openai/lib/python3.8/site-packages (from requests&gt;=2.20-&gt;openai) (1.26.15)
</span><span class='line'>Requirement already satisfied: certifi&gt;=2017.4.17 in /usr/local/miniforge3/envs/openai/lib/python3.8/site-packages (from requests&gt;=2.20-&gt;openai) (2022.12.7)
</span><span class='line'>Collecting attrs&gt;=17.3.0
</span><span class='line'>  Downloading attrs-22.2.0-py3-none-any.whl (60 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 60.0/60.0 kB 834.6 kB/s eta 0:00:00
</span><span class='line'>Collecting multidict&lt;7.0,&gt;=4.5
</span><span class='line'>  Downloading multidict-6.0.4.tar.gz (51 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 51.3/51.3 kB 1.4 MB/s eta 0:00:00
</span><span class='line'>  Installing build dependencies ... done
</span><span class='line'>  Getting requirements to build wheel ... done
</span><span class='line'>  Installing backend dependencies ... done
</span><span class='line'>  Preparing metadata (pyproject.toml) ... done
</span><span class='line'>Collecting async-timeout&lt;5.0,&gt;=4.0.0a3
</span><span class='line'>  Downloading async_timeout-4.0.2-py3-none-any.whl (5.8 kB)
</span><span class='line'>Collecting yarl&lt;2.0,&gt;=1.0
</span><span class='line'>  Downloading yarl-1.8.2.tar.gz (172 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 172.3/172.3 kB 1.8 MB/s eta 0:00:00
</span><span class='line'>  Installing build dependencies ... done
</span><span class='line'>  Getting requirements to build wheel ... done
</span><span class='line'>  Preparing metadata (pyproject.toml) ... done
</span><span class='line'>Collecting frozenlist&gt;=1.1.1
</span><span class='line'>  Downloading frozenlist-1.3.3.tar.gz (66 kB)
</span><span class='line'>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 66.6/66.6 kB 392.4 kB/s eta 0:00:00
</span><span class='line'>  Installing build dependencies ... done
</span><span class='line'>  Getting requirements to build wheel ... done
</span><span class='line'>  Preparing metadata (pyproject.toml) ... done
</span><span class='line'>Collecting aiosignal&gt;=1.1.2
</span><span class='line'>  Downloading aiosignal-1.3.1-py3-none-any.whl (7.6 kB)
</span><span class='line'>Building wheels for collected packages: aiohttp, frozenlist, multidict, yarl
</span><span class='line'>  Building wheel for aiohttp (pyproject.toml) ... done
</span><span class='line'>  Created wheel for aiohttp: filename=aiohttp-3.8.4-py3-none-any.whl size=183495 sha256=6bdf6b07bb86d5e5e452691da3570b0465c4177bec6fbe8ab668aef8d27ce39c
</span><span class='line'>  Stored in directory: /root/.cache/pip/wheels/46/48/fb/1fceb5376aa4eb481cec5ca10d6aece4455cf6a95030009502
</span><span class='line'>  Building wheel for frozenlist (pyproject.toml) ... done
</span><span class='line'>  Created wheel for frozenlist: filename=frozenlist-1.3.3-py3-none-any.whl size=9271 sha256=83ae70b8a9145f1fb94dffca4105ef207500e63dd3d8c056dc63a3f6ba664927
</span><span class='line'>  Stored in directory: /root/.cache/pip/wheels/0e/e7/55/8036a4cd9267238ba8aa2d714837827b8fd836324632469067
</span><span class='line'>  Building wheel for multidict (pyproject.toml) ... done
</span><span class='line'>  Created wheel for multidict: filename=multidict-6.0.4-py3-none-any.whl size=9710 sha256=0a72821685197753e4e43473bbfe1232bb33cd79fa4ad9c97daae3a7e4afd097
</span><span class='line'>  Stored in directory: /root/.cache/pip/wheels/23/65/1f/b5b0672ad49d2ff7b2c6ad75f24f45c407aab185c37803ae76
</span><span class='line'>  Building wheel for yarl (pyproject.toml) ... done
</span><span class='line'>  Created wheel for yarl: filename=yarl-1.8.2-py3-none-any.whl size=24118 sha256=4ed71ce5647e860cac0a0b5496e72e837878a33d62177d3bdded7d20d068b299
</span><span class='line'>  Stored in directory: /root/.cache/pip/wheels/4e/40/2e/3261e7db3f6b66ca3d8a1ec694f2d5d87f89110e2204675597
</span><span class='line'>Successfully built aiohttp frozenlist multidict yarl
</span><span class='line'>Installing collected packages: tqdm, multidict, frozenlist, attrs, async-timeout, yarl, aiosignal, aiohttp, openai
</span><span class='line'>Successfully installed aiohttp-3.8.4 aiosignal-1.3.1 async-timeout-4.0.2 attrs-22.2.0 frozenlist-1.3.3 multidict-6.0.4 openai-0.27.2 tqdm-4.65.0 yarl-1.8.2
</span><span class='line'>WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv
</span><span class='line'>(openai) root@ubuntu:~# 
</span></code></pre></td></tr></table></div></figure>


<h3>学习conda</h3>

<ul>
<li><a href="https://stackoverflow.com/questions/34534513/calling-conda-source-activate-from-bash-script">https://stackoverflow.com/questions/34534513/calling-conda-source-activate-from-bash-script</a></li>
<li><a href="https://docs.conda.io/projects/conda/en/latest/dev-guide/deep-dives/activation.html">https://docs.conda.io/projects/conda/en/latest/dev-guide/deep-dives/activation.html</a></li>
<li><a href="https://conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html">https://conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1
</span><span class='line'>$ eval "$(conda shell.bash activate)"
</span><span class='line'>$ conda shell.bash activate mamba-poc
</span><span class='line'>
</span><span class='line'>2
</span><span class='line'>eval "$(conda shell.bash hook)"
</span><span class='line'>conda activate &lt;env-name&gt;
</span><span class='line'>
</span><span class='line'>3
</span><span class='line'>#!/bin/bash
</span><span class='line'>source /Users/yourname/anaconda/bin/activate your_env
</span><span class='line'>python --version # example way to see that your virtual env loaded as expected
</span><span class='line'>
</span><span class='line'>4
</span><span class='line'>try using
</span><span class='line'>
</span><span class='line'>source ~/anaconda3/etc/profile.d/conda.sh
</span><span class='line'>
</span><span class='line'>and then do
</span><span class='line'>
</span><span class='line'>conda activate pult
</span><span class='line'>
</span><span class='line'>5
</span><span class='line'>https://unix.stackexchange.com/questions/689163/launch-terminal-and-conda-activate-env-from-bash-script
</span><span class='line'># Just activate my conda
</span><span class='line'>alias my_conda='source /home/$USER/anaconda3/bin/activate && conda activate MyPy38'
</span><span class='line'>
</span><span class='line'># Open Jupyter Notebook in my Env
</span><span class='line'>alias my_jupn='source /home/$USER/anaconda3/bin/activate && conda activate MyPy38 && jupyter-notebook'
</span><span class='line'>
</span><span class='line'># Open Jupyter Lab in my Env
</span><span class='line'>alias my_jupl='source /home/$USER/anaconda3/bin/activate && conda activate MyPy38 && jupyter-lab'
</span><span class='line'>
</span><span class='line'># Open Spyder in my Env
</span><span class='line'>alias my_spyder='source /home/$USER/anaconda3/bin/activate && conda activate MyPy38 && spyder'
</span></code></pre></td></tr></table></div></figure>


<h2>花生壳</h2>

<ul>
<li><a href="https://hsk.oray.com/download">https://hsk.oray.com/download</a></li>
<li><a href="https://service.oray.com/question/11639.html">https://service.oray.com/question/11639.html</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/03/25/reinstall-raspberry2/">重新折腾raspberry2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2023-03-25T21:24:35+08:00" pubdate data-updated="true">Sat 2023-03-25 21:24</time>
		
        
		
      </p>
    
  </header>



  <div class="entry-content"><p>买了新的raspberry4后，就没怎么去弄旧的树莓派2了，今天再次看到想着运行起来看看，插上电源后，一直亮着绿灯，然后就没其他反应了。</p>

<p>树莓派2有点旧，现在直接拿着新的手机充电器去接的时刻，一直起不来，刚开始是怀疑是用TTL接错线导致板子烧了，也没有显示器查看界面。</p>

<p>后面想着重新安装一下试试，然后拿着去接网线有线网络，这样就拿了一个旧的充电器的头。没想到这个时刻电源指示灯尽然闪起来了。想来这可能是电流过载保护了。</p>

<p>问题解决了，也把最新的重新安装的记录一下。</p>

<h2>安装</h2>

<p>参考：
* <a href="https://www.raspberrypi.com/documentation/computers/getting-started.html#installing-the-operating-system">Setting up your Raspberry Pi</a></p>

<h3>安装系统</h3>

<p>1 打开 <a href="https://www.raspberrypi.com/software/">Raspberry Pi Imager</a> 下载并安装，然后把SD card插入电脑。</p>

<p><img src="/images/blogs/rasp2/rasp2-1.png" alt="" /></p>

<p>2 设置初始化 用户和密码，并默认打开ssh服务（新版本已经去掉默认用户了，所以要设置一下 <a href="https://www.raspberrypi.com/news/raspberry-pi-bullseye-update-april-2022/">An update to Raspberry Pi OS Bullseye</a> ）</p>

<p><img src="/images/blogs/rasp2/rasp2-2.png" alt="" /></p>

<p>3 选择操作系统</p>

<p><img src="/images/blogs/rasp2/rasp2-3-1.png" alt="" /></p>

<p><img src="/images/blogs/rasp2/rasp2-3-2.png" alt="" /></p>

<p>4 连上有线网络，接通电源。然后打开路由管理界面，查看raspberry的ip地址</p>

<p><img src="/images/blogs/rasp2/rasp2-4-0.png" alt="" /></p>

<p>5 用ssh连接服务器</p>

<p><img src="/images/blogs/rasp2/rasp2-4-1.png" alt="" /></p>

<h3>配置Wifi网络</h3>

<p>原来已经买了usb的无线网卡，用 <code>ifconfig</code> 也能查看到 <code>wlan0</code> 的接口。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# apt install vim 
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree... Done
</span><span class='line'>Reading state information... Done
</span><span class='line'>  libgpm2 vim-runtime
</span><span class='line'>Suggested packages:
</span><span class='line'>  gpm ctags vim-doc vim-scripts
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  libgpm2 vim vim-runtime
</span><span class='line'>0 upgraded, 3 newly installed, 0 to remove and 0 not upgraded.
</span><span class='line'>...
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/vim (vim) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/vimdiff (vimdiff) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/rvim (rvim) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/rview (rview) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/vi (vi) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/view (view) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/ex (ex) in auto mode
</span><span class='line'>Processing triggers for man-db (2.9.4-2) ...
</span><span class='line'>Processing triggers for libc-bin (2.31-13+rpt2+rpi1+deb11u5) ...
</span><span class='line'>
</span><span class='line'>root@raspberrypi:~# echo "set mouse-=a" &gt;&gt;~/.vimrc
</span><span class='line'>root@raspberrypi:~# vim /etc/wpa_supplicant/wpa_supplicant.conf    
</span><span class='line'>root@raspberrypi:~# 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>root@raspberrypi:~# iwlist wlan0 scan
</span><span class='line'>
</span><span class='line'># 算一个加密的配置
</span><span class='line'>root@raspberrypi:~# wpa_passphrase winse
</span><span class='line'># reading passphrase from stdin
</span><span class='line'>xxx
</span><span class='line'>network={
</span><span class='line'>        ssid="winse"
</span><span class='line'>        #psk="xxx"
</span><span class='line'>        psk=xxx
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>root@raspberrypi:~# cat /etc/wpa_supplicant/wpa_supplicant.conf   
</span><span class='line'>country=CN
</span><span class='line'>ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
</span><span class='line'>update_config=1
</span><span class='line'>
</span><span class='line'>network={
</span><span class='line'>        ssid="winse"
</span><span class='line'>        #psk="xxx"
</span><span class='line'>        psk=xxx
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 配置服务
</span><span class='line'>pi@raspberrypi:~ $ cat /lib/systemd/system/wpa_supplicant.service 
</span><span class='line'>[Unit]
</span><span class='line'>Description=WPA supplicant
</span><span class='line'>Before=network.target
</span><span class='line'>After=dbus.service
</span><span class='line'>Wants=network.target
</span><span class='line'>IgnoreOnIsolate=true
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>#Type=dbus
</span><span class='line'>#BusName=fi.w1.wpa_supplicant1
</span><span class='line'>Type=forking
</span><span class='line'>ExecStart=/sbin/wpa_supplicant -u -s -O /run/wpa_supplicant -c /etc/wpa_supplicant/wpa_supplicant.conf -i wlan0 -B -D wext
</span><span class='line'>Restart=always
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target
</span><span class='line'>#Alias=dbus-fi.w1.wpa_supplicant1.service
</span><span class='line'>pi@raspberrypi:~ $ cat /etc/systemd/system/dhclient.service 
</span><span class='line'>[Unit]
</span><span class='line'>Description= DHCP Client
</span><span class='line'>Before=network.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>Type=forking
</span><span class='line'>ExecStart=/sbin/dhclient wlan0 -v
</span><span class='line'>ExecStop=/sbin/dhclient wlan0 -r
</span><span class='line'>Restart=always
</span><span class='line'>
</span><span class='line'>[Install] 
</span><span class='line'>WantedBy=multi-user.target
</span><span class='line'>pi@raspberrypi:~ $ 
</span><span class='line'>
</span><span class='line'>root@raspberrypi:~# systemctl daemon-reload 
</span><span class='line'>
</span><span class='line'>root@raspberrypi:~# systemctl stop NetworkManager
</span><span class='line'>root@raspberrypi:~# systemctl enable wpa_supplicant.service 
</span><span class='line'>root@raspberrypi:~# systemctl enable dhclient.service
</span><span class='line'>Created symlink /etc/systemd/system/multi-user.target.wants/dhclient.service → /etc/systemd/system/dhclient.service.
</span></code></pre></td></tr></table></div></figure>


<p>配置好后，重启服务器，再次查看路由器管理web界面：</p>

<p><img src="/images/blogs/rasp2/rasp2-5.png" alt="" /></p>

<p>然后再把网线拔掉，再重启一次确认一下。</p>

<h3>遇到的问题：</h3>

<p>1 <a href="https://zhuanlan.zhihu.com/p/136463580">https://zhuanlan.zhihu.com/p/136463580</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>如果树莓派系统使用的是Raspbian Stretch，则ifup命令可能不起作用，可能会收到一条错误消息，
</span><span class='line'>内容如下：“ ifdown：unknown interface wlan0 ”。可以使用以下任何命令来解决：
</span><span class='line'>sudo ifconfig wlan0 up
</span></code></pre></td></tr></table></div></figure>


<p>2 <a href="https://shumeipai.nxez.com/2017/09/13/raspberry-pi-network-configuration-before-boot.html">https://shumeipai.nxez.com/2017/09/13/raspberry-pi-network-configuration-before-boot.html</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>说明以及不同安全性的 WiFi 配置示例：
</span><span class='line'>#ssid:网络的ssid
</span><span class='line'>#psk:密码
</span><span class='line'>#priority:连接优先级，数字越大优先级越高（不可以是负数）
</span><span class='line'>#scan_ssid:连接隐藏WiFi时需要指定该值为1
</span><span class='line'>
</span><span class='line'>如果你的 WiFi 没有密码
</span><span class='line'>
</span><span class='line'>network={
</span><span class='line'>  ssid="你的无线网络名称（ssid）"
</span><span class='line'>  key_mgmt=NONE
</span><span class='line'>}
</span><span class='line'>如果你的 WiFi 使用WEP加密
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>network={
</span><span class='line'>  ssid="你的无线网络名称（ssid）"
</span><span class='line'>  key_mgmt=NONE
</span><span class='line'>  wep_key0="你的wifi密码"
</span><span class='line'>}
</span><span class='line'>如果你的 WiFi 使用WPA/WPA2加密
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>network={
</span><span class='line'>  ssid="你的无线网络名称（ssid）"
</span><span class='line'>  key_mgmt=WPA-PSK
</span><span class='line'>  psk="你的wifi密码"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>如果你不清楚 WiFi 的加密模式，可以在安卓手机上用 root explorer 打开 /data/misc/wifi/wpa/wpa_supplicant.conf，查看 WiFi 的信息。
</span></code></pre></td></tr></table></div></figure>


<p>3 <a href="https://www.labno3.com/2021/03/22/setting-up-raspberry-pi-wifi/">https://www.labno3.com/2021/03/22/setting-up-raspberry-pi-wifi/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>如果连接有问题，一定要确认Pi是否支持WiFi。也有可能你的SSID是错误的，要扫描和检查，
</span><span class='line'>使用sudo iwlist wlan0 scan并检查essid字段。
</span><span class='line'>这个字段应该和你在ssid字段输入的一样。
</span></code></pre></td></tr></table></div></figure>


<p>4 查看信息 <a href="https://www.baeldung.com/linux/connect-network-cli">https://www.baeldung.com/linux/connect-network-cli</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@raspberrypi:~# ip link show wlan0
</span><span class='line'>3: wlan0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
</span><span class='line'>  link/ether 00:5a:39:e1:4d:bb brd ff:ff:ff:ff:ff:ff
</span><span class='line'>root@raspberrypi:~# ip link set wlan0 up  
</span><span class='line'>root@raspberrypi:~# ip link show wlan0
</span><span class='line'>3: wlan0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
</span><span class='line'>  link/ether 00:5a:39:e1:4d:bb brd ff:ff:ff:ff:ff:ff
</span><span class='line'>root@raspberrypi:~# 
</span><span class='line'>root@raspberrypi:~# iw wlan0 link
</span><span class='line'>Not connected.
</span><span class='line'>
</span><span class='line'>root@raspberrypi:~# ifconfig wlan0 down
</span><span class='line'>root@raspberrypi:~# ifconfig wlan0 up 
</span><span class='line'>root@raspberrypi:~# ifconfig wlan0
</span><span class='line'>wlan0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500
</span><span class='line'>      ether 00:5a:39:e1:4d:bb  txqueuelen 1000  (Ethernet)
</span><span class='line'>      RX packets 0  bytes 0 (0.0 B)
</span><span class='line'>      RX errors 0  dropped 0  overruns 0  frame 0
</span><span class='line'>      TX packets 0  bytes 0 (0.0 B)
</span><span class='line'>      TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></code></pre></td></tr></table></div></figure>


<p>5 <a href="https://shapeshed.com/linux-wifi/">https://shapeshed.com/linux-wifi/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wpa_cli
</span></code></pre></td></tr></table></div></figure>


<p>6 <a href="https://www.bilibili.com/read/cv8895717">https://www.bilibili.com/read/cv8895717</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /etc/wpa_supplicant/wpa_supplicant.conf 编辑该文件，在文件顶部增加以下内容
</span><span class='line'>country=CN
</span><span class='line'>ctrl_interface=/run/wpa_supplicant
</span><span class='line'>update_config=1
</span><span class='line'>
</span><span class='line'>特别说明：country=CN 由于各个国家wifi使用频段不同，尤其5G频段
</span><span class='line'>
</span><span class='line'>vim /etc/rc.local 添加以下内容
</span><span class='line'>
</span><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>ip link set wlan0 up &
</span><span class='line'>wpa_supplicant -B -i wlan0 -D nl80211 -c /etc/wpa_supplicant/wpa_supplicant.conf &
</span><span class='line'>dhclient wlan0
</span><span class='line'>
</span><span class='line'>exit 0</span></code></pre></td></tr></table></div></figure>


<p>7 <a href="https://blog.csdn.net/u010049696/article/details/48765999">https://blog.csdn.net/u010049696/article/details/48765999</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>配置service。进入到/usr/lib/systemd/system目录，可以看到下面四个文件：
</span><span class='line'>
</span><span class='line'>wpa_supplicant-nl80211@.service
</span><span class='line'>wpa_supplicant.service
</span><span class='line'>wpa_supplicant@.service
</span><span class='line'>wpa_supplicant-wired@.service
</span><span class='line'>
</span><span class='line'>编辑wpa_supplicant.service文件，如下：
</span><span class='line'>
</span><span class='line'>[Unit]
</span><span class='line'>Description=WPA supplicant
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>Type=dbus
</span><span class='line'>BusName=fi.epitest.hostap.WPASupplicant
</span><span class='line'>ExecStart=/usr/bin/wpa_supplicant -c/etc/wpa_supplicant/test.conf -i wlp3s0
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target
</span><span class='line'>Alias=dbus-fi.epitest.hostap.WPASupplicant.service
</span><span class='line'>
</span><span class='line'>其中，只需修改ExecStart=/usr/bin/wpa_supplicant -c/etc/wpa_supplicant/test.conf -i wlp3s0即可。</span></code></pre></td></tr></table></div></figure>


<p>8 <a href="https://www.linuxbabe.com/command-line/ubuntu-server-16-04-wifi-wpa-supplicant">https://www.linuxbabe.com/command-line/ubuntu-server-16-04-wifi-wpa-supplicant</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Auto Connect on Startup
</span><span class='line'>To automatically connect to wireless network at boot time, we need to edit the wpa_supplicant.service file. It’s a good idea to copy the file from /lib/systemd/system/ directory to /etc/systemd/system/ directory, then edit it because we don’t want newer version of wpasupplicant to override our modifications.
</span><span class='line'>
</span><span class='line'>sudo cp /lib/systemd/system/wpa_supplicant.service /etc/systemd/system/wpa_supplicant.service
</span><span class='line'>
</span><span class='line'>sudo nano /etc/systemd/system/wpa_supplicant.service
</span><span class='line'>Find the following line.
</span><span class='line'>
</span><span class='line'>ExecStart=/sbin/wpa_supplicant -u -s -O /run/wpa_supplicant
</span><span class='line'>Change it to the following. Obviously you need to change wlp3s0 if that isn’t your interface name.
</span><span class='line'>
</span><span class='line'>ExecStart=/sbin/wpa_supplicant -u -s -c /etc/wpa_supplicant.conf -i wlp3s0
</span><span class='line'>It’s recommended to always try to restart wpa_supplicant when failure is detected. Add the following right below the ExecStart line.
</span><span class='line'>
</span><span class='line'>Restart=always
</span><span class='line'>If you can find the following line in this file, comment it out (Add the # character at the beginning of the line).
</span><span class='line'>
</span><span class='line'>Alias=dbus-fi.w1.wpa_supplicant1.service
</span><span class='line'>Save and close the file. Then enable wpa_supplicant service to start at boot time.
</span><span class='line'>
</span><span class='line'>sudo systemctl enable wpa_supplicant.service
</span><span class='line'>
</span><span class='line'>~~~
</span><span class='line'>
</span><span class='line'>sudo nano /etc/systemd/system/dhclient.service
</span><span class='line'>Put the following text into the file.
</span><span class='line'>
</span><span class='line'>[Unit]
</span><span class='line'>Description= DHCP Client
</span><span class='line'>Before=network.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>Type=forking
</span><span class='line'>ExecStart=/sbin/dhclient wlp3s0 -v
</span><span class='line'>ExecStop=/sbin/dhclient wlp3s0 -r
</span><span class='line'>Restart=always
</span><span class='line'>
</span><span class='line'>[Install] 
</span><span class='line'>WantedBy=multi-user.target
</span><span class='line'>Save and close the file. Then enable this service.
</span><span class='line'>
</span><span class='line'>sudo systemctl enable dhclient.service
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>



</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2024/01/15/aigc-setup-on-windows-wsl-2/">AIGC Setup on Win11 WSL2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/11/18/reinstall-redmine-on-respberry2/">Reinstall Redmine on Raspberry2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/04/09/dingtalk-with-openai/">钉钉群机器人对接ChatGPT</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/26/clash-on-raspberry4/">树莓派4安装Clash</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/25/reinstall-raspberry2/">重新折腾raspberry2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/25/mirror-request/">请求复制/镜像</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/03/18/wechat-on-openai/">微信对接OpenAI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/02/01/git-reset-hard/">记git Reset &#8211;hard</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

<!-- key -->
	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (68) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/efficity/'>efficity</a> (23) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (16) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blog/'>blog</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/raspberry/'>raspberry</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (237)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<!--
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
&#8211;>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2024 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winse.github.io" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>








<script type="text/javascript">
    $(function(){  
        $("img").click(function(){  
            var _this = $(this);
			window.open(_this.attr("src"), '_blank');
        });  
    });
</script>

</body>
</html>
