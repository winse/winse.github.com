
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="参考 源码 https://github.com/kubernetes/examples/tree/master/staging/volumes/nfs
https://github.com/kubernetes/examples/blob/master/staging/volumes/nfs/ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winse.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/libs/jquery.toc.min.js" type="text/javascript"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

<script src="/javascripts/generate-toc.js" type="text/javascript"></script>


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43198550-1', 'auto');
  ga('send', 'pageview');

</script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停, 熙熙攘攘, 忙忙碌碌, 不知何畏.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winse.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/04/19/k8s-nfs-run-example/">K8S官方例子NFS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-04-19T18:34:01+08:00" pubdate data-updated="true">Tue 2022-04-19 18:34</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><h2>参考</h2>

<p>源码</p>

<ul>
<li><a href="https://github.com/kubernetes/examples/tree/master/staging/volumes/nfs">https://github.com/kubernetes/examples/tree/master/staging/volumes/nfs</a></li>
<li><a href="https://github.com/kubernetes/examples/blob/master/staging/volumes/nfs/nfs-server-deployment.yaml">https://github.com/kubernetes/examples/blob/master/staging/volumes/nfs/nfs-server-deployment.yaml</a></li>
</ul>


<p>本地volumn</p>

<ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#local">https://kubernetes.io/zh/docs/concepts/storage/volumes/#local</a></li>
</ul>


<h2>运行</h2>

<h3>目录结构</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ git clone https://github.com/kubernetes/examples
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ cd examples/staging/volumes/nfs/
</span><span class='line'>[ec2-user@k8s nfs]$ ls -l
</span><span class='line'>total 48
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user  823 Apr 19 20:34 nfs-busybox-deployment.yaml
</span><span class='line'>drwxrwxr-x 2 ec2-user ec2-user   77 Apr 19 20:34 nfs-data
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user  193 Apr 19 20:34 nfs-pvc.yaml
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user 9379 Apr 19 20:34 nfs-pv.png
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user  234 Apr 19 20:34 nfs-pv.yaml
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user  729 Apr 19 20:34 nfs-server-deployment.yaml
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user  212 Apr 19 20:34 nfs-server-service.yaml
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user  673 Apr 19 20:34 nfs-web-deployment.yaml
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user  120 Apr 19 20:34 nfs-web-service.yaml
</span><span class='line'>drwxrwxr-x 2 ec2-user ec2-user   98 Apr 19 20:34 provisioner
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user 6540 Apr 19 20:34 README.md
</span><span class='line'>[ec2-user@k8s nfs]$ ls -l provisioner/
</span><span class='line'>total 12
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user 291 Apr 19 20:34 nfs-server-azure-pv.yaml
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user 324 Apr 19 20:34 nfs-server-cdk-pv.yaml
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user 215 Apr 19 20:34 nfs-server-gce-pv.yaml
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>nfs-data 是nfs-server镜像构建Dockerfile相关文件。</li>
<li>nfs-server：

<ul>
<li>nfs-server-deployment.yaml</li>
<li>nfs-server-service.yaml</li>
<li>provisioner</li>
</ul>
</li>
<li>web

<ul>
<li>nfs-pv.yaml</li>
<li>nfs-pvc.yaml</li>
<li>nfs-web-deployment.yaml</li>
<li>nfs-web-service.yaml</li>
<li>nfs-busybox-deployment.yaml</li>
</ul>
</li>
</ul>


<p>按照结构，一步步的来进行配置和运行。</p>

<h3>搭建NFS Server的本地存储卷</h3>

<ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#local">https://kubernetes.io/zh/docs/concepts/storage/volumes/#local</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ sudo mkdir /nfs
</span><span class='line'>[ec2-user@k8s ~]$ sudo chmod 777 /nfs
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ cat server-pv.yml 
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: PersistentVolume
</span><span class='line'>metadata:
</span><span class='line'>  name: nfs-pv
</span><span class='line'>spec:
</span><span class='line'>  capacity:
</span><span class='line'>    storage: 10Gi
</span><span class='line'>  volumeMode: Filesystem
</span><span class='line'>  accessModes:
</span><span class='line'>  - ReadWriteOnce
</span><span class='line'># https://kubernetes.io/docs/concepts/storage/persistent-volumes/#reclaiming
</span><span class='line'>  persistentVolumeReclaimPolicy: Delete
</span><span class='line'>  storageClassName: local-storage
</span><span class='line'>  local:
</span><span class='line'>    path: /nfs
</span><span class='line'>  nodeAffinity:
</span><span class='line'>    required:
</span><span class='line'>      nodeSelectorTerms:
</span><span class='line'>      - matchExpressions:
</span><span class='line'>        - key: kubernetes.io/hostname
</span><span class='line'>          operator: In
</span><span class='line'>          values:
</span><span class='line'>          - k8s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl apply -f server-pv.yml
</span><span class='line'>persistentvolume/nfs-pv created
</span></code></pre></td></tr></table></div></figure>


<p>创建server pvc：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s nfs]$ kubectl create namespace nfs
</span><span class='line'>namespace/nfs-server created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ cat provisioner/nfs-server-gce-pv.yaml   
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: PersistentVolumeClaim
</span><span class='line'>metadata:
</span><span class='line'>  name: nfs-pv-provisioning-demo
</span><span class='line'>  labels:
</span><span class='line'>    demo: nfs-pv-provisioning
</span><span class='line'>spec:
</span><span class='line'>  accessModes: [ "ReadWriteOnce" ]
</span><span class='line'>  resources:
</span><span class='line'>    requests:
</span><span class='line'>      storage: 10Gi
</span><span class='line'>  storageClassName: local-storage
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl apply -f provisioner/nfs-server-gce-pv.yaml -n nfs
</span><span class='line'>persistentvolumeclaim/nfs-pv-provisioning-demo created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl get pv 
</span><span class='line'>NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                          STORAGECLASS    REASON   AGE
</span><span class='line'>nfs-pv   10Gi       RWO            Delete           Bound    nfs/nfs-pv-provisioning-demo   local-storage            21s
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl get pvc -n nfs 
</span><span class='line'>NAME                       STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS    AGE
</span><span class='line'>nfs-pv-provisioning-demo   Bound    nfs-pv   10Gi       RWO            local-storage   18s
</span></code></pre></td></tr></table></div></figure>


<h3>启动nfs-server</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 下载镜像要代理的，可以替换image或者下载后改tag
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ cat nfs-server-deployment.yaml
</span><span class='line'>apiVersion: apps/v1
</span><span class='line'>kind: Deployment
</span><span class='line'>metadata:
</span><span class='line'>  name: nfs-server
</span><span class='line'>spec:
</span><span class='line'>  replicas: 1
</span><span class='line'>  selector:
</span><span class='line'>    matchLabels:
</span><span class='line'>      role: nfs-server
</span><span class='line'>  template:
</span><span class='line'>    metadata:
</span><span class='line'>      labels:
</span><span class='line'>        role: nfs-server
</span><span class='line'>    spec:
</span><span class='line'>      containers:
</span><span class='line'>      - name: nfs-server
</span><span class='line'>        image: k8s.gcr.io/volume-nfs:0.8
</span><span class='line'>        ports:
</span><span class='line'>          - name: nfs
</span><span class='line'>            containerPort: 2049
</span><span class='line'>          - name: mountd
</span><span class='line'>            containerPort: 20048
</span><span class='line'>          - name: rpcbind
</span><span class='line'>            containerPort: 111
</span><span class='line'>        securityContext:
</span><span class='line'>          privileged: true
</span><span class='line'>        volumeMounts:
</span><span class='line'>          - mountPath: /exports
</span><span class='line'>            name: mypvc
</span><span class='line'>      volumes:
</span><span class='line'>        - name: mypvc
</span><span class='line'>          persistentVolumeClaim:
</span><span class='line'>            claimName: nfs-pv-provisioning-demo
</span><span class='line'>[ec2-user@k8s nfs]$ cat nfs-server-service.yaml
</span><span class='line'>kind: Service
</span><span class='line'>apiVersion: v1
</span><span class='line'>metadata:
</span><span class='line'>  name: nfs-server
</span><span class='line'>spec:
</span><span class='line'>  ports:
</span><span class='line'>    - name: nfs
</span><span class='line'>      port: 2049
</span><span class='line'>    - name: mountd
</span><span class='line'>      port: 20048
</span><span class='line'>    - name: rpcbind
</span><span class='line'>      port: 111
</span><span class='line'>  selector:
</span><span class='line'>    role: nfs-server
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl apply -f nfs-server-deployment.yaml -f nfs-server-service.yaml -n nfs
</span><span class='line'>deployment.apps/nfs-server created
</span><span class='line'>service/nfs-server created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl get all -n nfs -o wide
</span><span class='line'>NAME                              READY   STATUS    RESTARTS   AGE   IP             NODE   NOMINATED NODE   READINESS GATES
</span><span class='line'>pod/nfs-server-64886b598f-57mnx   1/1     Running   0          18s   10.244.0.146   k8s    &lt;none&gt;           &lt;none&gt;
</span><span class='line'>
</span><span class='line'>NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE   SELECTOR
</span><span class='line'>service/nfs-server   ClusterIP   10.111.29.73   &lt;none&gt;        2049/TCP,20048/TCP,111/TCP   18s   role=nfs-server
</span><span class='line'>
</span><span class='line'>NAME                         READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                      SELECTOR
</span><span class='line'>deployment.apps/nfs-server   1/1     1            1           18s   nfs-server   k8s.gcr.io/volume-nfs:0.8   role=nfs-server
</span><span class='line'>
</span><span class='line'>NAME                                    DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES                      SELECTOR
</span><span class='line'>replicaset.apps/nfs-server-64886b598f   1         1         1       18s   nfs-server   k8s.gcr.io/volume-nfs:0.8   pod-template-hash=64886b598f,role=nfs-server
</span></code></pre></td></tr></table></div></figure>


<p>根据nodeAffinity容器部署在了k8s的机器。</p>

<h3>启动web应用</h3>

<p>创建容器使用的卷：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 不知为何，后面容器挂载卷的时刻识别不了域名... 
</span><span class='line'># mount的时刻可能是在node节点上执行的，所以解析不了域名。
</span><span class='line'># 把主机的 nameserver设置为（/etc/resolv.conf） nameserver 10.96.0.10 就可以了。
</span><span class='line'>[ec2-user@k8s nfs]$ cat nfs-pv.yaml 
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: PersistentVolume
</span><span class='line'>metadata:
</span><span class='line'>  name: nfs
</span><span class='line'>spec:
</span><span class='line'>  capacity:
</span><span class='line'>    storage: 1Mi
</span><span class='line'>  accessModes:
</span><span class='line'>    - ReadWriteMany
</span><span class='line'>  nfs:
</span><span class='line'>    server: nfs-server.nfs.svc.cluster.local
</span><span class='line'>    path: "/"
</span><span class='line'>  mountOptions:
</span><span class='line'>    - nfsvers=4.2
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl apply -f nfs-pv.yaml 
</span><span class='line'>persistentvolume/nfs created
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl get pv nfs
</span><span class='line'>NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
</span><span class='line'>nfs    1Mi        RWX            Retain           Available                                   12s
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ cat nfs-pvc.yaml 
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: PersistentVolumeClaim
</span><span class='line'>metadata:
</span><span class='line'>  name: nfs
</span><span class='line'>spec:
</span><span class='line'>  accessModes:
</span><span class='line'>    - ReadWriteMany
</span><span class='line'>  storageClassName: ""
</span><span class='line'>  resources:
</span><span class='line'>    requests:
</span><span class='line'>      storage: 1Mi
</span><span class='line'>  volumeName: nfs
</span><span class='line'>  
</span><span class='line'># kubectl get pv | tail -n+2 | awk '$5 == "Released" {print $1}' | xargs -I{} kubectl patch pv {} --type='merge' -p '{"spec":{"claimRef": null}}
</span><span class='line'># 
</span><span class='line'># [ec2-user@k8s nfs]$ kubectl patch pv nfs -p '{"spec":{"claimRef": null}}'                
</span><span class='line'># persistentvolume/nfs patched
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl apply -f nfs-pvc.yaml
</span><span class='line'>persistentvolumeclaim/nfs created
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl get pv 
</span><span class='line'>NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                          STORAGECLASS    REASON   AGE
</span><span class='line'>nfs      1Mi        RWX            Retain           Bound    default/nfs                                                 56s
</span><span class='line'>nfs-pv   10Gi       RWO            Delete           Bound    nfs/nfs-pv-provisioning-demo   local-storage            3m8s
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl get pvc -A 
</span><span class='line'>NAMESPACE   NAME                       STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS    AGE
</span><span class='line'>nfs         nfs                        Bound    nfs      1Mi        RWX                            22s
</span><span class='line'>nfs         nfs-pv-provisioning-demo   Bound    nfs-pv   10Gi       RWO            local-storage   3m
</span></code></pre></td></tr></table></div></figure>


<p>部署web应用的容器：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s nfs]$ cat nfs-web-deployment.yaml 
</span><span class='line'># This pod mounts the nfs volume claim into /usr/share/nginx/html and
</span><span class='line'># serves a simple web page.
</span><span class='line'>
</span><span class='line'>apiVersion: apps/v1
</span><span class='line'>kind: Deployment
</span><span class='line'>metadata:
</span><span class='line'>  name: nfs-web
</span><span class='line'>spec:
</span><span class='line'>  replicas: 2
</span><span class='line'>  selector:
</span><span class='line'>    matchLabels:
</span><span class='line'>      role: web-frontend
</span><span class='line'>  template:
</span><span class='line'>    metadata:
</span><span class='line'>      labels:
</span><span class='line'>        role: web-frontend
</span><span class='line'>    spec:
</span><span class='line'>      containers:
</span><span class='line'>      - name: web
</span><span class='line'>        image: nginx
</span><span class='line'>        ports:
</span><span class='line'>          - name: web
</span><span class='line'>            containerPort: 80
</span><span class='line'>        volumeMounts:
</span><span class='line'>            # name must match the volume name below
</span><span class='line'>            - name: nfs
</span><span class='line'>              mountPath: "/usr/share/nginx/html"
</span><span class='line'>      volumes:
</span><span class='line'>      - name: nfs
</span><span class='line'>        persistentVolumeClaim:
</span><span class='line'>          claimName: nfs
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ cat nfs-web-service.yaml
</span><span class='line'>kind: Service
</span><span class='line'>apiVersion: v1
</span><span class='line'>metadata:
</span><span class='line'>  name: nfs-web
</span><span class='line'>spec:
</span><span class='line'>  ports:
</span><span class='line'>    - port: 80
</span><span class='line'>  selector:
</span><span class='line'>    role: web-frontend
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl apply -f nfs-web-deployment.yaml -f nfs-web-service.yaml
</span><span class='line'>deployment.apps/nfs-web created
</span><span class='line'>service/nfs-web created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl get all
</span><span class='line'>NAME                           READY   STATUS    RESTARTS   AGE
</span><span class='line'>pod/nfs-web-5554f77845-6rq5p   1/1     Running   0          4m56s
</span><span class='line'>pod/nfs-web-5554f77845-8r885   1/1     Running   0          4m56s
</span><span class='line'>
</span><span class='line'>NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
</span><span class='line'>service/kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP   33d
</span><span class='line'>service/nfs-web      ClusterIP   10.108.129.153   &lt;none&gt;        80/TCP    4m56s
</span><span class='line'>
</span><span class='line'>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>deployment.apps/nfs-web   2/2     2            2           4m56s
</span><span class='line'>
</span><span class='line'>NAME                                 DESIRED   CURRENT   READY   AGE
</span><span class='line'>replicaset.apps/nfs-web-5554f77845   2         2         2       4m56s
</span></code></pre></td></tr></table></div></figure>


<p>测试：deployment创建两个busybox，会在nfs共享目录下创建修改index.html，内容为：时间和主机名。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s nfs]$ kubectl apply -f nfs-busybox-deployment.yaml 
</span><span class='line'>deployment.apps/nfs-busybox created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs]$ curl nfs-web.default.svc.cluster.local 
</span><span class='line'>Wed Apr 20 00:15:20 UTC 2022
</span><span class='line'>nfs-busybox-55c668489c-dxqcx
</span><span class='line'>[ec2-user@k8s nfs]$ curl nfs-web.default.svc.cluster.local
</span><span class='line'>Wed Apr 20 00:16:51 UTC 2022
</span><span class='line'>nfs-busybox-55c668489c-sl7jz
</span></code></pre></td></tr></table></div></figure>


<h3>清理</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s nfs]$ kubectl delete -f nfs-busybox-deployment.yaml -f nfs-web-deployment.yaml -f nfs-web-service.yaml -f nfs-pvc.yaml -f nfs-pv.yaml 
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl delete ns nfs 
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl delete -f server-pv.yml 
</span></code></pre></td></tr></table></div></figure>


<h2>问题</h2>

<h3>NFS服务器的域名解析不了</h3>

<p>一开始没有改节点的dns，会出现域名解析不了的情况：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s nfs]$ kubectl describe pod nfs-web-7bc965b94f-k6mrj -n nfs 
</span><span class='line'>...
</span><span class='line'>Events:
</span><span class='line'>  Type     Reason       Age               From               Message
</span><span class='line'>  ----     ------       ----              ----               -------
</span><span class='line'>  Normal   Scheduled    43s               default-scheduler  Successfully assigned nfs/nfs-web-7bc965b94f-k6mrj to worker1
</span><span class='line'>  Warning  FailedMount  1s (x7 over 35s)  kubelet            MountVolume.SetUp failed for volume "nfs" : mount failed: exit status 32
</span><span class='line'>Mounting command: mount
</span><span class='line'>Mounting arguments: -t nfs -o nfsvers=4.2 nfs-server.nfs.svc.cluster.local:/ /var/lib/kubelet/pods/03049217-ded3-4d31-86e8-6a13c0f5b12f/volumes/kubernetes.io~nfs/nfs
</span><span class='line'>Output: mount.nfs: Failed to resolve server nfs-server.nfs.svc.cluster.local: Name or service not known
</span><span class='line'>mount.nfs: Operation already in progress
</span></code></pre></td></tr></table></div></figure>


<p>容器内是可以通过域名访问的，mount的时刻可能是在node节点上执行的，所以解析不了域名。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl run -ti test --rm --image busybox -n nfs -- sh  
</span><span class='line'>/ # ping nfs-server.nfs.svc.cluster.local
</span><span class='line'>[ec2-user@k8s nfs]$ kubectl run -ti test --rm --image busybox -- sh
</span><span class='line'>
</span><span class='line'>/ # cat /etc/resolv.conf 
</span><span class='line'>nameserver 10.96.0.10
</span><span class='line'>search default.svc.cluster.local svc.cluster.local cluster.local localdomain
</span><span class='line'>options ndots:5
</span></code></pre></td></tr></table></div></figure>


<p>把所有节点的dns设置为 kube-dns 的 10.96.0.10 就可以了。</p>

<h3>集群出问题</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s nfs]$ kubectl get pods -A 
</span><span class='line'>,,,
</span><span class='line'>ingress-nginx          ingress-nginx-controller-755447bb4d-55hjz    0/1     CrashLoopBackOff       32 (2m19s ago)   17d
</span><span class='line'>kube-system            coredns-64897985d-4d5rx                      0/1     CrashLoopBackOff       40 (4m30s ago)   33d
</span><span class='line'>kube-system            coredns-64897985d-m9p9q                      0/1     CrashLoopBackOff       40 (4m15s ago)   33d
</span><span class='line'>,,,
</span><span class='line'>kubernetes-dashboard   dashboard-metrics-scraper-799d786dbf-rj8rl   0/1     CrashLoopBackOff       33 (116s ago)    17d
</span><span class='line'>kubernetes-dashboard   kubernetes-dashboard-fb8648fd9-22krh         0/1     CrashLoopBackOff       32 (3m35s ago)   17d
</span></code></pre></td></tr></table></div></figure>


<p>把所有的容器都清理了，然后重启服务器（或者kubelet）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s nfs]$ docker ps -a |  awk '{print $1}' | while read i ; do docker rm -f $i ; done 
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/04/14/k8s-nfs/">k8s共享存储使用NFS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-04-14T01:23:14+08:00" pubdate data-updated="true">Thu 2022-04-14 01:23</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>容器中的应用数据得保存下来，使用local/hostPath可以临时用用，还是得有一个共享的存储。</p>

<ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#volume-types">https://kubernetes.io/zh/docs/concepts/storage/volumes/#volume-types</a></li>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/_print/#types-of-persistent-volumes">https://kubernetes.io/zh/docs/concepts/storage/_print/#types-of-persistent-volumes</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner">https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath">https://kubernetes.io/docs/concepts/storage/volumes/#hostpath</a></li>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#local">https://kubernetes.io/zh/docs/concepts/storage/volumes/#local</a></li>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#cephfs">https://kubernetes.io/zh/docs/concepts/storage/volumes/#cephfs</a></li>
</ul>


<p>先使用最简单的NFS分区/卷。</p>

<ul>
<li><a href="http://www.lishuai.fun/2021/08/12/k8s-nfs-pv">http://www.lishuai.fun/2021/08/12/k8s-nfs-pv</a></li>
</ul>


<h2>安装NFS server on aws ec2</h2>

<ul>
<li><a href="https://segmentfault.com/a/1190000024512057">https://segmentfault.com/a/1190000024512057</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#所有node节点安装nfs客户端
</span><span class='line'>#yum -y install nfs-utils
</span><span class='line'>#systemctl start nfs && systemctl enable nfs
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ sudo yum install nfs-utils 
</span><span class='line'>Loaded plugins: langpacks, priorities, update-motd
</span><span class='line'>amzn2-core                                                                                                                     | 3.7 kB  00:00:00     
</span><span class='line'>Package 1:nfs-utils-1.3.0-0.54.amzn2.0.2.x86_64 already installed and latest version
</span><span class='line'>Nothing to do
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ sudo mkdir /backup
</span><span class='line'>[ec2-user@k8s ~]$ sudo chmod -R 755 /backup
</span><span class='line'>[ec2-user@k8s ~]$ sudo chown nfsnobody:nfsnobody /backup
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ sudo vi /etc/exports
</span><span class='line'>[ec2-user@k8s ~]$ cat /etc/exports    
</span><span class='line'>/backup 192.168.191.0/24(rw,sync,no_root_squash,no_all_squash)
</span><span class='line'>
</span><span class='line'># /k8s-fs *(rw,sync,no_root_squash,no_all_squash)
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ sudo service nfs-server restart 
</span><span class='line'>Redirecting to /bin/systemctl restart nfs-server.service
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>[ec2-user@k8s ~]$ sudo exportfs
</span><span class='line'>/backup         192.168.191.0/24
</span><span class='line'>[ec2-user@k8s ~]$ sudo exportfs -arv 
</span><span class='line'>exporting 192.168.191.0/24:/backup
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ rpcinfo -p localhost
</span><span class='line'>   program vers proto   port  service
</span><span class='line'>    100000    4   tcp    111  portmapper
</span><span class='line'>    100000    3   tcp    111  portmapper
</span><span class='line'>    100000    2   tcp    111  portmapper
</span><span class='line'>    100000    4   udp    111  portmapper
</span><span class='line'>    100000    3   udp    111  portmapper
</span><span class='line'>    100000    2   udp    111  portmapper
</span><span class='line'>    100024    1   udp  56847  status
</span><span class='line'>    100024    1   tcp  60971  status
</span><span class='line'>    100005    1   udp  20048  mountd
</span><span class='line'>    100005    1   tcp  20048  mountd
</span><span class='line'>    100005    2   udp  20048  mountd
</span><span class='line'>    100005    2   tcp  20048  mountd
</span><span class='line'>    100005    3   udp  20048  mountd
</span><span class='line'>    100005    3   tcp  20048  mountd
</span><span class='line'>    100003    3   tcp   2049  nfs
</span><span class='line'>    100003    4   tcp   2049  nfs
</span><span class='line'>    100227    3   tcp   2049  nfs_acl
</span><span class='line'>    100003    3   udp   2049  nfs
</span><span class='line'>    100227    3   udp   2049  nfs_acl
</span><span class='line'>    100021    1   udp  47545  nlockmgr
</span><span class='line'>    100021    3   udp  47545  nlockmgr
</span><span class='line'>    100021    4   udp  47545  nlockmgr
</span><span class='line'>    100021    1   tcp  40703  nlockmgr
</span><span class='line'>    100021    3   tcp  40703  nlockmgr
</span><span class='line'>    100021    4   tcp  40703  nlockmgr
</span><span class='line'>[ec2-user@k8s ~]$ showmount -e 192.168.191.131
</span><span class='line'>Export list for 192.168.191.131:
</span><span class='line'>/backup 192.168.191.0/24
</span></code></pre></td></tr></table></div></figure>


<p>也可以通过docker来启动nfs server：</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/2020/09/20/setup-a-nfs-server-with-docker/">https://blog.ruanbekker.com/blog/2020/09/20/setup-a-nfs-server-with-docker/</a></li>
<li><a href="https://westzq1.github.io/k8s/2019/06/28/nfs-server-on-K8S.html">https://westzq1.github.io/k8s/2019/06/28/nfs-server-on-K8S.html</a></li>
<li><a href="https://github.com/kubernetes/examples/blob/master/staging/volumes/nfs/nfs-server-deployment.yaml">https://github.com/kubernetes/examples/blob/master/staging/volumes/nfs/nfs-server-deployment.yaml</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ sudo mkdir -p /data/kubernetes-volumes
</span><span class='line'>[ec2-user@k8s ~]$ docker run --privileged -itd --name nfs -p 2049:2049 -e SHARED_DIRECTORY=/data -v /data/kubernetes-volumes:/data itsthenetwork/nfs-server-alpine:12 
</span><span class='line'>f84b70dcca6bd5abb275fbee50fd161d8befdd709ce6523b3a514f04b7af8677
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ docker logs f84b70dcca6bd5abb2 
</span><span class='line'>Writing SHARED_DIRECTORY to /etc/exports file
</span><span class='line'>The PERMITTED environment variable is unset or null, defaulting to '*'.
</span><span class='line'>This means any client can mount.
</span><span class='line'>The READ_ONLY environment variable is unset or null, defaulting to 'rw'.
</span><span class='line'>Clients have read/write access.
</span><span class='line'>The SYNC environment variable is unset or null, defaulting to 'async' mode.
</span><span class='line'>Writes will not be immediately written to disk.
</span><span class='line'>Displaying /etc/exports contents:
</span><span class='line'>/data *(rw,fsid=0,async,no_subtree_check,no_auth_nlm,insecure,no_root_squash)
</span><span class='line'>
</span><span class='line'>Starting rpcbind...
</span><span class='line'>Displaying rpcbind status...
</span><span class='line'>   program version netid     address                service    owner
</span><span class='line'>    100000    4    tcp6      ::.0.111               -          superuser
</span><span class='line'>    100000    3    tcp6      ::.0.111               -          superuser
</span><span class='line'>    100000    4    udp6      ::.0.111               -          superuser
</span><span class='line'>    100000    3    udp6      ::.0.111               -          superuser
</span><span class='line'>    100000    4    tcp       0.0.0.0.0.111          -          superuser
</span><span class='line'>    100000    3    tcp       0.0.0.0.0.111          -          superuser
</span><span class='line'>    100000    2    tcp       0.0.0.0.0.111          -          superuser
</span><span class='line'>    100000    4    udp       0.0.0.0.0.111          -          superuser
</span><span class='line'>    100000    3    udp       0.0.0.0.0.111          -          superuser
</span><span class='line'>    100000    2    udp       0.0.0.0.0.111          -          superuser
</span><span class='line'>    100000    4    local     /var/run/rpcbind.sock  -          superuser
</span><span class='line'>    100000    3    local     /var/run/rpcbind.sock  -          superuser
</span><span class='line'>Starting NFS in the background...
</span><span class='line'>rpc.nfsd: knfsd is currently down
</span><span class='line'>rpc.nfsd: Writing version string to kernel: -2 -3 +4 +4.1 +4.2
</span><span class='line'>rpc.nfsd: Created AF_INET TCP socket.
</span><span class='line'>rpc.nfsd: Created AF_INET6 TCP socket.
</span><span class='line'>Exporting File System...
</span><span class='line'>exporting *:/data
</span><span class='line'>/data           &lt;world&gt;
</span><span class='line'>Starting Mountd in the background...These
</span><span class='line'>Startup successful.
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ sudo mount -v -o vers=4,loud 127.0.0.1:/ nfsmnt
</span><span class='line'>mount.nfs: timeout set for Thu Apr 14 08:26:48 2022
</span><span class='line'>mount.nfs: trying text-based options 'vers=4.1,addr=127.0.0.1,clientaddr=127.0.0.1'
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ df -h | grep nfsmnt
</span><span class='line'>127.0.0.1:/      25G  9.8G   16G  39% /home/ec2-user/nfsmnt
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ touch nfsmnt/$(hostname).txt
</span><span class='line'>[ec2-user@k8s ~]$ ls -l nfsmnt/
</span><span class='line'>total 0
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user 0 Apr 14 08:25 k8s.txt
</span><span class='line'>[ec2-user@k8s ~]$ ls -l /data/kubernetes-volumes/
</span><span class='line'>total 0
</span><span class='line'>-rw-rw-r-- 1 ec2-user ec2-user 0 Apr 14 08:25 k8s.txt
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>
</span><span class='line'># vi /etc/fstab
</span><span class='line'># 192.168.0.4:/   /mnt   nfs4    _netdev,auto  0  0
</span><span class='line'>
</span><span class='line'>### pod
</span><span class='line'># kubectl create -f nfs-server.yml
</span><span class='line'>apiVersion: extensions/v1beta1
</span><span class='line'>kind: Deployment
</span><span class='line'>metadata:
</span><span class='line'>  name: nfs-server
</span><span class='line'>spec:
</span><span class='line'>  replicas: 1           # &lt;- no more replicas
</span><span class='line'>  template:
</span><span class='line'>    metadata:
</span><span class='line'>      labels:
</span><span class='line'>        app: nfs-server
</span><span class='line'>    spec:
</span><span class='line'>      nodeSelector:     # &lt;- use selector to fix nfs-server on k8s2.zhangqiaoc.com
</span><span class='line'>        kubernetes.io/hostname: k8s2.zhangqiaoc.com
</span><span class='line'>      containers:
</span><span class='line'>      - name: nfs-server
</span><span class='line'>        image: itsthenetwork/nfs-server-alpine:latest
</span><span class='line'>        volumeMounts:
</span><span class='line'>        - name: nfs-storage
</span><span class='line'>          mountPath: /nfsshare
</span><span class='line'>        env:
</span><span class='line'>        - name: SHARED_DIRECTORY
</span><span class='line'>          value: "/nfsshare"
</span><span class='line'>        ports:
</span><span class='line'>        - name: nfs  
</span><span class='line'>          containerPort: 2049   # &lt;- export port
</span><span class='line'>        securityContext:
</span><span class='line'>          privileged: true      # &lt;- privileged mode is mandentory.
</span><span class='line'>      volumes:
</span><span class='line'>      - name: nfs-storage  
</span><span class='line'>        hostPath:               # &lt;- the folder on the host machine.
</span><span class='line'>          path: /root/fileshare
</span><span class='line'># kubectl expose deployment nfs-server --type=ClusterIP
</span><span class='line'># kubectl get svc
</span><span class='line'>
</span><span class='line'># yum install -y nfs-utils
</span><span class='line'># mkdir /root/nfsmnt
</span><span class='line'># mount -v 10.101.117.226:/ /root/nfsmnt
</span></code></pre></td></tr></table></div></figure>


<p>client</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 所有work节点安装 nfs-utils rpcbind
</span><span class='line'>[ec2-user@worker1 ~]$ sudo yum install nfs-utils 
</span><span class='line'>Loaded plugins: langpacks, priorities, update-motd
</span><span class='line'>amzn2-core                                                                                                                                        | 3.7 kB  00:00:00     
</span><span class='line'>Package 1:nfs-utils-1.3.0-0.54.amzn2.0.2.x86_64 already installed and latest version
</span><span class='line'>Nothing to do
</span><span class='line'>
</span><span class='line'>[ec2-user@worker1 ~]$ sudo systemctl status nfs
</span><span class='line'>● nfs-server.service - NFS server and services
</span><span class='line'>   Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; disabled; vendor preset: disabled)
</span><span class='line'>   Active: inactive (dead)
</span><span class='line'>[ec2-user@worker1 ~]$ sudo systemctl status rpcbind
</span><span class='line'>● rpcbind.service - RPC bind service
</span><span class='line'>   Loaded: loaded (/usr/lib/systemd/system/rpcbind.service; enabled; vendor preset: enabled)
</span><span class='line'>   Active: active (running) since Wed 2022-04-13 20:44:34 CST; 1h 51min ago
</span><span class='line'>  Process: 6979 ExecStart=/sbin/rpcbind -w $RPCBIND_ARGS (code=exited, status=0/SUCCESS)
</span><span class='line'> Main PID: 7025 (rpcbind)
</span><span class='line'>    Tasks: 1
</span><span class='line'>   Memory: 2.1M
</span><span class='line'>   CGroup: /system.slice/rpcbind.service
</span><span class='line'>           └─7025 /sbin/rpcbind -w
</span><span class='line'>
</span><span class='line'>Apr 13 20:44:34 worker1 systemd[1]: Starting RPC bind service...
</span><span class='line'>Apr 13 20:44:34 worker1 systemd[1]: Started RPC bind service.
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@worker1 ~]$ sudo mkdir -p /data
</span><span class='line'>[ec2-user@worker1 ~]$ sudo chmod 777 /data 
</span><span class='line'>[ec2-user@worker1 ~]$ sudo mount -t nfs 192.168.191.131:/backup /data
</span><span class='line'>[ec2-user@worker1 ~]$ df -h | grep 192.168.191.131
</span><span class='line'>192.168.191.131:/backup   25G  9.6G   16G  39% /data
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># vi /etc/fstab
</span><span class='line'># 172.17.30.22:/backup /data nfs defaults 0 0
</span></code></pre></td></tr></table></div></figure>


<h2>k8s中使用NFS</h2>

<ul>
<li><a href="http://www.lishuai.fun/2021/08/12/k8s-nfs-pv/">http://www.lishuai.fun/2021/08/12/k8s-nfs-pv/</a></li>
</ul>


<h3>容器直接挂载NFS</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ cat nginx-1.yml 
</span><span class='line'>apiVersion: apps/v1
</span><span class='line'>kind: Deployment
</span><span class='line'>metadata:
</span><span class='line'>  name: nginx-deployment
</span><span class='line'>  labels:
</span><span class='line'>    app: nginx
</span><span class='line'>spec:
</span><span class='line'>  replicas: 3
</span><span class='line'>  selector:
</span><span class='line'>    matchLabels:
</span><span class='line'>      app: nginx
</span><span class='line'>  template:
</span><span class='line'>    metadata:
</span><span class='line'>      labels:
</span><span class='line'>        app: nginx
</span><span class='line'>    spec:
</span><span class='line'>      containers:
</span><span class='line'>      - name: nginx
</span><span class='line'>        image: nginx:1.14.2
</span><span class='line'>        ports:
</span><span class='line'>        - containerPort: 80
</span><span class='line'>        volumeMounts:
</span><span class='line'>        - name: data
</span><span class='line'>          mountPath: /usr/share/nginx/html
</span><span class='line'>      volumes:
</span><span class='line'>      - name: data
</span><span class='line'>        nfs:
</span><span class='line'>          path: /backup
</span><span class='line'>          server: 192.168.191.131
</span><span class='line'>        
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f nginx-1.yml
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get all 
</span><span class='line'>NAME                                   READY   STATUS    RESTARTS   AGE
</span><span class='line'>pod/nginx-deployment-67dcb957c-g2h8x   1/1     Running   0          2m50s
</span><span class='line'>pod/nginx-deployment-67dcb957c-gfv28   1/1     Running   0          2m50s
</span><span class='line'>pod/nginx-deployment-67dcb957c-rqwjs   1/1     Running   0          2m50s
</span><span class='line'>
</span><span class='line'>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
</span><span class='line'>service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   27d
</span><span class='line'>
</span><span class='line'>NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>deployment.apps/nginx-deployment   3/3     3            3           2m50s
</span><span class='line'>
</span><span class='line'>NAME                                         DESIRED   CURRENT   READY   AGE
</span><span class='line'>replicaset.apps/nginx-deployment-67dcb957c   3         3         3       2m50s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl exec -ti pod/nginx-deployment-67dcb957c-g2h8x -- bash 
</span><span class='line'>root@nginx-deployment-67dcb957c-g2h8x:/# echo $(hostname) &gt;/usr/share/nginx/html/1.txt
</span><span class='line'>
</span><span class='line'>root@nginx-deployment-67dcb957c-g2h8x:/# mount | grep 192
</span><span class='line'>192.168.191.131:/backup on /usr/share/nginx/html type nfs4 (rw,relatime,vers=4.1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=192.168.191.132,local_lock=none,addr=192.168.191.131)
</span><span class='line'>root@nginx-deployment-67dcb957c-g2h8x:/# 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 服务端查看文件内容
</span><span class='line'>[ec2-user@k8s ~]$ cat /backup/1.txt 
</span><span class='line'>nginx-deployment-67dcb957c-g2h8x
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl delete -f nginx-1.yml 
</span><span class='line'>deployment.apps "nginx-deployment" deleted
</span></code></pre></td></tr></table></div></figure>


<h3>pvc</h3>

<ul>
<li><a href="https://segmentfault.com/a/1190000040785500">https://segmentfault.com/a/1190000040785500</a></li>
<li><a href="http://www.lishuai.fun/2021/08/12/k8s-nfs-pv/#%E5%88%9B%E5%BB%BA%E7%B1%BB%E5%9E%8B%E4%B8%BAnfs%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%E5%8D%B7">http://www.lishuai.fun/2021/08/12/k8s-nfs-pv/#%E5%88%9B%E5%BB%BA%E7%B1%BB%E5%9E%8B%E4%B8%BAnfs%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%E5%8D%B7</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ vi pv-nfs.yaml 
</span><span class='line'>[ec2-user@k8s ~]$ cat pv-nfs.yaml 
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: PersistentVolume
</span><span class='line'>metadata:
</span><span class='line'>  name: pv-nfs
</span><span class='line'>spec:
</span><span class='line'>  capacity:
</span><span class='line'>    storage: 10Gi
</span><span class='line'>  accessModes:
</span><span class='line'>    - ReadWriteMany 
</span><span class='line'>  nfs:
</span><span class='line'>    path: /backup
</span><span class='line'>    server: 192.168.191.131
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f pv-nfs.yaml 
</span><span class='line'>persistentvolume/pv-nfs created
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pv 
</span><span class='line'>NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
</span><span class='line'>pv-nfs   10Gi       RWX            Retain           Available                                   5s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ vi pvc-nfs.yaml 
</span><span class='line'>[ec2-user@k8s ~]$ cat pvc-nfs.yaml 
</span><span class='line'>kind: PersistentVolumeClaim
</span><span class='line'>apiVersion: v1
</span><span class='line'>metadata:
</span><span class='line'>  name: pvc-nfs
</span><span class='line'>spec:
</span><span class='line'>  accessModes:
</span><span class='line'>    - ReadWriteMany
</span><span class='line'>  resources:
</span><span class='line'>    requests:
</span><span class='line'>      storage: 10Gi
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f pvc-nfs.yaml 
</span><span class='line'>persistentvolumeclaim/pvc-nfs created
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pvc
</span><span class='line'>NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
</span><span class='line'>pvc-nfs   Bound    pv-nfs   10Gi       RWX                           7s
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pv 
</span><span class='line'>NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM             STORAGECLASS   REASON   AGE
</span><span class='line'>pv-nfs   10Gi       RWX            Retain           Bound    default/pvc-nfs                           79s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ vi dp-pvc.yaml
</span><span class='line'>[ec2-user@k8s ~]$ cat dp-pvc.yaml 
</span><span class='line'>apiVersion: apps/v1
</span><span class='line'>kind: Deployment
</span><span class='line'>metadata:
</span><span class='line'>  name: busybox
</span><span class='line'>  labels:
</span><span class='line'>    app: busybox
</span><span class='line'>spec:
</span><span class='line'>  replicas: 1
</span><span class='line'>  selector:
</span><span class='line'>    matchLabels:
</span><span class='line'>      app: busybox
</span><span class='line'>  template:
</span><span class='line'>    metadata:
</span><span class='line'>      labels:
</span><span class='line'>        app: busybox
</span><span class='line'>    spec:
</span><span class='line'>      containers:
</span><span class='line'>      - name: busybox
</span><span class='line'>        image: busybox
</span><span class='line'>        command: ['sh', '-c', 'echo "Hello, Kubernetes!" && sleep 3600']
</span><span class='line'>        volumeMounts:
</span><span class='line'>        - name: data
</span><span class='line'>          mountPath: /data
</span><span class='line'>      volumes:
</span><span class='line'>      - name: data
</span><span class='line'>        persistentVolumeClaim:
</span><span class='line'>          claimName: pvc-nfs
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f dp-pvc.yaml 
</span><span class='line'>deployment.apps/busybox created
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get all 
</span><span class='line'>NAME                           READY   STATUS    RESTARTS   AGE
</span><span class='line'>pod/busybox-6b99c495c9-qnvlp   1/1     Running   0          47s
</span><span class='line'>
</span><span class='line'>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
</span><span class='line'>service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   27d
</span><span class='line'>
</span><span class='line'>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>deployment.apps/busybox   1/1     1            1           47s
</span><span class='line'>
</span><span class='line'>NAME                                 DESIRED   CURRENT   READY   AGE
</span><span class='line'>replicaset.apps/busybox-6b99c495c9   1         1         1       47s
</span><span class='line'>
</span><span class='line'># 查看NFS中原来的数据
</span><span class='line'>[ec2-user@k8s ~]$ kubectl exec -ti busybox-6b99c495c9-qnvlp -- cat /data/1.txt 
</span><span class='line'>nginx-deployment-67dcb957c-g2h8x
</span></code></pre></td></tr></table></div></figure>


<p>测一下subPathExpr：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl delete -f dp-pvc.yaml 
</span><span class='line'>deployment.apps "busybox" deleted
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>[ec2-user@k8s ~]$ vi dp-pvc.yaml 
</span><span class='line'>[ec2-user@k8s ~]$ cat dp-pvc.yaml 
</span><span class='line'>apiVersion: apps/v1
</span><span class='line'>kind: Deployment
</span><span class='line'>metadata:
</span><span class='line'>  name: busybox
</span><span class='line'>  labels:
</span><span class='line'>    app: busybox
</span><span class='line'>spec:
</span><span class='line'>  replicas: 1
</span><span class='line'>  selector:
</span><span class='line'>    matchLabels:
</span><span class='line'>      app: busybox
</span><span class='line'>  template:
</span><span class='line'>    metadata:
</span><span class='line'>      labels:
</span><span class='line'>        app: busybox
</span><span class='line'>    spec:
</span><span class='line'>      containers:
</span><span class='line'>      - name: busybox
</span><span class='line'>        image: busybox
</span><span class='line'>        command: ['sh', '-c', 'echo "Hello, Kubernetes!" && sleep 3600']
</span><span class='line'>        env:
</span><span class='line'>        - name: POD_NAME
</span><span class='line'>          valueFrom:
</span><span class='line'>            fieldRef:
</span><span class='line'>              apiVersion: v1
</span><span class='line'>              fieldPath: metadata.name
</span><span class='line'>        volumeMounts:
</span><span class='line'>        - name: data
</span><span class='line'>          mountPath: /data
</span><span class='line'>          subPathExpr: $(POD_NAME)
</span><span class='line'>      volumes:
</span><span class='line'>      - name: data
</span><span class='line'>        persistentVolumeClaim:
</span><span class='line'>          claimName: pvc-nfs
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f dp-pvc.yaml 
</span><span class='line'>deployment.apps/busybox created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get all 
</span><span class='line'>NAME                           READY   STATUS    RESTARTS   AGE
</span><span class='line'>pod/busybox-5497486bf5-csr6q   1/1     Running   0          7s
</span><span class='line'>
</span><span class='line'>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
</span><span class='line'>service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   27d
</span><span class='line'>
</span><span class='line'>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>deployment.apps/busybox   1/1     1            1           7s
</span><span class='line'>
</span><span class='line'>NAME                                 DESIRED   CURRENT   READY   AGE
</span><span class='line'>replicaset.apps/busybox-5497486bf5   1         1         1       7s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl exec -ti pod/busybox-5497486bf5-csr6q -- sh 
</span><span class='line'>/ # ls /data
</span><span class='line'>/ # echo $(hostname) &gt; /data/pvc.txt
</span><span class='line'>/ # exit
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 查看服务端目录下数据
</span><span class='line'>[ec2-user@k8s ~]$ ll /backup/
</span><span class='line'>total 4
</span><span class='line'>-rw-r--r-- 1 root root 33 Apr 14 00:37 1.txt
</span><span class='line'>drwxr-xr-x 2 root root 21 Apr 14 00:51 busybox-5497486bf5-csr6q
</span><span class='line'>[ec2-user@k8s ~]$ cat /backup/busybox-5497486bf5-csr6q/pvc.txt   
</span><span class='line'>busybox-5497486bf5-csr6q
</span></code></pre></td></tr></table></div></figure>


<p>把replicas改成2，再试试：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f dp-pvc.yaml 
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods
</span><span class='line'>NAME                       READY   STATUS    RESTARTS   AGE
</span><span class='line'>busybox-5497486bf5-fkzls   1/1     Running   0          3m8s
</span><span class='line'>busybox-5497486bf5-rv7k7   1/1     Running   0          3m8s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl exec busybox-5497486bf5-fkzls -- sh -c 'echo $(hostname) &gt;/data/$(hostname).txt'
</span><span class='line'>[ec2-user@k8s ~]$ kubectl exec busybox-5497486bf5-rv7k7 -- sh -c 'echo $(hostname) &gt;/data/$(hostname).txt'                        
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 查看服务端目录结构
</span><span class='line'>[ec2-user@k8s ~]$ ll -R /backup/
</span><span class='line'>/backup/:
</span><span class='line'>total 4
</span><span class='line'>-rw-r--r-- 1 root root 33 Apr 14 00:37 1.txt
</span><span class='line'>drwxr-xr-x 2 root root 21 Apr 14 00:51 busybox-5497486bf5-csr6q
</span><span class='line'>drwxr-xr-x 2 root root 42 Apr 14 01:20 busybox-5497486bf5-fkzls
</span><span class='line'>drwxr-xr-x 2 root root 42 Apr 14 01:20 busybox-5497486bf5-rv7k7
</span><span class='line'>
</span><span class='line'>/backup/busybox-5497486bf5-csr6q:
</span><span class='line'>total 4
</span><span class='line'>-rw-r--r-- 1 root root 25 Apr 14 00:51 pvc.txt
</span><span class='line'>
</span><span class='line'>/backup/busybox-5497486bf5-fkzls:
</span><span class='line'>total 4
</span><span class='line'>-rw-r--r-- 1 root root 25 Apr 14 01:20 busybox-5497486bf5-fkzls.txt
</span><span class='line'>
</span><span class='line'>/backup/busybox-5497486bf5-rv7k7:
</span><span class='line'>total 4
</span><span class='line'>-rw-r--r-- 1 root root 25 Apr 14 01:20 busybox-5497486bf5-rv7k7.txt
</span><span class='line'>[ec2-user@k8s ~]$ 
</span></code></pre></td></tr></table></div></figure>


<h3>NFS Subdir External Provisioner</h3>

<ul>
<li><a href="http://www.lishuai.fun/2021/08/12/k8s-nfs-pv/#NFS-Subdir-External-Provisioner">http://www.lishuai.fun/2021/08/12/k8s-nfs-pv/#NFS-Subdir-External-Provisioner</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#nfs">https://kubernetes.io/docs/concepts/storage/storage-classes/#nfs</a></li>
<li><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</a></li>
</ul>


<p>NFS subdir external provisioner 使用现有的的NFS 服务器来支持通过 Persistent Volume Claims 动态供应 Kubernetes Persistent Volumes。持久卷默认被配置为${namespace}-${pvcName}-${pvName}，使用这个必须已经拥有 NFS 服务器。</p>

<ul>
<li><a href="http://dockone.io/article/2598">http://dockone.io/article/2598</a> External NFS驱动的工作原理</li>
</ul>


<blockquote><p>K8S的外部NFS驱动，可以按照其工作方式（是作为NFS server还是NFS client）分为两类：</p>

<p>1.nfs-client:</p>

<p>也就是我们接下来演示的这一类，它通过K8S的内置的NFS驱动挂载远端的NFS服务器到本地目录；然后将自身作为storage provider，关联storage class。当用户创建对应的PVC来申请PV时，该provider就将PVC的要求与自身的属性比较，一旦满足就在本地挂载好的NFS目录中创建PV所属的子目录，为Pod提供动态的存储服务。</p>

<p>2.nfs:
与nfs-client不同，该驱动并不使用k8s的NFS驱动来挂载远端的NFS到本地再分配，而是直接将本地文件映射到容器内部，然后在容器内使用ganesha.nfsd来对外提供NFS服务；在每次创建PV的时候，直接在本地的NFS根目录中创建对应文件夹，并export出该子目录。</p>

<p>接下来我们来操作一个nfs-client驱动的例子，先对其有个直观的认识！</p>

<p>External NFS驱动的部署实例</p>

<p>这里，我们将nfs-client驱动做一个deployment部署到K8S集群中，然后对外提供存储服务。</p>

<p>1.部署nfs-client-provisioner</p>

<p>环境变量的PROVISIONER_NAME、NFS服务器地址、NFS对外提供服务的路径信息等需要设置好；部署所使用的yaml文件关键代码如下所示：</p>

<p>2.创建Storage Class</p>

<p>storage class的定义，需要注意的是：provisioner属性要等于驱动所传入的环境变量PROVISIONER_NAME的值。否则，驱动不知道知道如何绑定storage class。</p>

<p>3.创建PVC</p>

<p>这里指定了其对应的storage-class的名字为wise2c-nfs-storage，如下：</p>

<p>4.创建pod</p>

<p>指定该pod使用我们刚刚创建的PVC：henry-claim：</p>

<p>完成之后，如果attach到pod中执行一些文件的读写操作，就可以确定pod的/mnt已经使用了NFS的存储服务了。</p></blockquote>

<ul>
<li><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner#without-helm">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner#without-helm</a></li>
</ul>


<p>官方文档中的脚本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Set the subject of the RBAC objects to the current namespace where the provisioner is being deployed
</span><span class='line'>$ NS=$(kubectl config get-contexts|grep -e "^\*" |awk '{print $5}')
</span><span class='line'>$ NAMESPACE=${NS:-default}
</span><span class='line'>$ sed -i'' "s/namespace:.*/namespace: $NAMESPACE/g" ./deploy/rbac.yaml ./deploy/deployment.yaml
</span><span class='line'>$ kubectl create -f deploy/rbac.yaml</span></code></pre></td></tr></table></div></figure>


<p>操作步骤：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ git clone https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/
</span><span class='line'>[ec2-user@k8s ~]$ cd nfs-subdir-external-provisioner/
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs-subdir-external-provisioner]$ NS=$(kubectl config get-contexts|grep -e "^\*" |awk '{print $5}')
</span><span class='line'>[ec2-user@k8s nfs-subdir-external-provisioner]$ NAMESPACE=${NS:-default}
</span><span class='line'>[ec2-user@k8s nfs-subdir-external-provisioner]$ sed -i'' "s/namespace:.*/namespace: $NAMESPACE/g" ./deploy/rbac.yaml ./deploy/deployment.yaml
</span><span class='line'>[ec2-user@k8s nfs-subdir-external-provisioner]$ kubectl create -f deploy/rbac.yaml
</span><span class='line'>serviceaccount/nfs-client-provisioner created
</span><span class='line'>clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created
</span><span class='line'>clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created
</span><span class='line'>role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created
</span><span class='line'>rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>$ vi deploy/deployment.yaml
</span><span class='line'>
</span><span class='line'>            - name: NFS_SERVER
</span><span class='line'>              value: 192.168.191.131
</span><span class='line'>            - name: NFS_PATH
</span><span class='line'>              value: /backup
</span><span class='line'>      volumes:
</span><span class='line'>        - name: nfs-client-root
</span><span class='line'>          nfs:
</span><span class='line'>            server: 192.168.191.131
</span><span class='line'>            path: /backup
</span><span class='line'>
</span><span class='line'>$ vi deploy/class.yaml
</span><span class='line'>
</span><span class='line'>parameters:
</span><span class='line'>  archiveOnDelete: "false"
</span><span class='line'>#Specifies a template for creating a directory path via PVC metadata's such as labels, annotations, name or namespace. To specify metadata use ${.PVC.&lt;metadata&gt;}. Example: If folder should be named like &lt;pvc-namespace&gt;-&lt;pvc-name&gt;, use ${.PVC.namespace}-${.PVC.name} as pathPattern.
</span><span class='line'>#  pathPattern: "${.PVC.namespace}/${.PVC.annotations.nfs.io/storage-path}" # waits for nfs.io/storage-path annotation, if not specified will accept as empty string.
</span><span class='line'>#  onDelete: delete
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 先把镜像拉下来 k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs-subdir-external-provisioner]$ kubectl apply -f deploy/deployment.yaml 
</span><span class='line'>deployment.apps/nfs-client-provisioner created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs-subdir-external-provisioner]$ kubectl apply -f deploy/class.yaml 
</span><span class='line'>storageclass.storage.k8s.io/nfs-client created
</span><span class='line'>[ec2-user@k8s nfs-subdir-external-provisioner]$
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>测试：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># PVC内容
</span><span class='line'># https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/blob/master/deploy/test-claim.yaml
</span><span class='line'>kind: PersistentVolumeClaim
</span><span class='line'>apiVersion: v1
</span><span class='line'>metadata:
</span><span class='line'>  name: test-claim
</span><span class='line'>spec:
</span><span class='line'>  storageClassName: nfs-client
</span><span class='line'>  accessModes:
</span><span class='line'>    - ReadWriteMany
</span><span class='line'>  resources:
</span><span class='line'>    requests:
</span><span class='line'>      storage: 1Mi
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s nfs-subdir-external-provisioner]$ kubectl create -f deploy/test-claim.yaml -f deploy/test-pod.yaml
</span><span class='line'>persistentvolumeclaim/test-claim created
</span><span class='line'>pod/test-pod created
</span><span class='line'>
</span><span class='line'># kubectl delete -f deploy/test-pod.yaml -f deploy/test-claim.yaml
</span></code></pre></td></tr></table></div></figure>


<p><code>test pod</code> 在共享文件系统下写了一个 <code>touch /mnt/SUCCESS</code> 文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s nfs-subdir-external-provisioner]$ ll /backup/default-test-claim-pvc-9857153a-6c2b-42d7-b464-aa5fc2acbf90/
</span><span class='line'>total 0
</span><span class='line'>-rw-r--r-- 1 root root 0 Apr 14 02:14 SUCCESS
</span></code></pre></td></tr></table></div></figure>


<h3>NFS Ganesha server and external provisioner</h3>

<ul>
<li><a href="https://github.com/kubernetes-sigs/nfs-ganesha-server-and-external-provisioner">https://github.com/kubernetes-sigs/nfs-ganesha-server-and-external-provisioner</a></li>
<li><a href="http://www.lishuai.fun/2021/08/12/k8s-nfs-pv/#nfs-ganesha-server-and-external-provisioner">http://www.lishuai.fun/2021/08/12/k8s-nfs-pv/#nfs-ganesha-server-and-external-provisioner</a></li>
</ul>


<p>就是直接在k8s集群中装一个NFS server。感觉没有直接在系统安装NFS管理方便，先搁置了。</p>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/04/11/xiaomi-r4a-install-padavan/">Xiaomi R4a Install Padavan</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-04-11T21:19:31+08:00" pubdate data-updated="true">Mon 2022-04-11 21:19</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>最近换了个小米的路由，想着登录ssh，能在路由上跑一些小的定时任务。但是无奈，绑定不通过，那就直接刷机了。</p>

<p>一开始是按照csdn上的文章刷opewrt的，但是都不成功，最后换成 老毛子Padavan 了。</p>

<h2>参考</h2>

<ul>
<li><a href="https://blog.csdn.net/qq_43206901/article/details/119106511">小米路由器R4A(千兆版)固件刷opewrt、刷官方固件</a></li>
<li><a href="https://www.0412.cyou/type/xiaomi.html">小米路由4A千兆版安装openwrt教程（R4A）</a></li>
</ul>


<h2>步骤描述</h2>

<h3>获取root权限</h3>

<p>使用 <code>WSL Ubuntu</code> 进行访问，python3已经安装了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>winse@LAPTOP-I9ECVAQ4:OpenWRTInvasion-master$ python3 --version
</span><span class='line'>Python 3.8.5
</span><span class='line'>
</span><span class='line'># https://github.com/acecilia/OpenWRTInvasion
</span><span class='line'>winse@LAPTOP-I9ECVAQ4:OpenWRTInvasion-master$ ls
</span><span class='line'>Dockerfile  readme                                     requirements.txt  set_english.py
</span><span class='line'>extras      README.md                                  script.sh         speedtest_urls_template.xml
</span><span class='line'>firmwares   remote_command_execution_vulnerability.py  script_tools      tcp_file_server.py
</span><span class='line'>
</span><span class='line'>winse@LAPTOP-I9ECVAQ4:OpenWRTInvasion-master$ sudo apt install python3-pip
</span><span class='line'>
</span><span class='line'>winse@LAPTOP-I9ECVAQ4:OpenWRTInvasion-master$ pip3 install -r requirements.txt
</span><span class='line'>Requirement already satisfied: requests in /usr/lib/python3/dist-packages (from -r requirements.txt (line 1)) (2.22.0)
</span><span class='line'>
</span><span class='line'># stok获取：登录web访问后，浏览器的地址上就有stok的参数。
</span><span class='line'># 详情可查看参考的文章
</span><span class='line'>winse@LAPTOP-I9ECVAQ4:OpenWRTInvasion-master$ python3 remote_command_execution_vulnerability.py
</span><span class='line'>Router IP address [press enter for using the default 'miwifi.com']:
</span><span class='line'>Enter router admin password: __xxx__
</span><span class='line'>There two options to provide the files needed for invasion:
</span><span class='line'>   1. Use a local TCP file server runing on random port to provide files in local directory `script_tools`.
</span><span class='line'>   2. Download needed files from remote github repository. (choose this option only if github is accessable inside router device.)
</span><span class='line'>Which option do you prefer? (default: 1)
</span><span class='line'>****************
</span><span class='line'>router_ip_address: miwifi.com
</span><span class='line'>stok: __xxx__
</span><span class='line'>file provider: local file server
</span><span class='line'>****************
</span><span class='line'>start uploading config file...
</span><span class='line'>start exec command...
</span><span class='line'>local file server is runing on 0.0.0.0:1135. root='script_tools'
</span><span class='line'>local file server is getting 'busybox-mipsel' for 192.168.31.1.
</span><span class='line'>local file server is getting 'dropbearStaticMipsel.tar.bz2' for 192.168.31.1.
</span><span class='line'>done! Now you can connect to the router using several options: (user: root, password: root)
</span><span class='line'>* telnet miwifi.com
</span><span class='line'>* ssh -oKexAlgorithms=+diffie-hellman-group1-sha1 -c 3des-cbc -o UserKnownHostsFile=/dev/null root@miwifi.com
</span><span class='line'>* ftp: using a program like cyberduck
</span><span class='line'>
</span><span class='line'>winse@LAPTOP-I9ECVAQ4:OpenWRTInvasion-master$ ssh -oKexAlgorithms=+diffie-hellman-group1-sha1 -c 3des-cbc -o UserKnownHostsFile=/dev/null root@miwifi.com
</span><span class='line'>The authenticity of host 'miwifi.com (192.168.31.1)' can't be established.
</span><span class='line'>RSA key fingerprint is SHA256:AT91yqVuqPnmOO5wmke6V0Hl67GKXdkb48W/FU3WfEM.
</span><span class='line'>Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span><span class='line'>Warning: Permanently added 'miwifi.com,192.168.31.1' (RSA) to the list of known hosts.
</span><span class='line'>root@miwifi.com's password:
</span><span class='line'>
</span><span class='line'>BusyBox v1.19.4 (2021-09-30 03:16:53 UTC) built-in shell (ash)
</span><span class='line'>Enter 'help' for a list of built-in commands.
</span><span class='line'>
</span><span class='line'> -----------------------------------------------------
</span><span class='line'>       Welcome to XiaoQiang!
</span><span class='line'> -----------------------------------------------------
</span><span class='line'>  $$$$$$\  $$$$$$$\  $$$$$$$$\      $$\      $$\        $$$$$$\  $$\   $$\
</span><span class='line'> $$  __$$\ $$  __$$\ $$  _____|     $$ |     $$ |      $$  __$$\ $$ | $$  |
</span><span class='line'> $$ /  $$ |$$ |  $$ |$$ |           $$ |     $$ |      $$ /  $$ |$$ |$$  /
</span><span class='line'> $$$$$$$$ |$$$$$$$  |$$$$$\         $$ |     $$ |      $$ |  $$ |$$$$$  /
</span><span class='line'> $$  __$$ |$$  __$$&lt; $$  __|        $$ |     $$ |      $$ |  $$ |$$  $$&lt;
</span><span class='line'> $$ |  $$ |$$ |  $$ |$$ |           $$ |     $$ |      $$ |  $$ |$$ |\$$\
</span><span class='line'> $$ |  $$ |$$ |  $$ |$$$$$$$$\       $$$$$$$$$  |       $$$$$$  |$$ | \$$\
</span><span class='line'> \__|  \__|\__|  \__|\________|      \_________/        \______/ \__|  \__|
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>root@XiaoQiang:~# 
</span></code></pre></td></tr></table></div></figure>


<h3>安装breed</h3>

<p>用WinSCP登入路由，使用 <code>ftp协议</code> ，ip地址 <code>miwifi.com</code> ，账号 <code>root</code>，把 <code>breed-mt7621-pbr-m1.bin</code> 文件上传到tmp文件夹内，之后执行如下命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@XiaoQiang:~# cd /tmp
</span><span class='line'>root@XiaoQiang:/tmp# ls breed-mt7621-pbr-*
</span><span class='line'>breed-mt7621-pbr-m1.bin
</span><span class='line'>
</span><span class='line'>root@XiaoQiang:/tmp# mtd -r write breed-mt7621-pbr-m1.bin Bootloader
</span><span class='line'>Unlocking Bootloader ...
</span><span class='line'>
</span><span class='line'>Writing from breed-mt7621-pbr-m1.bin to Bootloader ...
</span><span class='line'>Rebooting ...
</span></code></pre></td></tr></table></div></figure>


<p>接上网线，再等一阵子（1,2分钟），然后访问 <code>http://192.168.1.1/</code> 。</p>

<h3>刷padavan</h3>

<p>下载r4a版本的padavan: <code>https://opt.cn2qq.com/padavan/</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MI-R4A_3.4.3.9-099.trx</span></code></pre></td></tr></table></div></figure>


<p>访问 <code>192.168.1.1</code> ，备份eeprom和固件（重要），然后勾选固件，然后将小米4A的trx固件文件进行上传，然后完成固件更新流程。</p>

<p>更新过程请不要切断路由电源！更新完成后, 页面并不会自动刷新, 自己尝试能否进入路由配置页面。。</p>

<p>刷完后，这里需要多等待一点时间，耐心一点。</p>

<h3>访问</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http://192.168.123.1/
</span><span class='line'>admin/admin
</span><span class='line'>
</span><span class='line'>在 [系统管理 - 服务] 页签开启ssh公钥登录。
</span><span class='line'>
</span><span class='line'>[MI-R4A /home/root]# uname -a
</span><span class='line'>Linux MI-R4A 3.4.113 #3 SMP Sun Apr 3 14:26:03 CST 2022 mips GNU/Linux
</span><span class='line'>[MI-R4A /home/root]# uname -r
</span><span class='line'>3.4.113
</span><span class='line'>[MI-R4A /home/root]# uname -m
</span><span class='line'>mips
</span><span class='line'>
</span><span class='line'>#CPU/Memory information
</span><span class='line'>$ cat /proc/cpuinfo
</span><span class='line'>
</span><span class='line'>#Version
</span><span class='line'>$ cat /proc/version
</span><span class='line'>
</span><span class='line'>#SCSI/Sata devices
</span><span class='line'>$ cat /proc/scsi/scsi
</span><span class='line'>
</span><span class='line'>#Partitions
</span><span class='line'>$ cat /proc/partitions
</span><span class='line'>
</span><span class='line'>#安装 okpg , 进入 Shell 后，在根目录安装，输入如下：
</span><span class='line'>[MI-R4A /home/root]# opkg.sh
</span><span class='line'>
</span><span class='line'># 升级：
</span><span class='line'>[MI-R4A /home/root]# opkg update
</span><span class='line'>Downloading http://bin.entware.net/mipselsf-k3.4/Packages.gz
</span><span class='line'>Updated list of available packages in /opt/var/opkg-lists/entware
</span><span class='line'>
</span><span class='line'>[MI-R4A /home/root]# opkg install jq
</span><span class='line'>Installing jq (1.6-2) to root...
</span><span class='line'>Downloading http://bin.entware.net/mipselsf-k3.4/jq_1.6-2_mipsel-3.4.ipk
</span><span class='line'>Configuring jq.
</span><span class='line'>
</span><span class='line'># opkg list
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/04/06/minikube-guide/">Minikube Guide</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-04-06T08:00:07+08:00" pubdate data-updated="true">Wed 2022-04-06 08:00</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>正如其名，minikube快速的安装一个k8s的集群，方便新手和应用开发人员调试等。</p>

<p>注：如果资源足够的话，搭建一个kubeadm的集群来的好一些。</p>

<h2>官网文档</h2>

<ul>
<li><a href="https://minikube.sigs.k8s.io/docs/start/">https://minikube.sigs.k8s.io/docs/start/</a></li>
</ul>


<h2>下载</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 墙外下载
</span><span class='line'>curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
</span><span class='line'>
</span><span class='line'># 上传
</span><span class='line'>[ec2-user@amazonlinux ~]$ rz
</span><span class='line'>rz waiting to receive.
</span><span class='line'>Starting zmodem transfer.  Press Ctrl+C to cancel.
</span><span class='line'>Transferring minikube-linux-amd64...
</span><span class='line'>  100%   70948 KB    35474 KB/sec    00:00:02       0 Errors  
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo install minikube-linux-amd64 /usr/local/bin/minikube
</span></code></pre></td></tr></table></div></figure>


<h2>安装docker</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ sudo amazon-linux-extras install docker
</span><span class='line'>Installing docker
</span><span class='line'>Loaded plugins: langpacks, priorities, update-motd
</span><span class='line'>Cleaning repos: amzn2-core amzn2extra-docker
</span><span class='line'>12 metadata files removed
</span><span class='line'>4 sqlite files removed
</span><span class='line'>0 metadata files removed
</span><span class='line'>Loaded plugins: langpacks, priorities, update-motd
</span><span class='line'>amzn2-core                                                                                                                                        | 3.7 kB  00:00:00     
</span><span class='line'>amzn2extra-docker                                                                                                                                 | 3.0 kB  00:00:00     
</span><span class='line'>(1/5): amzn2-core/2/x86_64/group_gz                                                                                                               | 2.5 kB  00:00:01     
</span><span class='line'>(2/5): amzn2-core/2/x86_64/updateinfo                                                                                                             | 452 kB  00:00:01     
</span><span class='line'>(3/5): amzn2extra-docker/2/x86_64/updateinfo                                                                                                      | 5.9 kB  00:00:00     
</span><span class='line'>(4/5): amzn2extra-docker/2/x86_64/primary_db                                                                                                      |  86 kB  00:00:01     
</span><span class='line'>(5/5): amzn2-core/2/x86_64/primary_db                                                                                                             |  60 MB  00:00:04     
</span><span class='line'>Resolving Dependencies
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package docker.x86_64 0:20.10.7-5.amzn2 will be installed
</span><span class='line'>--&gt; Processing Dependency: runc &gt;= 1.0.0 for package: docker-20.10.7-5.amzn2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libcgroup &gt;= 0.40.rc1-5.15 for package: docker-20.10.7-5.amzn2.x86_64
</span><span class='line'>--&gt; Processing Dependency: containerd &gt;= 1.3.2 for package: docker-20.10.7-5.amzn2.x86_64
</span><span class='line'>--&gt; Processing Dependency: pigz for package: docker-20.10.7-5.amzn2.x86_64
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package containerd.x86_64 0:1.4.6-8.amzn2 will be installed
</span><span class='line'>---&gt; Package libcgroup.x86_64 0:0.41-21.amzn2 will be installed
</span><span class='line'>---&gt; Package pigz.x86_64 0:2.3.4-1.amzn2.0.1 will be installed
</span><span class='line'>---&gt; Package runc.x86_64 0:1.0.0-2.amzn2 will be installed
</span><span class='line'>--&gt; Finished Dependency Resolution
</span><span class='line'>
</span><span class='line'>Dependencies Resolved
</span><span class='line'>
</span><span class='line'>=========================================================================================================================================================================
</span><span class='line'> Package                               Arch                              Version                                      Repository                                    Size
</span><span class='line'>=========================================================================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> docker                                x86_64                            20.10.7-5.amzn2                              amzn2extra-docker                             42 M
</span><span class='line'>Installing for dependencies:
</span><span class='line'> containerd                            x86_64                            1.4.6-8.amzn2                                amzn2extra-docker                             24 M
</span><span class='line'> libcgroup                             x86_64                            0.41-21.amzn2                                amzn2-core                                    66 k
</span><span class='line'> pigz                                  x86_64                            2.3.4-1.amzn2.0.1                            amzn2-core                                    81 k
</span><span class='line'> runc                                  x86_64                            1.0.0-2.amzn2                                amzn2extra-docker                            3.3 M
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>=========================================================================================================================================================================
</span><span class='line'>Install  1 Package (+4 Dependent packages)
</span><span class='line'>
</span><span class='line'>Total download size: 69 M
</span><span class='line'>Installed size: 285 M
</span><span class='line'>Is this ok [y/d/N]: t
</span><span class='line'>Is this ok [y/d/N]: y
</span><span class='line'>Downloading packages:
</span><span class='line'>(1/5): libcgroup-0.41-21.amzn2.x86_64.rpm                                                                                                         |  66 kB  00:00:01     
</span><span class='line'>(2/5): pigz-2.3.4-1.amzn2.0.1.x86_64.rpm                                                                                                          |  81 kB  00:00:01     
</span><span class='line'>(3/5): docker-20.10.7-5.amzn2.x86_64.rpm                                                                                                          |  42 MB  00:00:07     
</span><span class='line'>(4/5): runc-1.0.0-2.amzn2.x86_64.rpm                                                                                                              | 3.3 MB  00:00:00     
</span><span class='line'>(5/5): containerd-1.4.6-8.amzn2.x86_64.rpm                                                                                                        |  24 MB  00:00:12     
</span><span class='line'>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                                                                                    5.5 MB/s |  69 MB  00:00:12     
</span><span class='line'>Running transaction check
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded
</span><span class='line'>Running transaction
</span><span class='line'>  Installing : runc-1.0.0-2.amzn2.x86_64                                                                                                                             1/5 
</span><span class='line'>  Installing : containerd-1.4.6-8.amzn2.x86_64                                                                                                                       2/5 
</span><span class='line'>  Installing : libcgroup-0.41-21.amzn2.x86_64                                                                                                                        3/5 
</span><span class='line'>  Installing : pigz-2.3.4-1.amzn2.0.1.x86_64                                                                                                                         4/5 
</span><span class='line'>  Installing : docker-20.10.7-5.amzn2.x86_64                                                                                                                         5/5 
</span><span class='line'>  Verifying  : docker-20.10.7-5.amzn2.x86_64                                                                                                                         1/5 
</span><span class='line'>  Verifying  : containerd-1.4.6-8.amzn2.x86_64                                                                                                                       2/5 
</span><span class='line'>  Verifying  : runc-1.0.0-2.amzn2.x86_64                                                                                                                             3/5 
</span><span class='line'>  Verifying  : pigz-2.3.4-1.amzn2.0.1.x86_64                                                                                                                         4/5 
</span><span class='line'>  Verifying  : libcgroup-0.41-21.amzn2.x86_64                                                                                                                        5/5 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  docker.x86_64 0:20.10.7-5.amzn2                                                                                                                                        
</span><span class='line'>
</span><span class='line'>Dependency Installed:
</span><span class='line'>  containerd.x86_64 0:1.4.6-8.amzn2           libcgroup.x86_64 0:0.41-21.amzn2           pigz.x86_64 0:2.3.4-1.amzn2.0.1           runc.x86_64 0:1.0.0-2.amzn2          
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>  0  ansible2                 available    \
</span><span class='line'>        [ =2.4.2  =2.4.6  =2.8  =stable ]
</span><span class='line'>  2  httpd_modules            available    [ =1.0  =stable ]
</span><span class='line'>  3  memcached1.5             available    \
</span><span class='line'>        [ =1.5.1  =1.5.16  =1.5.17 ]
</span><span class='line'>  5  postgresql9.6            available    \
</span><span class='line'>        [ =9.6.6  =9.6.8  =stable ]
</span><span class='line'>  6  postgresql10             available    [ =10  =stable ]
</span><span class='line'>  9  R3.4                     available    [ =3.4.3  =stable ]
</span><span class='line'> 10  rust1                    available    \
</span><span class='line'>        [ =1.22.1  =1.26.0  =1.26.1  =1.27.2  =1.31.0  =1.38.0
</span><span class='line'>          =stable ]
</span><span class='line'> 11  vim                      available    [ =8.0  =stable ]
</span><span class='line'> 18  libreoffice              available    \
</span><span class='line'>        [ =5.0.6.2_15  =5.3.6.1  =stable ]
</span><span class='line'> 19  gimp                     available    [ =2.8.22 ]
</span><span class='line'> 20  docker=latest            enabled      \
</span><span class='line'>        [ =17.12.1  =18.03.1  =18.06.1  =18.09.9  =stable ]
</span><span class='line'> 21  mate-desktop1.x          available    \
</span><span class='line'>        [ =1.19.0  =1.20.0  =stable ]
</span><span class='line'> 22  GraphicsMagick1.3        available    \
</span><span class='line'>        [ =1.3.29  =1.3.32  =1.3.34  =stable ]
</span><span class='line'> 23  tomcat8.5                available    \
</span><span class='line'>        [ =8.5.31  =8.5.32  =8.5.38  =8.5.40  =8.5.42  =8.5.50
</span><span class='line'>          =stable ]
</span><span class='line'> 24  epel                     available    [ =7.11  =stable ]
</span><span class='line'> 25  testing                  available    [ =1.0  =stable ]
</span><span class='line'> 26  ecs                      available    [ =stable ]
</span><span class='line'> 27  corretto8                available    \
</span><span class='line'>        [ =1.8.0_192  =1.8.0_202  =1.8.0_212  =1.8.0_222  =1.8.0_232
</span><span class='line'>          =1.8.0_242  =stable ]
</span><span class='line'> 28  firecracker              available    [ =0.11  =stable ]
</span><span class='line'> 29  golang1.11               available    \
</span><span class='line'>        [ =1.11.3  =1.11.11  =1.11.13  =stable ]
</span><span class='line'> 30  squid4                   available    [ =4  =stable ]
</span><span class='line'> 32  lustre2.10               available    \
</span><span class='line'>        [ =2.10.5  =2.10.8  =stable ]
</span><span class='line'> 33  java-openjdk11           available    [ =11  =stable ]
</span><span class='line'> 34  lynis                    available    [ =stable ]
</span><span class='line'> 35  kernel-ng                available    [ =stable ]
</span><span class='line'> 36  BCC                      available    [ =0.x  =stable ]
</span><span class='line'> 37  mono                     available    [ =5.x  =stable ]
</span><span class='line'> 38  nginx1                   available    [ =stable ]
</span><span class='line'> 39  ruby2.6                  available    [ =2.6  =stable ]
</span><span class='line'> 40  mock                     available    [ =stable ]
</span><span class='line'> 41  postgresql11             available    [ =11  =stable ]
</span><span class='line'> 42  php7.4                   available    [ =stable ]
</span><span class='line'> 43  livepatch                available    [ =stable ]
</span><span class='line'> 44  python3.8                available    [ =stable ]
</span><span class='line'> 45  haproxy2                 available    [ =stable ]
</span><span class='line'> 46  collectd                 available    [ =stable ]
</span><span class='line'> 47  aws-nitro-enclaves-cli   available    [ =stable ]
</span><span class='line'> 48  R4                       available    [ =stable ]
</span><span class='line'> 49  kernel-5.4               available    [ =stable ]
</span><span class='line'> 50  selinux-ng               available    [ =stable ]
</span><span class='line'> 51  php8.0                   available    [ =stable ]
</span><span class='line'> 52  tomcat9                  available    [ =stable ]
</span><span class='line'> 53  unbound1.13              available    [ =stable ]
</span><span class='line'> 54  mariadb10.5              available    [ =stable ]
</span><span class='line'> 55  kernel-5.10              available    [ =stable ]
</span><span class='line'> 56  redis6                   available    [ =stable ]
</span><span class='line'> 57  ruby3.0                  available    [ =stable ]
</span><span class='line'> 58  postgresql12             available    [ =stable ]
</span><span class='line'> 59  postgresql13             available    [ =stable ]
</span><span class='line'> 60  mock2                    available    [ =stable ]
</span><span class='line'> 61  dnsmasq2.85              available    [ =stable ]
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo service docker start
</span><span class='line'>Redirecting to /bin/systemctl start docker.service
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo systemctl enable docker
</span><span class='line'>Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo usermod -a -G docker ec2-user
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ exit
</span><span class='line'>logout
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker info 
</span><span class='line'>Client:
</span><span class='line'> Context:    default
</span><span class='line'> Debug Mode: false
</span><span class='line'>
</span><span class='line'>Server:
</span><span class='line'> Containers: 0
</span><span class='line'>  Running: 0
</span><span class='line'>  Paused: 0
</span><span class='line'>  Stopped: 0
</span><span class='line'> Images: 0
</span><span class='line'> Server Version: 20.10.7
</span><span class='line'> Storage Driver: overlay2
</span><span class='line'>  Backing Filesystem: xfs
</span><span class='line'>  Supports d_type: true
</span><span class='line'>  Native Overlay Diff: true
</span><span class='line'>  userxattr: false
</span><span class='line'> Logging Driver: json-file
</span><span class='line'> Cgroup Driver: cgroupfs
</span><span class='line'> Cgroup Version: 1
</span><span class='line'> Plugins:
</span><span class='line'>  Volume: local
</span><span class='line'>  Network: bridge host ipvlan macvlan null overlay
</span><span class='line'>  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
</span><span class='line'> Swarm: inactive
</span><span class='line'> Runtimes: io.containerd.runc.v2 io.containerd.runtime.v1.linux runc
</span><span class='line'> Default Runtime: runc
</span><span class='line'> Init Binary: docker-init
</span><span class='line'> containerd version: d71fcd7d8303cbf684402823e425e9dd2e99285d
</span><span class='line'> runc version: 84113eef6fc27af1b01b3181f31bbaf708715301
</span><span class='line'> init version: de40ad0
</span><span class='line'> Security Options:
</span><span class='line'>  seccomp
</span><span class='line'>   Profile: default
</span><span class='line'> Kernel Version: 4.14.268-205.500.amzn2.x86_64
</span><span class='line'> Operating System: Amazon Linux 2
</span><span class='line'> OSType: linux
</span><span class='line'> Architecture: x86_64
</span><span class='line'> CPUs: 2
</span><span class='line'> Total Memory: 3.828GiB
</span><span class='line'> Name: amazonlinux.onprem
</span><span class='line'> ID: MXVZ:LQK7:BVKI:WECH:XNBN:QJUK:IXYU:FADA:4EYI:JOHA:VS3R:LNLX
</span><span class='line'> Docker Root Dir: /var/lib/docker
</span><span class='line'> Debug Mode: false
</span><span class='line'> Registry: https://index.docker.io/v1/
</span><span class='line'> Labels:
</span><span class='line'> Experimental: false
</span><span class='line'> Insecure Registries:
</span><span class='line'>  127.0.0.0/8
</span><span class='line'> Live Restore Enabled: false
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker info
</span><span class='line'>Client:
</span><span class='line'> Context:    default
</span><span class='line'> Debug Mode: false
</span><span class='line'>
</span><span class='line'>Server:
</span><span class='line'> Containers: 0
</span><span class='line'>  Running: 0
</span><span class='line'>  Paused: 0
</span><span class='line'>  Stopped: 0
</span><span class='line'> Images: 0
</span><span class='line'> Server Version: 20.10.7
</span><span class='line'> Storage Driver: overlay2
</span><span class='line'>  Backing Filesystem: xfs
</span><span class='line'>  Supports d_type: true
</span><span class='line'>  Native Overlay Diff: true
</span><span class='line'>  userxattr: false
</span><span class='line'> Logging Driver: json-file
</span><span class='line'> Cgroup Driver: cgroupfs
</span><span class='line'> Cgroup Version: 1
</span><span class='line'> Plugins:
</span><span class='line'>  Volume: local
</span><span class='line'>  Network: bridge host ipvlan macvlan null overlay
</span><span class='line'>  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
</span><span class='line'> Swarm: inactive
</span><span class='line'> Runtimes: runc io.containerd.runc.v2 io.containerd.runtime.v1.linux
</span><span class='line'> Default Runtime: runc
</span><span class='line'> Init Binary: docker-init
</span><span class='line'> containerd version: d71fcd7d8303cbf684402823e425e9dd2e99285d
</span><span class='line'> runc version: 84113eef6fc27af1b01b3181f31bbaf708715301
</span><span class='line'> init version: de40ad0
</span><span class='line'> Security Options:
</span><span class='line'>  seccomp
</span><span class='line'>   Profile: default
</span><span class='line'> Kernel Version: 4.14.268-205.500.amzn2.x86_64
</span><span class='line'> Operating System: Amazon Linux 2
</span><span class='line'> OSType: linux
</span><span class='line'> Architecture: x86_64
</span><span class='line'> CPUs: 2
</span><span class='line'> Total Memory: 3.828GiB
</span><span class='line'> Name: amazonlinux.onprem
</span><span class='line'> ID: MXVZ:LQK7:BVKI:WECH:XNBN:QJUK:IXYU:FADA:4EYI:JOHA:VS3R:LNLX
</span><span class='line'> Docker Root Dir: /var/lib/docker
</span><span class='line'> Debug Mode: false
</span><span class='line'> Registry: https://index.docker.io/v1/
</span><span class='line'> Labels:
</span><span class='line'> Experimental: false
</span><span class='line'> Insecure Registries:
</span><span class='line'>  127.0.0.0/8
</span><span class='line'> Live Restore Enabled: false
</span></code></pre></td></tr></table></div></figure>


<h2>启动minikube</h2>

<ul>
<li><a href="https://minikube.sigs.k8s.io/docs/start/">https://minikube.sigs.k8s.io/docs/start/</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ minikube start
</span><span class='line'>* minikube v1.25.2 on Amazon 2
</span><span class='line'>* Automatically selected the docker driver. Other choices: none, ssh
</span><span class='line'>* Starting control plane node minikube in cluster minikube
</span><span class='line'>* Pulling base image ...
</span><span class='line'>* Downloading Kubernetes v1.23.3 preload ...
</span><span class='line'>    &gt; preloaded-images-k8s-v17-v1...: 505.68 MiB / 505.68 MiB  100.00% 14.20 Mi
</span><span class='line'>    &gt; index.docker.io/kicbase/sta...: 379.06 MiB / 379.06 MiB  100.00% 2.11 MiB
</span><span class='line'>! minikube was unable to download gcr.io/k8s-minikube/kicbase:v0.0.30, but successfully downloaded docker.io/kicbase/stable:v0.0.30 as a fallback image
</span><span class='line'>* Creating docker container (CPUs=2, Memory=2200MB) ...
</span><span class='line'>! This container is having trouble accessing https://k8s.gcr.io
</span><span class='line'>* To pull new external images, you may need to configure a proxy: https://minikube.sigs.k8s.io/docs/reference/networking/proxy/
</span><span class='line'>* Preparing Kubernetes v1.23.3 on Docker 20.10.12 ...
</span><span class='line'>  - kubelet.housekeeping-interval=5m
</span><span class='line'>  - Generating certificates and keys ...
</span><span class='line'>  - Booting up control plane ...
</span><span class='line'>  - Configuring RBAC rules ...
</span><span class='line'>* Verifying Kubernetes components...
</span><span class='line'>  - Using image gcr.io/k8s-minikube/storage-provisioner:v5
</span><span class='line'>* Enabled addons: default-storageclass, storage-provisioner
</span><span class='line'>* kubectl not found. If you need it, try: 'minikube kubectl -- get pods -A'
</span><span class='line'>* Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default
</span></code></pre></td></tr></table></div></figure>


<p>Interact with your cluster</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ minikube kubectl -- get pods -A 
</span><span class='line'>    &gt; kubectl.sha256: 64 B / 64 B [--------------------------] 100.00% ? p/s 0s
</span><span class='line'>    &gt; kubectl: 44.43 MiB / 44.43 MiB [-------------] 100.00% 17.41 MiB p/s 2.8s
</span><span class='line'>NAMESPACE     NAME                               READY   STATUS    RESTARTS       AGE
</span><span class='line'>kube-system   coredns-64897985d-cm6h7            1/1     Running   0              2m3s
</span><span class='line'>kube-system   etcd-minikube                      1/1     Running   0              2m15s
</span><span class='line'>kube-system   kube-apiserver-minikube            1/1     Running   0              2m15s
</span><span class='line'>kube-system   kube-controller-manager-minikube   1/1     Running   0              2m15s
</span><span class='line'>kube-system   kube-proxy-s2sf4                   1/1     Running   0              2m3s
</span><span class='line'>kube-system   kube-scheduler-minikube            1/1     Running   0              2m15s
</span><span class='line'>kube-system   storage-provisioner                1/1     Running   1 (101s ago)   2m14s
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ alias kubectl="minikube kubectl --"
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl get pods -A 
</span><span class='line'>NAMESPACE     NAME                               READY   STATUS    RESTARTS        AGE
</span><span class='line'>kube-system   coredns-64897985d-cm6h7            1/1     Running   0               5m5s
</span><span class='line'>kube-system   etcd-minikube                      1/1     Running   0               5m17s
</span><span class='line'>kube-system   kube-apiserver-minikube            1/1     Running   0               5m17s
</span><span class='line'>kube-system   kube-controller-manager-minikube   1/1     Running   0               5m17s
</span><span class='line'>kube-system   kube-proxy-s2sf4                   1/1     Running   0               5m5s
</span><span class='line'>kube-system   kube-scheduler-minikube            1/1     Running   0               5m17s
</span><span class='line'>kube-system   storage-provisioner                1/1     Running   1 (4m43s ago)   5m16s
</span><span class='line'>
</span><span class='line'># 查看配置
</span><span class='line'>[ec2-user@amazonlinux ~]$ cat .kube/config 
</span><span class='line'>apiVersion: v1
</span><span class='line'>clusters:
</span><span class='line'>- cluster:
</span><span class='line'>    certificate-authority: /home/ec2-user/.minikube/ca.crt
</span><span class='line'>    extensions:
</span><span class='line'>    - extension:
</span><span class='line'>        last-update: Sun, 03 Apr 2022 16:43:46 UTC
</span><span class='line'>        provider: minikube.sigs.k8s.io
</span><span class='line'>        version: v1.25.2
</span><span class='line'>      name: cluster_info
</span><span class='line'>    server: https://192.168.49.2:8443
</span><span class='line'>  name: minikube
</span><span class='line'>contexts:
</span><span class='line'>- context:
</span><span class='line'>    cluster: minikube
</span><span class='line'>    extensions:
</span><span class='line'>    - extension:
</span><span class='line'>        last-update: Sun, 03 Apr 2022 16:43:46 UTC
</span><span class='line'>        provider: minikube.sigs.k8s.io
</span><span class='line'>        version: v1.25.2
</span><span class='line'>      name: context_info
</span><span class='line'>    namespace: default
</span><span class='line'>    user: minikube
</span><span class='line'>  name: minikube
</span><span class='line'>current-context: minikube
</span><span class='line'>kind: Config
</span><span class='line'>preferences: {}
</span><span class='line'>users:
</span><span class='line'>- name: minikube
</span><span class='line'>  user:
</span><span class='line'>    client-certificate: /home/ec2-user/.minikube/profiles/minikube/client.crt
</span><span class='line'>    client-key: /home/ec2-user/.minikube/profiles/minikube/client.key
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span></code></pre></td></tr></table></div></figure>


<p>或者做一个软连接的kubectl：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># https://minikube.sigs.k8s.io/docs/handbook/kubectl/
</span><span class='line'># https://kubernetes.io/docs/tasks/tools/included/optional-kubectl-configs-bash-linux/
</span><span class='line'># https://minikube.sigs.k8s.io/docs/handbook/kubectl/
</span><span class='line'>
</span><span class='line'>ln -s $(which minikube) /usr/local/bin/kubectl
</span></code></pre></td></tr></table></div></figure>


<h3>对系统做了些什么？</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ docker images 
</span><span class='line'>REPOSITORY       TAG       IMAGE ID       CREATED       SIZE
</span><span class='line'>kicbase/stable   v0.0.30   1312ccd2422d   7 weeks ago   1.14GB
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker ps 
</span><span class='line'>CONTAINER ID   IMAGE                    COMMAND                  CREATED         STATUS         PORTS                                                                                                                                  NAMES
</span><span class='line'>19887e6799fb   kicbase/stable:v0.0.30   "/usr/local/bin/entr…"   7 minutes ago   Up 7 minutes   127.0.0.1:49157-&gt;22/tcp, 127.0.0.1:49156-&gt;2376/tcp, 127.0.0.1:49155-&gt;5000/tcp, 127.0.0.1:49154-&gt;8443/tcp, 127.0.0.1:49153-&gt;32443/tcp   minikube
</span><span class='line'>
</span><span class='line'># 进到容器内查看
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker exec -ti 19887e6799fb bash 
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ minikube ssh
</span><span class='line'>docker@minikube:~$ sudo su -
</span><span class='line'>root@minikube:/# 
</span><span class='line'>root@minikube:/# docker ps -a 
</span><span class='line'>CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS                     PORTS     NAMES
</span><span class='line'>317a4dc12504   6e38f40d628d           "/storage-provisioner"   7 minutes ago   Up 7 minutes                         k8s_storage-provisioner_storage-provisioner_kube-system_c4ea2d31-2c3e-4672-9479-719b0082ac5c_1
</span><span class='line'>e0876840ef56   a4ca41631cc7           "/coredns -conf /etc…"   7 minutes ago   Up 7 minutes                         k8s_coredns_coredns-64897985d-cm6h7_kube-system_0bbdb9ae-d64a-4d74-8b38-ba5bd66af499_0
</span><span class='line'>485899a5fe0c   9b7cc9982109           "/usr/local/bin/kube…"   7 minutes ago   Up 7 minutes                         k8s_kube-proxy_kube-proxy-s2sf4_kube-system_2e24cec7-d9b3-430e-8869-b9af785588de_0
</span><span class='line'>0faab30374f5   k8s.gcr.io/pause:3.6   "/pause"                 7 minutes ago   Up 7 minutes                         k8s_POD_coredns-64897985d-cm6h7_kube-system_0bbdb9ae-d64a-4d74-8b38-ba5bd66af499_0
</span><span class='line'>ae99f0b5b873   k8s.gcr.io/pause:3.6   "/pause"                 7 minutes ago   Up 7 minutes                         k8s_POD_kube-proxy-s2sf4_kube-system_2e24cec7-d9b3-430e-8869-b9af785588de_0
</span><span class='line'>fdeeb06fda78   6e38f40d628d           "/storage-provisioner"   7 minutes ago   Exited (1) 7 minutes ago             k8s_storage-provisioner_storage-provisioner_kube-system_c4ea2d31-2c3e-4672-9479-719b0082ac5c_0
</span><span class='line'>f83e36d2d77e   k8s.gcr.io/pause:3.6   "/pause"                 7 minutes ago   Up 7 minutes                         k8s_POD_storage-provisioner_kube-system_c4ea2d31-2c3e-4672-9479-719b0082ac5c_0
</span><span class='line'>df73834cbaf8   b07520cd7ab7           "kube-controller-man…"   8 minutes ago   Up 8 minutes                         k8s_kube-controller-manager_kube-controller-manager-minikube_kube-system_b965983ec05322d0973594a01d5e8245_0
</span><span class='line'>49ad661cee86   25f8c7f3da61           "etcd --advertise-cl…"   8 minutes ago   Up 8 minutes                         k8s_etcd_etcd-minikube_kube-system_9d3d310935e5fabe942511eec3e2cd0c_0
</span><span class='line'>2c28a97b3875   99a3486be4f2           "kube-scheduler --au…"   8 minutes ago   Up 8 minutes                         k8s_kube-scheduler_kube-scheduler-minikube_kube-system_be132fe5c6572cb34d93f5e05ce2a540_0
</span><span class='line'>72aca4e710b6   f40be0088a83           "kube-apiserver --ad…"   8 minutes ago   Up 8 minutes                         k8s_kube-apiserver_kube-apiserver-minikube_kube-system_cd6e47233d36a9715b0ab9632f871843_0
</span><span class='line'>97c6ecde381c   k8s.gcr.io/pause:3.6   "/pause"                 8 minutes ago   Up 8 minutes                         k8s_POD_kube-scheduler-minikube_kube-system_be132fe5c6572cb34d93f5e05ce2a540_0
</span><span class='line'>9140211bc570   k8s.gcr.io/pause:3.6   "/pause"                 8 minutes ago   Up 8 minutes                         k8s_POD_kube-controller-manager-minikube_kube-system_b965983ec05322d0973594a01d5e8245_0
</span><span class='line'>b27ec09ec789   k8s.gcr.io/pause:3.6   "/pause"                 8 minutes ago   Up 8 minutes                         k8s_POD_kube-apiserver-minikube_kube-system_cd6e47233d36a9715b0ab9632f871843_0
</span><span class='line'>0aef74ead92e   k8s.gcr.io/pause:3.6   "/pause"                 8 minutes ago   Up 8 minutes                         k8s_POD_etcd-minikube_kube-system_9d3d310935e5fabe942511eec3e2cd0c_0
</span><span class='line'>
</span><span class='line'>root@minikube:/# docker images 
</span><span class='line'>REPOSITORY                                TAG       IMAGE ID       CREATED         SIZE
</span><span class='line'>k8s.gcr.io/kube-apiserver                 v1.23.3   f40be0088a83   2 months ago    135MB
</span><span class='line'>k8s.gcr.io/kube-proxy                     v1.23.3   9b7cc9982109   2 months ago    112MB
</span><span class='line'>k8s.gcr.io/kube-scheduler                 v1.23.3   99a3486be4f2   2 months ago    53.5MB
</span><span class='line'>k8s.gcr.io/kube-controller-manager        v1.23.3   b07520cd7ab7   2 months ago    125MB
</span><span class='line'>k8s.gcr.io/etcd                           3.5.1-0   25f8c7f3da61   5 months ago    293MB
</span><span class='line'>k8s.gcr.io/coredns/coredns                v1.8.6    a4ca41631cc7   5 months ago    46.8MB
</span><span class='line'>k8s.gcr.io/pause                          3.6       6270bb605e12   7 months ago    683kB
</span><span class='line'>kubernetesui/dashboard                    v2.3.1    e1482a24335a   9 months ago    220MB
</span><span class='line'>kubernetesui/metrics-scraper              v1.0.7    7801cfc6d5c0   9 months ago    34.4MB
</span><span class='line'>gcr.io/k8s-minikube/storage-provisioner   v5        6e38f40d628d   12 months ago   31.5MB
</span></code></pre></td></tr></table></div></figure>


<p>更便捷的管理minikube docker：</p>

<ul>
<li><a href="https://minikube.sigs.k8s.io/docs/handbook/pushing/">https://minikube.sigs.k8s.io/docs/handbook/pushing/</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># https://minikube.sigs.k8s.io/docs/handbook/pushing/#1-pushing-directly-to-the-in-cluster-docker-daemon-docker-env
</span><span class='line'>[ec2-user@amazonlinux ~]$ eval $(minikube docker-env)
</span><span class='line'># 原理就是设置了环境变量，docker连上了远程服务：export DOCKER_HOST="tcp://192.168.49.2:2376"
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker ps
</span><span class='line'>CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS     NAMES
</span><span class='line'>344dc0e8c1e6   7801cfc6d5c0           "/metrics-sidecar"       13 minutes ago   Up 13 minutes             k8s_dashboard-metrics-scraper_dashboard-metrics-scraper-58549894f-mzhg2_kubernetes-dashboard_4d6591df-2ee1-46b1-b44c-46ef748a3cd8_0
</span><span class='line'>276a2b6b591f   e1482a24335a           "/dashboard --insecu…"   13 minutes ago   Up 13 minutes             k8s_kubernetes-dashboard_kubernetes-dashboard-ccd587f44-w22lx_kubernetes-dashboard_eb06974d-a4e6-459a-b135-b2426696a75f_0
</span><span class='line'>739f9fdc02bf   k8s.gcr.io/pause:3.6   "/pause"                 13 minutes ago   Up 13 minutes             k8s_POD_dashboard-metrics-scraper-58549894f-mzhg2_kubernetes-dashboard_4d6591df-2ee1-46b1-b44c-46ef748a3cd8_0
</span><span class='line'>9b9d38bdb6d7   k8s.gcr.io/pause:3.6   "/pause"                 13 minutes ago   Up 13 minutes             k8s_POD_kubernetes-dashboard-ccd587f44-w22lx_kubernetes-dashboard_eb06974d-a4e6-459a-b135-b2426696a75f_0
</span><span class='line'>8fd387311710   k8s.gcr.io/pause:3.6   "/pause"                 8 hours ago      Up 8 hours                k8s_POD_hello-minikube-74c6b47596-gfxrl_default_689891ce-a761-46a6-aa16-fb33dd037c45_0
</span><span class='line'>317a4dc12504   6e38f40d628d           "/storage-provisioner"   8 hours ago      Up 8 hours                k8s_storage-provisioner_storage-provisioner_kube-system_c4ea2d31-2c3e-4672-9479-719b0082ac5c_1
</span><span class='line'>e0876840ef56   a4ca41631cc7           "/coredns -conf /etc…"   8 hours ago      Up 8 hours                k8s_coredns_coredns-64897985d-cm6h7_kube-system_0bbdb9ae-d64a-4d74-8b38-ba5bd66af499_0
</span><span class='line'>485899a5fe0c   9b7cc9982109           "/usr/local/bin/kube…"   8 hours ago      Up 8 hours                k8s_kube-proxy_kube-proxy-s2sf4_kube-system_2e24cec7-d9b3-430e-8869-b9af785588de_0
</span><span class='line'>0faab30374f5   k8s.gcr.io/pause:3.6   "/pause"                 8 hours ago      Up 8 hours                k8s_POD_coredns-64897985d-cm6h7_kube-system_0bbdb9ae-d64a-4d74-8b38-ba5bd66af499_0
</span><span class='line'>ae99f0b5b873   k8s.gcr.io/pause:3.6   "/pause"                 8 hours ago      Up 8 hours                k8s_POD_kube-proxy-s2sf4_kube-system_2e24cec7-d9b3-430e-8869-b9af785588de_0
</span><span class='line'>f83e36d2d77e   k8s.gcr.io/pause:3.6   "/pause"                 8 hours ago      Up 8 hours                k8s_POD_storage-provisioner_kube-system_c4ea2d31-2c3e-4672-9479-719b0082ac5c_0
</span><span class='line'>df73834cbaf8   b07520cd7ab7           "kube-controller-man…"   8 hours ago      Up 8 hours                k8s_kube-controller-manager_kube-controller-manager-minikube_kube-system_b965983ec05322d0973594a01d5e8245_0
</span><span class='line'>49ad661cee86   25f8c7f3da61           "etcd --advertise-cl…"   8 hours ago      Up 8 hours                k8s_etcd_etcd-minikube_kube-system_9d3d310935e5fabe942511eec3e2cd0c_0
</span><span class='line'>2c28a97b3875   99a3486be4f2           "kube-scheduler --au…"   8 hours ago      Up 8 hours                k8s_kube-scheduler_kube-scheduler-minikube_kube-system_be132fe5c6572cb34d93f5e05ce2a540_0
</span><span class='line'>72aca4e710b6   f40be0088a83           "kube-apiserver --ad…"   8 hours ago      Up 8 hours                k8s_kube-apiserver_kube-apiserver-minikube_kube-system_cd6e47233d36a9715b0ab9632f871843_0
</span><span class='line'>97c6ecde381c   k8s.gcr.io/pause:3.6   "/pause"                 8 hours ago      Up 8 hours                k8s_POD_kube-scheduler-minikube_kube-system_be132fe5c6572cb34d93f5e05ce2a540_0
</span><span class='line'>9140211bc570   k8s.gcr.io/pause:3.6   "/pause"                 8 hours ago      Up 8 hours                k8s_POD_kube-controller-manager-minikube_kube-system_b965983ec05322d0973594a01d5e8245_0
</span><span class='line'>b27ec09ec789   k8s.gcr.io/pause:3.6   "/pause"                 8 hours ago      Up 8 hours                k8s_POD_kube-apiserver-minikube_kube-system_cd6e47233d36a9715b0ab9632f871843_0
</span><span class='line'>0aef74ead92e   k8s.gcr.io/pause:3.6   "/pause"                 8 hours ago      Up 8 hours                k8s_POD_etcd-minikube_kube-system_9d3d310935e5fabe942511eec3e2cd0c_0
</span></code></pre></td></tr></table></div></figure>


<p>管理：</p>

<ul>
<li><a href="https://minikube.sigs.k8s.io/docs/handbook/pushing/#2-push-images-using-cache-command">https://minikube.sigs.k8s.io/docs/handbook/pushing/#2-push-images-using-cache-command</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>minikube cache add alpine:latest
</span><span class='line'>minikube cache reload
</span><span class='line'>minikube cache list
</span><span class='line'>minikube cache delete &lt;image name&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>dashboard</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ minikube dashboard
</span><span class='line'>* Enabling dashboard ...
</span><span class='line'>  - Using image kubernetesui/metrics-scraper:v1.0.7
</span><span class='line'>  - Using image kubernetesui/dashboard:v2.3.1
</span><span class='line'>* Verifying dashboard health ...
</span><span class='line'>* Launching proxy ...
</span><span class='line'>* Verifying proxy health ...
</span><span class='line'>* Opening http://127.0.0.1:37163/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ in your default browser...
</span><span class='line'>  http://127.0.0.1:37163/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo netstat -anp | grep 37163 | grep LISTEN
</span><span class='line'>tcp        0      0 127.0.0.1:37163         0.0.0.0:*               LISTEN      71016/kubectl       
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ ps aux|grep 71016
</span><span class='line'>ec2-user   71016  0.0  0.9 750808 38932 pts/2    Sl+  00:59   0:00 /home/ec2-user/.minikube/cache/linux/amd64/v1.23.3/kubectl --cluster minikube --context minikube proxy --port 0
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 再获取访问地址
</span><span class='line'>[ec2-user@amazonlinux ~]$ minikube dashboard --url
</span><span class='line'>* Verifying dashboard health ...
</span><span class='line'>* Launching proxy ...
</span><span class='line'>* Verifying proxy health ...
</span><span class='line'>http://127.0.0.1:43247/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/
</span></code></pre></td></tr></table></div></figure>


<h2>hello world</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ eval $(minikube docker-env)
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker load -i echoserver.tar.gz 
</span><span class='line'>6cc9890d69b6: Loading layer [==================================================&gt;]  61.68MB/61.68MB
</span><span class='line'>5f70bf18a086: Loading layer [==================================================&gt;]  1.024kB/1.024kB
</span><span class='line'>e105cd217163: Loading layer [==================================================&gt;]  8.704kB/8.704kB
</span><span class='line'>9f9b8efa9a34: Loading layer [==================================================&gt;]  83.34MB/83.34MB
</span><span class='line'>4cc84b7b3aba: Loading layer [==================================================&gt;]  3.072kB/3.072kB
</span><span class='line'>e2615e4925e2: Loading layer [==================================================&gt;]  3.072kB/3.072kB
</span><span class='line'>1787713d6d5d: Loading layer [==================================================&gt;]   5.12kB/5.12kB
</span><span class='line'>67639a8a7916: Loading layer [==================================================&gt;]  2.048kB/2.048kB
</span><span class='line'>Loaded image: k8s.gcr.io/echoserver:1.4
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker images 
</span><span class='line'>REPOSITORY                                TAG       IMAGE ID       CREATED         SIZE
</span><span class='line'>k8s.gcr.io/kube-apiserver                 v1.23.3   f40be0088a83   2 months ago    135MB
</span><span class='line'>k8s.gcr.io/kube-scheduler                 v1.23.3   99a3486be4f2   2 months ago    53.5MB
</span><span class='line'>k8s.gcr.io/kube-proxy                     v1.23.3   9b7cc9982109   2 months ago    112MB
</span><span class='line'>k8s.gcr.io/kube-controller-manager        v1.23.3   b07520cd7ab7   2 months ago    125MB
</span><span class='line'>k8s.gcr.io/etcd                           3.5.1-0   25f8c7f3da61   5 months ago    293MB
</span><span class='line'>k8s.gcr.io/coredns/coredns                v1.8.6    a4ca41631cc7   6 months ago    46.8MB
</span><span class='line'>k8s.gcr.io/pause                          3.6       6270bb605e12   7 months ago    683kB
</span><span class='line'>kubernetesui/dashboard                    v2.3.1    e1482a24335a   10 months ago   220MB
</span><span class='line'>kubernetesui/metrics-scraper              v1.0.7    7801cfc6d5c0   10 months ago   34.4MB
</span><span class='line'>gcr.io/k8s-minikube/storage-provisioner   v5        6e38f40d628d   12 months ago   31.5MB
</span><span class='line'>k8s.gcr.io/echoserver                     1.4       a90209bb39e3   5 years ago     140MB
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># kubectl create deployment hello-minikube --image=k8s.gcr.io/echoserver:1.4
</span><span class='line'># kubectl expose deployment hello-minikube --type=NodePort --port=8080
</span><span class='line'>
</span><span class='line'># kubectl --help
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl get svc 
</span><span class='line'>NAME             TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE
</span><span class='line'>hello-minikube   NodePort    10.98.195.3   &lt;none&gt;        8080:32754/TCP   7h
</span><span class='line'>kubernetes       ClusterIP   10.96.0.1     &lt;none&gt;        443/TCP          12d
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl get services hello-minikube
</span><span class='line'>NAME             TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE
</span><span class='line'>hello-minikube   NodePort   10.98.195.3   &lt;none&gt;        8080:32754/TCP   7h59m
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># kubectl port-forward service/hello-minikube 7080:8080
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl port-forward --address 0.0.0.0 service/hello-minikube 7080:8080
</span><span class='line'>Forwarding from 0.0.0.0:7080 -&gt; 8080
</span><span class='line'>Handling connection for 7080
</span><span class='line'>Handling connection for 7080
</span><span class='line'>
</span><span class='line'>浏览器访问 http://192.168.191.133:7080/
</span></code></pre></td></tr></table></div></figure>


<h2>load balancer</h2>

<ul>
<li><a href="https://minikube.sigs.k8s.io/docs/start/#loadbalancer-deployments">https://minikube.sigs.k8s.io/docs/start/#loadbalancer-deployments</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ kubectl create deployment balanced --image=k8s.gcr.io/echoserver:1.4  
</span><span class='line'>deployment.apps/balanced created
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl expose deployment balanced --type=LoadBalancer --port=8080
</span><span class='line'>service/balanced exposed
</span><span class='line'>[ec2-user@amazonlinux ~]$ minikube tunnel
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl get services balanced
</span><span class='line'>NAME       TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)          AGE
</span><span class='line'>balanced   LoadBalancer   10.100.193.49   10.100.193.49   8080:30406/TCP   13s
</span><span class='line'>[ec2-user@amazonlinux ~]$ curl 10.100.193.49:8080
</span><span class='line'>CLIENT VALUES:
</span><span class='line'>client_address=172.17.0.1
</span><span class='line'>command=GET
</span><span class='line'>real path=/
</span><span class='line'>query=nil
</span><span class='line'>request_version=1.1
</span><span class='line'>request_uri=http://10.100.193.49:8080/
</span><span class='line'>
</span><span class='line'>SERVER VALUES:
</span><span class='line'>server_version=nginx: 1.10.0 - lua: 10001
</span><span class='line'>
</span><span class='line'>HEADERS RECEIVED:
</span><span class='line'>accept=*/*
</span><span class='line'>host=10.100.193.49:8080
</span><span class='line'>user-agent=curl/7.79.1
</span><span class='line'>BODY:
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span></code></pre></td></tr></table></div></figure>


<h2>清理</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ minikube pause
</span><span class='line'>* Pausing node minikube ... 
</span><span class='line'>* Paused 18 containers in: kube-system, kubernetes-dashboard, storage-gluster, istio-operator
</span><span class='line'>[ec2-user@amazonlinux ~]$ minikube unpause
</span><span class='line'>* Unpausing node minikube ... 
</span><span class='line'>* Unpaused 18 containers in: kube-system, kubernetes-dashboard, storage-gluster, istio-operator
</span><span class='line'>
</span><span class='line'>###!!!!
</span><span class='line'>[ec2-user@amazonlinux ~]$ minikube config set memory 16384
</span><span class='line'>! These changes will take effect upon a minikube delete and then a minikube start
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ minikube config unset memory
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker ps 
</span><span class='line'>CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS     NAMES
</span><span class='line'>01cf3a66eb7c   a90209bb39e3           "nginx -g 'daemon of…"   6 minutes ago    Up 6 minutes              k8s_echoserver_balanced-5b98d98bf8-t464f_default_c6b70ff1-d799-4633-bf13-e481052a5da1_0
</span><span class='line'>6a23b4b82131   k8s.gcr.io/pause:3.6   "/pause"                 6 minutes ago    Up 6 minutes              k8s_POD_balanced-5b98d98bf8-t464f_default_c6b70ff1-d799-4633-bf13-e481052a5da1_0
</span><span class='line'>b5817aab4b25   a90209bb39e3           "nginx -g 'daemon of…"   17 minutes ago   Up 17 minutes             k8s_echoserver_hello-minikube-7bc9d7884c-m4r4s_default_cef90979-1c63-4497-acb0-d13847c5a60b_0
</span><span class='line'>9d5677d088c6   k8s.gcr.io/pause:3.6   "/pause"                 17 minutes ago   Up 17 minutes             k8s_POD_hello-minikube-7bc9d7884c-m4r4s_default_cef90979-1c63-4497-acb0-d13847c5a60b_0
</span><span class='line'>c13da70206de   e1482a24335a           "/dashboard --insecu…"   50 minutes ago   Up 50 minutes             k8s_kubernetes-dashboard_kubernetes-dashboard-ccd587f44-w22lx_kubernetes-dashboard_eb06974d-a4e6-459a-b135-b2426696a75f_4
</span><span class='line'>0cead3ead613   6e38f40d628d           "/storage-provisioner"   50 minutes ago   Up 50 minutes             k8s_storage-provisioner_storage-provisioner_kube-system_c4ea2d31-2c3e-4672-9479-719b0082ac5c_5
</span><span class='line'>3a1c19a7a51f   7801cfc6d5c0           "/metrics-sidecar"       51 minutes ago   Up 51 minutes             k8s_dashboard-metrics-scraper_dashboard-metrics-scraper-58549894f-mzhg2_kubernetes-dashboard_4d6591df-2ee1-46b1-b44c-46ef748a3cd8_2
</span><span class='line'>0c48d4f778de   a4ca41631cc7           "/coredns -conf /etc…"   51 minutes ago   Up 51 minutes             k8s_coredns_coredns-64897985d-cm6h7_kube-system_0bbdb9ae-d64a-4d74-8b38-ba5bd66af499_2
</span><span class='line'>ac2ee5d973c6   9b7cc9982109           "/usr/local/bin/kube…"   51 minutes ago   Up 51 minutes             k8s_kube-proxy_kube-proxy-s2sf4_kube-system_2e24cec7-d9b3-430e-8869-b9af785588de_2
</span><span class='line'>dc17216220bb   k8s.gcr.io/pause:3.6   "/pause"                 51 minutes ago   Up 51 minutes             k8s_POD_kubernetes-dashboard-ccd587f44-w22lx_kubernetes-dashboard_eb06974d-a4e6-459a-b135-b2426696a75f_2
</span><span class='line'>9d7f883afb88   k8s.gcr.io/pause:3.6   "/pause"                 51 minutes ago   Up 51 minutes             k8s_POD_storage-provisioner_kube-system_c4ea2d31-2c3e-4672-9479-719b0082ac5c_2
</span><span class='line'>d28d9a0a91b1   k8s.gcr.io/pause:3.6   "/pause"                 51 minutes ago   Up 51 minutes             k8s_POD_coredns-64897985d-cm6h7_kube-system_0bbdb9ae-d64a-4d74-8b38-ba5bd66af499_2
</span><span class='line'>7e7a16e16d03   k8s.gcr.io/pause:3.6   "/pause"                 51 minutes ago   Up 51 minutes             k8s_POD_kube-proxy-s2sf4_kube-system_2e24cec7-d9b3-430e-8869-b9af785588de_2
</span><span class='line'>ace45942773c   k8s.gcr.io/pause:3.6   "/pause"                 51 minutes ago   Up 51 minutes             k8s_POD_dashboard-metrics-scraper-58549894f-mzhg2_kubernetes-dashboard_4d6591df-2ee1-46b1-b44c-46ef748a3cd8_2
</span><span class='line'>8f00f611d713   f40be0088a83           "kube-apiserver --ad…"   51 minutes ago   Up 51 minutes             k8s_kube-apiserver_kube-apiserver-minikube_kube-system_cd6e47233d36a9715b0ab9632f871843_2
</span><span class='line'>79f528bbd4d1   99a3486be4f2           "kube-scheduler --au…"   51 minutes ago   Up 51 minutes             k8s_kube-scheduler_kube-scheduler-minikube_kube-system_be132fe5c6572cb34d93f5e05ce2a540_2
</span><span class='line'>75ce75e37ceb   b07520cd7ab7           "kube-controller-man…"   51 minutes ago   Up 51 minutes             k8s_kube-controller-manager_kube-controller-manager-minikube_kube-system_b965983ec05322d0973594a01d5e8245_2
</span><span class='line'>50c302912f4a   25f8c7f3da61           "etcd --advertise-cl…"   51 minutes ago   Up 51 minutes             k8s_etcd_etcd-minikube_kube-system_9d3d310935e5fabe942511eec3e2cd0c_2
</span><span class='line'>0b1c094b5824   k8s.gcr.io/pause:3.6   "/pause"                 51 minutes ago   Up 51 minutes             k8s_POD_kube-controller-manager-minikube_kube-system_b965983ec05322d0973594a01d5e8245_2
</span><span class='line'>7b6d52353935   k8s.gcr.io/pause:3.6   "/pause"                 51 minutes ago   Up 51 minutes             k8s_POD_kube-scheduler-minikube_kube-system_be132fe5c6572cb34d93f5e05ce2a540_2
</span><span class='line'>64ba4b4c1a84   k8s.gcr.io/pause:3.6   "/pause"                 51 minutes ago   Up 51 minutes             k8s_POD_etcd-minikube_kube-system_9d3d310935e5fabe942511eec3e2cd0c_2
</span><span class='line'>92f05324a447   k8s.gcr.io/pause:3.6   "/pause"                 51 minutes ago   Up 51 minutes             k8s_POD_kube-apiserver-minikube_kube-system_cd6e47233d36a9715b0ab9632f871843_2
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ minikube addons list
</span><span class='line'>|-----------------------------|----------|--------------|--------------------------------|
</span><span class='line'>|         ADDON NAME          | PROFILE  |    STATUS    |           MAINTAINER           |
</span><span class='line'>|-----------------------------|----------|--------------|--------------------------------|
</span><span class='line'>| ambassador                  | minikube | disabled     | third-party (ambassador)       |
</span><span class='line'>| auto-pause                  | minikube | disabled     | google                         |
</span><span class='line'>| csi-hostpath-driver         | minikube | disabled     | kubernetes                     |
</span><span class='line'>| dashboard                   | minikube | enabled ✅   | kubernetes                     |
</span><span class='line'>| default-storageclass        | minikube | enabled ✅   | kubernetes                     |
</span><span class='line'>| efk                         | minikube | disabled     | third-party (elastic)          |
</span><span class='line'>| freshpod                    | minikube | disabled     | google                         |
</span><span class='line'>| gcp-auth                    | minikube | disabled     | google                         |
</span><span class='line'>| gvisor                      | minikube | disabled     | google                         |
</span><span class='line'>| helm-tiller                 | minikube | disabled     | third-party (helm)             |
</span><span class='line'>| ingress                     | minikube | disabled     | unknown (third-party)          |
</span><span class='line'>| ingress-dns                 | minikube | disabled     | google                         |
</span><span class='line'>| istio                       | minikube | disabled     | third-party (istio)            |
</span><span class='line'>| istio-provisioner           | minikube | disabled     | third-party (istio)            |
</span><span class='line'>| kong                        | minikube | disabled     | third-party (Kong HQ)          |
</span><span class='line'>| kubevirt                    | minikube | disabled     | third-party (kubevirt)         |
</span><span class='line'>| logviewer                   | minikube | disabled     | unknown (third-party)          |
</span><span class='line'>| metallb                     | minikube | disabled     | third-party (metallb)          |
</span><span class='line'>| metrics-server              | minikube | disabled     | kubernetes                     |
</span><span class='line'>| nvidia-driver-installer     | minikube | disabled     | google                         |
</span><span class='line'>| nvidia-gpu-device-plugin    | minikube | disabled     | third-party (nvidia)           |
</span><span class='line'>| olm                         | minikube | disabled     | third-party (operator          |
</span><span class='line'>|                             |          |              | framework)                     |
</span><span class='line'>| pod-security-policy         | minikube | disabled     | unknown (third-party)          |
</span><span class='line'>| portainer                   | minikube | disabled     | portainer.io                   |
</span><span class='line'>| registry                    | minikube | disabled     | google                         |
</span><span class='line'>| registry-aliases            | minikube | disabled     | unknown (third-party)          |
</span><span class='line'>| registry-creds              | minikube | disabled     | third-party (upmc enterprises) |
</span><span class='line'>| storage-provisioner         | minikube | enabled ✅   | google                         |
</span><span class='line'>| storage-provisioner-gluster | minikube | disabled     | unknown (third-party)          |
</span><span class='line'>| volumesnapshots             | minikube | disabled     | kubernetes                     |
</span><span class='line'>|-----------------------------|----------|--------------|--------------------------------|
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ minikube delete --all
</span><span class='line'>* Deleting "minikube" in docker ...
</span><span class='line'>* Removing /home/ec2-user/.minikube/machines/minikube ...
</span><span class='line'>* Removed all traces of the "minikube" cluster.
</span><span class='line'>* Successfully deleted all profiles
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#Create a second cluster running an older Kubernetes release:
</span><span class='line'># minikube start -p aged --kubernetes-version=v1.16.1
</span></code></pre></td></tr></table></div></figure>


<h2>k3d</h2>

<ul>
<li><a href="https://k3d.io/v5.4.1/">https://k3d.io/v5.4.1/</a>
k3d is a lightweight wrapper to run k3s (Rancher Lab’s minimal Kubernetes distribution) in docker.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ wget -q -O - https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
</span><span class='line'>Preparing to install k3d into /usr/local/bin
</span><span class='line'>k3d installed into /usr/local/bin/k3d
</span><span class='line'>Run 'k3d --help' to see what you can do with it.
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ k3d cluster create mycluster
</span><span class='line'>INFO[0000] Prep: Network                                
</span><span class='line'>INFO[0000] Created network 'k3d-mycluster'              
</span><span class='line'>INFO[0000] Created image volume k3d-mycluster-images    
</span><span class='line'>INFO[0000] Starting new tools node...                   
</span><span class='line'>INFO[0001] Creating node 'k3d-mycluster-server-0'       
</span><span class='line'>INFO[0003] Pulling image 'ghcr.io/k3d-io/k3d-tools:5.4.1' 
</span><span class='line'>INFO[0007] Pulling image 'docker.io/rancher/k3s:v1.22.7-k3s1' 
</span><span class='line'>INFO[0009] Starting Node 'k3d-mycluster-tools'          
</span><span class='line'>INFO[0084] Creating LoadBalancer 'k3d-mycluster-serverlb' 
</span><span class='line'>INFO[0087] Pulling image 'ghcr.io/k3d-io/k3d-proxy:5.4.1' 
</span><span class='line'>INFO[0098] Using the k3d-tools node to gather environment information 
</span><span class='line'>INFO[0098] HostIP: using network gateway 172.18.0.1 address 
</span><span class='line'>INFO[0098] Starting cluster 'mycluster'                 
</span><span class='line'>INFO[0098] Starting servers...                          
</span><span class='line'>INFO[0098] Starting Node 'k3d-mycluster-server-0'       
</span><span class='line'>INFO[0104] All agents already running.                  
</span><span class='line'>INFO[0104] Starting helpers...                          
</span><span class='line'>INFO[0104] Starting Node 'k3d-mycluster-serverlb'       
</span><span class='line'>INFO[0111] Injecting records for hostAliases (incl. host.k3d.internal) and for 2 network members into CoreDNS configmap... 
</span><span class='line'>INFO[0114] Cluster 'mycluster' created successfully!    
</span><span class='line'>INFO[0114] You can now use it like this:                
</span><span class='line'>kubectl cluster-info
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker ps 
</span><span class='line'>CONTAINER ID   IMAGE                            COMMAND                  CREATED         STATUS         PORTS                             NAMES
</span><span class='line'>5d57c1328e66   ghcr.io/k3d-io/k3d-proxy:5.4.1   "/bin/sh -c nginx-pr…"   6 minutes ago   Up 6 minutes   80/tcp, 0.0.0.0:41489-&gt;6443/tcp   k3d-mycluster-serverlb
</span><span class='line'>add7ac133348   rancher/k3s:v1.22.7-k3s1         "/bin/k3s server --t…"   6 minutes ago   Up 6 minutes                                     k3d-mycluster-server-0
</span><span class='line'>
</span><span class='line'># 注意：上面的kubectl是minikue的，需要下载
</span><span class='line'>[ec2-user@amazonlinux ~]$ curl -LO https://dl.k8s.io/release/v1.23.0/bin/linux/amd64/kubectl
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100   154  100   154    0     0    230      0 --:--:-- --:--:-- --:--:--   230
</span><span class='line'>100 44.4M  100 44.4M    0     0  1989k      0  0:00:22  0:00:22 --:--:-- 2256k
</span><span class='line'>[ec2-user@amazonlinux ~]$ ll
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo cp kubectl /usr/local/bin/
</span><span class='line'>[ec2-user@amazonlinux ~]$ which kubectl
</span><span class='line'>/usr/local/bin/kubectl
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl get nodes
</span><span class='line'>NAME                     STATUS   ROLES                  AGE   VERSION
</span><span class='line'>k3d-mycluster-server-0   Ready    control-plane,master   47m   v1.22.7+k3s1
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl get pods -A 
</span><span class='line'>NAMESPACE     NAME                                      READY   STATUS      RESTARTS      AGE
</span><span class='line'>kube-system   local-path-provisioner-84bb864455-s8t7f   1/1     Running     0             45m
</span><span class='line'>kube-system   coredns-96cc4f57d-vvmrx                   1/1     Running     0             45m
</span><span class='line'>kube-system   helm-install-traefik-crd--1-ghv9f         0/1     Completed   0             45m
</span><span class='line'>kube-system   helm-install-traefik--1-s4ktb             0/1     Completed   1             45m
</span><span class='line'>kube-system   svclb-traefik-9jt5d                       2/2     Running     1 (44m ago)   44m
</span><span class='line'>kube-system   metrics-server-ff9dbcb6c-72mwc            1/1     Running     0             45m
</span><span class='line'>kube-system   traefik-56c4b88c4b-f454f                  1/1     Running     0             44m
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ k3d cluster list 
</span><span class='line'>NAME        SERVERS   AGENTS   LOADBALANCER
</span><span class='line'>mycluster   1/1       0/0      true
</span><span class='line'>[ec2-user@amazonlinux ~]$ k3d node create worker1 --cluster mycluster
</span><span class='line'>INFO[0000] Adding 1 node(s) to the runtime local cluster 'mycluster'... 
</span><span class='line'>INFO[0000] Using the k3d-tools node to gather environment information 
</span><span class='line'>INFO[0000] Starting new tools node...                   
</span><span class='line'>INFO[0000] Starting Node 'k3d-mycluster-tools'          
</span><span class='line'>INFO[0001] HostIP: using network gateway 172.18.0.1 address 
</span><span class='line'>INFO[0001] Starting Node 'k3d-worker1-0'                
</span><span class='line'>INFO[0009] Successfully created 1 node(s)!              
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl get nodes
</span><span class='line'>NAME                     STATUS     ROLES                  AGE   VERSION
</span><span class='line'>k3d-mycluster-server-0   Ready      control-plane,master   50m   v1.22.7+k3s1
</span><span class='line'>k3d-worker1-0            NotReady   &lt;none&gt;                 7s    v1.22.7+k3s1
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl get nodes                          
</span><span class='line'>NAME                     STATUS   ROLES                  AGE   VERSION
</span><span class='line'>k3d-mycluster-server-0   Ready    control-plane,master   50m   v1.22.7+k3s1
</span><span class='line'>k3d-worker1-0            Ready    &lt;none&gt;                 24s   v1.22.7+k3s1
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://k3d.io/v5.4.1/usage/exposing_services/">https://k3d.io/v5.4.1/usage/exposing_services/</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ cat .vimrc 
</span><span class='line'>set paste
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ cat thatfile.yaml 
</span><span class='line'>apiVersion: networking.k8s.io/v1
</span><span class='line'>kind: Ingress
</span><span class='line'>metadata:
</span><span class='line'>  name: nginx
</span><span class='line'>  annotations:
</span><span class='line'>    ingress.kubernetes.io/ssl-redirect: "false"
</span><span class='line'>spec:
</span><span class='line'>  rules:
</span><span class='line'>  - http:
</span><span class='line'>      paths:
</span><span class='line'>      - path: /
</span><span class='line'>        pathType: Prefix
</span><span class='line'>        backend:
</span><span class='line'>          service:
</span><span class='line'>            name: nginx
</span><span class='line'>            port:
</span><span class='line'>              number: 80
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ export KUBECONFIG="$(k3d kubeconfig write mycluster)"  
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl create deployment nginx --image=nginx
</span><span class='line'>deployment.apps/nginx created
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl create service clusterip nginx --tcp=80:80
</span><span class='line'>service/nginx created
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl apply -f thatfile.yaml
</span><span class='line'>ingress.networking.k8s.io/nginx created
</span></code></pre></td></tr></table></div></figure>


<p>查看结果：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ kubectl get all -A -o wide
</span><span class='line'>NAMESPACE     NAME                                          READY   STATUS      RESTARTS      AGE     IP          NODE                     NOMINATED NODE   READINESS GATES
</span><span class='line'>kube-system   pod/local-path-provisioner-84bb864455-s8t7f   1/1     Running     0             64m     10.42.0.5   k3d-mycluster-server-0   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   pod/coredns-96cc4f57d-vvmrx                   1/1     Running     0             64m     10.42.0.6   k3d-mycluster-server-0   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   pod/helm-install-traefik-crd--1-ghv9f         0/1     Completed   0             64m     10.42.0.4   k3d-mycluster-server-0   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   pod/helm-install-traefik--1-s4ktb             0/1     Completed   1             64m     10.42.0.3   k3d-mycluster-server-0   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   pod/svclb-traefik-9jt5d                       2/2     Running     1 (63m ago)   63m     10.42.0.7   k3d-mycluster-server-0   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   pod/metrics-server-ff9dbcb6c-72mwc            1/1     Running     0             64m     10.42.0.2   k3d-mycluster-server-0   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   pod/traefik-56c4b88c4b-f454f                  1/1     Running     0             63m     10.42.0.8   k3d-mycluster-server-0   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   pod/svclb-traefik-dvvrp                       2/2     Running     1 (13m ago)   14m     10.42.1.2   k3d-worker1-0            &lt;none&gt;           &lt;none&gt;
</span><span class='line'>default       pod/nginx-6799fc88d8-vgc9x                    1/1     Running     0             4m34s   10.42.1.3   k3d-worker1-0            &lt;none&gt;           &lt;none&gt;
</span><span class='line'>
</span><span class='line'>NAMESPACE     NAME                     TYPE           CLUSTER-IP      EXTERNAL-IP             PORT(S)                      AGE     SELECTOR
</span><span class='line'>default       service/kubernetes       ClusterIP      10.43.0.1       &lt;none&gt;                  443/TCP                      64m     &lt;none&gt;
</span><span class='line'>kube-system   service/kube-dns         ClusterIP      10.43.0.10      &lt;none&gt;                  53/UDP,53/TCP,9153/TCP       64m     k8s-app=kube-dns
</span><span class='line'>kube-system   service/metrics-server   ClusterIP      10.43.88.129    &lt;none&gt;                  443/TCP                      64m     k8s-app=metrics-server
</span><span class='line'>kube-system   service/traefik          LoadBalancer   10.43.4.2       172.18.0.2,172.18.0.4   80:32037/TCP,443:30484/TCP   63m     app.kubernetes.io/instance=traefik,app.kubernetes.io/name=traefik
</span><span class='line'>default       service/nginx            ClusterIP      10.43.206.223   &lt;none&gt;                  80/TCP                       4m30s   app=nginx
</span><span class='line'>
</span><span class='line'>NAMESPACE     NAME                           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE   CONTAINERS               IMAGES                                                SELECTOR
</span><span class='line'>kube-system   daemonset.apps/svclb-traefik   2         2         2       2            2           &lt;none&gt;          63m   lb-port-80,lb-port-443   rancher/klipper-lb:v0.3.4,rancher/klipper-lb:v0.3.4   app=svclb-traefik
</span><span class='line'>
</span><span class='line'>NAMESPACE     NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS               IMAGES                                   SELECTOR
</span><span class='line'>kube-system   deployment.apps/local-path-provisioner   1/1     1            1           64m     local-path-provisioner   rancher/local-path-provisioner:v0.0.21   app=local-path-provisioner
</span><span class='line'>kube-system   deployment.apps/coredns                  1/1     1            1           64m     coredns                  rancher/mirrored-coredns-coredns:1.8.6   k8s-app=kube-dns
</span><span class='line'>kube-system   deployment.apps/metrics-server           1/1     1            1           64m     metrics-server           rancher/mirrored-metrics-server:v0.5.2   k8s-app=metrics-server
</span><span class='line'>kube-system   deployment.apps/traefik                  1/1     1            1           63m     traefik                  rancher/mirrored-library-traefik:2.6.1   app.kubernetes.io/instance=traefik,app.kubernetes.io/name=traefik
</span><span class='line'>default       deployment.apps/nginx                    1/1     1            1           4m34s   nginx                    nginx                                    app=nginx
</span><span class='line'>
</span><span class='line'>NAMESPACE     NAME                                                DESIRED   CURRENT   READY   AGE     CONTAINERS               IMAGES                                   SELECTOR
</span><span class='line'>kube-system   replicaset.apps/local-path-provisioner-84bb864455   1         1         1       64m     local-path-provisioner   rancher/local-path-provisioner:v0.0.21   app=local-path-provisioner,pod-template-hash=84bb864455
</span><span class='line'>kube-system   replicaset.apps/coredns-96cc4f57d                   1         1         1       64m     coredns                  rancher/mirrored-coredns-coredns:1.8.6   k8s-app=kube-dns,pod-template-hash=96cc4f57d
</span><span class='line'>kube-system   replicaset.apps/metrics-server-ff9dbcb6c            1         1         1       64m     metrics-server           rancher/mirrored-metrics-server:v0.5.2   k8s-app=metrics-server,pod-template-hash=ff9dbcb6c
</span><span class='line'>kube-system   replicaset.apps/traefik-56c4b88c4b                  1         1         1       63m     traefik                  rancher/mirrored-library-traefik:2.6.1   app.kubernetes.io/instance=traefik,app.kubernetes.io/name=traefik,pod-template-hash=56c4b88c4b
</span><span class='line'>default       replicaset.apps/nginx-6799fc88d8                    1         1         1       4m34s   nginx                    nginx                                    app=nginx,pod-template-hash=6799fc88d8
</span><span class='line'>
</span><span class='line'>NAMESPACE     NAME                                 COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES                                      SELECTOR
</span><span class='line'>kube-system   job.batch/helm-install-traefik-crd   1/1           52s        64m   helm         rancher/klipper-helm:v0.6.6-build20211022   controller-uid=1d4ac20d-0436-4d54-9d8b-e37fe7c46e6e
</span><span class='line'>kube-system   job.batch/helm-install-traefik       1/1           53s        64m   helm         rancher/klipper-helm:v0.6.6-build20211022   controller-uid=b51475a5-3fac-4b96-b218-7dd7a094512b
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ kubectl get ingress 
</span><span class='line'>NAME    CLASS    HOSTS   ADDRESS                 PORTS   AGE
</span><span class='line'>nginx   &lt;none&gt;   *       172.18.0.2,172.18.0.4   80      3m18s
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ curl 172.18.0.2
</span><span class='line'>&lt;!DOCTYPE html&gt;
</span><span class='line'>&lt;html&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span><span class='line'>&lt;style&gt;
</span><span class='line'>html { color-scheme: light dark; }
</span><span class='line'>body { width: 35em; margin: 0 auto;
</span><span class='line'>font-family: Tahoma, Verdana, Arial, sans-serif; }
</span><span class='line'>&lt;/style&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>&lt;body&gt;
</span><span class='line'>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span><span class='line'>working. Further configuration is required.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;For online documentation and support please refer to
</span><span class='line'>&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span><span class='line'>Commercial support is available at
</span><span class='line'>&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/03/26/k8s-ingress/">K8s Ingress</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-03-26T13:59:16+08:00" pubdate data-updated="true">Sat 2022-03-26 13:59</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>Ingress是一个集中的集群应用网关，自动化的k8s反向代理组件（功能类比nginx）。</p>

<p>Ingress涉及到LoadBalancer，Ingress Controller, Ingress config等相关概念。controller从LoadBalancer/NodePort把当前的服务发布出去，同时监听Ingress config实时的修改当前Ingress配置(实时更新nginx.conf配置文件，并重载)</p>

<p>这里仅从helloworld入门实践操作进行。</p>

<h2>入门指南</h2>

<h3>参考</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#quick-start">https://kubernetes.github.io/ingress-nginx/deploy/#quick-start</a></li>
<li><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh/docs/concepts/services-networking/ingress/</a></p></li>
<li><p><a href="https://docs.jdcloud.com/cn/jcs-for-kubernetes/deploy-k8s-ingress-nginx">https://docs.jdcloud.com/cn/jcs-for-kubernetes/deploy-k8s-ingress-nginx</a></p></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/concepts/ingress.html">https://jimmysong.io/kubernetes-handbook/concepts/ingress.html</a></li>
</ul>


<p>版本兼容性：
* <a href="https://github.com/kubernetes/ingress-nginx/#support-versions-table">https://github.com/kubernetes/ingress-nginx/#support-versions-table</a></p>

<h3>下载镜像</h3>

<p>镜像在gcr上面，先远程下载回来：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.2/deploy/static/provider/cloud/deploy.yaml 
</span><span class='line'>[ec2-user@k8s ~]$ vi ingress-nginx-controller-v1.1.2.yaml
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ grep image: ingress-nginx-controller-v1.1.2.yaml | sed 's/image: //' | sort -u | xargs echo 
</span><span class='line'>k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# docker pull k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c 
</span><span class='line'>k8s.gcr.io/ingress-nginx/controller@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c: Pulling from ingress-nginx/controller
</span><span class='line'>a0d0a0d46f8b: Pull complete 
</span><span class='line'>3aae86482564: Pull complete 
</span><span class='line'>c0d03781abb3: Pull complete 
</span><span class='line'>0297e2ef8f7f: Pull complete 
</span><span class='line'>866a68ce3c13: Pull complete 
</span><span class='line'>1c2a7ca65b54: Pull complete 
</span><span class='line'>41fd2de30e46: Pull complete 
</span><span class='line'>637f10464e4d: Pull complete 
</span><span class='line'>998064a16da4: Pull complete 
</span><span class='line'>e63d23220e8c: Pull complete 
</span><span class='line'>8128610547fb: Pull complete 
</span><span class='line'>ae07a1a7f038: Pull complete 
</span><span class='line'>ceb23c4cb607: Pull complete 
</span><span class='line'>Digest: sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
</span><span class='line'>Status: Downloaded newer image for k8s.gcr.io/ingress-nginx/controller@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
</span><span class='line'>k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# docker pull k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660 
</span><span class='line'>k8s.gcr.io/ingress-nginx/kube-webhook-certgen@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660: Pulling from ingress-nginx/kube-webhook-certgen
</span><span class='line'>ec52731e9273: Pull complete 
</span><span class='line'>b90aa28117d4: Pull complete 
</span><span class='line'>Digest: sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>Status: Downloaded newer image for k8s.gcr.io/ingress-nginx/kube-webhook-certgen@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# docker save k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660 -o ingress-nginx-v1.1.2.tar
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# gzip ingress-nginx-v1.1.2.tar 
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# ll -h ingress-nginx-v1.1.2.tar.gz 
</span><span class='line'>-rw------- 1 root root 116M Mar 24 23:49 ingress-nginx-v1.1.2.tar.gz
</span></code></pre></td></tr></table></div></figure>


<p>本地Linux服务器加载镜像</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ docker load -i k8s.gcr.io-ingress-nginx-v1.1.2.tar.gz 
</span><span class='line'>c0d270ab7e0d: Loading layer [==================================================&gt;]  3.697MB/3.697MB
</span><span class='line'>ce7a3c1169b6: Loading layer [==================================================&gt;]  45.38MB/45.38MB
</span><span class='line'>e2eb06d8af82: Loading layer [==================================================&gt;]  5.865MB/5.865MB
</span><span class='line'>ab1476f3fdd9: Loading layer [==================================================&gt;]  120.9MB/120.9MB
</span><span class='line'>ad20729656ef: Loading layer [==================================================&gt;]  4.096kB/4.096kB
</span><span class='line'>0d5022138006: Loading layer [==================================================&gt;]  38.09MB/38.09MB
</span><span class='line'>8f757e3fe5e4: Loading layer [==================================================&gt;]  21.42MB/21.42MB
</span><span class='line'>d2bc6b915bc9: Loading layer [==================================================&gt;]  4.019MB/4.019MB
</span><span class='line'>bbeb6784ed45: Loading layer [==================================================&gt;]  313.9kB/313.9kB
</span><span class='line'>0c411e83ee78: Loading layer [==================================================&gt;]  6.141MB/6.141MB
</span><span class='line'>9c2d86dc137f: Loading layer [==================================================&gt;]  38.45MB/38.45MB
</span><span class='line'>7797e5b3a760: Loading layer [==================================================&gt;]  2.754MB/2.754MB
</span><span class='line'>98ef19df5514: Loading layer [==================================================&gt;]  4.096kB/4.096kB
</span><span class='line'>4cde87c7ecaf: Loading layer [==================================================&gt;]  51.75MB/51.75MB
</span><span class='line'>11536690d74a: Loading layer [==================================================&gt;]  3.584kB/3.584kB
</span><span class='line'>Loaded image ID: sha256:c41e9fcadf5a291120de706b7dfa1af598b9f2ed5138b6dcb9f79a68aad0ef4c
</span><span class='line'>Loaded image ID: sha256:7e5c1cecb086f36c6ef4b319a60853020820997f3600c3687e8ba6139e83674d
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ cat k8s.gcr.io-ingress-nginx-v1.1.2.tar.gz | ssh worker1 docker load 
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>docker tag 7e5c1cecb086 k8s.gcr.io/ingress-nginx/controller:v1.1.2
</span><span class='line'>docker tag c41e9fcadf5a k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>注：由于配置中用了sha码，下载后tag不同，把image最后的 @sha256:xxx 删掉
</span><span class='line'>vi ingress-nginx-controller-v1.1.2.yaml
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h3>创建服务</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f ingress-nginx-controller-v1.1.2.yaml
</span><span class='line'>namespace/ingress-nginx created
</span><span class='line'>serviceaccount/ingress-nginx created
</span><span class='line'>serviceaccount/ingress-nginx-admission created
</span><span class='line'>role.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>role.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>clusterrole.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>rolebinding.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>configmap/ingress-nginx-controller created
</span><span class='line'>service/ingress-nginx-controller created
</span><span class='line'>service/ingress-nginx-controller-admission created
</span><span class='line'>deployment.apps/ingress-nginx-controller created
</span><span class='line'>job.batch/ingress-nginx-admission-create created
</span><span class='line'>job.batch/ingress-nginx-admission-patch created
</span><span class='line'>ingressclass.networking.k8s.io/nginx created
</span><span class='line'>validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl wait --namespace ingress-nginx \
</span><span class='line'>   --for=condition=ready pod \
</span><span class='line'>   --selector=app.kubernetes.io/component=controller \
</span><span class='line'>   --timeout=120s
</span><span class='line'>pod/ingress-nginx-controller-755447bb4d-rnxvl condition met
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 状态参考：
</span><span class='line'># https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --namespace=ingress-nginx
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get all -n ingress-nginx
</span><span class='line'>NAME                                            READY   STATUS      RESTARTS   AGE
</span><span class='line'>pod/ingress-nginx-admission-create-hbt9d        0/1     Completed   0          2m51s
</span><span class='line'>pod/ingress-nginx-admission-patch-j8qfh         0/1     Completed   1          2m51s
</span><span class='line'>pod/ingress-nginx-controller-755447bb4d-rnxvl   1/1     Running     0          2m51s
</span><span class='line'>
</span><span class='line'>NAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
</span><span class='line'>service/ingress-nginx-controller             LoadBalancer   10.104.8.155    &lt;pending&gt;     80:31031/TCP,443:31845/TCP   2m51s
</span><span class='line'>service/ingress-nginx-controller-admission   ClusterIP      10.108.67.255   &lt;none&gt;        443/TCP                      2m51s
</span><span class='line'>
</span><span class='line'>NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>deployment.apps/ingress-nginx-controller   1/1     1            1           2m51s
</span><span class='line'>
</span><span class='line'>NAME                                                  DESIRED   CURRENT   READY   AGE
</span><span class='line'>replicaset.apps/ingress-nginx-controller-755447bb4d   1         1         1       2m51s
</span><span class='line'>
</span><span class='line'>NAME                                       COMPLETIONS   DURATION   AGE
</span><span class='line'>job.batch/ingress-nginx-admission-create   1/1           3s         2m51s
</span><span class='line'>job.batch/ingress-nginx-admission-patch    1/1           3s         2m51s
</span></code></pre></td></tr></table></div></figure>


<p>看到 ingress-nginx-controller 服务的 <code>EXTERNAL-IP</code> 为 <code>&lt;pending&gt;</code> ，由于本地搭建并没有配备负载均衡器，所以没有手段，获取不到对外的IP。</p>

<h3>本地测试</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl create deployment demo --image=httpd --port=80
</span><span class='line'>deployment.apps/demo created
</span><span class='line'>[ec2-user@k8s ~]$ kubectl expose deployment demo
</span><span class='line'>service/demo exposed
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl create ingress demo-localhost --class=nginx \
</span><span class='line'>   --rule=demo.localdev.me/*=demo:80
</span><span class='line'>ingress.networking.k8s.io/demo-localhost created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl port-forward --namespace=ingress-nginx service/ingress-nginx-controller 8080:80
</span><span class='line'>Forwarding from 127.0.0.1:8080 -&gt; 80
</span><span class='line'>Forwarding from [::1]:8080 -&gt; 80
</span><span class='line'>Handling connection for 8080
</span><span class='line'>Handling connection for 8080
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ curl http://demo.localdev.me:8080/
</span><span class='line'>&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<p>clean</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl delete deployment demo 
</span><span class='line'>kubectl delete service demo 
</span><span class='line'>kubectl delete ingress demo</span></code></pre></td></tr></table></div></figure>


<h2>集成（发布）</h2>

<h3>cloud</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#aws">https://kubernetes.github.io/ingress-nginx/deploy/#aws</a></li>
</ul>


<p>配置云厂商的负载均衡器。</p>

<h3>baremetal: nodeport</h3>

<p>适用于部署在裸机服务器上的 Kubernetes 集群，以及使用通用 Linux 发行版手动安装 Kubernetes 的 [原始] 虚拟机</p>

<p>为了快速测试，您可以使用 NodePort。这应该适用于几乎每个集群，但它通常会使用 30000-32767 范围内的端口。</p>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters">https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.2/deploy/static/provider/baremetal/deploy.yaml
</span></code></pre></td></tr></table></div></figure>


<p>注：也可以通过修改配置使用80，443等端口，但不推荐。</p>

<h3>baremetal: hostNetwork</h3>

<p>ingress nginx controller的pod网络直接使用主机网络，这个比Service Nodeport稍微灵活一点，可以自己选择/管理端口。</p>

<h3>A pure software solution: MetalLB</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb</a></li>
<li><a href="https://metallb.universe.tf/concepts/">https://metallb.universe.tf/concepts/</a></li>
</ul>


<p>It has two features that work together to provide this service: address allocation, and external announcement.</p>

<p>After MetalLB has assigned an external IP address to a service, it needs to make the network beyond the cluster aware that the IP “lives” in the cluster. MetalLB uses standard routing protocols to achieve this: ARP, NDP, or BGP.</p>

<h4>安装</h4>

<ul>
<li><a href="https://metallb.universe.tf/installation/">https://metallb.universe.tf/installation/</a></li>
</ul>


<p>需要kube-proxy配置arp为true。得与局域网进行广播通信，所以需要开启arp功能（标准路由协议）。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl edit configmap -n kube-system kube-proxy
</span><span class='line'>
</span><span class='line'>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span><span class='line'>kind: KubeProxyConfiguration
</span><span class='line'>mode: "ipvs"
</span><span class='line'>ipvs:
</span><span class='line'>  strictARP: true</span></code></pre></td></tr></table></div></figure>


<p>或者批处理一步到位</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># see what changes would be made, returns nonzero returncode if different
</span><span class='line'>kubectl get configmap kube-proxy -n kube-system -o yaml | \
</span><span class='line'>sed -e "s/strictARP: false/strictARP: true/" | \
</span><span class='line'>kubectl diff -f - -n kube-system
</span><span class='line'>
</span><span class='line'># actually apply the changes, returns nonzero returncode on errors only
</span><span class='line'>kubectl get configmap kube-proxy -n kube-system -o yaml | \
</span><span class='line'>sed -e "s/strictARP: false/strictARP: true/" | \
</span><span class='line'>kubectl apply -f - -n kube-system
</span></code></pre></td></tr></table></div></figure>


<p>安装</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml
</span><span class='line'>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml
</span></code></pre></td></tr></table></div></figure>


<p>下载镜像慢一点，需要稍微多等等。再查看状态：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get all -n metallb-system
</span><span class='line'>NAME                             READY   STATUS    RESTARTS   AGE
</span><span class='line'>pod/controller-57fd9c5bb-kc5zt   1/1     Running   0          5m55s
</span><span class='line'>pod/speaker-8pg4v                1/1     Running   0          5m55s
</span><span class='line'>pod/speaker-95bs8                1/1     Running   0          5m55s
</span><span class='line'>
</span><span class='line'>NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
</span><span class='line'>daemonset.apps/speaker   2         2         2       2            2           kubernetes.io/os=linux   5m55s
</span><span class='line'>
</span><span class='line'>NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>deployment.apps/controller   1/1     1            1           5m55s
</span><span class='line'>
</span><span class='line'>NAME                                   DESIRED   CURRENT   READY   AGE
</span><span class='line'>replicaset.apps/controller-57fd9c5bb   1         1         1       5m55s
</span></code></pre></td></tr></table></div></figure>


<h4>配置地址</h4>

<ul>
<li><p><a href="https://metallb.universe.tf/configuration/#layer-2-configuration">https://metallb.universe.tf/configuration/#layer-2-configuration</a></p></li>
<li><p><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb</a></p></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 查看主机ip，避开这些节点IP的区间
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get node -o wide
</span><span class='line'>NAME      STATUS   ROLES                  AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME
</span><span class='line'>k8s       Ready    control-plane,master   10d   v1.23.5   192.168.191.131   &lt;none&gt;        Amazon Linux 2   4.14.268-205.500.amzn2.x86_64   docker://20.10.7
</span><span class='line'>worker1   Ready    &lt;none&gt;                 10d   v1.23.5   192.168.191.132   &lt;none&gt;        Amazon Linux 2   4.14.268-205.500.amzn2.x86_64   docker://20.10.7
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ cat metallb-config.yml
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: ConfigMap
</span><span class='line'>metadata:
</span><span class='line'>  namespace: metallb-system
</span><span class='line'>  name: config
</span><span class='line'>data:
</span><span class='line'>  config: |
</span><span class='line'>    address-pools:
</span><span class='line'>    - name: default
</span><span class='line'>      protocol: layer2
</span><span class='line'>      addresses:
</span><span class='line'>      - 192.168.191.200-192.168.191.220
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f metallb-config.yml 
</span><span class='line'>configmap/config created
</span></code></pre></td></tr></table></div></figure>


<p>然后，再回过头重新安装一遍nginx-ingress：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --namespace=ingress-nginx
</span><span class='line'>NAME                                        READY   STATUS      RESTARTS   AGE
</span><span class='line'>ingress-nginx-admission-create-b9hkn        0/1     Completed   0          17s
</span><span class='line'>ingress-nginx-admission-patch-xmnbr         0/1     Completed   1          17s
</span><span class='line'>ingress-nginx-controller-755447bb4d-lfrwk   0/1     Running     0          17s
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --namespace=ingress-nginx
</span><span class='line'>NAME                                        READY   STATUS      RESTARTS   AGE
</span><span class='line'>ingress-nginx-admission-create-b9hkn        0/1     Completed   0          25s
</span><span class='line'>ingress-nginx-admission-patch-xmnbr         0/1     Completed   1          25s
</span><span class='line'>ingress-nginx-controller-755447bb4d-lfrwk   1/1     Running     0          25s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl -n ingress-nginx get svc
</span><span class='line'>NAME                                 TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
</span><span class='line'>ingress-nginx-controller             LoadBalancer   10.107.221.243   192.168.191.200   80:31443/TCP,443:30099/TCP   57s
</span><span class='line'>ingress-nginx-controller-admission   ClusterIP      10.105.12.185    &lt;none&gt;            443/TCP                      57s
</span></code></pre></td></tr></table></div></figure>


<p>这次 EXTERNAL-IP 的ip就有值了，上面配置的ip段里面一个ip。</p>

<h3>在线/集成测试</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#online-testing">https://kubernetes.github.io/ingress-nginx/deploy/#online-testing</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get service ingress-nginx-controller --namespace=ingress-nginx
</span><span class='line'>NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
</span><span class='line'>ingress-nginx-controller   LoadBalancer   10.107.221.243   192.168.191.200   80:31443/TCP,443:30099/TCP   4m
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl create deployment demo --image=httpd --port=80
</span><span class='line'>deployment.apps/demo created
</span><span class='line'>[ec2-user@k8s ~]$ kubectl expose deployment demo
</span><span class='line'>service/demo exposed
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl create ingress demo --class=nginx \
</span><span class='line'>   --rule="www.demo.io/*=demo:80"
</span><span class='line'>ingress.networking.k8s.io/demo created
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get ingress 
</span><span class='line'>NAME   CLASS   HOSTS         ADDRESS   PORTS   AGE
</span><span class='line'>demo   nginx   www.demo.io             80      42s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get ingress 
</span><span class='line'>NAME   CLASS   HOSTS         ADDRESS           PORTS   AGE
</span><span class='line'>demo   nginx   www.demo.io   192.168.191.200   80      27m
</span></code></pre></td></tr></table></div></figure>


<p>在本地windows机器的 <code>C:/Windows/System32/drivers/etc/hosts</code> 增加 <code>192.168.191.200 www.demo.io</code> ，然后浏览器访问 <code>http://www.demo.io/</code> ，顺利的话就能在浏览器看到：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>It works!</span></code></pre></td></tr></table></div></figure>


<h3>后记</h3>

<h4>理一下网络调用，其实就是nginx的方式：</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl logs --tail=2 pod/demo-764c97f6fd-q5xts
</span><span class='line'>10.244.2.79 - - [28/Mar/2022:09:52:36 +0000] "GET / HTTP/1.1" 200 45
</span><span class='line'>10.244.2.79 - - [28/Mar/2022:09:52:36 +0000] "GET /favicon.ico HTTP/1.1" 404 196
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -n ingress-nginx -o wide 
</span><span class='line'>NAME                                        READY   STATUS      RESTARTS   AGE    IP            NODE      NOMINATED NODE   READINESS GATES
</span><span class='line'>ingress-nginx-admission-create-b9hkn        0/1     Completed   0          157m   10.244.2.78   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>ingress-nginx-admission-patch-xmnbr         0/1     Completed   1          157m   10.244.2.77   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>ingress-nginx-controller-755447bb4d-lfrwk   1/1     Running     0          157m   10.244.2.79   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>
</span><span class='line'># 192.168.191.1是vmware虚拟网卡的地址
</span><span class='line'>[ec2-user@k8s ~]$ kubectl logs --tail=2 pod/ingress-nginx-controller-755447bb4d-lfrwk -n ingress-nginx 
</span><span class='line'>192.168.191.1 - - [28/Mar/2022:09:52:36 +0000] "GET / HTTP/1.1" 200 45 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.82 Safari/537.36" 566 0.000 [default-demo-80] [] 10.244.2.80:80 45 0.000 200 6d52ef8349eb3101c31c3cc6377b982b
</span><span class='line'>192.168.191.1 - - [28/Mar/2022:09:52:36 +0000] "GET /favicon.ico HTTP/1.1" 404 196 "http://www.demo.io/" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.82 Safari/537.36" 506 0.001 [default-demo-80] [] 10.244.2.80:80 196 0.000 404 fefe172a57273977cdcd1455bcf322ac
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>## web
</span><span class='line'>Request URL: http://www.demo.io/
</span><span class='line'>Request Method: GET
</span><span class='line'>Status Code: 200 OK
</span><span class='line'>Remote Address: 192.168.191.200:80
</span><span class='line'>Referrer Policy: strict-origin-when-cross-origin
</span></code></pre></td></tr></table></div></figure>


<h4>看看metallb的日志，ip是怎么分配的</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># https://metallb.universe.tf/concepts/layer2/
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -n metallb-system -o wide
</span><span class='line'>NAME                         READY   STATUS    RESTARTS   AGE     IP                NODE      NOMINATED NODE   READINESS GATES
</span><span class='line'>controller-57fd9c5bb-kc5zt   1/1     Running   0          3h34m   10.244.2.76       worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>speaker-8pg4v                1/1     Running   0          3h34m   192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>speaker-95bs8                1/1     Running   0          3h34m   192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl logs pod/controller-57fd9c5bb-kc5zt -n metallb-system
</span><span class='line'>{"caller":"level.go:63","event":"ipAllocated","ip":["192.168.191.200"],"level":"info","msg":"IP address assigned by controller","service":"ingress-nginx/ingress-nginx-controller","ts":"2022-03-28T07:16:22.675599527Z"}
</span><span class='line'>{"caller":"level.go:63","event":"serviceUpdated","level":"info","msg":"updated service object","service":"ingress-nginx/ingress-nginx-controller","ts":"2022-03-28T07:1
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl logs speaker-8pg4v -n metallb-system 
</span><span class='line'>{"caller":"level.go:63","event":"serviceAnnounced","ips":["192.168.191.200"],"level":"info","msg":"service has IP, announcing","pool":"default","protocol":"layer2","service":"ingress-nginx/ingress-nginx-controller","ts":"2022-03-28T07:16:42.775467559Z"}
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ ping 192.168.191.200
</span><span class='line'>PING 192.168.191.200 (192.168.191.200) 56(84) bytes of data.
</span><span class='line'>^C
</span><span class='line'>--- 192.168.191.200 ping statistics ---
</span><span class='line'>3 packets transmitted, 0 received, 100% packet loss, time 2055ms
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ arp 
</span><span class='line'>Address                  HWtype  HWaddress           Flags Mask            Iface
</span><span class='line'>192.168.191.200          ether   00:0c:29:d5:4f:0f   C                     eth0
</span><span class='line'>
</span><span class='line'># worker1节点的MAC
</span><span class='line'>[ec2-user@worker1 ~]$ ip a | grep -i -C 10 '00:0c:29:d5:4f:0f' 
</span><span class='line'>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
</span><span class='line'>    link/ether 00:0c:29:d5:4f:0f brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.191.132/24 brd 192.168.191.255 scope global dynamic eth0
</span><span class='line'>       valid_lft 1714sec preferred_lft 1714sec
</span><span class='line'>
</span><span class='line'># In layer 2 mode, all traffic for a service IP goes to one node. From there, kube-proxy spreads the traffic to all the service’s pods.
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -A -o wide | grep 192.168.191.132
</span><span class='line'>kube-system            kube-flannel-ds-q4qkt                        1/1     Running     8 (2d10h ago)   11d     192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            kube-proxy-pd77m                             1/1     Running     6 (3d2h ago)    11d     192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>metallb-system         speaker-8pg4v                                1/1     Running     0               5h31m   192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>例子：</h2>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#local-testing">https://kubernetes.github.io/ingress-nginx/deploy/#local-testing</a></li>
<li><a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/">https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/</a></li>
</ul>


<h2>验证</h2>

<ul>
<li><a href="https://www.qikqiak.com/post/visually-explained-k8s-service/">图解 Kubernetes Service</a></li>
<li><a href="https://www.qikqiak.com/post/visually-explained-k8s-ingress/">图解 Kubernetes Ingress</a></li>
</ul>


<p>文中说loadbalancer是通过了nodeport（会创建nodeport），还是有点诧异的。验证一番，果真如此！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get service ingress-nginx-controller --namespace=ingress-nginx
</span><span class='line'>NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
</span><span class='line'>ingress-nginx-controller   LoadBalancer   10.107.221.243   192.168.191.200   80:31443/TCP,443:30099/TCP   34m
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl describe service ingress-nginx-controller --namespace=ingress-nginx
</span><span class='line'>Name:                     ingress-nginx-controller
</span><span class='line'>Namespace:                ingress-nginx
</span><span class='line'>Labels:                   app.kubernetes.io/component=controller
</span><span class='line'>                          app.kubernetes.io/instance=ingress-nginx
</span><span class='line'>                          app.kubernetes.io/managed-by=Helm
</span><span class='line'>                          app.kubernetes.io/name=ingress-nginx
</span><span class='line'>                          app.kubernetes.io/part-of=ingress-nginx
</span><span class='line'>                          app.kubernetes.io/version=1.1.2
</span><span class='line'>                          helm.sh/chart=ingress-nginx-4.0.18
</span><span class='line'>Annotations:              &lt;none&gt;
</span><span class='line'>Selector:                 app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx
</span><span class='line'>Type:                     LoadBalancer
</span><span class='line'>IP Family Policy:         SingleStack
</span><span class='line'>IP Families:              IPv4
</span><span class='line'>IP:                       10.107.221.243
</span><span class='line'>IPs:                      10.107.221.243
</span><span class='line'>LoadBalancer Ingress:     192.168.191.200
</span><span class='line'>Port:                     http  80/TCP
</span><span class='line'>TargetPort:               http/TCP
</span><span class='line'>NodePort:                 http  31443/TCP
</span><span class='line'>Endpoints:                10.244.2.79:80
</span><span class='line'>Port:                     https  443/TCP
</span><span class='line'>TargetPort:               https/TCP
</span><span class='line'>NodePort:                 https  30099/TCP
</span><span class='line'>Endpoints:                10.244.2.79:443
</span><span class='line'>Session Affinity:         None
</span><span class='line'>External Traffic Policy:  Local
</span><span class='line'>HealthCheck NodePort:     31942
</span><span class='line'>Events:
</span><span class='line'>  Type    Reason        Age   From                Message
</span><span class='line'>  ----    ------        ----  ----                -------
</span><span class='line'>  Normal  IPAllocated   38m   metallb-controller  Assigned IP ["192.168.191.200"]
</span><span class='line'>  Normal  nodeAssigned  38m   metallb-speaker     announcing from node "worker1"
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ netstat -anp | grep 31443 
</span><span class='line'>(No info could be read for "-p": geteuid()=1002 but you should be root.)
</span><span class='line'>tcp        0      0 0.0.0.0:31443           0.0.0.0:*               LISTEN      -       
</span><span class='line'>
</span><span class='line'>[ec2-user@worker1 ~]$ netstat -anp | grep 31443
</span><span class='line'>(No info could be read for "-p": geteuid()=1002 but you should be root.)
</span><span class='line'>tcp        0      0 0.0.0.0:31443           0.0.0.0:*               LISTEN      -                   
</span></code></pre></td></tr></table></div></figure>


<h2>其他参考</h2>

<ul>
<li><a href="https://blog.51cto.com/tansong/4850092">多种方式访问AWS EKS的 Kubernetes Dashboard 下篇</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 创建证书
</span><span class='line'>openssl genrsa 2048 &gt; k8s-dashboard-private.key
</span><span class='line'>openssl req -new -x509 -nodes -sha1 -days 3650 -extensions v3_ca -key k8s-dashboard-private.key &gt; k8s-dashboard.crt
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://segmentfault.com/a/1190000019908991">k8s ingress原理及ingress-nginx部署测试</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>
  <h1><a class='category' href='/blog/categories/recommend/'>Recommend</a></h1>
	<ul role="list">
		
			<li class="post">
				<a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/08/25/video-auto-translate/">视频自动翻译</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/06/09/reasonable-way-to-access-the-internet/">科学上网（续）</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/01/20/gitalk-on-octopress/">Gitalk on Octopress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/11/16/sphinx-generate-docs/">使用Sphinx生成/管理文档</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/10/30/windows-run-ubuntu/">Windows Run Ubuntu</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/30/kubeadm-install-kubenetes-on-centos7/">Kubeadm部署kubernetes</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/08/casperjs-crawler/">爬虫之CasperJS</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/05/23/spark-on-hive-speculation-shit-bug/">Hive on Spark预测性执行BUG一枚</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/27/vnc-server-on-centos7/">在Centos7上安装VNC Server</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/25/develop-environment-prepare/">[整理] 环境准备工具集</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/19/nginx-https/">Nginx配置https</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/09/19/163-open-movies-download/">批量下载163-open的视频</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/23/hadoop-guide-catalog/">[整理] Hadoop入门</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/04/rpm-build-your-package/">RPM打包</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/03/28/hive-on-spark/">Hive on Spark</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/11/22/gfw-ladder/">搭梯笔记</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/09/13/review-linux-101-hacks/">【linux 101 Hacks】读后感</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/08/24/manual-install-supervisor/">Supervisor安装配置</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/10/16/spark-build-and-configuration/">编译/搭建Spark环境</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/08/25/step-by-step-found-java-oom-error/">查找逐步定位Java程序OOM的异常实践</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/30/hadoop2-snappy-compress/">Hadoop2 Snappy Compress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/27/start-redis/">[读读书]Redis入门指南</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/04/21/hadoop2-windows-startguide/">Windows下部署/配置/调试hadoop2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/30/git-cheatsheet/">GIT操作记录手册</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/18/jekyll-edit-link-in-web-page/">Jekyll页面添加编辑按钮</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/02/23/quickly-open-program-in-windows/">[Windows运行]快速打开程序</a>
			</li>
		
			<li class="post">
				<a href="/blog/2013/09/19/let-shell-command-efficient/">让敲Shell命令高效起来</a>
			</li>
		
	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/04/19/k8s-nfs-run-example/">K8S官方例子NFS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/04/14/k8s-nfs/">k8s共享存储使用NFS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/04/11/xiaomi-r4a-install-padavan/">Xiaomi R4a Install Padavan</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/04/06/minikube-guide/">Minikube Guide</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/03/26/k8s-ingress/">K8s Ingress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/03/18/k8s-guide-use-kubeadm/">k8s-v1.23.5安装指南 - 使用kubeadm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/03/18/k8s-deps-download/">k8s-v1.23.5依赖下载</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/01/13/openeuler20-dot-03lts-sp3-install-docker/">欧拉20.03LTS_SP3安装docker</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/0/'>0</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/alluxio/'>alluxio</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/android/'>android</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/bigdata/'>bigdata</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blabla/'>blabla</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/debug/'>debug</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/deprecated/'>deprecated</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/devops/'>devops</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (16) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/es/'>es</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/flume/'>flume</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/git/'>git</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (44) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hbase/'>hbase</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hole/'>hole</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jenkins/'>jenkins</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jeykll/'>jeykll</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k2/'>k2</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (15) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kafka/'>kafka</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kubeadm/'>kubeadm</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/logstash/'>logstash</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/map/'>map</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nfs/'>nfs</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/openeuler/'>openeuler</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/r4a/'>r4a</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/recommend/'>recommend</a> (28) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/shell/'>shell</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/staf/'>staf</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tachyon/'>tachyon</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tez/'>tez</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tools/'>tools</a> (70) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/topics/'>topics</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/vagrant/'>vagrant</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/wsl/'>wsl</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/zookeeper/'>zookeeper</a> (1) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (227)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<!--
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
&#8211;>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1253103971'%3E%3C/span%3E%3Cscript src='https://s19.cnzz.com/z_stat.php%3Fid%3D1253103971%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winse.github.io" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>











</body>
</html>
