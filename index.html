
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Winse Blog</title>
  <meta name="author" content="Winse Liu">

  
  <meta name="description" content="Ingress是一个集中的集群应用网关，自动化的k8s反向代理组件（功能类比nginx）。 Ingress涉及到LoadBalancer，Ingress Controller, Ingress config等相关概念。controller从LoadBalancer/ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://winse.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Winse Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/libs/jquery.toc.min.js" type="text/javascript"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->

<script src="/javascripts/generate-toc.js" type="text/javascript"></script>


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43198550-1', 'auto');
  ga('send', 'pageview');

</script>



</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Winse Blog</a></h1>
  
    <h2>走走停停, 熙熙攘攘, 忙忙碌碌, 不知何畏.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:winse.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="站内搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/archives/updated.html">Updated</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/03/26/k8s-ingress/">K8s Ingress</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-03-26T13:59:16+08:00" pubdate data-updated="true">Sat 2022-03-26 13:59</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>Ingress是一个集中的集群应用网关，自动化的k8s反向代理组件（功能类比nginx）。</p>

<p>Ingress涉及到LoadBalancer，Ingress Controller, Ingress config等相关概念。controller从LoadBalancer/NodePort把当前的服务发布出去，同时监听Ingress config实时的修改当前Ingress配置(实时更新nginx.conf配置文件，并重载)</p>

<p>这里仅从helloworld入门实践操作进行。</p>

<h2>入门指南</h2>

<h3>参考</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#quick-start">https://kubernetes.github.io/ingress-nginx/deploy/#quick-start</a></li>
<li><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh/docs/concepts/services-networking/ingress/</a></p></li>
<li><p><a href="https://docs.jdcloud.com/cn/jcs-for-kubernetes/deploy-k8s-ingress-nginx">https://docs.jdcloud.com/cn/jcs-for-kubernetes/deploy-k8s-ingress-nginx</a></p></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/concepts/ingress.html">https://jimmysong.io/kubernetes-handbook/concepts/ingress.html</a></li>
</ul>


<p>版本兼容性：
* <a href="https://github.com/kubernetes/ingress-nginx/#support-versions-table">https://github.com/kubernetes/ingress-nginx/#support-versions-table</a></p>

<h3>下载镜像</h3>

<p>镜像在gcr上面，先远程下载回来：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.2/deploy/static/provider/cloud/deploy.yaml 
</span><span class='line'>[ec2-user@k8s ~]$ vi ingress-nginx-controller-v1.1.2.yaml
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ grep image: ingress-nginx-controller-v1.1.2.yaml | sed 's/image: //' | sort -u | xargs echo 
</span><span class='line'>k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# docker pull k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c 
</span><span class='line'>k8s.gcr.io/ingress-nginx/controller@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c: Pulling from ingress-nginx/controller
</span><span class='line'>a0d0a0d46f8b: Pull complete 
</span><span class='line'>3aae86482564: Pull complete 
</span><span class='line'>c0d03781abb3: Pull complete 
</span><span class='line'>0297e2ef8f7f: Pull complete 
</span><span class='line'>866a68ce3c13: Pull complete 
</span><span class='line'>1c2a7ca65b54: Pull complete 
</span><span class='line'>41fd2de30e46: Pull complete 
</span><span class='line'>637f10464e4d: Pull complete 
</span><span class='line'>998064a16da4: Pull complete 
</span><span class='line'>e63d23220e8c: Pull complete 
</span><span class='line'>8128610547fb: Pull complete 
</span><span class='line'>ae07a1a7f038: Pull complete 
</span><span class='line'>ceb23c4cb607: Pull complete 
</span><span class='line'>Digest: sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
</span><span class='line'>Status: Downloaded newer image for k8s.gcr.io/ingress-nginx/controller@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
</span><span class='line'>k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# docker pull k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660 
</span><span class='line'>k8s.gcr.io/ingress-nginx/kube-webhook-certgen@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660: Pulling from ingress-nginx/kube-webhook-certgen
</span><span class='line'>ec52731e9273: Pull complete 
</span><span class='line'>b90aa28117d4: Pull complete 
</span><span class='line'>Digest: sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>Status: Downloaded newer image for k8s.gcr.io/ingress-nginx/kube-webhook-certgen@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# docker save k8s.gcr.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660 -o ingress-nginx-v1.1.2.tar
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# gzip ingress-nginx-v1.1.2.tar 
</span><span class='line'>
</span><span class='line'>[root@izt4nhcmmx33bjwcsdmf8oz ~]# ll -h ingress-nginx-v1.1.2.tar.gz 
</span><span class='line'>-rw------- 1 root root 116M Mar 24 23:49 ingress-nginx-v1.1.2.tar.gz
</span></code></pre></td></tr></table></div></figure>


<p>本地Linux服务器加载镜像</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ docker load -i k8s.gcr.io-ingress-nginx-v1.1.2.tar.gz 
</span><span class='line'>c0d270ab7e0d: Loading layer [==================================================&gt;]  3.697MB/3.697MB
</span><span class='line'>ce7a3c1169b6: Loading layer [==================================================&gt;]  45.38MB/45.38MB
</span><span class='line'>e2eb06d8af82: Loading layer [==================================================&gt;]  5.865MB/5.865MB
</span><span class='line'>ab1476f3fdd9: Loading layer [==================================================&gt;]  120.9MB/120.9MB
</span><span class='line'>ad20729656ef: Loading layer [==================================================&gt;]  4.096kB/4.096kB
</span><span class='line'>0d5022138006: Loading layer [==================================================&gt;]  38.09MB/38.09MB
</span><span class='line'>8f757e3fe5e4: Loading layer [==================================================&gt;]  21.42MB/21.42MB
</span><span class='line'>d2bc6b915bc9: Loading layer [==================================================&gt;]  4.019MB/4.019MB
</span><span class='line'>bbeb6784ed45: Loading layer [==================================================&gt;]  313.9kB/313.9kB
</span><span class='line'>0c411e83ee78: Loading layer [==================================================&gt;]  6.141MB/6.141MB
</span><span class='line'>9c2d86dc137f: Loading layer [==================================================&gt;]  38.45MB/38.45MB
</span><span class='line'>7797e5b3a760: Loading layer [==================================================&gt;]  2.754MB/2.754MB
</span><span class='line'>98ef19df5514: Loading layer [==================================================&gt;]  4.096kB/4.096kB
</span><span class='line'>4cde87c7ecaf: Loading layer [==================================================&gt;]  51.75MB/51.75MB
</span><span class='line'>11536690d74a: Loading layer [==================================================&gt;]  3.584kB/3.584kB
</span><span class='line'>Loaded image ID: sha256:c41e9fcadf5a291120de706b7dfa1af598b9f2ed5138b6dcb9f79a68aad0ef4c
</span><span class='line'>Loaded image ID: sha256:7e5c1cecb086f36c6ef4b319a60853020820997f3600c3687e8ba6139e83674d
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ cat k8s.gcr.io-ingress-nginx-v1.1.2.tar.gz | ssh worker1 docker load 
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>docker tag 7e5c1cecb086 k8s.gcr.io/ingress-nginx/controller:v1.1.2
</span><span class='line'>docker tag c41e9fcadf5a k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>注：由于配置中用了sha码，下载后tag不同，把image最后的 @sha256:xxx 删掉
</span><span class='line'>vi ingress-nginx-controller-v1.1.2.yaml
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h3>创建服务</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f ingress-nginx-controller-v1.1.2.yaml
</span><span class='line'>namespace/ingress-nginx created
</span><span class='line'>serviceaccount/ingress-nginx created
</span><span class='line'>serviceaccount/ingress-nginx-admission created
</span><span class='line'>role.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>role.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>clusterrole.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>rolebinding.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created
</span><span class='line'>clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
</span><span class='line'>configmap/ingress-nginx-controller created
</span><span class='line'>service/ingress-nginx-controller created
</span><span class='line'>service/ingress-nginx-controller-admission created
</span><span class='line'>deployment.apps/ingress-nginx-controller created
</span><span class='line'>job.batch/ingress-nginx-admission-create created
</span><span class='line'>job.batch/ingress-nginx-admission-patch created
</span><span class='line'>ingressclass.networking.k8s.io/nginx created
</span><span class='line'>validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl wait --namespace ingress-nginx \
</span><span class='line'>   --for=condition=ready pod \
</span><span class='line'>   --selector=app.kubernetes.io/component=controller \
</span><span class='line'>   --timeout=120s
</span><span class='line'>pod/ingress-nginx-controller-755447bb4d-rnxvl condition met
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 状态参考：
</span><span class='line'># https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --namespace=ingress-nginx
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get all -n ingress-nginx
</span><span class='line'>NAME                                            READY   STATUS      RESTARTS   AGE
</span><span class='line'>pod/ingress-nginx-admission-create-hbt9d        0/1     Completed   0          2m51s
</span><span class='line'>pod/ingress-nginx-admission-patch-j8qfh         0/1     Completed   1          2m51s
</span><span class='line'>pod/ingress-nginx-controller-755447bb4d-rnxvl   1/1     Running     0          2m51s
</span><span class='line'>
</span><span class='line'>NAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
</span><span class='line'>service/ingress-nginx-controller             LoadBalancer   10.104.8.155    &lt;pending&gt;     80:31031/TCP,443:31845/TCP   2m51s
</span><span class='line'>service/ingress-nginx-controller-admission   ClusterIP      10.108.67.255   &lt;none&gt;        443/TCP                      2m51s
</span><span class='line'>
</span><span class='line'>NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>deployment.apps/ingress-nginx-controller   1/1     1            1           2m51s
</span><span class='line'>
</span><span class='line'>NAME                                                  DESIRED   CURRENT   READY   AGE
</span><span class='line'>replicaset.apps/ingress-nginx-controller-755447bb4d   1         1         1       2m51s
</span><span class='line'>
</span><span class='line'>NAME                                       COMPLETIONS   DURATION   AGE
</span><span class='line'>job.batch/ingress-nginx-admission-create   1/1           3s         2m51s
</span><span class='line'>job.batch/ingress-nginx-admission-patch    1/1           3s         2m51s
</span></code></pre></td></tr></table></div></figure>


<p>看到 ingress-nginx-controller 服务的 <code>EXTERNAL-IP</code> 为 <code>&lt;pending&gt;</code> ，由于本地搭建并没有配备负载均衡器，所以没有手段，获取不到对外的IP。</p>

<h3>本地测试</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl create deployment demo --image=httpd --port=80
</span><span class='line'>deployment.apps/demo created
</span><span class='line'>[ec2-user@k8s ~]$ kubectl expose deployment demo
</span><span class='line'>service/demo exposed
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl create ingress demo-localhost --class=nginx \
</span><span class='line'>   --rule=demo.localdev.me/*=demo:80
</span><span class='line'>ingress.networking.k8s.io/demo-localhost created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl port-forward --namespace=ingress-nginx service/ingress-nginx-controller 8080:80
</span><span class='line'>Forwarding from 127.0.0.1:8080 -&gt; 80
</span><span class='line'>Forwarding from [::1]:8080 -&gt; 80
</span><span class='line'>Handling connection for 8080
</span><span class='line'>Handling connection for 8080
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ curl http://demo.localdev.me:8080/
</span><span class='line'>&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>集成（发布）</h2>

<h3>cloud</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#aws">https://kubernetes.github.io/ingress-nginx/deploy/#aws</a></li>
</ul>


<p>配置云厂商的负载均衡器。</p>

<h3>baremetal: nodeport</h3>

<p>适用于部署在裸机服务器上的 Kubernetes 集群，以及使用通用 Linux 发行版手动安装 Kubernetes 的 [原始] 虚拟机</p>

<p>为了快速测试，您可以使用 NodePort。这应该适用于几乎每个集群，但它通常会使用 30000-32767 范围内的端口。</p>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters">https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.2/deploy/static/provider/baremetal/deploy.yaml
</span></code></pre></td></tr></table></div></figure>


<p>注：也可以通过修改配置使用80，443等端口，但不推荐。</p>

<h3>baremetal: hostNetwork</h3>

<p>ingress nginx controller的pod网络直接使用主机网络，这个比Service Nodeport稍微灵活一点，可以自己选择/管理端口。</p>

<h3>A pure software solution: MetalLB</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb</a></li>
<li><a href="https://metallb.universe.tf/concepts/">https://metallb.universe.tf/concepts/</a></li>
</ul>


<p>It has two features that work together to provide this service: address allocation, and external announcement.</p>

<p>After MetalLB has assigned an external IP address to a service, it needs to make the network beyond the cluster aware that the IP “lives” in the cluster. MetalLB uses standard routing protocols to achieve this: ARP, NDP, or BGP.</p>

<h4>安装</h4>

<ul>
<li><a href="https://metallb.universe.tf/installation/">https://metallb.universe.tf/installation/</a></li>
</ul>


<p>需要kube-proxy配置arp为true。得与局域网进行广播通信，所以需要开启arp功能（标准路由协议）。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl edit configmap -n kube-system kube-proxy
</span><span class='line'>
</span><span class='line'>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span><span class='line'>kind: KubeProxyConfiguration
</span><span class='line'>mode: "ipvs"
</span><span class='line'>ipvs:
</span><span class='line'>  strictARP: true</span></code></pre></td></tr></table></div></figure>


<p>或者批处理一步到位</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># see what changes would be made, returns nonzero returncode if different
</span><span class='line'>kubectl get configmap kube-proxy -n kube-system -o yaml | \
</span><span class='line'>sed -e "s/strictARP: false/strictARP: true/" | \
</span><span class='line'>kubectl diff -f - -n kube-system
</span><span class='line'>
</span><span class='line'># actually apply the changes, returns nonzero returncode on errors only
</span><span class='line'>kubectl get configmap kube-proxy -n kube-system -o yaml | \
</span><span class='line'>sed -e "s/strictARP: false/strictARP: true/" | \
</span><span class='line'>kubectl apply -f - -n kube-system
</span></code></pre></td></tr></table></div></figure>


<p>安装</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml
</span><span class='line'>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml
</span></code></pre></td></tr></table></div></figure>


<p>下载镜像慢一点，需要稍微多等等。再查看状态：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get all -n metallb-system
</span><span class='line'>NAME                             READY   STATUS    RESTARTS   AGE
</span><span class='line'>pod/controller-57fd9c5bb-kc5zt   1/1     Running   0          5m55s
</span><span class='line'>pod/speaker-8pg4v                1/1     Running   0          5m55s
</span><span class='line'>pod/speaker-95bs8                1/1     Running   0          5m55s
</span><span class='line'>
</span><span class='line'>NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
</span><span class='line'>daemonset.apps/speaker   2         2         2       2            2           kubernetes.io/os=linux   5m55s
</span><span class='line'>
</span><span class='line'>NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
</span><span class='line'>deployment.apps/controller   1/1     1            1           5m55s
</span><span class='line'>
</span><span class='line'>NAME                                   DESIRED   CURRENT   READY   AGE
</span><span class='line'>replicaset.apps/controller-57fd9c5bb   1         1         1       5m55s
</span></code></pre></td></tr></table></div></figure>


<h4>配置地址</h4>

<ul>
<li><p><a href="https://metallb.universe.tf/configuration/#layer-2-configuration">https://metallb.universe.tf/configuration/#layer-2-configuration</a></p></li>
<li><p><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb</a></p></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 查看主机ip，避开这些节点IP的区间
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get node -o wide
</span><span class='line'>NAME      STATUS   ROLES                  AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME
</span><span class='line'>k8s       Ready    control-plane,master   10d   v1.23.5   192.168.191.131   &lt;none&gt;        Amazon Linux 2   4.14.268-205.500.amzn2.x86_64   docker://20.10.7
</span><span class='line'>worker1   Ready    &lt;none&gt;                 10d   v1.23.5   192.168.191.132   &lt;none&gt;        Amazon Linux 2   4.14.268-205.500.amzn2.x86_64   docker://20.10.7
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ cat metallb-config.yml
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: ConfigMap
</span><span class='line'>metadata:
</span><span class='line'>  namespace: metallb-system
</span><span class='line'>  name: config
</span><span class='line'>data:
</span><span class='line'>  config: |
</span><span class='line'>    address-pools:
</span><span class='line'>    - name: default
</span><span class='line'>      protocol: layer2
</span><span class='line'>      addresses:
</span><span class='line'>      - 192.168.191.200-192.168.191.220
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f metallb-config.yml 
</span><span class='line'>configmap/config created
</span></code></pre></td></tr></table></div></figure>


<p>然后，再回过头重新安装一遍nginx-ingress：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --namespace=ingress-nginx
</span><span class='line'>NAME                                        READY   STATUS      RESTARTS   AGE
</span><span class='line'>ingress-nginx-admission-create-b9hkn        0/1     Completed   0          17s
</span><span class='line'>ingress-nginx-admission-patch-xmnbr         0/1     Completed   1          17s
</span><span class='line'>ingress-nginx-controller-755447bb4d-lfrwk   0/1     Running     0          17s
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --namespace=ingress-nginx
</span><span class='line'>NAME                                        READY   STATUS      RESTARTS   AGE
</span><span class='line'>ingress-nginx-admission-create-b9hkn        0/1     Completed   0          25s
</span><span class='line'>ingress-nginx-admission-patch-xmnbr         0/1     Completed   1          25s
</span><span class='line'>ingress-nginx-controller-755447bb4d-lfrwk   1/1     Running     0          25s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl -n ingress-nginx get svc
</span><span class='line'>NAME                                 TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
</span><span class='line'>ingress-nginx-controller             LoadBalancer   10.107.221.243   192.168.191.200   80:31443/TCP,443:30099/TCP   57s
</span><span class='line'>ingress-nginx-controller-admission   ClusterIP      10.105.12.185    &lt;none&gt;            443/TCP                      57s
</span></code></pre></td></tr></table></div></figure>


<p>这次 EXTERNAL-IP 的ip就有值了，上面配置的ip段里面一个ip。</p>

<h3>在线/集成测试</h3>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#online-testing">https://kubernetes.github.io/ingress-nginx/deploy/#online-testing</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get service ingress-nginx-controller --namespace=ingress-nginx
</span><span class='line'>NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
</span><span class='line'>ingress-nginx-controller   LoadBalancer   10.107.221.243   192.168.191.200   80:31443/TCP,443:30099/TCP   4m
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl create deployment demo --image=httpd --port=80
</span><span class='line'>deployment.apps/demo created
</span><span class='line'>[ec2-user@k8s ~]$ kubectl expose deployment demo
</span><span class='line'>service/demo exposed
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl create ingress demo --class=nginx \
</span><span class='line'>   --rule="www.demo.io/*=demo:80"
</span><span class='line'>ingress.networking.k8s.io/demo created
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get ingress 
</span><span class='line'>NAME   CLASS   HOSTS         ADDRESS   PORTS   AGE
</span><span class='line'>demo   nginx   www.demo.io             80      42s
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get ingress 
</span><span class='line'>NAME   CLASS   HOSTS         ADDRESS           PORTS   AGE
</span><span class='line'>demo   nginx   www.demo.io   192.168.191.200   80      27m
</span></code></pre></td></tr></table></div></figure>


<p>在本地windows机器的 <code>C:/Windows/System32/drivers/etc/hosts</code> 增加 <code>192.168.191.200 www.demo.io</code> ，然后浏览器访问 <code>http://www.demo.io/</code> ，顺利的话就能在浏览器看到：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>It works!</span></code></pre></td></tr></table></div></figure>


<h3>后记</h3>

<h4>理一下网络调用，其实就是nginx的方式：</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl logs --tail=2 pod/demo-764c97f6fd-q5xts
</span><span class='line'>10.244.2.79 - - [28/Mar/2022:09:52:36 +0000] "GET / HTTP/1.1" 200 45
</span><span class='line'>10.244.2.79 - - [28/Mar/2022:09:52:36 +0000] "GET /favicon.ico HTTP/1.1" 404 196
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -n ingress-nginx -o wide 
</span><span class='line'>NAME                                        READY   STATUS      RESTARTS   AGE    IP            NODE      NOMINATED NODE   READINESS GATES
</span><span class='line'>ingress-nginx-admission-create-b9hkn        0/1     Completed   0          157m   10.244.2.78   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>ingress-nginx-admission-patch-xmnbr         0/1     Completed   1          157m   10.244.2.77   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>ingress-nginx-controller-755447bb4d-lfrwk   1/1     Running     0          157m   10.244.2.79   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>
</span><span class='line'># 192.168.191.1是vmware虚拟网卡的地址
</span><span class='line'>[ec2-user@k8s ~]$ kubectl logs --tail=2 pod/ingress-nginx-controller-755447bb4d-lfrwk -n ingress-nginx 
</span><span class='line'>192.168.191.1 - - [28/Mar/2022:09:52:36 +0000] "GET / HTTP/1.1" 200 45 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.82 Safari/537.36" 566 0.000 [default-demo-80] [] 10.244.2.80:80 45 0.000 200 6d52ef8349eb3101c31c3cc6377b982b
</span><span class='line'>192.168.191.1 - - [28/Mar/2022:09:52:36 +0000] "GET /favicon.ico HTTP/1.1" 404 196 "http://www.demo.io/" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.82 Safari/537.36" 506 0.001 [default-demo-80] [] 10.244.2.80:80 196 0.000 404 fefe172a57273977cdcd1455bcf322ac
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>## web
</span><span class='line'>Request URL: http://www.demo.io/
</span><span class='line'>Request Method: GET
</span><span class='line'>Status Code: 200 OK
</span><span class='line'>Remote Address: 192.168.191.200:80
</span><span class='line'>Referrer Policy: strict-origin-when-cross-origin
</span></code></pre></td></tr></table></div></figure>


<h4>看看metallb的日志，ip是怎么分配的</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># https://metallb.universe.tf/concepts/layer2/
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -n metallb-system -o wide
</span><span class='line'>NAME                         READY   STATUS    RESTARTS   AGE     IP                NODE      NOMINATED NODE   READINESS GATES
</span><span class='line'>controller-57fd9c5bb-kc5zt   1/1     Running   0          3h34m   10.244.2.76       worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>speaker-8pg4v                1/1     Running   0          3h34m   192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>speaker-95bs8                1/1     Running   0          3h34m   192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl logs pod/controller-57fd9c5bb-kc5zt -n metallb-system
</span><span class='line'>{"caller":"level.go:63","event":"ipAllocated","ip":["192.168.191.200"],"level":"info","msg":"IP address assigned by controller","service":"ingress-nginx/ingress-nginx-controller","ts":"2022-03-28T07:16:22.675599527Z"}
</span><span class='line'>{"caller":"level.go:63","event":"serviceUpdated","level":"info","msg":"updated service object","service":"ingress-nginx/ingress-nginx-controller","ts":"2022-03-28T07:1
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl logs speaker-8pg4v -n metallb-system 
</span><span class='line'>{"caller":"level.go:63","event":"serviceAnnounced","ips":["192.168.191.200"],"level":"info","msg":"service has IP, announcing","pool":"default","protocol":"layer2","service":"ingress-nginx/ingress-nginx-controller","ts":"2022-03-28T07:16:42.775467559Z"}
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ ping 192.168.191.200
</span><span class='line'>PING 192.168.191.200 (192.168.191.200) 56(84) bytes of data.
</span><span class='line'>^C
</span><span class='line'>--- 192.168.191.200 ping statistics ---
</span><span class='line'>3 packets transmitted, 0 received, 100% packet loss, time 2055ms
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ arp 
</span><span class='line'>Address                  HWtype  HWaddress           Flags Mask            Iface
</span><span class='line'>192.168.191.200          ether   00:0c:29:d5:4f:0f   C                     eth0
</span><span class='line'>
</span><span class='line'># worker1节点的MAC
</span><span class='line'>[ec2-user@worker1 ~]$ ip a | grep -i -C 10 '00:0c:29:d5:4f:0f' 
</span><span class='line'>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
</span><span class='line'>    link/ether 00:0c:29:d5:4f:0f brd ff:ff:ff:ff:ff:ff
</span><span class='line'>    inet 192.168.191.132/24 brd 192.168.191.255 scope global dynamic eth0
</span><span class='line'>       valid_lft 1714sec preferred_lft 1714sec
</span><span class='line'>
</span><span class='line'># In layer 2 mode, all traffic for a service IP goes to one node. From there, kube-proxy spreads the traffic to all the service’s pods.
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -A -o wide | grep 192.168.191.132
</span><span class='line'>kube-system            kube-flannel-ds-q4qkt                        1/1     Running     8 (2d10h ago)   11d     192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            kube-proxy-pd77m                             1/1     Running     6 (3d2h ago)    11d     192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>metallb-system         speaker-8pg4v                                1/1     Running     0               5h31m   192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>例子：</h2>

<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/#local-testing">https://kubernetes.github.io/ingress-nginx/deploy/#local-testing</a></li>
<li><a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/">https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/</a></li>
</ul>


<h2>验证</h2>

<ul>
<li><a href="https://www.qikqiak.com/post/visually-explained-k8s-service/">图解 Kubernetes Service</a></li>
<li><a href="https://www.qikqiak.com/post/visually-explained-k8s-ingress/">图解 Kubernetes Ingress</a></li>
</ul>


<p>文中说loadbalancer是通过了nodeport（会创建nodeport），还是有点诧异的。验证一番，果真如此！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get service ingress-nginx-controller --namespace=ingress-nginx
</span><span class='line'>NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
</span><span class='line'>ingress-nginx-controller   LoadBalancer   10.107.221.243   192.168.191.200   80:31443/TCP,443:30099/TCP   34m
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl describe service ingress-nginx-controller --namespace=ingress-nginx
</span><span class='line'>Name:                     ingress-nginx-controller
</span><span class='line'>Namespace:                ingress-nginx
</span><span class='line'>Labels:                   app.kubernetes.io/component=controller
</span><span class='line'>                          app.kubernetes.io/instance=ingress-nginx
</span><span class='line'>                          app.kubernetes.io/managed-by=Helm
</span><span class='line'>                          app.kubernetes.io/name=ingress-nginx
</span><span class='line'>                          app.kubernetes.io/part-of=ingress-nginx
</span><span class='line'>                          app.kubernetes.io/version=1.1.2
</span><span class='line'>                          helm.sh/chart=ingress-nginx-4.0.18
</span><span class='line'>Annotations:              &lt;none&gt;
</span><span class='line'>Selector:                 app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx
</span><span class='line'>Type:                     LoadBalancer
</span><span class='line'>IP Family Policy:         SingleStack
</span><span class='line'>IP Families:              IPv4
</span><span class='line'>IP:                       10.107.221.243
</span><span class='line'>IPs:                      10.107.221.243
</span><span class='line'>LoadBalancer Ingress:     192.168.191.200
</span><span class='line'>Port:                     http  80/TCP
</span><span class='line'>TargetPort:               http/TCP
</span><span class='line'>NodePort:                 http  31443/TCP
</span><span class='line'>Endpoints:                10.244.2.79:80
</span><span class='line'>Port:                     https  443/TCP
</span><span class='line'>TargetPort:               https/TCP
</span><span class='line'>NodePort:                 https  30099/TCP
</span><span class='line'>Endpoints:                10.244.2.79:443
</span><span class='line'>Session Affinity:         None
</span><span class='line'>External Traffic Policy:  Local
</span><span class='line'>HealthCheck NodePort:     31942
</span><span class='line'>Events:
</span><span class='line'>  Type    Reason        Age   From                Message
</span><span class='line'>  ----    ------        ----  ----                -------
</span><span class='line'>  Normal  IPAllocated   38m   metallb-controller  Assigned IP ["192.168.191.200"]
</span><span class='line'>  Normal  nodeAssigned  38m   metallb-speaker     announcing from node "worker1"
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ netstat -anp | grep 31443 
</span><span class='line'>(No info could be read for "-p": geteuid()=1002 but you should be root.)
</span><span class='line'>tcp        0      0 0.0.0.0:31443           0.0.0.0:*               LISTEN      -       
</span><span class='line'>
</span><span class='line'>[ec2-user@worker1 ~]$ netstat -anp | grep 31443
</span><span class='line'>(No info could be read for "-p": geteuid()=1002 but you should be root.)
</span><span class='line'>tcp        0      0 0.0.0.0:31443           0.0.0.0:*               LISTEN      -                   
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/03/18/k8s-guide-use-kubeadm/">k8s-v1.23.5安装指南 - 使用kubeadm</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-03-18T11:58:48+08:00" pubdate data-updated="true">Fri 2022-03-18 11:58</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>注[2022-03-25]：如果后面需要用AWS，用Amazon的操作系统会便利一点。aws的命令这些都自带了。</p>

<p>本文是在 Amazon Linux 2 系统上安装部署的，和centos7.3基本相似。</p>

<p>和k8s软件依赖需要访问google的，已经在前面一篇文章中下载好，本文中会直接使用。依赖的软件可以在百度网盘下载：</p>

<pre><code>链接：https://pan.baidu.com/s/1P3ABqKGt1JhNkg-9yB22yQ 
提取码：k7af
</code></pre>

<h2>安装 amazon-linux-2 操作系统</h2>

<ul>
<li><a href="https://docs.amazonaws.cn/AWSEC2/latest/UserGuide/amazon-linux-2-virtual-machine.html#amazon-linux-2-virtual-machine-download">步骤 2：下载 Amazon Linux 2 VM 映像</a></li>
<li>下载 <a href="https://cdn.amazonlinux.com/os-images/2.0.20220218.3/">https://cdn.amazonlinux.com/os-images/2.0.20220218.3/</a></li>
</ul>


<p>这里下载vmware使用的镜像 <code>amzn2-vmware_esx-2.0.20220218.3-x86_64.xfs.gpt.ova</code> 和初始化配置 <code>Seed.iso</code> 。</p>

<p>这里简单说下，其实ova已经是可以直接用的，文档中讲的很多内容是辅助系统定制初始化的。user-data用于创建用户和修改文件内容，meta-data配置主机名和网络ip设置。为了本地开发测试，我们直接用默认提供 <code>Seed.iso</code> 即可，登录使用 <code>ec2-user:amazon</code> 。</p>

<p>然后双击 ova 文件，就可以导入创建一个虚拟机出来了。</p>

<ul>
<li>修改网络适配器为NAT模式；</li>
<li>添加CD/DVD设备，选择 <code>Seed.iso</code> ISO映射文件；</li>
<li>开机登录系统后，打开sshd的密码登录。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo ifup eth0
</span><span class='line'>$ ip a
</span><span class='line'>
</span><span class='line'>$ sudo vi /etc/ssh/sshd_config
</span><span class='line'>#PasswordAuthentication no
</span><span class='line'>
</span><span class='line'>$ sudo service sshd reload 
</span></code></pre></td></tr></table></div></figure>


<h2>安装docker</h2>

<p>k8s需要容器运行时软件，我们先安装好docker。</p>

<ul>
<li><a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker</a></li>
</ul>


<p>aws linux 2有它自己的docker源，使用docker官网文档的方式依赖有些找不到。直接按照aws官方文档中提供的方式安装。</p>

<h3>坑</h3>

<p>一开始是按照docker官网在centos的方式安装的，但yum repo的变量不对上，改了releasever后，然后依赖的版本找不到。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## https://docs.docker.com/engine/install/centos/
</span><span class='line'>[ec2-user@amazonlinux ~]$ cat /etc/issue
</span><span class='line'>\S
</span><span class='line'>Kernel \r on an \m
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ yum-debug-dump
</span><span class='line'>Loaded plugins: langpacks, priorities, update-motd
</span><span class='line'>Output written to: /home/ec2-user/yum_debug_dump-amazonlinux.onprem-2022-03-17_02:16:37.txt.gz
</span><span class='line'>[ec2-user@amazonlinux ~]$ less /home/ec2-user/yum_debug_dump-amazonlinux.onprem-2022-03-17_02:16:37.txt.gz
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span><span class='line'>
</span><span class='line'>$releasever的值,这个表示当前系统的发行版本，可以通过rpm -qi centos-release命令查看，结果如下：
</span><span class='line'>$basearch是我们的系统硬件架构(CPU指令集),使用命令arch得到
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo sed -i 's/$releasever/7/g' /etc/yum.repos.d/docker-ce.repo 
</span><span class='line'>
</span><span class='line'>## 缺少依赖
</span></code></pre></td></tr></table></div></figure>


<h3>正式安装docker</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## https://docs.aws.amazon.com/AmazonECS/latest/developerguide/docker-basics.html
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo yum update -y
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo amazon-linux-extras install docker
</span><span class='line'>Installing docker
</span><span class='line'>Loaded plugins: langpacks, priorities, update-motd
</span><span class='line'>Cleaning repos: amzn2-core amzn2extra-docker
</span><span class='line'>12 metadata files removed
</span><span class='line'>4 sqlite files removed
</span><span class='line'>0 metadata files removed
</span><span class='line'>Loaded plugins: langpacks, priorities, update-motd
</span><span class='line'>amzn2-core                                                                                                                                        | 3.7 kB  00:00:00     
</span><span class='line'>amzn2extra-docker                                                                                                                                 | 3.0 kB  00:00:00     
</span><span class='line'>(1/5): amzn2-core/2/x86_64/group_gz                                                                                                               | 2.5 kB  00:00:00     
</span><span class='line'>(2/5): amzn2extra-docker/2/x86_64/updateinfo                                                                                                      | 5.9 kB  00:00:00     
</span><span class='line'>(3/5): amzn2-core/2/x86_64/updateinfo                                                                                                             | 452 kB  00:00:01     
</span><span class='line'>(4/5): amzn2extra-docker/2/x86_64/primary_db                                                                                                      |  86 kB  00:00:00     
</span><span class='line'>(5/5): amzn2-core/2/x86_64/primary_db                                                                                                             |  60 MB  00:01:42     
</span><span class='line'>Resolving Dependencies
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package docker.x86_64 0:20.10.7-5.amzn2 will be installed
</span><span class='line'>--&gt; Processing Dependency: runc &gt;= 1.0.0 for package: docker-20.10.7-5.amzn2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libcgroup &gt;= 0.40.rc1-5.15 for package: docker-20.10.7-5.amzn2.x86_64
</span><span class='line'>--&gt; Processing Dependency: containerd &gt;= 1.3.2 for package: docker-20.10.7-5.amzn2.x86_64
</span><span class='line'>--&gt; Processing Dependency: pigz for package: docker-20.10.7-5.amzn2.x86_64
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package containerd.x86_64 0:1.4.6-8.amzn2 will be installed
</span><span class='line'>---&gt; Package libcgroup.x86_64 0:0.41-21.amzn2 will be installed
</span><span class='line'>---&gt; Package pigz.x86_64 0:2.3.4-1.amzn2.0.1 will be installed
</span><span class='line'>---&gt; Package runc.x86_64 0:1.0.0-2.amzn2 will be installed
</span><span class='line'>--&gt; Finished Dependency Resolution
</span><span class='line'>
</span><span class='line'>Dependencies Resolved
</span><span class='line'>
</span><span class='line'>=========================================================================================================================================================================
</span><span class='line'> Package                               Arch                              Version                                      Repository                                    Size
</span><span class='line'>=========================================================================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> docker                                x86_64                            20.10.7-5.amzn2                              amzn2extra-docker                             42 M
</span><span class='line'>Installing for dependencies:
</span><span class='line'> containerd                            x86_64                            1.4.6-8.amzn2                                amzn2extra-docker                             24 M
</span><span class='line'> libcgroup                             x86_64                            0.41-21.amzn2                                amzn2-core                                    66 k
</span><span class='line'> pigz                                  x86_64                            2.3.4-1.amzn2.0.1                            amzn2-core                                    81 k
</span><span class='line'> runc                                  x86_64                            1.0.0-2.amzn2                                amzn2extra-docker                            3.3 M
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>=========================================================================================================================================================================
</span><span class='line'>Install  1 Package (+4 Dependent packages)
</span><span class='line'>
</span><span class='line'>Total download size: 69 M
</span><span class='line'>Installed size: 285 M
</span><span class='line'>Is this ok [y/d/N]: y
</span><span class='line'>Downloading packages:
</span><span class='line'>(1/5): pigz-2.3.4-1.amzn2.0.1.x86_64.rpm                                                                                                          |  81 kB  00:00:00     
</span><span class='line'>(2/5): libcgroup-0.41-21.amzn2.x86_64.rpm                                                                                                         |  66 kB  00:00:00     
</span><span class='line'>(3/5): containerd-1.4.6-8.amzn2.x86_64.rpm                                                                                                        |  24 MB  00:01:14     
</span><span class='line'>(4/5): runc-1.0.0-2.amzn2.x86_64.rpm                                                                                                              | 3.3 MB  00:00:10     
</span><span class='line'>(5/5): docker-20.10.7-5.amzn2.x86_64.rpm                                                                                                          |  42 MB  00:01:50     
</span><span class='line'>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                                                                                    641 kB/s |  69 MB  00:01:50     
</span><span class='line'>Running transaction check
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded
</span><span class='line'>Running transaction
</span><span class='line'>  Installing : runc-1.0.0-2.amzn2.x86_64                                                                                                                             1/5 
</span><span class='line'>  Installing : containerd-1.4.6-8.amzn2.x86_64                                                                                                                       2/5 
</span><span class='line'>  Installing : libcgroup-0.41-21.amzn2.x86_64                                                                                                                        3/5 
</span><span class='line'>  Installing : pigz-2.3.4-1.amzn2.0.1.x86_64                                                                                                                         4/5 
</span><span class='line'>  Installing : docker-20.10.7-5.amzn2.x86_64                                                                                                                         5/5 
</span><span class='line'>  Verifying  : docker-20.10.7-5.amzn2.x86_64                                                                                                                         1/5 
</span><span class='line'>  Verifying  : containerd-1.4.6-8.amzn2.x86_64                                                                                                                       2/5 
</span><span class='line'>  Verifying  : runc-1.0.0-2.amzn2.x86_64                                                                                                                             3/5 
</span><span class='line'>  Verifying  : pigz-2.3.4-1.amzn2.0.1.x86_64                                                                                                                         4/5 
</span><span class='line'>  Verifying  : libcgroup-0.41-21.amzn2.x86_64                                                                                                                        5/5 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  docker.x86_64 0:20.10.7-5.amzn2                                                                                                                                        
</span><span class='line'>
</span><span class='line'>Dependency Installed:
</span><span class='line'>  containerd.x86_64 0:1.4.6-8.amzn2           libcgroup.x86_64 0:0.41-21.amzn2           pigz.x86_64 0:2.3.4-1.amzn2.0.1           runc.x86_64 0:1.0.0-2.amzn2          
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>  0  ansible2                 available    \
</span><span class='line'>        [ =2.4.2  =2.4.6  =2.8  =stable ]
</span><span class='line'>  2  httpd_modules            available    [ =1.0  =stable ]
</span><span class='line'>  3  memcached1.5             available    \
</span><span class='line'>        [ =1.5.1  =1.5.16  =1.5.17 ]
</span><span class='line'>  5  postgresql9.6            available    \
</span><span class='line'>        [ =9.6.6  =9.6.8  =stable ]
</span><span class='line'>  6  postgresql10             available    [ =10  =stable ]
</span><span class='line'>  9  R3.4                     available    [ =3.4.3  =stable ]
</span><span class='line'> 10  rust1                    available    \
</span><span class='line'>        [ =1.22.1  =1.26.0  =1.26.1  =1.27.2  =1.31.0  =1.38.0
</span><span class='line'>          =stable ]
</span><span class='line'> 11  vim                      available    [ =8.0  =stable ]
</span><span class='line'> 18  libreoffice              available    \
</span><span class='line'>        [ =5.0.6.2_15  =5.3.6.1  =stable ]
</span><span class='line'> 19  gimp                     available    [ =2.8.22 ]
</span><span class='line'> 20  docker=latest            enabled      \
</span><span class='line'>        [ =17.12.1  =18.03.1  =18.06.1  =18.09.9  =stable ]
</span><span class='line'> 21  mate-desktop1.x          available    \
</span><span class='line'>        [ =1.19.0  =1.20.0  =stable ]
</span><span class='line'> 22  GraphicsMagick1.3        available    \
</span><span class='line'>        [ =1.3.29  =1.3.32  =1.3.34  =stable ]
</span><span class='line'> 23  tomcat8.5                available    \
</span><span class='line'>        [ =8.5.31  =8.5.32  =8.5.38  =8.5.40  =8.5.42  =8.5.50
</span><span class='line'>          =stable ]
</span><span class='line'> 24  epel                     available    [ =7.11  =stable ]
</span><span class='line'> 25  testing                  available    [ =1.0  =stable ]
</span><span class='line'> 26  ecs                      available    [ =stable ]
</span><span class='line'> 27  corretto8                available    \
</span><span class='line'>        [ =1.8.0_192  =1.8.0_202  =1.8.0_212  =1.8.0_222  =1.8.0_232
</span><span class='line'>          =1.8.0_242  =stable ]
</span><span class='line'> 28  firecracker              available    [ =0.11  =stable ]
</span><span class='line'> 29  golang1.11               available    \
</span><span class='line'>        [ =1.11.3  =1.11.11  =1.11.13  =stable ]
</span><span class='line'> 30  squid4                   available    [ =4  =stable ]
</span><span class='line'> 32  lustre2.10               available    \
</span><span class='line'>        [ =2.10.5  =2.10.8  =stable ]
</span><span class='line'> 33  java-openjdk11           available    [ =11  =stable ]
</span><span class='line'> 34  lynis                    available    [ =stable ]
</span><span class='line'> 35  kernel-ng                available    [ =stable ]
</span><span class='line'> 36  BCC                      available    [ =0.x  =stable ]
</span><span class='line'> 37  mono                     available    [ =5.x  =stable ]
</span><span class='line'> 38  nginx1                   available    [ =stable ]
</span><span class='line'> 39  ruby2.6                  available    [ =2.6  =stable ]
</span><span class='line'> 40  mock                     available    [ =stable ]
</span><span class='line'> 41  postgresql11             available    [ =11  =stable ]
</span><span class='line'> 42  php7.4                   available    [ =stable ]
</span><span class='line'> 43  livepatch                available    [ =stable ]
</span><span class='line'> 44  python3.8                available    [ =stable ]
</span><span class='line'> 45  haproxy2                 available    [ =stable ]
</span><span class='line'> 46  collectd                 available    [ =stable ]
</span><span class='line'> 47  aws-nitro-enclaves-cli   available    [ =stable ]
</span><span class='line'> 48  R4                       available    [ =stable ]
</span><span class='line'> 49  kernel-5.4               available    [ =stable ]
</span><span class='line'> 50  selinux-ng               available    [ =stable ]
</span><span class='line'> 51  php8.0                   available    [ =stable ]
</span><span class='line'> 52  tomcat9                  available    [ =stable ]
</span><span class='line'> 53  unbound1.13              available    [ =stable ]
</span><span class='line'> 54  mariadb10.5              available    [ =stable ]
</span><span class='line'> 55  kernel-5.10              available    [ =stable ]
</span><span class='line'> 56  redis6                   available    [ =stable ]
</span><span class='line'> 57  ruby3.0                  available    [ =stable ]
</span><span class='line'> 58  postgresql12             available    [ =stable ]
</span><span class='line'> 59  postgresql13             available    [ =stable ]
</span><span class='line'> 60  mock2                    available    [ =stable ]
</span><span class='line'> 61  dnsmasq2.85              available    [ =stable ]
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo service docker start
</span><span class='line'>Redirecting to /bin/systemctl start docker.service
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo systemctl enable docker
</span><span class='line'>Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo usermod -a -G docker ec2-user
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker info
</span><span class='line'>Client:
</span><span class='line'> Context:    default
</span><span class='line'> Debug Mode: false
</span><span class='line'>
</span><span class='line'>Server:
</span><span class='line'>ERROR: Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get "http://%2Fvar%2Frun%2Fdocker.sock/v1.24/info": dial unix /var/run/docker.sock: connect: permission denied
</span><span class='line'>errors pretty printing info
</span><span class='line'>[ec2-user@amazonlinux ~]$ exit
</span><span class='line'>退出后再次连接：
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker info 
</span><span class='line'>Client:
</span><span class='line'> Context:    default
</span><span class='line'> Debug Mode: false
</span><span class='line'>
</span><span class='line'>Server:
</span><span class='line'> Containers: 0
</span><span class='line'>  Running: 0
</span><span class='line'>  Paused: 0
</span><span class='line'>  Stopped: 0
</span><span class='line'> Images: 0
</span><span class='line'> Server Version: 20.10.7
</span><span class='line'> Storage Driver: overlay2
</span><span class='line'>  Backing Filesystem: xfs
</span><span class='line'>  Supports d_type: true
</span><span class='line'>  Native Overlay Diff: true
</span><span class='line'>  userxattr: false
</span><span class='line'> Logging Driver: json-file
</span><span class='line'> Cgroup Driver: cgroupfs
</span><span class='line'> Cgroup Version: 1
</span><span class='line'> Plugins:
</span><span class='line'>  Volume: local
</span><span class='line'>  Network: bridge host ipvlan macvlan null overlay
</span><span class='line'>  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
</span><span class='line'> Swarm: inactive
</span><span class='line'> Runtimes: io.containerd.runc.v2 io.containerd.runtime.v1.linux runc
</span><span class='line'> Default Runtime: runc
</span><span class='line'> Init Binary: docker-init
</span><span class='line'> containerd version: d71fcd7d8303cbf684402823e425e9dd2e99285d
</span><span class='line'> runc version: 84113eef6fc27af1b01b3181f31bbaf708715301
</span><span class='line'> init version: de40ad0
</span><span class='line'> Security Options:
</span><span class='line'>  seccomp
</span><span class='line'>   Profile: default
</span><span class='line'> Kernel Version: 4.14.268-205.500.amzn2.x86_64
</span><span class='line'> Operating System: Amazon Linux 2
</span><span class='line'> OSType: linux
</span><span class='line'> Architecture: x86_64
</span><span class='line'> CPUs: 2
</span><span class='line'> Total Memory: 3.828GiB
</span><span class='line'> Name: amazonlinux.onprem
</span><span class='line'> ID: GENW:47BV:UJR2:247P:CPFE:PHSO:RA6Z:H4RK:HYEE:LXN3:XDIZ:SI6Q
</span><span class='line'> Docker Root Dir: /var/lib/docker
</span><span class='line'> Debug Mode: false
</span><span class='line'> Registry: https://index.docker.io/v1/
</span><span class='line'> Labels:
</span><span class='line'> Experimental: false
</span><span class='line'> Insecure Registries:
</span><span class='line'>  127.0.0.0/8
</span><span class='line'> Live Restore Enabled: false
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo yum install telnet -y
</span></code></pre></td></tr></table></div></figure>


<h2>准备工作</h2>

<p>可以先了解一些基本概念
* <a href="https://www.jianshu.com/p/7bc34ff88d9d">Kubernetes in Action 笔记 —— 部署第一个应用</a></p>

<ul>
<li><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B">准备开始</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## 确保每个节点上 MAC 地址和 product_uuid 的唯一性
</span><span class='line'>[ec2-user@amazonlinux ~]$ ip link
</span><span class='line'>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
</span><span class='line'>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class='line'>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
</span><span class='line'>    link/ether 00:0c:29:a4:a6:fc brd ff:ff:ff:ff:ff:ff
</span><span class='line'>[ec2-user@amazonlinux ~]$ ifconfig -a
</span><span class='line'>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span><span class='line'>        inet 192.168.191.131  netmask 255.255.255.0  broadcast 192.168.191.255
</span><span class='line'>        inet6 fe80::20c:29ff:fea4:a6fc  prefixlen 64  scopeid 0x20&lt;link&gt;
</span><span class='line'>        ether 00:0c:29:a4:a6:fc  txqueuelen 1000  (Ethernet)
</span><span class='line'>        RX packets 1737  bytes 288390 (281.6 KiB)
</span><span class='line'>        RX errors 0  dropped 0  overruns 0  frame 0
</span><span class='line'>        TX packets 1704  bytes 139101 (135.8 KiB)
</span><span class='line'>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span><span class='line'>
</span><span class='line'>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
</span><span class='line'>        inet 127.0.0.1  netmask 255.0.0.0
</span><span class='line'>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
</span><span class='line'>        loop  txqueuelen 1000  (Local Loopback)
</span><span class='line'>        RX packets 625  bytes 57768 (56.4 KiB)
</span><span class='line'>        RX errors 0  dropped 0  overruns 0  frame 0
</span><span class='line'>        TX packets 625  bytes 57768 (56.4 KiB)
</span><span class='line'>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo cat /sys/class/dmi/id/product_uuid
</span><span class='line'>564DD81E-DEBE-B06D-CF35-D7E3DDA4A6FC
</span><span class='line'>
</span><span class='line'>## 检查网络适配器
</span><span class='line'># 只有一个网卡，跳过
</span><span class='line'>
</span><span class='line'>## 允许 iptables 检查桥接流量
</span><span class='line'>[ec2-user@amazonlinux ~]$ lsmod | grep br_netfilter
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo modprobe br_netfilter
</span><span class='line'>[ec2-user@amazonlinux ~]$ lsmod | grep br_netfilter 
</span><span class='line'>br_netfilter           24576  0
</span><span class='line'>bridge                172032  1 br_netfilter
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span><span class='line'>br_netfilter
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span><span class='line'>net.bridge.bridge-nf-call-ip6tables = 1
</span><span class='line'>net.bridge.bridge-nf-call-iptables = 1
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo sysctl --system
</span><span class='line'>* Applying /etc/sysctl.d/00-defaults.conf ...
</span><span class='line'>kernel.printk = 8 4 1 7
</span><span class='line'>kernel.panic = 30
</span><span class='line'>net.ipv4.neigh.default.gc_thresh1 = 0
</span><span class='line'>net.ipv6.neigh.default.gc_thresh1 = 0
</span><span class='line'>net.ipv4.neigh.default.gc_thresh2 = 15360
</span><span class='line'>net.ipv6.neigh.default.gc_thresh2 = 15360
</span><span class='line'>net.ipv4.neigh.default.gc_thresh3 = 16384
</span><span class='line'>net.ipv6.neigh.default.gc_thresh3 = 16384
</span><span class='line'>* Applying /usr/lib/sysctl.d/00-system.conf ...
</span><span class='line'>net.bridge.bridge-nf-call-ip6tables = 0
</span><span class='line'>net.bridge.bridge-nf-call-iptables = 0
</span><span class='line'>net.bridge.bridge-nf-call-arptables = 0
</span><span class='line'>* Applying /usr/lib/sysctl.d/10-default-yama-scope.conf ...
</span><span class='line'>kernel.yama.ptrace_scope = 0
</span><span class='line'>* Applying /usr/lib/sysctl.d/50-default.conf ...
</span><span class='line'>kernel.sysrq = 16
</span><span class='line'>kernel.core_uses_pid = 1
</span><span class='line'>kernel.kptr_restrict = 1
</span><span class='line'>net.ipv4.conf.default.rp_filter = 1
</span><span class='line'>net.ipv4.conf.all.rp_filter = 1
</span><span class='line'>net.ipv4.conf.default.accept_source_route = 0
</span><span class='line'>net.ipv4.conf.all.accept_source_route = 0
</span><span class='line'>net.ipv4.conf.default.promote_secondaries = 1
</span><span class='line'>net.ipv4.conf.all.promote_secondaries = 1
</span><span class='line'>fs.protected_hardlinks = 1
</span><span class='line'>fs.protected_symlinks = 1
</span><span class='line'>* Applying /etc/sysctl.d/99-amazon.conf ...
</span><span class='line'>kernel.sched_autogroup_enabled = 0
</span><span class='line'>* Applying /etc/sysctl.d/99-sysctl.conf ...
</span><span class='line'>* Applying /etc/sysctl.d/k8s.conf ...
</span><span class='line'>net.bridge.bridge-nf-call-ip6tables = 1
</span><span class='line'>net.bridge.bridge-nf-call-iptables = 1
</span><span class='line'>* Applying /etc/sysctl.conf ...
</span><span class='line'>
</span><span class='line'>## SELINUX
</span><span class='line'>sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config 
</span><span class='line'>setenforce 0
</span><span class='line'>
</span><span class='line'>## Docker
</span><span class='line'>cat &lt;&lt;EOF | sudo tee /etc/docker/daemon.json
</span><span class='line'>{
</span><span class='line'>  "exec-opts": ["native.cgroupdriver=systemd"],
</span><span class='line'>  "log-driver": "json-file",
</span><span class='line'>  "log-opts": {
</span><span class='line'>    "max-size": "100m"
</span><span class='line'>  },
</span><span class='line'>  "storage-driver": "overlay2"
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>sudo systemctl enable docker
</span><span class='line'>sudo systemctl daemon-reload
</span><span class='line'>sudo systemctl restart docker
</span></code></pre></td></tr></table></div></figure>


<p>修改时区</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo rm -rf /etc/localtime 
</span><span class='line'>sudo ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime </span></code></pre></td></tr></table></div></figure>


<h2>主节点安装kubeadm并加载docker镜像</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## 修改主机名
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo hostnamectl --static set-hostname k8s 
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo hostname k8s 
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ rz
</span><span class='line'>rz waiting to receive.
</span><span class='line'>Starting zmodem transfer.  Press Ctrl+C to cancel.
</span><span class='line'>Transferring ab0e12925be5251baf5dd3b31493663d46e4a7b458c7a5b6b717f4ae87a81bd4-kubeadm-1.23.5-0.x86_64.rpm...
</span><span class='line'>  100%    9253 KB    9253 KB/sec    00:00:01       0 Errors  
</span><span class='line'>Transferring d39aa6eb38a6a8326b7e88c622107327dfd02ac8aaae32eceb856643a2ad9981-kubelet-1.23.5-0.x86_64.rpm...
</span><span class='line'>  100%   21041 KB    21041 KB/sec    00:00:01       0 Errors  
</span><span class='line'>Transferring 4d300a7655f56307d35f127d99dc192b6aa4997f322234e754f16aaa60fd8906-cri-tools-1.23.0-0.x86_64.rpm...
</span><span class='line'>  100%    7228 KB    7228 KB/sec    00:00:01       0 Errors  
</span><span class='line'>Transferring db7cb5cb0b3f6875f54d10f02e625573988e3e91fd4fc5eef0b1876bb18604ad-kubernetes-cni-0.8.7-0.x86_64.rpm...
</span><span class='line'>  100%   19030 KB    19030 KB/sec    00:00:01       0 Errors  
</span><span class='line'>Transferring 96b208380314a19ded917eaf125ed748f5e2b28a3cc8707a10a76a9f5b61c0df-kubectl-1.23.5-0.x86_64.rpm...
</span><span class='line'>  100%    9689 KB    9689 KB/sec    00:00:01       0 Errors  
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ sudo yum install -y *.rpm
</span><span class='line'>Loaded plugins: langpacks, priorities, update-motd
</span><span class='line'>Examining 4d300a7655f56307d35f127d99dc192b6aa4997f322234e754f16aaa60fd8906-cri-tools-1.23.0-0.x86_64.rpm: cri-tools-1.23.0-0.x86_64
</span><span class='line'>Marking 4d300a7655f56307d35f127d99dc192b6aa4997f322234e754f16aaa60fd8906-cri-tools-1.23.0-0.x86_64.rpm to be installed
</span><span class='line'>Examining 96b208380314a19ded917eaf125ed748f5e2b28a3cc8707a10a76a9f5b61c0df-kubectl-1.23.5-0.x86_64.rpm: kubectl-1.23.5-0.x86_64
</span><span class='line'>Marking 96b208380314a19ded917eaf125ed748f5e2b28a3cc8707a10a76a9f5b61c0df-kubectl-1.23.5-0.x86_64.rpm to be installed
</span><span class='line'>Examining ab0e12925be5251baf5dd3b31493663d46e4a7b458c7a5b6b717f4ae87a81bd4-kubeadm-1.23.5-0.x86_64.rpm: kubeadm-1.23.5-0.x86_64
</span><span class='line'>Marking ab0e12925be5251baf5dd3b31493663d46e4a7b458c7a5b6b717f4ae87a81bd4-kubeadm-1.23.5-0.x86_64.rpm to be installed
</span><span class='line'>Examining d39aa6eb38a6a8326b7e88c622107327dfd02ac8aaae32eceb856643a2ad9981-kubelet-1.23.5-0.x86_64.rpm: kubelet-1.23.5-0.x86_64
</span><span class='line'>Marking d39aa6eb38a6a8326b7e88c622107327dfd02ac8aaae32eceb856643a2ad9981-kubelet-1.23.5-0.x86_64.rpm to be installed
</span><span class='line'>Examining db7cb5cb0b3f6875f54d10f02e625573988e3e91fd4fc5eef0b1876bb18604ad-kubernetes-cni-0.8.7-0.x86_64.rpm: kubernetes-cni-0.8.7-0.x86_64
</span><span class='line'>Marking db7cb5cb0b3f6875f54d10f02e625573988e3e91fd4fc5eef0b1876bb18604ad-kubernetes-cni-0.8.7-0.x86_64.rpm to be installed
</span><span class='line'>Resolving Dependencies
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package cri-tools.x86_64 0:1.23.0-0 will be installed
</span><span class='line'>---&gt; Package kubeadm.x86_64 0:1.23.5-0 will be installed
</span><span class='line'>---&gt; Package kubectl.x86_64 0:1.23.5-0 will be installed
</span><span class='line'>---&gt; Package kubelet.x86_64 0:1.23.5-0 will be installed
</span><span class='line'>--&gt; Processing Dependency: conntrack for package: kubelet-1.23.5-0.x86_64
</span><span class='line'>--&gt; Processing Dependency: ebtables for package: kubelet-1.23.5-0.x86_64
</span><span class='line'>--&gt; Processing Dependency: socat for package: kubelet-1.23.5-0.x86_64
</span><span class='line'>---&gt; Package kubernetes-cni.x86_64 0:0.8.7-0 will be installed
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package conntrack-tools.x86_64 0:1.4.4-5.amzn2.2 will be installed
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_cttimeout.so.1(LIBNETFILTER_CTTIMEOUT_1.1)(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_cttimeout.so.1(LIBNETFILTER_CTTIMEOUT_1.0)(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_cthelper.so.0(LIBNETFILTER_CTHELPER_1.0)(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_queue.so.1()(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_cttimeout.so.1()(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_cthelper.so.0()(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>---&gt; Package ebtables.x86_64 0:2.0.10-16.amzn2.0.1 will be installed
</span><span class='line'>---&gt; Package socat.x86_64 0:1.7.3.2-2.amzn2.0.1 will be installed
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package libnetfilter_cthelper.x86_64 0:1.0.0-10.amzn2.1 will be installed
</span><span class='line'>---&gt; Package libnetfilter_cttimeout.x86_64 0:1.0.0-6.amzn2.1 will be installed
</span><span class='line'>---&gt; Package libnetfilter_queue.x86_64 0:1.0.2-2.amzn2.0.2 will be installed
</span><span class='line'>--&gt; Finished Dependency Resolution
</span><span class='line'>
</span><span class='line'>Dependencies Resolved
</span><span class='line'>
</span><span class='line'>======================================================================================================================================================
</span><span class='line'> Package                Arch   Version             Repository                                                                                    Size
</span><span class='line'>======================================================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> cri-tools              x86_64 1.23.0-0            /4d300a7655f56307d35f127d99dc192b6aa4997f322234e754f16aaa60fd8906-cri-tools-1.23.0-0.x86_64   34 M
</span><span class='line'> kubeadm                x86_64 1.23.5-0            /ab0e12925be5251baf5dd3b31493663d46e4a7b458c7a5b6b717f4ae87a81bd4-kubeadm-1.23.5-0.x86_64     43 M
</span><span class='line'> kubectl                x86_64 1.23.5-0            /96b208380314a19ded917eaf125ed748f5e2b28a3cc8707a10a76a9f5b61c0df-kubectl-1.23.5-0.x86_64     44 M
</span><span class='line'> kubelet                x86_64 1.23.5-0            /d39aa6eb38a6a8326b7e88c622107327dfd02ac8aaae32eceb856643a2ad9981-kubelet-1.23.5-0.x86_64    119 M
</span><span class='line'> kubernetes-cni         x86_64 0.8.7-0             /db7cb5cb0b3f6875f54d10f02e625573988e3e91fd4fc5eef0b1876bb18604ad-kubernetes-cni-0.8.7-0.x86_64
</span><span class='line'>                                                                                                                                                 55 M
</span><span class='line'>Installing for dependencies:
</span><span class='line'> conntrack-tools        x86_64 1.4.4-5.amzn2.2     amzn2-core                                                                                   186 k
</span><span class='line'> ebtables               x86_64 2.0.10-16.amzn2.0.1 amzn2-core                                                                                   122 k
</span><span class='line'> libnetfilter_cthelper  x86_64 1.0.0-10.amzn2.1    amzn2-core                                                                                    18 k
</span><span class='line'> libnetfilter_cttimeout x86_64 1.0.0-6.amzn2.1     amzn2-core                                                                                    18 k
</span><span class='line'> libnetfilter_queue     x86_64 1.0.2-2.amzn2.0.2   amzn2-core                                                                                    24 k
</span><span class='line'> socat                  x86_64 1.7.3.2-2.amzn2.0.1 amzn2-core                                                                                   291 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>======================================================================================================================================================
</span><span class='line'>Install  5 Packages (+6 Dependent packages)
</span><span class='line'>
</span><span class='line'>Total size: 296 M
</span><span class='line'>Total download size: 658 k
</span><span class='line'>Installed size: 298 M
</span><span class='line'>Downloading packages:
</span><span class='line'>(1/6): ebtables-2.0.10-16.amzn2.0.1.x86_64.rpm                                                                                 | 122 kB  00:00:10     
</span><span class='line'>(2/6): libnetfilter_cthelper-1.0.0-10.amzn2.1.x86_64.rpm                                                                       |  18 kB  00:00:00     
</span><span class='line'>(3/6): conntrack-tools-1.4.4-5.amzn2.2.x86_64.rpm                                                                              | 186 kB  00:00:10     
</span><span class='line'>(4/6): libnetfilter_cttimeout-1.0.0-6.amzn2.1.x86_64.rpm                                                                       |  18 kB  00:00:00     
</span><span class='line'>(5/6): libnetfilter_queue-1.0.2-2.amzn2.0.2.x86_64.rpm                                                                         |  24 kB  00:00:00     
</span><span class='line'>(6/6): socat-1.7.3.2-2.amzn2.0.1.x86_64.rpm                                                                                    | 291 kB  00:00:00     
</span><span class='line'>------------------------------------------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                                                                  45 kB/s | 658 kB  00:00:14     
</span><span class='line'>Running transaction check
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded
</span><span class='line'>Running transaction
</span><span class='line'>  Installing : libnetfilter_cthelper-1.0.0-10.amzn2.1.x86_64                                                                                     1/11 
</span><span class='line'>  Installing : libnetfilter_cttimeout-1.0.0-6.amzn2.1.x86_64                                                                                     2/11 
</span><span class='line'>  Installing : libnetfilter_queue-1.0.2-2.amzn2.0.2.x86_64                                                                                       3/11 
</span><span class='line'>  Installing : conntrack-tools-1.4.4-5.amzn2.2.x86_64                                                                                            4/11 
</span><span class='line'>  Installing : ebtables-2.0.10-16.amzn2.0.1.x86_64                                                                                               5/11 
</span><span class='line'>  Installing : cri-tools-1.23.0-0.x86_64                                                                                                         6/11 
</span><span class='line'>  Installing : socat-1.7.3.2-2.amzn2.0.1.x86_64                                                                                                  7/11 
</span><span class='line'>  Installing : kubelet-1.23.5-0.x86_64                                                                                                           8/11 
</span><span class='line'>  Installing : kubernetes-cni-0.8.7-0.x86_64                                                                                                     9/11 
</span><span class='line'>  Installing : kubectl-1.23.5-0.x86_64                                                                                                          10/11 
</span><span class='line'>  Installing : kubeadm-1.23.5-0.x86_64                                                                                                          11/11 
</span><span class='line'>  Verifying  : kubernetes-cni-0.8.7-0.x86_64                                                                                                     1/11 
</span><span class='line'>  Verifying  : kubectl-1.23.5-0.x86_64                                                                                                           2/11 
</span><span class='line'>  Verifying  : socat-1.7.3.2-2.amzn2.0.1.x86_64                                                                                                  3/11 
</span><span class='line'>  Verifying  : cri-tools-1.23.0-0.x86_64                                                                                                         4/11 
</span><span class='line'>  Verifying  : ebtables-2.0.10-16.amzn2.0.1.x86_64                                                                                               5/11 
</span><span class='line'>  Verifying  : libnetfilter_queue-1.0.2-2.amzn2.0.2.x86_64                                                                                       6/11 
</span><span class='line'>  Verifying  : conntrack-tools-1.4.4-5.amzn2.2.x86_64                                                                                            7/11 
</span><span class='line'>  Verifying  : libnetfilter_cttimeout-1.0.0-6.amzn2.1.x86_64                                                                                     8/11 
</span><span class='line'>  Verifying  : kubeadm-1.23.5-0.x86_64                                                                                                           9/11 
</span><span class='line'>  Verifying  : kubelet-1.23.5-0.x86_64                                                                                                          10/11 
</span><span class='line'>  Verifying  : libnetfilter_cthelper-1.0.0-10.amzn2.1.x86_64                                                                                    11/11 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  cri-tools.x86_64 0:1.23.0-0   kubeadm.x86_64 0:1.23.5-0   kubectl.x86_64 0:1.23.5-0   kubelet.x86_64 0:1.23.5-0   kubernetes-cni.x86_64 0:0.8.7-0  
</span><span class='line'>
</span><span class='line'>Dependency Installed:
</span><span class='line'>  conntrack-tools.x86_64 0:1.4.4-5.amzn2.2          ebtables.x86_64 0:2.0.10-16.amzn2.0.1           libnetfilter_cthelper.x86_64 0:1.0.0-10.amzn2.1  
</span><span class='line'>  libnetfilter_cttimeout.x86_64 0:1.0.0-6.amzn2.1   libnetfilter_queue.x86_64 0:1.0.2-2.amzn2.0.2   socat.x86_64 0:1.7.3.2-2.amzn2.0.1               
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ sudo yum install ebtables ethtool             
</span></code></pre></td></tr></table></div></figure>


<p>加载docker镜像：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ docker load -i k8s.tar.gz 
</span><span class='line'>194a408e97d8: Loading layer [==================================================&gt;]  68.57MB/68.57MB
</span><span class='line'>2b8347a02bc5: Loading layer [==================================================&gt;]  1.509MB/1.509MB
</span><span class='line'>618b3e11ccba: Loading layer [==================================================&gt;]  44.17MB/44.17MB
</span><span class='line'>Loaded image: k8s.gcr.io/kube-proxy:v1.23.5
</span><span class='line'>5b1fa8e3e100: Loading layer [==================================================&gt;]  3.697MB/3.697MB
</span><span class='line'>83e216f0eb98: Loading layer [==================================================&gt;]  1.509MB/1.509MB
</span><span class='line'>a70573edad24: Loading layer [==================================================&gt;]  121.1MB/121.1MB
</span><span class='line'>Loaded image: k8s.gcr.io/kube-controller-manager:v1.23.5
</span><span class='line'>46576c5a6a97: Loading layer [==================================================&gt;]  49.63MB/49.63MB
</span><span class='line'>Loaded image: k8s.gcr.io/kube-scheduler:v1.23.5
</span><span class='line'>6d75f23be3dd: Loading layer [==================================================&gt;]  3.697MB/3.697MB
</span><span class='line'>b6e8c573c18d: Loading layer [==================================================&gt;]  2.257MB/2.257MB
</span><span class='line'>d80003ff5706: Loading layer [==================================================&gt;]    267MB/267MB
</span><span class='line'>664dd6f2834b: Loading layer [==================================================&gt;]  2.137MB/2.137MB
</span><span class='line'>62ae031121b1: Loading layer [==================================================&gt;]  18.86MB/18.86MB
</span><span class='line'>Loaded image: k8s.gcr.io/etcd:3.5.1-0
</span><span class='line'>256bc5c338a6: Loading layer [==================================================&gt;]  336.4kB/336.4kB
</span><span class='line'>80e4a2390030: Loading layer [==================================================&gt;]  46.62MB/46.62MB
</span><span class='line'>Loaded image: k8s.gcr.io/coredns/coredns:v1.8.6
</span><span class='line'>1021ef88c797: Loading layer [==================================================&gt;]  684.5kB/684.5kB
</span><span class='line'>Loaded image: k8s.gcr.io/pause:3.6
</span><span class='line'>50098fdfecae: Loading layer [==================================================&gt;]  131.3MB/131.3MB
</span><span class='line'>Loaded image: k8s.gcr.io/kube-apiserver:v1.23.5
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ docker images 
</span><span class='line'>REPOSITORY                           TAG       IMAGE ID       CREATED        SIZE
</span><span class='line'>k8s.gcr.io/kube-apiserver            v1.23.5   3fc1d62d6587   15 hours ago   135MB
</span><span class='line'>k8s.gcr.io/kube-proxy                v1.23.5   3c53fa8541f9   15 hours ago   112MB
</span><span class='line'>k8s.gcr.io/kube-controller-manager   v1.23.5   b0c9e5e4dbb1   15 hours ago   125MB
</span><span class='line'>k8s.gcr.io/kube-scheduler            v1.23.5   884d49d6d8c9   15 hours ago   53.5MB
</span><span class='line'>k8s.gcr.io/etcd                      3.5.1-0   25f8c7f3da61   4 months ago   293MB
</span><span class='line'>k8s.gcr.io/coredns/coredns           v1.8.6    a4ca41631cc7   5 months ago   46.8MB
</span><span class='line'>k8s.gcr.io/pause                     3.6       6270bb605e12   6 months ago   683kB
</span><span class='line'>[ec2-user@k8s ~]$ 
</span></code></pre></td></tr></table></div></figure>


<h2>主节点(控制平面control-plane node)启动服务</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ sudo su - 
</span><span class='line'>
</span><span class='line'>[root@k8s ~]# kubeadm init 
</span><span class='line'>[init] Using Kubernetes version: v1.23.5
</span><span class='line'>[preflight] Running pre-flight checks
</span><span class='line'>        [WARNING FileExisting-tc]: tc not found in system path
</span><span class='line'>        [WARNING Hostname]: hostname "k8s" could not be reached
</span><span class='line'>        [WARNING Hostname]: hostname "k8s": lookup k8s on 192.168.191.2:53: no such host
</span><span class='line'>        [WARNING Service-Kubelet]: kubelet service is not enabled, please run 'systemctl enable kubelet.service'
</span><span class='line'>[preflight] Pulling images required for setting up a Kubernetes cluster
</span><span class='line'>[preflight] This might take a minute or two, depending on the speed of your internet connection
</span><span class='line'>[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'
</span><span class='line'>[certs] Using certificateDir folder "/etc/kubernetes/pki"
</span><span class='line'>[certs] Generating "ca" certificate and key
</span><span class='line'>[certs] Generating "apiserver" certificate and key
</span><span class='line'>[certs] apiserver serving cert is signed for DNS names [k8s kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.191.131]
</span><span class='line'>[certs] Generating "apiserver-kubelet-client" certificate and key
</span><span class='line'>[certs] Generating "front-proxy-ca" certificate and key
</span><span class='line'>[certs] Generating "front-proxy-client" certificate and key
</span><span class='line'>[certs] Generating "etcd/ca" certificate and key
</span><span class='line'>[certs] Generating "etcd/server" certificate and key
</span><span class='line'>[certs] etcd/server serving cert is signed for DNS names [k8s localhost] and IPs [192.168.191.131 127.0.0.1 ::1]
</span><span class='line'>[certs] Generating "etcd/peer" certificate and key
</span><span class='line'>[certs] etcd/peer serving cert is signed for DNS names [k8s localhost] and IPs [192.168.191.131 127.0.0.1 ::1]
</span><span class='line'>[certs] Generating "etcd/healthcheck-client" certificate and key
</span><span class='line'>[certs] Generating "apiserver-etcd-client" certificate and key
</span><span class='line'>[certs] Generating "sa" key and public key
</span><span class='line'>[kubeconfig] Using kubeconfig folder "/etc/kubernetes"
</span><span class='line'>[kubeconfig] Writing "admin.conf" kubeconfig file
</span><span class='line'>[kubeconfig] Writing "kubelet.conf" kubeconfig file
</span><span class='line'>[kubeconfig] Writing "controller-manager.conf" kubeconfig file
</span><span class='line'>[kubeconfig] Writing "scheduler.conf" kubeconfig file
</span><span class='line'>[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
</span><span class='line'>[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
</span><span class='line'>[kubelet-start] Starting the kubelet
</span><span class='line'>[control-plane] Using manifest folder "/etc/kubernetes/manifests"
</span><span class='line'>[control-plane] Creating static Pod manifest for "kube-apiserver"
</span><span class='line'>[control-plane] Creating static Pod manifest for "kube-controller-manager"
</span><span class='line'>[control-plane] Creating static Pod manifest for "kube-scheduler"
</span><span class='line'>[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"
</span><span class='line'>[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests". This can take up to 4m0s
</span><span class='line'>[kubelet-check] Initial timeout of 40s passed.
</span><span class='line'>[apiclient] All control plane components are healthy after 87.001525 seconds
</span><span class='line'>[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
</span><span class='line'>[kubelet] Creating a ConfigMap "kubelet-config-1.23" in namespace kube-system with the configuration for the kubelets in the cluster
</span><span class='line'>NOTE: The "kubelet-config-1.23" naming of the kubelet ConfigMap is deprecated. Once the UnversionedKubeletConfigMap feature gate graduates to Beta the default name will become just "kubelet-config". Kubeadm upgrade will handle this transition transparently.
</span><span class='line'>[upload-certs] Skipping phase. Please see --upload-certs
</span><span class='line'>[mark-control-plane] Marking the node k8s as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]
</span><span class='line'>[mark-control-plane] Marking the node k8s as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]
</span><span class='line'>[bootstrap-token] Using token: sj6fff.bpak7gkd3hnyzcm5
</span><span class='line'>[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
</span><span class='line'>[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes
</span><span class='line'>[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
</span><span class='line'>[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
</span><span class='line'>[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
</span><span class='line'>[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace
</span><span class='line'>[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key
</span><span class='line'>[addons] Applied essential addon: CoreDNS
</span><span class='line'>[addons] Applied essential addon: kube-proxy
</span><span class='line'>
</span><span class='line'>Your Kubernetes control-plane has initialized successfully!
</span><span class='line'>
</span><span class='line'>To start using your cluster, you need to run the following as a regular user:
</span><span class='line'>
</span><span class='line'>  mkdir -p $HOME/.kube
</span><span class='line'>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span><span class='line'>  sudo chown $(id -u):$(id -g) $HOME/.kube/config
</span><span class='line'>
</span><span class='line'>Alternatively, if you are the root user, you can run:
</span><span class='line'>
</span><span class='line'>  export KUBECONFIG=/etc/kubernetes/admin.conf
</span><span class='line'>
</span><span class='line'>You should now deploy a pod network to the cluster.
</span><span class='line'>Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
</span><span class='line'>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span><span class='line'>
</span><span class='line'>Then you can join any number of worker nodes by running the following on each as root:
</span><span class='line'>
</span><span class='line'>kubeadm join 192.168.191.131:6443 --token sj6fff.bpak7gkd3hnyzcm5 \
</span><span class='line'>        --discovery-token-ca-cert-hash sha256:8e15649afc0771e80cce7f1dfdbb0933f4fdbd45ea1f9e03be1f3b78449a6d3c 
</span><span class='line'>[root@k8s ~]# 
</span></code></pre></td></tr></table></div></figure>


<p>普通用户配置kubectl：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ mkdir -p $HOME/.kube
</span><span class='line'>[ec2-user@k8s ~]$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span><span class='line'>[ec2-user@k8s ~]$ sudo chown $(id -u):$(id -g) $HOME/.kube/config
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ which kubectl
</span><span class='line'>/usr/bin/kubectl
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>[ec2-user@k8s ~]$ kubectl cluster-info
</span><span class='line'>Kubernetes control plane is running at https://192.168.191.131:6443
</span><span class='line'>CoreDNS is running at https://192.168.191.131:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span><span class='line'>
</span><span class='line'>To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get nodes -o wide
</span><span class='line'>NAME   STATUS     ROLES                  AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME
</span><span class='line'>k8s    NotReady   control-plane,master   14m   v1.23.5   192.168.191.131   &lt;none&gt;        Amazon Linux 2   4.14.268-205.500.amzn2.x86_64   docker://20.10.7
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --all-namespaces -o wide
</span><span class='line'>NAMESPACE     NAME                          READY   STATUS    RESTARTS   AGE   IP                NODE     NOMINATED NODE   READINESS GATES
</span><span class='line'>kube-system   coredns-64897985d-pcxpd       0/1     Pending   0          14m   &lt;none&gt;            &lt;none&gt;   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   coredns-64897985d-pfsj6       0/1     Pending   0          14m   &lt;none&gt;            &lt;none&gt;   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   etcd-k8s                      1/1     Running   0          14m   192.168.191.131   k8s      &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-apiserver-k8s            1/1     Running   0          14m   192.168.191.131   k8s      &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-controller-manager-k8s   1/1     Running   0          14m   192.168.191.131   k8s      &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-proxy-qj6lw              1/1     Running   0          14m   192.168.191.131   k8s      &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-scheduler-k8s            1/1     Running   0          14m   192.168.191.131   k8s      &lt;none&gt;           &lt;none&gt;
</span><span class='line'>[ec2-user@k8s ~]$ 
</span></code></pre></td></tr></table></div></figure>


<p>如果希望主节点（控制平面节点control-plane node)上也调度 Pod， 例如用于开发的单机 Kubernetes 集群，请运行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@k8s ~]# export KUBECONFIG=/etc/kubernetes/admin.conf
</span><span class='line'>[root@k8s ~]# kubectl taint nodes --all node-role.kubernetes.io/master-
</span><span class='line'>node/k8s untainted
</span><span class='line'>[root@k8s ~]# 
</span></code></pre></td></tr></table></div></figure>


<h2>加入工作节点(nodes)</h2>

<p>先把docker安装好，以及系统基础配置，参考上面的步骤。然后安装kubeadm，以及加载gcr的docker镜像。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@amazonlinux ~]$ ll
</span><span class='line'>total 285480
</span><span class='line'>-rw-r--r-- 1 ec2-user ec2-user   7401938 Mar 17 15:22 4d300a7655f56307d35f127d99dc192b6aa4997f322234e754f16aaa60fd8906-cri-tools-1.23.0-0.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 ec2-user ec2-user   9921646 Mar 17 15:22 96b208380314a19ded917eaf125ed748f5e2b28a3cc8707a10a76a9f5b61c0df-kubectl-1.23.5-0.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 ec2-user ec2-user   9475514 Mar 17 15:22 ab0e12925be5251baf5dd3b31493663d46e4a7b458c7a5b6b717f4ae87a81bd4-kubeadm-1.23.5-0.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 ec2-user ec2-user  21546750 Mar 17 15:22 d39aa6eb38a6a8326b7e88c622107327dfd02ac8aaae32eceb856643a2ad9981-kubelet-1.23.5-0.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 ec2-user ec2-user  19487362 Mar 17 15:22 db7cb5cb0b3f6875f54d10f02e625573988e3e91fd4fc5eef0b1876bb18604ad-kubernetes-cni-0.8.7-0.x86_64.rpm
</span><span class='line'>-rw-r--r-- 1 ec2-user ec2-user 224482960 Mar 17 15:22 k8s.tar.gz
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo yum install *.rpm 
</span><span class='line'>Loaded plugins: langpacks, priorities, update-motd
</span><span class='line'>Examining 4d300a7655f56307d35f127d99dc192b6aa4997f322234e754f16aaa60fd8906-cri-tools-1.23.0-0.x86_64.rpm: cri-tools-1.23.0-0.x86_64
</span><span class='line'>Marking 4d300a7655f56307d35f127d99dc192b6aa4997f322234e754f16aaa60fd8906-cri-tools-1.23.0-0.x86_64.rpm to be installed
</span><span class='line'>Examining 96b208380314a19ded917eaf125ed748f5e2b28a3cc8707a10a76a9f5b61c0df-kubectl-1.23.5-0.x86_64.rpm: kubectl-1.23.5-0.x86_64
</span><span class='line'>Marking 96b208380314a19ded917eaf125ed748f5e2b28a3cc8707a10a76a9f5b61c0df-kubectl-1.23.5-0.x86_64.rpm to be installed
</span><span class='line'>Examining ab0e12925be5251baf5dd3b31493663d46e4a7b458c7a5b6b717f4ae87a81bd4-kubeadm-1.23.5-0.x86_64.rpm: kubeadm-1.23.5-0.x86_64
</span><span class='line'>Marking ab0e12925be5251baf5dd3b31493663d46e4a7b458c7a5b6b717f4ae87a81bd4-kubeadm-1.23.5-0.x86_64.rpm to be installed
</span><span class='line'>Examining d39aa6eb38a6a8326b7e88c622107327dfd02ac8aaae32eceb856643a2ad9981-kubelet-1.23.5-0.x86_64.rpm: kubelet-1.23.5-0.x86_64
</span><span class='line'>Marking d39aa6eb38a6a8326b7e88c622107327dfd02ac8aaae32eceb856643a2ad9981-kubelet-1.23.5-0.x86_64.rpm to be installed
</span><span class='line'>Examining db7cb5cb0b3f6875f54d10f02e625573988e3e91fd4fc5eef0b1876bb18604ad-kubernetes-cni-0.8.7-0.x86_64.rpm: kubernetes-cni-0.8.7-0.x86_64
</span><span class='line'>Marking db7cb5cb0b3f6875f54d10f02e625573988e3e91fd4fc5eef0b1876bb18604ad-kubernetes-cni-0.8.7-0.x86_64.rpm to be installed
</span><span class='line'>Resolving Dependencies
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package cri-tools.x86_64 0:1.23.0-0 will be installed
</span><span class='line'>---&gt; Package kubeadm.x86_64 0:1.23.5-0 will be installed
</span><span class='line'>---&gt; Package kubectl.x86_64 0:1.23.5-0 will be installed
</span><span class='line'>---&gt; Package kubelet.x86_64 0:1.23.5-0 will be installed
</span><span class='line'>--&gt; Processing Dependency: conntrack for package: kubelet-1.23.5-0.x86_64
</span><span class='line'>amzn2-core                                                                                                                                  | 3.7 kB  00:00:00     
</span><span class='line'>--&gt; Processing Dependency: ebtables for package: kubelet-1.23.5-0.x86_64
</span><span class='line'>--&gt; Processing Dependency: socat for package: kubelet-1.23.5-0.x86_64
</span><span class='line'>---&gt; Package kubernetes-cni.x86_64 0:0.8.7-0 will be installed
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package conntrack-tools.x86_64 0:1.4.4-5.amzn2.2 will be installed
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_cttimeout.so.1(LIBNETFILTER_CTTIMEOUT_1.1)(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_cttimeout.so.1(LIBNETFILTER_CTTIMEOUT_1.0)(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_cthelper.so.0(LIBNETFILTER_CTHELPER_1.0)(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_queue.so.1()(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_cttimeout.so.1()(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>--&gt; Processing Dependency: libnetfilter_cthelper.so.0()(64bit) for package: conntrack-tools-1.4.4-5.amzn2.2.x86_64
</span><span class='line'>---&gt; Package ebtables.x86_64 0:2.0.10-16.amzn2.0.1 will be installed
</span><span class='line'>---&gt; Package socat.x86_64 0:1.7.3.2-2.amzn2.0.1 will be installed
</span><span class='line'>--&gt; Running transaction check
</span><span class='line'>---&gt; Package libnetfilter_cthelper.x86_64 0:1.0.0-10.amzn2.1 will be installed
</span><span class='line'>---&gt; Package libnetfilter_cttimeout.x86_64 0:1.0.0-6.amzn2.1 will be installed
</span><span class='line'>---&gt; Package libnetfilter_queue.x86_64 0:1.0.2-2.amzn2.0.2 will be installed
</span><span class='line'>--&gt; Finished Dependency Resolution
</span><span class='line'>
</span><span class='line'>Dependencies Resolved
</span><span class='line'>
</span><span class='line'>===================================================================================================================================================================
</span><span class='line'> Package                  Arch     Version                 Repository                                                                                         Size
</span><span class='line'>===================================================================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> cri-tools                x86_64   1.23.0-0                /4d300a7655f56307d35f127d99dc192b6aa4997f322234e754f16aaa60fd8906-cri-tools-1.23.0-0.x86_64        34 M
</span><span class='line'> kubeadm                  x86_64   1.23.5-0                /ab0e12925be5251baf5dd3b31493663d46e4a7b458c7a5b6b717f4ae87a81bd4-kubeadm-1.23.5-0.x86_64          43 M
</span><span class='line'> kubectl                  x86_64   1.23.5-0                /96b208380314a19ded917eaf125ed748f5e2b28a3cc8707a10a76a9f5b61c0df-kubectl-1.23.5-0.x86_64          44 M
</span><span class='line'> kubelet                  x86_64   1.23.5-0                /d39aa6eb38a6a8326b7e88c622107327dfd02ac8aaae32eceb856643a2ad9981-kubelet-1.23.5-0.x86_64         119 M
</span><span class='line'> kubernetes-cni           x86_64   0.8.7-0                 /db7cb5cb0b3f6875f54d10f02e625573988e3e91fd4fc5eef0b1876bb18604ad-kubernetes-cni-0.8.7-0.x86_64    55 M
</span><span class='line'>Installing for dependencies:
</span><span class='line'> conntrack-tools          x86_64   1.4.4-5.amzn2.2         amzn2-core                                                                                        186 k
</span><span class='line'> ebtables                 x86_64   2.0.10-16.amzn2.0.1     amzn2-core                                                                                        122 k
</span><span class='line'> libnetfilter_cthelper    x86_64   1.0.0-10.amzn2.1        amzn2-core                                                                                         18 k
</span><span class='line'> libnetfilter_cttimeout   x86_64   1.0.0-6.amzn2.1         amzn2-core                                                                                         18 k
</span><span class='line'> libnetfilter_queue       x86_64   1.0.2-2.amzn2.0.2       amzn2-core                                                                                         24 k
</span><span class='line'> socat                    x86_64   1.7.3.2-2.amzn2.0.1     amzn2-core                                                                                        291 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>===================================================================================================================================================================
</span><span class='line'>Install  5 Packages (+6 Dependent packages)
</span><span class='line'>
</span><span class='line'>Total size: 296 M
</span><span class='line'>Total download size: 658 k
</span><span class='line'>Installed size: 298 M
</span><span class='line'>Is this ok [y/d/N]: y
</span><span class='line'>Downloading packages:
</span><span class='line'>(1/6): ebtables-2.0.10-16.amzn2.0.1.x86_64.rpm                                                                                              | 122 kB  00:00:00     
</span><span class='line'>(2/6): libnetfilter_cthelper-1.0.0-10.amzn2.1.x86_64.rpm                                                                                    |  18 kB  00:00:00     
</span><span class='line'>(3/6): libnetfilter_cttimeout-1.0.0-6.amzn2.1.x86_64.rpm                                                                                    |  18 kB  00:00:00     
</span><span class='line'>(4/6): conntrack-tools-1.4.4-5.amzn2.2.x86_64.rpm                                                                                           | 186 kB  00:00:00     
</span><span class='line'>(5/6): libnetfilter_queue-1.0.2-2.amzn2.0.2.x86_64.rpm                                                                                      |  24 kB  00:00:00     
</span><span class='line'>(6/6): socat-1.7.3.2-2.amzn2.0.1.x86_64.rpm                                                                                                 | 291 kB  00:00:00     
</span><span class='line'>-------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span><span class='line'>Total                                                                                                                              1.0 MB/s | 658 kB  00:00:00     
</span><span class='line'>Running transaction check
</span><span class='line'>Running transaction test
</span><span class='line'>Transaction test succeeded
</span><span class='line'>Running transaction
</span><span class='line'>  Installing : libnetfilter_cthelper-1.0.0-10.amzn2.1.x86_64                                                                                                  1/11 
</span><span class='line'>  Installing : libnetfilter_cttimeout-1.0.0-6.amzn2.1.x86_64                                                                                                  2/11 
</span><span class='line'>  Installing : libnetfilter_queue-1.0.2-2.amzn2.0.2.x86_64                                                                                                    3/11 
</span><span class='line'>  Installing : conntrack-tools-1.4.4-5.amzn2.2.x86_64                                                                                                         4/11 
</span><span class='line'>  Installing : ebtables-2.0.10-16.amzn2.0.1.x86_64                                                                                                            5/11 
</span><span class='line'>  Installing : cri-tools-1.23.0-0.x86_64                                                                                                                      6/11 
</span><span class='line'>  Installing : socat-1.7.3.2-2.amzn2.0.1.x86_64                                                                                                               7/11 
</span><span class='line'>  Installing : kubelet-1.23.5-0.x86_64                                                                                                                        8/11 
</span><span class='line'>  Installing : kubernetes-cni-0.8.7-0.x86_64                                                                                                                  9/11 
</span><span class='line'>  Installing : kubectl-1.23.5-0.x86_64                                                                                                                       10/11 
</span><span class='line'>  Installing : kubeadm-1.23.5-0.x86_64                                                                                                                       11/11 
</span><span class='line'>  Verifying  : kubernetes-cni-0.8.7-0.x86_64                                                                                                                  1/11 
</span><span class='line'>  Verifying  : kubectl-1.23.5-0.x86_64                                                                                                                        2/11 
</span><span class='line'>  Verifying  : socat-1.7.3.2-2.amzn2.0.1.x86_64                                                                                                               3/11 
</span><span class='line'>  Verifying  : cri-tools-1.23.0-0.x86_64                                                                                                                      4/11 
</span><span class='line'>  Verifying  : ebtables-2.0.10-16.amzn2.0.1.x86_64                                                                                                            5/11 
</span><span class='line'>  Verifying  : libnetfilter_queue-1.0.2-2.amzn2.0.2.x86_64                                                                                                    6/11 
</span><span class='line'>  Verifying  : conntrack-tools-1.4.4-5.amzn2.2.x86_64                                                                                                         7/11 
</span><span class='line'>  Verifying  : libnetfilter_cttimeout-1.0.0-6.amzn2.1.x86_64                                                                                                  8/11 
</span><span class='line'>  Verifying  : kubeadm-1.23.5-0.x86_64                                                                                                                        9/11 
</span><span class='line'>  Verifying  : kubelet-1.23.5-0.x86_64                                                                                                                       10/11 
</span><span class='line'>  Verifying  : libnetfilter_cthelper-1.0.0-10.amzn2.1.x86_64                                                                                                 11/11 
</span><span class='line'>
</span><span class='line'>Installed:
</span><span class='line'>  cri-tools.x86_64 0:1.23.0-0     kubeadm.x86_64 0:1.23.5-0     kubectl.x86_64 0:1.23.5-0     kubelet.x86_64 0:1.23.5-0     kubernetes-cni.x86_64 0:0.8.7-0    
</span><span class='line'>
</span><span class='line'>Dependency Installed:
</span><span class='line'>  conntrack-tools.x86_64 0:1.4.4-5.amzn2.2              ebtables.x86_64 0:2.0.10-16.amzn2.0.1               libnetfilter_cthelper.x86_64 0:1.0.0-10.amzn2.1      
</span><span class='line'>  libnetfilter_cttimeout.x86_64 0:1.0.0-6.amzn2.1       libnetfilter_queue.x86_64 0:1.0.2-2.amzn2.0.2       socat.x86_64 0:1.7.3.2-2.amzn2.0.1                   
</span><span class='line'>
</span><span class='line'>Complete!
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo yum install ebtables ethtool  
</span><span class='line'>Loaded plugins: langpacks, priorities, update-motd
</span><span class='line'>Package ebtables-2.0.10-16.amzn2.0.1.x86_64 already installed and latest version
</span><span class='line'>Package 2:ethtool-4.8-10.amzn2.x86_64 already installed and latest version
</span><span class='line'>Nothing to do
</span></code></pre></td></tr></table></div></figure>


<p>加载docker镜像</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker load -i k8s.tar.gz 
</span><span class='line'>194a408e97d8: Loading layer [==================================================&gt;]  68.57MB/68.57MB
</span><span class='line'>2b8347a02bc5: Loading layer [==================================================&gt;]  1.509MB/1.509MB
</span><span class='line'>618b3e11ccba: Loading layer [==================================================&gt;]  44.17MB/44.17MB
</span><span class='line'>Loaded image: k8s.gcr.io/kube-proxy:v1.23.5
</span><span class='line'>5b1fa8e3e100: Loading layer [==================================================&gt;]  3.697MB/3.697MB
</span><span class='line'>83e216f0eb98: Loading layer [==================================================&gt;]  1.509MB/1.509MB
</span><span class='line'>a70573edad24: Loading layer [==================================================&gt;]  121.1MB/121.1MB
</span><span class='line'>Loaded image: k8s.gcr.io/kube-controller-manager:v1.23.5
</span><span class='line'>46576c5a6a97: Loading layer [==================================================&gt;]  49.63MB/49.63MB
</span><span class='line'>Loaded image: k8s.gcr.io/kube-scheduler:v1.23.5
</span><span class='line'>6d75f23be3dd: Loading layer [==================================================&gt;]  3.697MB/3.697MB
</span><span class='line'>b6e8c573c18d: Loading layer [==================================================&gt;]  2.257MB/2.257MB
</span><span class='line'>d80003ff5706: Loading layer [==================================================&gt;]    267MB/267MB
</span><span class='line'>664dd6f2834b: Loading layer [==================================================&gt;]  2.137MB/2.137MB
</span><span class='line'>62ae031121b1: Loading layer [==================================================&gt;]  18.86MB/18.86MB
</span><span class='line'>Loaded image: k8s.gcr.io/etcd:3.5.1-0
</span><span class='line'>256bc5c338a6: Loading layer [==================================================&gt;]  336.4kB/336.4kB
</span><span class='line'>80e4a2390030: Loading layer [==================================================&gt;]  46.62MB/46.62MB
</span><span class='line'>Loaded image: k8s.gcr.io/coredns/coredns:v1.8.6
</span><span class='line'>1021ef88c797: Loading layer [==================================================&gt;]  684.5kB/684.5kB
</span><span class='line'>Loaded image: k8s.gcr.io/pause:3.6
</span><span class='line'>50098fdfecae: Loading layer [==================================================&gt;]  131.3MB/131.3MB
</span><span class='line'>Loaded image: k8s.gcr.io/kube-apiserver:v1.23.5
</span><span class='line'>
</span><span class='line'>[ec2-user@amazonlinux ~]$ docker images 
</span><span class='line'>REPOSITORY                           TAG       IMAGE ID       CREATED        SIZE
</span><span class='line'>k8s.gcr.io/kube-apiserver            v1.23.5   3fc1d62d6587   15 hours ago   135MB
</span><span class='line'>k8s.gcr.io/kube-proxy                v1.23.5   3c53fa8541f9   15 hours ago   112MB
</span><span class='line'>k8s.gcr.io/kube-controller-manager   v1.23.5   b0c9e5e4dbb1   15 hours ago   125MB
</span><span class='line'>k8s.gcr.io/kube-scheduler            v1.23.5   884d49d6d8c9   15 hours ago   53.5MB
</span><span class='line'>k8s.gcr.io/etcd                      3.5.1-0   25f8c7f3da61   4 months ago   293MB
</span><span class='line'>k8s.gcr.io/coredns/coredns           v1.8.6    a4ca41631cc7   5 months ago   46.8MB
</span><span class='line'>k8s.gcr.io/pause                     3.6       6270bb605e12   6 months ago   683kB
</span><span class='line'>[ec2-user@amazonlinux ~]$ 
</span></code></pre></td></tr></table></div></figure>


<p>中间出了个小插曲，一开始没有改主机名，导致加入节点的时刻用的是默认的，这样看起来不清晰，后面改了名称后就不认了。得重新弄一遍。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## 加入节点
</span><span class='line'>[ec2-user@amazonlinux ~]$ sudo su -
</span><span class='line'>[root@amazonlinux ~]# kubeadm join 192.168.191.131:6443 --token sj6fff.bpak7gkd3hnyzcm5 \
</span><span class='line'>         --discovery-token-ca-cert-hash sha256:8e15649afc0771e80cce7f1dfdbb0933f4fdbd45ea1f9e03be1f3b78449a6d3c 
</span><span class='line'>[preflight] Running pre-flight checks
</span><span class='line'>        [WARNING FileExisting-tc]: tc not found in system path
</span><span class='line'>        [WARNING Hostname]: hostname "amazonlinux.onprem" could not be reached
</span><span class='line'>        [WARNING Hostname]: hostname "amazonlinux.onprem": lookup amazonlinux.onprem on 192.168.191.2:53: no such host
</span><span class='line'>        [WARNING Service-Kubelet]: kubelet service is not enabled, please run 'systemctl enable kubelet.service'
</span><span class='line'>[preflight] Reading configuration from the cluster...
</span><span class='line'>[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
</span><span class='line'>[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
</span><span class='line'>[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
</span><span class='line'>[kubelet-start] Starting the kubelet
</span><span class='line'>[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...
</span><span class='line'>
</span><span class='line'>This node has joined the cluster:
</span><span class='line'>* Certificate signing request was sent to apiserver and a response was received.
</span><span class='line'>* The Kubelet was informed of the new secure connection details.
</span><span class='line'>
</span><span class='line'>Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
</span><span class='line'>
</span><span class='line'>[root@amazonlinux ~]# 
</span><span class='line'>
</span><span class='line'>## 改下主机名称：
</span><span class='line'>[root@amazonlinux ~]# hostnamectl --static set-hostname worker1
</span><span class='line'>[root@amazonlinux ~]# hostname worker1
</span><span class='line'>[root@amazonlinux ~]# exit
</span><span class='line'>
</span><span class='line'>## 改了一下名，重启后不行了，重新加入
</span><span class='line'>[ec2-user@worker1 ~]$ sudo su - 
</span><span class='line'>Last login: Thu Mar 17 15:24:32 CST 2022 on pts/0
</span><span class='line'>
</span><span class='line'>[root@worker1 ~]# kubeadm join 192.168.191.131:6443 --token sj6fff.bpak7gkd3hnyzcm5 \
</span><span class='line'>          --discovery-token-ca-cert-hash sha256:8e15649afc0771e80cce7f1dfdbb0933f4fdbd45ea1f9e03be1f3b78449a6d3c 
</span><span class='line'>[preflight] Running pre-flight checks
</span><span class='line'>        [WARNING FileExisting-tc]: tc not found in system path
</span><span class='line'>        [WARNING Hostname]: hostname "worker1" could not be reached
</span><span class='line'>        [WARNING Hostname]: hostname "worker1": lookup worker1 on 192.168.191.2:53: no such host
</span><span class='line'>        [WARNING Service-Kubelet]: kubelet service is not enabled, please run 'systemctl enable kubelet.service'
</span><span class='line'>error execution phase preflight: [preflight] Some fatal errors occurred:
</span><span class='line'>        [ERROR FileAvailable--etc-kubernetes-kubelet.conf]: /etc/kubernetes/kubelet.conf already exists
</span><span class='line'>        [ERROR Port-10250]: Port 10250 is in use
</span><span class='line'>        [ERROR FileAvailable--etc-kubernetes-pki-ca.crt]: /etc/kubernetes/pki/ca.crt already exists
</span><span class='line'>[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
</span><span class='line'>To see the stack trace of this error execute with --v=5 or higher
</span><span class='line'>
</span><span class='line'>## 直接重新加入不行，需要先重置再加入
</span><span class='line'>[root@worker1 ~]# kubeadm reset 
</span><span class='line'>[reset] WARNING: Changes made to this host by 'kubeadm init' or 'kubeadm join' will be reverted.
</span><span class='line'>[reset] Are you sure you want to proceed? [y/N]: y
</span><span class='line'>[preflight] Running pre-flight checks
</span><span class='line'>W0317 17:42:03.050519    6887 removeetcdmember.go:80] [reset] No kubeadm config, using etcd pod spec to get data directory
</span><span class='line'>[reset] No etcd config found. Assuming external etcd
</span><span class='line'>[reset] Please, manually reset etcd to prevent further issues
</span><span class='line'>[reset] Stopping the kubelet service
</span><span class='line'>[reset] Unmounting mounted directories in "/var/lib/kubelet"
</span><span class='line'>[reset] Deleting contents of config directories: [/etc/kubernetes/manifests /etc/kubernetes/pki]
</span><span class='line'>[reset] Deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf]
</span><span class='line'>[reset] Deleting contents of stateful directories: [/var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni]
</span><span class='line'>
</span><span class='line'>The reset process does not clean CNI configuration. To do so, you must remove /etc/cni/net.d
</span><span class='line'>
</span><span class='line'>The reset process does not reset or clean up iptables rules or IPVS tables.
</span><span class='line'>If you wish to reset iptables, you must do so manually by using the "iptables" command.
</span><span class='line'>
</span><span class='line'>If your cluster was setup to utilize IPVS, run ipvsadm --clear (or similar)
</span><span class='line'>to reset your system's IPVS tables.
</span><span class='line'>
</span><span class='line'>The reset process does not clean your kubeconfig files and you must remove them manually.
</span><span class='line'>Please, check the contents of the $HOME/.kube/config file.
</span><span class='line'>
</span><span class='line'>[root@worker1 ~]# kubeadm join 192.168.191.131:6443 --token sj6fff.bpak7gkd3hnyzcm5 \
</span><span class='line'>         --discovery-token-ca-cert-hash sha256:8e15649afc0771e80cce7f1dfdbb0933f4fdbd45ea1f9e03be1f3b78449a6d3c 
</span><span class='line'>[preflight] Running pre-flight checks
</span><span class='line'>        [WARNING FileExisting-tc]: tc not found in system path
</span><span class='line'>        [WARNING Hostname]: hostname "worker1" could not be reached
</span><span class='line'>        [WARNING Hostname]: hostname "worker1": lookup worker1 on 192.168.191.2:53: no such host
</span><span class='line'>        [WARNING Service-Kubelet]: kubelet service is not enabled, please run 'systemctl enable kubelet.service'
</span><span class='line'>[preflight] Reading configuration from the cluster...
</span><span class='line'>[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
</span><span class='line'>[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
</span><span class='line'>[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
</span><span class='line'>[kubelet-start] Starting the kubelet
</span><span class='line'>[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...
</span><span class='line'>
</span><span class='line'>This node has joined the cluster:
</span><span class='line'>* Certificate signing request was sent to apiserver and a response was received.
</span><span class='line'>* The Kubelet was informed of the new secure connection details.
</span><span class='line'>
</span><span class='line'>Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
</span></code></pre></td></tr></table></div></figure>


<p>加入节点后，查看状态：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get nodes 
</span><span class='line'>NAME      STATUS     ROLES                  AGE    VERSION
</span><span class='line'>k8s       Ready      control-plane,master   166m   v1.23.5
</span><span class='line'>worker1   NotReady   &lt;none&gt;                 30s    v1.23.5
</span></code></pre></td></tr></table></div></figure>


<h2>安装网络</h2>

<ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model">https://kubernetes.io/zh/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model</a></li>
<li><a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/addons/">https://kubernetes.io/zh/docs/concepts/cluster-administration/addons/</a></li>
<li><a href="https://github.com/flannel-io/flannel#deploying-flannel-manually">https://github.com/flannel-io/flannel#deploying-flannel-manually</a></li>
</ul>


<p>github上的资源好像也不能下载了，打开后复制内容到新建的文件中。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># For Kubernetes v1.17+ kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span><span class='line'>[ec2-user@k8s ~]$ vi kube-flannel.yml 
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f kube-flannel.yml
</span></code></pre></td></tr></table></div></figure>


<p>由于初始化 <code>kubeadm init</code> 时没有添加网络参数，导致这里flannel网络插件一直处于 CrashLoopBackOff 状态，查看日志提示没有分配 cidr 报错查日志</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/debug/k8s_crashloopbackoff.html
</span><span class='line'># 查看日志
</span><span class='line'>[ec2-user@k8s ~]$ kubectl describe -n kube-system pod kube-flannel-ds-sbx86 
</span><span class='line'>  Warning  BackOff    2m5s (x69 over 16m)  kubelet            Back-off restarting failed container
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl logs -n kube-system kube-flannel-ds-sbx86 
</span><span class='line'>E0317 09:19:27.915383       1 main.go:317] Error registering network: failed to acquire lease: node "k8s" pod cidr not assigned
</span><span class='line'>W0317 09:19:27.915664       1 reflector.go:436] github.com/flannel-io/flannel/subnet/kube/kube.go:379: watch of *v1.Node ended with: an error on the server ("unable to decode an event from the watch stream: context canceled") has prevented the request from succeeding
</span><span class='line'>
</span><span class='line'>可以再通过docker查看flannel日志
</span><span class='line'>[root@test4 profile]# docker ps -l
</span><span class='line'>[root@test4 profile]# docker logs f7be3ebe77fd 
</span><span class='line'>
</span><span class='line'>## https://www.talkwithtrend.com/Article/251751
</span><span class='line'># kube-controller-manager 没有给新加入的节点分配 IP 段，init 的时候没有指定 IP 段
</span><span class='line'># 加最后两行，和 kube-flannel.yml 中的 net-conf.json/Network 对应：
</span><span class='line'>[ec2-user@k8s ~]$ sudo vi /etc/kubernetes/manifests/kube-controller-manager.yaml 
</span><span class='line'>  - command:
</span><span class='line'>    - kube-controller-manager
</span><span class='line'>    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf
</span><span class='line'>    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf
</span><span class='line'>    - --bind-address=127.0.0.1
</span><span class='line'>    - --client-ca-file=/etc/kubernetes/pki/ca.crt
</span><span class='line'>    - --cluster-name=kubernetes
</span><span class='line'>    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
</span><span class='line'>    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
</span><span class='line'>    - --controllers=*,bootstrapsigner,tokencleaner
</span><span class='line'>    - --kubeconfig=/etc/kubernetes/controller-manager.conf
</span><span class='line'>    - --leader-elect=true
</span><span class='line'>    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
</span><span class='line'>    - --root-ca-file=/etc/kubernetes/pki/ca.crt
</span><span class='line'>    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
</span><span class='line'>    - --use-service-account-credentials=true
</span><span class='line'>    - --allocate-node-cidrs=true
</span><span class='line'>    - --cluster-cidr=10.244.0.0/16
</span><span class='line'>
</span><span class='line'># 重启服务
</span><span class='line'>## https://stackoverflow.com/questions/51375940/kubernetes-master-node-is-down-after-restarting-host-machine
</span><span class='line'>[ec2-user@k8s ~]$ sudo systemctl restart kubelet  
</span><span class='line'>
</span><span class='line'># 重新部署
</span><span class='line'># 然后删除flannel容器，重新部署
</span><span class='line'>[ec2-user@k8s ~]$ kubectl delete -f kube-flannel.yml 
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f kube-flannel.yml
</span></code></pre></td></tr></table></div></figure>


<p>注：还有可以临时编辑节点的配置 手动分配podCIDR。这里不做具体描述，参考： <a href="http://www.hyhblog.cn/2021/02/21/k8s-flannel-pod-cidr-not-assigned/">http://www.hyhblog.cn/2021/02/21/k8s-flannel-pod-cidr-not-assigned/</a> 。</p>

<p>再次查看pod状态，网络组件安装好后，dns组件也跑起来了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl get pods --all-namespaces -o wide 
</span><span class='line'>NAMESPACE     NAME                          READY   STATUS    RESTARTS   AGE     IP                NODE      NOMINATED NODE   READINESS GATES
</span><span class='line'>kube-system   coredns-64897985d-4d5rx       1/1     Running   0          2m30s   10.244.0.3        k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   coredns-64897985d-m9p9q       1/1     Running   0          2m30s   10.244.0.2        k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   etcd-k8s                      1/1     Running   0          166m    192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-apiserver-k8s            1/1     Running   0          166m    192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-controller-manager-k8s   1/1     Running   0          12m     192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-flannel-ds-q4qkt         1/1     Running   0          60s     192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-flannel-ds-ttcwt         1/1     Running   0          6m1s    192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-proxy-pd77m              1/1     Running   0          60s     192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-proxy-qj6lw              1/1     Running   0          166m    192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system   kube-scheduler-k8s            1/1     Running   0          166m    192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>安装dashboard</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## https://github.com/kubernetes/dashboard#kubernetes-dashboard
</span><span class='line'># kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f dashboard-v2.5.1.yml 
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -A -o wide
</span><span class='line'>NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE     IP                NODE      NOMINATED NODE   READINESS GATES
</span><span class='line'>kube-system            coredns-64897985d-4d5rx                      1/1     Running   0          36m     10.244.0.3        k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            coredns-64897985d-m9p9q                      1/1     Running   0          36m     10.244.0.2        k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            etcd-k8s                                     1/1     Running   0          3h20m   192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            kube-apiserver-k8s                           1/1     Running   0          3h19m   192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            kube-controller-manager-k8s                  1/1     Running   0          46m     192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            kube-flannel-ds-q4qkt                        1/1     Running   0          34m     192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            kube-flannel-ds-ttcwt                        1/1     Running   0          39m     192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            kube-proxy-pd77m                             1/1     Running   0          34m     192.168.191.132   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            kube-proxy-qj6lw                             1/1     Running   0          3h20m   192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kube-system            kube-scheduler-k8s                           1/1     Running   0          3h20m   192.168.191.131   k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kubernetes-dashboard   dashboard-metrics-scraper-799d786dbf-q87wv   1/1     Running   0          59s     10.244.2.3        worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>kubernetes-dashboard   kubernetes-dashboard-fb8648fd9-vprpt         1/1     Running   0          59s     10.244.2.2        worker1   &lt;none&gt;           &lt;none&gt;
</span></code></pre></td></tr></table></div></figure>


<p>安装还是很便捷和容易的，访问搞起来比较麻烦，由于是在虚拟机里面部署，kubectl命令也都在虚拟机操作，用 <code>kubectl proxy</code> 访问dashboard，如果不是localhost或者https的话不给访问的。</p>

<p>尝试了绑定网卡ip，但是由于不是https，还是不能访问dashboard：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl proxy --address='0.0.0.0' --accept-hosts='.*'
</span><span class='line'>Starting to serve on [::]:8001
</span></code></pre></td></tr></table></div></figure>


<p>访问dashboard方法一：kubectl proxy 加上 ssh的locally port forward，把本地的8001的请求转发到 远程服务器的localhost:8001。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## https://github.com/kubernetes/dashboard#access
</span><span class='line'>[ec2-user@k8s ~]$ kubectl proxy 
</span><span class='line'>Starting to serve on 127.0.0.1:8001
</span></code></pre></td></tr></table></div></figure>


<p>在SecureCRT的ssh会话的配置 Session Options 的 Connection - Port Forwarding 增加 Local Port Forwarding 的端口转发。在Local和Remote的Port输入框中都填入8001即可。</p>

<p>重新连接，这样我们访问 <code>http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/login</code> 就能访问到dashboard页面了。</p>

<p>方法二：后面直接通过查看dashboard服务的ip，通过 ssh的socks5代理 来访问 使用内部地址的dashboard。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl -n kubernetes-dashboard get service kubernetes-dashboard
</span><span class='line'>NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
</span><span class='line'>kubernetes-dashboard   ClusterIP   10.101.193.109   &lt;none&gt;        443/TCP   6h38m
</span><span class='line'>
</span><span class='line'>## 通过服务ip访问（Locally Port Forwarding - socks5方式代理）：
</span><span class='line'>https://10.101.193.109/#/login
</span><span class='line'>https://10.101.193.109/#/pod?namespace=kube-system
</span></code></pre></td></tr></table></div></figure>


<p>方法三：或者网上说的使用端口转发：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## https://kubernetes.io/zh/docs/tasks/access-application-cluster/port-forward-access-application-cluster/
</span><span class='line'>kubectl port-forward -n kubernetes-dashboard service/kubernetes-dashboard 8080:443 --address='0.0.0.0'
</span></code></pre></td></tr></table></div></figure>


<p>能访问了，接下来就是获取token进行登录。同样有两种方式，第一种暴力设置跳过登录，第二种方式从系统中获取/创建一个token来登录。</p>

<p>登录方法一：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## https://www.cnblogs.com/tylerzhou/p/11117956.html
</span><span class='line'># 在1.10.1里面默认不再显然skip按钮,其实dashboard安装有很多坑,如果有读者按照以上设置仍然不能正常成功登陆,但是仍然想要体验dashboard,可以开启默认关闭的skip按钮,这样就可以进入到dashboard管理界面了.
</span><span class='line'>      containers:
</span><span class='line'>      - args:
</span><span class='line'>        - --auto-generate-certificates
</span><span class='line'>        - --enable-skip-login            # &lt;-- add this line
</span><span class='line'>        image: k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1
</span></code></pre></td></tr></table></div></figure>


<p>改了配置后记得重新加载。</p>

<p>方法二：另一种方式是从系统获取token，然后填到界面上然后登录。访问dashboard：</p>

<ul>
<li><a href="https://stackoverflow.com/questions/46664104/how-to-sign-in-kubernetes-dashboard">https://stackoverflow.com/questions/46664104/how-to-sign-in-kubernetes-dashboard</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/guide/auth-with-kubeconfig-or-token.html">https://jimmysong.io/kubernetes-handbook/guide/auth-with-kubeconfig-or-token.html</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl -n kube-system get secret
</span><span class='line'># 这些secrets中的大部分都可以用来访问dashboard的,只有不同的账户权限不同,很多账户被限制不能进行操作.
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl -n kube-system describe secret deployment-controller-token
</span><span class='line'>
</span><span class='line'># 使用一条命令来显示token
</span><span class='line'>[ec2-user@k8s ~]$ kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | awk '/^deployment-controller-token-/{print $1}') | awk '$1=="token:"{print $2}'
</span><span class='line'>eyJhbGciOiJSUzI1NiIsImtpZCI6IjQzNllWOFFBYU5qaXdtUmdLelJQSDU5T2FVbGVpREJFZTlMQU12MXFhN1UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkZXBsb3ltZW50LWNvbnRyb2xsZXItdG9rZW4tejVwbWQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVwbG95bWVudC1jb250cm9sbGVyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNTcwNWJiMzYtMTMyNi00MGY5LWI3ZWUtNzE3ZTAyMTM1NzA2Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRlcGxveW1lbnQtY29udHJvbGxlciJ9.Av-RwOQGdEyZn56xmH_siz-7yU07OrhLhfiPqfJRaNJ5DL8wEDIZkxgNMzHrrthTsOJl7Tky3ABo5z3c_4xjgADGSqKqP0rvWtaLSHZFZR16c5S2c08aHdSH7KIAdoCy0muMiKHRw67QRf7zo5bPUyqfCyPY2vcB-pxqYnrTTAw71f34rgIPA-LACc5LIQwv8DT5O-KE1TopYF7lX5hXZIHOGP3sYpmbR7yIzO3MDNRUIfiZutYiQnHwXRQGBwHu1iUVk8Lu69gnqggkjp2cXa4d2ZUpCxrpeLGGdjPv6JPZEFLDhLbiBLF04b7IOdFQO4bH6BbXBNs9e0AGPbvp4Q
</span><span class='line'>[ec2-user@k8s ~]$ 
</span></code></pre></td></tr></table></div></figure>


<p>方法三：当然，也可以创建一个dashboard的拥有完整权限的token：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ kubectl create serviceaccount cluster-admin-dashboard-sa -n kube-system
</span><span class='line'>
</span><span class='line'>$ kubectl create clusterrolebinding cluster-admin-dashboard-sa \
</span><span class='line'>  --clusterrole=cluster-admin \
</span><span class='line'>  --serviceaccount=kube-system:cluster-admin-dashboard-sa -n kube-system
</span><span class='line'>
</span><span class='line'>And then, you can use the token of just created cluster admin service account.
</span><span class='line'>$ kubectl get secret | grep cluster-admin-dashboard-sa
</span><span class='line'>cluster-admin-dashboard-sa-token-6xm8l   kubernetes.io/service-account-token   3         18m
</span><span class='line'>$ kubectl describe secret cluster-admin-dashboard-sa-token-6xm8l
</span><span class='line'>
</span><span class='line'># Parse the token
</span><span class='line'>$ TOKEN=$(kubectl describe secret -n kube-system $(kubectl get secret -n kube-system | awk '/^cluster-admin-dashboard-sa-token-/{print $1}') | awk '$1=="token:"{print $2}')
</span><span class='line'>$ echo $TOKEN
</span><span class='line'>
</span><span class='line'>## -OR-
</span><span class='line'>[ec2-user@k8s ~]$ kubectl describe secret cluster-admin-dashboard-sa
</span><span class='line'>## -OR-
</span><span class='line'>[ec2-user@k8s ~]$ kubectl describe secret -n kube-system | grep deployment -A 12
</span></code></pre></td></tr></table></div></figure>


<p>如果使用token登录，一段事件没有操作就会有超时的困扰，可以修改token-ttl配置。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>##--&gt; Unauthorized (401): You have been logged out because your token has expired.
</span><span class='line'>
</span><span class='line'>## https://blog.csdn.net/otoyix/article/details/118758736
</span><span class='line'># 增加一行参数 token-ttl=68400
</span><span class='line'>  containers:
</span><span class='line'>    - name: kubernetes-dashboard
</span><span class='line'>      image: 'kubernetesui/dashboard:v2.0.0-rc5'
</span><span class='line'>      args:
</span><span class='line'>        - '--auto-generate-certificates'
</span><span class='line'>        - '--namespace=kubernetes-dashboard'
</span><span class='line'>        - '--token-ttl=68400'    -- 增加了此行
</span></code></pre></td></tr></table></div></figure>


<h2>安装metrics-server</h2>

<p>如果没有安装metrics-server，在dashboard中不能看到cpu/内存使用情况图形，kubectl top的命令也获取不到数据。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl top nodes
</span><span class='line'>error: Metrics API not available
</span><span class='line'>[ec2-user@k8s ~]$ kubectl top pods -A
</span><span class='line'>error: Metrics API not available
</span></code></pre></td></tr></table></div></figure>


<p>安装metrics-server会有镜像下载和证书的问题：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 每台主机都导入一下该镜像
</span><span class='line'>[ec2-user@k8s ~]$ docker load -i metrics-server-v0.6.1.tar.gz 
</span><span class='line'>3dc34f14eb83: Loading layer [==================================================&gt;]  66.43MB/66.43MB
</span><span class='line'>Loaded image: k8s.gcr.io/metrics-server/metrics-server:v0.6.1
</span><span class='line'>
</span><span class='line'># kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</span><span class='line'>[ec2-user@k8s ~]$ vi metrics-server.yml
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f metrics-server.yml 
</span></code></pre></td></tr></table></div></figure>


<p>还是启动不起来，由于metrics-server需要连服务端，证书不对，为了先跑起来，先忽略安全证书。在containers参数最后加上 <code>--kubelet-insecure-tls</code> ，然后删除后重新创建一次。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## [k8s metrics-server 轻量化监控](https://www.jianshu.com/p/5fe108d70310)
</span><span class='line'>## https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/#cannot-use-the-metrics-server-securely-in-a-kubeadm-cluster
</span><span class='line'>
</span><span class='line'>## 证书 https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#kubelet-serving-certs
</span><span class='line'>
</span><span class='line'>## https://github.com/kubernetes-sigs/metrics-server/blob/master/FAQ.md#how-to-run-metrics-server-securely
</span><span class='line'>## https://github.com/kubernetes-sigs/metrics-server/issues/196
</span><span class='line'>## https://cloud.tencent.com/developer/article/1819955
</span><span class='line'>    spec:
</span><span class='line'>      containers:
</span><span class='line'>      - args:
</span><span class='line'>        - --cert-dir=/tmp
</span><span class='line'>        - --secure-port=4443
</span><span class='line'>        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
</span><span class='line'>        - --kubelet-use-node-status-port
</span><span class='line'>        - --metric-resolution=15s
</span><span class='line'>        - --kubelet-insecure-tls
</span><span class='line'>        image: k8s.gcr.io/metrics-server/metrics-server:v0.6.1
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl delete -f metrics-server.yml 
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f metrics-server.yml 
</span></code></pre></td></tr></table></div></figure>


<p>等一小会，再次查看top命令。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl top nodes 
</span><span class='line'>NAME      CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
</span><span class='line'>k8s       91m          4%     913Mi           23%       
</span><span class='line'>worker1   38m          1%     431Mi           11%       
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>[ec2-user@k8s ~]$ kubectl top pods -n kube-system
</span><span class='line'>NAME                              CPU(cores)   MEMORY(bytes)   
</span><span class='line'>coredns-64897985d-4d5rx           1m           12Mi            
</span><span class='line'>coredns-64897985d-m9p9q           1m           12Mi            
</span><span class='line'>etcd-k8s                          11m          60Mi            
</span><span class='line'>kube-apiserver-k8s                32m          312Mi           
</span><span class='line'>kube-controller-manager-k8s       13m          46Mi            
</span><span class='line'>kube-flannel-ds-q4qkt             2m           11Mi            
</span><span class='line'>kube-flannel-ds-ttcwt             2m           11Mi            
</span><span class='line'>kube-proxy-pd77m                  7m           16Mi            
</span><span class='line'>kube-proxy-qj6lw                  2m           16Mi            
</span><span class='line'>kube-scheduler-k8s                3m           17Mi            
</span><span class='line'>metrics-server-7cf8b65d65-trtcj   33m          11Mi            
</span><span class='line'>[ec2-user@k8s ~]$ 
</span></code></pre></td></tr></table></div></figure>


<p>同时dashboard web界面就能看到cpu/内存的性能图形了。</p>

<h2>Hello world</h2>

<p>编写一个配置，然后运行一个实例，看看两台机器上的pod网络是否互通。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## docker run -it public.ecr.aws/amazonlinux/amazonlinux /bin/bash
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ cat replicaset.yml 
</span><span class='line'>apiVersion: apps/v1
</span><span class='line'>kind: ReplicaSet
</span><span class='line'>metadata:
</span><span class='line'>  name: hello-world
</span><span class='line'>spec:
</span><span class='line'>  replicas: 2
</span><span class='line'>  selector:
</span><span class='line'>    matchLabels:
</span><span class='line'>      app: hello-world
</span><span class='line'>  template:
</span><span class='line'>    metadata:
</span><span class='line'>      labels:
</span><span class='line'>        app: hello-world
</span><span class='line'>    spec:
</span><span class='line'>      containers:
</span><span class='line'>      - name: hello-world
</span><span class='line'>        image: amazonlinux:2
</span><span class='line'>        command: ["/bin/sh"]
</span><span class='line'>        args: ["-c", "while true; do echo hello; sleep 10;done"]
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f replicaset.yml  
</span><span class='line'>replicaset.apps/hello-world created
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl get pods -o wide
</span><span class='line'>NAME                READY   STATUS    RESTARTS   AGE   IP            NODE      NOMINATED NODE   READINESS GATES
</span><span class='line'>hello-world-d2tss   1/1     Running   0          8s    10.244.0.7    k8s       &lt;none&gt;           &lt;none&gt;
</span><span class='line'>hello-world-h9jxq   1/1     Running   0          8s    10.244.2.12   worker1   &lt;none&gt;           &lt;none&gt;
</span><span class='line'>[ec2-user@k8s ~]$ 
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl exec -ti hello-world-d2tss bash 
</span><span class='line'>kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
</span><span class='line'>bash-4.2# cat /etc/hosts 
</span><span class='line'>
</span><span class='line'>bash-4.2# yum install -y iputils net-tools 
</span><span class='line'>
</span><span class='line'>bash-4.2# ping hello-world-h9jxq           
</span><span class='line'>ping: hello-world-h9jxq: Name or service not known
</span><span class='line'>服务service才有域名。后面试一下服务的，来ping域名，测试下dns。
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>bash-4.2# ping 10.244.0.7 
</span><span class='line'>PING 10.244.0.7 (10.244.0.7) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.244.0.7: icmp_seq=1 ttl=255 time=0.012 ms
</span><span class='line'>64 bytes from 10.244.0.7: icmp_seq=2 ttl=255 time=0.021 ms
</span><span class='line'>^C
</span><span class='line'>--- 10.244.0.7 ping statistics ---
</span><span class='line'>2 packets transmitted, 2 received, 0% packet loss, time 1007ms
</span><span class='line'>rtt min/avg/max/mdev = 0.012/0.016/0.021/0.006 ms
</span><span class='line'>
</span><span class='line'>bash-4.2# ping 10.244.2.12
</span><span class='line'>PING 10.244.2.12 (10.244.2.12) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.244.2.12: icmp_seq=1 ttl=253 time=0.508 ms
</span><span class='line'>64 bytes from 10.244.2.12: icmp_seq=2 ttl=253 time=0.425 ms
</span><span class='line'>^C
</span><span class='line'>--- 10.244.2.12 ping statistics ---
</span><span class='line'>2 packets transmitted, 2 received, 0% packet loss, time 1027ms
</span><span class='line'>rtt min/avg/max/mdev = 0.425/0.466/0.508/0.046 ms
</span></code></pre></td></tr></table></div></figure>


<h2>Service domain</h2>

<p>配置启动容器和服务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ cat pg-db.yml 
</span><span class='line'>---
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: Pod
</span><span class='line'>metadata:
</span><span class='line'>  name: db-op-1 
</span><span class='line'>  labels:
</span><span class='line'>    name: postgres
</span><span class='line'>spec:
</span><span class='line'>  hostname: db-op-1
</span><span class='line'>  containers:
</span><span class='line'>  - name: postgres
</span><span class='line'>    image: postgis/postgis:9.6-2.5
</span><span class='line'>    imagePullPolicy: IfNotPresent
</span><span class='line'>---
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: Service
</span><span class='line'>metadata:
</span><span class='line'>  name: db-op-1
</span><span class='line'>spec:
</span><span class='line'>  ports:
</span><span class='line'>  - protocol: TCP
</span><span class='line'>    port: 5432
</span><span class='line'>  selector:
</span><span class='line'>    name: postgres
</span><span class='line'>
</span><span class='line'>[ec2-user@k8s ~]$ kubectl apply -f pg-db.yml 
</span></code></pre></td></tr></table></div></figure>


<p>在默认的namespace中再启动一个postgis的容器，用来测试访问域名：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ kubectl run busybox --image=postgis/postgis:9.6-2.5 -ti --restart=Never --rm  --command -- sh                
</span><span class='line'>If you don't see a command prompt, try pressing enter.
</span><span class='line'>
</span><span class='line'># apt update ; apt-get install net-tools iproute2 iputils-ping -y
</span><span class='line'>
</span><span class='line'># cat /etc/resolv.conf
</span><span class='line'>nameserver 10.96.0.10
</span><span class='line'>search default.svc.cluster.local svc.cluster.local cluster.local localdomain
</span><span class='line'>options ndots:5
</span><span class='line'>
</span><span class='line'># ping db-op-1
</span><span class='line'>PING db-op-1.default.svc.cluster.local (10.107.190.149) 56(84) bytes of data.
</span><span class='line'>
</span><span class='line'># psql -h db-op-1 -U postgres
</span><span class='line'>Password for user postgres: 
</span><span class='line'>psql (9.6.24)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>postgres=# \q
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/03/18/k8s-deps-download/">k8s-v1.23.5依赖下载</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-03-18T10:57:38+08:00" pubdate data-updated="true">Fri 2022-03-18 10:57</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>几年前安装使用过k8s(kubernetes)，明白安装过程最大的一个难关是容器镜像的下载，所以找回原来的文章，试着用原来的代理翻墙的方式，但是原来可行的 <code>ssh -D</code> socks5 的方式在 Amazon Linux 2 上面不好使，最后直接在外网主机上安装并缓冲RPM，然后下载打包 k8s.gcr.io 下的所有镜像。</p>

<p>尽管过程没有那么的严谨，但是每个步骤还是都得执行的。</p>

<h2>参考文章</h2>

<ul>
<li><p><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">安装 kubeadm</a></p></li>
<li><p><a href="https://docs.docker.com/engine/install/centos/">Install Docker Engine on CentOS</a></p></li>
<li><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/docker-basics.html">Docker basics for Amazon ECS</a></li>
<li><p><a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker">容器运行时 - Docker</a></p></li>
<li><p><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#%E5%AE%89%E8%A3%85-kubeadm-kubelet-%E5%92%8C-kubectl">安装 kubeadm、kubelet 和 kubectl</a></p></li>
<li><p><a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/#%E5%9C%A8%E6%B2%A1%E6%9C%89%E4%BA%92%E8%81%94%E7%BD%91%E8%BF%9E%E6%8E%A5%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E8%BF%90%E8%A1%8C-kubeadm">在没有互联网连接的情况下运行 kubeadm</a></p></li>
<li><p><a href="https://www.jianshu.com/p/5fe108d70310">k8s metrics-server 轻量化监控</a></p></li>
</ul>


<h2>安装Docker</h2>

<p>k8s的pod需要容器运行时（Container Runtime），这里直接选择熟悉的docker。外网的主机是centos7的，按照docker官网步骤安装。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## https://docs.docker.com/engine/install/centos/
</span><span class='line'>$ sudo yum remove docker \
</span><span class='line'>                   docker-client \
</span><span class='line'>                   docker-client-latest \
</span><span class='line'>                   docker-common \
</span><span class='line'>                   docker-latest \
</span><span class='line'>                   docker-latest-logrotate \
</span><span class='line'>                   docker-logrotate \
</span><span class='line'>                   docker-engine
</span><span class='line'>
</span><span class='line'>$ sudo yum install -y yum-utils
</span><span class='line'>$ sudo yum-config-manager \
</span><span class='line'>     --add-repo \
</span><span class='line'>     https://download.docker.com/linux/centos/docker-ce.repo
</span><span class='line'>
</span><span class='line'>$ yum list docker-ce --showduplicates | sort -r
</span><span class='line'>
</span><span class='line'>$ sudo yum clean all
</span><span class='line'>$ sudo yum install docker-ce docker-ce-cli containerd.io
</span><span class='line'>
</span><span class='line'>$ sudo service docker start
</span><span class='line'>$ sudo systemctl enable docker
</span><span class='line'># docker info
</span><span class='line'>
</span><span class='line'>## https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker
</span><span class='line'>$ cat &lt;&lt;EOF | sudo tee /etc/docker/daemon.json
</span><span class='line'>{
</span><span class='line'>  "exec-opts": ["native.cgroupdriver=systemd"],
</span><span class='line'>  "log-driver": "json-file",
</span><span class='line'>  "log-opts": {
</span><span class='line'>    "max-size": "100m"
</span><span class='line'>  },
</span><span class='line'>  "storage-driver": "overlay2"
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>$ sudo systemctl enable docker
</span><span class='line'>$ sudo systemctl daemon-reload
</span><span class='line'>$ sudo systemctl restart docker
</span></code></pre></td></tr></table></div></figure>


<h2>安装 kubeadm、kubelet 和 kubectl</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## 设置缓冲
</span><span class='line'># vi /etc/yum.conf 
</span><span class='line'>keepcache=1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>## https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#%E5%AE%89%E8%A3%85-kubeadm-kubelet-%E5%92%8C-kubectl
</span><span class='line'>## 在官网基础上，禁用gpgcheck
</span><span class='line'># cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span><span class='line'>[kubernetes]
</span><span class='line'>name=Kubernetes
</span><span class='line'>baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span><span class='line'>enabled=1
</span><span class='line'>gpgcheck=0
</span><span class='line'>repo_gpgcheck=0
</span><span class='line'>gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span><span class='line'>exclude=kubelet kubeadm kubectl
</span><span class='line'>EOF
</span><span class='line'>
</span><span class='line'>## 将 SELinux 设置为 permissive 模式（相当于将其禁用）
</span><span class='line'># sudo setenforce 0
</span><span class='line'># sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
</span><span class='line'>
</span><span class='line'># sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
</span><span class='line'>
</span><span class='line'>## 无需启动 sudo systemctl enable --now kubelet
</span></code></pre></td></tr></table></div></figure>


<p>把缓冲的rpm下载到本地</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ea5df05219bb /]# cd /var/cache/yum/
</span><span class='line'>[root@ea5df05219bb yum]# ll -R 
</span><span class='line'>
</span><span class='line'>[root@ea5df05219bb yum]# yum install lrzsz 
</span><span class='line'>
</span><span class='line'>[root@ea5df05219bb yum]# sz x86_64/7/kubernetes/packages/*
</span></code></pre></td></tr></table></div></figure>


<h2>在没有互联网连接的情况下运行kubeadm</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/#%E5%9C%A8%E6%B2%A1%E6%9C%89%E4%BA%92%E8%81%94%E7%BD%91%E8%BF%9E%E6%8E%A5%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E8%BF%90%E8%A1%8C-kubeadm
</span><span class='line'>
</span><span class='line'># kubeadm config images list
</span><span class='line'>k8s.gcr.io/kube-apiserver:v1.23.5
</span><span class='line'>k8s.gcr.io/kube-controller-manager:v1.23.5
</span><span class='line'>k8s.gcr.io/kube-scheduler:v1.23.5
</span><span class='line'>k8s.gcr.io/kube-proxy:v1.23.5
</span><span class='line'>k8s.gcr.io/pause:3.6
</span><span class='line'>k8s.gcr.io/etcd:3.5.1-0
</span><span class='line'>k8s.gcr.io/coredns/coredns:v1.8.6
</span><span class='line'>
</span><span class='line'># kubeadm config images pull
</span><span class='line'>[config/images] Pulled k8s.gcr.io/kube-apiserver:v1.23.5
</span><span class='line'>[config/images] Pulled k8s.gcr.io/kube-controller-manager:v1.23.5
</span><span class='line'>[config/images] Pulled k8s.gcr.io/kube-scheduler:v1.23.5
</span><span class='line'>[config/images] Pulled k8s.gcr.io/kube-proxy:v1.23.5
</span><span class='line'>[config/images] Pulled k8s.gcr.io/pause:3.6
</span><span class='line'>[config/images] Pulled k8s.gcr.io/etcd:3.5.1-0
</span><span class='line'>[config/images] Pulled k8s.gcr.io/coredns/coredns:v1.8.6
</span><span class='line'>
</span><span class='line'># docker images
</span><span class='line'>REPOSITORY                           TAG       IMAGE ID       CREATED         SIZE
</span><span class='line'>k8s.gcr.io/kube-apiserver            v1.23.5   3fc1d62d6587   14 hours ago    135MB
</span><span class='line'>k8s.gcr.io/kube-proxy                v1.23.5   3c53fa8541f9   14 hours ago    112MB
</span><span class='line'>k8s.gcr.io/kube-controller-manager   v1.23.5   b0c9e5e4dbb1   14 hours ago    125MB
</span><span class='line'>k8s.gcr.io/kube-scheduler            v1.23.5   884d49d6d8c9   14 hours ago    53.5MB
</span><span class='line'>k8s.gcr.io/etcd                      3.5.1-0   25f8c7f3da61   4 months ago    293MB
</span><span class='line'>k8s.gcr.io/coredns/coredns           v1.8.6    a4ca41631cc7   5 months ago    46.8MB
</span><span class='line'>k8s.gcr.io/pause                     3.6       6270bb605e12   6 months ago    683kB
</span><span class='line'>centos                               7         8652b9f0cb4c   16 months ago   204MB
</span><span class='line'>
</span><span class='line'># docker images | awk '{print $1}' | grep k8s | xargs echo 
</span><span class='line'>k8s.gcr.io/kube-apiserver k8s.gcr.io/kube-proxy k8s.gcr.io/kube-controller-manager k8s.gcr.io/kube-scheduler k8s.gcr.io/etcd k8s.gcr.io/coredns/coredns k8s.gcr.io/pause
</span><span class='line'>
</span><span class='line'># docker save -o k8s-v1.23.5.tar k8s.gcr.io/kube-apiserver k8s.gcr.io/kube-proxy k8s.gcr.io/kube-controller-manager k8s.gcr.io/kube-scheduler k8s.gcr.io/etcd k8s.gcr.io/coredns/coredns k8s.gcr.io/pause
</span><span class='line'># gzip k8s-v1.23.5.tar
</span></code></pre></td></tr></table></div></figure>


<p>把导出的images下载回来后，加载到本地主机</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ docker load -i k8s-v1.23.5.tar.gz 
</span></code></pre></td></tr></table></div></figure>


<h2>metrics-server</h2>

<p>metrics server的镜像也是在google的服务上的，也下载保存下来。在dashboard上可以通过它查看node/pod的cpu/内存占用图形情况。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># docker pull k8s.gcr.io/metrics-server/metrics-server:v0.6.1
</span><span class='line'>
</span><span class='line'># docker save -o metrics-server-v0.6.1.tar k8s.gcr.io/metrics-server/metrics-server:v0.6.1
</span><span class='line'># gzip metrics-server-v0.6.1.tar 
</span></code></pre></td></tr></table></div></figure>


<p>下载回来后，加载到本地主机</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ docker load -i metrics-server-v0.6.1.tar.gz 
</span></code></pre></td></tr></table></div></figure>


<p>基本安装好后，本地镜像如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ec2-user@k8s ~]$ docker images 
</span><span class='line'>REPOSITORY                                       TAG       IMAGE ID       CREATED        SIZE
</span><span class='line'>k8s.gcr.io/kube-apiserver                        v1.23.5   3fc1d62d6587   39 hours ago   135MB
</span><span class='line'>k8s.gcr.io/kube-proxy                            v1.23.5   3c53fa8541f9   39 hours ago   112MB
</span><span class='line'>k8s.gcr.io/kube-scheduler                        v1.23.5   884d49d6d8c9   39 hours ago   53.5MB
</span><span class='line'>k8s.gcr.io/kube-controller-manager               v1.23.5   b0c9e5e4dbb1   39 hours ago   125MB
</span><span class='line'>rancher/mirrored-flannelcni-flannel              v0.17.0   9247abf08677   2 weeks ago    59.8MB
</span><span class='line'>k8s.gcr.io/metrics-server/metrics-server         v0.6.1    e57a417f15d3   5 weeks ago    68.8MB
</span><span class='line'>rancher/mirrored-flannelcni-flannel-cni-plugin   v1.0.1    ac40ce625740   8 weeks ago    8.1MB
</span><span class='line'>k8s.gcr.io/etcd                                  3.5.1-0   25f8c7f3da61   4 months ago   293MB
</span><span class='line'>k8s.gcr.io/coredns/coredns                       v1.8.6    a4ca41631cc7   5 months ago   46.8MB
</span><span class='line'>k8s.gcr.io/pause                                 3.6       6270bb605e12   6 months ago   683kB
</span><span class='line'>
</span><span class='line'>[ec2-user@worker1 ~]$ docker images 
</span><span class='line'>REPOSITORY                                       TAG       IMAGE ID       CREATED        SIZE
</span><span class='line'>k8s.gcr.io/kube-apiserver                        v1.23.5   3fc1d62d6587   39 hours ago   135MB
</span><span class='line'>k8s.gcr.io/kube-proxy                            v1.23.5   3c53fa8541f9   39 hours ago   112MB
</span><span class='line'>k8s.gcr.io/kube-controller-manager               v1.23.5   b0c9e5e4dbb1   39 hours ago   125MB
</span><span class='line'>k8s.gcr.io/kube-scheduler                        v1.23.5   884d49d6d8c9   39 hours ago   53.5MB
</span><span class='line'>kubernetesui/dashboard                           v2.5.1    7fff914c4a61   7 days ago     243MB
</span><span class='line'>rancher/mirrored-flannelcni-flannel              v0.17.0   9247abf08677   2 weeks ago    59.8MB
</span><span class='line'>k8s.gcr.io/metrics-server/metrics-server         v0.6.1    e57a417f15d3   5 weeks ago    68.8MB
</span><span class='line'>rancher/mirrored-flannelcni-flannel-cni-plugin   v1.0.1    ac40ce625740   8 weeks ago    8.1MB
</span><span class='line'>k8s.gcr.io/etcd                                  3.5.1-0   25f8c7f3da61   4 months ago   293MB
</span><span class='line'>k8s.gcr.io/coredns/coredns                       v1.8.6    a4ca41631cc7   5 months ago   46.8MB
</span><span class='line'>k8s.gcr.io/pause                                 3.6       6270bb605e12   6 months ago   683kB
</span><span class='line'>kubernetesui/metrics-scraper                     v1.0.7    7801cfc6d5c0   9 months ago   34.4MB
</span></code></pre></td></tr></table></div></figure>


<h2>小结</h2>

<p>本文就要在外网模拟了一下安装，把需要翻墙的两个组件（rpm，docker image）缓冲下来，然后在本地机器上直接使用。</p>

<p>下载的 最新版本v1.23.5 的（需翻墙的）依赖可以在百度网盘下载：</p>

<pre><code>链接：https://pan.baidu.com/s/1P3ABqKGt1JhNkg-9yB22yQ 
提取码：k7af
</code></pre>

<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/01/13/openeuler20-dot-03lts-sp3-install-docker/">欧拉20.03LTS_SP3安装docker</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-01-13T11:46:25+08:00" pubdate data-updated="true">Thu 2022-01-13 11:46</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>随着时间车轮往前滚滚，Centos-7正逐渐的走下神坛，国内开源操作系统蓬勃发展，跟上时代的步伐，先把docker在欧拉上安装起来。</p>

<p>使用欧拉自带库非常容易安装，但是相对版本比较旧：18.09。还有就是，使用docker官网最新版，可以使用centos-8版本的库来进行安装。</p>

<p>这里两种方式都试了一下，关键步骤罗列如下：</p>

<h2>欧拉自带</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# cat /etc/yum.repos.d/openEuler.repo   
</span><span class='line'>[root@localhost ~]# yum search docker 
</span><span class='line'>[root@localhost ~]# yum list | grep docker 
</span><span class='line'>docker-engine.x86_64                                    18.09.0-206.oe1                           OS        
</span><span class='line'>
</span><span class='line'># 默认已经disabled
</span><span class='line'>[root@localhost ~]# getenforce 
</span><span class='line'>Disabled
</span><span class='line'>[root@localhost ~]# cat /etc/sysconfig/selinux
</span><span class='line'>
</span><span class='line'># 安装
</span><span class='line'>[root@localhost ~]# yum install docker
</span><span class='line'>Last metadata expiration check: 1:22:48 ago on Thu 13 Jan 2022 10:19:38 AM CST.
</span><span class='line'>Dependencies resolved.
</span><span class='line'>================================================================================================================================================================
</span><span class='line'> Package                                   Architecture                       Version                                      Repository                      Size
</span><span class='line'>================================================================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> docker-engine                             x86_64                             18.09.0-206.oe1                              OS                              45 M
</span><span class='line'>Installing dependencies:
</span><span class='line'> libcgroup                                 x86_64                             0.42.2-1.oe1                                 OS                              96 k
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>================================================================================================================================================================
</span><span class='line'>Install  2 Packages
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# docker version 
</span><span class='line'>Client:
</span><span class='line'> Version:           18.09.0
</span><span class='line'> EulerVersion:      18.09.0.206
</span><span class='line'> API version:       1.39
</span><span class='line'> Go version:        go1.15.7
</span><span class='line'> Git commit:        e4c0fb8
</span><span class='line'> Built:             Fri Dec 31 21:47:09 2021
</span><span class='line'> OS/Arch:           linux/amd64
</span><span class='line'> Experimental:      false
</span><span class='line'>
</span><span class='line'>Server:
</span><span class='line'> Engine:
</span><span class='line'>  Version:          18.09.0
</span><span class='line'>  EulerVersion:     18.09.0.206
</span><span class='line'>  API version:      1.39 (minimum version 1.12)
</span><span class='line'>  Go version:       go1.15.7
</span><span class='line'>  Git commit:       e4c0fb8
</span><span class='line'>  Built:            Fri Dec 31 21:46:37 2021
</span><span class='line'>  OS/Arch:          linux/amd64
</span><span class='line'>  Experimental:     false
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# docker ps -a 
</span><span class='line'>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</span></code></pre></td></tr></table></div></figure>


<h2>安装最新版</h2>

<ul>
<li><a href="https://docs.docker.com/engine/install/centos/">https://docs.docker.com/engine/install/centos/</a></li>
<li><a href="https://blog.csdn.net/Jairoguo/article/details/118403323">https://blog.csdn.net/Jairoguo/article/details/118403323</a></li>
</ul>


<h3>安装包repo的国内源</h3>

<ul>
<li>aliyun源：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dnf config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></code></pre></td></tr></table></div></figure>


<ul>
<li>huawei源：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo yum-config-manager \
</span><span class='line'>    --add-repo \
</span><span class='line'>    https://repo.huaweicloud.com/docker-ce/linux/centos/docker-ce.repo
</span><span class='line'>sudo sed -i 's+download.docker.com+repo.huaweicloud.com/docker-ce+' /etc/yum.repos.d/docker-ce.repo</span></code></pre></td></tr></table></div></figure>


<h3>问题1：$releasever</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# yum search docker 
</span><span class='line'>Docker CE Stable - x86_64                                                                                                       240  B/s | 394  B     00:01    
</span><span class='line'>Errors during downloading metadata for repository 'docker-ce-stable':
</span><span class='line'>  - Status code: 404 for https://download.docker.com/linux/centos/20.03LTS_SP3/x86_64/stable/repodata/repomd.xml (IP: 13.224.160.26)
</span><span class='line'>Error: Failed to download metadata for repo 'docker-ce-stable': Cannot download repomd.xml: Cannot download repodata/repomd.xml: All mirrors were tried
</span></code></pre></td></tr></table></div></figure>


<p>解决：</p>

<p>跟centos的对不上，直接用centos-8的版本，把 <code>$releasever</code> 改成 <code>8</code> :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# cat /etc/os-release 
</span><span class='line'>NAME="openEuler"
</span><span class='line'>VERSION="20.03 (LTS-SP3)"
</span><span class='line'>ID="openEuler"
</span><span class='line'>VERSION_ID="20.03"
</span><span class='line'>PRETTY_NAME="openEuler 20.03 (LTS-SP3)"
</span><span class='line'>ANSI_COLOR="0;31"
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# arch
</span><span class='line'>x86_64
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># 修改release-version版本为8：
</span><span class='line'>vi /etc/yum.repos.d/docker-ce.repo 
</span><span class='line'>:%s/$releasever/8/g
</span></code></pre></td></tr></table></div></figure>


<h3>问题2：Base依赖</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  - cannot install the best candidate for the job
</span><span class='line'>  - nothing provides fuse-overlayfs &gt;= 0.7 needed by docker-ce-rootless-extras-20.10.0-3.el8.x86_64
</span><span class='line'>  - nothing provides slirp4netns &gt;= 0.4 needed by docker-ce-rootless-extras-20.10.0-3.el8.x86_64</span></code></pre></td></tr></table></div></figure>


<p>解决：</p>

<p>添加centos-base库，同样替换成centos-8的版本。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget -O /etc/yum.repos.d/CentOS-Base.repo https://repo.huaweicloud.com/repository/conf/CentOS-8-reg.repo
</span><span class='line'>[root@localhost ~]# vi /etc/yum.repos.d/CentOS-Base.repo 
</span><span class='line'>:%s/$releasever/8/g
</span></code></pre></td></tr></table></div></figure>


<h3>正式安装</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# yum install docker-ce docker-ce-cli containerd.io
</span><span class='line'>CentOS-8 - Base - repo.huaweicloud.com                                                                                          583 kB/s | 4.6 MB     00:08    
</span><span class='line'>CentOS-8 - AppStream - repo.huaweicloud.com                                                                                     565 kB/s | 8.4 MB     00:15    
</span><span class='line'>CentOS-8 - PowerTools - repo.huaweicloud.com                                                                                    626 kB/s | 2.3 MB     00:03    
</span><span class='line'>CentOS-8 - Extras - repo.huaweicloud.com                                                                                         43 kB/s |  10 kB     00:00    
</span><span class='line'>Dependencies resolved.
</span><span class='line'>================================================================================================================================================================
</span><span class='line'> Package                                  Architecture          Version                                                   Repository                       Size
</span><span class='line'>================================================================================================================================================================
</span><span class='line'>Installing:
</span><span class='line'> containerd.io                            x86_64                1.4.12-3.1.el8                                            docker-ce-stable                 28 M
</span><span class='line'> docker-ce                                x86_64                3:20.10.12-3.el8                                          docker-ce-stable                 22 M
</span><span class='line'> docker-ce-cli                            x86_64                1:20.10.12-3.el8                                          docker-ce-stable                 30 M
</span><span class='line'>Upgrading:
</span><span class='line'> selinux-policy                           noarch                3.14.3-80.el8_5.2                                         BaseOS                          636 k
</span><span class='line'> selinux-policy-targeted                  noarch                3.14.3-80.el8_5.2                                         BaseOS                           15 M
</span><span class='line'>Installing dependencies:
</span><span class='line'> container-selinux                        noarch                2:2.167.0-1.module_el8.5.0+911+f19012f9                   AppStream                        54 k
</span><span class='line'> docker-ce-rootless-extras                x86_64                20.10.12-3.el8                                            docker-ce-stable                4.6 M
</span><span class='line'> docker-scan-plugin                       x86_64                0.12.0-3.el8                                              docker-ce-stable                3.7 M
</span><span class='line'> fuse-overlayfs                           x86_64                1.7.1-1.module_el8.5.0+890+6b136101                       AppStream                        73 k
</span><span class='line'> fuse3                                    x86_64                3.9.2-8.oe1                                               OS                              112 k
</span><span class='line'> libcgroup                                x86_64                0.42.2-1.oe1                                              OS                               96 k
</span><span class='line'> libslirp                                 x86_64                4.4.0-1.module_el8.5.0+890+6b136101                       AppStream                        70 k
</span><span class='line'> slirp4netns                              x86_64                1.1.8-1.module_el8.5.0+890+6b136101                       AppStream                        51 k
</span><span class='line'>Installing weak dependencies:
</span><span class='line'> fuse3-help                               x86_64                3.9.2-8.oe1                                               OS                               14 k
</span><span class='line'>Enabling module streams:
</span><span class='line'> container-tools                                                rhel8                                                                                          
</span><span class='line'>
</span><span class='line'>Transaction Summary
</span><span class='line'>================================================================================================================================================================
</span><span class='line'>Install  12 Packages
</span><span class='line'>Upgrade   2 Packages
</span><span class='line'>
</span><span class='line'>Total download size: 105 M
</span></code></pre></td></tr></table></div></figure>


<h3>使用</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# docker version
</span><span class='line'>Client: Docker Engine - Community
</span><span class='line'> Version:           20.10.12
</span><span class='line'> API version:       1.41
</span><span class='line'> Go version:        go1.16.12
</span><span class='line'> Git commit:        e91ed57
</span><span class='line'> Built:             Mon Dec 13 11:45:22 2021
</span><span class='line'> OS/Arch:           linux/amd64
</span><span class='line'> Context:           default
</span><span class='line'> Experimental:      true
</span><span class='line'>
</span><span class='line'>Server: Docker Engine - Community
</span><span class='line'> Engine:
</span><span class='line'>  Version:          20.10.12
</span><span class='line'>  API version:      1.41 (minimum version 1.12)
</span><span class='line'>  Go version:       go1.16.12
</span><span class='line'>  Git commit:       459d0df
</span><span class='line'>  Built:            Mon Dec 13 11:43:44 2021
</span><span class='line'>  OS/Arch:          linux/amd64
</span><span class='line'>  Experimental:     false
</span><span class='line'> containerd:
</span><span class='line'>  Version:          1.4.12
</span><span class='line'>  GitCommit:        7b11cfaabd73bb80907dd23182b9347b4245eb5d
</span><span class='line'> runc:
</span><span class='line'>  Version:          1.0.2
</span><span class='line'>  GitCommit:        v1.0.2-0-g52b36a2
</span><span class='line'> docker-init:
</span><span class='line'>  Version:          0.19.0
</span><span class='line'>  GitCommit:        de40ad0
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# docker ps -a 
</span><span class='line'>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# docker pull centos:7
</span><span class='line'>7: Pulling from library/centos
</span><span class='line'>2d473b07cdd5: Pull complete 
</span><span class='line'>Digest: sha256:9d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426a630e0987
</span><span class='line'>Status: Downloaded newer image for centos:7
</span><span class='line'>docker.io/library/centos:7
</span><span class='line'>[root@localhost ~]# 
</span><span class='line'>[root@localhost ~]# docker images 
</span><span class='line'>REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
</span><span class='line'>centos       7         eeb6ee3f44bd   3 months ago   204MB
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# docker run --rm centos:7 hostname 
</span><span class='line'>3c7a047ec95e
</span><span class='line'>[root@localhost ~]# docker run --rm centos:7 date 
</span><span class='line'>Thu Jan 13 03:33:12 UTC 2022
</span></code></pre></td></tr></table></div></figure>


<h2>docker镜像加速</h2>

<ul>
<li><a href="https://www.runoob.com/docker/docker-mirror-acceleration.html">https://www.runoob.com/docker/docker-mirror-acceleration.html</a></li>
<li><a href="https://mirrors.ustc.edu.cn/help/dockerhub.html">https://mirrors.ustc.edu.cn/help/dockerhub.html</a></li>
</ul>


<p>添加镜像配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># https://docker.mirrors.ustc.edu.cn/
</span><span class='line'># https://hub-mirror.c.163.com
</span><span class='line'># https://reg-mirror.qiniu.com
</span><span class='line'>[root@localhost ~]# cat /etc/docker/daemon.json
</span><span class='line'>{
</span><span class='line'>"registry-mirrors":["https://reg-mirror.qiniu.com/"]
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>[root@localhost ~]# service docker restart 
</span><span class='line'>Redirecting to /bin/systemctl restart docker.service
</span><span class='line'>[root@localhost ~]# docker info 
</span><span class='line'>Registry Mirrors:
</span><span class='line'> https://reg-mirror.qiniu.com/
</span></code></pre></td></tr></table></div></figure>


<p>运行一个hello-world看看速度：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# docker run hello-world 
</span><span class='line'>Unable to find image 'hello-world:latest' locally
</span><span class='line'>latest: Pulling from library/hello-world
</span><span class='line'>2db29710123e: Pull complete 
</span><span class='line'>Digest: sha256:975f4b14f326b05db86e16de00144f9c12257553bba9484fed41f9b6f2257800
</span><span class='line'>Status: Downloaded newer image for hello-world:latest
</span><span class='line'>
</span><span class='line'>Hello from Docker!
</span><span class='line'>This message shows that your installation appears to be working correctly.
</span><span class='line'>
</span><span class='line'>To generate this message, Docker took the following steps:
</span><span class='line'> 1. The Docker client contacted the Docker daemon.
</span><span class='line'> 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
</span><span class='line'>    (amd64)
</span><span class='line'> 3. The Docker daemon created a new container from that image which runs the
</span><span class='line'>    executable that produces the output you are currently reading.
</span><span class='line'> 4. The Docker daemon streamed that output to the Docker client, which sent it
</span><span class='line'>    to your terminal.
</span><span class='line'>
</span><span class='line'>To try something more ambitious, you can run an Ubuntu container with:
</span><span class='line'> $ docker run -it ubuntu bash
</span><span class='line'>
</span><span class='line'>Share images, automate workflows, and more with a free Docker ID:
</span><span class='line'> https://hub.docker.com/
</span><span class='line'>
</span><span class='line'>For more examples and ideas, visit:
</span><span class='line'> https://docs.docker.com/get-started/
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/12/08/octopress-generate-toc/">octopress生成TOC</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2021-12-08T18:23:23+08:00" pubdate data-updated="true">Wed 2021-12-08 18:23</time>
		
        
		
      </p>
    
  </header>


  <div class="entry-content"><p>尝试了jekyll直接生成toc的方式都失败了，最终通过jquery运行时生成的方式实现目录导航。</p>

<h2>参考</h2>

<ul>
<li><a href="http://brizzled.clapper.org/blog/2012/02/04/generating-a-table-of-contents-in-octopress/">Generating a Table of Contents in Octopress</a></li>
</ul>


<h2>步骤实现</h2>

<h3>添加jquery.toc.min.js</h3>

<p>1、下载 <a href="https://ndabas.github.io/toc/">https://ndabas.github.io/toc/</a> 当前是 0.4.0 版本。解压把 jquery.toc.min.js 放到 source/javascripts/libs/ 目录下。</p>

<p>2、在 source/_includes/head.html 文件的 jquery.min.js 下一行引入 jquery.toc.min.js ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>  &lt;script&gt;!window.jQuery && document.write(unescape('%3Cscript src="{{ root_url }}/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))&lt;/script&gt;
</span><span class='line'>  &lt;script src="{{ root_url }}/javascripts/libs/jquery.toc.min.js" type="text/javascript"&gt;&lt;/script&gt;
</span><span class='line'></span></code></pre></td></tr></table></div></figure>


<h3>使用toc创建目录导航</h3>

<p>3、在 source/javascripts 目录下创建 generate-toc.js ，内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function generateTOC(insertBefore, heading) {
</span><span class='line'>  var container = jQuery("&lt;div id='tocBlock'&gt;&lt;/div&gt;");
</span><span class='line'>  var div = jQuery("&lt;ul id='toc'&gt;&lt;/ul&gt;");
</span><span class='line'>  
</span><span class='line'>  var content = $(insertBefore).first();
</span><span class='line'>
</span><span class='line'>  if (heading != undefined && heading != null) {
</span><span class='line'>    container.append('&lt;span class="tocHeading"&gt;' + heading + '&lt;/span&gt;');
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>// div.tableOfContents(content);
</span><span class='line'>  div.toc({content: content, headings: "h2,h3,h4"});
</span><span class='line'>  container.append(div);
</span><span class='line'>  container.insertBefore(insertBefore);
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>并在 source/_includes/custom/head.html 引入该文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>&lt;script src="{{ root_url }}/javascripts/generate-toc.js" type="text/javascript"&gt;&lt;/script&gt;
</span><span class='line'></span></code></pre></td></tr></table></div></figure>


<p>4、运行时调用toc创建目录，在 source/_includes/custom/after_footer.html 添加如下内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>{% if index %}
</span><span class='line'>  {% comment %}
</span><span class='line'>  No table of contents on the index page.
</span><span class='line'>  {% endcomment %}
</span><span class='line'>
</span><span class='line'>{% elsif page.toc == true %}
</span><span class='line'>  &lt;script type="text/javascript"&gt;
</span><span class='line'>  jQuery(document).ready(function() {
</span><span class='line'>    // Put a TOC right before the entry content.
</span><span class='line'>    generateTOC('.entry-content', '目录');
</span><span class='line'>  });
</span><span class='line'>  &lt;/script&gt;
</span><span class='line'>{% endif %}
</span><span class='line'></span></code></pre></td></tr></table></div></figure>


<h3>CSS样式</h3>

<p>5、添加样式，在 sass/custom 目录下添加 _screen.scss 文件，内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$toc-bg: #dfdfdf;
</span><span class='line'>
</span><span class='line'>$toc-incr: 5px;
</span><span class='line'>
</span><span class='line'>div#tocBlock {
</span><span class='line'>border-radius: 10px;
</span><span class='line'>padding: 10px;
</span><span class='line'>box-shadow: 5px 5px 5px #999;
</span><span class='line'>
</span><span class='line'>    float: right;
</span><span class='line'>    font-size: 10pt;
</span><span class='line'>    width: 300px;
</span><span class='line'>    padding-left: 20px;
</span><span class='line'>    padding-right: 10px;
</span><span class='line'>    padding-top: 10px;
</span><span class='line'>    padding-bottom: 0px;
</span><span class='line'>
</span><span class='line'>    background: $toc-bg;
</span><span class='line'>    border: solid 1px #999999;
</span><span class='line'>    margin: 0 0 10px 15px;
</span><span class='line'>
</span><span class='line'>    .tocHeading {
</span><span class='line'>        font-weight: bold;
</span><span class='line'>        font-size: 125%;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    #toc {
</span><span class='line'>        background: $toc-bg;
</span><span class='line'>        ul {
</span><span class='line'>            list-style: disc;
</span><span class='line'>            li {
</span><span class='line'>                margin-left: $toc-incr !important;
</span><span class='line'>                padding: 0 !important;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>并把该文件添加到 sass/screen.scss ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@import "custom/screen";
</span></code></pre></td></tr></table></div></figure>


<h3>运行调试</h3>

<p>6、删除 source/stylesheets/screen.css</p>

<p>7、预览看效果 <code>rake preview</code></p>

<h2>jekyll生成 查看</h2>

<blockquote><p>{:toc} ，jekyll-toc ，jekyll html 都没试成功，难道是jekyll-2太老了？</p></blockquote>

<ul>
<li><a href="https://plutotree.me/jekyll/2019/01/30/jekyll-toc-solution.html">https://plutotree.me/jekyll/2019/01/30/jekyll-toc-solution.html</a></li>
<li><a href="http://www.zhengjiachao.com/topics/github.io/add-outline-on-jekyll-post.html">http://www.zhengjiachao.com/topics/github.io/add-outline-on-jekyll-post.html</a></li>
<li><a href="https://github.com/allejo/jekyll-toc#usage">https://github.com/allejo/jekyll-toc#usage</a></li>
</ul>


<p>&ndash;END</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>佛爷</h1>
  <p>来之不易, 且等且珍惜. <br>得之我幸; 不得<span style="display:none">-争-复争-且不得</span>, 命也, 乐享天命, 福也. </p>
  <p><a href="https://github.com/winse"><i class="fa fa-github-alt">winse</i></a>&nbsp;&nbsp;<a href="http://weibo.com/winseliu"><i class="fa fa-weibo">winseliu</i></a></p>
</section>
<section>
  <h1><a class='category' href='/blog/categories/recommend/'>Recommend</a></h1>
	<ul role="list">
		
			<li class="post">
				<a href="/blog/2019/04/10/try-k8s/">Try K8s</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/08/25/video-auto-translate/">视频自动翻译</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/06/09/reasonable-way-to-access-the-internet/">科学上网（续）</a>
			</li>
		
			<li class="post">
				<a href="/blog/2018/01/20/gitalk-on-octopress/">Gitalk on Octopress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/11/16/sphinx-generate-docs/">使用Sphinx生成/管理文档</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/10/30/windows-run-ubuntu/">Windows Run Ubuntu</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/30/kubeadm-install-kubenetes-on-centos7/">Kubeadm部署kubernetes</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/07/08/casperjs-crawler/">爬虫之CasperJS</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/05/23/spark-on-hive-speculation-shit-bug/">Hive on Spark预测性执行BUG一枚</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/27/vnc-server-on-centos7/">在Centos7上安装VNC Server</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/25/develop-environment-prepare/">[整理] 环境准备工具集</a>
			</li>
		
			<li class="post">
				<a href="/blog/2017/01/19/nginx-https/">Nginx配置https</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/09/19/163-open-movies-download/">批量下载163-open的视频</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/23/hadoop-guide-catalog/">[整理] Hadoop入门</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/04/04/rpm-build-your-package/">RPM打包</a>
			</li>
		
			<li class="post">
				<a href="/blog/2016/03/28/hive-on-spark/">Hive on Spark</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/11/22/gfw-ladder/">搭梯笔记</a>
			</li>
		
			<li class="post">
				<a href="/blog/2015/08/24/manual-install-supervisor/">Supervisor安装配置</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/10/16/spark-build-and-configuration/">编译/搭建Spark环境</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/08/25/step-by-step-found-java-oom-error/">查找逐步定位Java程序OOM的异常实践</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/30/hadoop2-snappy-compress/">Hadoop2 Snappy Compress</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/07/27/start-redis/">[读读书]Redis入门指南</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/04/21/hadoop2-windows-startguide/">Windows下部署/配置/调试hadoop2</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/30/git-cheatsheet/">GIT操作记录手册</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/03/18/jekyll-edit-link-in-web-page/">Jekyll页面添加编辑按钮</a>
			</li>
		
			<li class="post">
				<a href="/blog/2014/02/23/quickly-open-program-in-windows/">[Windows运行]快速打开程序</a>
			</li>
		
			<li class="post">
				<a href="/blog/2013/09/19/let-shell-command-efficient/">让敲Shell命令高效起来</a>
			</li>
		
	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/03/26/k8s-ingress/">K8s Ingress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/03/18/k8s-guide-use-kubeadm/">k8s-v1.23.5安装指南 - 使用kubeadm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/03/18/k8s-deps-download/">k8s-v1.23.5依赖下载</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/01/13/openeuler20-dot-03lts-sp3-install-docker/">欧拉20.03LTS_SP3安装docker</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/12/08/octopress-generate-toc/">octopress生成TOC</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/12/08/recommand-blogs/">认真的博客</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/09/15/k2-again/">斐讯K2刷机padavan</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/05/11/redmine-on-arm-pi/">在树莓派上部署redmine</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>

	 
	<ul role="list">
		
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/0/'>0</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/alluxio/'>alluxio</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/android/'>android</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/bigdata/'>bigdata</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/blabla/'>blabla</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/books/'>books</a> (6) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/debug/'>debug</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/deprecated/'>deprecated</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/devops/'>devops</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/docker/'>docker</a> (16) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/es/'>es</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/flume/'>flume</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/ganglia/'>ganglia</a> (5) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/git/'>git</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hadoop/'>hadoop</a> (44) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hbase/'>hbase</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hive/'>hive</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/hole/'>hole</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/java/'>java</a> (13) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jekyll/'>jekyll</a> (8) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jenkins/'>jenkins</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/jeykll/'>jeykll</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k2/'>k2</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/k8s/'>k8s</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kafka/'>kafka</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/kubeadm/'>kubeadm</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/logstash/'>logstash</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/map/'>map</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/nginx/'>nginx</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/puppet/'>puppet</a> (11) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/recommend/'>recommend</a> (27) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/redis/'>redis</a> (7) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/scala/'>scala</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/shell/'>shell</a> (4) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/spark/'>spark</a> (12) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/staf/'>staf</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tachyon/'>tachyon</a> (3) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tez/'>tez</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/tools/'>tools</a> (69) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/topics/'>topics</a> (2) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/vagrant/'>vagrant</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/wsl/'>wsl</a> (1) 
		</li>
		 
		<li style="float:left; width:120px"> 
			<a class='category' href='/blog/categories/zookeeper/'>zookeeper</a> (1) 
		</li>
		
		
		<li style="clear:both; width: 1px; margin: 0; padding: 0;"></li>
		<li class="category"><a href="/blog/archives">All categories</a> (223)</li>
	</ul>
	
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/winse">@winse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'winse',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<!--
  <h1>Softs, I&#8217;m using</h1>
  <ul>
    <li class="post">
		<a href="http://hadoop.apache.org/releases.html">hadoop-2.6.3</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/HBASE/?selectedTab=com.atlassian.jira.jira-projects-plugin:changelog-panel">hbase-0.96.0</a>
	</li>
	<li class="post">
		<a href="https://hive.apache.org/downloads.html">hive-1.2.1</a>
	</li>
	<li class="post">
		<a href="https://issues.apache.org/jira/browse/TEZ/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">tez-0.7.0</a>
    </li>
  </ul>
&#8211;>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Winse Liu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1253103971'%3E%3C/span%3E%3Cscript src='https://s19.cnzz.com/z_stat.php%3Fid%3D1253103971%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script>

var time=location.pathname.substring(6).substring(0,11);
var eName=location.pathname.substring(17);
var gitalk = new Gitalk({
  clientID: 'c14f68eac6330d15d984',
  clientSecret: '73b7c1fffa98e299ff0cdd332821201933858e6e',
  repo: 'winse.github.com',
  owner: 'winse',
  admin: ['winse'],
  id: eName,
  labels: ['Gitalk', time],
  body: "http://winse.github.io" + location.pathname,
  createIssueManually: true,
  
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')

</script>



<script>
/*
$.ajax({
  type: "POST",
  url: "http://log.winseliu.com:20000",
  data: JSON.stringify({
    title: document.title,
    location: JSON.stringify(location),
    referrer: document.referrer,
    userAgent: navigator.userAgent
  }),
  contentType: "application/json; charset=utf-8",
  dataType: "json"
});
*/
</script>











</body>
</html>
